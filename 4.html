<!DOCTYPE html>
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7]><html class="ie ie6 ie-lte9 ie-lte8 ie-lte7 no-js" lang="en-us"> <![endif]-->
<!--[if IE 7]><html class="ie ie7 ie-lte9 ie-lte8 ie-lte7 no-js" lang="en-us"> <![endif]-->
<!--[if IE 8]><html class="ie ie8 ie-lte9 ie-lte8 no-js" lang="en-us"> <![endif]-->
<!--[if IE 9]><html class="ie9 ie-lte9 no-js" lang="en-us"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html class="no-js" lang="en-us"> <!--<![endif]-->
<head>
  <meta charset="utf-8" />
  <!-- www.phpied.com/conditional-comments-block-downloads/ -->
  <!-- Always force latest IE rendering engine
       (even in intranet) & Chrome Frame
       Remove this if you use the .htaccess -->
  <!--[if IE]>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <![endif]-->

  <title>Diffbook</title>

  <!-- http://dev.w3.org/html5/markup/meta.name.html -->
  <meta name="application-name" content="diffbook" />

  <!-- Speaking of Google, don't forget to set your site up:
       http://google.com/webmasters -->
  <meta name="google-site-verification" content="" />

  <!--  Mobile Viewport Fix
        j.mp/mobileviewport & davidbcalhoun.com/2010/viewport-metatag
        device-width: Occupy full width of the screen in its current orientation
        initial-scale = 1.0 retains dimensions instead of zooming out if page height > device height
        user-scalable = yes allows the user to zoom in -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="shortcut icon" href="static/images/favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" href="static/images/favicon.png">

  <!-- All JavaScript at the bottom, except for Modernizr which enables
       HTML5 elements & feature detects -->
  <script src="static/js/modernizr.custom.js"></script>

  <!-- include stylesheets -->
  

  <script type="text/javascript"><!--
    // These variables are used by the web2py_ajax_init function in web2py_ajax.js (which is loaded below).
    var w2p_ajax_confirm_message = "Are you sure you want to delete this object?";
    var w2p_ajax_date_format = "%Y-%m-%d";
    var w2p_ajax_datetime_format = "%Y-%m-%d %H:%M:%S";
    //--></script>

<meta name="keywords" content="web2py, python, framework" />
<meta name="description" content="a cool new app" />
<meta name="generator" content="Web2py Web Framework" />
<meta name="author" content="Your Name &lt;you@example.com&gt;" />
<script src="static/js/jquery.js" type="text/javascript"></script><link href="static/css/calendar.css" rel="stylesheet" type="text/css" /><script src="static/js/calendar.js" type="text/javascript"></script><script src="static/js/web2py.js" type="text/javascript"></script><link href="static/css/web2py.css" rel="stylesheet" type="text/css" /><link href="static/css/bootstrap.min.css" rel="stylesheet" type="text/css" /><link href="static/css/bootstrap-responsive.min.css" rel="stylesheet" type="text/css" /><link href="static/css/web2py_bootstrap.css" rel="stylesheet" type="text/css" />


  

  <!-- uncomment here to load jquery-ui
       <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/themes/base/jquery-ui.css" type="text/css" media="all" />
       <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js" type="text/javascript"></script>
       uncomment to load jquery-ui //-->
  <noscript><link href="static/css/web2py_bootstrap_nojs.css" rel="stylesheet" type="text/css" /></noscript>
  
  <style type="text/css">

      /* Sticky footer styles
      -------------------------------------------------- */

      html,
      body {
        height: 100%;
        /* The html and body elements cannot have any padding or margin. */
      }

      /* Wrapper for page content to push down footer */
      #wrap {
        min-height: 100%;
        height: auto !important;
        height: 100%;
        /* Negative indent footer by it's height */
        margin: 0 auto -60px;
      }

      /* Set the fixed height of the footer here */
      #push,
      #footer {
        height: 60px;
      }
      #footer {
        background-color: #f5f5f5;
      }

      /* Lastly, apply responsive CSS fixes as necessary */
      @media (max-width: 767px) {
        #footer {
          margin-left: -20px;
          margin-right: -20px;
          padding-left: 20px;
          padding-right: 20px;
        }
      }



      /* Custom page CSS
      -------------------------------------------------- */
      /* Not required for template or sticky footer method. */

      .container {
        width: auto;
        max-width: 680px;
      }
      .container .credit {
        margin: 20px 0;
      }

    </style>
</head>

<body>
  
  <body>


    <!-- Part 1: Wrap all page content here -->
    <div id="wrap">

      <!-- Begin page content -->
      <div class="container-fluid">
        <div class="page-header">
          	<h1>
              Diffbook
              <small>easy? diffbook</small>
            </h1>
        </div>
        
        


<div class="pagination">
  <ul>

      <li><a href="/diffbook/0.html">Chapter 0</a></li>

      <li><a href="/diffbook/1.html">Chapter 1</a></li>

      <li><a href="/diffbook/2.html">Chapter 2</a></li>

      <li><a href="/diffbook/3.html">Chapter 3</a></li>

      <li><a href="/diffbook/4.html">Chapter 4</a></li>

      <li><a href="/diffbook/5.html">Chapter 5</a></li>

      <li><a href="/diffbook/6.html">Chapter 6</a></li>

      <li><a href="/diffbook/7.html">Chapter 7</a></li>

      <li><a href="/diffbook/8.html">Chapter 8</a></li>

      <li><a href="/diffbook/9.html">Chapter 9</a></li>

      <li><a href="/diffbook/10.html">Chapter 10</a></li>

      <li><a href="/diffbook/11.html">Chapter 11</a></li>

      <li><a href="/diffbook/12.html">Chapter 12</a></li>

  </ul>
</div>

<div class="pagination">
  <ul>

      
      <li><a href="#com_53abe1b205f0a83fb543b6cd0cf91520a17ec264">53abe1b</a></li>
      

      
      <li><a href="#com_6bb6aa38abec16f773cf4de7ccca9a63de5bbc25">6bb6aa3</a></li>
      

      
      <li><a href="#com_d10f699a861fc591e3fe0efe856226e86d3f2e63">d10f699</a></li>
      

      
      <li><a href="#com_8c22050b7b3e142741e74298101e7f89fb9f970e">8c22050</a></li>
      

      
      <li><a href="#com_48569a3fc4dc6b15ba5f6e079ddb55b2d16d40db">48569a3</a></li>
      

      
      <li><a href="#com_b498c5c3b9092a1b7d0007315399d52d89448269">b498c5c</a></li>
      

      
      <li><a href="#com_5df5b9dd5e0315a674b3cbd977cfe69600fd0a05">5df5b9d</a></li>
      

      
      <li><a href="#com_837efe4e87a76b921e7b61cde5aea4d726356b2b">837efe4</a></li>
      

      
      <li><a href="#com_944df2a7389d729cf013d02eae65c18518b8cc16">944df2a</a></li>
      

      
      <li><a href="#com_4ce1dd997904e455f83c860f74756262ad3418af">4ce1dd9</a></li>
      

      
      <li><a href="#com_a07816cbd9bbd91235d592a25658ba25e33c2158">a07816c</a></li>
      

      
      <li><a href="#com_1474cd610abbf95ddae737e284aadb36e07648e2">1474cd6</a></li>
      

      
      <li><a href="#com_7362f7b775c90f03acfdf14f6714e99b13e99bb5">7362f7b</a></li>
      

      
      <li><a href="#com_aaedb38690383ecf93b2532de0f390cd64ec2010">aaedb38</a></li>
      

      

      
      <li><a href="#com_5b6f32d64158ddb25a2b55b74a6198947b934f80">5b6f32d</a></li>
      

      
      <li><a href="#com_5f860e4094ac8ad56f13f4cdf731ebbce45bbe6c">5f860e4</a></li>
      

      
      <li><a href="#com_e612918f84aba2602dcb4a9b4fc3453d90d964ab">e612918</a></li>
      

      
      <li><a href="#com_cd9c659cd509b94781f4c7668d3b738f31cb1df0">cd9c659</a></li>
      

      
      <li><a href="#com_075e5deeecd75d8be86a799ec938d91142e1f0ee">075e5de</a></li>
      

      
      <li><a href="#com_185d733fc840b62ad03595850b7a4e6a1ecb2d37">185d733</a></li>
      

      
      <li><a href="#com_7e7e01785344e80494420d4f507d11be3ca68d4b">7e7e017</a></li>
      

      
      <li><a href="#com_90939933b126998cf4862eaa483e5603e78164c5">9093993</a></li>
      

      
      <li><a href="#com_0677242ae882ef63cd9c160ad73e63c8a8a6ba41">0677242</a></li>
      

      
      <li><a href="#com_5c8132747606fd3202f87e6a7e1f40bc44a40446">5c81327</a></li>
      

      
      <li><a href="#com_8e6b2e59de0fcefc30df59ddb554259997229161">8e6b2e5</a></li>
      

      
      <li><a href="#com_095fafdc4aac3affea53728fb10f65dfebcdccde">095fafd</a></li>
      

      
      <li><a href="#com_802723ff8451a432d95b98f05c0a56da45001f8d">802723f</a></li>
      

      
      <li><a href="#com_4e43f1ee097323aee901582c509b6b1e9b6b7b83">4e43f1e</a></li>
      

      
      <li><a href="#com_4fcf1d55fe17816a80e49e93dcac144fd7c115cf">4fcf1d5</a></li>
      

      
      <li><a href="#com_a033f046abd2da8faff5435de84a8262bb1614cf">a033f04</a></li>
      

      
      <li><a href="#com_b66c174b3bd1d8e256081f1ec22e82e5a6edd034">b66c174</a></li>
      

      
      <li><a href="#com_d1c83adb22e40cb10cd137a599552a8f91d00785">d1c83ad</a></li>
      

      
      <li><a href="#com_739a4c66c06a1aa5de5f4bd07b49e2f04ec30290">739a4c6</a></li>
      

      
      <li><a href="#com_1c6da8b244c40c1ebea4f3f4774db6d23c2490a4">1c6da8b</a></li>
      

      
      <li><a href="#com_9f8f7358720ecddc06a79b90a68cc94ae5b28603">9f8f735</a></li>
      

      
      <li><a href="#com_1288bf1759b4610486e060ad6fec83b90983389f">1288bf1</a></li>
      

      
      <li><a href="#com_a95fdc684888028417662225d97c7fc3534b6cd2">a95fdc6</a></li>
      

      
      <li><a href="#com_be7f582b3cfaff86147de6fdd55e75f820082f81">be7f582</a></li>
      

      
      <li><a href="#com_d864cef3b68d807ffe8dbc10c26845734fefb97b">d864cef</a></li>
      

      
      <li><a href="#com_6feb49d47e68077713b316da11a6533e1d639add">6feb49d</a></li>
      

      
      <li><a href="#com_f17d5b525d8d9d8b4698838c1482d5cff64144a4">f17d5b5</a></li>
      

      
      <li><a href="#com_5f1db951d80eabbaa41f72575cbdb44cb068d065">5f1db95</a></li>
      

      
      <li><a href="#com_f2fd41dd2a0d4bf68f5cd4f0989fb32bdc35eac5">f2fd41d</a></li>
      

      
      <li><a href="#com_056a1bdee4d0dd56ee506979ef272d4c0de9dfb0">056a1bd</a></li>
      

      
      <li><a href="#com_25fcabc8e16dd81e067560c2a68a60687b7e7217">25fcabc</a></li>
      

      
      <li><a href="#com_097d699dc16179206ccb7e4aee863d6523cd471c">097d699</a></li>
      

      
      <li><a href="#com_49f38ab7ef56de1eb4ef48f68427ebf8a46b505d">49f38ab</a></li>
      

      
      <li><a href="#com_60ecdf04f0802a47a3fb83116d1449f8c3e6f141">60ecdf0</a></li>
      

      
      <li><a href="#com_eaaa0e14bf17cdc4d0edd2ea9daa9af5f3484c09">eaaa0e1</a></li>
      

      
      <li><a href="#com_28816a98948c4a6577f73bdeb2b7424dc55d2582">28816a9</a></li>
      

      
      <li><a href="#com_b3a7d279a1568aca7ae3fe29ef436c7f924fd681">b3a7d27</a></li>
      

      
      <li><a href="#com_c4e4f430a3fe8433d95790170768d74eaf109a49">c4e4f43</a></li>
      

      
      <li><a href="#com_76c0363755694c36971ffc9db176312fe5c14276">76c0363</a></li>
      

      
      <li><a href="#com_7bce1473ce90f4e60f49d72bf1b61d32f430cb54">7bce147</a></li>
      

      
      <li><a href="#com_e234f6edf67361b3ba718ea10184ba8e7c2f773d">e234f6e</a></li>
      

      
      <li><a href="#com_d3f20357877157ed6c1368276a97f432517ebc0c">d3f2035</a></li>
      

      
      <li><a href="#com_82dc64e7baa231edd3896ca7a0d41393e426f123">82dc64e</a></li>
      

      
      <li><a href="#com_1cb1624695d89442155ab19b3a6a64640d6ba973">1cb1624</a></li>
      

      
      <li><a href="#com_8ea3f6b22b9717bd3d68e501bb882b71fa3117fa">8ea3f6b</a></li>
      

      
      <li><a href="#com_cff9eceaf2725218af443dfeafc2d37b98c5fb21">cff9ece</a></li>
      

      
      <li><a href="#com_edfb809206bafa44b393537366c2ab240226941a">edfb809</a></li>
      

      
      <li><a href="#com_703ae1c98c20d735ce9564d95fa0380eb0ee76d4">703ae1c</a></li>
      

      
      <li><a href="#com_f2639bb0d5b3d8cd41114b0de8f6209830d6edeb">f2639bb</a></li>
      

      
      <li><a href="#com_040c3ddf5bf14f3346445ac1082ad627ce6bc0b1">040c3dd</a></li>
      

      
      <li><a href="#com_e9b5433942573152d517f4f0f70639e0dfcf5afe">e9b5433</a></li>
      

      
      <li><a href="#com_31b67861f63a89ddbca5db525b9ea745b956670e">31b6786</a></li>
      

      
      <li><a href="#com_189c12f17f3e21b5a8782723a2e75a89c8342098">189c12f</a></li>
      

      
      <li><a href="#com_a1af38f67ad075e98bd13ffcfb36a0a6dcb3aa32">a1af38f</a></li>
      

      
      <li><a href="#com_9e10b63ca42973fcccba175ef95076d74f292d1b">9e10b63</a></li>
      

      
      <li><a href="#com_ac4003f4349f9ee22c67309ceeb48de5539b0308">ac4003f</a></li>
      

      
      <li><a href="#com_9845f00d9881250c0f454844915b3e6dbee6dccf">9845f00</a></li>
      

      

  </ul>
</div>




<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/53abe1b205f0a83fb543b6cd0cf91520a17ec264">53abe1b</a><ul><li>Date : 2014-09-05</li><li>updated profiler command line option</li></ul></li></ul>
<div class="row-fluid" id="com_53abe1b205f0a83fb543b6cd0cf91520a17ec264">
    <div class="span6"><div class="diff"><div class="insert">+  -F PROFILER_DIR, --profiler=PROFILER_DIR</div><div class="insert">+                        profiler dir</div><div class="">   -t, --taskbar         use web2py gui and run in taskbar (system tray)</div><div class="">   --nogui               text-only, no GUI</div><div class="">   -A ARGS, --args=ARGS  should be followed by a list of arguments to be passed</div><div class="">                         to script, to be used with -S, -A must be the last</div><div class="">                         option</div><div class="">   --no-banner           Do not print header banner</div><div class="">   --interfaces=INTERFACES</div><div class="">                         listen on multiple addresses: &quot;ip1:port1:key1:cert1:ca</div><div class="">                         _cert1;ip2:port2:key2:cert2:ca_cert2;...&quot;</div><div class="">                         (:key:cert:ca_cert optional; no spaces; IPv6 addresses</div><div class="">                         must be in square [] brackets)</div><div class="">   --run_system_tests    runs web2py tests</div><div class=""> ``:code</div><div class=""> </div><div class=""> ------</div><div class="insert">+Please note:</div><div class="insert">+- The option ``-W``, used to install a Windows service, has been removed. Please see [[nssm in the Deployment Recipes chapter ../13/#nssm]]</div><div class="insert">+- Profiler output can be analyzed using ``runsnakerun`` tool</div><div class=""> ------</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">-  -F PROFILER_FILENAME, --profiler=PROFILER_FILENAME</div><div class="delete">-                        profiler filename</div><div class="">   -t, --taskbar         use web2py gui and run in taskbar (system tray)</div><div class="">   --nogui               text-only, no GUI</div><div class="">   -A ARGS, --args=ARGS  should be followed by a list of arguments to be passed</div><div class="">                         to script, to be used with -S, -A must be the last</div><div class="">                         option</div><div class="">   --no-banner           Do not print header banner</div><div class="">   --interfaces=INTERFACES</div><div class="">                         listen on multiple addresses: &quot;ip1:port1:key1:cert1:ca</div><div class="">                         _cert1;ip2:port2:key2:cert2:ca_cert2;...&quot;</div><div class="">                         (:key:cert:ca_cert optional; no spaces; IPv6 addresses</div><div class="">                         must be in square [] brackets)</div><div class="">   --run_system_tests    runs web2py tests</div><div class=""> ``:code</div><div class=""> </div><div class=""> ------</div><div class="delete">-Please note: The option ``-W``, used to install a Windows service, has been removed. Please see [[nssm in the Deployment Recipes chapter ../13/#nssm]]</div><div class=""> ------</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/6bb6aa38abec16f773cf4de7ccca9a63de5bbc25">6bb6aa3</a><ul><li>Date : 2014-07-23</li><li>Substantial rewrite of the first part of the DAL chapter, adding better documentation for DAL, Tables and Fields.</li></ul></li></ul>
<div class="row-fluid" id="com_6bb6aa38abec16f773cf4de7ccca9a63de5bbc25">
    <div class="span6"><div class="diff"><div class="insert">+[[CommandLineOptions]]</div><div class=""> ### Command line options</div></div></div>
    <div class="span6"><div class="diff"><div class=""> ### Command line options</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/d10f699a861fc591e3fe0efe856226e86d3f2e63">d10f699</a><ul><li>Date : 2014-03-21</li><li>remove information relevant to the removed -W windows service cmd line option</li></ul></li></ul>
<div class="row-fluid" id="com_d10f699a861fc591e3fe0efe856226e86d3f2e63">
    <div class="span6"><div class="diff"><div class="insert">Lower-case options are used to configure the web server. The ``-L`` option tells web2py to read configuration options from a file, <span class="highlight">while ``-S``, ``-P`` and ``-M`` options start an interactive Python shell. The ``-T`` option finds and runs controller doctests in a</span> web2py <span class="highlight">execution en</span>vi<span class="highlight">ronment. For exampl</span>e, <span class="highlight">the following</span> ex<span class="highlight"></span>ample runs doctests from all controllers in the &quot;welcome&quot; application:</div><div class=""> ``</div><div class=""> python web2py.py -vT welcome</div><div class=""> ``:code</div><div class=""> </div><div class=""> ### Workflow</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">Lower-case options are used to configure the web server. The ``-L`` option tells web2py to read configuration options from a file, <span class="highlight">``-W`` installs</span> web2py <span class="highlight">as a windows ser</span>vi<span class="highlight">c</span>e, <span class="highlight">while ``-S``, ``-P`` and ``-M`` options start an interactive Python shell. The ``-T`` option finds and runs controller doctests in a web2py</span> ex<span class="highlight">ecution environment. For example, the following ex</span>ample runs doctests from all controllers in the &quot;welcome&quot; application:</div><div class=""> ``</div><div class=""> python web2py.py -vT welcome</div><div class=""> ``:code</div><div class=""> </div><div class="delete">-if you run web2py as a Windows Service, ``-W``,  it is not convenient to pass the configuration using command line arguments. For this reason, in the web2py folder there is a sample &quot;options_std.py&quot; configuration file for the internal web server:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-import socket</div><div class="delete">-import os</div><div class="delete">-</div><div class="delete">-ip = &#x27;0.0.0.0&#x27;</div><div class="delete">-port = 80</div><div class="delete">-interfaces = [(&#x27;0.0.0.0&#x27;, 80)]</div><div class="delete">-               #,(&#x27;0.0.0.0&#x27;,443,&#x27;ssl_private_key.pem&#x27;,&#x27;ssl_certificate.pem&#x27;)]</div><div class="delete">-password = &#x27;&lt;recycle&gt;&#x27;  # ## &lt;recycle&gt; means use the previous password</div><div class="delete">-pid_filename = &#x27;httpserver.pid&#x27;</div><div class="delete">-log_filename = &#x27;httpserver.log&#x27;</div><div class="delete">-profiler_filename = None</div><div class="delete">-ssl_certificate = None  # &#x27;ssl_certificate.pem&#x27;  # ## path to certificate file</div><div class="delete">-ssl_private_key = None  # &#x27;ssl_private_key.pem&#x27;  # ## path to private key file</div><div class="delete">-#numthreads = 50 # ## deprecated; remove</div><div class="delete">-minthreads = None</div><div class="delete">-maxthreads = None</div><div class="delete">-server_name = socket.gethostname()</div><div class="delete">-request_queue_size = 5</div><div class="delete">-timeout = 30</div><div class="delete">-shutdown_timeout = 5</div><div class="delete">-folder = os.getcwd()</div><div class="delete">-extcron = None</div><div class="delete">-nocron = None</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-This file contains the web2py defaults. If you edit this file, you need to import it explicitly with the ``-L`` command-line option. It only works if you run web2py as a Windows Service.</div><div class="delete">-</div><div class=""> ### Workflow</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/8c22050b7b3e142741e74298101e7f89fb9f970e">8c22050</a><ul><li>Date : 2014-03-06</li><li>add task_status. More anchors. Promote scheduler headings</li></ul></li></ul>
<div class="row-fluid" id="com_8c22050b7b3e142741e74298101e7f89fb9f970e">
    <div class="span6"><div class="diff"><div class="insert">+[[scheduler]]</div><div class="insert">+### web2py Scheduler </div><div class="insert">+</div><div class="insert">+The mainstream web2py solution for running tasks in the background (and therefore away from the webserver process) is the built-in scheduler.</div><div class=""> </div><div class=""> The stable API consists of these functions:</div><div class=""> - disable()</div><div class=""> - resume()</div><div class=""> - terminate()</div><div class=""> - kill()</div><div class=""> - queue_task(), </div><div class=""> - task_status() </div><div class=""> - stop_task()</div><div class=""> </div><div class=""> The web2py scheduler works very much like the task queue described in the previous sub-section with some differences:</div><div class=""> - It provides a standard mechanism for creating, scheduling, and monitoring tasks.</div><div class=""> - There is not a single background process but a set of workers processes.</div><div class=""> - The job of worker nodes can be monitored because their state, as well as the state of the tasks, is stored in the database.</div><div class=""> - It works without web2py but that is not documented here.</div><div class=""> </div><div class=""> The scheduler does not use cron, although one can use cron @reboot to start the worker nodes.</div><div class=""> </div><div class=""> More information about deploying the scheduler under Linux and Windows is in the Deployment recipes chapter.</div><div class=""> </div><div class=""> In the scheduler, a task is simply a function defined in a model (or in a module and imported by a model). For example:</div><div class=""> Also, tasks can access another environmental variable that is not present in nor</div><div class=""> Remember to call ``db.commit()`` at the end of every task if it involves inserts/updates to the database. web2py commits by default at the end of a successful action but the scheduler tasks are not actions.</div><div class=""> ------</div><div class=""> </div><div class=""> To enable the scheduler you must instantiate the Scheduler class in a model.</div><div class=""> The recommended way to enable the scheduler to your app is to create a model file named ``scheduler.py`` and define your function there. After the functions, you can put the following code into the model:</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.scheduler import Scheduler</div><div class=""> scheduler = Scheduler(db)</div><div class=""> ``:code</div><div class=""> </div><div class=""> If your tasks are defined in a module (as opposed to a model) you may have to restart the workers.</div><div class=""> </div><div class=""> The task is scheduled with</div><div class=""> </div><div class=""> ``</div><div class=""> scheduler.queue_task(task_add,pvars=dict(a=1,b=2))</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class="insert"><span class="highlight"></span>#### Parameters</div><div class=""> </div><div class=""> The first argument of the ``Scheduler`` class must be the database to be used by the scheduler to communicate with the workers. This can be the ``db`` of the app or another dedicated ``db``, perhaps one shared by multiple apps. If you use SQLite it&#x27;s recommended to use a separate db from the one used by your app in order to keep the app responsive.</div><div class=""> Once the tasks are defined and the ``Scheduler`` is instantiated, all that is needed to do is to start the workers. You can do that in several ways:</div><div class=""> </div><div class=""> ``</div><div class=""> python web2py.py -K myapp</div><div class=""> ``</div><div class=""> starts a worker for the app ``myapp``. If you want start multiple workers for the same app, you can do so just passing ``myapp,myapp``. You can pass also the ``group_names`` (overriding the one set in your model) with</div><div class=""> </div><div class=""> ``</div><div class=""> python web2py.py -K myapp:group1:group2,myotherapp:group1</div><div class=""> ``</div><div class=""> </div><div class=""> If you have a model called ``scheduler.py`` you can start/stop the workers from web2py&#x27;s default window (the one you use to set the ip address and the port).</div><div class=""> </div><div class="insert"><span class="highlight"></span>#### Scheduler Deployment</div><div class=""> One last nice addition: if you use the embedded webserver, you can start the webserver and the scheduler with just one line of code (this assumes you don&#x27;t want the web2py window popping up, else you can use the &quot;Schedulers&quot; menu instead)</div><div class=""> </div><div class=""> ``</div><div class=""> python web2py.py -a yourpass -K myapp -X</div><div class=""> ``</div><div class=""> You can pass the usual parameters (-i, -p, here -a prevents the window from showing up), pass whatever app in the -K parameter and append a -X. The scheduler will run alongside the webserver!</div><div class=""> </div><div class=""> Windows users looking to create a service should see the Deployment Recipes chapter.</div><div class=""> </div><div class=""> </div><div class="insert">+[[scheduler_signature]]</div><div class="insert">+#### Complete Scheduler signature</div><div class=""> Scheduler&#x27;s complete signature is:</div><div class=""> </div><div class=""> ``</div><div class=""> Scheduler(</div><div class="">     db,</div><div class="">     tasks=None,</div><div class="">     migrate=True,</div><div class="">     worker_name=None,</div><div class="">     group_names=None,</div><div class="">     heartbeat=HEARTBEAT,</div><div class="">     max_empty_runs=0,</div><div class="">     discard_results=False,</div><div class="">     utc_time=False</div><div class=""> )</div><div class=""> ``:code</div><div class=""> </div><div class=""> Let&#x27;s see them in order:</div><div class=""> </div><div class=""> - ``db`` is the database DAL instance where you want the scheduler tables be placed.</div><div class=""> - ``tasks`` is a dictionary that maps task names into functions. If you do not pass this parameter, function will be searched in the app environment.</div><div class=""> Let&#x27;s see them in order:</div><div class=""> </div><div class=""> ------</div><div class=""> NB: This is useful if you have different workers instances (e.g. on different machines) and you want to assign tasks to a specific worker.</div><div class=""> </div><div class=""> NB2: It&#x27;s possible to assign a worker more groups, and they can be also all the same, as ``[&#x27;mygroup&#x27;,&#x27;mygroup&#x27;]``. Tasks will be distributed taking into consideration that a worker with group_names ``[&#x27;mygroup&#x27;,&#x27;mygroup&#x27;]`` is able to process the double of the tasks a worker with group_names ``[&#x27;mygroup&#x27;]`` is.</div><div class=""> ------</div><div class=""> </div><div class=""> - ``heartbeat`` is by default set to 3 seconds. This parameter is the one controlling how often a scheduler will check its status on the ``scheduler_worker`` table and see if there are any **ASSIGNED** tasks to itself to process.</div><div class=""> - ``max_empty_runs`` is 0 by default, that means that the worker will continue to process tasks as soon as they are **ASSIGNED**. If you set this to a value of, let&#x27;s say, 10, a worker will die automatically if it&#x27;s **ACTIVE** and no tasks are **ASSIGNED** to it for 10 loops. A loop is when a worker searches for tasks, every 3 seconds (or the set ``heartbeat``)</div><div class=""> - ``discard_results`` is False by default. If set to True, no scheduler_run records will be created.</div><div class=""> </div><div class=""> ------</div><div class=""> NB: scheduler_run records will be created as before for **FAILED**, **TIMEOUT** and **STOPPED** tasks&#x27;s statuses.</div><div class=""> ------</div><div class=""> </div><div class=""> - ``utc_time`` is False by default. If you need to coordinate with workers living in different timezones, or don&#x27;t have problems with solar/DST times, supplying datetimes from different countries, etc, you can set this to True. The scheduler will honor the UTC time and work leaving the local time aside. Caveat: you need to schedule tasks with UTC times (for start_time, stop_time, and so on.)</div><div class=""> </div><div class=""> Now we have the infrastructure in place: defined the tasks, told the scheduler about them, started the worker(s). What remains is to actually schedule the tasks</div><div class=""> </div><div class=""> </div><div class="insert"><span class="highlight"></span>#### Tasks</div><div class=""> Tasks can be scheduled programmatically or via appadmin. In fact, a task is scheduled simply by adding an entry in the table &quot;scheduler_task&quot;, which you can access via appadmin:</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/myapp/appadmin/insert/db/scheduler_task</div><div class=""> ``</div><div class=""> </div><div class=""> The meaning of the fields in this table is obvious. The &quot;args&quot; and &quot;vars&quot;&quot; fields are the values to be passed to the task in JSON format. In the case of the &quot;task_add&quot; above, an example of &quot;args&quot; and &quot;vars&quot; could be:</div><div class=""> </div><div class=""> ``</div><div class=""> args = [3, 4]</div><div class=""> vars = {}</div><div class=""> ``:code</div><div class=""> </div><div class=""> or</div><div class=""> </div><div class=""> ``</div><div class=""> args = []</div><div class=""> vars = {&#x27;a&#x27;:3, &#x27;b&#x27;:4}</div><div class=""> ``:code</div><div class=""> </div><div class=""> The ``scheduler_task`` table is the one where tasks are organized.</div><div class=""> </div><div class=""> To add tasks via the API, use</div><div class=""> ``</div><div class=""> scheduler.queue_task(&#x27;mytask&#x27;,...)</div><div class=""> ``</div><div class=""> which is documented [[below #queue_task_sig]] .</div><div class=""> </div><div class=""> </div><div class="insert"><span class="highlight"></span>#### Task Lifecycle</div><div class=""> All tasks follow a lifecycle</div><div class=""> </div><div class=""> </div><div class=""> [[scheduler tasks @///image/ce8edcc3.png center]]</div><div class=""> </div><div class=""> By default, when you send a task to the scheduler, </div><div class=""> it is in the **QUEUED** status.</div><div class=""> If you need it to be executed later, use the ``start_time`` parameter (default = now).</div><div class=""> If for some reason you need to be sure that the task does not </div><div class=""> get executed after a certain point in time (maybe a request to a web service</div><div class=""> that shuts down at 1AM, a mail that needs to be sent not after the working hours, etc...) you can set a ``stop_time`` (default = None) for it.</div><div class=""> If your task is NOT picked up by a worker before ``stop_time``, it will be set as **EXPIRED**.</div><div class=""> Tasks with no ``stop_time`` set or picked up **BEFORE** stop_time are **ASSIGNED** to a worker. When a workers picks up a task, its status is set to **RUNNING**.</div><div class=""> </div><div class=""> **RUNNING** tasks may end up:</div><div class=""> - **TIMEOUT** when more than ``n`` seconds passed with ``timeout`` parameter (default = 60 seconds).</div><div class=""> - **FAILED** when an exception is detected,</div><div class=""> - **COMPLETED** when they successfully complete.</div><div class=""> </div><div class=""> Values for ``start_time`` and ``stop_time`` should be datetime objects. To schedule &quot;mytask&quot; to run at 30 seconds from the current time, for example, you would do the following:</div><div class=""> scheduler.queue_task(&#x27;mytask&#x27;,</div><div class=""> </div><div class=""> Additionally, you can control how many times a task should be repeated (i.e. you need to aggregate some data at specified intervals). To do so, set the ``repeats``</div><div class=""> parameter (default = 1 time only, 0 = unlimited). You can influence how many seconds should pass between executions with the ``period`` parameter (default = 60 seconds).</div><div class=""> </div><div class=""> ------</div><div class=""> Default behavior: The time period is not calculated between the END of the first round and the START of the next, but from the START time of the first round to the START time of the next cycle). </div><div class=""> This can cause accumulating &#x27;drift&#x27; in the start time of a job.</div><div class=""> After v 2.8.2, a new parameter ``prevent_drift`` was added, defaulting to False. If set to True when queing a task, the start_time parameter will take precedence over the period, preventing drift.</div><div class=""> ------</div><div class=""> </div><div class=""> You can also set how many times the function can raise an exception (i.e. requesting data from a slow web service) and be queued again instead of stopping in **FAILED**  status using the parameter ``retry_failed`` (default = 0, -1 = unlimited).</div><div class=""> </div><div class=""> [[task repeats @///image/7d8b85e4.png center]]</div><div class=""> </div><div class=""> Summary: you have</div><div class=""> - ``period`` and ``repeats`` to get an automatically rescheduled function</div><div class=""> - ``timeout`` to be sure that a function doesn&#x27;t exceed a certain amount of time</div><div class=""> - ``retry_failed`` to control how many times the task can &quot;fail&quot;</div><div class=""> - ``start_time`` and ``stop_time`` to schedule a function in a restricted timeframe</div><div class=""> </div><div class="insert"><span class="highlight"></span>#### ``queue_task<span class="highlight"></span>`` [[queue_task_sig]]</div><div class=""> </div><div class=""> The method:</div><div class=""> ``</div><div class=""> scheduler.queue_task(</div><div class="">     function,</div><div class="">     pargs=[],</div><div class="">     pvars={},</div><div class="">     start_time=now, 		#datetime</div><div class="">     stop_time = None,		#datetime</div><div class="">     timeout = 60,               #seconds</div><div class="">     prevent_drift=False,</div><div class="">     period=60,                  #seconds</div><div class="">     immediate=False,</div><div class="">     repeats = 1</div><div class=""> )</div><div class=""> ``:code</div><div class=""> allows you to queue tasks to be executed by workers. </div><div class=""> It returns a row (see [[here #queue_task_return]]), and it takes the following parameters:</div><div class=""> </div><div class=""> - ``function`` (required): It can be a task name or a reference to an actual function.</div><div class=""> scheduler = Scheduler(db, tasks=dict(demo1=task_add))</div><div class=""> </div><div class=""> scheduler.queue_task(&#x27;demo1&#x27;, pvars=dict(a=1,b=2),</div><div class="">                      repeats = 0, period = 180)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Since version 2.4.1 if you pass an additional parameter ``immediate=True`` it will force the main worker to reassign tasks. Until 2.4.1, the worker checks for new tasks every 5 cycles (so, ``5*heartbeats`` seconds). If you had an app that needed to check frequently for new tasks, to get a &#x27;&#x27;snappy&#x27;&#x27; behaviour you were forced to lower the ``heartbeat`` parameter, putting the db under pressure for no reason. With ``immediate=True`` you can force the check for new tasks: it will happen at most as ``heartbeat`` seconds are passed   </div><div class=""> </div><div class=""> A call to ``scheduler.queue_task`` returns the task ``id`` and ``uuid`` of the task you queued (can be the one you passed or the auto-generated one), and possible ``errors``: [[queue_task_return]]</div><div class=""> </div><div class=""> ``</div><div class=""> &lt;Row {&#x27;errors&#x27;: {}, &#x27;id&#x27;: 1, &#x27;uuid&#x27;: &#x27;08e6433a-cf07-4cea-a4cb-01f16ae5f414&#x27;}&gt;</div><div class=""> ``</div><div class="">  </div><div class=""> If there are errors (usually syntax error or input validation errors),</div><div class=""> you get the result of the validation, and id and uuid will be None</div><div class=""> </div><div class=""> ``</div><div class=""> &lt;Row {&#x27;errors&#x27;: {&#x27;period&#x27;: &#x27;enter an integer greater than or equal to 0&#x27;}, &#x27;id&#x27;: None, &#x27;uuid&#x27;: None}&gt;</div><div class=""> ``</div><div class=""> </div><div class="insert">+#### ``task_status`` [[task_status]]</div><div class="insert">+</div><div class="insert">+To query the scheduler about tasks, use ``task_status``</div><div class="insert">+``</div><div class="insert">+scheduler.task_status(ref, output=False)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+The argument ``ref`` can be</div><div class="insert">+- integer --&gt; lookup will be done by scheduler_task.id</div><div class="insert">+- string --&gt; lookup will be done by scheduler_task.uuid</div><div class="insert">+- query --&gt; lookup as you wish (as in db.scheduler_task.task_name == &#x27;test1&#x27;)</div><div class="insert">+``output=True`` fetches the scheduler_run record</div><div class="insert">+</div><div class="insert">+It returns a single Row object, for the most recent queued task matching the criteria.</div><div class="insert">+</div><div class="insert">+scheduler_run record is fetched by a left join, so it can</div><div class="insert">+have all fields == None</div><div class="insert">+</div><div class="insert">+##### Example: retrieving scheduler task status, results and tracebacks</div><div class="insert">+Here the scheduler instance is ``mysched``</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+task = mysched.queue_task(f, ....)</div><div class="insert">+task_status = mysched.task_status(task.id, output=True)</div><div class="insert">+traceback = task_status.scheduler_run.traceback</div><div class="insert">+result = task_status.scheduler_run.run_result #or</div><div class="insert">+result = task_status.result</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+#### Results and output</div><div class=""> </div><div class=""> The table &quot;scheduler_run&quot; stores the status of all running tasks. Each record references a task that has been picked up by a worker.  One task can have multiple runs. For example, a task scheduled to repeat 10 times an hour will probably have 10 runs (unless one fails or they take longer than 1 hour). Beware that if the task has no return values, it is removed from the scheduler_run table as soon as it is finished.</div><div class=""> </div><div class=""> Possible run statuses are:</div><div class=""> </div><div class=""> ``</div><div class=""> RUNNING, COMPLETED, FAILED, TIMEOUT</div><div class=""> ``</div><div class=""> </div><div class=""> If the run is completed, no exceptions are thrown, and there is no task timeout, the run is marked as ``COMPLETED`` and the task is marked as ``QUEUED`` or ``COMPLETED`` depending on whether it is supposed to run again at a later time. The output of the task is serialized in JSON and stored in the run record.</div><div class=""> </div><div class=""> When a ``RUNNING`` task throws an exception, the run is mark as ``FAILED`` and the task is marked as ``FAILED``. The traceback is stored in the run record.</div><div class=""> </div><div class=""> Similarly, when a run exceeds the timeout, it is stopped and marked as ``TIMEOUT``, and the task is marked as ``TIMEOUT``.</div><div class=""> </div><div class=""> In any case, the stdout is captured and also logged into the run record.</div><div class=""> </div><div class=""> Using appadmin, one can check all ``RUNNING`` tasks, the output of ``COMPLETED`` tasks, the error of ``FAILED`` tasks, etc.</div><div class=""> </div><div class=""> The scheduler also creates one more table called &quot;scheduler_worker&quot;, which stores the workers&#x27; heartbeat and their status.</div><div class=""> </div><div class="insert"><span class="highlight"></span>#### Managing processes</div><div class=""> </div><div class=""> Worker fine management is hard. This module tries not to leave behind any platform (Mac, Win, Linux) .</div><div class=""> </div><div class=""> When you start a worker, you may later want to:</div><div class=""> - kill it &quot;no matter what it&#x27;s doing&quot;</div><div class=""> - kill it only if it is not processing tasks</div><div class=""> - put it to sleep</div><div class=""> Maybe you have yet some tasks queued, and you want to save some resources.</div><div class=""> You know you want them processed every hour, so, you&#x27;ll want to:</div><div class=""> - process all queued tasks and die automatically</div><div class=""> All of these things are possible managing ``Scheduler`` parameters or the ``scheduler_worker`` table.</div><div class=""> To be more precise, for started workers you can change the ``status`` value of any worker to influence</div><div class=""> its behavior.</div><div class=""> As for tasks, workers can be in one of the following statuses: ACTIVE, DISABLED, TERMINATE or KILLED.</div><div class=""> </div><div class=""> **ACTIVE** and **DISABLED** are &quot;persistent&quot;, while **TERMINATE** or **KILL**, as statuses</div><div class=""> name suggest, are more &quot;commands&quot; than real statuses.</div><div class=""> Hitting ctrl+c is equal to set a worker to **KILL**</div><div class=""> </div><div class=""> [[workers statuses @///image/bd891eed.png center]]</div><div class=""> scheduler.queue_task(</div><div class="">     pargs=[],</div><div class="">     pvars={&#x27;a&#x27;:3,&#x27;b&#x27;:4},</div><div class="">     repeats = 10, # run 10 times</div><div class="">     period = 3600, # every 1h</div><div class="">     timeout = 120, # should take less than 120 seconds</div><div class="">     )</div><div class=""> ``:code</div><div class=""> </div><div class=""> Notice that fields &quot;times_run&quot;, &quot;last_run_time&quot; and &quot;assigned_worker_name&quot; are not provided at schedule time but are filled automatically by the workers.</div><div class=""> </div><div class=""> You can also retrieve the output of completed tasks:</div><div class=""> </div><div class=""> ``</div><div class=""> completed_runs = db(db.scheduler_run.run_status=&#x27;COMPLETED&#x27;).select()</div><div class=""> ``:code</div><div class=""> </div><div class=""> ------</div><div class=""> The scheduler is considered experimental because it needs more extensive testing and because the table structure may change as more features are added.</div><div class=""> ------</div><div class=""> </div><div class="insert"><span class="highlight"></span>#### Reporting p<span class="highlight">rogress p</span>ercentages</div><div class=""> </div><div class=""> A special &quot;word&quot; encountered in the print statements of your functions clear all</div><div class=""> the previous output. That word is ``!clear!``.</div><div class=""> This, coupled with the ``sync_output`` parameter, allows to report percentages.</div><div class=""> </div><div class=""> </div><div class=""> Here is an example:</div><div class=""> </div><div class=""> ``</div><div class=""> def reporting_percentages():</div><div class="">     time.sleep(5)</div><div class="">     print &#x27;50%&#x27;</div><div class="">     time.sleep(5)</div><div class="">     print &#x27;!clear!100%&#x27;</div><div class="">     return 1</div><div class=""> ``</div><div class=""> </div><div class=""> The function ``reporting_percentages`` sleeps for 5 seconds, outputs ``50%``.</div><div class=""> Then, it sleeps other 5 seconds and outputs ``100%``. Note that the output in the scheduler_run table is synced every 2 seconds and that the second print statement that contains ``!clear!100%`` gets the ``50%`` output cleared and replaced by ``100%`` only.</div><div class=""> </div><div class=""> ``</div><div class=""> scheduler.queue_task(reporting_percentages,</div><div class="">                      sync_output=2)</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class="insert">+[[modules]]</div><div class=""> ### Third party modules</div><div class=""> ``import``:inxx</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">-#### Scheduler </div><div class=""> </div><div class="delete">-Prior to version 2.6.0 the scheduler was considered experimental. From v2.6.0 the documented API is stable.</div><div class=""> The stable API consists of these functions:</div><div class=""> - disable()</div><div class=""> - resume()</div><div class=""> - terminate()</div><div class=""> - kill()</div><div class=""> - queue_task(), </div><div class=""> - task_status() </div><div class=""> - stop_task()</div><div class=""> </div><div class=""> The web2py scheduler works very much like the task queue described in the previous sub-section with some differences:</div><div class=""> - It provides a standard mechanism for creating, scheduling, and monitoring tasks.</div><div class=""> - There is not a single background process but a set of workers processes.</div><div class=""> - The job of worker nodes can be monitored because their state, as well as the state of the tasks, is stored in the database.</div><div class=""> - It works without web2py but that is not documented here.</div><div class=""> </div><div class=""> The scheduler does not use cron, although one can use cron @reboot to start the worker nodes.</div><div class=""> </div><div class=""> More information about deploying the scheduler under Linux and Windows is in the Deployment recipes chapter.</div><div class=""> </div><div class=""> In the scheduler, a task is simply a function defined in a model (or in a module and imported by a model). For example:</div><div class=""> Also, tasks can access another environmental variable that is not present in nor</div><div class=""> Remember to call ``db.commit()`` at the end of every task if it involves inserts/updates to the database. web2py commits by default at the end of a successful action but the scheduler tasks are not actions.</div><div class=""> ------</div><div class=""> </div><div class=""> To enable the scheduler you must instantiate the Scheduler class in a model.</div><div class=""> The recommended way to enable the scheduler to your app is to create a model file named ``scheduler.py`` and define your function there. After the functions, you can put the following code into the model:</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.scheduler import Scheduler</div><div class=""> scheduler = Scheduler(db)</div><div class=""> ``:code</div><div class=""> </div><div class=""> If your tasks are defined in a module (as opposed to a model) you may have to restart the workers.</div><div class=""> </div><div class=""> The task is scheduled with</div><div class=""> </div><div class=""> ``</div><div class=""> scheduler.queue_task(task_add,pvars=dict(a=1,b=2))</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class="delete"><span class="highlight">#</span>#### Parameters</div><div class=""> </div><div class=""> The first argument of the ``Scheduler`` class must be the database to be used by the scheduler to communicate with the workers. This can be the ``db`` of the app or another dedicated ``db``, perhaps one shared by multiple apps. If you use SQLite it&#x27;s recommended to use a separate db from the one used by your app in order to keep the app responsive.</div><div class=""> Once the tasks are defined and the ``Scheduler`` is instantiated, all that is needed to do is to start the workers. You can do that in several ways:</div><div class=""> </div><div class=""> ``</div><div class=""> python web2py.py -K myapp</div><div class=""> ``</div><div class=""> starts a worker for the app ``myapp``. If you want start multiple workers for the same app, you can do so just passing ``myapp,myapp``. You can pass also the ``group_names`` (overriding the one set in your model) with</div><div class=""> </div><div class=""> ``</div><div class=""> python web2py.py -K myapp:group1:group2,myotherapp:group1</div><div class=""> ``</div><div class=""> </div><div class=""> If you have a model called ``scheduler.py`` you can start/stop the workers from web2py&#x27;s default window (the one you use to set the ip address and the port).</div><div class=""> </div><div class="delete"><span class="highlight">#</span>#### Scheduler Deployment</div><div class=""> One last nice addition: if you use the embedded webserver, you can start the webserver and the scheduler with just one line of code (this assumes you don&#x27;t want the web2py window popping up, else you can use the &quot;Schedulers&quot; menu instead)</div><div class=""> </div><div class=""> ``</div><div class=""> python web2py.py -a yourpass -K myapp -X</div><div class=""> ``</div><div class=""> You can pass the usual parameters (-i, -p, here -a prevents the window from showing up), pass whatever app in the -K parameter and append a -X. The scheduler will run alongside the webserver!</div><div class=""> </div><div class=""> Windows users looking to create a service should see the Deployment Recipes chapter.</div><div class=""> </div><div class=""> </div><div class="delete">-##### Complete Scheduler signature</div><div class=""> Scheduler&#x27;s complete signature is:</div><div class=""> </div><div class=""> ``</div><div class=""> Scheduler(</div><div class="">     db,</div><div class="">     tasks=None,</div><div class="">     migrate=True,</div><div class="">     worker_name=None,</div><div class="">     group_names=None,</div><div class="">     heartbeat=HEARTBEAT,</div><div class="">     max_empty_runs=0,</div><div class="">     discard_results=False,</div><div class="">     utc_time=False</div><div class=""> )</div><div class=""> ``:code</div><div class=""> </div><div class=""> Let&#x27;s see them in order:</div><div class=""> </div><div class=""> - ``db`` is the database DAL instance where you want the scheduler tables be placed.</div><div class=""> - ``tasks`` is a dictionary that maps task names into functions. If you do not pass this parameter, function will be searched in the app environment.</div><div class=""> Let&#x27;s see them in order:</div><div class=""> </div><div class=""> ------</div><div class=""> NB: This is useful if you have different workers instances (e.g. on different machines) and you want to assign tasks to a specific worker.</div><div class=""> </div><div class=""> NB2: It&#x27;s possible to assign a worker more groups, and they can be also all the same, as ``[&#x27;mygroup&#x27;,&#x27;mygroup&#x27;]``. Tasks will be distributed taking into consideration that a worker with group_names ``[&#x27;mygroup&#x27;,&#x27;mygroup&#x27;]`` is able to process the double of the tasks a worker with group_names ``[&#x27;mygroup&#x27;]`` is.</div><div class=""> ------</div><div class=""> </div><div class=""> - ``heartbeat`` is by default set to 3 seconds. This parameter is the one controlling how often a scheduler will check its status on the ``scheduler_worker`` table and see if there are any **ASSIGNED** tasks to itself to process.</div><div class=""> - ``max_empty_runs`` is 0 by default, that means that the worker will continue to process tasks as soon as they are **ASSIGNED**. If you set this to a value of, let&#x27;s say, 10, a worker will die automatically if it&#x27;s **ACTIVE** and no tasks are **ASSIGNED** to it for 10 loops. A loop is when a worker searches for tasks, every 3 seconds (or the set ``heartbeat``)</div><div class=""> - ``discard_results`` is False by default. If set to True, no scheduler_run records will be created.</div><div class=""> </div><div class=""> ------</div><div class=""> NB: scheduler_run records will be created as before for **FAILED**, **TIMEOUT** and **STOPPED** tasks&#x27;s statuses.</div><div class=""> ------</div><div class=""> </div><div class=""> - ``utc_time`` is False by default. If you need to coordinate with workers living in different timezones, or don&#x27;t have problems with solar/DST times, supplying datetimes from different countries, etc, you can set this to True. The scheduler will honor the UTC time and work leaving the local time aside. Caveat: you need to schedule tasks with UTC times (for start_time, stop_time, and so on.)</div><div class=""> </div><div class=""> Now we have the infrastructure in place: defined the tasks, told the scheduler about them, started the worker(s). What remains is to actually schedule the tasks</div><div class=""> </div><div class=""> </div><div class="delete"><span class="highlight">#</span>#### Tasks</div><div class=""> Tasks can be scheduled programmatically or via appadmin. In fact, a task is scheduled simply by adding an entry in the table &quot;scheduler_task&quot;, which you can access via appadmin:</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/myapp/appadmin/insert/db/scheduler_task</div><div class=""> ``</div><div class=""> </div><div class=""> The meaning of the fields in this table is obvious. The &quot;args&quot; and &quot;vars&quot;&quot; fields are the values to be passed to the task in JSON format. In the case of the &quot;task_add&quot; above, an example of &quot;args&quot; and &quot;vars&quot; could be:</div><div class=""> </div><div class=""> ``</div><div class=""> args = [3, 4]</div><div class=""> vars = {}</div><div class=""> ``:code</div><div class=""> </div><div class=""> or</div><div class=""> </div><div class=""> ``</div><div class=""> args = []</div><div class=""> vars = {&#x27;a&#x27;:3, &#x27;b&#x27;:4}</div><div class=""> ``:code</div><div class=""> </div><div class=""> The ``scheduler_task`` table is the one where tasks are organized.</div><div class=""> </div><div class=""> To add tasks via the API, use</div><div class=""> ``</div><div class=""> scheduler.queue_task(&#x27;mytask&#x27;,...)</div><div class=""> ``</div><div class=""> which is documented [[below #queue_task_sig]] .</div><div class=""> </div><div class=""> </div><div class="delete"><span class="highlight">#</span>#### Task Lifecycle</div><div class=""> All tasks follow a lifecycle</div><div class=""> </div><div class=""> </div><div class=""> [[scheduler tasks @///image/ce8edcc3.png center]]</div><div class=""> </div><div class=""> By default, when you send a task to the scheduler, </div><div class=""> it is in the **QUEUED** status.</div><div class=""> If you need it to be executed later, use the ``start_time`` parameter (default = now).</div><div class=""> If for some reason you need to be sure that the task does not </div><div class=""> get executed after a certain point in time (maybe a request to a web service</div><div class=""> that shuts down at 1AM, a mail that needs to be sent not after the working hours, etc...) you can set a ``stop_time`` (default = None) for it.</div><div class=""> If your task is NOT picked up by a worker before ``stop_time``, it will be set as **EXPIRED**.</div><div class=""> Tasks with no ``stop_time`` set or picked up **BEFORE** stop_time are **ASSIGNED** to a worker. When a workers picks up a task, its status is set to **RUNNING**.</div><div class=""> </div><div class=""> **RUNNING** tasks may end up:</div><div class=""> - **TIMEOUT** when more than ``n`` seconds passed with ``timeout`` parameter (default = 60 seconds).</div><div class=""> - **FAILED** when an exception is detected,</div><div class=""> - **COMPLETED** when they successfully complete.</div><div class=""> </div><div class=""> Values for ``start_time`` and ``stop_time`` should be datetime objects. To schedule &quot;mytask&quot; to run at 30 seconds from the current time, for example, you would do the following:</div><div class=""> scheduler.queue_task(&#x27;mytask&#x27;,</div><div class=""> </div><div class=""> Additionally, you can control how many times a task should be repeated (i.e. you need to aggregate some data at specified intervals). To do so, set the ``repeats``</div><div class=""> parameter (default = 1 time only, 0 = unlimited). You can influence how many seconds should pass between executions with the ``period`` parameter (default = 60 seconds).</div><div class=""> </div><div class=""> ------</div><div class=""> Default behavior: The time period is not calculated between the END of the first round and the START of the next, but from the START time of the first round to the START time of the next cycle). </div><div class=""> This can cause accumulating &#x27;drift&#x27; in the start time of a job.</div><div class=""> After v 2.8.2, a new parameter ``prevent_drift`` was added, defaulting to False. If set to True when queing a task, the start_time parameter will take precedence over the period, preventing drift.</div><div class=""> ------</div><div class=""> </div><div class=""> You can also set how many times the function can raise an exception (i.e. requesting data from a slow web service) and be queued again instead of stopping in **FAILED**  status using the parameter ``retry_failed`` (default = 0, -1 = unlimited).</div><div class=""> </div><div class=""> [[task repeats @///image/7d8b85e4.png center]]</div><div class=""> </div><div class=""> Summary: you have</div><div class=""> - ``period`` and ``repeats`` to get an automatically rescheduled function</div><div class=""> - ``timeout`` to be sure that a function doesn&#x27;t exceed a certain amount of time</div><div class=""> - ``retry_failed`` to control how many times the task can &quot;fail&quot;</div><div class=""> - ``start_time`` and ``stop_time`` to schedule a function in a restricted timeframe</div><div class=""> </div><div class="delete"><span class="highlight">#</span>#### ``queue_task<span class="highlight">`` and ``task_status</span>`` [[queue_task_sig]]</div><div class=""> </div><div class=""> The method:</div><div class=""> ``</div><div class=""> scheduler.queue_task(</div><div class="">     function,</div><div class="">     pargs=[],</div><div class="">     pvars={},</div><div class="">     start_time=now, 		#datetime</div><div class="">     stop_time = None,		#datetime</div><div class="">     timeout = 60,               #seconds</div><div class="">     prevent_drift=False,</div><div class="">     period=60,                  #seconds</div><div class="">     immediate=False,</div><div class="">     repeats = 1</div><div class=""> )</div><div class=""> ``:code</div><div class=""> allows you to queue tasks to be executed by workers. </div><div class=""> It returns a row (see [[here #queue_task_return]]), and it takes the following parameters:</div><div class=""> </div><div class=""> - ``function`` (required): It can be a task name or a reference to an actual function.</div><div class=""> scheduler = Scheduler(db, tasks=dict(demo1=task_add))</div><div class=""> </div><div class=""> scheduler.queue_task(&#x27;demo1&#x27;, pvars=dict(a=1,b=2),</div><div class="">                      repeats = 0, period = 180)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Since version 2.4.1 if you pass an additional parameter ``immediate=True`` it will force the main worker to reassign tasks. Until 2.4.1, the worker checks for new tasks every 5 cycles (so, ``5*heartbeats`` seconds). If you had an app that needed to check frequently for new tasks, to get a &#x27;&#x27;snappy&#x27;&#x27; behaviour you were forced to lower the ``heartbeat`` parameter, putting the db under pressure for no reason. With ``immediate=True`` you can force the check for new tasks: it will happen at most as ``heartbeat`` seconds are passed   </div><div class=""> </div><div class=""> A call to ``scheduler.queue_task`` returns the task ``id`` and ``uuid`` of the task you queued (can be the one you passed or the auto-generated one), and possible ``errors``: [[queue_task_return]]</div><div class=""> </div><div class=""> ``</div><div class=""> &lt;Row {&#x27;errors&#x27;: {}, &#x27;id&#x27;: 1, &#x27;uuid&#x27;: &#x27;08e6433a-cf07-4cea-a4cb-01f16ae5f414&#x27;}&gt;</div><div class=""> ``</div><div class="">  </div><div class=""> If there are errors (usually syntax error or input validation errors),</div><div class=""> you get the result of the validation, and id and uuid will be None</div><div class=""> </div><div class=""> ``</div><div class=""> &lt;Row {&#x27;errors&#x27;: {&#x27;period&#x27;: &#x27;enter an integer greater than or equal to 0&#x27;}, &#x27;id&#x27;: None, &#x27;uuid&#x27;: None}&gt;</div><div class=""> ``</div><div class=""> </div><div class="delete">-##### Results and output</div><div class=""> </div><div class=""> The table &quot;scheduler_run&quot; stores the status of all running tasks. Each record references a task that has been picked up by a worker.  One task can have multiple runs. For example, a task scheduled to repeat 10 times an hour will probably have 10 runs (unless one fails or they take longer than 1 hour). Beware that if the task has no return values, it is removed from the scheduler_run table as soon as it is finished.</div><div class=""> </div><div class=""> Possible run statuses are:</div><div class=""> </div><div class=""> ``</div><div class=""> RUNNING, COMPLETED, FAILED, TIMEOUT</div><div class=""> ``</div><div class=""> </div><div class=""> If the run is completed, no exceptions are thrown, and there is no task timeout, the run is marked as ``COMPLETED`` and the task is marked as ``QUEUED`` or ``COMPLETED`` depending on whether it is supposed to run again at a later time. The output of the task is serialized in JSON and stored in the run record.</div><div class=""> </div><div class=""> When a ``RUNNING`` task throws an exception, the run is mark as ``FAILED`` and the task is marked as ``FAILED``. The traceback is stored in the run record.</div><div class=""> </div><div class=""> Similarly, when a run exceeds the timeout, it is stopped and marked as ``TIMEOUT``, and the task is marked as ``TIMEOUT``.</div><div class=""> </div><div class=""> In any case, the stdout is captured and also logged into the run record.</div><div class=""> </div><div class=""> Using appadmin, one can check all ``RUNNING`` tasks, the output of ``COMPLETED`` tasks, the error of ``FAILED`` tasks, etc.</div><div class=""> </div><div class=""> The scheduler also creates one more table called &quot;scheduler_worker&quot;, which stores the workers&#x27; heartbeat and their status.</div><div class=""> </div><div class="delete"><span class="highlight">#</span>#### Managing processes</div><div class=""> </div><div class=""> Worker fine management is hard. This module tries not to leave behind any platform (Mac, Win, Linux) .</div><div class=""> </div><div class=""> When you start a worker, you may later want to:</div><div class=""> - kill it &quot;no matter what it&#x27;s doing&quot;</div><div class=""> - kill it only if it is not processing tasks</div><div class=""> - put it to sleep</div><div class=""> Maybe you have yet some tasks queued, and you want to save some resources.</div><div class=""> You know you want them processed every hour, so, you&#x27;ll want to:</div><div class=""> - process all queued tasks and die automatically</div><div class=""> All of these things are possible managing ``Scheduler`` parameters or the ``scheduler_worker`` table.</div><div class=""> To be more precise, for started workers you can change the ``status`` value of any worker to influence</div><div class=""> its behavior.</div><div class=""> As for tasks, workers can be in one of the following statuses: ACTIVE, DISABLED, TERMINATE or KILLED.</div><div class=""> </div><div class=""> **ACTIVE** and **DISABLED** are &quot;persistent&quot;, while **TERMINATE** or **KILL**, as statuses</div><div class=""> name suggest, are more &quot;commands&quot; than real statuses.</div><div class=""> Hitting ctrl+c is equal to set a worker to **KILL**</div><div class=""> </div><div class=""> [[workers statuses @///image/bd891eed.png center]]</div><div class=""> scheduler.queue_task(</div><div class="">     pargs=[],</div><div class="">     pvars={&#x27;a&#x27;:3,&#x27;b&#x27;:4},</div><div class="">     repeats = 10, # run 10 times</div><div class="">     period = 3600, # every 1h</div><div class="">     timeout = 120, # should take less than 120 seconds</div><div class="">     )</div><div class=""> ``:code</div><div class=""> </div><div class=""> Notice that fields &quot;times_run&quot;, &quot;last_run_time&quot; and &quot;assigned_worker_name&quot; are not provided at schedule time but are filled automatically by the workers.</div><div class=""> </div><div class=""> You can also retrieve the output of completed tasks:</div><div class=""> </div><div class=""> ``</div><div class=""> completed_runs = db(db.scheduler_run.run_status=&#x27;COMPLETED&#x27;).select()</div><div class=""> ``:code</div><div class=""> </div><div class=""> ------</div><div class=""> The scheduler is considered experimental because it needs more extensive testing and because the table structure may change as more features are added.</div><div class=""> ------</div><div class=""> </div><div class="delete"><span class="highlight">#</span>#### Reporting p<span class="highlight"></span>ercentages</div><div class=""> </div><div class=""> A special &quot;word&quot; encountered in the print statements of your functions clear all</div><div class=""> the previous output. That word is ``!clear!``.</div><div class=""> This, coupled with the ``sync_output`` parameter, allows to report percentages.</div><div class=""> </div><div class=""> </div><div class=""> Here is an example:</div><div class=""> </div><div class=""> ``</div><div class=""> def reporting_percentages():</div><div class="">     time.sleep(5)</div><div class="">     print &#x27;50%&#x27;</div><div class="">     time.sleep(5)</div><div class="">     print &#x27;!clear!100%&#x27;</div><div class="">     return 1</div><div class=""> ``</div><div class=""> </div><div class=""> The function ``reporting_percentages`` sleeps for 5 seconds, outputs ``50%``.</div><div class=""> Then, it sleeps other 5 seconds and outputs ``100%``. Note that the output in the scheduler_run table is synced every 2 seconds and that the second print statement that contains ``!clear!100%`` gets the ``50%`` output cleared and replaced by ``100%`` only.</div><div class=""> </div><div class=""> ``</div><div class=""> scheduler.queue_task(reporting_percentages,</div><div class="">                      sync_output=2)</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> ### Third party modules</div><div class=""> ``import``:inxx</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/48569a3fc4dc6b15ba5f6e079ddb55b2d16d40db">48569a3</a><ul><li>Date : 2014-02-26</li><li>typo fix</li></ul></li></ul>
<div class="row-fluid" id="com_48569a3fc4dc6b15ba5f6e079ddb55b2d16d40db">
    <div class="span6"><div class="diff"><div class=""> -------</div><div class=""> Beware! Given ``from gluon import current``, it is correct to use ``current.request`` and any of the other thread local objects but one should never assign them to global variables in the module, such as in</div><div class=""> ``</div><div class=""> request = current.request # WRONG! DANGER!</div><div class=""> ``</div><div class="insert">nor<span class="highlight"></span> should one use current to assign class attributes:</div><div class=""> ``</div><div class=""> class MyClass:</div><div class="">     request = current.request # WRONG! DANGER!</div><div class=""> ``</div><div class=""> This is because the thread local object must be extracted at runtime. Global variables instead are defined only once when the model is imported for the first time.</div><div class=""> -------</div></div></div>
    <div class="span6"><div class="diff"><div class=""> -------</div><div class=""> Beware! Given ``from gluon import current``, it is correct to use ``current.request`` and any of the other thread local objects but one should never assign them to global variables in the module, such as in</div><div class=""> ``</div><div class=""> request = current.request # WRONG! DANGER!</div><div class=""> ``</div><div class="delete">nor<span class="highlight"> one</span> should one use current to assign class attributes:</div><div class=""> ``</div><div class=""> class MyClass:</div><div class="">     request = current.request # WRONG! DANGER!</div><div class=""> ``</div><div class=""> This is because the thread local object must be extracted at runtime. Global variables instead are defined only once when the model is imported for the first time.</div><div class=""> -------</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/b498c5c3b9092a1b7d0007315399d52d89448269">b498c5c</a><ul><li>Date : 2014-02-26</li><li>Errata per github issue #165</li></ul></li></ul>
<div class="row-fluid" id="com_b498c5c3b9092a1b7d0007315399d52d89448269">
    <div class="span6"><div class="diff"><div class=""> There are some caveats to keep in mind:</div><div class=""> - Models in the same folder/subfolder are executed in alphabetical order.</div><div class=""> - Any variable defined in a model will be visible to other models following alphabetically, to the controllers, and to the views.</div><div class=""> ``models_to_run``:inxx</div><div class="insert">+``conditional models``:inxx</div><div class="insert">+[[conditional_models]]</div><div class=""> - Models in subfolders are executed conditionally. For example, if the user has requested &quot;/a/c/f&quot; where &quot;a&quot; is the application, &quot;c&quot; is the controller, and &quot;f&quot; is the function (action), then the following models are executed:</div><div class=""> </div><div class=""> ``</div><div class=""> applications/a/models/*.py</div><div class=""> applications/a/models/c/*.py</div><div class=""> applications/a/models/c/f/*.py</div><div class=""> ``</div><div class="">   This behaviour is enforced by default. Altering the ``response.models_to_run`` regex list, you can force the behaviour you want. Look at [[response #response_models_to_run]] for additional details</div><div class=""> </div><div class=""> - The requested controller is executed and the requested function is called. This means all top-level code in the controller is also executed at every request for that controller.</div><div class=""> - The view is only called if the action returns a dictionary.</div><div class=""> - If a view is not found, web2py tries to use a generic view. By default, generic views are disabled, although the &#x27;welcome&#x27; app includes a line in /models/db.py to enable them on localhost only. They can be enabled per extension type and per action (using ``response.generic_patterns``). In general, generic views are a development tool and typically should not be used in production. If you want some actions to use a generic view, list those actions in ``response.generic_patterns`` (discussed in more detail in the chapter on Services).</div><div class=""> </div><div class=""> The possible behaviors of an action are the following:</div><div class=""> </div><div class=""> **Return a string**</div><div class=""> ``</div><div class=""> def index(): return &#x27;data&#x27;</div><div class=""> ``</div><div class=""> </div><div class=""> For backward compatibility ``SQLDB=DAL`` and ``SQLField=Field``. We encourage yo</div><div class=""> Other objects and modules are defined in the libraries, but they are not automatically imported since they are not used as often.</div><div class=""> </div><div class=""> The core API entities in the web2py execution environment are ``request``, ``response``, ``session``, ``cache``, ``URL``, ``HTTP``, ``redirect`` and ``T`` and are discussed below.</div><div class=""> </div><div class=""> A few objects and functions, including **Auth**, **Crud** and **Service**, are defined in &quot;gluon/tools.py&quot; and they need to be imported as necessary:</div><div class=""> ``</div><div class=""> from gluon.tools import Auth, Crud, Service</div><div class=""> ``:code</div><div class=""> They are imported in ``db.py`` in the scaffolding application.</div><div class=""> </div><div class=""> #### Accessing the API from Python modules</div><div class=""> </div><div class=""> Your models or controller may import python modules, and these may need to use some of the web2py API. The way to do it is by importing them:</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon import *</div><div class=""> ``</div><div class=""> </div><div class=""> In fact, any Python module, even if not imported by a web2py application, can import the web2py API as long as web2py is in the ``sys.path``.</div><div class=""> </div><div class="insert">There is one caveat, though. Web2py defines some global objects (request, response, session, cache, T) that can only exist when an HTTP request is present (or is faked). Therefore, modules can access them only if they are called from an application. For this reasons they are placed into a container calle<span class="highlight">d</span> ``current``, which is a thread local object. Here is an example.</div><div class=""> </div><div class=""> Create a module &quot;/myapp/modules/test.py&quot; that contains:</div><div class=""> ``</div><div class=""> from gluon import *</div><div class=""> def ip(): return current.request.client</div><div class=""> ``</div><div class=""> Now from a controller in &quot;myapp&quot; you can do</div><div class=""> ``</div><div class=""> import test</div><div class=""> def index():</div><div class="">     return &quot;Your ip is &quot; + test.ip()</div><div class=""> ``</div><div class=""> </div><div class=""> Notice a few things:</div><div class=""> </div><div class=""> - ``import test`` looks for the module first in the current app&#x27;s modules folder, then in the folders listed in ``sys.path``. Therefore, app-level modules always take precedence over Python modules. This allows different apps to ship with different versions of their modules, without conflicts.</div><div class=""> </div><div class=""> - Different users can call the same action ``index`` concurrently, which calls the function in the module, and yet there is no conflict because ``current.request`` is a different object in different threads. Just be careful not to access ``current.request`` outside of functions or classes (i.e., at the top level) in the module.</div><div class=""> </div><div class=""> - ``import test`` is a shortcut for ``from applications.appname.modules import test``. Using the longer syntax, it is possible to import modules from other applications.</div><div class=""> Modules that import ``current`` can access:</div><div class=""> - ``current.session``</div><div class=""> - ``current.cache``</div><div class=""> - ``current.T``</div><div class=""> and any other variable your application chooses to store in current. For example a model could do</div><div class=""> </div><div class=""> ``</div><div class=""> auth = Auth(db)</div><div class=""> from gluon import current</div><div class=""> current.auth = auth</div><div class=""> ``</div><div class=""> </div><div class=""> and now all modules imported can access ``current.auth``.</div><div class=""> </div><div class=""> ``current`` and ``import`` create a powerful mechanism to build extensible and reusable modules for your applications.</div><div class=""> </div><div class=""> -------</div><div class=""> Beware! Given ``from gluon import current``, it is correct to use ``current.request`` and any of the other thread local objects but one should never assign them to global variables in the module, such as in</div><div class=""> ``</div><div class=""> request = current.request # WRONG! DANGER!</div><div class=""> ``</div><div class="insert">nor one should <span class="highlight">one </span>use <span class="highlight">curren</span>t<span class="highlight"> to</span> assign class attributes<span class="highlight">:</span></div><div class=""> ``</div><div class=""> class MyClass:</div><div class="">     request = current.request # WRONG! DANGER!</div><div class=""> ``</div><div class=""> This is because the thread local object must be extracted at runtime. Global variables instead are defined only once when the model is imported for the first time.</div><div class=""> -------</div><div class=""> </div><div class=""> Another caveat has to do with cache. You cannot use the ``cache`` object to decorate functions in modules, that is because it would not behave as expected. In order to cache a function ``f`` in a module you must use ``lazy_cache``:</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.cache import lazy_cache</div><div class=""> </div><div class=""> @lazy_cache(&#x27;key&#x27;, time_expire=60, cache_model=&#x27;ram&#x27;)</div><div class=""> def f(a,b,c,): ....</div><div class=""> ``:code</div><div class=""> </div><div class=""> Mind that the key is user defined but must be uniquely associated to the function. If omitted web2py will automatically determine a key.</div><div class=""> </div><div class=""> ### ``request``</div><div class=""> ``request``:inxx ``Storage``:inxx ``request.cookies``:inxx ``user_agent``:inxx</div><div class=""> T(&quot;hello world ## first occurrence&quot;)</div><div class=""> T(&quot;hello world ## second occurrence&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The text following the ``##``, including the double ``##``, are comments.</div><div class=""> </div><div class=""> #### Pluralization engine</div><div class=""> </div><div class=""> Since version 2.0, web2py includes a powerful pluralization system (PS). This means that when text marked for translation depends on a numeric variable, it may be translated differently based on the numeric value. For example in English we may render:</div><div class=""> </div><div class=""> ``</div><div class=""> x book(s)</div><div class=""> ``</div><div class=""> </div><div class=""> with</div><div class=""> </div><div class=""> ``</div><div class=""> a book (x==1)</div><div class=""> 5 books (x==5)</div><div class=""> ``</div><div class=""> </div><div class="insert">English has one singular form and one plural form. The plural form is constructed by adding a &quot;-s&quot; or &quot;-es&quot; or using an exceptional form. web2py provides a way to define pluralization rules for each language<span class="highlight"></span>, as well as exceptions to the default rules. In fact web2py already knows pluralization rules for many languages. It knows, for example, that Slovenian has one singular form and 3 plural forms (for x==1, x==3 or x==4 and x&gt;4). These rules are encoded in &quot;gluon/contrib/plural_rules/*.py&quot; files and new files can be created. Explicit pluralizations for words are created by editing pluralization files using the administrative interface.</div></div></div>
    <div class="span6"><div class="diff"><div class=""> There are some caveats to keep in mind:</div><div class=""> - Models in the same folder/subfolder are executed in alphabetical order.</div><div class=""> - Any variable defined in a model will be visible to other models following alphabetically, to the controllers, and to the views.</div><div class=""> ``models_to_run``:inxx</div><div class=""> - Models in subfolders are executed conditionally. For example, if the user has requested &quot;/a/c/f&quot; where &quot;a&quot; is the application, &quot;c&quot; is the controller, and &quot;f&quot; is the function (action), then the following models are executed:</div><div class=""> </div><div class=""> ``</div><div class=""> applications/a/models/*.py</div><div class=""> applications/a/models/c/*.py</div><div class=""> applications/a/models/c/f/*.py</div><div class=""> ``</div><div class="">   This behaviour is enforced by default. Altering the ``response.models_to_run`` regex list, you can force the behaviour you want. Look at [[response #response_models_to_run]] for additional details</div><div class=""> </div><div class=""> - The requested controller is executed and the requested function is called. This means all top-level code in the controller is also executed at every request for that controller.</div><div class=""> - The view is only called if the action returns a dictionary.</div><div class=""> - If a view is not found, web2py tries to use a generic view. By default, generic views are disabled, although the &#x27;welcome&#x27; app includes a line in /models/db.py to enable them on localhost only. They can be enabled per extension type and per action (using ``response.generic_patterns``). In general, generic views are a development tool and typically should not be used in production. If you want some actions to use a generic view, list those actions in ``response.generic_patterns`` (discussed in more detail in the chapter on Services).</div><div class=""> </div><div class=""> The possible behaviors of an action are the following:</div><div class=""> </div><div class=""> **Return a string**</div><div class=""> ``</div><div class=""> def index(): return &#x27;data&#x27;</div><div class=""> ``</div><div class=""> </div><div class=""> For backward compatibility ``SQLDB=DAL`` and ``SQLField=Field``. We encourage yo</div><div class=""> Other objects and modules are defined in the libraries, but they are not automatically imported since they are not used as often.</div><div class=""> </div><div class=""> The core API entities in the web2py execution environment are ``request``, ``response``, ``session``, ``cache``, ``URL``, ``HTTP``, ``redirect`` and ``T`` and are discussed below.</div><div class=""> </div><div class=""> A few objects and functions, including **Auth**, **Crud** and **Service**, are defined in &quot;gluon/tools.py&quot; and they need to be imported as necessary:</div><div class=""> ``</div><div class=""> from gluon.tools import Auth, Crud, Service</div><div class=""> ``:code</div><div class=""> They are imported in ``db.py`` in the scaffolding application.</div><div class=""> </div><div class=""> #### Accessing the API from Python modules</div><div class=""> </div><div class=""> Your models or controller may import python modules, and these may need to use some of the web2py API. The way to do it is by importing them:</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon import *</div><div class=""> ``</div><div class=""> </div><div class=""> In fact, any Python module, even if not imported by a web2py application, can import the web2py API as long as web2py is in the ``sys.path``.</div><div class=""> </div><div class="delete">There is one caveat, though. Web2py defines some global objects (request, response, session, cache, T) that can only exist when an HTTP request is present (or is faked). Therefore, modules can access them only if they are called from an application. For this reasons they are placed into a container calle<span class="highlight">r</span> ``current``, which is a thread local object. Here is an example.</div><div class=""> </div><div class=""> Create a module &quot;/myapp/modules/test.py&quot; that contains:</div><div class=""> ``</div><div class=""> from gluon import *</div><div class=""> def ip(): return current.request.client</div><div class=""> ``</div><div class=""> Now from a controller in &quot;myapp&quot; you can do</div><div class=""> ``</div><div class=""> import test</div><div class=""> def index():</div><div class="">     return &quot;Your ip is &quot; + test.ip()</div><div class=""> ``</div><div class=""> </div><div class=""> Notice a few things:</div><div class=""> </div><div class=""> - ``import test`` looks for the module first in the current app&#x27;s modules folder, then in the folders listed in ``sys.path``. Therefore, app-level modules always take precedence over Python modules. This allows different apps to ship with different versions of their modules, without conflicts.</div><div class=""> </div><div class=""> - Different users can call the same action ``index`` concurrently, which calls the function in the module, and yet there is no conflict because ``current.request`` is a different object in different threads. Just be careful not to access ``current.request`` outside of functions or classes (i.e., at the top level) in the module.</div><div class=""> </div><div class=""> - ``import test`` is a shortcut for ``from applications.appname.modules import test``. Using the longer syntax, it is possible to import modules from other applications.</div><div class=""> Modules that import ``current`` can access:</div><div class=""> - ``current.session``</div><div class=""> - ``current.cache``</div><div class=""> - ``current.T``</div><div class=""> and any other variable your application chooses to store in current. For example a model could do</div><div class=""> </div><div class=""> ``</div><div class=""> auth = Auth(db)</div><div class=""> from gluon import current</div><div class=""> current.auth = auth</div><div class=""> ``</div><div class=""> </div><div class=""> and now all modules imported can access ``current.auth``.</div><div class=""> </div><div class=""> ``current`` and ``import`` create a powerful mechanism to build extensible and reusable modules for your applications.</div><div class=""> </div><div class=""> -------</div><div class=""> Beware! Given ``from gluon import current``, it is correct to use ``current.request`` and any of the other thread local objects but one should never assign them to global variables in the module, such as in</div><div class=""> ``</div><div class=""> request = current.request # WRONG! DANGER!</div><div class=""> ``</div><div class="delete">nor one should <span class="highlight"></span>use <span class="highlight">i</span>t<span class="highlight"></span> assign class attributes<span class="highlight"></span></div><div class=""> ``</div><div class=""> class MyClass:</div><div class="">     request = current.request # WRONG! DANGER!</div><div class=""> ``</div><div class=""> This is because the thread local object must be extracted at runtime. Global variables instead are defined only once when the model is imported for the first time.</div><div class=""> -------</div><div class=""> </div><div class=""> Another caveat has to do with cache. You cannot use the ``cache`` object to decorate functions in modules, that is because it would not behave as expected. In order to cache a function ``f`` in a module you must use ``lazy_cache``:</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.cache import lazy_cache</div><div class=""> </div><div class=""> @lazy_cache(&#x27;key&#x27;, time_expire=60, cache_model=&#x27;ram&#x27;)</div><div class=""> def f(a,b,c,): ....</div><div class=""> ``:code</div><div class=""> </div><div class=""> Mind that the key is user defined but must be uniquely associated to the function. If omitted web2py will automatically determine a key.</div><div class=""> </div><div class=""> ### ``request``</div><div class=""> ``request``:inxx ``Storage``:inxx ``request.cookies``:inxx ``user_agent``:inxx</div><div class=""> T(&quot;hello world ## first occurrence&quot;)</div><div class=""> T(&quot;hello world ## second occurrence&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The text following the ``##``, including the double ``##``, are comments.</div><div class=""> </div><div class=""> #### Pluralization engine</div><div class=""> </div><div class=""> Since version 2.0, web2py includes a powerful pluralization system (PS). This means that when text marked for translation depends on a numeric variable, it may be translated differently based on the numeric value. For example in English we may render:</div><div class=""> </div><div class=""> ``</div><div class=""> x book(s)</div><div class=""> ``</div><div class=""> </div><div class=""> with</div><div class=""> </div><div class=""> ``</div><div class=""> a book (x==1)</div><div class=""> 5 books (x==5)</div><div class=""> ``</div><div class=""> </div><div class="delete">English has one singular form and one plural form. The plural form is constructed by adding a &quot;-s&quot; or &quot;-es&quot; or using an exceptional form. web2py provides a way to define pluralization rules for each language<span class="highlight">s</span>, as well as exceptions to the default rules. In fact web2py already knows pluralization rules for many languages. It knows, for example, that Slovenian has one singular form and 3 plural forms (for x==1, x==3 or x==4 and x&gt;4). These rules are encoded in &quot;gluon/contrib/plural_rules/*.py&quot; files and new files can be created. Explicit pluralizations for words are created by editing pluralization files using the administrative interface.</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/5df5b9dd5e0315a674b3cbd977cfe69600fd0a05">5df5b9d</a><ul><li>Date : 2014-02-08</li><li>changes to cache. Remove -W cmdline opt.</li></ul></li></ul>
<div class="row-fluid" id="com_5df5b9dd5e0315a674b3cbd977cfe69600fd0a05">
    <div class="span6"><div class="diff"><div class="">   -C, --cron            trigger a cron run manually; usually invoked from a</div><div class="">                         system crontab</div><div class="">   --softcron            triggers the use of softcron</div><div class="">   -Y, --run-cron        start the background cron process</div><div class="">   -J, --cronjob         identify cron-initiated command</div><div class="">   -L CONFIG, --config=CONFIG</div><div class="">                         config file</div><div class="">   -F PROFILER_FILENAME, --profiler=PROFILER_FILENAME</div><div class="">                         profiler filename</div><div class="">   -t, --taskbar         use web2py gui and run in taskbar (system tray)</div><div class="">   --nogui               text-only, no GUI</div><div class="">   -A ARGS, --args=ARGS  should be followed by a list of arguments to be passed</div><div class="">                         to script, to be used with -S, -A must be the last</div><div class="">                         option</div><div class="">   --no-banner           Do not print header banner</div><div class="">   --interfaces=INTERFACES</div><div class="">                         listen on multiple addresses: &quot;ip1:port1:key1:cert1:ca</div><div class="">                         _cert1;ip2:port2:key2:cert2:ca_cert2;...&quot;</div><div class="">                         (:key:cert:ca_cert optional; no spaces; IPv6 addresses</div><div class="">                         must be in square [] brackets)</div><div class="">   --run_system_tests    runs web2py tests</div><div class=""> ``:code</div><div class=""> </div><div class="insert">+------</div><div class="insert">+Please note: The option ``-W``, used to install a Windows service, has been removed. Please see [[nssm in the Deployment Recipes chapter ../13/#nssm]]</div><div class="insert">+------</div><div class="insert">+</div><div class=""> Lower-case options are used to configure the web server. The ``-L`` option tells web2py to read configuration options from a file, ``-W`` installs web2py as a windows service, while ``-S``, ``-P`` and ``-M`` options start an interactive Python shell. The ``-T`` option finds and runs controller doctests in a web2py execution environment. For example, the following example runs doctests from all controllers in the &quot;welcome&quot; application:</div><div class=""> ``</div><div class=""> python web2py.py -vT welcome</div><div class=""> ``:code</div><div class=""> </div><div class=""> if you run web2py as a Windows Service, ``-W``,  it is not convenient to pass the configuration using command line arguments. For this reason, in the web2py folder there is a sample &quot;options_std.py&quot; configuration file for the internal web server:</div><div class=""> </div><div class=""> ``</div><div class=""> import socket</div><div class=""> import os</div><div class=""> </div><div class=""> ip = &#x27;0.0.0.0&#x27;</div><div class=""> port = 80</div><div class=""> interfaces = [(&#x27;0.0.0.0&#x27;, 80)]</div><div class="">                #,(&#x27;0.0.0.0&#x27;,443,&#x27;ssl_private_key.pem&#x27;,&#x27;ssl_certificate.pem&#x27;)]</div><div class=""> password = &#x27;&lt;recycle&gt;&#x27;  # ## &lt;recycle&gt; means use the previous password</div><div class=""> pid_filename = &#x27;httpserver.pid&#x27;</div><div class=""> log_filename = &#x27;httpserver.log&#x27;</div><div class=""> profiler_filename = None</div><div class=""> ssl_certificate = None  # &#x27;ssl_certificate.pem&#x27;  # ## path to certificate file</div><div class=""> def cache_controller_on_disk():</div><div class="">     t = time.ctime()</div><div class="">     return dict(time=t, link=A(&#x27;click to reload&#x27;,</div><div class="">                               _href=request.url))</div><div class=""> ``:code</div><div class=""> </div><div class=""> The dictionary returned by ``cache_controller_on_disk``  is cached on disk for 5 seconds. Remember that web2py cannot cache a dictionary that contains un-pickleable objects.</div><div class=""> </div><div class=""> It is also possible to cache the view. The trick is to render the view in the controller function, so that the controller returns a string. This is done by returning ``response.render(d)`` where ``d`` is the dictionary we intended to pass to the view. The following example caches the output of the controller function in RAM (including the rendered view):</div><div class=""> </div><div class=""> ``cache view``:inxx</div><div class=""> ``</div><div class=""> @cache(request.env.path_info, time_expire=5, cache_model=cache.ram)</div><div class=""> def cache_controller_and_view():</div><div class="">     import time</div><div class="">     t = time.ctime()</div><div class="">     d = dict(time=t, link=A(&#x27;click to reload&#x27;, _href=request.url))</div><div class="">     return response.render(d)</div><div class=""> ``:code</div><div class=""> ``response.render(d)`` returns the rendered view as a string, which is now cached for 5 seconds. This is the best and fastest way of caching.</div><div class=""> ------</div><div class="insert">We recommend <span class="highlight">[[</span>@cache.action<span class="highlight"> #cache_action]]</span> starting from web2py &gt; 2.4.6 </div><div class=""> ------</div><div class=""> </div><div class=""> Note, ``time_expire`` is used to compare the current time with the time the requested object was last saved in the cache. It does not affect future requests. This enables ``time_expire`` to be set dynamically when an object is requested rather than being fixed when the object is saved. For example:</div><div class=""> ``</div><div class=""> message = cache.ram(&#x27;message&#x27;, lambda: &#x27;Hello&#x27;, time_expire=5)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Now, suppose the following call is made 10 seconds after the above call:</div><div class=""> ``</div><div class=""> message = cache.ram(&#x27;message&#x27;, lambda: &#x27;Goodbye&#x27;, time_expire=20)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Because ``time_expire`` is set to 20 seconds in the second call and only 10 seconds has elapsed since the message was first saved, the value &quot;Hello&quot; will be retrieved from the cache, and it will not be updated with &quot;Goodbye&quot;. The ``time_expire`` value of 5 seconds in the first call has no impact on the second call.</div><div class=""> </div><div class=""> Setting ``time_expire=0`` (or a negative value) forces the cached item to be refreshed (because the elapsed time since the last save will always be &gt; 0), and setting ``time_expire=None`` forces retrieval of the cached value, regardless of the time elapsed since it was saved (if ``time_expire`` is always ``None``, the cached item will effectively never expire).</div><div class=""> </div><div class=""> You can clear one or more cache variables with</div><div class=""> ``cache clear``:inxx</div><div class=""> </div><div class=""> ``</div><div class=""> cache.ram.clear(regex=&#x27;...&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> where ``regex`` is a regular expression matching all the keys you want removed from the cache. You can also clear a single item with:</div><div class=""> ``</div><div class=""> cache.ram(key, None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> where ``key`` is the key of the cached item.</div><div class=""> </div><div class=""> It is also possible to define other caching mechanisms such as memcache. Memcache is available via ``gluon.contrib.memcache`` and is discussed in more detail in Chapter 14.</div><div class=""> </div><div class=""> ------</div><div class="insert">+Be careful when caching to remember that caching is usually at the app-level not at the user level. If you need, for example, to cache user specific content, choose a key that includes the user id.</div><div class="insert">+------</div><div class="insert">+</div><div class="insert">+------</div><div class="insert">+The admin app for an application lets you view cache keys (and clear the cache). Access it from the database management screen of admin.</div><div class=""> ------</div><div class=""> </div><div class="insert">+[[cache_action]]</div><div class=""> #### ``cache.action``</div><div class=""> Web2py by default assumes that the returned content is not going to be cached, as this reduces the shortcomings of an improper caching of the page client-side.</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">-  -W WINSERVICE, --winservice=WINSERVICE </div><div class="delete">-                        -W install|start|stop as Windows service. </div><div class="delete">-                        However, this is deprecated. Please see </div><div class="delete">-                        use of nssm in the Deployment Recipes chapter</div><div class="">   -C, --cron            trigger a cron run manually; usually invoked from a</div><div class="">                         system crontab</div><div class="">   --softcron            triggers the use of softcron</div><div class="">   -Y, --run-cron        start the background cron process</div><div class="">   -J, --cronjob         identify cron-initiated command</div><div class="">   -L CONFIG, --config=CONFIG</div><div class="">                         config file</div><div class="">   -F PROFILER_FILENAME, --profiler=PROFILER_FILENAME</div><div class="">                         profiler filename</div><div class="">   -t, --taskbar         use web2py gui and run in taskbar (system tray)</div><div class="">   --nogui               text-only, no GUI</div><div class="">   -A ARGS, --args=ARGS  should be followed by a list of arguments to be passed</div><div class="">                         to script, to be used with -S, -A must be the last</div><div class="">                         option</div><div class="">   --no-banner           Do not print header banner</div><div class="">   --interfaces=INTERFACES</div><div class="">                         listen on multiple addresses: &quot;ip1:port1:key1:cert1:ca</div><div class="">                         _cert1;ip2:port2:key2:cert2:ca_cert2;...&quot;</div><div class="">                         (:key:cert:ca_cert optional; no spaces; IPv6 addresses</div><div class="">                         must be in square [] brackets)</div><div class="">   --run_system_tests    runs web2py tests</div><div class=""> ``:code</div><div class=""> </div><div class=""> Lower-case options are used to configure the web server. The ``-L`` option tells web2py to read configuration options from a file, ``-W`` installs web2py as a windows service, while ``-S``, ``-P`` and ``-M`` options start an interactive Python shell. The ``-T`` option finds and runs controller doctests in a web2py execution environment. For example, the following example runs doctests from all controllers in the &quot;welcome&quot; application:</div><div class=""> ``</div><div class=""> python web2py.py -vT welcome</div><div class=""> ``:code</div><div class=""> </div><div class=""> if you run web2py as a Windows Service, ``-W``,  it is not convenient to pass the configuration using command line arguments. For this reason, in the web2py folder there is a sample &quot;options_std.py&quot; configuration file for the internal web server:</div><div class=""> </div><div class=""> ``</div><div class=""> import socket</div><div class=""> import os</div><div class=""> </div><div class=""> ip = &#x27;0.0.0.0&#x27;</div><div class=""> port = 80</div><div class=""> interfaces = [(&#x27;0.0.0.0&#x27;, 80)]</div><div class="">                #,(&#x27;0.0.0.0&#x27;,443,&#x27;ssl_private_key.pem&#x27;,&#x27;ssl_certificate.pem&#x27;)]</div><div class=""> password = &#x27;&lt;recycle&gt;&#x27;  # ## &lt;recycle&gt; means use the previous password</div><div class=""> pid_filename = &#x27;httpserver.pid&#x27;</div><div class=""> log_filename = &#x27;httpserver.log&#x27;</div><div class=""> profiler_filename = None</div><div class=""> ssl_certificate = None  # &#x27;ssl_certificate.pem&#x27;  # ## path to certificate file</div><div class=""> def cache_controller_on_disk():</div><div class="">     t = time.ctime()</div><div class="">     return dict(time=t, link=A(&#x27;click to reload&#x27;,</div><div class="">                               _href=request.url))</div><div class=""> ``:code</div><div class=""> </div><div class=""> The dictionary returned by ``cache_controller_on_disk``  is cached on disk for 5 seconds. Remember that web2py cannot cache a dictionary that contains un-pickleable objects.</div><div class=""> </div><div class=""> It is also possible to cache the view. The trick is to render the view in the controller function, so that the controller returns a string. This is done by returning ``response.render(d)`` where ``d`` is the dictionary we intended to pass to the view. The following example caches the output of the controller function in RAM (including the rendered view):</div><div class=""> </div><div class=""> ``cache view``:inxx</div><div class=""> ``</div><div class=""> @cache(request.env.path_info, time_expire=5, cache_model=cache.ram)</div><div class=""> def cache_controller_and_view():</div><div class="">     import time</div><div class="">     t = time.ctime()</div><div class="">     d = dict(time=t, link=A(&#x27;click to reload&#x27;, _href=request.url))</div><div class="">     return response.render(d)</div><div class=""> ``:code</div><div class=""> ``response.render(d)`` returns the rendered view as a string, which is now cached for 5 seconds. This is the best and fastest way of caching.</div><div class=""> ------</div><div class="delete">We recommend <span class="highlight">to use </span>@cache.action<span class="highlight"></span> starting from web2py &gt; 2.4.6 </div><div class=""> ------</div><div class=""> </div><div class=""> Note, ``time_expire`` is used to compare the current time with the time the requested object was last saved in the cache. It does not affect future requests. This enables ``time_expire`` to be set dynamically when an object is requested rather than being fixed when the object is saved. For example:</div><div class=""> ``</div><div class=""> message = cache.ram(&#x27;message&#x27;, lambda: &#x27;Hello&#x27;, time_expire=5)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Now, suppose the following call is made 10 seconds after the above call:</div><div class=""> ``</div><div class=""> message = cache.ram(&#x27;message&#x27;, lambda: &#x27;Goodbye&#x27;, time_expire=20)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Because ``time_expire`` is set to 20 seconds in the second call and only 10 seconds has elapsed since the message was first saved, the value &quot;Hello&quot; will be retrieved from the cache, and it will not be updated with &quot;Goodbye&quot;. The ``time_expire`` value of 5 seconds in the first call has no impact on the second call.</div><div class=""> </div><div class=""> Setting ``time_expire=0`` (or a negative value) forces the cached item to be refreshed (because the elapsed time since the last save will always be &gt; 0), and setting ``time_expire=None`` forces retrieval of the cached value, regardless of the time elapsed since it was saved (if ``time_expire`` is always ``None``, the cached item will effectively never expire).</div><div class=""> </div><div class=""> You can clear one or more cache variables with</div><div class=""> ``cache clear``:inxx</div><div class=""> </div><div class=""> ``</div><div class=""> cache.ram.clear(regex=&#x27;...&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> where ``regex`` is a regular expression matching all the keys you want removed from the cache. You can also clear a single item with:</div><div class=""> ``</div><div class=""> cache.ram(key, None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> where ``key`` is the key of the cached item.</div><div class=""> </div><div class=""> It is also possible to define other caching mechanisms such as memcache. Memcache is available via ``gluon.contrib.memcache`` and is discussed in more detail in Chapter 14.</div><div class=""> </div><div class=""> ------</div><div class="delete">-Be careful when caching to remeber that caching is usually at the app-level not at the user level. If you need, for example, to cache user specific content, choose a key that includes the user id.</div><div class=""> ------</div><div class=""> </div><div class=""> #### ``cache.action``</div><div class=""> Web2py by default assumes that the returned content is not going to be cached, as this reduces the shortcomings of an improper caching of the page client-side.</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/837efe4e87a76b921e7b61cde5aea4d726356b2b">837efe4</a><ul><li>Date : 2014-02-02</li><li>Some better cross referencing for the A and URL helpers</li></ul></li></ul>
<div class="row-fluid" id="com_837efe4e87a76b921e7b61cde5aea4d726356b2b">
    <div class="span6"><div class="diff"><div class="insert">+[[URL]]</div><div class=""> ### ``URL``</div><div class=""> ``URL``:inxx</div><div class=""> The ``URL`` function is one of the most important functions in web2py. It generates internal URL paths for the actions and the static files.</div></div></div>
    <div class="span6"><div class="diff"><div class=""> ### ``URL``</div><div class=""> ``URL``:inxx</div><div class=""> The ``URL`` function is one of the most important functions in web2py. It generates internal URL paths for the actions and the static files.</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/944df2a7389d729cf013d02eae65c18518b8cc16">944df2a</a><ul><li>Date : 2014-02-02</li><li>Fixed the obsolete reference to hmac settings, better internal links. hmac fix. Added a few cross references throughout the book (i.e. internal links), gave a few more examples of Markmin links, changed a reference to 5th edition and added ch 15 to the introduction's summary of chapters</li></ul></li></ul>
<div class="row-fluid" id="com_944df2a7389d729cf013d02eae65c18518b8cc16">
    <div class="span6"><div class="diff"><div class=""> **markmin** markup:</div><div class=""> ``</div><div class=""> gluon/contrib/markmin</div><div class=""> ``:code</div><div class="insert">+(see [[MARKMIN syntax ../05/#markmin_syntax]] for more)</div><div class=""> </div><div class=""> **fpdf** created my Mariano Reingart for generating PDF documents:</div><div class=""> ``</div><div class=""> gluon/contrib/fpdf</div><div class=""> ``</div><div class=""> This is not documented in this book but it is hosted and documented here:</div><div class=""> ``</div><div class=""> http://code.google.com/p/pyfpdf/</div><div class=""> ``</div><div class=""> </div><div class=""> **pysimplesoap** is a lightweight SOAP server implementation created by Mariano Reingart:</div><div class=""> </div><div class=""> ``</div><div class=""> gluon/contrib/pysimplesoap/</div><div class=""> ``:code</div><div class=""> </div><div class=""> **simplejsonrpc** is a lightweight JSON-RPC client also created by Mariano Reingart: ``jsonrpc``:inxx</div><div class=""> </div><div class=""> ``</div><div class=""> gluon/contrib/simplejsonrpc.py</div><div class=""> Inside ``%%{...}`` you can also use the following modifiers:</div><div class=""> - ``!`` to capitalize the text (equivalent to ``string.capitalize``)</div><div class=""> - ``!!`` to capitalize every word (equivalent to ``string.title``)</div><div class=""> - ``!!!`` to capitalize every character (equivalent to ``string.upper``)</div><div class=""> </div><div class=""> Notice you can use \ to escape ``!`` and ``?``.</div><div class=""> </div><div class=""> #### Translations, pluralization, and MARKMIN</div><div class=""> </div><div class=""> You can also use the powerful MARKMIN syntax inside translation strings by replacing</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;hello world&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> with</div><div class=""> </div><div class=""> ``</div><div class=""> T.M(&quot;hello world&quot;)</div><div class=""> ``</div><div class=""> </div><div class="insert">Now the string accepts MARKMIN markup as described <span class="highlight">in [[Ch</span>a<span class="highlight">p</span>ter <span class="highlight">5 ../05#markm</span>in<span class="highlight">_</span>sy<span class="highlight">n</span>t<span class="highlight">ax]]</span></div></div></div>
    <div class="span6"><div class="diff"><div class=""> **markmin** markup:</div><div class=""> ``</div><div class=""> gluon/contrib/markmin</div><div class=""> ``:code</div><div class=""> </div><div class=""> **fpdf** created my Mariano Reingart for generating PDF documents:</div><div class=""> ``</div><div class=""> gluon/contrib/fpdf</div><div class=""> ``</div><div class=""> This is not documented in this book but it is hosted and documented here:</div><div class=""> ``</div><div class=""> http://code.google.com/p/pyfpdf/</div><div class=""> ``</div><div class=""> </div><div class=""> **pysimplesoap** is a lightweight SOAP server implementation created by Mariano Reingart:</div><div class=""> </div><div class=""> ``</div><div class=""> gluon/contrib/pysimplesoap/</div><div class=""> ``:code</div><div class=""> </div><div class=""> **simplejsonrpc** is a lightweight JSON-RPC client also created by Mariano Reingart: ``jsonrpc``:inxx</div><div class=""> </div><div class=""> ``</div><div class=""> gluon/contrib/simplejsonrpc.py</div><div class=""> Inside ``%%{...}`` you can also use the following modifiers:</div><div class=""> - ``!`` to capitalize the text (equivalent to ``string.capitalize``)</div><div class=""> - ``!!`` to capitalize every word (equivalent to ``string.title``)</div><div class=""> - ``!!!`` to capitalize every character (equivalent to ``string.upper``)</div><div class=""> </div><div class=""> Notice you can use \ to escape ``!`` and ``?``.</div><div class=""> </div><div class=""> #### Translations, pluralization, and MARKMIN</div><div class=""> </div><div class=""> You can also use the powerful MARKMIN syntax inside translation strings by replacing</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;hello world&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> with</div><div class=""> </div><div class=""> ``</div><div class=""> T.M(&quot;hello world&quot;)</div><div class=""> ``</div><div class=""> </div><div class="delete">Now the string accepts MARKMIN markup as described <span class="highlight">l</span>a<span class="highlight"></span>ter <span class="highlight"></span>in<span class="highlight"> the book. You can also use the pluralization </span>sy<span class="highlight">s</span>t<span class="highlight">em inside MARKMIN.</span></div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/4ce1dd997904e455f83c860f74756262ad3418af">4ce1dd9</a><ul><li>Date : 2014-01-23</li><li>Fixed description of response.stream() which does not take a "headers" argument.</li></ul></li></ul>
<div class="row-fluid" id="com_4ce1dd997904e455f83c860f74756262ad3418af">
    <div class="span6"><div class="diff"><div class=""> - ``response.body``: a ``StringIO`` object into which web2py writes the output page body. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.cookies``: similar to ``request.cookies``, but while the latter contains the cookies sent from the client to the server, the former contains cookies sent by the server to the client. The session cookie is handled automatically.</div><div class=""> - ``response.download(request, db)``: a method used to implement the controller function that allows downloading of uploaded files. ``response.download`` expects the last ``arg`` in ``request.args`` to be the encoded filename (i.e., the filename generated at upload time and stored in the upload field). It extracts the upload field name and table name as well as the original filename from the encoded filename. ``response.download`` takes two optional arguments: ``chunk_size`` sets the size in bytes for chunked streaming (defaults to 64K), and ``attachments`` determines whether the downloaded file should be treated as an attachment or not (default to ``True``). Note, ``response.download`` is specifically for downloading files associated with ``db`` upload fields. Use ``response.stream`` (see below) for other types of file downloads and streaming. Also, note that it is not necessary to use ``response.download`` to access files uploaded to the /static folder -- static files can (and generally should) be accessed directly via URL (e.g., /app/static/files/myfile.pdf).</div><div class=""> - ``response.files``: a list of ``.css``, ``.js``, ``.coffee``, and ``.less`` files required by the page. They will automatically be linked in the head of the standard &quot;layout.html&quot; via the included &quot;web2py_ajax.html&quot;. To include a new CSS, JS, COFFEE, or LESS file, just append it to this list. It will handle duplicates. The order is important.</div><div class=""> - ``response.include_files()`` generates html head tags to include all ``response.files`` (used in &quot;views/web2py_ajax.html&quot;).</div><div class=""> - ``response.flash``: optional parameter that may be included in the views. Normally used to notify the user about something that happened.</div><div class=""> - ``response.headers``: a ``dict`` for HTTP response headers. Web2py sets some headers by default, including &quot;Content-Length&quot;, &quot;Content-Type&quot;, and &quot;X-Powered-By&quot; (set equal to web2py). Web2py also sets the &quot;Cache-Control&quot;, &quot;Expires&quot;, and &quot;Pragma&quot; headers to prevent client-side caching, except for static file requests, for which client-side caching is enabled. The headers that web2py sets can be overwritten or removed, and new headers can be added (e.g., ``response.headers[&#x27;Cache-Control&#x27;] = &#x27;private&#x27;``). You can remove a header by removing its key from the response.headers dict, e.g. ``del response.headers[&#x27;Custom-Header&#x27;]``, however web2py&#x27;s default headers will be re-added just before returning the response. To avoid this behavior, just set the header value to None, e.g. to remove the default Content-Type header, ``response.headers[&#x27;Content-Type&#x27;] = None``</div><div class=""> - ``response.menu``: optional parameter that may be included in the views, normally used to pass a navigation menu tree to the view. It can be rendered by the MENU helper.</div><div class=""> - ``response.meta``: a Storage object that contains optional ``&lt;meta&gt;`` information like ``response.meta.author``, ``.description``, and/or ``.keywords``. The content of each meta variable is automatically placed in the proper ``META`` tag by the code in &quot;views/web2py_ajax.html&quot;, which is included by default in &quot;views/layout.html&quot;.</div><div class=""> - ``response.include_meta()`` generates a string that includes all ``response.meta`` headers serialized (used in &quot;views/web2py_ajax.html&quot;).</div><div class=""> - ``response.postprocessing``: this is a list of functions, empty by default. These functions are used to filter the response object at the output of an action, before the output is rendered by the view. It can be used to implement support for other template languages.</div><div class=""> - ``response.render(view, vars)``: a method used to call the view explicitly inside the controller. ``view`` is an optional parameter which is the name of the view file, ``vars`` is a dictionary of named values passed to the view.</div><div class=""> - ``response.session_file``: file stream containing the session.</div><div class=""> - ``response.session_file_name``: name of the file where the session will be saved.</div><div class=""> - ``response.session_id``: the id of the current session. It is determined automatically. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.session_id_name``: the name of the session cookie for this application. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.static_version``: a version number for the static asset management.  </div><div class=""> - ``response.status``: the HTTP status code integer to be passed to the response. Default is 200 (OK).</div><div class="insert">- ``response.stream(file, chunk_size, request=request, attachment=False, filename<span class="highlight"></span>=None)``: when a controller returns it, web2py streams the file content back to the client in blocks of size ``chunk_size``. The ``request`` parameter is required to use the chunk start in the HTTP header. ``file`` should be a file path (for backward compatibility, it can also be an open file object, but this is not recommended). As noted above, ``response.download`` should be used to retrieve files stored via an upload field. ``response.stream`` can be used in other cases, such as returning a temporary file or StringIO object created by the controller. If ``attachment`` is True, the Content-Disposition header will be set to &quot;attachment&quot;, and if ``filename`` is also provided, it will be added to the Content-Disposition header as well (but only when ``attachment`` is True). If not already included in ``response.headers``, the following response headers will be set automatically: Content-Type, Content-Length, Cache-Control, Pragma, and Last-Modified (the latter three are set to allow browser caching of the file). To override any of these automatic header settings, simply set them in ``response.headers`` before calling ``response.stream``.</div><div class=""> - ``response.subtitle``: optional parameter that may be included in the views. It should contain the subtitle of the page.</div><div class=""> - ``response.title``: optional parameter that may be included in the views. It should contain the title of the page and should be rendered inside the html title tag in the header.</div><div class=""> - ``response.toolbar``: a function that allows you to embed a toolbar into page for debugging purposes ``{{=response.toolbar()}}``. The toolbar displays request, response, session variables and database access time for each query.</div><div class=""> - ``response._vars``: this variable is accessible only in a view, not in the action. It contains the values returned by the action to the view.</div><div class=""> - ``response._caller``: this is a function that wraps all action calls. It defaults to the identity function, but it can be modified in order to catch special types of exception to do extra logging;</div><div class="">   ``</div><div class="">   response._caller = lambda f: f()</div><div class="">   ``</div><div class=""> - ``response.optimize_css``: can be set to &quot;concat,minify,inline&quot; to concatenate, minify and inline the CSS files included by web2py.</div><div class=""> - ``response.optimize_js``: can be set to &quot;concat,minify,inline&quot; to concatenate, minify and inline the JavaScript files included by web2py. </div><div class=""> - ``response.view``: the name of the view template that must render the page. This is set by default to:</div><div class="">   ``</div><div class="">   &quot;%s/%s.%s&quot; % (request.controller, request.function, request.extension)</div><div class="">   ``:code</div><div class="">   or, if the above file cannot be located, to</div><div class="">   ``</div><div class="">   &quot;generic.%s&quot; % (request.extension)</div><div class="">   ``:code</div><div class="">   Change the value of this variable to modify the view file associated with a particular action.</div></div></div>
    <div class="span6"><div class="diff"><div class=""> - ``response.body``: a ``StringIO`` object into which web2py writes the output page body. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.cookies``: similar to ``request.cookies``, but while the latter contains the cookies sent from the client to the server, the former contains cookies sent by the server to the client. The session cookie is handled automatically.</div><div class=""> - ``response.download(request, db)``: a method used to implement the controller function that allows downloading of uploaded files. ``response.download`` expects the last ``arg`` in ``request.args`` to be the encoded filename (i.e., the filename generated at upload time and stored in the upload field). It extracts the upload field name and table name as well as the original filename from the encoded filename. ``response.download`` takes two optional arguments: ``chunk_size`` sets the size in bytes for chunked streaming (defaults to 64K), and ``attachments`` determines whether the downloaded file should be treated as an attachment or not (default to ``True``). Note, ``response.download`` is specifically for downloading files associated with ``db`` upload fields. Use ``response.stream`` (see below) for other types of file downloads and streaming. Also, note that it is not necessary to use ``response.download`` to access files uploaded to the /static folder -- static files can (and generally should) be accessed directly via URL (e.g., /app/static/files/myfile.pdf).</div><div class=""> - ``response.files``: a list of ``.css``, ``.js``, ``.coffee``, and ``.less`` files required by the page. They will automatically be linked in the head of the standard &quot;layout.html&quot; via the included &quot;web2py_ajax.html&quot;. To include a new CSS, JS, COFFEE, or LESS file, just append it to this list. It will handle duplicates. The order is important.</div><div class=""> - ``response.include_files()`` generates html head tags to include all ``response.files`` (used in &quot;views/web2py_ajax.html&quot;).</div><div class=""> - ``response.flash``: optional parameter that may be included in the views. Normally used to notify the user about something that happened.</div><div class=""> - ``response.headers``: a ``dict`` for HTTP response headers. Web2py sets some headers by default, including &quot;Content-Length&quot;, &quot;Content-Type&quot;, and &quot;X-Powered-By&quot; (set equal to web2py). Web2py also sets the &quot;Cache-Control&quot;, &quot;Expires&quot;, and &quot;Pragma&quot; headers to prevent client-side caching, except for static file requests, for which client-side caching is enabled. The headers that web2py sets can be overwritten or removed, and new headers can be added (e.g., ``response.headers[&#x27;Cache-Control&#x27;] = &#x27;private&#x27;``). You can remove a header by removing its key from the response.headers dict, e.g. ``del response.headers[&#x27;Custom-Header&#x27;]``, however web2py&#x27;s default headers will be re-added just before returning the response. To avoid this behavior, just set the header value to None, e.g. to remove the default Content-Type header, ``response.headers[&#x27;Content-Type&#x27;] = None``</div><div class=""> - ``response.menu``: optional parameter that may be included in the views, normally used to pass a navigation menu tree to the view. It can be rendered by the MENU helper.</div><div class=""> - ``response.meta``: a Storage object that contains optional ``&lt;meta&gt;`` information like ``response.meta.author``, ``.description``, and/or ``.keywords``. The content of each meta variable is automatically placed in the proper ``META`` tag by the code in &quot;views/web2py_ajax.html&quot;, which is included by default in &quot;views/layout.html&quot;.</div><div class=""> - ``response.include_meta()`` generates a string that includes all ``response.meta`` headers serialized (used in &quot;views/web2py_ajax.html&quot;).</div><div class=""> - ``response.postprocessing``: this is a list of functions, empty by default. These functions are used to filter the response object at the output of an action, before the output is rendered by the view. It can be used to implement support for other template languages.</div><div class=""> - ``response.render(view, vars)``: a method used to call the view explicitly inside the controller. ``view`` is an optional parameter which is the name of the view file, ``vars`` is a dictionary of named values passed to the view.</div><div class=""> - ``response.session_file``: file stream containing the session.</div><div class=""> - ``response.session_file_name``: name of the file where the session will be saved.</div><div class=""> - ``response.session_id``: the id of the current session. It is determined automatically. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.session_id_name``: the name of the session cookie for this application. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.static_version``: a version number for the static asset management.  </div><div class=""> - ``response.status``: the HTTP status code integer to be passed to the response. Default is 200 (OK).</div><div class="delete">- ``response.stream(file, chunk_size, request=request, attachment=False, filename<span class="highlight">=None, headers</span>=None)``: when a controller returns it, web2py streams the file content back to the client in blocks of size ``chunk_size``. The ``request`` parameter is required to use the chunk start in the HTTP header. ``file`` should be a file path (for backward compatibility, it can also be an open file object, but this is not recommended). As noted above, ``response.download`` should be used to retrieve files stored via an upload field. ``response.stream`` can be used in other cases, such as returning a temporary file or StringIO object created by the controller. If ``attachment`` is True, the Content-Disposition header will be set to &quot;attachment&quot;, and if ``filename`` is also provided, it will be added to the Content-Disposition header as well (but only when ``attachment`` is True). If not already included in ``response.headers``, the following response headers will be set automatically: Content-Type, Content-Length, Cache-Control, Pragma, and Last-Modified (the latter three are set to allow browser caching of the file). To override any of these automatic header settings, simply set them in ``response.headers`` before calling ``response.stream``.</div><div class=""> - ``response.subtitle``: optional parameter that may be included in the views. It should contain the subtitle of the page.</div><div class=""> - ``response.title``: optional parameter that may be included in the views. It should contain the title of the page and should be rendered inside the html title tag in the header.</div><div class=""> - ``response.toolbar``: a function that allows you to embed a toolbar into page for debugging purposes ``{{=response.toolbar()}}``. The toolbar displays request, response, session variables and database access time for each query.</div><div class=""> - ``response._vars``: this variable is accessible only in a view, not in the action. It contains the values returned by the action to the view.</div><div class=""> - ``response._caller``: this is a function that wraps all action calls. It defaults to the identity function, but it can be modified in order to catch special types of exception to do extra logging;</div><div class="">   ``</div><div class="">   response._caller = lambda f: f()</div><div class="">   ``</div><div class=""> - ``response.optimize_css``: can be set to &quot;concat,minify,inline&quot; to concatenate, minify and inline the CSS files included by web2py.</div><div class=""> - ``response.optimize_js``: can be set to &quot;concat,minify,inline&quot; to concatenate, minify and inline the JavaScript files included by web2py. </div><div class=""> - ``response.view``: the name of the view template that must render the page. This is set by default to:</div><div class="">   ``</div><div class="">   &quot;%s/%s.%s&quot; % (request.controller, request.function, request.extension)</div><div class="">   ``:code</div><div class="">   or, if the above file cannot be located, to</div><div class="">   ``</div><div class="">   &quot;generic.%s&quot; % (request.extension)</div><div class="">   ``:code</div><div class="">   Change the value of this variable to modify the view file associated with a particular action.</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/a07816cbd9bbd91235d592a25658ba25e33c2158">a07816c</a><ul><li>Date : 2014-01-21</li><li>Updated scheduler documentation for prevent_drift</li></ul></li></ul>
<div class="row-fluid" id="com_a07816cbd9bbd91235d592a25658ba25e33c2158">
    <div class="span6"><div class="diff"><div class="insert">+To add tasks via the API, use</div><div class="insert">+``</div><div class="insert">+scheduler.queue_task(&#x27;mytask&#x27;,...)</div><div class="insert">+``</div><div class="insert">+which is documented [[below #queue_task_sig]] .</div><div class="insert">+</div><div class="insert">+</div><div class="insert">+##### Task Lifecycle</div><div class=""> All tasks follow a lifecycle</div><div class=""> </div><div class="insert">+</div><div class=""> [[scheduler tasks @///image/ce8edcc3.png center]]</div><div class=""> </div><div class=""> By default, when you send a task to the scheduler, </div><div class=""> it is in the **QUEUED** status.</div><div class=""> If you need it to be executed later, use the ``start_time`` parameter (default = now).</div><div class=""> If for some reason you need to be sure that the task does not </div><div class=""> get executed after a certain point in time (maybe a request to a web service</div><div class=""> that shuts down at 1AM, a mail that needs to be sent not after the working hours, etc...) you can set a ``stop_time`` (default = None) for it.</div><div class=""> If your task is NOT picked up by a worker before ``stop_time``, it will be set as **EXPIRED**.</div><div class=""> Tasks with no ``stop_time`` set or picked up **BEFORE** stop_time are **ASSIGNED** to a worker. When a workers picks up a task, its status is set to **RUNNING**.</div><div class=""> </div><div class=""> **RUNNING** tasks may end up:</div><div class=""> - **TIMEOUT** when more than ``n`` seconds passed with ``timeout`` parameter (default = 60 seconds).</div><div class=""> - **FAILED** when an exception is detected,</div><div class=""> - **COMPLETED** when they successfully complete.</div><div class=""> </div><div class=""> Values for ``start_time`` and ``stop_time`` should be datetime objects. To schedule &quot;mytask&quot; to run at 30 seconds from the current time, for example, you would do the following:</div><div class=""> </div><div class=""> ``</div><div class=""> from datetime import timedelta as timed</div><div class=""> scheduler.queue_task(&#x27;mytask&#x27;,</div><div class="">     start_time=request.now + timed(seconds=30))</div><div class=""> ``:code</div><div class=""> </div><div class=""> Additionally, you can control how many times a task should be repeated (i.e. you need to aggregate some data at specified intervals). To do so, set the ``repeats``</div><div class=""> parameter (default = 1 time only, 0 = unlimited). You can influence how many seconds should pass between executions with the ``period`` parameter (default = 60 seconds).</div><div class=""> </div><div class=""> ------</div><div class="insert">+Default behavior: The time period is not calculated between the END of the first round and the START of the next, but from the START time of the first round to the START time of the next cycle). </div><div class="insert">+This can cause accumulating &#x27;drift&#x27; in the start time of a job.</div><div class="insert">+After v 2.8.2, a new parameter ``prevent_drift`` was added, defaulting to False. If set to True when queing a task, the start_time parameter will take precedence over the period, preventing drift.</div><div class=""> ------</div><div class=""> </div><div class=""> You can also set how many times the function can raise an exception (i.e. requesting data from a slow web service) and be queued again instead of stopping in **FAILED**  status using the parameter ``retry_failed`` (default = 0, -1 = unlimited).</div><div class=""> </div><div class=""> [[task repeats @///image/7d8b85e4.png center]]</div><div class=""> </div><div class=""> Summary: you have</div><div class=""> - ``period`` and ``repeats`` to get an automatically rescheduled function</div><div class=""> - ``timeout`` to be sure that a function doesn&#x27;t exceed a certain amount of time</div><div class=""> - ``retry_failed`` to control how many times the task can &quot;fail&quot;</div><div class=""> - ``start_time`` and ``stop_time`` to schedule a function in a restricted timeframe</div><div class=""> </div><div class="insert">##### ``queue_task`` and ``task_status``<span class="highlight"> [[queue_task_sig]]</span></div><div class=""> </div><div class=""> The method:</div><div class=""> ``</div><div class="insert">+scheduler.queue_task(</div><div class="insert">+    function,</div><div class="insert">+    pargs=[],</div><div class="insert">+    pvars={},</div><div class="insert">+    start_time=now, 		#datetime</div><div class="insert">+    stop_time = None,		#datetime</div><div class="insert">+    timeout = 60,               #seconds</div><div class="insert">+    prevent_drift=False,</div><div class="insert">+    period=60,                  #seconds</div><div class="insert">+    immediate=False,</div><div class="insert">+    repeats = 1</div><div class="insert">+)</div><div class=""> ``:code</div><div class="insert">+allows you to queue tasks to be executed by workers. </div><div class="insert">+It returns a row (see [[here #queue_task_return]]), and it takes the following parameters:</div><div class=""> </div><div class=""> - ``function`` (required): It can be a task name or a reference to an actual function.</div><div class=""> - ``pargs``: are the arguments to be passed to the task, stored as a Python list.</div><div class=""> - ``pvars`` : are the named arguments to be passed to the task, stored as a Python dictionary.</div><div class="insert">-<span class="highlight"></span> all other scheduler_task columns can be passed as keyword<span class="highlight"></span> arguments<span class="highlight">;</span> <span class="highlight">the most imp</span>or<span class="highlight">tant</span> <span class="highlight"></span>a<span class="highlight">r</span>e <span class="highlight"></span>s<span class="highlight">h</span>o<span class="highlight">wn</span>.</div><div class=""> </div><div class=""> For example:</div><div class=""> </div><div class=""> ``</div><div class=""> scheduler.queue_task(&#x27;demo1&#x27;, [1,2])</div><div class=""> ``</div><div class="">  </div><div class=""> does the exact same thing as </div><div class=""> </div><div class=""> ``</div><div class=""> scheduler.queue_task(&#x27;demo1&#x27;, pvars={&#x27;a&#x27;:1, &#x27;b&#x27;:2})</div><div class=""> ``:code</div><div class=""> </div><div class=""> as</div><div class=""> </div><div class=""> ``</div><div class=""> st.validate_and_insert(function_name=&#x27;demo1&#x27;, args=json.dumps([1,2]))</div><div class=""> ``:code</div><div class=""> </div><div class=""> and as:</div><div class=""> </div><div class=""> ``</div><div class=""> st.validate_and_insert(function_name=&#x27;demo1&#x27;, vars=json.dumps({&#x27;a&#x27;:1,&#x27;b&#x27;:2}))</div><div class=""> ``:code</div><div class=""> </div><div class=""> Here is a more complex complete example:</div><div class=""> ``</div><div class=""> def task_add(a,b):</div><div class="">     return a+b</div><div class=""> </div><div class=""> scheduler = Scheduler(db, tasks=dict(demo1=task_add))</div><div class=""> </div><div class=""> scheduler.queue_task(&#x27;demo1&#x27;, pvars=dict(a=1,b=2),</div><div class="">                      repeats = 0, period = 180)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Since version 2.4.1 if you pass an additional parameter ``immediate=True`` it will force the main worker to reassign tasks. Until 2.4.1, the worker checks for new tasks every 5 cycles (so, ``5*heartbeats`` seconds). If you had an app that needed to check frequently for new tasks, to get a &#x27;&#x27;snappy&#x27;&#x27; behaviour you were forced to lower the ``heartbeat`` parameter, putting the db under pressure for no reason. With ``immediate=True`` you can force the check for new tasks: it will happen at most as ``heartbeat`` seconds are passed   </div><div class=""> </div><div class="insert">A call to ``scheduler.queue_task`` returns the task ``id`` and ``uuid`` of the task you queued (can be the one you passed or the auto-generated one), and possible ``errors``:<span class="highlight"> [[queue_task_return]]</span></div></div></div>
    <div class="span6"><div class="diff"><div class=""> All tasks follow a lifecycle</div><div class=""> </div><div class=""> [[scheduler tasks @///image/ce8edcc3.png center]]</div><div class=""> </div><div class=""> By default, when you send a task to the scheduler, </div><div class=""> it is in the **QUEUED** status.</div><div class=""> If you need it to be executed later, use the ``start_time`` parameter (default = now).</div><div class=""> If for some reason you need to be sure that the task does not </div><div class=""> get executed after a certain point in time (maybe a request to a web service</div><div class=""> that shuts down at 1AM, a mail that needs to be sent not after the working hours, etc...) you can set a ``stop_time`` (default = None) for it.</div><div class=""> If your task is NOT picked up by a worker before ``stop_time``, it will be set as **EXPIRED**.</div><div class=""> Tasks with no ``stop_time`` set or picked up **BEFORE** stop_time are **ASSIGNED** to a worker. When a workers picks up a task, its status is set to **RUNNING**.</div><div class=""> </div><div class=""> **RUNNING** tasks may end up:</div><div class=""> - **TIMEOUT** when more than ``n`` seconds passed with ``timeout`` parameter (default = 60 seconds).</div><div class=""> - **FAILED** when an exception is detected,</div><div class=""> - **COMPLETED** when they successfully complete.</div><div class=""> </div><div class=""> Values for ``start_time`` and ``stop_time`` should be datetime objects. To schedule &quot;mytask&quot; to run at 30 seconds from the current time, for example, you would do the following:</div><div class=""> </div><div class=""> ``</div><div class=""> from datetime import timedelta as timed</div><div class=""> scheduler.queue_task(&#x27;mytask&#x27;,</div><div class="">     start_time=request.now + timed(seconds=30))</div><div class=""> ``:code</div><div class=""> </div><div class=""> Additionally, you can control how many times a task should be repeated (i.e. you need to aggregate some data at specified intervals). To do so, set the ``repeats``</div><div class=""> parameter (default = 1 time only, 0 = unlimited). You can influence how many seconds should pass between executions with the ``period`` parameter (default = 60 seconds).</div><div class=""> </div><div class=""> ------</div><div class="delete">-The time period is not calculated between the END of the first round and the START of the next, but from the START time of the first round to the START time of the next cycle)</div><div class=""> ------</div><div class=""> </div><div class=""> You can also set how many times the function can raise an exception (i.e. requesting data from a slow web service) and be queued again instead of stopping in **FAILED**  status using the parameter ``retry_failed`` (default = 0, -1 = unlimited).</div><div class=""> </div><div class=""> [[task repeats @///image/7d8b85e4.png center]]</div><div class=""> </div><div class=""> Summary: you have</div><div class=""> - ``period`` and ``repeats`` to get an automatically rescheduled function</div><div class=""> - ``timeout`` to be sure that a function doesn&#x27;t exceed a certain amount of time</div><div class=""> - ``retry_failed`` to control how many times the task can &quot;fail&quot;</div><div class=""> - ``start_time`` and ``stop_time`` to schedule a function in a restricted timeframe</div><div class=""> </div><div class="delete">##### ``queue_task`` and ``task_status``<span class="highlight"></span></div><div class=""> </div><div class=""> The method:</div><div class=""> ``</div><div class="delete">-scheduler.queue_task(function, pargs=[], pvars={}, **kwargs)</div><div class=""> ``:code</div><div class="delete">-allows you to queue tasks to be executed by workers. It takes the following parameters:</div><div class=""> </div><div class=""> - ``function`` (required): It can be a task name or a reference to an actual function.</div><div class=""> - ``pargs``: are the arguments to be passed to the task, stored as a Python list.</div><div class=""> - ``pvars`` : are the named arguments to be passed to the task, stored as a Python dictionary.</div><div class="delete">-<span class="highlight"> ``kwargs`` :</span> all other scheduler_task columns can be passed as keyword<span class="highlight">s</span> arguments<span class="highlight"></span> <span class="highlight">(f</span>or<span class="highlight"></span> <span class="highlight">ex</span>a<span class="highlight">mpl</span>e <span class="highlight">repeat</span>s<span class="highlight">, peri</span>o<span class="highlight">d, timeout)</span>.</div><div class=""> </div><div class=""> For example:</div><div class=""> </div><div class=""> ``</div><div class=""> scheduler.queue_task(&#x27;demo1&#x27;, [1,2])</div><div class=""> ``</div><div class="">  </div><div class=""> does the exact same thing as </div><div class=""> </div><div class=""> ``</div><div class=""> scheduler.queue_task(&#x27;demo1&#x27;, pvars={&#x27;a&#x27;:1, &#x27;b&#x27;:2})</div><div class=""> ``:code</div><div class=""> </div><div class=""> as</div><div class=""> </div><div class=""> ``</div><div class=""> st.validate_and_insert(function_name=&#x27;demo1&#x27;, args=json.dumps([1,2]))</div><div class=""> ``:code</div><div class=""> </div><div class=""> and as:</div><div class=""> </div><div class=""> ``</div><div class=""> st.validate_and_insert(function_name=&#x27;demo1&#x27;, vars=json.dumps({&#x27;a&#x27;:1,&#x27;b&#x27;:2}))</div><div class=""> ``:code</div><div class=""> </div><div class=""> Here is a more complex complete example:</div><div class=""> ``</div><div class=""> def task_add(a,b):</div><div class="">     return a+b</div><div class=""> </div><div class=""> scheduler = Scheduler(db, tasks=dict(demo1=task_add))</div><div class=""> </div><div class=""> scheduler.queue_task(&#x27;demo1&#x27;, pvars=dict(a=1,b=2),</div><div class="">                      repeats = 0, period = 180)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Since version 2.4.1 if you pass an additional parameter ``immediate=True`` it will force the main worker to reassign tasks. Until 2.4.1, the worker checks for new tasks every 5 cycles (so, ``5*heartbeats`` seconds). If you had an app that needed to check frequently for new tasks, to get a &#x27;&#x27;snappy&#x27;&#x27; behaviour you were forced to lower the ``heartbeat`` parameter, putting the db under pressure for no reason. With ``immediate=True`` you can force the check for new tasks: it will happen at most as ``heartbeat`` seconds are passed   </div><div class=""> </div><div class="delete">A call to ``scheduler.queue_task`` returns the task ``id`` and ``uuid`` of the task you queued (can be the one you passed or the auto-generated one), and possible ``errors``:<span class="highlight"></span></div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/1474cd610abbf95ddae737e284aadb36e07648e2">1474cd6</a><ul><li>Date : 2014-01-06</li><li>Update routes examples filenames.</li></ul></li></ul>
<div class="row-fluid" id="com_1474cd610abbf95ddae737e284aadb36e07648e2">
    <div class="span6"><div class="diff"><div class=""> There are three example files in the &quot;examples&quot; directory:</div><div class=""> ``</div><div class=""> options_std.py</div><div class="insert">+routes.parametric.example.py</div><div class="insert">+routes.patterns.example.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> They are all meant to be copied to the root dir (where web2py.py or web2py.exe is) and edited according to your own preferences.</div><div class=""> The former is an optional configuration file that can be passed to web2py.py with the ``-L`` option. The second is an example of a URL mapping file. It is loaded automatically when renamed &quot;routes.py&quot;. The third is an alternative syntax for URL mapping, and can also be renamed (or copied to) &quot;routes.py&quot;.</div><div class=""> </div><div class=""> The files</div><div class=""> ``</div><div class=""> app.example.yaml</div><div class=""> queue.example.yaml</div><div class=""> ``:code</div><div class=""> </div><div class=""> are example configuration files used for deployment on the Google App Engine. You can read more about them in the Deployment Recipes chapter and on the Google Documentation pages.</div><div class=""> </div><div class=""> There are also additional libraries, some developed by a third party:</div><div class=""> </div><div class=""> **feedparser**``feedparser``:cite  by Mark Pilgrim for reading RSS and Atom feeds:</div><div class=""> ``</div><div class=""> gluon/contrib/__init__.py</div><div class=""> gluon/contrib/feedparser.py</div><div class=""> ``:code</div><div class=""> routers = dict(</div><div class="">           &#x27;domain1.com&#x27; : &#x27;app1&#x27;,</div><div class="">           &#x27;domain2.com&#x27; : &#x27;app2&#x27;,</div><div class="">       }</div><div class="">   ),</div><div class=""> )</div><div class=""> ``:code</div><div class=""> does what you&#x27;d expect.</div><div class=""> </div><div class=""> ``</div><div class=""> routers = dict(</div><div class="">   BASE  = dict(</div><div class="">       domains = {</div><div class="">           &#x27;domain.com:80&#x27;  : &#x27;app/insecure&#x27;,</div><div class="">           &#x27;domain.com:443&#x27; : &#x27;app/secure&#x27;,</div><div class="">       }</div><div class="">   ),</div><div class=""> )</div><div class=""> ``:code</div><div class=""> maps ``http://domain.com`` accesses to the controller named ``insecure``, while ``HTTPS`` accesses go to the ``secure`` controller. Alternatively, you can map different ports to different apps, in the obvious way.</div><div class=""> </div><div class="insert">For further information, please consult the file [[&quot;route<span class="highlight">s.parametric</span>.example.py&quot; https://github.com/web2py/web2py/blob/master/examples/route<span class="highlight">s.parametric</span>.example.py]] provided in the &quot;examples&quot; folder of the standard web2py distribution.</div><div class=""> </div><div class=""> Note: The &#x27;&#x27;parameter-based&#x27;&#x27; system first appeared in web2py version 1.92.1.</div><div class=""> </div><div class=""> #### Pattern-based system</div><div class=""> </div><div class=""> Although the &#x27;&#x27;parameter-based&#x27;&#x27; system just described should be sufficient for most use cases, the alternative &#x27;&#x27;pattern-based&#x27;&#x27; system provides some additional flexibility for more complex cases. To use the pattern-based system, instead of defining routers as dictionaries of routing parameters, you define two lists (or tuples) of 2-tuples, ``routes_in`` and ``routes_out``. Each tuple contains two elements: the pattern to be replaced and the string that replaces it. For example:</div><div class=""> ``</div><div class=""> routes_in = (</div><div class="">   (&#x27;/testme&#x27;, &#x27;/examples/default/index&#x27;),</div><div class=""> )</div><div class=""> routes_out = (</div><div class="">   (&#x27;/examples/default/index&#x27;, &#x27;/testme&#x27;),</div><div class=""> )</div><div class=""> ``:code</div><div class=""> </div><div class=""> With these routes, the URL:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/testme</div><div class=""> ``:code</div><div class=""> </div><div class=""> Note: These items first appeared in web2py version 1.83.</div><div class=""> ``routes_onerror``:inxx</div><div class=""> </div><div class=""> You can also use ``routes.py`` to re-route requests to special actions in case there is an error on the server. You can specify this mapping globally, for each app, for each error code, or for each app and error code. Here is an example:</div><div class=""> ``</div><div class=""> routes_onerror = [</div><div class="">   (&#x27;init/400&#x27;, &#x27;/init/default/login&#x27;),</div><div class="">   (&#x27;init/*&#x27;, &#x27;/init/static/fail.html&#x27;),</div><div class="">   (&#x27;*/404&#x27;, &#x27;/init/static/cantfind.html&#x27;),</div><div class="">   (&#x27;*/*&#x27;, &#x27;/init/error/index&#x27;)</div><div class=""> ]</div><div class=""> ``:code</div><div class=""> </div><div class=""> For each tuple, the first string is matched against &quot;[app name]/[error code]&quot;. If a match is found, the failed request is re-routed to the URL in the second string of the matching tuple. If the error handling URL is a not a static file, the following GET variables will be passed to the error action:</div><div class=""> - ``code``: the HTTP status code (e.g., 404, 500)</div><div class=""> - ``ticket``: in the form of &quot;[app name]/[ticket number]&quot; (or &quot;None&quot; if no ticket)</div><div class=""> - ``requested_uri``: equivalent to ``request.env.request_uri``</div><div class=""> - ``request_url``: equivalent to ``request.url``</div><div class=""> </div><div class=""> These variables will be accessible to the error handling action via ``request.vars`` and can be used in generating the error response. In particular, it is a good idea for the error action to return the original HTTP error code instead of the default 200 (OK) status code. This can be done by setting ``response.status = request.vars.code``. It is also possible to have the error action send (or queue) an email to an administrator, including a link to the ticket in ``admin``.</div><div class=""> </div><div class="insert">Unmatched errors display a default error page. This default error page can also be customized here (see &quot;route<span class="highlight">s.pa</span>r<span class="highlight">ametric</span>.example.py&quot; and &quot;route<span class="highlight">s.pattern</span>s.example.py&quot; in the &quot;examples&quot; folder):</div><div class=""> ``</div><div class=""> error_message = &#x27;&lt;html&gt;&lt;body&gt;&lt;h1&gt;%s&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&#x27;</div><div class=""> error_message_ticket = &#x27;&#x27;&#x27;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Internal error&lt;/h1&gt;</div><div class="">      Ticket issued: &lt;a href=&quot;/admin/default/ticket/%(ticket)s&quot;</div><div class="">      target=&quot;_blank&quot;&gt;%(ticket)s&lt;/a&gt;&lt;/body&gt;&lt;/html&gt;&#x27;&#x27;&#x27;</div><div class=""> ``:code</div></div></div>
    <div class="span6"><div class="diff"><div class=""> There are three example files in the &quot;examples&quot; directory:</div><div class=""> ``</div><div class=""> options_std.py</div><div class="delete">-routes.example.py</div><div class="delete">-router.example.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> They are all meant to be copied to the root dir (where web2py.py or web2py.exe is) and edited according to your own preferences.</div><div class=""> The former is an optional configuration file that can be passed to web2py.py with the ``-L`` option. The second is an example of a URL mapping file. It is loaded automatically when renamed &quot;routes.py&quot;. The third is an alternative syntax for URL mapping, and can also be renamed (or copied to) &quot;routes.py&quot;.</div><div class=""> </div><div class=""> The files</div><div class=""> ``</div><div class=""> app.example.yaml</div><div class=""> queue.example.yaml</div><div class=""> ``:code</div><div class=""> </div><div class=""> are example configuration files used for deployment on the Google App Engine. You can read more about them in the Deployment Recipes chapter and on the Google Documentation pages.</div><div class=""> </div><div class=""> There are also additional libraries, some developed by a third party:</div><div class=""> </div><div class=""> **feedparser**``feedparser``:cite  by Mark Pilgrim for reading RSS and Atom feeds:</div><div class=""> ``</div><div class=""> gluon/contrib/__init__.py</div><div class=""> gluon/contrib/feedparser.py</div><div class=""> ``:code</div><div class=""> routers = dict(</div><div class="">           &#x27;domain1.com&#x27; : &#x27;app1&#x27;,</div><div class="">           &#x27;domain2.com&#x27; : &#x27;app2&#x27;,</div><div class="">       }</div><div class="">   ),</div><div class=""> )</div><div class=""> ``:code</div><div class=""> does what you&#x27;d expect.</div><div class=""> </div><div class=""> ``</div><div class=""> routers = dict(</div><div class="">   BASE  = dict(</div><div class="">       domains = {</div><div class="">           &#x27;domain.com:80&#x27;  : &#x27;app/insecure&#x27;,</div><div class="">           &#x27;domain.com:443&#x27; : &#x27;app/secure&#x27;,</div><div class="">       }</div><div class="">   ),</div><div class=""> )</div><div class=""> ``:code</div><div class=""> maps ``http://domain.com`` accesses to the controller named ``insecure``, while ``HTTPS`` accesses go to the ``secure`` controller. Alternatively, you can map different ports to different apps, in the obvious way.</div><div class=""> </div><div class="delete">For further information, please consult the file [[&quot;route<span class="highlight">r</span>.example.py&quot; https://github.com/web2py/web2py/blob/master/examples/route<span class="highlight">r</span>.example.py]] provided in the &quot;examples&quot; folder of the standard web2py distribution.</div><div class=""> </div><div class=""> Note: The &#x27;&#x27;parameter-based&#x27;&#x27; system first appeared in web2py version 1.92.1.</div><div class=""> </div><div class=""> #### Pattern-based system</div><div class=""> </div><div class=""> Although the &#x27;&#x27;parameter-based&#x27;&#x27; system just described should be sufficient for most use cases, the alternative &#x27;&#x27;pattern-based&#x27;&#x27; system provides some additional flexibility for more complex cases. To use the pattern-based system, instead of defining routers as dictionaries of routing parameters, you define two lists (or tuples) of 2-tuples, ``routes_in`` and ``routes_out``. Each tuple contains two elements: the pattern to be replaced and the string that replaces it. For example:</div><div class=""> ``</div><div class=""> routes_in = (</div><div class="">   (&#x27;/testme&#x27;, &#x27;/examples/default/index&#x27;),</div><div class=""> )</div><div class=""> routes_out = (</div><div class="">   (&#x27;/examples/default/index&#x27;, &#x27;/testme&#x27;),</div><div class=""> )</div><div class=""> ``:code</div><div class=""> </div><div class=""> With these routes, the URL:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/testme</div><div class=""> ``:code</div><div class=""> </div><div class=""> Note: These items first appeared in web2py version 1.83.</div><div class=""> ``routes_onerror``:inxx</div><div class=""> </div><div class=""> You can also use ``routes.py`` to re-route requests to special actions in case there is an error on the server. You can specify this mapping globally, for each app, for each error code, or for each app and error code. Here is an example:</div><div class=""> ``</div><div class=""> routes_onerror = [</div><div class="">   (&#x27;init/400&#x27;, &#x27;/init/default/login&#x27;),</div><div class="">   (&#x27;init/*&#x27;, &#x27;/init/static/fail.html&#x27;),</div><div class="">   (&#x27;*/404&#x27;, &#x27;/init/static/cantfind.html&#x27;),</div><div class="">   (&#x27;*/*&#x27;, &#x27;/init/error/index&#x27;)</div><div class=""> ]</div><div class=""> ``:code</div><div class=""> </div><div class=""> For each tuple, the first string is matched against &quot;[app name]/[error code]&quot;. If a match is found, the failed request is re-routed to the URL in the second string of the matching tuple. If the error handling URL is a not a static file, the following GET variables will be passed to the error action:</div><div class=""> - ``code``: the HTTP status code (e.g., 404, 500)</div><div class=""> - ``ticket``: in the form of &quot;[app name]/[ticket number]&quot; (or &quot;None&quot; if no ticket)</div><div class=""> - ``requested_uri``: equivalent to ``request.env.request_uri``</div><div class=""> - ``request_url``: equivalent to ``request.url``</div><div class=""> </div><div class=""> These variables will be accessible to the error handling action via ``request.vars`` and can be used in generating the error response. In particular, it is a good idea for the error action to return the original HTTP error code instead of the default 200 (OK) status code. This can be done by setting ``response.status = request.vars.code``. It is also possible to have the error action send (or queue) an email to an administrator, including a link to the ticket in ``admin``.</div><div class=""> </div><div class="delete">Unmatched errors display a default error page. This default error page can also be customized here (see &quot;route<span class="highlight"></span>r<span class="highlight"></span>.example.py&quot; and &quot;route<span class="highlight"></span>s.example.py&quot; in the &quot;examples&quot; folder):</div><div class=""> ``</div><div class=""> error_message = &#x27;&lt;html&gt;&lt;body&gt;&lt;h1&gt;%s&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&#x27;</div><div class=""> error_message_ticket = &#x27;&#x27;&#x27;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Internal error&lt;/h1&gt;</div><div class="">      Ticket issued: &lt;a href=&quot;/admin/default/ticket/%(ticket)s&quot;</div><div class="">      target=&quot;_blank&quot;&gt;%(ticket)s&lt;/a&gt;&lt;/body&gt;&lt;/html&gt;&#x27;&#x27;&#x27;</div><div class=""> ``:code</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/7362f7b775c90f03acfdf14f6714e99b13e99bb5">7362f7b</a><ul><li>Date : 2014-01-05</li><li>Added "@" to the lazy_cache decorator example</li></ul></li></ul>
<div class="row-fluid" id="com_7362f7b775c90f03acfdf14f6714e99b13e99bb5">
    <div class="span6"><div class="diff"><div class="insert"><span class="highlight">@</span>lazy_cache(&#x27;key&#x27;, time_expire=60, cache_model=&#x27;ram&#x27;)</div><div class=""> def f(a,b,c,): ....</div><div class=""> ``:code</div></div></div>
    <div class="span6"><div class="diff"><div class="delete"><span class="highlight"></span>lazy_cache(&#x27;key&#x27;, time_expire=60, cache_model=&#x27;ram&#x27;)</div><div class=""> def f(a,b,c,): ....</div><div class=""> ``:code</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/aaedb38690383ecf93b2532de0f390cd64ec2010">aaedb38</a><ul><li>Date : 2013-11-01</li><li>fixed reference to superfish and import Crud</li></ul></li></ul>
<div class="row-fluid" id="com_aaedb38690383ecf93b2532de0f390cd64ec2010">
    <div class="span6"><div class="diff"><div class=""> A few objects and functions, including **Auth**, **Crud** and **Service**, are defined in &quot;gluon/tools.py&quot; and they need to be imported as necessary:</div><div class=""> ``</div><div class=""> from gluon.tools import Auth, Crud, Service</div><div class=""> ``:code</div><div class="insert">+They are imported in ``db.py`` in the scaffolding application.</div></div></div>
    <div class="span6"><div class="diff"><div class=""> A few objects and functions, including **Auth**, **Crud** and **Service**, are defined in &quot;gluon/tools.py&quot; and they need to be imported as necessary:</div><div class=""> ``</div><div class=""> from gluon.tools import Auth, Crud, Service</div><div class=""> ``:code</div></div></div>
</div>
<hr />





<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/5b6f32d64158ddb25a2b55b74a6198947b934f80">5b6f32d</a><ul><li>Date : 2013-10-06</li><li>Referred to niphlod's slice re testing. Updated notes about using resonse.models_to_run to reflect the importance of the sort order of models</li></ul></li></ul>
<div class="row-fluid" id="com_5b6f32d64158ddb25a2b55b74a6198947b934f80">
    <div class="span6"><div class="diff"><div class=""> - ``response.delimiters`` defaults to ``(&#x27;{{&#x27;,&#x27;}}&#x27;)``. It allows you to change the delimiter of code embedded in views.</div><div class=""> - ``response.xmlrpc(request, methods)``: when a controller returns it, this function exposes the methods via XML-RPC``xmlrpc``:cite . This function is deprecated since a better mechanism is available and described in Chapter 10.</div><div class=""> - ``response.write(text)``: a method to write text into the output page body.</div><div class=""> - ``response.js`` can contain Javascript code. This code will be executed if and only if the response is received by a web2py component as discussed in Chapter 12.</div><div class=""> - ``response.models_to_run`` [[response_models_to_run]] contains a list of regexes that chooses what models to run.</div><div class=""> -- By default, this is set automatically to load /a/models/*.py, /a/models/c/*.py, and /a/models/c/f/*.py files when ``/a/c/f`` is requested. You can set, e.g., ``response.models_to_run = [&#x27;myfolder/&#x27;]`` to force the execution only of the models inside your application&#x27;s ``models/myfolder`` subfolder.</div><div class="insert">+-- NB: ``response.models_to_run`` is a list of regex, not a list of filepaths. The regex are relative to the models/ folder, so any model file with a relative file path that matches one of the regexes will be executed. Note also that this can not affect any models which have already been evaluated because they were earlier in the alphabetic sort order. That is, if a conditional model for controller orange was orange/orange_model.py and it set the regex to [.*], that change does not affect any models previously rejected for loading such as the model apple/apple_model.py ; it matches the new regex, but it was evaluated and rejected before orange/orange_model.py changed the regex.</div><div class="insert">+-- This means that if you want to use models_to_run to share conditional models between controllers, put the models in a sub-directory that will sort last such as zzz, and then use a regex &#x27;zzz&#x27;.</div><div class="insert">+. </div></div></div>
    <div class="span6"><div class="diff"><div class=""> - ``response.delimiters`` defaults to ``(&#x27;{{&#x27;,&#x27;}}&#x27;)``. It allows you to change the delimiter of code embedded in views.</div><div class=""> - ``response.xmlrpc(request, methods)``: when a controller returns it, this function exposes the methods via XML-RPC``xmlrpc``:cite . This function is deprecated since a better mechanism is available and described in Chapter 10.</div><div class=""> - ``response.write(text)``: a method to write text into the output page body.</div><div class=""> - ``response.js`` can contain Javascript code. This code will be executed if and only if the response is received by a web2py component as discussed in Chapter 12.</div><div class=""> - ``response.models_to_run`` [[response_models_to_run]] contains a list of regexes that chooses what models to run.</div><div class=""> -- By default, this is set automatically to load /a/models/*.py, /a/models/c/*.py, and /a/models/c/f/*.py files when ``/a/c/f`` is requested. You can set, e.g., ``response.models_to_run = [&#x27;myfolder/&#x27;]`` to force the execution only of the models inside your application&#x27;s ``models/myfolder`` subfolder.</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/5f860e4094ac8ad56f13f4cdf731ebbce45bbe6c">5f860e4</a><ul><li>Date : 2013-09-05</li><li>W2P_TASK info, thanks Niphlod</li></ul></li></ul>
<div class="row-fluid" id="com_5f860e4094ac8ad56f13f4cdf731ebbce45bbe6c">
    <div class="span6"><div class="diff"><div class="insert">+Tasks will always be called in the same environment seen by controllers and therefore they see all the global variables defined in models, including database connections (``db``).</div><div class="insert">+Tasks differ from a controller action because they are not associated with an HTTP request and therefore there is no ``request.env``.</div><div class="insert">+Also, tasks can access another environmental variable that is not present in normal requests: ``W2P_TASK``. ``W2P_TASK.id`` holds the ``scheduler_task.id`` and ``W2P_TASK.uuid`` the ``scheduler_task.uuid`` field of the task that is running.</div><div class=""> </div><div class=""> ------</div><div class=""> Remember to call ``db.commit()`` at the end of every task if it involves inserts/updates to the database. web2py commits by default at the end of a successful action but the scheduler tasks are not actions.</div><div class=""> ------</div><div class=""> </div><div class=""> To enable the scheduler you must instantiate the Scheduler class in a model.</div><div class=""> The recommended way to enable the scheduler to your app is to create a model file named ``scheduler.py`` and define your function there. After the functions, you can put the following code into the model:</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.scheduler import Scheduler</div><div class=""> scheduler = Scheduler(db)</div><div class=""> ``:code</div><div class=""> </div><div class=""> If your tasks are defined in a module (as opposed to a model) you may have to restart the workers.</div><div class=""> </div><div class=""> The task is scheduled with</div><div class=""> </div><div class=""> ``</div><div class=""> scheduler.queue_task(task_add,pvars=dict(a=1,b=2))</div><div class=""> ``:code</div><div class=""> you get the result of the validation, and id and uuid will be None</div><div class=""> ##### Results and output</div><div class=""> </div><div class=""> The table &quot;scheduler_run&quot; stores the status of all running tasks. Each record references a task that has been picked up by a worker.  One task can have multiple runs. For example, a task scheduled to repeat 10 times an hour will probably have 10 runs (unless one fails or they take longer than 1 hour). Beware that if the task has no return values, it is removed from the scheduler_run table as soon as it is finished.</div><div class=""> </div><div class=""> Possible run statuses are:</div><div class=""> </div><div class=""> ``</div><div class=""> RUNNING, COMPLETED, FAILED, TIMEOUT</div><div class=""> ``</div><div class=""> </div><div class=""> If the run is completed, no exceptions are thrown, and there is no task timeout, the run is marked as ``COMPLETED`` and the task is marked as ``QUEUED`` or ``COMPLETED`` depending on whether it is supposed to run again at a later time. The output of the task is serialized in JSON and stored in the run record.</div><div class=""> </div><div class=""> When a ``RUNNING`` task throws an exception, the run is mark as ``FAILED`` and the task is marked as ``FAILED``. The traceback is stored in the run record.</div><div class=""> </div><div class=""> Similarly, when a run exceeds the timeout, it is stopped and marked as ``TIMEOUT``, and the task is marked as ``TIMEOUT``.</div><div class=""> </div><div class=""> In any case, the stdout is captured and also logged into the run record.</div><div class=""> </div><div class=""> Using appadmin, one can check all ``RUNNING`` tasks, the output of ``COMPLETED`` tasks, the error of ``FAILED`` tasks, etc.</div><div class=""> </div><div class="insert"><span class="highlight">The scheduler also creates one more table called &quot;scheduler_worker&quot;, which st</span>ores the workers&#x27; heartbeat and their status.</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">-Tasks will always be called in the same environment seen by controllers and therefore they see all the global variables defined in models, including database connections (``db``). Tasks differ from a controller action because they are not associated with an HTTP request and therefore there is no ``request.env``.</div><div class=""> </div><div class=""> ------</div><div class=""> Remember to call ``db.commit()`` at the end of every task if it involves inserts/updates to the database. web2py commits by default at the end of a successful action but the scheduler tasks are not actions.</div><div class=""> ------</div><div class=""> </div><div class=""> To enable the scheduler you must instantiate the Scheduler class in a model.</div><div class=""> The recommended way to enable the scheduler to your app is to create a model file named ``scheduler.py`` and define your function there. After the functions, you can put the following code into the model:</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.scheduler import Scheduler</div><div class=""> scheduler = Scheduler(db)</div><div class=""> ``:code</div><div class=""> </div><div class=""> If your tasks are defined in a module (as opposed to a model) you may have to restart the workers.</div><div class=""> </div><div class=""> The task is scheduled with</div><div class=""> </div><div class=""> ``</div><div class=""> scheduler.queue_task(task_add,pvars=dict(a=1,b=2))</div><div class=""> ``:code</div><div class=""> you get the result of the validation, and id and uuid will be None</div><div class=""> ##### Results and output</div><div class=""> </div><div class=""> The table &quot;scheduler_run&quot; stores the status of all running tasks. Each record references a task that has been picked up by a worker.  One task can have multiple runs. For example, a task scheduled to repeat 10 times an hour will probably have 10 runs (unless one fails or they take longer than 1 hour). Beware that if the task has no return values, it is removed from the scheduler_run table as soon as it is finished.</div><div class=""> </div><div class=""> Possible run statuses are:</div><div class=""> </div><div class=""> ``</div><div class=""> RUNNING, COMPLETED, FAILED, TIMEOUT</div><div class=""> ``</div><div class=""> </div><div class=""> If the run is completed, no exceptions are thrown, and there is no task timeout, the run is marked as ``COMPLETED`` and the task is marked as ``QUEUED`` or ``COMPLETED`` depending on whether it is supposed to run again at a later time. The output of the task is serialized in JSON and stored in the run record.</div><div class=""> </div><div class=""> When a ``RUNNING`` task throws an exception, the run is mark as ``FAILED`` and the task is marked as ``FAILED``. The traceback is stored in the run record.</div><div class=""> </div><div class=""> Similarly, when a run exceeds the timeout, it is stopped and marked as ``TIMEOUT``, and the task is marked as ``TIMEOUT``.</div><div class=""> </div><div class=""> In any case, the stdout is captured and also logged into the run record.</div><div class=""> </div><div class=""> Using appadmin, one can check all ``RUNNING`` tasks, the output of ``COMPLETED`` tasks, the error of ``FAILED`` tasks, etc.</div><div class=""> </div><div class="delete">-The scheduler also creates one more table called &quot;scheduler_worker&quot;, which st\</div><div class="delete"><span class="highlight"></span>ores the workers&#x27; heartbeat and their status.</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/e612918f84aba2602dcb4a9b4fc3453d90d964ab">e612918</a><ul><li>Date : 2013-09-05</li><li>-W command line option deprecated in favour of nssm</li></ul></li></ul>
<div class="row-fluid" id="com_e612918f84aba2602dcb4a9b4fc3453d90d964ab">
    <div class="span6"><div class="diff"><div class="insert">+                        -W install|start|stop as Windows service. </div><div class="insert">+                        However, this is deprecated. Please see </div><div class="insert">+                        use of nssm in the Deployment Recipes chapter</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">-                        -W install|start|stop as Windows service</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/cd9c659cd509b94781f4c7668d3b738f31cb1df0">cd9c659</a><ul><li>Date : 2013-09-02</li><li>Update @reboot cron example</li></ul></li></ul>
<div class="row-fluid" id="com_cd9c659cd509b94781f4c7668d3b738f31cb1df0">
    <div class="span6"><div class="diff"><div class=""> If you specify ``@reboot`` in the first field in the crontab file, the given task will be executed only once, at web2py startup. You can use this feature if you want to pre-cache, check, or initialize data for an application on web2py startup. Note that cron tasks are executed in parallel with the application --- if the application is not ready to serve requests until the cron task is finished, you should implement checks to reflect this. Example:</div><div class=""> ``</div><div class="insert">@reboot<span class="highlight"></span>  root *mycontroller/myfunction</div><div class=""> ``:code</div></div></div>
    <div class="span6"><div class="diff"><div class=""> If you specify ``@reboot`` in the first field in the crontab file, the given task will be executed only once, at web2py startup. You can use this feature if you want to pre-cache, check, or initialize data for an application on web2py startup. Note that cron tasks are executed in parallel with the application --- if the application is not ready to serve requests until the cron task is finished, you should implement checks to reflect this. Example:</div><div class=""> ``</div><div class="delete">@reboot<span class="highlight">  *  *  *  *</span>  root *mycontroller/myfunction</div><div class=""> ``:code</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/075e5deeecd75d8be86a799ec938d91142e1f0ee">075e5de</a><ul><li>Date : 2013-08-26</li><li>pacthed book about new examples folder</li></ul></li></ul>
<div class="row-fluid" id="com_075e5deeecd75d8be86a799ec938d91142e1f0ee">
    <div class="span6"><div class="diff"><div class="insert">There are three example files<span class="highlight"> in the &quot;examples&quot; directory</span>:</div><div class=""> ``</div><div class=""> options_std.py</div><div class=""> routes.example.py</div><div class=""> router.example.py</div><div class=""> ``:code</div><div class=""> </div><div class="insert">+They are all meant to be copied to the root dir (where web2py.py or web2py.exe is) and edited according to your own preferences.</div><div class=""> The former is an optional configuration file that can be passed to web2py.py with the ``-L`` option. The second is an example of a URL mapping file. It is loaded automatically when renamed &quot;routes.py&quot;. The third is an alternative syntax for URL mapping, and can also be renamed (or copied to) &quot;routes.py&quot;.</div><div class=""> </div><div class=""> The files</div><div class=""> ``</div><div class=""> app.example.yaml</div><div class=""> queue.example.yaml</div><div class=""> ``:code</div><div class=""> </div><div class=""> are example configuration files used for deployment on the Google App Engine. You can read more about them in the Deployment Recipes chapter and on the Google Documentation pages.</div><div class=""> </div><div class=""> There are also additional libraries, some developed by a third party:</div><div class=""> </div><div class=""> **feedparser**``feedparser``:cite  by Mark Pilgrim for reading RSS and Atom feeds:</div><div class=""> ``</div><div class=""> gluon/contrib/__init__.py</div><div class=""> gluon/contrib/feedparser.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> **markdown2**``markdown2``:cite  by Trent Mick for wiki markup:</div><div class=""> ``</div><div class=""> routers = dict(</div><div class="">           &#x27;domain1.com&#x27; : &#x27;app1&#x27;,</div><div class="">           &#x27;domain2.com&#x27; : &#x27;app2&#x27;,</div><div class="">       }</div><div class="">   ),</div><div class=""> )</div><div class=""> ``:code</div><div class=""> does what you&#x27;d expect.</div><div class=""> </div><div class=""> ``</div><div class=""> routers = dict(</div><div class="">   BASE  = dict(</div><div class="">       domains = {</div><div class="">           &#x27;domain.com:80&#x27;  : &#x27;app/insecure&#x27;,</div><div class="">           &#x27;domain.com:443&#x27; : &#x27;app/secure&#x27;,</div><div class="">       }</div><div class="">   ),</div><div class=""> )</div><div class=""> ``:code</div><div class=""> maps ``http://domain.com`` accesses to the controller named ``insecure``, while ``HTTPS`` accesses go to the ``secure`` controller. Alternatively, you can map different ports to different apps, in the obvious way.</div><div class=""> </div><div class="insert">For further information, please consult the file [[<span class="highlight">&quot;router.example.py&quot; https</span>://<span class="highlight">github.</span>co<span class="highlight">m</span>/web2py/<span class="highlight"></span>w<span class="highlight">eb2py/blob/master/examples</span>/router.example.py]] provided in the <span class="highlight">&quot;examples&quot;</span> folder of the standard web2py distribution.</div><div class=""> </div><div class=""> Note: The &#x27;&#x27;parameter-based&#x27;&#x27; system first appeared in web2py version 1.92.1.</div><div class=""> </div><div class=""> #### Pattern-based system</div><div class=""> </div><div class=""> Although the &#x27;&#x27;parameter-based&#x27;&#x27; system just described should be sufficient for most use cases, the alternative &#x27;&#x27;pattern-based&#x27;&#x27; system provides some additional flexibility for more complex cases. To use the pattern-based system, instead of defining routers as dictionaries of routing parameters, you define two lists (or tuples) of 2-tuples, ``routes_in`` and ``routes_out``. Each tuple contains two elements: the pattern to be replaced and the string that replaces it. For example:</div><div class=""> ``</div><div class=""> routes_in = (</div><div class="">   (&#x27;/testme&#x27;, &#x27;/examples/default/index&#x27;),</div><div class=""> )</div><div class=""> routes_out = (</div><div class="">   (&#x27;/examples/default/index&#x27;, &#x27;/testme&#x27;),</div><div class=""> )</div><div class=""> ``:code</div><div class=""> </div><div class=""> With these routes, the URL:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/testme</div><div class=""> ``:code</div><div class=""> </div><div class=""> Note: These items first appeared in web2py version 1.83.</div><div class=""> ``routes_onerror``:inxx</div><div class=""> </div><div class=""> You can also use ``routes.py`` to re-route requests to special actions in case there is an error on the server. You can specify this mapping globally, for each app, for each error code, or for each app and error code. Here is an example:</div><div class=""> ``</div><div class=""> routes_onerror = [</div><div class="">   (&#x27;init/400&#x27;, &#x27;/init/default/login&#x27;),</div><div class="">   (&#x27;init/*&#x27;, &#x27;/init/static/fail.html&#x27;),</div><div class="">   (&#x27;*/404&#x27;, &#x27;/init/static/cantfind.html&#x27;),</div><div class="">   (&#x27;*/*&#x27;, &#x27;/init/error/index&#x27;)</div><div class=""> ]</div><div class=""> ``:code</div><div class=""> </div><div class=""> For each tuple, the first string is matched against &quot;[app name]/[error code]&quot;. If a match is found, the failed request is re-routed to the URL in the second string of the matching tuple. If the error handling URL is a not a static file, the following GET variables will be passed to the error action:</div><div class=""> - ``code``: the HTTP status code (e.g., 404, 500)</div><div class=""> - ``ticket``: in the form of &quot;[app name]/[ticket number]&quot; (or &quot;None&quot; if no ticket)</div><div class=""> - ``requested_uri``: equivalent to ``request.env.request_uri``</div><div class=""> - ``request_url``: equivalent to ``request.url``</div><div class=""> </div><div class=""> These variables will be accessible to the error handling action via ``request.vars`` and can be used in generating the error response. In particular, it is a good idea for the error action to return the original HTTP error code instead of the default 200 (OK) status code. This can be done by setting ``response.status = request.vars.code``. It is also possible to have the error action send (or queue) an email to an administrator, including a link to the ticket in ``admin``.</div><div class=""> </div><div class="insert">Unmatched errors display a default error page. This default error page can also be customized here (see <span class="highlight">&quot;</span>router.example.py<span class="highlight">&quot;</span> and <span class="highlight">&quot;</span>routes.example.py<span class="highlight">&quot;</span> in the <span class="highlight">&quot;</span>e<span class="highlight">xam</span>p<span class="highlight">les&quot;</span> folder):</div><div class=""> ``</div><div class=""> error_message = &#x27;&lt;html&gt;&lt;body&gt;&lt;h1&gt;%s&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&#x27;</div><div class=""> error_message_ticket = &#x27;&#x27;&#x27;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Internal error&lt;/h1&gt;</div><div class="">      Ticket issued: &lt;a href=&quot;/admin/default/ticket/%(ticket)s&quot;</div><div class="">      target=&quot;_blank&quot;&gt;%(ticket)s&lt;/a&gt;&lt;/body&gt;&lt;/html&gt;&#x27;&#x27;&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class=""> The first variable contains the error message when an invalid application or function is requested. The second variable contains the error message when a ticket is issued.</div><div class=""> </div><div class=""> ``routes_onerror`` work with both routing mechanisms.</div><div class=""> </div><div class=""> ``error_handler``:inxx</div><div class=""> In &quot;routes.py&quot; you can also specify an action in charge of error handling:</div><div class=""> </div><div class=""> ``</div><div class=""> error_handler = dict(application=&#x27;error&#x27;,</div><div class="">                       controller=&#x27;default&#x27;,</div><div class="">                       function=&#x27;index&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> import logging</div><div class=""> logger = logging.getLogger(&quot;web2py.app.myapp&quot;)</div><div class=""> logger.setLevel(logging.DEBUG)</div><div class=""> ``:code</div><div class=""> </div><div class=""> and you can use it to log messages of various importance</div><div class=""> </div><div class=""> ``</div><div class=""> logger.debug(&quot;Just checking that %s&quot; % details)</div><div class=""> logger.info(&quot;You ought to know that %s&quot; % details)</div><div class=""> logger.warn(&quot;Mind that %s&quot; % details)</div><div class=""> logger.error(&quot;Oops, something bad happened %s&quot; % details)</div><div class=""> ``:code</div><div class=""> </div><div class=""> ``logging`` is a standard python module described here:</div><div class=""> ``</div><div class=""> http://docs.python.org/library/logging.html</div><div class=""> ``</div><div class=""> The string &quot;web2py.app.myapp&quot; defines an app-level logger.</div><div class=""> </div><div class=""> For this to work properly, you need a configuration file for the logger.</div><div class="insert">One is provided by web2py in the <span class="highlight">&quot;</span>e<span class="highlight">xam</span>p<span class="highlight">les&quot;</span> folder &quot;logging.example.conf&quot;. You need to <span class="highlight">copy the file to web2py&#x27;s directory and </span>rename the file<span class="highlight"> to</span> &quot;logging.conf&quot; and customize it as necessary.</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">There are three example files<span class="highlight"></span>:</div><div class=""> ``</div><div class=""> options_std.py</div><div class=""> routes.example.py</div><div class=""> router.example.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> The former is an optional configuration file that can be passed to web2py.py with the ``-L`` option. The second is an example of a URL mapping file. It is loaded automatically when renamed &quot;routes.py&quot;. The third is an alternative syntax for URL mapping, and can also be renamed (or copied to) &quot;routes.py&quot;.</div><div class=""> </div><div class=""> The files</div><div class=""> ``</div><div class=""> app.example.yaml</div><div class=""> queue.example.yaml</div><div class=""> ``:code</div><div class=""> </div><div class=""> are example configuration files used for deployment on the Google App Engine. You can read more about them in the Deployment Recipes chapter and on the Google Documentation pages.</div><div class=""> </div><div class=""> There are also additional libraries, some developed by a third party:</div><div class=""> </div><div class=""> **feedparser**``feedparser``:cite  by Mark Pilgrim for reading RSS and Atom feeds:</div><div class=""> ``</div><div class=""> gluon/contrib/__init__.py</div><div class=""> gluon/contrib/feedparser.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> **markdown2**``markdown2``:cite  by Trent Mick for wiki markup:</div><div class=""> ``</div><div class=""> routers = dict(</div><div class="">           &#x27;domain1.com&#x27; : &#x27;app1&#x27;,</div><div class="">           &#x27;domain2.com&#x27; : &#x27;app2&#x27;,</div><div class="">       }</div><div class="">   ),</div><div class=""> )</div><div class=""> ``:code</div><div class=""> does what you&#x27;d expect.</div><div class=""> </div><div class=""> ``</div><div class=""> routers = dict(</div><div class="">   BASE  = dict(</div><div class="">       domains = {</div><div class="">           &#x27;domain.com:80&#x27;  : &#x27;app/insecure&#x27;,</div><div class="">           &#x27;domain.com:443&#x27; : &#x27;app/secure&#x27;,</div><div class="">       }</div><div class="">   ),</div><div class=""> )</div><div class=""> ``:code</div><div class=""> maps ``http://domain.com`` accesses to the controller named ``insecure``, while ``HTTPS`` accesses go to the ``secure`` controller. Alternatively, you can map different ports to different apps, in the obvious way.</div><div class=""> </div><div class="delete">For further information, please consult the file [[<span class="highlight">``router.example.py`` http</span>://<span class="highlight"></span>co<span class="highlight">de.google.com/p</span>/web2py/<span class="highlight">source/bro</span>w<span class="highlight">se</span>/router.example.py]] provided in the <span class="highlight">base</span> folder of the standard web2py distribution.</div><div class=""> </div><div class=""> Note: The &#x27;&#x27;parameter-based&#x27;&#x27; system first appeared in web2py version 1.92.1.</div><div class=""> </div><div class=""> #### Pattern-based system</div><div class=""> </div><div class=""> Although the &#x27;&#x27;parameter-based&#x27;&#x27; system just described should be sufficient for most use cases, the alternative &#x27;&#x27;pattern-based&#x27;&#x27; system provides some additional flexibility for more complex cases. To use the pattern-based system, instead of defining routers as dictionaries of routing parameters, you define two lists (or tuples) of 2-tuples, ``routes_in`` and ``routes_out``. Each tuple contains two elements: the pattern to be replaced and the string that replaces it. For example:</div><div class=""> ``</div><div class=""> routes_in = (</div><div class="">   (&#x27;/testme&#x27;, &#x27;/examples/default/index&#x27;),</div><div class=""> )</div><div class=""> routes_out = (</div><div class="">   (&#x27;/examples/default/index&#x27;, &#x27;/testme&#x27;),</div><div class=""> )</div><div class=""> ``:code</div><div class=""> </div><div class=""> With these routes, the URL:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/testme</div><div class=""> ``:code</div><div class=""> </div><div class=""> Note: These items first appeared in web2py version 1.83.</div><div class=""> ``routes_onerror``:inxx</div><div class=""> </div><div class=""> You can also use ``routes.py`` to re-route requests to special actions in case there is an error on the server. You can specify this mapping globally, for each app, for each error code, or for each app and error code. Here is an example:</div><div class=""> ``</div><div class=""> routes_onerror = [</div><div class="">   (&#x27;init/400&#x27;, &#x27;/init/default/login&#x27;),</div><div class="">   (&#x27;init/*&#x27;, &#x27;/init/static/fail.html&#x27;),</div><div class="">   (&#x27;*/404&#x27;, &#x27;/init/static/cantfind.html&#x27;),</div><div class="">   (&#x27;*/*&#x27;, &#x27;/init/error/index&#x27;)</div><div class=""> ]</div><div class=""> ``:code</div><div class=""> </div><div class=""> For each tuple, the first string is matched against &quot;[app name]/[error code]&quot;. If a match is found, the failed request is re-routed to the URL in the second string of the matching tuple. If the error handling URL is a not a static file, the following GET variables will be passed to the error action:</div><div class=""> - ``code``: the HTTP status code (e.g., 404, 500)</div><div class=""> - ``ticket``: in the form of &quot;[app name]/[ticket number]&quot; (or &quot;None&quot; if no ticket)</div><div class=""> - ``requested_uri``: equivalent to ``request.env.request_uri``</div><div class=""> - ``request_url``: equivalent to ``request.url``</div><div class=""> </div><div class=""> These variables will be accessible to the error handling action via ``request.vars`` and can be used in generating the error response. In particular, it is a good idea for the error action to return the original HTTP error code instead of the default 200 (OK) status code. This can be done by setting ``response.status = request.vars.code``. It is also possible to have the error action send (or queue) an email to an administrator, including a link to the ticket in ``admin``.</div><div class=""> </div><div class="delete">Unmatched errors display a default error page. This default error page can also be customized here (see <span class="highlight">``</span>router.example.py<span class="highlight">``</span> and <span class="highlight">``</span>routes.example.py<span class="highlight">``</span> in the <span class="highlight">root w</span>e<span class="highlight">b2</span>p<span class="highlight">y</span> folder):</div><div class=""> ``</div><div class=""> error_message = &#x27;&lt;html&gt;&lt;body&gt;&lt;h1&gt;%s&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&#x27;</div><div class=""> error_message_ticket = &#x27;&#x27;&#x27;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Internal error&lt;/h1&gt;</div><div class="">      Ticket issued: &lt;a href=&quot;/admin/default/ticket/%(ticket)s&quot;</div><div class="">      target=&quot;_blank&quot;&gt;%(ticket)s&lt;/a&gt;&lt;/body&gt;&lt;/html&gt;&#x27;&#x27;&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class=""> The first variable contains the error message when an invalid application or function is requested. The second variable contains the error message when a ticket is issued.</div><div class=""> </div><div class=""> ``routes_onerror`` work with both routing mechanisms.</div><div class=""> </div><div class=""> ``error_handler``:inxx</div><div class=""> In &quot;routes.py&quot; you can also specify an action in charge of error handling:</div><div class=""> </div><div class=""> ``</div><div class=""> error_handler = dict(application=&#x27;error&#x27;,</div><div class="">                       controller=&#x27;default&#x27;,</div><div class="">                       function=&#x27;index&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> import logging</div><div class=""> logger = logging.getLogger(&quot;web2py.app.myapp&quot;)</div><div class=""> logger.setLevel(logging.DEBUG)</div><div class=""> ``:code</div><div class=""> </div><div class=""> and you can use it to log messages of various importance</div><div class=""> </div><div class=""> ``</div><div class=""> logger.debug(&quot;Just checking that %s&quot; % details)</div><div class=""> logger.info(&quot;You ought to know that %s&quot; % details)</div><div class=""> logger.warn(&quot;Mind that %s&quot; % details)</div><div class=""> logger.error(&quot;Oops, something bad happened %s&quot; % details)</div><div class=""> ``:code</div><div class=""> </div><div class=""> ``logging`` is a standard python module described here:</div><div class=""> ``</div><div class=""> http://docs.python.org/library/logging.html</div><div class=""> ``</div><div class=""> The string &quot;web2py.app.myapp&quot; defines an app-level logger.</div><div class=""> </div><div class=""> For this to work properly, you need a configuration file for the logger.</div><div class="delete">One is provided by web2py in the <span class="highlight">root w</span>e<span class="highlight">b2</span>p<span class="highlight">y</span> folder &quot;logging.example.conf&quot;. You need to <span class="highlight"></span>rename the file<span class="highlight"></span> &quot;logging.conf&quot; and customize it as necessary.</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/185d733fc840b62ad03595850b7a4e6a1ecb2d37">185d733</a><ul><li>Date : 2013-08-25</li><li>another get_vars/post_vars, thanks Niphlod</li></ul></li></ul>
<div class="row-fluid" id="com_185d733fc840b62ad03595850b7a4e6a1ecb2d37">
    <div class="span6"><div class="diff"><div class=""> ``request`` has the following items/attributes, some of which are also an instance of the ``Storage`` class:</div><div class=""> - ``request.cookies``: a ``Cookie.SimpleCookie()`` object containing the cookies passed with the HTTP request. It acts like a dictionary of cookies. Each cookie is a Morsel object ``morsel``:cite.</div><div class=""> - ``request.env``: a ``Storage`` object containing the environment variables passed to the controller, including HTTP header variables from the HTTP request and standard WSGI parameters. The environment variables are all converted to lower case, and dots are converted to underscores for easier memorization.</div><div class=""> - ``request.application``: the name of the requested application.</div><div class=""> - ``request.controller``: the name of the requested controller.</div><div class=""> - ``request.function``: the name of the requested function.</div><div class=""> - ``request.extension``: the extension of the requested action. It defaults to &quot;html&quot;. If the controller function returns a dictionary and does not specify a view, this is used to determine the extension of the view file that will render the dictionary (parsed from the ``request.env.path_info``).</div><div class=""> - ``request.folder``: the application directory. For example if the application is &quot;welcome&quot;, ``request.folder`` is set to the absolute path &quot;/path/to/welcome&quot;. In your programs, you should always use this variable and the ``os.path.join`` function to build paths to the files you need to access. Although web2py always uses absolute paths, it is a good rule never to explicitly  change the current working folder (whatever that is) since this is not a thread-safe practice.</div><div class=""> - ``request.now``: a ``datetime.datetime`` object storing the datetime of the current request.</div><div class=""> - ``request.utcnow``: a ``datetime.datetime`` object storing the UTC datetime of the current request.</div><div class=""> - ``request.args``: A list of the URL path components following the controller function name; equivalent to ``request.env.path_info.split(&#x27;/&#x27;)[3:]``</div><div class="insert">+- ``request.vars``: a ``gluon.storage.Storage`` object containing all request parameters.</div><div class="insert">+- ``request.get_vars``: a ``gluon.storage.Storage`` object containing only parameters passed into the query string (a request to ``/a/c/f?var1=1&amp;var2=2`` will end in ``{var1: &quot;1&quot;, var2: &quot;2&quot;}``)</div><div class="insert">+- ``request.post_vars``: a ``gluon.storage.Storage`` object containing only the parameters passed into the body of the request (usually in POST, PUT, DELETE requests).</div><div class=""> - ``request.client``: The ip address of the client as determined by, if present, ``request.env.http_x_forwarded_for`` or by ``request.env.remote_addr`` otherwise. While this is useful it should not be trusted because the ``http_x_forwarded_for`` can be spoofed.</div><div class=""> - ``request.is_local``: ``True`` if the client is localhost, ``False`` otherwise. Should work behind a proxy if the proxy supports ``http_x_forwarded_for``.</div><div class=""> - ``request.is_https``: ``True`` if the request is using the HTTPS protocol, ``False`` otherwise.</div><div class=""> - ``request.body``: a read-only file stream that contains the body of the HTTP request. This is automatically parsed to get the ``request.post_vars`` and then rewinded. It can be read with ``request.body.read()``.</div><div class=""> - ``request.ajax`` is True if the function is being called via an Ajax request.</div><div class=""> - ``request.cid`` is the ``id`` of the component that generated the Ajax request (if any). You can read more about components in Chapter 12.</div><div class=""> - ``request.requires_https()`` prevents further code execution if the request is not over HTTPS and redirects the visitor to the current page over HTTPS.</div><div class=""> - ``request.restful`` this is a new and very useful decorator that can be used to change the default behavior of web2py actions by separating GET/POST/PUSH/DELETE requests. It will be discussed in some detail in Chapter 10.</div><div class=""> - ``request.user_agent()`` parses the user_agent field from the client and returns the information in the form of a dictionary. It is useful to detect mobile devices. It uses &quot;gluon/contrib/user_agent_parser.py&quot; created by Ross Peoples. To see what it does, try to embed the following code in a view:</div><div class=""> ``</div><div class=""> {{=BEAUTIFY(request.user_agent())}}</div><div class=""> ``:code</div></div></div>
    <div class="span6"><div class="diff"><div class=""> ``request`` has the following items/attributes, some of which are also an instance of the ``Storage`` class:</div><div class=""> - ``request.cookies``: a ``Cookie.SimpleCookie()`` object containing the cookies passed with the HTTP request. It acts like a dictionary of cookies. Each cookie is a Morsel object ``morsel``:cite.</div><div class=""> - ``request.env``: a ``Storage`` object containing the environment variables passed to the controller, including HTTP header variables from the HTTP request and standard WSGI parameters. The environment variables are all converted to lower case, and dots are converted to underscores for easier memorization.</div><div class=""> - ``request.application``: the name of the requested application.</div><div class=""> - ``request.controller``: the name of the requested controller.</div><div class=""> - ``request.function``: the name of the requested function.</div><div class=""> - ``request.extension``: the extension of the requested action. It defaults to &quot;html&quot;. If the controller function returns a dictionary and does not specify a view, this is used to determine the extension of the view file that will render the dictionary (parsed from the ``request.env.path_info``).</div><div class=""> - ``request.folder``: the application directory. For example if the application is &quot;welcome&quot;, ``request.folder`` is set to the absolute path &quot;/path/to/welcome&quot;. In your programs, you should always use this variable and the ``os.path.join`` function to build paths to the files you need to access. Although web2py always uses absolute paths, it is a good rule never to explicitly  change the current working folder (whatever that is) since this is not a thread-safe practice.</div><div class=""> - ``request.now``: a ``datetime.datetime`` object storing the datetime of the current request.</div><div class=""> - ``request.utcnow``: a ``datetime.datetime`` object storing the UTC datetime of the current request.</div><div class=""> - ``request.args``: A list of the URL path components following the controller function name; equivalent to ``request.env.path_info.split(&#x27;/&#x27;)[3:]``</div><div class="delete">-- ``request.vars``: a ``gluon.storage.Storage`` object containing both the HTTP GET and HTTP POST query variables.</div><div class="delete">-- ``request.get_vars``: a ``gluon.storage.Storage`` object containing only the HTTP GET query variables.</div><div class="delete">-- ``request.post_vars``: a ``gluon.storage.Storage`` object containing only the HTTP POST query variables.</div><div class=""> - ``request.client``: The ip address of the client as determined by, if present, ``request.env.http_x_forwarded_for`` or by ``request.env.remote_addr`` otherwise. While this is useful it should not be trusted because the ``http_x_forwarded_for`` can be spoofed.</div><div class=""> - ``request.is_local``: ``True`` if the client is localhost, ``False`` otherwise. Should work behind a proxy if the proxy supports ``http_x_forwarded_for``.</div><div class=""> - ``request.is_https``: ``True`` if the request is using the HTTPS protocol, ``False`` otherwise.</div><div class=""> - ``request.body``: a read-only file stream that contains the body of the HTTP request. This is automatically parsed to get the ``request.post_vars`` and then rewinded. It can be read with ``request.body.read()``.</div><div class=""> - ``request.ajax`` is True if the function is being called via an Ajax request.</div><div class=""> - ``request.cid`` is the ``id`` of the component that generated the Ajax request (if any). You can read more about components in Chapter 12.</div><div class=""> - ``request.requires_https()`` prevents further code execution if the request is not over HTTPS and redirects the visitor to the current page over HTTPS.</div><div class=""> - ``request.restful`` this is a new and very useful decorator that can be used to change the default behavior of web2py actions by separating GET/POST/PUSH/DELETE requests. It will be discussed in some detail in Chapter 10.</div><div class=""> - ``request.user_agent()`` parses the user_agent field from the client and returns the information in the form of a dictionary. It is useful to detect mobile devices. It uses &quot;gluon/contrib/user_agent_parser.py&quot; created by Ross Peoples. To see what it does, try to embed the following code in a view:</div><div class=""> ``</div><div class=""> {{=BEAUTIFY(request.user_agent())}}</div><div class=""> ``:code</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/7e7e01785344e80494420d4f507d11be3ca68d4b">7e7e017</a><ul><li>Date : 2013-08-24</li><li>fixed text about get_vars and post_vars, thanks Niphlod</li></ul></li></ul>
<div class="row-fluid" id="com_7e7e01785344e80494420d4f507d11be3ca68d4b">
    <div class="span6"><div class="diff"><div class=""> ``request.get_vars``:inxx ``request.post_vars``:inxx ``request.vars``:inxx</div><div class="insert">+If the HTTP request is a GET, then ``request.env.request_method`` is set to &quot;GET&quot;; if it is a POST, ``request.env.request_method`` is set to &quot;POST&quot;. </div><div class="insert">+URL query variables are stored in ``request.get_vars``.</div><div class="insert">+``request.post_vars`` contains all parameters passed into the body of a request (usually a POST, PUT or a DELETE one).</div><div class="insert">+The ``request.vars`` Storage dictionary contains both of them (``get_vars`` and ``post_vars`` get merged)</div></div></div>
    <div class="span6"><div class="diff"><div class=""> ``request.get_vars``:inxx ``request.post_vars``:inxx ``request.vars``:inxx</div><div class="delete">-If the HTTP request is a GET, then ``request.env.request_method`` is set to &quot;GET&quot;; if it is a POST, ``request.env.request_method`` is set to &quot;POST&quot;. URL query variables are stored in the ``request.vars`` Storage dictionary; they are also stored in ``request.get_vars`` (following a GET request) or ``request.post_vars`` (following a POST request).</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/90939933b126998cf4862eaa483e5603e78164c5">9093993</a><ul><li>Date : 2013-07-25</li><li>Minor changes to scheduler documentation, removing experimental</li></ul></li></ul>
<div class="row-fluid" id="com_90939933b126998cf4862eaa483e5603e78164c5">
    <div class="span6"><div class="diff"><div class="insert">+#### Scheduler </div><div class="insert">+</div><div class="insert">+Prior to version 2.6.0 the scheduler was considered experimental. From v2.6.0 the documented API is stable.</div><div class="insert">+The stable API consists of these functions:</div><div class="insert">+- disable()</div><div class="insert">+- resume()</div><div class="insert">+- terminate()</div><div class="insert">+- kill()</div><div class="insert">+- queue_task(), </div><div class="insert">+- task_status() </div><div class="insert">+- stop_task()</div><div class=""> </div><div class=""> The web2py scheduler works very much like the task queue described in the previous sub-section with some differences:</div><div class=""> - It provides a standard mechanism for creating, scheduling, and monitoring tasks.</div><div class=""> - There is not a single background process but a set of workers processes.</div><div class=""> - The job of worker nodes can be monitored because their state, as well as the state of the tasks, is stored in the database.</div><div class=""> - It works without web2py but that is not documented here.</div><div class=""> </div><div class=""> The scheduler does not use cron, although one can use cron @reboot to start the worker nodes.</div><div class=""> </div><div class=""> More information about deploying the scheduler under Linux and Windows is in the Deployment recipes chapter.</div><div class=""> </div><div class=""> In the scheduler, a task is simply a function defined in a model (or in a module and imported by a model). For example:</div><div class=""> </div><div class=""> ``</div><div class=""> def task_add(a,b):</div><div class="">     return a+b</div><div class=""> ``:code</div><div class=""> </div><div class=""> Tasks will always be called in the same environment seen by controllers and therefore they see all the global variables defined in models, including database connections (``db``). Tasks differ from a controller action because they are not associated with an HTTP request and therefore there is no ``request.env``.</div><div class=""> </div><div class=""> The task is scheduled with</div><div class=""> scheduler.queue_task(task_add,pvars=dict(a=1,b=2))</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> ##### Parameters</div><div class=""> </div><div class=""> The first argument of the ``Scheduler`` class must be the database to be used by the scheduler to communicate with the workers. This can be the ``db`` of the app or another dedicated ``db``, perhaps one shared by multiple apps. If you use SQLite it&#x27;s recommended to use a separate db from the one used by your app in order to keep the app responsive.</div><div class=""> Once the tasks are defined and the ``Scheduler`` is instantiated, all that is needed to do is to start the workers. You can do that in several ways:</div><div class=""> </div><div class=""> ``</div><div class=""> python web2py.py -K myapp</div><div class=""> ``</div><div class=""> starts a worker for the app ``myapp``. If you want start multiple workers for the same app, you can do so just passing ``myapp,myapp``. You can pass also the ``group_names`` (overriding the one set in your model) with</div><div class=""> </div><div class=""> ``</div><div class=""> python web2py.py -K myapp:group1:group2,myotherapp:group1</div><div class=""> ``</div><div class=""> </div><div class=""> If you have a model called ``scheduler.py`` you can start/stop the workers from web2py&#x27;s default window (the one you use to set the ip address and the port).</div><div class=""> </div><div class="insert">+##### Scheduler Deployment</div><div class=""> One last nice addition: if you use the embedded webserver, you can start the webserver and the scheduler with just one line of code (this assumes you don&#x27;t want the web2py window popping up, else you can use the &quot;Schedulers&quot; menu instead)</div><div class=""> </div><div class=""> ``</div><div class=""> python web2py.py -a yourpass -K myapp -X</div><div class=""> ``</div><div class=""> You can pass the usual parameters (-i, -p, here -a prevents the window from showing up), pass whatever app in the -K parameter and append a -X. The scheduler will run alongside the webserver!</div><div class=""> </div><div class="insert">+Windows users looking to create a service should see the Deployment Recipes chapter.</div><div class="insert">+</div><div class="insert">+</div><div class="insert">+##### Complete Scheduler signature</div><div class=""> Scheduler&#x27;s complete signature is:</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">-#### Scheduler (experimental)</div><div class=""> </div><div class=""> The web2py scheduler works very much like the task queue described in the previous sub-section with some differences:</div><div class=""> - It provides a standard mechanism for creating, scheduling, and monitoring tasks.</div><div class=""> - There is not a single background process but a set of workers processes.</div><div class=""> - The job of worker nodes can be monitored because their state, as well as the state of the tasks, is stored in the database.</div><div class=""> - It works without web2py but that is not documented here.</div><div class=""> </div><div class=""> The scheduler does not use cron, although one can use cron @reboot to start the worker nodes.</div><div class=""> </div><div class=""> More information about deploying the scheduler under Linux and Windows is in the Deployment recipes chapter.</div><div class=""> </div><div class=""> In the scheduler, a task is simply a function defined in a model (or in a module and imported by a model). For example:</div><div class=""> </div><div class=""> ``</div><div class=""> def task_add(a,b):</div><div class="">     return a+b</div><div class=""> ``:code</div><div class=""> </div><div class=""> Tasks will always be called in the same environment seen by controllers and therefore they see all the global variables defined in models, including database connections (``db``). Tasks differ from a controller action because they are not associated with an HTTP request and therefore there is no ``request.env``.</div><div class=""> </div><div class=""> The task is scheduled with</div><div class=""> scheduler.queue_task(task_add,pvars=dict(a=1,b=2))</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> ##### Parameters</div><div class=""> </div><div class=""> The first argument of the ``Scheduler`` class must be the database to be used by the scheduler to communicate with the workers. This can be the ``db`` of the app or another dedicated ``db``, perhaps one shared by multiple apps. If you use SQLite it&#x27;s recommended to use a separate db from the one used by your app in order to keep the app responsive.</div><div class=""> Once the tasks are defined and the ``Scheduler`` is instantiated, all that is needed to do is to start the workers. You can do that in several ways:</div><div class=""> </div><div class=""> ``</div><div class=""> python web2py.py -K myapp</div><div class=""> ``</div><div class=""> starts a worker for the app ``myapp``. If you want start multiple workers for the same app, you can do so just passing ``myapp,myapp``. You can pass also the ``group_names`` (overriding the one set in your model) with</div><div class=""> </div><div class=""> ``</div><div class=""> python web2py.py -K myapp:group1:group2,myotherapp:group1</div><div class=""> ``</div><div class=""> </div><div class=""> If you have a model called ``scheduler.py`` you can start/stop the workers from web2py&#x27;s default window (the one you use to set the ip address and the port).</div><div class=""> </div><div class=""> One last nice addition: if you use the embedded webserver, you can start the webserver and the scheduler with just one line of code (this assumes you don&#x27;t want the web2py window popping up, else you can use the &quot;Schedulers&quot; menu instead)</div><div class=""> </div><div class=""> ``</div><div class=""> python web2py.py -a yourpass -K myapp -X</div><div class=""> ``</div><div class=""> You can pass the usual parameters (-i, -p, here -a prevents the window from showing up), pass whatever app in the -K parameter and append a -X. The scheduler will run alongside the webserver!</div><div class=""> </div><div class=""> Scheduler&#x27;s complete signature is:</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/0677242ae882ef63cd9c160ad73e63c8a8a6ba41">0677242</a><ul><li>Date : 2013-07-05</li><li>Correct response.download method name in Chapter 4</li></ul></li></ul>
<div class="row-fluid" id="com_0677242ae882ef63cd9c160ad73e63c8a8a6ba41">
    <div class="span6"><div class="diff"><div class=""> - ``response.body``: a ``StringIO`` object into which web2py writes the output page body. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.cookies``: similar to ``request.cookies``, but while the latter contains the cookies sent from the client to the server, the former contains cookies sent by the server to the client. The session cookie is handled automatically.</div><div class="insert">- ``response.download(request, db)``: a method used to implement the controller function that allows downloading of uploaded files. ``re<span class="highlight">sponse</span>.download`` expects the last ``arg`` in ``request.args`` to be the encoded filename (i.e., the filename generated at upload time and stored in the upload field). It extracts the upload field name and table name as well as the original filename from the encoded filename. ``response.download`` takes two optional arguments: ``chunk_size`` sets the size in bytes for chunked streaming (defaults to 64K), and ``attachments`` determines whether the downloaded file should be treated as an attachment or not (default to ``True``). Note, ``response.download`` is specifically for downloading files associated with ``db`` upload fields. Use ``response.stream`` (see below) for other types of file downloads and streaming. Also, note that it is not necessary to use ``response.download`` to access files uploaded to the /static folder -- static files can (and generally should) be accessed directly via URL (e.g., /app/static/files/myfile.pdf).</div></div></div>
    <div class="span6"><div class="diff"><div class=""> - ``response.body``: a ``StringIO`` object into which web2py writes the output page body. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.cookies``: similar to ``request.cookies``, but while the latter contains the cookies sent from the client to the server, the former contains cookies sent by the server to the client. The session cookie is handled automatically.</div><div class="delete">- ``response.download(request, db)``: a method used to implement the controller function that allows downloading of uploaded files. ``re<span class="highlight">quest</span>.download`` expects the last ``arg`` in ``request.args`` to be the encoded filename (i.e., the filename generated at upload time and stored in the upload field). It extracts the upload field name and table name as well as the original filename from the encoded filename. ``response.download`` takes two optional arguments: ``chunk_size`` sets the size in bytes for chunked streaming (defaults to 64K), and ``attachments`` determines whether the downloaded file should be treated as an attachment or not (default to ``True``). Note, ``response.download`` is specifically for downloading files associated with ``db`` upload fields. Use ``response.stream`` (see below) for other types of file downloads and streaming. Also, note that it is not necessary to use ``response.download`` to access files uploaded to the /static folder -- static files can (and generally should) be accessed directly via URL (e.g., /app/static/files/myfile.pdf).</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/5c8132747606fd3202f87e6a7e1f40bc44a40446">5c81327</a><ul><li>Date : 2013-07-05</li><li>Fix function name in the example</li></ul></li></ul>
<div class="row-fluid" id="com_5c8132747606fd3202f87e6a7e1f40bc44a40446">
    <div class="span6"><div class="diff"><div class=""> ----------</div><div class=""> **variable** | **value**</div><div class=""> ``request.application`` | ``examples``</div><div class=""> ``request.controller`` | ``default``</div><div class="insert">``request.function`` | ``<span class="highlight">status</span>``</div></div></div>
    <div class="span6"><div class="diff"><div class=""> ----------</div><div class=""> **variable** | **value**</div><div class=""> ``request.application`` | ``examples``</div><div class=""> ``request.controller`` | ``default``</div><div class="delete">``request.function`` | ``<span class="highlight">index</span>``</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/8e6b2e59de0fcefc30df59ddb554259997229161">8e6b2e5</a><ul><li>Date : 2013-06-25</li><li>clarifying the meaning of the --folder command line option</li></ul></li></ul>
<div class="row-fluid" id="com_8e6b2e59de0fcefc30df59ddb554259997229161">
    <div class="span6"><div class="diff"><div class="insert">                        <span class="highlight">location of the applications </span>folder <span class="highlight">(also known as di</span>r<span class="highlight">e</span>c<span class="highlight"></span>to<span class="highlight">ry)</span> <span class="highlight"></span></div></div></div>
    <div class="span6"><div class="diff"><div class="delete">                        <span class="highlight"></span>folder <span class="highlight">f</span>r<span class="highlight">om whi</span>c<span class="highlight">h </span>to<span class="highlight"></span> <span class="highlight">run web2py</span></div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/095fafdc4aac3affea53728fb10f65dfebcdccde">095fafd</a><ul><li>Date : 2013-06-09</li><li>documentation of models_to_run, thanks niphlod</li></ul></li></ul>
<div class="row-fluid" id="com_095fafdc4aac3affea53728fb10f65dfebcdccde">
    <div class="span6"><div class="diff"><div class=""> There are some caveats to keep in mind:</div><div class=""> - Models in the same folder/subfolder are executed in alphabetical order.</div><div class=""> - Any variable defined in a model will be visible to other models following alphabetically, to the controllers, and to the views.</div><div class="insert">+``models_to_run``:inxx</div><div class=""> - Models in subfolders are executed conditionally. For example, if the user has requested &quot;/a/c/f&quot; where &quot;a&quot; is the application, &quot;c&quot; is the controller, and &quot;f&quot; is the function (action), then the following models are executed:</div><div class=""> </div><div class=""> ``</div><div class=""> applications/a/models/*.py</div><div class=""> applications/a/models/c/*.py</div><div class=""> applications/a/models/c/f/*.py</div><div class=""> ``</div><div class="insert">+  This behaviour is enforced by default. Altering the ``response.models_to_run`` regex list, you can force the behaviour you want. Look at [[response #response_models_to_run]] for additional details</div><div class=""> </div><div class=""> - The requested controller is executed and the requested function is called. This means all top-level code in the controller is also executed at every request for that controller.</div><div class=""> - The view is only called if the action returns a dictionary.</div><div class=""> - If a view is not found, web2py tries to use a generic view. By default, generic views are disabled, although the &#x27;welcome&#x27; app includes a line in /models/db.py to enable them on localhost only. They can be enabled per extension type and per action (using ``response.generic_patterns``). In general, generic views are a development tool and typically should not be used in production. If you want some actions to use a generic view, list those actions in ``response.generic_patterns`` (discussed in more detail in the chapter on Services).</div><div class=""> </div><div class=""> The possible behaviors of an action are the following:</div><div class=""> </div><div class=""> **Return a string**</div><div class=""> ``</div><div class=""> def index(): return &#x27;data&#x27;</div><div class=""> ``</div><div class=""> </div><div class=""> **Return a dictionary for a view**:</div><div class=""> ``</div><div class=""> def index(): return dict(key=&#x27;value&#x27;)</div><div class=""> ``</div><div class=""> </div><div class=""> **Return all local variables**:</div><div class=""> ``</div><div class=""> def index(): return locals()</div><div class=""> Also notice the ``request.env.wsgi_*`` variables. They are specific to the wsgi</div><div class=""> ``response.headers``:inxx</div><div class=""> ``response.meta``:inxx</div><div class=""> ``response.menu``:inxx</div><div class=""> ``response.postprocessing``:inxx</div><div class=""> ``response.render``:inxx</div><div class=""> ``response.static_version``:inxx</div><div class=""> ``response.status``:inxx</div><div class=""> ``response.stream``:inxx</div><div class=""> ``response.subtitle``:inxx</div><div class=""> ``response.title``:inxx</div><div class=""> ``response.toolbar``:inxx</div><div class=""> ``response.view``:inxx</div><div class=""> ``response.delimiters``:inxx</div><div class=""> ``response.js``:inxx</div><div class=""> ``response.write``:inxx</div><div class=""> ``response.include_files``:inxx</div><div class=""> ``response.include_meta``:inxx</div><div class=""> ``response.optimize_css``:inxx</div><div class=""> ``response.optimize_js``:inxx</div><div class=""> ``response._caller``:inxx</div><div class="insert">+``response.models_to_run``:inxx</div><div class=""> </div><div class=""> ``response`` is another instance of the ``Storage`` class. It contains the following:</div><div class=""> </div><div class=""> - ``response.body``: a ``StringIO`` object into which web2py writes the output page body. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.cookies``: similar to ``request.cookies``, but while the latter contains the cookies sent from the client to the server, the former contains cookies sent by the server to the client. The session cookie is handled automatically.</div><div class=""> - ``response.download(request, db)``: a method used to implement the controller function that allows downloading of uploaded files. ``request.download`` expects the last ``arg`` in ``request.args`` to be the encoded filename (i.e., the filename generated at upload time and stored in the upload field). It extracts the upload field name and table name as well as the original filename from the encoded filename. ``response.download`` takes two optional arguments: ``chunk_size`` sets the size in bytes for chunked streaming (defaults to 64K), and ``attachments`` determines whether the downloaded file should be treated as an attachment or not (default to ``True``). Note, ``response.download`` is specifically for downloading files associated with ``db`` upload fields. Use ``response.stream`` (see below) for other types of file downloads and streaming. Also, note that it is not necessary to use ``response.download`` to access files uploaded to the /static folder -- static files can (and generally should) be accessed directly via URL (e.g., /app/static/files/myfile.pdf).</div><div class=""> - ``response.files``: a list of ``.css``, ``.js``, ``.coffee``, and ``.less`` files required by the page. They will automatically be linked in the head of the standard &quot;layout.html&quot; via the included &quot;web2py_ajax.html&quot;. To include a new CSS, JS, COFFEE, or LESS file, just append it to this list. It will handle duplicates. The order is important.</div><div class=""> - ``response.include_files()`` generates html head tags to include all ``response.files`` (used in &quot;views/web2py_ajax.html&quot;).</div><div class=""> - ``response.flash``: optional parameter that may be included in the views. Normally used to notify the user about something that happened.</div><div class=""> - ``response.headers``: a ``dict`` for HTTP response headers. Web2py sets some headers by default, including &quot;Content-Length&quot;, &quot;Content-Type&quot;, and &quot;X-Powered-By&quot; (set equal to web2py). Web2py also sets the &quot;Cache-Control&quot;, &quot;Expires&quot;, and &quot;Pragma&quot; headers to prevent client-side caching, except for static file requests, for which client-side caching is enabled. The headers that web2py sets can be overwritten or removed, and new headers can be added (e.g., ``response.headers[&#x27;Cache-Control&#x27;] = &#x27;private&#x27;``). You can remove a header by removing its key from the response.headers dict, e.g. ``del response.headers[&#x27;Custom-Header&#x27;]``, however web2py&#x27;s default headers will be re-added just before returning the response. To avoid this behavior, just set the header value to None, e.g. to remove the default Content-Type header, ``response.headers[&#x27;Content-Type&#x27;] = None``</div><div class=""> - ``response.menu``: optional parameter that may be included in the views, normally used to pass a navigation menu tree to the view. It can be rendered by the MENU helper.</div><div class=""> - ``response.meta``: a Storage object that contains optional ``&lt;meta&gt;`` information like ``response.meta.author``, ``.description``, and/or ``.keywords``. The content of each meta variable is automatically placed in the proper ``META`` tag by the code in &quot;views/web2py_ajax.html&quot;, which is included by default in &quot;views/layout.html&quot;.</div><div class=""> - ``response.include_meta()`` generates a string that includes all ``response.meta`` headers serialized (used in &quot;views/web2py_ajax.html&quot;).</div><div class=""> - ``response.postprocessing``: this is a list of functions, empty by default. These functions are used to filter the response object at the output of an action, before the output is rendered by the view. It can be used to implement support for other template languages.</div><div class=""> - ``response.render(view, vars)``: a method used to call the view explicitly inside the controller. ``view`` is an optional parameter which is the name of the view file, ``vars`` is a dictionary of named values passed to the view.</div><div class=""> - ``response.session_file``: file stream containing the session.</div><div class=""> - ``response.session_file_name``: name of the file where the session will be saved.</div><div class=""> - ``response.session_id``: the id of the current session. It is determined automatically. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.session_id_name``: the name of the session cookie for this application. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.static_version``: a version number for the static asset management.  </div><div class=""> Also notice the ``request.env.wsgi_*`` variables. They are specific to the wsgi</div><div class=""> - ``response._caller``: this is a function that wraps all action calls. It defaults to the identity function, but it can be modified in order to catch special types of exception to do extra logging;</div><div class="">   ``</div><div class="">   response._caller = lambda f: f()</div><div class="">   ``</div><div class=""> - ``response.optimize_css``: can be set to &quot;concat,minify,inline&quot; to concatenate, minify and inline the CSS files included by web2py.</div><div class=""> - ``response.optimize_js``: can be set to &quot;concat,minify,inline&quot; to concatenate, minify and inline the JavaScript files included by web2py. </div><div class=""> - ``response.view``: the name of the view template that must render the page. This is set by default to:</div><div class="">   ``</div><div class="">   &quot;%s/%s.%s&quot; % (request.controller, request.function, request.extension)</div><div class="">   ``:code</div><div class="">   or, if the above file cannot be located, to</div><div class="">   ``</div><div class="">   &quot;generic.%s&quot; % (request.extension)</div><div class="">   ``:code</div><div class="">   Change the value of this variable to modify the view file associated with a particular action.</div><div class=""> </div><div class=""> - ``response.delimiters`` defaults to ``(&#x27;{{&#x27;,&#x27;}}&#x27;)``. It allows you to change the delimiter of code embedded in views.</div><div class=""> - ``response.xmlrpc(request, methods)``: when a controller returns it, this function exposes the methods via XML-RPC``xmlrpc``:cite . This function is deprecated since a better mechanism is available and described in Chapter 10.</div><div class=""> - ``response.write(text)``: a method to write text into the output page body.</div><div class=""> - ``response.js`` can contain Javascript code. This code will be executed if and only if the response is received by a web2py component as discussed in Chapter 12.</div><div class="insert">+- ``response.models_to_run`` [[response_models_to_run]] contains a list of regexes that chooses what models to run.</div><div class="insert">+-- By default, this is set automatically to load /a/models/*.py, /a/models/c/*.py, and /a/models/c/f/*.py files when ``/a/c/f`` is requested. You can set, e.g., ``response.models_to_run = [&#x27;myfolder/&#x27;]`` to force the execution only of the models inside your application&#x27;s ``models/myfolder`` subfolder.</div><div class="insert">+-- NB: ``response.models_to_run`` is a list of regex, not a list of filepaths. The regex are relative to the models/ folder, so any model file with a relative file path that matches one of the regexes will be executed.</div><div class=""> </div><div class=""> Since ``response`` is a ``gluon.storage.Storage`` object, it can be used to store other attributes that you may want to pass to the view. While there is no technical restriction, our recommendation is to store only variables that are to be rendered by all pages in the overall layout (&quot;layout.html&quot;).</div><div class=""> </div><div class=""> Anyway, we strongly suggest to stick to the variables listed here:</div><div class=""> ``</div><div class=""> response.title</div><div class=""> response.subtitle</div><div class=""> response.flash</div><div class=""> response.menu</div><div class=""> response.meta.author</div><div class=""> response.meta.description</div><div class=""> response.meta.keywords</div><div class=""> response.meta.*</div><div class=""> ``:code</div><div class=""> </div><div class=""> because this will make it easier for you to replace the standard &quot;layout.html&quot; file that comes with web2py with another layout file, one that uses the same set of variables.</div><div class=""> </div><div class=""> Old versions of web2py used ``response.author`` instead of ``response.meta.author`` and similar for the other meta attributes.</div><div class=""> </div><div class=""> ### ``session``</div><div class=""> redirect(&#x27;http://www.web2py.com&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> is simply a shortcut for:</div><div class=""> ``</div><div class=""> raise HTTP(303,</div><div class="">            &#x27;You are being redirected &lt;a href=&quot;%s&quot;&gt;here&lt;/a&gt;&#x27; % location,</div><div class="">            Location=&#x27;http://www.web2py.com&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The named arguments of the ``HTTP`` initializer method are translated into HTTP header directives, in this case, the redirection target location. ``redirect`` takes an optional second argument, which is the HTTP status code for the redirection (303 by default). Change this number to 307 for a temporary redirect or to 301 for a permanent redirect.</div><div class=""> </div><div class=""> The most common way to use redirect is to redirect to other pages in the same app and (optionally) pass parameters:</div><div class=""> </div><div class=""> ``</div><div class=""> redirect(URL(&#x27;index&#x27;, args=(1,2,3), vars=dict(a=&#x27;b&#x27;)))</div><div class=""> ``:code</div><div class=""> </div><div class=""> In chapter 12 we discuss web2py components. They make Ajax requests to web2py actions. If the called action performs a redirect, you may want the Ajax request to follow the redirect or you may want the entire page performing the Ajax request redirecting. In this latter case you can set:</div><div class=""> </div><div class=""> ``</div><div class="insert">redirect(...,<span class="highlight">clien</span>t<span class="highlight">_sid</span>e=<span class="highlight">Tr</span>u<span class="highlight">e</span>)</div><div class=""> ``:code</div></div></div>
    <div class="span6"><div class="diff"><div class=""> There are some caveats to keep in mind:</div><div class=""> - Models in the same folder/subfolder are executed in alphabetical order.</div><div class=""> - Any variable defined in a model will be visible to other models following alphabetically, to the controllers, and to the views.</div><div class=""> - Models in subfolders are executed conditionally. For example, if the user has requested &quot;/a/c/f&quot; where &quot;a&quot; is the application, &quot;c&quot; is the controller, and &quot;f&quot; is the function (action), then the following models are executed:</div><div class=""> </div><div class=""> ``</div><div class=""> applications/a/models/*.py</div><div class=""> applications/a/models/c/*.py</div><div class=""> applications/a/models/c/f/*.py</div><div class=""> ``</div><div class=""> </div><div class=""> - The requested controller is executed and the requested function is called. This means all top-level code in the controller is also executed at every request for that controller.</div><div class=""> - The view is only called if the action returns a dictionary.</div><div class=""> - If a view is not found, web2py tries to use a generic view. By default, generic views are disabled, although the &#x27;welcome&#x27; app includes a line in /models/db.py to enable them on localhost only. They can be enabled per extension type and per action (using ``response.generic_patterns``). In general, generic views are a development tool and typically should not be used in production. If you want some actions to use a generic view, list those actions in ``response.generic_patterns`` (discussed in more detail in the chapter on Services).</div><div class=""> </div><div class=""> The possible behaviors of an action are the following:</div><div class=""> </div><div class=""> **Return a string**</div><div class=""> ``</div><div class=""> def index(): return &#x27;data&#x27;</div><div class=""> ``</div><div class=""> </div><div class=""> **Return a dictionary for a view**:</div><div class=""> ``</div><div class=""> def index(): return dict(key=&#x27;value&#x27;)</div><div class=""> ``</div><div class=""> </div><div class=""> **Return all local variables**:</div><div class=""> ``</div><div class=""> def index(): return locals()</div><div class=""> Also notice the ``request.env.wsgi_*`` variables. They are specific to the wsgi</div><div class=""> ``response.headers``:inxx</div><div class=""> ``response.meta``:inxx</div><div class=""> ``response.menu``:inxx</div><div class=""> ``response.postprocessing``:inxx</div><div class=""> ``response.render``:inxx</div><div class=""> ``response.static_version``:inxx</div><div class=""> ``response.status``:inxx</div><div class=""> ``response.stream``:inxx</div><div class=""> ``response.subtitle``:inxx</div><div class=""> ``response.title``:inxx</div><div class=""> ``response.toolbar``:inxx</div><div class=""> ``response.view``:inxx</div><div class=""> ``response.delimiters``:inxx</div><div class=""> ``response.js``:inxx</div><div class=""> ``response.write``:inxx</div><div class=""> ``response.include_files``:inxx</div><div class=""> ``response.include_meta``:inxx</div><div class=""> ``response.optimize_css``:inxx</div><div class=""> ``response.optimize_js``:inxx</div><div class=""> ``response._caller``:inxx</div><div class=""> </div><div class=""> ``response`` is another instance of the ``Storage`` class. It contains the following:</div><div class=""> </div><div class=""> - ``response.body``: a ``StringIO`` object into which web2py writes the output page body. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.cookies``: similar to ``request.cookies``, but while the latter contains the cookies sent from the client to the server, the former contains cookies sent by the server to the client. The session cookie is handled automatically.</div><div class=""> - ``response.download(request, db)``: a method used to implement the controller function that allows downloading of uploaded files. ``request.download`` expects the last ``arg`` in ``request.args`` to be the encoded filename (i.e., the filename generated at upload time and stored in the upload field). It extracts the upload field name and table name as well as the original filename from the encoded filename. ``response.download`` takes two optional arguments: ``chunk_size`` sets the size in bytes for chunked streaming (defaults to 64K), and ``attachments`` determines whether the downloaded file should be treated as an attachment or not (default to ``True``). Note, ``response.download`` is specifically for downloading files associated with ``db`` upload fields. Use ``response.stream`` (see below) for other types of file downloads and streaming. Also, note that it is not necessary to use ``response.download`` to access files uploaded to the /static folder -- static files can (and generally should) be accessed directly via URL (e.g., /app/static/files/myfile.pdf).</div><div class=""> - ``response.files``: a list of ``.css``, ``.js``, ``.coffee``, and ``.less`` files required by the page. They will automatically be linked in the head of the standard &quot;layout.html&quot; via the included &quot;web2py_ajax.html&quot;. To include a new CSS, JS, COFFEE, or LESS file, just append it to this list. It will handle duplicates. The order is important.</div><div class=""> - ``response.include_files()`` generates html head tags to include all ``response.files`` (used in &quot;views/web2py_ajax.html&quot;).</div><div class=""> - ``response.flash``: optional parameter that may be included in the views. Normally used to notify the user about something that happened.</div><div class=""> - ``response.headers``: a ``dict`` for HTTP response headers. Web2py sets some headers by default, including &quot;Content-Length&quot;, &quot;Content-Type&quot;, and &quot;X-Powered-By&quot; (set equal to web2py). Web2py also sets the &quot;Cache-Control&quot;, &quot;Expires&quot;, and &quot;Pragma&quot; headers to prevent client-side caching, except for static file requests, for which client-side caching is enabled. The headers that web2py sets can be overwritten or removed, and new headers can be added (e.g., ``response.headers[&#x27;Cache-Control&#x27;] = &#x27;private&#x27;``). You can remove a header by removing its key from the response.headers dict, e.g. ``del response.headers[&#x27;Custom-Header&#x27;]``, however web2py&#x27;s default headers will be re-added just before returning the response. To avoid this behavior, just set the header value to None, e.g. to remove the default Content-Type header, ``response.headers[&#x27;Content-Type&#x27;] = None``</div><div class=""> - ``response.menu``: optional parameter that may be included in the views, normally used to pass a navigation menu tree to the view. It can be rendered by the MENU helper.</div><div class=""> - ``response.meta``: a Storage object that contains optional ``&lt;meta&gt;`` information like ``response.meta.author``, ``.description``, and/or ``.keywords``. The content of each meta variable is automatically placed in the proper ``META`` tag by the code in &quot;views/web2py_ajax.html&quot;, which is included by default in &quot;views/layout.html&quot;.</div><div class=""> - ``response.include_meta()`` generates a string that includes all ``response.meta`` headers serialized (used in &quot;views/web2py_ajax.html&quot;).</div><div class=""> - ``response.postprocessing``: this is a list of functions, empty by default. These functions are used to filter the response object at the output of an action, before the output is rendered by the view. It can be used to implement support for other template languages.</div><div class=""> - ``response.render(view, vars)``: a method used to call the view explicitly inside the controller. ``view`` is an optional parameter which is the name of the view file, ``vars`` is a dictionary of named values passed to the view.</div><div class=""> - ``response.session_file``: file stream containing the session.</div><div class=""> - ``response.session_file_name``: name of the file where the session will be saved.</div><div class=""> - ``response.session_id``: the id of the current session. It is determined automatically. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.session_id_name``: the name of the session cookie for this application. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.static_version``: a version number for the static asset management.  </div><div class=""> Also notice the ``request.env.wsgi_*`` variables. They are specific to the wsgi</div><div class=""> - ``response._caller``: this is a function that wraps all action calls. It defaults to the identity function, but it can be modified in order to catch special types of exception to do extra logging;</div><div class="">   ``</div><div class="">   response._caller = lambda f: f()</div><div class="">   ``</div><div class=""> - ``response.optimize_css``: can be set to &quot;concat,minify,inline&quot; to concatenate, minify and inline the CSS files included by web2py.</div><div class=""> - ``response.optimize_js``: can be set to &quot;concat,minify,inline&quot; to concatenate, minify and inline the JavaScript files included by web2py. </div><div class=""> - ``response.view``: the name of the view template that must render the page. This is set by default to:</div><div class="">   ``</div><div class="">   &quot;%s/%s.%s&quot; % (request.controller, request.function, request.extension)</div><div class="">   ``:code</div><div class="">   or, if the above file cannot be located, to</div><div class="">   ``</div><div class="">   &quot;generic.%s&quot; % (request.extension)</div><div class="">   ``:code</div><div class="">   Change the value of this variable to modify the view file associated with a particular action.</div><div class=""> </div><div class=""> - ``response.delimiters`` defaults to ``(&#x27;{{&#x27;,&#x27;}}&#x27;)``. It allows you to change the delimiter of code embedded in views.</div><div class=""> - ``response.xmlrpc(request, methods)``: when a controller returns it, this function exposes the methods via XML-RPC``xmlrpc``:cite . This function is deprecated since a better mechanism is available and described in Chapter 10.</div><div class=""> - ``response.write(text)``: a method to write text into the output page body.</div><div class=""> - ``response.js`` can contain Javascript code. This code will be executed if and only if the response is received by a web2py component as discussed in Chapter 12.</div><div class=""> </div><div class=""> Since ``response`` is a ``gluon.storage.Storage`` object, it can be used to store other attributes that you may want to pass to the view. While there is no technical restriction, our recommendation is to store only variables that are to be rendered by all pages in the overall layout (&quot;layout.html&quot;).</div><div class=""> </div><div class=""> Anyway, we strongly suggest to stick to the variables listed here:</div><div class=""> ``</div><div class=""> response.title</div><div class=""> response.subtitle</div><div class=""> response.flash</div><div class=""> response.menu</div><div class=""> response.meta.author</div><div class=""> response.meta.description</div><div class=""> response.meta.keywords</div><div class=""> response.meta.*</div><div class=""> ``:code</div><div class=""> </div><div class=""> because this will make it easier for you to replace the standard &quot;layout.html&quot; file that comes with web2py with another layout file, one that uses the same set of variables.</div><div class=""> </div><div class=""> Old versions of web2py used ``response.author`` instead of ``response.meta.author`` and similar for the other meta attributes.</div><div class=""> </div><div class=""> ### ``session``</div><div class=""> redirect(&#x27;http://www.web2py.com&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> is simply a shortcut for:</div><div class=""> ``</div><div class=""> raise HTTP(303,</div><div class="">            &#x27;You are being redirected &lt;a href=&quot;%s&quot;&gt;here&lt;/a&gt;&#x27; % location,</div><div class="">            Location=&#x27;http://www.web2py.com&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The named arguments of the ``HTTP`` initializer method are translated into HTTP header directives, in this case, the redirection target location. ``redirect`` takes an optional second argument, which is the HTTP status code for the redirection (303 by default). Change this number to 307 for a temporary redirect or to 301 for a permanent redirect.</div><div class=""> </div><div class=""> The most common way to use redirect is to redirect to other pages in the same app and (optionally) pass parameters:</div><div class=""> </div><div class=""> ``</div><div class=""> redirect(URL(&#x27;index&#x27;, args=(1,2,3), vars=dict(a=&#x27;b&#x27;)))</div><div class=""> ``:code</div><div class=""> </div><div class=""> In chapter 12 we discuss web2py components. They make Ajax requests to web2py actions. If the called action performs a redirect, you may want the Ajax request to follow the redirect or you may want the entire page performing the Ajax request redirecting. In this latter case you can set:</div><div class=""> </div><div class=""> ``</div><div class="delete">redirect(...,<span class="highlight"></span>t<span class="highlight">yp</span>e=<span class="highlight">&#x27;a</span>u<span class="highlight">to&#x27;</span>)</div><div class=""> ``:code</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/802723ff8451a432d95b98f05c0a56da45001f8d">802723f</a><ul><li>Date : 2013-06-05</li><li>Correction from J2EE to Java EE (old name)</li></ul></li></ul>
<div class="row-fluid" id="com_802723ff8451a432d95b98f05c0a56da45001f8d">
    <div class="span6"><div class="diff"><div class=""> -------</div><div class="insert">web2py normally runs with CPython (the C implementation of the Python interpreter created by Guido van Rossum), but it can also run with PyPy and Jython. The latter possibility allows the use of web2py in the context of a J<span class="highlight">ava </span>EE infrastructure. To use Jython, simply replace &quot;python web2py.py ...&quot; with &quot;jython web2py.py&quot;. Details about installing Jython, zxJDBC modules required to access the databases can be found in Chapter 14.</div><div class=""> -------</div></div></div>
    <div class="span6"><div class="diff"><div class=""> -------</div><div class="delete">web2py normally runs with CPython (the C implementation of the Python interpreter created by Guido van Rossum), but it can also run with PyPy and Jython. The latter possibility allows the use of web2py in the context of a J<span class="highlight">2</span>EE infrastructure. To use Jython, simply replace &quot;python web2py.py ...&quot; with &quot;jython web2py.py&quot;. Details about installing Jython, zxJDBC modules required to access the databases can be found in Chapter 14.</div><div class=""> -------</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/4e43f1ee097323aee901582c509b6b1e9b6b7b83">4e43f1e</a><ul><li>Date : 2013-06-01</li><li>typo in static asset management patch, thanks Niphlod</li></ul></li></ul>
<div class="row-fluid" id="com_4e43f1ee097323aee901582c509b6b1e9b6b7b83">
    <div class="span6"><div class="diff"><div class=""> For example, in Apache, change this:</div><div class=""> ``</div><div class=""> AliasMatch ^/([^/]+)/static/(.*) \</div><div class="">    /home/www-data/web2py/applications/$1/static/$2</div><div class=""> ``</div><div class=""> into this:</div><div class=""> ``</div><div class="insert">AliasMatch ^/([^/]+)/static/(?:<span class="highlight"></span>_[\d]+<span class="highlight"></span>.[\d]+<span class="highlight"></span>.[\d]+<span class="highlight">/</span>)?(.*) \</div><div class="">    /home/www-data/web2py/applications/$1/static/$2</div><div class=""> ``</div></div></div>
    <div class="span6"><div class="diff"><div class=""> For example, in Apache, change this:</div><div class=""> ``</div><div class=""> AliasMatch ^/([^/]+)/static/(.*) \</div><div class="">    /home/www-data/web2py/applications/$1/static/$2</div><div class=""> ``</div><div class=""> into this:</div><div class=""> ``</div><div class="delete">AliasMatch ^/([^/]+)/static/(?:<span class="highlight">/</span>_[\d]+<span class="highlight">\</span>.[\d]+<span class="highlight">\</span>.[\d]+<span class="highlight"></span>)?(.*) \</div><div class="">    /home/www-data/web2py/applications/$1/static/$2</div><div class=""> ``</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/4fcf1d55fe17816a80e49e93dcac144fd7c115cf">4fcf1d5</a><ul><li>Date : 2013-05-08</li><li>cache.action, thanks Niphlod</li></ul></li></ul>
<div class="row-fluid" id="com_4fcf1d55fe17816a80e49e93dcac144fd7c115cf">
    <div class="span6"><div class="diff"><div class=""> ``cache view``:inxx</div><div class=""> ``</div><div class=""> @cache(request.env.path_info, time_expire=5, cache_model=cache.ram)</div><div class=""> def cache_controller_and_view():</div><div class="">     import time</div><div class="">     t = time.ctime()</div><div class="">     d = dict(time=t, link=A(&#x27;click to reload&#x27;, _href=request.url))</div><div class="">     return response.render(d)</div><div class=""> ``:code</div><div class=""> ``response.render(d)`` returns the rendered view as a string, which is now cached for 5 seconds. This is the best and fastest way of caching.</div><div class=""> ------</div><div class="insert">We recommend to use @cache.<span class="highlight">a</span>c<span class="highlight">t</span>i<span class="highlight">o</span>n<span class="highlight"></span> starting from web2py <span class="highlight">&gt; </span>2.4.<span class="highlight">6</span> </div><div class=""> ------</div><div class=""> </div><div class=""> Note, ``time_expire`` is used to compare the current time with the time the requested object was last saved in the cache. It does not affect future requests. This enables ``time_expire`` to be set dynamically when an object is requested rather than being fixed when the object is saved. For example:</div><div class=""> ``</div><div class=""> message = cache.ram(&#x27;message&#x27;, lambda: &#x27;Hello&#x27;, time_expire=5)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Now, suppose the following call is made 10 seconds after the above call:</div><div class=""> ``</div><div class=""> message = cache.ram(&#x27;message&#x27;, lambda: &#x27;Goodbye&#x27;, time_expire=20)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Because ``time_expire`` is set to 20 seconds in the second call and only 10 seconds has elapsed since the message was first saved, the value &quot;Hello&quot; will be retrieved from the cache, and it will not be updated with &quot;Goodbye&quot;. The ``time_expire`` value of 5 seconds in the first call has no impact on the second call.</div><div class=""> </div><div class=""> Setting ``time_expire=0`` (or a negative value) forces the cached item to be refreshed (because the elapsed time since the last save will always be &gt; 0), and setting ``time_expire=None`` forces retrieval of the cached value, regardless of the time elapsed since it was saved (if ``time_expire`` is always ``None``, the cached item will effectively never expire).</div><div class=""> </div><div class=""> You can clear one or more cache variables with</div><div class=""> ``cache clear``:inxx</div><div class=""> </div><div class=""> ``</div><div class=""> cache.ram.clear(regex=&#x27;...&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> where ``regex`` is a regular expression matching all the keys you want removed from the cache. You can also clear a single item with:</div><div class=""> ``</div><div class=""> cache.ram(key, None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> where ``key`` is the key of the cached item.</div><div class=""> </div><div class=""> It is also possible to define other caching mechanisms such as memcache. Memcache is available via ``gluon.contrib.memcache`` and is discussed in more detail in Chapter 14.</div><div class=""> </div><div class=""> ------</div><div class=""> Be careful when caching to remeber that caching is usually at the app-level not at the user level. If you need, for example, to cache user specific content, choose a key that includes the user id.</div><div class=""> ------</div><div class=""> </div><div class="insert">#### ``cache.<span class="highlight">a</span>c<span class="highlight">t</span>i<span class="highlight">o</span>n<span class="highlight"></span>``</div><div class=""> Web2py by default assumes that the returned content is not going to be cached, as this reduces the shortcomings of an improper caching of the page client-side.</div><div class=""> </div><div class=""> For example, when you show a form to the user, or a list of records, the web page should not be cached, as other users may have inserted new records on the table you are showing.</div><div class=""> </div><div class=""> Instead, if you are showing to the user a wiki page whose content will never change (or it changes once a week), it is useful to store that page, but it is even more useful </div><div class=""> to tell the client that that page is not going to change.</div><div class=""> </div><div class=""> This is accomplished sending out some specific headers along with the page: when the client&#x27;s browser receives the content, it is stored in the browser&#x27;s cache and it will not be requested again</div><div class=""> to your site. Of course this is a **major** speedup for public-facing sites.</div><div class=""> </div><div class="insert">+Web2py &gt; 2.4.6 introduced a new ``cache.action`` decorator to allow a smarter handling of this situation.</div><div class="insert">+``cache.action`` can be used:</div><div class=""> - for setting smart cache headers</div><div class=""> - to cache the results accordingly</div><div class=""> ------</div><div class=""> NB: it will do one or another or **both**.</div><div class=""> ------</div><div class=""> The main problem with caching a view with ``@cache(request.env.path_info, time_expire=300, cache_model=cache.ram)`` is that request.env.path_info as a key leads to several problems, e.g.</div><div class=""> + URL vars are not considered</div><div class="">   -- you cached the result of &#x27;&#x27;/app/default/index?**search=foo**&#x27;&#x27; : for the next 300 seconds &#x27;&#x27;/app/default/index?**search=bar**&#x27;&#x27; will return the exact same thing of &#x27;&#x27;/app/default/index?**search=foo**&#x27;&#x27;</div><div class=""> + User is not considered</div><div class="">   -- you user accesses often a page and you choose to cache it. </div><div class="">      However, you cached the result of &#x27;&#x27;/app/default/index&#x27;&#x27; using request.env.path_info as the key, so another user</div><div class="">      will see a page that was not meant for him</div><div class="">   -- you cached a page for &quot;Bill&quot;, but &quot;Bill&quot; accessed the page from the desktop. Now he tries to access it from its phone: if you prepared a template </div><div class="">      for mobile users that is different from the standard one, &quot;Joe&quot; will not see it</div><div class=""> + Language is not considered</div><div class="">   -- when you cache the page, if you use T() for some elements, the page will be stored with a fixed translation</div><div class=""> + Method is not considered</div><div class="">   -- When you cache a page, you should only cache it if it&#x27;s a result of a GET operation</div><div class=""> + Status code is not considered</div><div class="">   -- When you cached the page for the first time, something went wrong and you returned a nice 404 page.</div><div class="">      You don&#x27;t want to cache errors ^_^</div><div class=""> </div><div class="insert">Instead of letting users write a lot of boilerplate code to take care of all those problems, ``cache.<span class="highlight">a</span>c<span class="highlight">t</span>i<span class="highlight">o</span>n<span class="highlight"></span>`` was created.</div><div class=""> It will by default use smart cache headers to let the browser cache the result: if you pass a cache model to it, it will also figure out the best key automatically, </div><div class=""> so different versions of the same page can be stored and retrieved accordingly (e.g. one for English users and one for Spanish ones)</div><div class=""> </div><div class=""> It takes several parameters, with smart defaults:</div><div class=""> </div><div class=""> - time_expire : the usual, defaults to 300 seconds</div><div class="insert">- cache_model : by default is None. This means that @cache.<span class="highlight">a</span>c<span class="highlight">t</span>i<span class="highlight">o</span>n<span class="highlight"></span> will **only** alter the default headers to let the client&#x27;s browser cache the content</div><div class="">     -- if you pass, e.g., ``cache.ram``, the result will be stored in the cache as well</div><div class=""> - prefix : if you want to prefix the auto-generated key (useful for clearing it later with, e.g. ``cache.ram.clear(prefix*)``)</div><div class=""> - session : if you want to consider the session, defaults to False</div><div class=""> - vars : if you want to consider URL vars, defaults to True</div><div class=""> - lang : if you want to consider the language, defaults to True</div><div class=""> - user_agent : if you want to consider the user agent, defaults to False</div><div class=""> - public : if you want the same page for all the users that will ever access it, defaults to True</div><div class=""> - valid_statuses : defaults to None. cache.client will cache only pages requested with a GET method, whose status codes begin with 1,2 or 3. </div><div class="">   You can pass a list of status codes (when you want pages to be cached with those statuses, e.g. status_codes=[200] will cache only pages</div><div class="">   that resulted in a 200 status code) </div><div class=""> - quick : defaults to None, but you can pass a list of initials to set a particular feature:</div><div class="">   -- **S**ession, **V**ars, **L**ang, **U**ser_agent, **P**ublic</div><div class="insert">+     e.g. ``@cache.action(time_expire=300, cache_model=cache.ram, quick=&#x27;SVP&#x27;)`` is the same as</div><div class="insert">+     ``@cache.action(time_expire=300, cache_model=cache.ram, session=True, vars=True, public=True)``</div></div></div>
    <div class="span6"><div class="diff"><div class=""> ``cache view``:inxx</div><div class=""> ``</div><div class=""> @cache(request.env.path_info, time_expire=5, cache_model=cache.ram)</div><div class=""> def cache_controller_and_view():</div><div class="">     import time</div><div class="">     t = time.ctime()</div><div class="">     d = dict(time=t, link=A(&#x27;click to reload&#x27;, _href=request.url))</div><div class="">     return response.render(d)</div><div class=""> ``:code</div><div class=""> ``response.render(d)`` returns the rendered view as a string, which is now cached for 5 seconds. This is the best and fastest way of caching.</div><div class=""> ------</div><div class="delete">We recommend to use @cache.<span class="highlight"></span>c<span class="highlight">l</span>i<span class="highlight">e</span>n<span class="highlight">t</span> starting from web2py <span class="highlight"></span>2.4.<span class="highlight">4</span> </div><div class=""> ------</div><div class=""> </div><div class=""> Note, ``time_expire`` is used to compare the current time with the time the requested object was last saved in the cache. It does not affect future requests. This enables ``time_expire`` to be set dynamically when an object is requested rather than being fixed when the object is saved. For example:</div><div class=""> ``</div><div class=""> message = cache.ram(&#x27;message&#x27;, lambda: &#x27;Hello&#x27;, time_expire=5)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Now, suppose the following call is made 10 seconds after the above call:</div><div class=""> ``</div><div class=""> message = cache.ram(&#x27;message&#x27;, lambda: &#x27;Goodbye&#x27;, time_expire=20)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Because ``time_expire`` is set to 20 seconds in the second call and only 10 seconds has elapsed since the message was first saved, the value &quot;Hello&quot; will be retrieved from the cache, and it will not be updated with &quot;Goodbye&quot;. The ``time_expire`` value of 5 seconds in the first call has no impact on the second call.</div><div class=""> </div><div class=""> Setting ``time_expire=0`` (or a negative value) forces the cached item to be refreshed (because the elapsed time since the last save will always be &gt; 0), and setting ``time_expire=None`` forces retrieval of the cached value, regardless of the time elapsed since it was saved (if ``time_expire`` is always ``None``, the cached item will effectively never expire).</div><div class=""> </div><div class=""> You can clear one or more cache variables with</div><div class=""> ``cache clear``:inxx</div><div class=""> </div><div class=""> ``</div><div class=""> cache.ram.clear(regex=&#x27;...&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> where ``regex`` is a regular expression matching all the keys you want removed from the cache. You can also clear a single item with:</div><div class=""> ``</div><div class=""> cache.ram(key, None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> where ``key`` is the key of the cached item.</div><div class=""> </div><div class=""> It is also possible to define other caching mechanisms such as memcache. Memcache is available via ``gluon.contrib.memcache`` and is discussed in more detail in Chapter 14.</div><div class=""> </div><div class=""> ------</div><div class=""> Be careful when caching to remeber that caching is usually at the app-level not at the user level. If you need, for example, to cache user specific content, choose a key that includes the user id.</div><div class=""> ------</div><div class=""> </div><div class="delete">#### ``cache.<span class="highlight"></span>c<span class="highlight">l</span>i<span class="highlight">e</span>n<span class="highlight">t</span>``</div><div class=""> Web2py by default assumes that the returned content is not going to be cached, as this reduces the shortcomings of an improper caching of the page client-side.</div><div class=""> </div><div class=""> For example, when you show a form to the user, or a list of records, the web page should not be cached, as other users may have inserted new records on the table you are showing.</div><div class=""> </div><div class=""> Instead, if you are showing to the user a wiki page whose content will never change (or it changes once a week), it is useful to store that page, but it is even more useful </div><div class=""> to tell the client that that page is not going to change.</div><div class=""> </div><div class=""> This is accomplished sending out some specific headers along with the page: when the client&#x27;s browser receives the content, it is stored in the browser&#x27;s cache and it will not be requested again</div><div class=""> to your site. Of course this is a **major** speedup for public-facing sites.</div><div class=""> </div><div class="delete">-Web2py 2.4.4 introduced a new ``cache.client`` decorator to allow a smarter handling of this situation.</div><div class="delete">-``cache.client`` can be used:</div><div class=""> - for setting smart cache headers</div><div class=""> - to cache the results accordingly</div><div class=""> ------</div><div class=""> NB: it will do one or another or **both**.</div><div class=""> ------</div><div class=""> The main problem with caching a view with ``@cache(request.env.path_info, time_expire=300, cache_model=cache.ram)`` is that request.env.path_info as a key leads to several problems, e.g.</div><div class=""> + URL vars are not considered</div><div class="">   -- you cached the result of &#x27;&#x27;/app/default/index?**search=foo**&#x27;&#x27; : for the next 300 seconds &#x27;&#x27;/app/default/index?**search=bar**&#x27;&#x27; will return the exact same thing of &#x27;&#x27;/app/default/index?**search=foo**&#x27;&#x27;</div><div class=""> + User is not considered</div><div class="">   -- you user accesses often a page and you choose to cache it. </div><div class="">      However, you cached the result of &#x27;&#x27;/app/default/index&#x27;&#x27; using request.env.path_info as the key, so another user</div><div class="">      will see a page that was not meant for him</div><div class="">   -- you cached a page for &quot;Bill&quot;, but &quot;Bill&quot; accessed the page from the desktop. Now he tries to access it from its phone: if you prepared a template </div><div class="">      for mobile users that is different from the standard one, &quot;Joe&quot; will not see it</div><div class=""> + Language is not considered</div><div class="">   -- when you cache the page, if you use T() for some elements, the page will be stored with a fixed translation</div><div class=""> + Method is not considered</div><div class="">   -- When you cache a page, you should only cache it if it&#x27;s a result of a GET operation</div><div class=""> + Status code is not considered</div><div class="">   -- When you cached the page for the first time, something went wrong and you returned a nice 404 page.</div><div class="">      You don&#x27;t want to cache errors ^_^</div><div class=""> </div><div class="delete">Instead of letting users write a lot of boilerplate code to take care of all those problems, ``cache.<span class="highlight"></span>c<span class="highlight">l</span>i<span class="highlight">e</span>n<span class="highlight">t</span>`` was created.</div><div class=""> It will by default use smart cache headers to let the browser cache the result: if you pass a cache model to it, it will also figure out the best key automatically, </div><div class=""> so different versions of the same page can be stored and retrieved accordingly (e.g. one for English users and one for Spanish ones)</div><div class=""> </div><div class=""> It takes several parameters, with smart defaults:</div><div class=""> </div><div class=""> - time_expire : the usual, defaults to 300 seconds</div><div class="delete">- cache_model : by default is None. This means that @cache.<span class="highlight"></span>c<span class="highlight">l</span>i<span class="highlight">e</span>n<span class="highlight">t</span> will **only** alter the default headers to let the client&#x27;s browser cache the content</div><div class="">     -- if you pass, e.g., ``cache.ram``, the result will be stored in the cache as well</div><div class=""> - prefix : if you want to prefix the auto-generated key (useful for clearing it later with, e.g. ``cache.ram.clear(prefix*)``)</div><div class=""> - session : if you want to consider the session, defaults to False</div><div class=""> - vars : if you want to consider URL vars, defaults to True</div><div class=""> - lang : if you want to consider the language, defaults to True</div><div class=""> - user_agent : if you want to consider the user agent, defaults to False</div><div class=""> - public : if you want the same page for all the users that will ever access it, defaults to True</div><div class=""> - valid_statuses : defaults to None. cache.client will cache only pages requested with a GET method, whose status codes begin with 1,2 or 3. </div><div class="">   You can pass a list of status codes (when you want pages to be cached with those statuses, e.g. status_codes=[200] will cache only pages</div><div class="">   that resulted in a 200 status code) </div><div class=""> - quick : defaults to None, but you can pass a list of initials to set a particular feature:</div><div class="">   -- **S**ession, **V**ars, **L**ang, **U**ser_agent, **P**ublic</div><div class="delete">-     e.g. ``@cache.client(time_expire=300, cache_model=cache.ram, quick=&#x27;SVP&#x27;)`` is the same as</div><div class="delete">-     ``@cache.client(time_expire=300, cache_model=cache.ram, session=True, vars=True, public=True)``</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/a033f046abd2da8faff5435de84a8262bb1614cf">a033f04</a><ul><li>Date : 2013-05-07</li><li>minor typo fixes</li></ul></li></ul>
<div class="row-fluid" id="com_a033f046abd2da8faff5435de84a8262bb1614cf">
    <div class="span6"><div class="diff"><div class="insert">if you run web2py as <span class="highlight">a </span>Windows Service, ``-W``,  it is not convenient to pass the configuration using command line arguments. For this reason, in the web2py folder there is a sample &quot;options_std.py&quot; configuration file for the internal web server:</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">if you run web2py as <span class="highlight"></span>Windows Service, ``-W``,  it is not convenient to pass the configuration using command line arguments. For this reason, in the web2py folder there is a sample &quot;options_std.py&quot; configuration file for the internal web server:</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/b66c174b3bd1d8e256081f1ec22e82e5a6edd034">b66c174</a><ul><li>Date : 2013-04-13</li><li>fix typo in 4.9.1 Separate Sessions</li></ul></li></ul>
<div class="row-fluid" id="com_b66c174b3bd1d8e256081f1ec22e82e5a6edd034">
    <div class="span6"><div class="diff"><div class="insert">If you are storing sessions on <span class="highlight"></span>the filesystem and you have lots of them, the file system access may become a bottle-neck. One solution is the following:</div><div class=""> ``</div><div class=""> session.connect(request, response, separate=True)</div><div class=""> ``:code</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">If you are storing sessions on <span class="highlight"> system access may become a bottle-neck. One solution is the following</span>the filesystem and you have lots of them, the file system access may become a bottle-neck. One solution is the following:</div><div class=""> ``</div><div class=""> session.connect(request, response, separate=True)</div><div class=""> ``:code</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/d1c83adb22e40cb10cd137a599552a8f91d00785">d1c83ad</a><ul><li>Date : 2013-04-06</li><li>manual merge of <a href="https://github.com/mdipierro/web2py-book/pull/52">https://github.com/mdipierro/web2py-book/pull/52</a>, thanks krmr</li></ul></li></ul>
<div class="row-fluid" id="com_d1c83adb22e40cb10cd137a599552a8f91d00785">
    <div class="span6"><div class="diff"><div class=""> ### ``response``</div><div class=""> ``response``:inxx</div><div class=""> ``response.body``:inxx</div><div class=""> ``response.cookies``:inxx</div><div class=""> ``response.download``:inxx</div><div class=""> ``response.files``:inxx</div><div class=""> ``response.flash``:inxx</div><div class=""> ``response.headers``:inxx</div><div class=""> ``response.meta``:inxx</div><div class=""> ``response.menu``:inxx</div><div class=""> ``response.postprocessing``:inxx</div><div class=""> ``response.render``:inxx</div><div class="insert">+``response.static_version``:inxx</div><div class=""> ``response.status``:inxx</div><div class=""> ``response.stream``:inxx</div><div class=""> ``response.subtitle``:inxx</div><div class=""> ``response.title``:inxx</div><div class=""> ``response.toolbar``:inxx</div><div class=""> ``response.view``:inxx</div><div class=""> ``response.delimiters``:inxx</div><div class=""> ``response.js``:inxx</div><div class=""> ``response.write``:inxx</div><div class=""> ``response.include_files``:inxx</div><div class=""> ``response.include_meta``:inxx</div><div class=""> ``response.optimize_css``:inxx</div><div class=""> ``response.optimize_js``:inxx</div><div class=""> ``response._caller``:inxx</div><div class=""> </div><div class=""> ``response`` is another instance of the ``Storage`` class. It contains the following:</div><div class=""> </div><div class=""> - ``response.body``: a ``StringIO`` object into which web2py writes the output page body. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.cookies``: similar to ``request.cookies``, but while the latter contains the cookies sent from the client to the server, the former contains cookies sent by the server to the client. The session cookie is handled automatically.</div><div class=""> - ``response.download(request, db)``: a method used to implement the controller function that allows downloading of uploaded files. ``request.download`` expects the last ``arg`` in ``request.args`` to be the encoded filename (i.e., the filename generated at upload time and stored in the upload field). It extracts the upload field name and table name as well as the original filename from the encoded filename. ``response.download`` takes two optional arguments: ``chunk_size`` sets the size in bytes for chunked streaming (defaults to 64K), and ``attachments`` determines whether the downloaded file should be treated as an attachment or not (default to ``True``). Note, ``response.download`` is specifically for downloading files associated with ``db`` upload fields. Use ``response.stream`` (see below) for other types of file downloads and streaming. Also, note that it is not necessary to use ``response.download`` to access files uploaded to the /static folder -- static files can (and generally should) be accessed directly via URL (e.g., /app/static/files/myfile.pdf).</div><div class="insert">- ``response.files``: a list of ``.css``, ``.js``, ``<span class="highlight">.</span>coffee``, and ``.less`` files required by the page. They will automatically be linked in the head of the standard &quot;layout.html&quot; via the included &quot;web2py_ajax.html&quot;. To include a new CSS, JS, COFFEE, or LESS file, just append it to this list. It will handle duplicates. The order is important.</div><div class=""> - ``response.include_files()`` generates html head tags to include all ``response.files`` (used in &quot;views/web2py_ajax.html&quot;).</div><div class=""> - ``response.flash``: optional parameter that may be included in the views. Normally used to notify the user about something that happened.</div><div class="insert">- ``response.headers``: a ``dict`` for HTTP response headers. Web2py sets some headers by default, including &quot;Content-Length&quot;, &quot;Content-Type&quot;, and &quot;X-Powered-By&quot; (set equal to web2py). Web2py also sets the &quot;Cache-Control&quot;, &quot;Expires&quot;, and &quot;Pragma&quot; headers to prevent client-side caching, except for static file requests, for which client-side caching is enabled. The headers that web2py sets can be overwritten or removed, and new headers can be added (e.g., ``response.headers[&#x27;Cache-Control&#x27;] = &#x27;private&#x27;``). You can remove a header by removing its key from the response.headers dict, e.g.<span class="highlight"> </span>``del response.headers[&#x27;Custom-Header&#x27;]``, however web2py&#x27;s default headers will be re-added just before returning the response. To avoid this behavior, just set the header value to None, e.g. to remove the default Content-Type header, ``response.headers[&#x27;Content-Type&#x27;] = None``</div><div class=""> - ``response.menu``: optional parameter that may be included in the views, normally used to pass a navigation menu tree to the view. It can be rendered by the MENU helper.</div><div class=""> - ``response.meta``: a Storage object that contains optional ``&lt;meta&gt;`` information like ``response.meta.author``, ``.description``, and/or ``.keywords``. The content of each meta variable is automatically placed in the proper ``META`` tag by the code in &quot;views/web2py_ajax.html&quot;, which is included by default in &quot;views/layout.html&quot;.</div><div class=""> - ``response.include_meta()`` generates a string that includes all ``response.meta`` headers serialized (used in &quot;views/web2py_ajax.html&quot;).</div><div class=""> - ``response.postprocessing``: this is a list of functions, empty by default. These functions are used to filter the response object at the output of an action, before the output is rendered by the view. It can be used to implement support for other template languages.</div><div class=""> - ``response.render(view, vars)``: a method used to call the view explicitly inside the controller. ``view`` is an optional parameter which is the name of the view file, ``vars`` is a dictionary of named values passed to the view.</div><div class=""> - ``response.session_file``: file stream containing the session.</div><div class=""> - ``response.session_file_name``: name of the file where the session will be saved.</div><div class=""> - ``response.session_id``: the id of the current session. It is determined automatically. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.session_id_name``: the name of the session cookie for this application. NEVER CHANGE THIS VARIABLE.</div><div class="insert">+- ``response.static_version``: a version number for the static asset management.  </div><div class=""> - ``response.status``: the HTTP status code integer to be passed to the response. Default is 200 (OK).</div><div class=""> - ``response.stream(file, chunk_size, request=request, attachment=False, filename=None, headers=None)``: when a controller returns it, web2py streams the file content back to the client in blocks of size ``chunk_size``. The ``request`` parameter is required to use the chunk start in the HTTP header. ``file`` should be a file path (for backward compatibility, it can also be an open file object, but this is not recommended). As noted above, ``response.download`` should be used to retrieve files stored via an upload field. ``response.stream`` can be used in other cases, such as returning a temporary file or StringIO object created by the controller. If ``attachment`` is True, the Content-Disposition header will be set to &quot;attachment&quot;, and if ``filename`` is also provided, it will be added to the Content-Disposition header as well (but only when ``attachment`` is True). If not already included in ``response.headers``, the following response headers will be set automatically: Content-Type, Content-Length, Cache-Control, Pragma, and Last-Modified (the latter three are set to allow browser caching of the file). To override any of these automatic header settings, simply set them in ``response.headers`` before calling ``response.stream``.</div><div class=""> - ``response.subtitle``: optional parameter that may be included in the views. It should contain the subtitle of the page.</div><div class=""> - ``response.title``: optional parameter that may be included in the views. It should contain the title of the page and should be rendered inside the html title tag in the header.</div><div class=""> - ``response.toolbar``: a function that allows you to embed a toolbar into page for debugging purposes ``{{=response.toolbar()}}``. The toolbar displays request, response, session variables and database access time for each query.</div><div class=""> - ``response._vars``: this variable is accessible only in a view, not in the action. It contains the values returned by the action to the view.</div><div class=""> - ``response._caller``: this is a function that wraps all action calls. It defaults to the identity function, but it can be modified in order to catch special types of exception to do extra logging;</div><div class="">   ``</div><div class="">   response._caller = lambda f: f()</div><div class="">   ``</div><div class="insert">+- ``response.optimize_css``: can be set to &quot;concat,minify,inline&quot; to concatenate, minify and inline the CSS files included by web2py.</div><div class="insert">+- ``response.optimize_js``: can be set to &quot;concat,minify,inline&quot; to concatenate, minify and inline the JavaScript files included by web2py. </div><div class=""> - ``response.view``: the name of the view template that must render the page. This is set by default to:</div><div class="">   ``</div><div class="">   &quot;%s/%s.%s&quot; % (request.controller, request.function, request.extension)</div><div class="">   ``:code</div><div class="">   or, if the above file cannot be located, to</div><div class="">   ``</div><div class="">   &quot;generic.%s&quot; % (request.extension)</div><div class="">   ``:code</div><div class="">   Change the value of this variable to modify the view file associated with a particular action.</div><div class=""> </div><div class=""> - ``response.delimiters`` defaults to ``(&#x27;{{&#x27;,&#x27;}}&#x27;)``. It allows you to change the delimiter of code embedded in views.</div><div class=""> - ``response.xmlrpc(request, methods)``: when a controller returns it, this function exposes the methods via XML-RPC``xmlrpc``:cite . This function is deprecated since a better mechanism is available and described in Chapter 10.</div><div class=""> - ``response.write(text)``: a method to write text into the output page body.</div><div class=""> - ``response.js`` can contain Javascript code. This code will be executed if and only if the response is received by a web2py component as discussed in Chapter 12.</div><div class=""> </div><div class=""> Since ``response`` is a ``gluon.storage.Storage`` object, it can be used to store other attributes that you may want to pass to the view. While there is no technical restriction, our recommendation is to store only variables that are to be rendered by all pages in the overall layout (&quot;layout.html&quot;).</div><div class=""> </div><div class=""> Anyway, we strongly suggest to stick to the variables listed here:</div><div class=""> ``</div><div class=""> response.title</div><div class=""> To **store sessions in cookies** instead you can do:</div><div class=""> ``</div><div class=""> session.connect(request,response,cookie_key=&#x27;yoursecret&#x27;,compression_level=None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Here ``cookie_key`` is a symmetric encryption key.</div><div class=""> ``compression_level`` is an optional ``zlib`` encryption level.</div><div class=""> </div><div class=""> While sessions in cookie are often recommended for scalability reason they are limited in size. Large sessions will result in broken cookies.</div><div class=""> </div><div class=""> You can check the state of your application at any time by printing the ``request``, ``session`` and ``response`` system variables. One way to do it is to create a dedicated action:</div><div class=""> ``</div><div class=""> def status():</div><div class="">     return dict(request=request, session=session, response=response)</div><div class=""> ``:code</div><div class=""> </div><div class=""> In the &quot;generic.html&quot; view this is done using ``{{=response.toolbar()}}``.</div><div class=""> </div><div class=""> </div><div class=""> #### Separate sessions</div><div class=""> </div><div class="insert">If you are storing sessions on <span class="highlight"></span> system access may become a bottle-neck. One solution is the following<span class="highlight">the filesystem and you have lots of them, the file system access may become a bottle-neck. One solution is the following</span>:</div><div class=""> ``</div><div class=""> session.connect(request, response, separate=True)</div><div class=""> ``:code</div><div class=""> </div><div class=""> By setting ``separate=True`` web2py will store sessions not in the &quot;sessions/&quot; folder but in subfolders of the &quot;sessions/&quot; folder. The subfolder will be created automatically. Sessions with the same prefix will be in the same subfolder. Again, note that the above must be called before any logic that might require the session.</div><div class=""> </div><div class=""> ### ``cache``</div><div class=""> ``cache``:inxx ``cache.ram``:inxx ``cache.disk``:inxx</div><div class=""> ``cache`` a global object also available in the web2py execution environment. It has two attributes:</div><div class=""> - ``cache.ram``: the application cache in main memory.</div><div class=""> - ``cache.disk``: the application cache on disk.</div><div class=""> ``cache`` is callable, this allows it to be used as a decorator for caching actions and views.</div><div class=""> </div><div class=""> The following example caches the ``time.ctime()`` function in RAM:</div><div class=""> ``</div><div class=""> def cache_in_ram():</div><div class="">     import time</div><div class="">     t = cache.ram(&#x27;time&#x27;, lambda: time.ctime(), time_expire=5)</div><div class="">     return dict(time=t, link=A(&#x27;click me&#x27;, _href=request.url))</div><div class=""> ``:code</div><div class=""> The ``args`` attributes are automatically parsed, decoded, and finally stored in</div><div class=""> If args contains only one element, there is no need to pass it in a list.</div><div class=""> </div><div class=""> You can also use the ``URL`` function to generate URLs to actions in other controllers and other applications:</div><div class=""> </div><div class=""> ``</div><div class=""> URL(&#x27;a&#x27;, &#x27;c&#x27;, &#x27;f&#x27;, args=[&#x27;x&#x27;, &#x27;y&#x27;], vars=dict(z=&#x27;t&#x27;))</div><div class=""> ``:code</div><div class=""> </div><div class=""> is mapped into</div><div class=""> </div><div class=""> ``</div><div class=""> /a/c/f/x/y?z=t</div><div class=""> ``</div><div class=""> </div><div class=""> It is also possible to specify application, controller and function using named arguments:</div><div class=""> </div><div class=""> ``</div><div class=""> URL(a=&#x27;a&#x27;, c=&#x27;c&#x27;, f=&#x27;f&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class="insert">If the application name <span class="highlight">&#x27;&#x27;</span>a<span class="highlight">&#x27;&#x27;</span> is missing the current app is assumed.</div><div class=""> </div><div class=""> ``</div><div class=""> URL(&#x27;c&#x27;, &#x27;f&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class="insert">If the controller name<span class="highlight"> &#x27;&#x27;c&#x27;&#x27;</span> is missing, the current one is assumed.</div><div class=""> </div><div class=""> ``</div><div class=""> URL(&#x27;f&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Instead of passing the name of a controller function it is also possible to pass the function itself</div><div class=""> </div><div class=""> ``</div><div class=""> URL(f)</div><div class=""> ``:code</div><div class=""> </div><div class=""> For the reasons mentioned above, you should always use the ``URL`` function to generate URLs of static files for your applications. Static files are stored in the application&#x27;s ``static`` subfolder (that&#x27;s where they go when uploaded using the administrative interface). web2py provides a virtual &#x27;static&#x27; controller whose job is to retrieve files from the ``static`` subfolder, determine their content-type, and stream the file to the client. The following example generates the URL for the static file &quot;image.png&quot;:</div><div class=""> </div><div class=""> ``</div><div class=""> URL(&#x27;static&#x27;, &#x27;image.png&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> is mapped into</div><div class=""> </div><div class=""> ``</div><div class=""> where:</div><div class=""> &lt;modifier&gt;::= ! | !! | !!!</div><div class=""> &lt;word&gt; ::= any word or phrase in singular in lower case (!)</div><div class=""> &lt;parameter&gt; ::= [index] | (key) | (number)</div><div class=""> ``</div><div class=""> </div><div class=""> For example:</div><div class=""> </div><div class=""> - ``%%{word}`` is equivalent to ``%%{word[0]}`` (if no modifiers are used).</div><div class=""> - ``%%{word[index]}`` is used when symbols is a tuple. symbols[index] gives us a number used to make a decision on which word form to choose.</div><div class=""> - ``%%{word(key)}`` is used to get the numeric parameter from symbols[key]</div><div class=""> - ``%%{word(number)}`` allows to set a ``number`` directly (e.g.: ``%%{word(%i)}``)</div><div class=""> - ``%%{?word?number}`` returns &quot;word&quot; if ``number==1``, returns the ``number`` otherwise</div><div class=""> - ``%%{?number} or %%{??number}`` returns ``number`` if ``number!=1``, return nothing otherwise</div><div class=""> </div><div class=""> ``T(&quot;blabla %s %%{word}&quot;, symbols=var)``</div><div class=""> </div><div class=""> ``%%{word}`` by default means ``%%{word[0]}``,</div><div class=""> where ``[0]`` is an item index in symbols tuple.</div><div class=""> </div><div class=""> ``T(&quot;blabla %s %s %%{word[1]}&quot;, (var1, var2))``</div><div class="insert">PS is used for &quot;word&quot; and <span class="highlight">&quot;</span>var2<span class="highlight">&quot;</span> respectively.</div><div class=""> </div><div class=""> You can use several ``%%{}`` placeholders with one index:</div><div class=""> </div><div class=""> ``T(&quot;%%{this} %%{is} %s %%{book}&quot;, var)``</div><div class=""> </div><div class=""> or</div><div class=""> </div><div class=""> ``T(&quot;%%{this[0]} %%{is[0]} %s %%{book[0]}&quot;, var)``</div><div class=""> </div><div class=""> They generate:</div><div class=""> </div><div class=""> ``</div><div class=""> var  output</div><div class=""> ------------------</div><div class="">  1   this is 1 book</div><div class="">  2   these are 2 books</div><div class="">  3   these are 2 books</div><div class=""> ``</div><div class=""> </div><div class=""> Similarly you can pass a dictionary to symbols:</div><div class=""> does the exact same thing as</div><div class=""> scheduler.queue_task(&#x27;demo1&#x27;, pvars={&#x27;a&#x27;:1, &#x27;b&#x27;:2})</div><div class=""> ``:code</div><div class=""> </div><div class=""> as</div><div class=""> </div><div class=""> ``</div><div class=""> st.validate_and_insert(function_name=&#x27;demo1&#x27;, args=json.dumps([1,2]))</div><div class=""> ``:code</div><div class=""> </div><div class=""> and as:</div><div class=""> </div><div class=""> ``</div><div class=""> st.validate_and_insert(function_name=&#x27;demo1&#x27;, vars=json.dumps({&#x27;a&#x27;:1,&#x27;b&#x27;:2}))</div><div class=""> ``:code</div><div class=""> </div><div class=""> Here is a more complex complete example:</div><div class=""> ``</div><div class=""> def task_add(a,b):</div><div class="">     return a+b</div><div class=""> </div><div class="insert">s<span class="highlight"></span>cheduler = Scheduler(db, tasks=dict(demo1=task_add))</div><div class=""> </div><div class=""> scheduler.queue_task(&#x27;demo1&#x27;, pvars=dict(a=1,b=2),</div><div class="">                      repeats = 0, period = 180)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Since version 2.4.1 if you pass an additional parameter ``immediate=True`` it will force the main worker to reassign tasks. Until 2.4.1, the worker checks for new tasks every 5 cycles (so, ``5*heartbeats`` seconds). If you had an app that needed to check frequently for new tasks, to get a &#x27;&#x27;snappy&#x27;&#x27; behaviour you were forced to lower the ``heartbeat`` parameter, putting the db under pressure for no reason. With ``immediate=True`` you can force the check for new tasks: it will happen at most as ``heartbeat`` seconds are passed   </div><div class=""> </div><div class=""> A call to ``scheduler.queue_task`` returns the task ``id`` and ``uuid`` of the task you queued (can be the one you passed or the auto-generated one), and possible ``errors``:</div><div class=""> </div><div class=""> ``</div><div class=""> &lt;Row {&#x27;errors&#x27;: {}, &#x27;id&#x27;: 1, &#x27;uuid&#x27;: &#x27;08e6433a-cf07-4cea-a4cb-01f16ae5f414&#x27;}&gt;</div><div class=""> ``</div><div class="">  </div><div class="insert">If there are errors (usually syntax error<span class="highlight"></span> or input validation errors),</div><div class=""> you get the result of the validation, and id and uuid will be None</div><div class=""> </div><div class=""> ``</div><div class=""> &lt;Row {&#x27;errors&#x27;: {&#x27;period&#x27;: &#x27;enter an integer greater than or equal to 0&#x27;}, &#x27;id&#x27;: None, &#x27;uuid&#x27;: None}&gt;</div><div class=""> ``</div><div class=""> </div><div class=""> ##### Results and output</div><div class=""> </div><div class=""> The table &quot;scheduler_run&quot; stores the status of all running tasks. Each record references a task that has been picked up by a worker.  One task can have multiple runs. For example, a task scheduled to repeat 10 times an hour will probably have 10 runs (unless one fails or they take longer than 1 hour). Beware that if the task has no return values, it is removed from the scheduler_run table as soon as it is finished.</div><div class=""> </div><div class=""> Possible run statuses are:</div><div class=""> </div><div class=""> ``</div><div class=""> RUNNING, COMPLETED, FAILED, TIMEOUT</div><div class=""> ``</div><div class=""> </div><div class=""> If the run is completed, no exceptions are thrown, and there is no task timeout, the run is marked as ``COMPLETED`` and the task is marked as ``QUEUED`` or ``COMPLETED`` depending on whether it is supposed to run again at a later time. The output of the task is serialized in JSON and stored in the run record.</div><div class=""> </div><div class=""> When a ``RUNNING`` task throws an exception, the run is mark as ``FAILED`` and the task is marked as ``FAILED``. The traceback is stored in the run record.</div><div class=""> </div><div class=""> Similarly, when a run exceeds the timeout, it is stopped and marked as ``TIMEOUT``, and the task is marked as ``TIMEOUT``.</div><div class=""> </div><div class=""> In any case, the stdout is captured and also logged into the run record.</div><div class=""> </div><div class=""> Using appadmin, one can check all ``RUNNING`` tasks, the output of ``COMPLETED`` tasks, the error of ``FAILED`` tasks, etc.</div><div class=""> </div><div class="insert">+The scheduler also creates one more table called &quot;scheduler_worker&quot;, which st\</div><div class="insert">+ores the workers&#x27; heartbeat and their status.</div></div></div>
    <div class="span6"><div class="diff"><div class=""> ### ``response``</div><div class=""> ``response``:inxx</div><div class=""> ``response.body``:inxx</div><div class=""> ``response.cookies``:inxx</div><div class=""> ``response.download``:inxx</div><div class=""> ``response.files``:inxx</div><div class=""> ``response.flash``:inxx</div><div class=""> ``response.headers``:inxx</div><div class=""> ``response.meta``:inxx</div><div class=""> ``response.menu``:inxx</div><div class=""> ``response.postprocessing``:inxx</div><div class=""> ``response.render``:inxx</div><div class=""> ``response.status``:inxx</div><div class=""> ``response.stream``:inxx</div><div class=""> ``response.subtitle``:inxx</div><div class=""> ``response.title``:inxx</div><div class=""> ``response.toolbar``:inxx</div><div class=""> ``response.view``:inxx</div><div class=""> ``response.delimiters``:inxx</div><div class=""> ``response.js``:inxx</div><div class=""> ``response.write``:inxx</div><div class=""> ``response.include_files``:inxx</div><div class=""> ``response.include_meta``:inxx</div><div class=""> ``response.optimize_css``:inxx</div><div class=""> ``response.optimize_js``:inxx</div><div class=""> ``response._caller``:inxx</div><div class=""> </div><div class=""> ``response`` is another instance of the ``Storage`` class. It contains the following:</div><div class=""> </div><div class=""> - ``response.body``: a ``StringIO`` object into which web2py writes the output page body. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.cookies``: similar to ``request.cookies``, but while the latter contains the cookies sent from the client to the server, the former contains cookies sent by the server to the client. The session cookie is handled automatically.</div><div class=""> - ``response.download(request, db)``: a method used to implement the controller function that allows downloading of uploaded files. ``request.download`` expects the last ``arg`` in ``request.args`` to be the encoded filename (i.e., the filename generated at upload time and stored in the upload field). It extracts the upload field name and table name as well as the original filename from the encoded filename. ``response.download`` takes two optional arguments: ``chunk_size`` sets the size in bytes for chunked streaming (defaults to 64K), and ``attachments`` determines whether the downloaded file should be treated as an attachment or not (default to ``True``). Note, ``response.download`` is specifically for downloading files associated with ``db`` upload fields. Use ``response.stream`` (see below) for other types of file downloads and streaming. Also, note that it is not necessary to use ``response.download`` to access files uploaded to the /static folder -- static files can (and generally should) be accessed directly via URL (e.g., /app/static/files/myfile.pdf).</div><div class="delete">- ``response.files``: a list of ``.css``, ``.js``, ``<span class="highlight"></span>coffee``, and ``.less`` files required by the page. They will automatically be linked in the head of the standard &quot;layout.html&quot; via the included &quot;web2py_ajax.html&quot;. To include a new CSS, JS, COFFEE, or LESS file, just append it to this list. It will handle duplicates. The order is important.</div><div class=""> - ``response.include_files()`` generates html head tags to include all ``response.files`` (used in &quot;views/web2py_ajax.html&quot;).</div><div class=""> - ``response.flash``: optional parameter that may be included in the views. Normally used to notify the user about something that happened.</div><div class="delete">- ``response.headers``: a ``dict`` for HTTP response headers. Web2py sets some headers by default, including &quot;Content-Length&quot;, &quot;Content-Type&quot;, and &quot;X-Powered-By&quot; (set equal to web2py). Web2py also sets the &quot;Cache-Control&quot;, &quot;Expires&quot;, and &quot;Pragma&quot; headers to prevent client-side caching, except for static file requests, for which client-side caching is enabled. The headers that web2py sets can be overwritten or removed, and new headers can be added (e.g., ``response.headers[&#x27;Cache-Control&#x27;] = &#x27;private&#x27;``). You can remove a header by removing its key from the response.headers dict, e.g.<span class="highlight"></span>``del response.headers[&#x27;Custom-Header&#x27;]``, however web2py&#x27;s default headers will be re-added just before returning the response. To avoid this behavior, just set the header value to None, e.g. to remove the default Content-Type header, ``response.headers[&#x27;Content-Type&#x27;] = None``</div><div class=""> - ``response.menu``: optional parameter that may be included in the views, normally used to pass a navigation menu tree to the view. It can be rendered by the MENU helper.</div><div class=""> - ``response.meta``: a Storage object that contains optional ``&lt;meta&gt;`` information like ``response.meta.author``, ``.description``, and/or ``.keywords``. The content of each meta variable is automatically placed in the proper ``META`` tag by the code in &quot;views/web2py_ajax.html&quot;, which is included by default in &quot;views/layout.html&quot;.</div><div class=""> - ``response.include_meta()`` generates a string that includes all ``response.meta`` headers serialized (used in &quot;views/web2py_ajax.html&quot;).</div><div class=""> - ``response.postprocessing``: this is a list of functions, empty by default. These functions are used to filter the response object at the output of an action, before the output is rendered by the view. It can be used to implement support for other template languages.</div><div class=""> - ``response.render(view, vars)``: a method used to call the view explicitly inside the controller. ``view`` is an optional parameter which is the name of the view file, ``vars`` is a dictionary of named values passed to the view.</div><div class=""> - ``response.session_file``: file stream containing the session.</div><div class=""> - ``response.session_file_name``: name of the file where the session will be saved.</div><div class=""> - ``response.session_id``: the id of the current session. It is determined automatically. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.session_id_name``: the name of the session cookie for this application. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.status``: the HTTP status code integer to be passed to the response. Default is 200 (OK).</div><div class=""> - ``response.stream(file, chunk_size, request=request, attachment=False, filename=None, headers=None)``: when a controller returns it, web2py streams the file content back to the client in blocks of size ``chunk_size``. The ``request`` parameter is required to use the chunk start in the HTTP header. ``file`` should be a file path (for backward compatibility, it can also be an open file object, but this is not recommended). As noted above, ``response.download`` should be used to retrieve files stored via an upload field. ``response.stream`` can be used in other cases, such as returning a temporary file or StringIO object created by the controller. If ``attachment`` is True, the Content-Disposition header will be set to &quot;attachment&quot;, and if ``filename`` is also provided, it will be added to the Content-Disposition header as well (but only when ``attachment`` is True). If not already included in ``response.headers``, the following response headers will be set automatically: Content-Type, Content-Length, Cache-Control, Pragma, and Last-Modified (the latter three are set to allow browser caching of the file). To override any of these automatic header settings, simply set them in ``response.headers`` before calling ``response.stream``.</div><div class=""> - ``response.subtitle``: optional parameter that may be included in the views. It should contain the subtitle of the page.</div><div class=""> - ``response.title``: optional parameter that may be included in the views. It should contain the title of the page and should be rendered inside the html title tag in the header.</div><div class=""> - ``response.toolbar``: a function that allows you to embed a toolbar into page for debugging purposes ``{{=response.toolbar()}}``. The toolbar displays request, response, session variables and database access time for each query.</div><div class=""> - ``response._vars``: this variable is accessible only in a view, not in the action. It contains the values returned by the action to the view.</div><div class=""> - ``response._caller``: this is a function that wraps all action calls. It defaults to the identity function, but it can be modified in order to catch special types of exception to do extra logging;</div><div class="">   ``</div><div class="">   response._caller = lambda f: f()</div><div class="">   ``</div><div class="delete">-- ``response.optimize_css``: it can be set to &quot;concat,minify,inline&quot; to concatenate, minify and inline the CSS files included by web2py.</div><div class="delete">-- ``response.optimize_js``: it can be set to &quot;concat,minify,inline&quot; to concatenate, minify and inline the JavaScript files included by web2py.</div><div class=""> - ``response.view``: the name of the view template that must render the page. This is set by default to:</div><div class="">   ``</div><div class="">   &quot;%s/%s.%s&quot; % (request.controller, request.function, request.extension)</div><div class="">   ``:code</div><div class="">   or, if the above file cannot be located, to</div><div class="">   ``</div><div class="">   &quot;generic.%s&quot; % (request.extension)</div><div class="">   ``:code</div><div class="">   Change the value of this variable to modify the view file associated with a particular action.</div><div class=""> </div><div class=""> - ``response.delimiters`` defaults to ``(&#x27;{{&#x27;,&#x27;}}&#x27;)``. It allows you to change the delimiter of code embedded in views.</div><div class=""> - ``response.xmlrpc(request, methods)``: when a controller returns it, this function exposes the methods via XML-RPC``xmlrpc``:cite . This function is deprecated since a better mechanism is available and described in Chapter 10.</div><div class=""> - ``response.write(text)``: a method to write text into the output page body.</div><div class=""> - ``response.js`` can contain Javascript code. This code will be executed if and only if the response is received by a web2py component as discussed in Chapter 12.</div><div class=""> </div><div class=""> Since ``response`` is a ``gluon.storage.Storage`` object, it can be used to store other attributes that you may want to pass to the view. While there is no technical restriction, our recommendation is to store only variables that are to be rendered by all pages in the overall layout (&quot;layout.html&quot;).</div><div class=""> </div><div class=""> Anyway, we strongly suggest to stick to the variables listed here:</div><div class=""> ``</div><div class=""> response.title</div><div class=""> To **store sessions in cookies** instead you can do:</div><div class=""> ``</div><div class=""> session.connect(request,response,cookie_key=&#x27;yoursecret&#x27;,compression_level=None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Here ``cookie_key`` is a symmetric encryption key.</div><div class=""> ``compression_level`` is an optional ``zlib`` encryption level.</div><div class=""> </div><div class=""> While sessions in cookie are often recommended for scalability reason they are limited in size. Large sessions will result in broken cookies.</div><div class=""> </div><div class=""> You can check the state of your application at any time by printing the ``request``, ``session`` and ``response`` system variables. One way to do it is to create a dedicated action:</div><div class=""> ``</div><div class=""> def status():</div><div class="">     return dict(request=request, session=session, response=response)</div><div class=""> ``:code</div><div class=""> </div><div class=""> In the &quot;generic.html&quot; view this is done using ``{{=response.toolbar()}}``.</div><div class=""> </div><div class=""> </div><div class=""> #### Separate sessions</div><div class=""> </div><div class="delete">If you are storing sessions on <span class="highlight">the filesystem and you have lots of them, the file</span> system access may become a bottle-neck. One solution is the following<span class="highlight"></span>:</div><div class=""> ``</div><div class=""> session.connect(request, response, separate=True)</div><div class=""> ``:code</div><div class=""> </div><div class=""> By setting ``separate=True`` web2py will store sessions not in the &quot;sessions/&quot; folder but in subfolders of the &quot;sessions/&quot; folder. The subfolder will be created automatically. Sessions with the same prefix will be in the same subfolder. Again, note that the above must be called before any logic that might require the session.</div><div class=""> </div><div class=""> ### ``cache``</div><div class=""> ``cache``:inxx ``cache.ram``:inxx ``cache.disk``:inxx</div><div class=""> ``cache`` a global object also available in the web2py execution environment. It has two attributes:</div><div class=""> - ``cache.ram``: the application cache in main memory.</div><div class=""> - ``cache.disk``: the application cache on disk.</div><div class=""> ``cache`` is callable, this allows it to be used as a decorator for caching actions and views.</div><div class=""> </div><div class=""> The following example caches the ``time.ctime()`` function in RAM:</div><div class=""> ``</div><div class=""> def cache_in_ram():</div><div class="">     import time</div><div class="">     t = cache.ram(&#x27;time&#x27;, lambda: time.ctime(), time_expire=5)</div><div class="">     return dict(time=t, link=A(&#x27;click me&#x27;, _href=request.url))</div><div class=""> ``:code</div><div class=""> The ``args`` attributes are automatically parsed, decoded, and finally stored in</div><div class=""> If args contains only one element, there is no need to pass it in a list.</div><div class=""> </div><div class=""> You can also use the ``URL`` function to generate URLs to actions in other controllers and other applications:</div><div class=""> </div><div class=""> ``</div><div class=""> URL(&#x27;a&#x27;, &#x27;c&#x27;, &#x27;f&#x27;, args=[&#x27;x&#x27;, &#x27;y&#x27;], vars=dict(z=&#x27;t&#x27;))</div><div class=""> ``:code</div><div class=""> </div><div class=""> is mapped into</div><div class=""> </div><div class=""> ``</div><div class=""> /a/c/f/x/y?z=t</div><div class=""> ``</div><div class=""> </div><div class=""> It is also possible to specify application, controller and function using named arguments:</div><div class=""> </div><div class=""> ``</div><div class=""> URL(a=&#x27;a&#x27;, c=&#x27;c&#x27;, f=&#x27;f&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class="delete">If the application name <span class="highlight"></span>a<span class="highlight"></span> is missing the current app is assumed.</div><div class=""> </div><div class=""> ``</div><div class=""> URL(&#x27;c&#x27;, &#x27;f&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class="delete">If the controller name<span class="highlight"></span> is missing, the current one is assumed.</div><div class=""> </div><div class=""> ``</div><div class=""> URL(&#x27;f&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Instead of passing the name of a controller function it is also possible to pass the function itself</div><div class=""> </div><div class=""> ``</div><div class=""> URL(f)</div><div class=""> ``:code</div><div class=""> </div><div class=""> For the reasons mentioned above, you should always use the ``URL`` function to generate URLs of static files for your applications. Static files are stored in the application&#x27;s ``static`` subfolder (that&#x27;s where they go when uploaded using the administrative interface). web2py provides a virtual &#x27;static&#x27; controller whose job is to retrieve files from the ``static`` subfolder, determine their content-type, and stream the file to the client. The following example generates the URL for the static file &quot;image.png&quot;:</div><div class=""> </div><div class=""> ``</div><div class=""> URL(&#x27;static&#x27;, &#x27;image.png&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> is mapped into</div><div class=""> </div><div class=""> ``</div><div class=""> where:</div><div class=""> &lt;modifier&gt;::= ! | !! | !!!</div><div class=""> &lt;word&gt; ::= any word or phrase in singular in lower case (!)</div><div class=""> &lt;parameter&gt; ::= [index] | (key) | (number)</div><div class=""> ``</div><div class=""> </div><div class=""> For example:</div><div class=""> </div><div class=""> - ``%%{word}`` is equivalent to ``%%{word[0]}`` (if no modifiers are used).</div><div class=""> - ``%%{word[index]}`` is used when symbols is a tuple. symbols[index] gives us a number used to make a decision on which word form to choose.</div><div class=""> - ``%%{word(key)}`` is used to get the numeric parameter from symbols[key]</div><div class=""> - ``%%{word(number)}`` allows to set a ``number`` directly (e.g.: ``%%{word(%i)}``)</div><div class=""> - ``%%{?word?number}`` returns &quot;word&quot; if ``number==1``, returns the ``number`` otherwise</div><div class=""> - ``%%{?number} or %%{??number}`` returns ``number`` if ``number!=1``, return nothing otherwise</div><div class=""> </div><div class=""> ``T(&quot;blabla %s %%{word}&quot;, symbols=var)``</div><div class=""> </div><div class=""> ``%%{word}`` by default means ``%%{word[0]}``,</div><div class=""> where ``[0]`` is an item index in symbols tuple.</div><div class=""> </div><div class=""> ``T(&quot;blabla %s %s %%{word[1]}&quot;, (var1, var2))``</div><div class="delete">PS is used for &quot;word&quot; and <span class="highlight"></span>var2<span class="highlight"></span> respectively.</div><div class=""> </div><div class=""> You can use several ``%%{}`` placeholders with one index:</div><div class=""> </div><div class=""> ``T(&quot;%%{this} %%{is} %s %%{book}&quot;, var)``</div><div class=""> </div><div class=""> or</div><div class=""> </div><div class=""> ``T(&quot;%%{this[0]} %%{is[0]} %s %%{book[0]}&quot;, var)``</div><div class=""> </div><div class=""> They generate:</div><div class=""> </div><div class=""> ``</div><div class=""> var  output</div><div class=""> ------------------</div><div class="">  1   this is 1 book</div><div class="">  2   these are 2 books</div><div class="">  3   these are 2 books</div><div class=""> ``</div><div class=""> </div><div class=""> Similarly you can pass a dictionary to symbols:</div><div class=""> does the exact same thing as</div><div class=""> scheduler.queue_task(&#x27;demo1&#x27;, pvars={&#x27;a&#x27;:1, &#x27;b&#x27;:2})</div><div class=""> ``:code</div><div class=""> </div><div class=""> as</div><div class=""> </div><div class=""> ``</div><div class=""> st.validate_and_insert(function_name=&#x27;demo1&#x27;, args=json.dumps([1,2]))</div><div class=""> ``:code</div><div class=""> </div><div class=""> and as:</div><div class=""> </div><div class=""> ``</div><div class=""> st.validate_and_insert(function_name=&#x27;demo1&#x27;, vars=json.dumps({&#x27;a&#x27;:1,&#x27;b&#x27;:2}))</div><div class=""> ``:code</div><div class=""> </div><div class=""> Here is a more complex complete example:</div><div class=""> ``</div><div class=""> def task_add(a,b):</div><div class="">     return a+b</div><div class=""> </div><div class="delete">s<span class="highlight">e</span>cheduler = Scheduler(db, tasks=dict(demo1=task_add))</div><div class=""> </div><div class=""> scheduler.queue_task(&#x27;demo1&#x27;, pvars=dict(a=1,b=2),</div><div class="">                      repeats = 0, period = 180)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Since version 2.4.1 if you pass an additional parameter ``immediate=True`` it will force the main worker to reassign tasks. Until 2.4.1, the worker checks for new tasks every 5 cycles (so, ``5*heartbeats`` seconds). If you had an app that needed to check frequently for new tasks, to get a &#x27;&#x27;snappy&#x27;&#x27; behaviour you were forced to lower the ``heartbeat`` parameter, putting the db under pressure for no reason. With ``immediate=True`` you can force the check for new tasks: it will happen at most as ``heartbeat`` seconds are passed   </div><div class=""> </div><div class=""> A call to ``scheduler.queue_task`` returns the task ``id`` and ``uuid`` of the task you queued (can be the one you passed or the auto-generated one), and possible ``errors``:</div><div class=""> </div><div class=""> ``</div><div class=""> &lt;Row {&#x27;errors&#x27;: {}, &#x27;id&#x27;: 1, &#x27;uuid&#x27;: &#x27;08e6433a-cf07-4cea-a4cb-01f16ae5f414&#x27;}&gt;</div><div class=""> ``</div><div class="">  </div><div class="delete">If there are errors (usually syntax error<span class="highlight">s</span> or input validation errors),</div><div class=""> you get the result of the validation, and id and uuid will be None</div><div class=""> </div><div class=""> ``</div><div class=""> &lt;Row {&#x27;errors&#x27;: {&#x27;period&#x27;: &#x27;enter an integer greater than or equal to 0&#x27;}, &#x27;id&#x27;: None, &#x27;uuid&#x27;: None}&gt;</div><div class=""> ``</div><div class=""> </div><div class=""> ##### Results and output</div><div class=""> </div><div class=""> The table &quot;scheduler_run&quot; stores the status of all running tasks. Each record references a task that has been picked up by a worker.  One task can have multiple runs. For example, a task scheduled to repeat 10 times an hour will probably have 10 runs (unless one fails or they take longer than 1 hour). Beware that if the task has no return values, it is removed from the scheduler_run table as soon as it is finished.</div><div class=""> </div><div class=""> Possible run statuses are:</div><div class=""> </div><div class=""> ``</div><div class=""> RUNNING, COMPLETED, FAILED, TIMEOUT</div><div class=""> ``</div><div class=""> </div><div class=""> If the run is completed, no exceptions are thrown, and there is no task timeout, the run is marked as ``COMPLETED`` and the task is marked as ``QUEUED`` or ``COMPLETED`` depending on whether it is supposed to run again at a later time. The output of the task is serialized in JSON and stored in the run record.</div><div class=""> </div><div class=""> When a ``RUNNING`` task throws an exception, the run is mark as ``FAILED`` and the task is marked as ``FAILED``. The traceback is stored in the run record.</div><div class=""> </div><div class=""> Similarly, when a run exceeds the timeout, it is stopped and marked as ``TIMEOUT``, and the task is marked as ``TIMEOUT``.</div><div class=""> </div><div class=""> In any case, the stdout is captured and also logged into the run record.</div><div class=""> </div><div class=""> Using appadmin, one can check all ``RUNNING`` tasks, the output of ``COMPLETED`` tasks, the error of ``FAILED`` tasks, etc.</div><div class=""> </div><div class="delete">-The scheduler also creates one more table called &quot;scheduler_worker&quot;, which stores the workers&#x27; heartbeat and their status. </div><div class="delete">-</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/739a4c66c06a1aa5de5f4bd07b49e2f04ec30290">739a4c6</a><ul><li>Date : 2013-04-04</li><li>English 5th: Various text corrections</li></ul></li></ul>
<div class="row-fluid" id="com_739a4c66c06a1aa5de5f4bd07b49e2f04ec30290">
    <div class="span6"><div class="diff"><div class=""> - ``response.body``: a ``StringIO`` object into which web2py writes the output page body. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.cookies``: similar to ``request.cookies``, but while the latter contains the cookies sent from the client to the server, the former contains cookies sent by the server to the client. The session cookie is handled automatically.</div><div class=""> - ``response.download(request, db)``: a method used to implement the controller function that allows downloading of uploaded files. ``request.download`` expects the last ``arg`` in ``request.args`` to be the encoded filename (i.e., the filename generated at upload time and stored in the upload field). It extracts the upload field name and table name as well as the original filename from the encoded filename. ``response.download`` takes two optional arguments: ``chunk_size`` sets the size in bytes for chunked streaming (defaults to 64K), and ``attachments`` determines whether the downloaded file should be treated as an attachment or not (default to ``True``). Note, ``response.download`` is specifically for downloading files associated with ``db`` upload fields. Use ``response.stream`` (see below) for other types of file downloads and streaming. Also, note that it is not necessary to use ``response.download`` to access files uploaded to the /static folder -- static files can (and generally should) be accessed directly via URL (e.g., /app/static/files/myfile.pdf).</div><div class=""> - ``response.files``: a list of ``.css``, ``.js``, ``coffee``, and ``.less`` files required by the page. They will automatically be linked in the head of the standard &quot;layout.html&quot; via the included &quot;web2py_ajax.html&quot;. To include a new CSS, JS, COFFEE, or LESS file, just append it to this list. It will handle duplicates. The order is important.</div><div class=""> - ``response.include_files()`` generates html head tags to include all ``response.files`` (used in &quot;views/web2py_ajax.html&quot;).</div><div class=""> - ``response.flash``: optional parameter that may be included in the views. Normally used to notify the user about something that happened.</div><div class=""> - ``response.headers``: a ``dict`` for HTTP response headers. Web2py sets some headers by default, including &quot;Content-Length&quot;, &quot;Content-Type&quot;, and &quot;X-Powered-By&quot; (set equal to web2py). Web2py also sets the &quot;Cache-Control&quot;, &quot;Expires&quot;, and &quot;Pragma&quot; headers to prevent client-side caching, except for static file requests, for which client-side caching is enabled. The headers that web2py sets can be overwritten or removed, and new headers can be added (e.g., ``response.headers[&#x27;Cache-Control&#x27;] = &#x27;private&#x27;``). You can remove a header by removing its key from the response.headers dict, e.g.``del response.headers[&#x27;Custom-Header&#x27;]``, however web2py&#x27;s default headers will be re-added just before returning the response. To avoid this behavior, just set the header value to None, e.g. to remove the default Content-Type header, ``response.headers[&#x27;Content-Type&#x27;] = None``</div><div class=""> - ``response.menu``: optional parameter that may be included in the views, normally used to pass a navigation menu tree to the view. It can be rendered by the MENU helper.</div><div class=""> - ``response.meta``: a Storage object that contains optional ``&lt;meta&gt;`` information like ``response.meta.author``, ``.description``, and/or ``.keywords``. The content of each meta variable is automatically placed in the proper ``META`` tag by the code in &quot;views/web2py_ajax.html&quot;, which is included by default in &quot;views/layout.html&quot;.</div><div class=""> - ``response.include_meta()`` generates a string that includes all ``response.meta`` headers serialized (used in &quot;views/web2py_ajax.html&quot;).</div><div class=""> - ``response.postprocessing``: this is a list of functions, empty by default. These functions are used to filter the response object at the output of an action, before the output is rendered by the view. It can be used to implement support for other template languages.</div><div class=""> - ``response.render(view, vars)``: a method used to call the view explicitly inside the controller. ``view`` is an optional parameter which is the name of the view file, ``vars`` is a dictionary of named values passed to the view.</div><div class=""> - ``response.session_file``: file stream containing the session.</div><div class=""> - ``response.session_file_name``: name of the file where the session will be saved.</div><div class=""> - ``response.session_id``: the id of the current session. It is determined automatically. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.session_id_name``: the name of the session cookie for this application. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.status``: the HTTP status code integer to be passed to the response. Default is 200 (OK).</div><div class=""> - ``response.stream(file, chunk_size, request=request, attachment=False, filename=None, headers=None)``: when a controller returns it, web2py streams the file content back to the client in blocks of size ``chunk_size``. The ``request`` parameter is required to use the chunk start in the HTTP header. ``file`` should be a file path (for backward compatibility, it can also be an open file object, but this is not recommended). As noted above, ``response.download`` should be used to retrieve files stored via an upload field. ``response.stream`` can be used in other cases, such as returning a temporary file or StringIO object created by the controller. If ``attachment`` is True, the Content-Disposition header will be set to &quot;attachment&quot;, and if ``filename`` is also provided, it will be added to the Content-Disposition header as well (but only when ``attachment`` is True). If not already included in ``response.headers``, the following response headers will be set automatically: Content-Type, Content-Length, Cache-Control, Pragma, and Last-Modified (the latter three are set to allow browser caching of the file). To override any of these automatic header settings, simply set them in ``response.headers`` before calling ``response.stream``.</div><div class=""> - ``response.subtitle``: optional parameter that may be included in the views. It should contain the subtitle of the page.</div><div class="insert">- ``response.title``: optional parameter that may be included in the views. It should contain the title of the page and should be rendered <span class="highlight">inside</span> the <span class="highlight">html</span> title <span class="highlight">tag</span> in the header.</div><div class=""> - ``response.toolbar``: a function that allows you to embed a toolbar into page for debugging purposes ``{{=response.toolbar()}}``. The toolbar displays request, response, session variables and database access time for each query.</div><div class="insert">- ``response._vars``: this variable is accessible only in a view, not in the action. It contains the value<span class="highlight">s</span> returned by the action to the view.</div><div class=""> - ``response._caller``: this is a function that wraps all action calls. It defaults to the identity function, but it can be modified in order to catch special types of exception to do extra logging;</div><div class="">   ``</div><div class="">   response._caller = lambda f: f()</div><div class="">   ``</div><div class="insert">+- ``response.optimize_css``: it can be set to &quot;concat,minify,inline&quot; to concatenate, minify and inline the CSS files included by web2py.</div><div class="insert">+- ``response.optimize_js``: it can be set to &quot;concat,minify,inline&quot; to concatenate, minify and inline the JavaScript files included by web2py.</div><div class=""> - ``response.view``: the name of the view template that must render the page. This is set by default to:</div><div class="">   ``</div><div class="">   &quot;%s/%s.%s&quot; % (request.controller, request.function, request.extension)</div><div class="">   ``:code</div><div class="">   or, if the above file cannot be located, to</div><div class="">   ``</div><div class="">   &quot;generic.%s&quot; % (request.extension)</div><div class="">   ``:code</div><div class="">   Change the value of this variable to modify the view file associated with a particular action.</div><div class=""> </div><div class=""> - ``response.delimiters`` defaults to ``(&#x27;{{&#x27;,&#x27;}}&#x27;)``. It allows you to change the delimiter of code embedded in views.</div><div class=""> - ``response.xmlrpc(request, methods)``: when a controller returns it, this function exposes the methods via XML-RPC``xmlrpc``:cite . This function is deprecated since a better mechanism is available and described in Chapter 10.</div><div class=""> - ``response.write(text)``: a method to write text into the output page body.</div><div class=""> - ``response.js`` can contain Javascript code. This code will be executed if and only if the response is received by a web2py component as discussed in Chapter 12.</div><div class=""> </div><div class=""> Since ``response`` is a ``gluon.storage.Storage`` object, it can be used to store other attributes that you may want to pass to the view. While there is no technical restriction, our recommendation is to store only variables that are to be rendered by all pages in the overall layout (&quot;layout.html&quot;).</div><div class=""> </div><div class=""> Anyway, we strongly suggest to stick to the variables listed here:</div><div class=""> ``</div><div class=""> response.title</div><div class=""> To **store sessions in cookies** instead you can do:</div><div class=""> ``</div><div class=""> session.connect(request,response,cookie_key=&#x27;yoursecret&#x27;,compression_level=None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Here ``cookie_key`` is a symmetric encryption key.</div><div class=""> ``compression_level`` is an optional ``zlib`` encryption level.</div><div class=""> </div><div class=""> While sessions in cookie are often recommended for scalability reason they are limited in size. Large sessions will result in broken cookies.</div><div class=""> </div><div class=""> You can check the state of your application at any time by printing the ``request``, ``session`` and ``response`` system variables. One way to do it is to create a dedicated action:</div><div class=""> ``</div><div class=""> def status():</div><div class="">     return dict(request=request, session=session, response=response)</div><div class=""> ``:code</div><div class=""> </div><div class=""> In the &quot;generic.html&quot; view this is done using ``{{=response.toolbar()}}``.</div><div class=""> </div><div class=""> </div><div class=""> #### Separate sessions</div><div class=""> </div><div class="insert">If you are storing sessions on<span class="highlight"> the</span> filesystem and you have lots of them, the file system access may become a bottle-neck. One solution is the following:</div><div class=""> ``</div><div class=""> session.connect(request, response, separate=True)</div><div class=""> ``:code</div><div class=""> </div><div class=""> By setting ``separate=True`` web2py will store sessions not in the &quot;sessions/&quot; folder but in subfolders of the &quot;sessions/&quot; folder. The subfolder will be created automatically. Sessions with the same prefix will be in the same subfolder. Again, note that the above must be called before any logic that might require the session.</div><div class=""> </div><div class=""> ### ``cache``</div><div class=""> ``cache``:inxx ``cache.ram``:inxx ``cache.disk``:inxx</div><div class=""> ``cache`` a global object also available in the web2py execution environment. It has two attributes:</div><div class=""> - ``cache.ram``: the application cache in main memory.</div><div class=""> - ``cache.disk``: the application cache on disk.</div><div class=""> ``cache`` is callable, this allows it to be used as a decorator for caching actions and views.</div><div class=""> </div><div class=""> The following example caches the ``time.ctime()`` function in RAM:</div><div class=""> ``</div><div class=""> def cache_in_ram():</div><div class="">     import time</div><div class="">     t = cache.ram(&#x27;time&#x27;, lambda: time.ctime(), time_expire=5)</div><div class="">     return dict(time=t, link=A(&#x27;click me&#x27;, _href=request.url))</div><div class=""> ``:code</div><div class=""> message = cache.ram(&#x27;message&#x27;, lambda: &#x27;Goodbye&#x27;, time_expire=20)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Because ``time_expire`` is set to 20 seconds in the second call and only 10 seconds has elapsed since the message was first saved, the value &quot;Hello&quot; will be retrieved from the cache, and it will not be updated with &quot;Goodbye&quot;. The ``time_expire`` value of 5 seconds in the first call has no impact on the second call.</div><div class=""> </div><div class=""> Setting ``time_expire=0`` (or a negative value) forces the cached item to be refreshed (because the elapsed time since the last save will always be &gt; 0), and setting ``time_expire=None`` forces retrieval of the cached value, regardless of the time elapsed since it was saved (if ``time_expire`` is always ``None``, the cached item will effectively never expire).</div><div class=""> </div><div class=""> You can clear one or more cache variables with</div><div class=""> ``cache clear``:inxx</div><div class=""> </div><div class=""> ``</div><div class=""> cache.ram.clear(regex=&#x27;...&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> where ``regex`` is a regular expression matching all the keys you want removed from the cache. You can also clear a single item with:</div><div class=""> ``</div><div class=""> cache.ram(key, None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> where ``key`` is the key of the cached item.</div><div class=""> </div><div class="insert">It is also possible to define other caching mechanisms such as memcache. Memcache is available via ``gluon.contrib.memcache`` and is discussed in more detail<span class="highlight"></span> in Chapter 14.</div><div class=""> </div><div class=""> ------</div><div class=""> Be careful when caching to remeber that caching is usually at the app-level not at the user level. If you need, for example, to cache user specific content, choose a key that includes the user id.</div><div class=""> ------</div><div class=""> </div><div class=""> #### ``cache.client``</div><div class=""> Web2py by default assumes that the returned content is not going to be cached, as this reduces the shortcomings of an improper caching of the page client-side.</div><div class=""> </div><div class=""> For example, when you show a form to the user, or a list of records, the web page should not be cached, as other users may have inserted new records on the table you are showing.</div><div class=""> </div><div class=""> Instead, if you are showing to the user a wiki page whose content will never change (or it changes once a week), it is useful to store that page, but it is even more useful </div><div class=""> to tell the client that that page is not going to change.</div><div class=""> </div><div class=""> This is accomplished sending out some specific headers along with the page: when the client&#x27;s browser receives the content, it is stored in the browser&#x27;s cache and it will not be requested again</div><div class=""> to your site. Of course this is a **major** speedup for public-facing sites.</div><div class=""> </div><div class=""> Web2py 2.4.4 introduced a new ``cache.client`` decorator to allow a smarter handling of this situation.</div><div class=""> ``cache.client`` can be used:</div><div class=""> - for setting smart cache headers</div><div class=""> - to cache the results accordingly</div><div class=""> redirect(...,type=&#x27;auto&#x27;)</div><div class=""> ``T``:inxx ``internationalization``:inxx</div><div class=""> </div><div class=""> The object ``T`` is the language translator. It constitutes a single global instance of the web2py class ``gluon.language.translator``. All string constants (and only string constants) should be marked by ``T``, for example:</div><div class=""> ``</div><div class=""> a = T(&quot;hello world&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Strings that are marked with ``T`` are identified by web2py as needing language translation and they will be translated when the code (in the model, controller, or view) is executed. If the string to be translated is not a constant but a variable, it will be added to the translation file at runtime (except on GAE) to be translated later.</div><div class=""> </div><div class=""> The ``T`` object can also contain interpolated variables and supports multiple equivalent syntaxes:</div><div class=""> ``</div><div class=""> a = T(&quot;hello %s&quot;, (&#x27;Tim&#x27;,))</div><div class=""> a = T(&quot;hello %(name)s&quot;, dict(name=&#x27;Tim&#x27;))</div><div class=""> a = T(&quot;hello %s&quot;) % (&#x27;Tim&#x27;,)</div><div class=""> a = T(&quot;hello %(name)s&quot;) % dict(name=&#x27;Tim&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The latter syntax is recommended because it makes translation easier.</div><div class=""> The first string is translated according to the requested language file and the ``name`` variable is replaced independently of the language.</div><div class=""> </div><div class="insert">You can concatenat<span class="highlight">e</span> translated strings and normal strings:</div><div class=""> ``</div><div class=""> T(&quot;blah &quot;) + name + T(&quot; blah&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The following code is also allowed and often preferable:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;blah %(name)s blah&quot;, dict(name=&#x27;Tim&#x27;))</div><div class=""> ``:code</div><div class=""> </div><div class=""> or the alternative syntax</div><div class=""> ``</div><div class=""> T(&quot;blah %(name)s blah&quot;) % dict(name=&#x27;Tim&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> In both cases the translation occurs before the variable name is substituted in the &quot;%(name)s&quot; slot. The following alternative should NOT BE USED:</div><div class=""> ``</div><div class=""> T(&quot;blah %(name)s blah&quot; % dict(name=&#x27;Tim&#x27;))</div><div class=""> ``:code</div><div class=""> </div><div class=""> You can also force a per-string language:</div><div class=""> T(&quot;Hello World&quot;, language=&quot;it-it&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> --------------</div><div class=""> In the case multiple languages are requested, for example &quot;it-it, fr-ft&quot;, web2py tries to locate &quot;it-it.py&quot; and &quot;fr-fr.py&quot; translation files. If none of the requested files is present, it tries to fall back on &quot;it.py&quot; and &quot;fr.py&quot;. If these files are not present it defaults to &quot;default.py&quot;. If this is not present either, it default to no-translation. The more general rule is that web2py tries &quot;xx-xy-yy.py&quot;, &quot;xx-xy.py&quot;, &quot;xx.py&quot;, &quot;default.py&quot; for each of the &quot;xx-xy-yy&quot; accepted languages trying to find the closest match to the visitor&#x27;s preferences.</div><div class=""> -------------</div><div class=""> </div><div class=""> You can turn off translations completely via</div><div class=""> </div><div class=""> ``</div><div class=""> T.force(None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Normally, string translation is evaluated lazily when the view is rendered; hence, the translator ``force`` method should not be called inside a view.</div><div class=""> </div><div class=""> It is possible to disable lazy evaluation via</div><div class=""> ``</div><div class=""> T.lazy = False</div><div class=""> ``:code</div><div class=""> </div><div class="insert">In this way, strings are translated i<span class="highlight">n</span>mediately by the ``T`` operator based on the currently accepted or forced language.</div><div class=""> </div><div class=""> It is also possible to disable lazy evaluation for individual strings:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;Hello World&quot;, lazy=False)</div><div class=""> ``:code</div><div class=""> </div><div class=""> A common issue is the following. The original application is in English. Suppose that there is a translation file (for example Italian, &quot;it-it.py&quot;) and the HTTP client declares that it accepts both English (en) and Italian (it-it) in that order. The following unwanted situation occurs: web2py does not know the default is written in English (en). Therefore, it prefers translating everything into Italian (it-it) because it only found the Italian translation file. If it had not found the &quot;it-it.py&quot; file, it would have used the default language strings (English).</div><div class=""> </div><div class=""> There are two solutions for this problem: create a translation language for English, which would be redundant and unnecessary, or better, tell web2py which languages should use the default language strings (the strings coded into the application). This can be done with:</div><div class=""> ``</div><div class=""> T.set_current_languages(&#x27;en&#x27;, &#x27;en-en&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> It stores in  ``T.current_languages`` a list of languages that do not require translation and forces a reload of the language files.</div><div class=""> </div><div class=""> Notice that &quot;it&quot; and &quot;it-it&quot; are different languages from the point of view of web2py. To support both of them, one would need two translation files, always lower case. The same is true for all other languages.</div><div class=""> </div><div class=""> The currently accepted language is stored in</div><div class=""> ``</div><div class=""> x book(s)</div><div class=""> </div><div class=""> with</div><div class=""> </div><div class=""> ``</div><div class=""> a book (x==1)</div><div class=""> 5 books (x==5)</div><div class=""> ``</div><div class=""> </div><div class=""> English has one singular form and one plural form. The plural form is constructed by adding a &quot;-s&quot; or &quot;-es&quot; or using an exceptional form. web2py provides a way to define pluralization rules for each languages, as well as exceptions to the default rules. In fact web2py already knows pluralization rules for many languages. It knows, for example, that Slovenian has one singular form and 3 plural forms (for x==1, x==3 or x==4 and x&gt;4). These rules are encoded in &quot;gluon/contrib/plural_rules/*.py&quot; files and new files can be created. Explicit pluralizations for words are created by editing pluralization files using the administrative interface.</div><div class=""> </div><div class=""> By default the PS is not activated. It is triggered by the ``symbol`` argument of the ``T`` function. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;You have %s %%{book}&quot;, symbols=10)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Now the PS is activated for the word &quot;book&quot; and for the number 10.</div><div class=""> The result in English will be: &quot;You have 10 books&quot;. Notice that &quot;book&quot; has been pluralized into &quot;books&quot;.</div><div class=""> </div><div class=""> The PS consists of 3 parts:</div><div class="insert">- placeholders ``%%{}`` to mark words in <span class="highlight">the </span>``T``<span class="highlight"> input</span></div><div class=""> - rule to give a decision which word form to use (&quot;rules/plural_rules/*.py&quot;)</div><div class=""> - dictionary with word plural forms (&quot;app/languages/plural-*.py&quot;)</div><div class=""> </div><div class=""> The value of symbols can be a single variable, a list/tuple of variables, or a dictionary.</div><div class=""> </div><div class=""> The placeholder ``%%{}`` consists of 3 parts:</div><div class=""> </div><div class=""> ``</div><div class="insert">%%{[&lt;modifier&gt;]&lt;wor<span class="highlight"></span>d&gt;[&lt;parameter&gt;]},</div><div class=""> ``</div><div class=""> </div><div class=""> where:</div><div class=""> </div><div class=""> ``</div><div class=""> &lt;modifier&gt;::= ! | !! | !!!</div><div class=""> &lt;word&gt; ::= any word or phrase in singular in lower case (!)</div><div class=""> &lt;parameter&gt; ::= [index] | (key) | (number)</div><div class=""> ``</div><div class=""> </div><div class=""> For example:</div><div class=""> </div><div class=""> - ``%%{word}`` is equivalent to ``%%{word[0]}`` (if no modifiers are used).</div><div class=""> - ``%%{word[index]}`` is used when symbols is a tuple. symbols[index] gives us a number used to make a decision on which word form to choose.</div><div class=""> - ``%%{word(key)}`` is used to get the numeric parameter from symbols[key]</div><div class=""> - ``%%{word(number)}`` allows to set a ``number`` directly (e.g.: ``%%{word(%i)}``)</div><div class=""> - ``%%{?word?number}`` returns &quot;word&quot; if ``number==1``, returns the ``number`` otherwise</div><div class=""> - ``%%{?number} or %%{??number}`` returns ``number`` if ``number!=1``, return nothing otherwise</div><div class=""> </div><div class=""> ``T(&quot;blabla %s %%{word}&quot;, symbols=var)``</div><div class=""> error_handler = dict(application=&#x27;error&#x27;,</div><div class=""> </div><div class=""> If the ``error_handler`` is specified the action is called without user redirection and the handler action will be in charge of dealing with the error. In the event that the error-handling page itself returns an error, web2py will fall back to its old static responses.</div><div class=""> </div><div class=""> </div><div class=""> #### Static asset management</div><div class=""> </div><div class=""> Since version 2.1.0, web2py has the ability to manage static assets.</div><div class=""> </div><div class=""> When an application is in development, static file can change often, therefore web2py sends static files with no cache headers. This has the side-effect of &quot;forcing&quot; the browser to request static files at every request. This results in low performance when loading the page.</div><div class=""> </div><div class=""> In a &quot;production&quot; site, you may want to serve static files with ``cache`` headers to prevent un-necessary downloads since static files do not change.</div><div class=""> </div><div class=""> ``cache`` headers allow the browser to fetch each file only once, thus saving bandwidth and reducing loading time.</div><div class=""> </div><div class=""> Yet there is a problem: What should the cache headers declare? When should the files expire? When the files are first served, the server cannot forecast when they will be changed.</div><div class=""> </div><div class=""> A manual approach consists of creating subfolders for different versions of static files. For example an early version of &quot;layout.css&quot; can be made available at the URL &quot;/myapp/static/css/1.2.3/layout.css&quot;. When you change the file, you create a new subfolder and you link it as &quot;/myapp/static/css/1.2.4/layout.css&quot;.</div><div class=""> </div><div class=""> This procedure works but it is pedantic since every time you update the css file, you must remember to move it to another folder, change the URL of the file in your layout.html and deploy.</div><div class=""> </div><div class="insert">Static asset management solves the problem by allowing the developer to declare a version for a group of static files and they will be requested again only when the version number changes. The <span class="highlight">asset version number is</span> made part of the file url as in the previous example. The difference from the previous approach is that the version number only appears in the URL, not in the file system.</div><div class=""> </div><div class=""> </div><div class=""> If you want to serve &quot;/myapp/static/layout.css&quot; with the cache headers, you just need to include the file with a modified URL that includes a version number:</div><div class=""> ``</div><div class=""> /myapp/static/_1.2.3/layout.css</div><div class=""> ``</div><div class=""> (notice the URL defines a version number, it does not appear anywhere else).</div><div class=""> </div><div class=""> Notice that the URL starts with &quot;/myapp/static/&quot;, followed by a version number composed by an underscore and 3 integers separated by a period (as described in [[SemVer http://semver.org/]]), then followed by the filename. Also notice that you do not have to create a &quot;_1.2.3/&quot; folder.</div><div class=""> </div><div class=""> Every time the static file is requested with a version in the url, it will be served with &quot;far in the future&quot; cache headers, specifically:</div><div class=""> ``</div><div class=""> Cache-Control : max-age=315360000</div><div class=""> Expires: Thu, 31 Dec 2037 23:59:59 GMT</div><div class=""> ``</div><div class=""> This means that the browser will fetch those files only once, and they will be saved &quot;forever&quot; in the browser&#x27;s cache.</div><div class=""> </div><div class=""> Every time the &quot;_1.2.3/filename&quot; is requested, web2py will remove the version part from the path and serve your file with far in the future headers so they will be cached forever. If you changed the version number in the URL, this tricks the browser into thinking it is requesting a different file, and the file is fetched again.</div><div class=""> </div><div class=""> You can use &quot;_1.2.3&quot;, &quot;_0.0.0&quot;, &quot;_999.888.888&quot;, as long as the version starts with underscore followed by three numbers separated by period.</div><div class=""> By **cron** we refer to a web2py functionality not to the Unix Cron mechanism. T</div><div class=""> web2py cron is the way to go if you need tasks in the background at scheduled times and these tasks take a relatively short time compared to the time interval between two calls. Each task runs in its own process, and multiple tasks can run concurrently, but you have no control over how many tasks run. If accidentally one task overlaps with itself, it can cause a database lock and a spike in memory usage.</div><div class=""> </div><div class=""> web2py scheduler takes a different approach. The number of running processes is fixed, and they can run on different machines. Each process is called a worker. Each worker picks a task when available and executes it as soon as possible after the time when it is scheduled to run, but not necessarily at that exact time. There cannot be more processes running than the number of scheduled tasks and therefore no memory spikes. Scheduler tasks can be defined in models and are stored in the database. The web2py scheduler does not implement a distributed queue since it assumes that the time to distribute tasks is negligible compared with the time to run the tasks. Workers pick up the task from the database.</div><div class=""> </div><div class=""> Homemade tasks queues can be a simpler alternative to the web2py scheduler in some cases.</div><div class=""> </div><div class=""> #### Cron</div><div class=""> ``cron``:inxx</div><div class=""> </div><div class=""> The web2py cron provides the ability for applications to execute tasks at preset times, in a platform-independent manner.</div><div class=""> </div><div class=""> For each application, cron functionality is defined by a crontab file:</div><div class=""> </div><div class=""> ``</div><div class=""> app/cron/crontab</div><div class=""> ``</div><div class=""> </div><div class=""> It follows the syntax defined in ref. ``cron``:cite (with some extensions that are specific to web2py).</div><div class=""> </div><div class=""> ------</div><div class="insert">Before web2py 2.1.1, cron was enabled by default and could be disabled with the ``-N`` command line option<span class="highlight">.</span> Since 2.1.1, cron is disabled by default and can be enabled by the ``-Y`` option. This change was motivated by the desire to push users toward using the new scheduler (which is superior to the cron mechanism) and also because cron may impact on performance.</div><div class=""> ------</div><div class=""> </div><div class=""> This means that every application can have a separate cron configuration and that cron config can be changed from within web2py without affecting the host OS itself.</div><div class=""> </div><div class=""> Here is an example:</div><div class=""> ``</div><div class=""> 0-59/1  *  *  *  *  root python /path/to/python/script.py</div><div class=""> 30      3  *  *  *  root *applications/admin/cron/db_vacuum.py</div><div class=""> */30    *  *  *  *  root **applications/admin/cron/something.py</div><div class=""> @reboot root    *mycontroller/myfunction</div><div class=""> @hourly root    *applications/admin/cron/expire_sessions.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> The last two lines in this example use extensions to regular cron syntax to provide additional web2py functionality.</div><div class=""> </div><div class=""> -------</div><div class=""> The file &quot;applications/admin/cron/expire_sessions.py&quot; actually exists and ships with the **admin** app. It checks for expired sessions and deletes them. &quot;applications/admin/cron/crontab&quot; runs this task hourly.</div><div class=""> -------</div><div class=""> </div><div class="insert">If the task/script is prefixed with an asterisk (``*``) and ends with ``.py``, it will be executed in the web2py environment. This means you will have all the controllers and models at your disposal. If you use two asterisks (``**``), the <span class="highlight">model</span>s will not be executed. This is the recommended way of calling, as it has less overhead and avoids potential locking problems.</div><div class=""> </div><div class=""> Notice that scripts/functions executed in the web2py environment require a manual ``db.commit()`` at the end of the function or the transaction will be reverted.</div><div class=""> </div><div class=""> web2py does not generate tickets or meaningful tracebacks in shell mode, which is how cron is run, so make sure that your web2py code runs without errors before you set it up as a cron task as you will likely not be able to see those errors when run from cron. Moreover, be careful how you use models: while the execution happens in a separate process, database locks have to be taken into account in order to avoid pages waiting for cron tasks that may be blocking the database. Use the ``**`` syntax if you don&#x27;t need to use the database in your cron task.</div><div class=""> </div><div class=""> You can also call a controller function, in which case there is no need to specify a path. The controller and function will be that of the invoking application. Take special care about the caveats listed above. Example:</div><div class=""> ``</div><div class=""> */30  *  *  *  *  root *mycontroller/myfunction</div><div class=""> ``:code</div><div class=""> </div><div class=""> If you specify ``@reboot`` in the first field in the crontab file, the given task will be executed only once, at web2py startup. You can use this feature if you want to pre-cache, check, or initialize data for an application on web2py startup. Note that cron tasks are executed in parallel with the application --- if the application is not ready to serve requests until the cron task is finished, you should implement checks to reflect this. Example:</div><div class=""> ``</div><div class=""> @reboot  *  *  *  *  root *mycontroller/myfunction</div><div class=""> ``:code</div><div class=""> </div><div class=""> Depending on how you are invoking web2py, there are four modes of operation for web2py cron.</div><div class=""> - &#x27;&#x27;soft cron&#x27;&#x27;: available under all execution modes</div><div class=""> - &#x27;&#x27;hard cron&#x27;&#x27;: available if using the built-in web server (either directly or via Apache mod_proxy)</div><div class=""> - &#x27;&#x27;external cron&#x27;&#x27;: available if you have access to the system&#x27;s own cron service</div><div class=""> - No cron</div><div class=""> Scheduler(</div><div class="">     migrate=True,</div><div class="">     worker_name=None,</div><div class="">     group_names=None,</div><div class="">     heartbeat=HEARTBEAT,</div><div class="">     max_empty_runs=0,</div><div class="">     discard_results=False,</div><div class="">     utc_time=False</div><div class=""> )</div><div class=""> ``:code</div><div class=""> </div><div class=""> Let&#x27;s see them in order:</div><div class=""> </div><div class=""> - ``db`` is the database DAL instance where you want the scheduler tables be placed.</div><div class=""> - ``tasks`` is a dictionary that maps task names into functions. If you do not pass this parameter, function will be searched in the app environment.</div><div class=""> - ``worker_name`` is None by default. As soon as the worker is started, a worker name is generated as hostname-uuid. If you want to specify that, be sure that it&#x27;s unique.</div><div class=""> - ``group_names`` is by default set to **[main]**. All tasks have a ``group_name`` parameter, set to **main** by default. Workers can only pick up tasks of their assigned group.</div><div class=""> </div><div class=""> ------</div><div class=""> NB: This is useful if you have different workers instances (e.g. on different machines) and you want to assign tasks to a specific worker.</div><div class=""> </div><div class="insert">NB2: It&#x27;s possible to assign a worker more groups, and they can be also all the same, as<span class="highlight"> ``[&#x27;mygroup&#x27;,&#x27;mygroup&#x27;]``. Tasks will be distributed taking into consideration that a worker with group_names ``[&#x27;mygroup&#x27;,&#x27;mygroup&#x27;]`` is able to process the double of the tasks a worker with group_names ``[&#x27;mygroup&#x27;]`` is.</span></div><div class=""> ------</div><div class="insert"><span class="highlight"></span></div><div class=""> - ``heartbeat`` is by default set to 3 seconds. This parameter is the one controlling how often a scheduler will check its status on the ``scheduler_worker`` table and see if there are any **ASSIGNED** tasks to itself to process.</div><div class=""> - ``max_empty_runs`` is 0 by default, that means that the worker will continue to process tasks as soon as they are **ASSIGNED**. If you set this to a value of, let&#x27;s say, 10, a worker will die automatically if it&#x27;s **ACTIVE** and no tasks are **ASSIGNED** to it for 10 loops. A loop is when a worker searches for tasks, every 3 seconds (or the set ``heartbeat``)</div><div class=""> - ``discard_results`` is False by default. If set to True, no scheduler_run records will be created.</div><div class=""> </div><div class=""> ------</div><div class=""> NB: scheduler_run records will be created as before for **FAILED**, **TIMEOUT** and **STOPPED** tasks&#x27;s statuses.</div><div class=""> ------</div><div class=""> </div><div class=""> - ``utc_time`` is False by default. If you need to coordinate with workers living in different timezones, or don&#x27;t have problems with solar/DST times, supplying datetimes from different countries, etc, you can set this to True. The scheduler will honor the UTC time and work leaving the local time aside. Caveat: you need to schedule tasks with UTC times (for start_time, stop_time, and so on.)</div><div class=""> </div><div class=""> Now we have the infrastructure in place: defined the tasks, told the scheduler about them, started the worker(s). What remains is to actually schedule the tasks</div><div class=""> </div><div class=""> </div><div class=""> ##### Tasks</div><div class=""> Tasks can be scheduled programmatically or via appadmin. In fact, a task is scheduled simply by adding an entry in the table &quot;scheduler_task&quot;, which you can access via appadmin:</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/myapp/appadmin/insert/db/scheduler_task</div><div class=""> ``</div><div class=""> </div><div class=""> st.validate_and_insert(function_name=&#x27;demo1&#x27;, vars=json.dumps({&#x27;a&#x27;:1,&#x27;b&#x27;:2}))</div><div class=""> </div><div class=""> Here is a more complex complete example:</div><div class=""> ``</div><div class=""> def task_add(a,b):</div><div class="">     return a+b</div><div class=""> </div><div class=""> secheduler = Scheduler(db, tasks=dict(demo1=task_add))</div><div class=""> </div><div class=""> scheduler.queue_task(&#x27;demo1&#x27;, pvars=dict(a=1,b=2),</div><div class="">                      repeats = 0, period = 180)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Since version 2.4.1 if you pass an additional parameter ``immediate=True`` it will force the main worker to reassign tasks. Until 2.4.1, the worker checks for new tasks every 5 cycles (so, ``5*heartbeats`` seconds). If you had an app that needed to check frequently for new tasks, to get a &#x27;&#x27;snappy&#x27;&#x27; behaviour you were forced to lower the ``heartbeat`` parameter, putting the db under pressure for no reason. With ``immediate=True`` you can force the check for new tasks: it will happen at most as ``heartbeat`` seconds are passed   </div><div class=""> </div><div class=""> A call to ``scheduler.queue_task`` returns the task ``id`` and ``uuid`` of the task you queued (can be the one you passed or the auto-generated one), and possible ``errors``:</div><div class=""> </div><div class=""> ``</div><div class=""> &lt;Row {&#x27;errors&#x27;: {}, &#x27;id&#x27;: 1, &#x27;uuid&#x27;: &#x27;08e6433a-cf07-4cea-a4cb-01f16ae5f414&#x27;}&gt;</div><div class=""> ``</div><div class="">  </div><div class="insert">If there are errors (usually syntax error<span class="highlight">s</span> o<span class="highlight">r</span> input validation errors),</div><div class=""> you get the result of the validation, and id and uuid will be None</div><div class=""> </div><div class=""> ``</div><div class=""> &lt;Row {&#x27;errors&#x27;: {&#x27;period&#x27;: &#x27;enter an integer greater than or equal to 0&#x27;}, &#x27;id&#x27;: None, &#x27;uuid&#x27;: None}&gt;</div><div class=""> ``</div><div class=""> </div><div class=""> ##### Results and output</div><div class=""> </div><div class=""> The table &quot;scheduler_run&quot; stores the status of all running tasks. Each record references a task that has been picked up by a worker.  One task can have multiple runs. For example, a task scheduled to repeat 10 times an hour will probably have 10 runs (unless one fails or they take longer than 1 hour). Beware that if the task has no return values, it is removed from the scheduler_run table as soon as it is finished.</div><div class=""> </div><div class=""> Possible run statuses are:</div><div class=""> </div><div class=""> ``</div><div class=""> RUNNING, COMPLETED, FAILED, TIMEOUT</div><div class=""> ``</div><div class=""> </div><div class=""> If the run is completed, no exceptions are thrown, and there is no task timeout, the run is marked as ``COMPLETED`` and the task is marked as ``QUEUED`` or ``COMPLETED`` depending on whether it is supposed to run again at a later time. The output of the task is serialized in JSON and stored in the run record.</div><div class=""> </div><div class=""> When a ``RUNNING`` task throws an exception, the run is mark as ``FAILED`` and the task is marked as ``FAILED``. The traceback is stored in the run record.</div><div class=""> </div><div class=""> Similarly, when a run exceeds the timeout, it is stopped and marked as ``TIMEOUT``, and the task is marked as ``TIMEOUT``.</div><div class=""> </div><div class=""> In any case, the stdout is captured and also logged into the run record.</div><div class=""> </div><div class=""> Using appadmin, one can check all ``RUNNING`` tasks, the output of ``COMPLETED`` tasks, the error of ``FAILED`` tasks, etc.</div><div class=""> </div><div class="insert">+The scheduler also creates one more table called &quot;scheduler_worker&quot;, which stores the workers&#x27; heartbeat and their status. </div><div class="insert">+</div><div class=""> </div><div class=""> ##### Managing processes</div><div class=""> </div><div class=""> Worker fine management is hard. This module tries not to leave behind any platform (Mac, Win, Linux) .</div><div class=""> </div><div class=""> When you start a worker, you may later want to:</div><div class=""> - kill it &quot;no matter what it&#x27;s doing&quot;</div><div class=""> - kill it only if it is not processing tasks</div><div class=""> - put it to sleep</div><div class=""> Maybe you have yet some tasks queued, and you want to save some resources.</div><div class=""> You know you want them processed every hour, so, you&#x27;ll want to:</div><div class=""> - process all queued tasks and die automatically</div><div class=""> All of these things are possible managing ``Scheduler`` parameters or the ``scheduler_worker`` table.</div><div class=""> To be more precise, for started workers you can change the ``status`` value of any worker to influence</div><div class=""> its behavior.</div><div class=""> As for tasks, workers can be in one of the following statuses: ACTIVE, DISABLED, TERMINATE or KILLED.</div><div class=""> </div><div class=""> **ACTIVE** and **DISABLED** are &quot;persistent&quot;, while **TERMINATE** or **KILL**, as statuses</div><div class=""> name suggest, are more &quot;commands&quot; than real statuses.</div><div class=""> Hitting ctrl+c is equal to set a worker to **KILL**</div><div class=""> scheduler.queue_task(</div><div class="">     timeout = 120, # should take less than 120 seconds</div><div class="">     )</div><div class=""> ``:code</div><div class=""> </div><div class=""> Notice that fields &quot;times_run&quot;, &quot;last_run_time&quot; and &quot;assigned_worker_name&quot; are not provided at schedule time but are filled automatically by the workers.</div><div class=""> </div><div class=""> You can also retrieve the output of completed tasks:</div><div class=""> </div><div class=""> ``</div><div class=""> completed_runs = db(db.scheduler_run.run_status=&#x27;COMPLETED&#x27;).select()</div><div class=""> ``:code</div><div class=""> </div><div class=""> ------</div><div class=""> The scheduler is considered experimental because it needs more extensive testing and because the table structure may change as more features are added.</div><div class=""> ------</div><div class=""> </div><div class=""> ##### Reporting percentages</div><div class=""> </div><div class=""> A special &quot;word&quot; encountered in the print statements of your functions clear all</div><div class=""> the previous output. That word is ``!clear!``.</div><div class="insert">+This, coupled with the ``sync_output`` parameter, allows to report percentages.</div><div class="insert">+</div><div class=""> </div><div class=""> Here is an example:</div><div class=""> </div><div class=""> ``</div><div class=""> def reporting_percentages():</div><div class="">     time.sleep(5)</div><div class="">     print &#x27;50%&#x27;</div><div class="">     time.sleep(5)</div><div class="">     print &#x27;!clear!100%&#x27;</div><div class="">     return 1</div><div class=""> ``</div><div class=""> </div><div class=""> The function ``reporting_percentages`` sleeps for 5 seconds, outputs ``50%``.</div><div class=""> Then, it sleeps other 5 seconds and outputs ``100%``. Note that the output in the scheduler_run table is synced every 2 seconds and that the second print statement that contains ``!clear!100%`` gets the ``50%`` output cleared and replaced by ``100%`` only.</div><div class=""> </div><div class=""> ``</div><div class=""> scheduler.queue_task(reporting_percentages,</div><div class="">                      sync_output=2)</div><div class=""> ``:code</div><div class=""> </div><div class=""> result = other.some_action()</div><div class=""> ``:code</div><div class=""> </div><div class=""> In line 2, ``request=request`` is optional. It has the effect of passing the current request to the environment of &quot;other&quot;. Without this argument, the environment would contain a new and empty (apart from ``request.folder``) request object. It is also possible to pass a response and a session object to ``exec_environment``. Be careful when passing request, response and session objects --- modification by the called action or coding dependencies in the called action could lead to unexpected side effects.</div><div class=""> </div><div class=""> The function call in line 3 does not execute the view; it simply returns the dictionary unless ``response.render`` is called explicitly by &quot;some_action&quot;.</div><div class=""> </div><div class=""> One final caution: don&#x27;t use ``exec_environment`` inappropriately. If you want the results of actions in another application, you probably should implement an XML-RPC API (implementing an XML-RPC API with web2py is almost trivial). Don&#x27;t use ``exec_environment`` as a redirection mechanism; use the ``redirect`` helper.</div><div class=""> </div><div class=""> ### Cooperation</div><div class=""> ``cooperation``:inxx</div><div class=""> </div><div class=""> There are many ways applications can cooperate:</div><div class=""> - Applications can connect to the same database and thus share tables. It is not necessary that all tables in the database are defined by all applications, but they must be defined by those applications that use them. All applications that use the same table, but one, must define the table with ``migrate=False``.</div><div class=""> - Applications can embed components from other applications using the LOAD helper (described in Chapter 12).</div><div class=""> - Applications can share sessions.</div><div class=""> - Applications can call each other&#x27;s actions remotely via XML-RPC.</div><div class=""> - Applications can access each other&#x27;s files via the filesystem (assuming they share the same filesystem).</div><div class=""> - Applications can call each other&#x27;s actions locally using ``exec_environment`` as discussed above.</div><div class=""> - Applications can import each other&#x27;s modules using the syntax:</div><div class=""> ``</div><div class="insert">+from applications.otherapp.modules import mymodule</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+or</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+import applications.otherapp.modules.othermodule</div><div class=""> ``:code</div><div class=""> </div><div class=""> - Applications can import any module in the ``PYTHONPATH`` search path, ``sys.path``.</div><div class=""> </div><div class=""> One app can load the session of another app using the command:</div><div class=""> </div><div class=""> ``</div><div class=""> session.connect(request, response, masterapp=&#x27;appname&#x27;, db=db)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Here &quot;appname&quot; is the name of the master application, the one that sets the initial session_id in the cookie. ``db`` is a database connection to the database that contains the session table (``web2py_session``). All apps that share sessions must use the same database for session storage.</div><div class=""> </div></div></div>
    <div class="span6"><div class="diff"><div class=""> - ``response.body``: a ``StringIO`` object into which web2py writes the output page body. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.cookies``: similar to ``request.cookies``, but while the latter contains the cookies sent from the client to the server, the former contains cookies sent by the server to the client. The session cookie is handled automatically.</div><div class=""> - ``response.download(request, db)``: a method used to implement the controller function that allows downloading of uploaded files. ``request.download`` expects the last ``arg`` in ``request.args`` to be the encoded filename (i.e., the filename generated at upload time and stored in the upload field). It extracts the upload field name and table name as well as the original filename from the encoded filename. ``response.download`` takes two optional arguments: ``chunk_size`` sets the size in bytes for chunked streaming (defaults to 64K), and ``attachments`` determines whether the downloaded file should be treated as an attachment or not (default to ``True``). Note, ``response.download`` is specifically for downloading files associated with ``db`` upload fields. Use ``response.stream`` (see below) for other types of file downloads and streaming. Also, note that it is not necessary to use ``response.download`` to access files uploaded to the /static folder -- static files can (and generally should) be accessed directly via URL (e.g., /app/static/files/myfile.pdf).</div><div class=""> - ``response.files``: a list of ``.css``, ``.js``, ``coffee``, and ``.less`` files required by the page. They will automatically be linked in the head of the standard &quot;layout.html&quot; via the included &quot;web2py_ajax.html&quot;. To include a new CSS, JS, COFFEE, or LESS file, just append it to this list. It will handle duplicates. The order is important.</div><div class=""> - ``response.include_files()`` generates html head tags to include all ``response.files`` (used in &quot;views/web2py_ajax.html&quot;).</div><div class=""> - ``response.flash``: optional parameter that may be included in the views. Normally used to notify the user about something that happened.</div><div class=""> - ``response.headers``: a ``dict`` for HTTP response headers. Web2py sets some headers by default, including &quot;Content-Length&quot;, &quot;Content-Type&quot;, and &quot;X-Powered-By&quot; (set equal to web2py). Web2py also sets the &quot;Cache-Control&quot;, &quot;Expires&quot;, and &quot;Pragma&quot; headers to prevent client-side caching, except for static file requests, for which client-side caching is enabled. The headers that web2py sets can be overwritten or removed, and new headers can be added (e.g., ``response.headers[&#x27;Cache-Control&#x27;] = &#x27;private&#x27;``). You can remove a header by removing its key from the response.headers dict, e.g.``del response.headers[&#x27;Custom-Header&#x27;]``, however web2py&#x27;s default headers will be re-added just before returning the response. To avoid this behavior, just set the header value to None, e.g. to remove the default Content-Type header, ``response.headers[&#x27;Content-Type&#x27;] = None``</div><div class=""> - ``response.menu``: optional parameter that may be included in the views, normally used to pass a navigation menu tree to the view. It can be rendered by the MENU helper.</div><div class=""> - ``response.meta``: a Storage object that contains optional ``&lt;meta&gt;`` information like ``response.meta.author``, ``.description``, and/or ``.keywords``. The content of each meta variable is automatically placed in the proper ``META`` tag by the code in &quot;views/web2py_ajax.html&quot;, which is included by default in &quot;views/layout.html&quot;.</div><div class=""> - ``response.include_meta()`` generates a string that includes all ``response.meta`` headers serialized (used in &quot;views/web2py_ajax.html&quot;).</div><div class=""> - ``response.postprocessing``: this is a list of functions, empty by default. These functions are used to filter the response object at the output of an action, before the output is rendered by the view. It can be used to implement support for other template languages.</div><div class=""> - ``response.render(view, vars)``: a method used to call the view explicitly inside the controller. ``view`` is an optional parameter which is the name of the view file, ``vars`` is a dictionary of named values passed to the view.</div><div class=""> - ``response.session_file``: file stream containing the session.</div><div class=""> - ``response.session_file_name``: name of the file where the session will be saved.</div><div class=""> - ``response.session_id``: the id of the current session. It is determined automatically. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.session_id_name``: the name of the session cookie for this application. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.status``: the HTTP status code integer to be passed to the response. Default is 200 (OK).</div><div class=""> - ``response.stream(file, chunk_size, request=request, attachment=False, filename=None, headers=None)``: when a controller returns it, web2py streams the file content back to the client in blocks of size ``chunk_size``. The ``request`` parameter is required to use the chunk start in the HTTP header. ``file`` should be a file path (for backward compatibility, it can also be an open file object, but this is not recommended). As noted above, ``response.download`` should be used to retrieve files stored via an upload field. ``response.stream`` can be used in other cases, such as returning a temporary file or StringIO object created by the controller. If ``attachment`` is True, the Content-Disposition header will be set to &quot;attachment&quot;, and if ``filename`` is also provided, it will be added to the Content-Disposition header as well (but only when ``attachment`` is True). If not already included in ``response.headers``, the following response headers will be set automatically: Content-Type, Content-Length, Cache-Control, Pragma, and Last-Modified (the latter three are set to allow browser caching of the file). To override any of these automatic header settings, simply set them in ``response.headers`` before calling ``response.stream``.</div><div class=""> - ``response.subtitle``: optional parameter that may be included in the views. It should contain the subtitle of the page.</div><div class="delete">- ``response.title``: optional parameter that may be included in the views. It should contain the title of the page and should be rendered <span class="highlight">by</span> the <span class="highlight">HTML</span> title <span class="highlight">TAG</span> in the header.</div><div class=""> - ``response.toolbar``: a function that allows you to embed a toolbar into page for debugging purposes ``{{=response.toolbar()}}``. The toolbar displays request, response, session variables and database access time for each query.</div><div class="delete">- ``response._vars``: this variable is accessible only in a view, not in the action. It contains the value<span class="highlight"></span> returned by the action to the view.</div><div class=""> - ``response._caller``: this is a function that wraps all action calls. It defaults to the identity function, but it can be modified in order to catch special types of exception to do extra logging;</div><div class="">   ``</div><div class="">   response._caller = lambda f: f()</div><div class="">   ``</div><div class="delete">-- ``response.optimize_css``: if can be set to &quot;concat,minify,inline&quot; to concatenate, minify and inline the CSS files included by web2py.</div><div class="delete">-- ``response.optimize_js``: if can be set to &quot;concat,minify,inline&quot; to concatenate, minify and inline the JavaScript files included by web2py.</div><div class=""> - ``response.view``: the name of the view template that must render the page. This is set by default to:</div><div class="">   ``</div><div class="">   &quot;%s/%s.%s&quot; % (request.controller, request.function, request.extension)</div><div class="">   ``:code</div><div class="">   or, if the above file cannot be located, to</div><div class="">   ``</div><div class="">   &quot;generic.%s&quot; % (request.extension)</div><div class="">   ``:code</div><div class="">   Change the value of this variable to modify the view file associated with a particular action.</div><div class=""> </div><div class=""> - ``response.delimiters`` defaults to ``(&#x27;{{&#x27;,&#x27;}}&#x27;)``. It allows you to change the delimiter of code embedded in views.</div><div class=""> - ``response.xmlrpc(request, methods)``: when a controller returns it, this function exposes the methods via XML-RPC``xmlrpc``:cite . This function is deprecated since a better mechanism is available and described in Chapter 10.</div><div class=""> - ``response.write(text)``: a method to write text into the output page body.</div><div class=""> - ``response.js`` can contain Javascript code. This code will be executed if and only if the response is received by a web2py component as discussed in Chapter 12.</div><div class=""> </div><div class=""> Since ``response`` is a ``gluon.storage.Storage`` object, it can be used to store other attributes that you may want to pass to the view. While there is no technical restriction, our recommendation is to store only variables that are to be rendered by all pages in the overall layout (&quot;layout.html&quot;).</div><div class=""> </div><div class=""> Anyway, we strongly suggest to stick to the variables listed here:</div><div class=""> ``</div><div class=""> response.title</div><div class=""> To **store sessions in cookies** instead you can do:</div><div class=""> ``</div><div class=""> session.connect(request,response,cookie_key=&#x27;yoursecret&#x27;,compression_level=None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Here ``cookie_key`` is a symmetric encryption key.</div><div class=""> ``compression_level`` is an optional ``zlib`` encryption level.</div><div class=""> </div><div class=""> While sessions in cookie are often recommended for scalability reason they are limited in size. Large sessions will result in broken cookies.</div><div class=""> </div><div class=""> You can check the state of your application at any time by printing the ``request``, ``session`` and ``response`` system variables. One way to do it is to create a dedicated action:</div><div class=""> ``</div><div class=""> def status():</div><div class="">     return dict(request=request, session=session, response=response)</div><div class=""> ``:code</div><div class=""> </div><div class=""> In the &quot;generic.html&quot; view this is done using ``{{=response.toolbar()}}``.</div><div class=""> </div><div class=""> </div><div class=""> #### Separate sessions</div><div class=""> </div><div class="delete">-If you are storing sessions on filesystems and you have lots of them, the file system access may become a bottle-neck. One solution is the following:</div><div class="delete">If you are storing sessions on<span class="highlight"></span> filesystem and you have lots of them, the file system access may become a bottle-neck. One solution is the following:</div><div class=""> ``</div><div class=""> session.connect(request, response, separate=True)</div><div class=""> ``:code</div><div class=""> </div><div class=""> By setting ``separate=True`` web2py will store sessions not in the &quot;sessions/&quot; folder but in subfolders of the &quot;sessions/&quot; folder. The subfolder will be created automatically. Sessions with the same prefix will be in the same subfolder. Again, note that the above must be called before any logic that might require the session.</div><div class=""> </div><div class=""> ### ``cache``</div><div class=""> ``cache``:inxx ``cache.ram``:inxx ``cache.disk``:inxx</div><div class=""> ``cache`` a global object also available in the web2py execution environment. It has two attributes:</div><div class=""> - ``cache.ram``: the application cache in main memory.</div><div class=""> - ``cache.disk``: the application cache on disk.</div><div class=""> ``cache`` is callable, this allows it to be used as a decorator for caching actions and views.</div><div class=""> </div><div class=""> The following example caches the ``time.ctime()`` function in RAM:</div><div class=""> ``</div><div class=""> def cache_in_ram():</div><div class="">     import time</div><div class="">     t = cache.ram(&#x27;time&#x27;, lambda: time.ctime(), time_expire=5)</div><div class="">     return dict(time=t, link=A(&#x27;click me&#x27;, _href=request.url))</div><div class=""> ``:code</div><div class=""> message = cache.ram(&#x27;message&#x27;, lambda: &#x27;Goodbye&#x27;, time_expire=20)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Because ``time_expire`` is set to 20 seconds in the second call and only 10 seconds has elapsed since the message was first saved, the value &quot;Hello&quot; will be retrieved from the cache, and it will not be updated with &quot;Goodbye&quot;. The ``time_expire`` value of 5 seconds in the first call has no impact on the second call.</div><div class=""> </div><div class=""> Setting ``time_expire=0`` (or a negative value) forces the cached item to be refreshed (because the elapsed time since the last save will always be &gt; 0), and setting ``time_expire=None`` forces retrieval of the cached value, regardless of the time elapsed since it was saved (if ``time_expire`` is always ``None``, the cached item will effectively never expire).</div><div class=""> </div><div class=""> You can clear one or more cache variables with</div><div class=""> ``cache clear``:inxx</div><div class=""> </div><div class=""> ``</div><div class=""> cache.ram.clear(regex=&#x27;...&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> where ``regex`` is a regular expression matching all the keys you want removed from the cache. You can also clear a single item with:</div><div class=""> ``</div><div class=""> cache.ram(key, None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> where ``key`` is the key of the cached item.</div><div class=""> </div><div class="delete">It is also possible to define other caching mechanisms such as memcache. Memcache is available via ``gluon.contrib.memcache`` and is discussed in more detail<span class="highlight">s</span> in Chapter 14.</div><div class=""> </div><div class=""> ------</div><div class=""> Be careful when caching to remeber that caching is usually at the app-level not at the user level. If you need, for example, to cache user specific content, choose a key that includes the user id.</div><div class=""> ------</div><div class=""> </div><div class=""> #### ``cache.client``</div><div class=""> Web2py by default assumes that the returned content is not going to be cached, as this reduces the shortcomings of an improper caching of the page client-side.</div><div class=""> </div><div class=""> For example, when you show a form to the user, or a list of records, the web page should not be cached, as other users may have inserted new records on the table you are showing.</div><div class=""> </div><div class=""> Instead, if you are showing to the user a wiki page whose content will never change (or it changes once a week), it is useful to store that page, but it is even more useful </div><div class=""> to tell the client that that page is not going to change.</div><div class=""> </div><div class=""> This is accomplished sending out some specific headers along with the page: when the client&#x27;s browser receives the content, it is stored in the browser&#x27;s cache and it will not be requested again</div><div class=""> to your site. Of course this is a **major** speedup for public-facing sites.</div><div class=""> </div><div class=""> Web2py 2.4.4 introduced a new ``cache.client`` decorator to allow a smarter handling of this situation.</div><div class=""> ``cache.client`` can be used:</div><div class=""> - for setting smart cache headers</div><div class=""> - to cache the results accordingly</div><div class=""> redirect(...,type=&#x27;auto&#x27;)</div><div class=""> ``T``:inxx ``internationalization``:inxx</div><div class=""> </div><div class=""> The object ``T`` is the language translator. It constitutes a single global instance of the web2py class ``gluon.language.translator``. All string constants (and only string constants) should be marked by ``T``, for example:</div><div class=""> ``</div><div class=""> a = T(&quot;hello world&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Strings that are marked with ``T`` are identified by web2py as needing language translation and they will be translated when the code (in the model, controller, or view) is executed. If the string to be translated is not a constant but a variable, it will be added to the translation file at runtime (except on GAE) to be translated later.</div><div class=""> </div><div class=""> The ``T`` object can also contain interpolated variables and supports multiple equivalent syntaxes:</div><div class=""> ``</div><div class=""> a = T(&quot;hello %s&quot;, (&#x27;Tim&#x27;,))</div><div class=""> a = T(&quot;hello %(name)s&quot;, dict(name=&#x27;Tim&#x27;))</div><div class=""> a = T(&quot;hello %s&quot;) % (&#x27;Tim&#x27;,)</div><div class=""> a = T(&quot;hello %(name)s&quot;) % dict(name=&#x27;Tim&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The latter syntax is recommended because it makes translation easier.</div><div class=""> The first string is translated according to the requested language file and the ``name`` variable is replaced independently of the language.</div><div class=""> </div><div class="delete">You can concatenat<span class="highlight">ing</span> translated strings and normal strings:</div><div class=""> ``</div><div class=""> T(&quot;blah &quot;) + name + T(&quot; blah&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The following code is also allowed and often preferable:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;blah %(name)s blah&quot;, dict(name=&#x27;Tim&#x27;))</div><div class=""> ``:code</div><div class=""> </div><div class=""> or the alternative syntax</div><div class=""> ``</div><div class=""> T(&quot;blah %(name)s blah&quot;) % dict(name=&#x27;Tim&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> In both cases the translation occurs before the variable name is substituted in the &quot;%(name)s&quot; slot. The following alternative should NOT BE USED:</div><div class=""> ``</div><div class=""> T(&quot;blah %(name)s blah&quot; % dict(name=&#x27;Tim&#x27;))</div><div class=""> ``:code</div><div class=""> </div><div class=""> You can also force a per-string language:</div><div class=""> T(&quot;Hello World&quot;, language=&quot;it-it&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> --------------</div><div class=""> In the case multiple languages are requested, for example &quot;it-it, fr-ft&quot;, web2py tries to locate &quot;it-it.py&quot; and &quot;fr-fr.py&quot; translation files. If none of the requested files is present, it tries to fall back on &quot;it.py&quot; and &quot;fr.py&quot;. If these files are not present it defaults to &quot;default.py&quot;. If this is not present either, it default to no-translation. The more general rule is that web2py tries &quot;xx-xy-yy.py&quot;, &quot;xx-xy.py&quot;, &quot;xx.py&quot;, &quot;default.py&quot; for each of the &quot;xx-xy-yy&quot; accepted languages trying to find the closest match to the visitor&#x27;s preferences.</div><div class=""> -------------</div><div class=""> </div><div class=""> You can turn off translations completely via</div><div class=""> </div><div class=""> ``</div><div class=""> T.force(None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Normally, string translation is evaluated lazily when the view is rendered; hence, the translator ``force`` method should not be called inside a view.</div><div class=""> </div><div class=""> It is possible to disable lazy evaluation via</div><div class=""> ``</div><div class=""> T.lazy = False</div><div class=""> ``:code</div><div class=""> </div><div class="delete">In this way, strings are translated i<span class="highlight">m</span>mediately by the ``T`` operator based on the currently accepted or forced language.</div><div class=""> </div><div class=""> It is also possible to disable lazy evaluation for individual strings:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;Hello World&quot;, lazy=False)</div><div class=""> ``:code</div><div class=""> </div><div class=""> A common issue is the following. The original application is in English. Suppose that there is a translation file (for example Italian, &quot;it-it.py&quot;) and the HTTP client declares that it accepts both English (en) and Italian (it-it) in that order. The following unwanted situation occurs: web2py does not know the default is written in English (en). Therefore, it prefers translating everything into Italian (it-it) because it only found the Italian translation file. If it had not found the &quot;it-it.py&quot; file, it would have used the default language strings (English).</div><div class=""> </div><div class=""> There are two solutions for this problem: create a translation language for English, which would be redundant and unnecessary, or better, tell web2py which languages should use the default language strings (the strings coded into the application). This can be done with:</div><div class=""> ``</div><div class=""> T.set_current_languages(&#x27;en&#x27;, &#x27;en-en&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> It stores in  ``T.current_languages`` a list of languages that do not require translation and forces a reload of the language files.</div><div class=""> </div><div class=""> Notice that &quot;it&quot; and &quot;it-it&quot; are different languages from the point of view of web2py. To support both of them, one would need two translation files, always lower case. The same is true for all other languages.</div><div class=""> </div><div class=""> The currently accepted language is stored in</div><div class=""> ``</div><div class=""> x book(s)</div><div class=""> </div><div class=""> with</div><div class=""> </div><div class=""> ``</div><div class=""> a book (x==1)</div><div class=""> 5 books (x==5)</div><div class=""> ``</div><div class=""> </div><div class=""> English has one singular form and one plural form. The plural form is constructed by adding a &quot;-s&quot; or &quot;-es&quot; or using an exceptional form. web2py provides a way to define pluralization rules for each languages, as well as exceptions to the default rules. In fact web2py already knows pluralization rules for many languages. It knows, for example, that Slovenian has one singular form and 3 plural forms (for x==1, x==3 or x==4 and x&gt;4). These rules are encoded in &quot;gluon/contrib/plural_rules/*.py&quot; files and new files can be created. Explicit pluralizations for words are created by editing pluralization files using the administrative interface.</div><div class=""> </div><div class=""> By default the PS is not activated. It is triggered by the ``symbol`` argument of the ``T`` function. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;You have %s %%{book}&quot;, symbols=10)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Now the PS is activated for the word &quot;book&quot; and for the number 10.</div><div class=""> The result in English will be: &quot;You have 10 books&quot;. Notice that &quot;book&quot; has been pluralized into &quot;books&quot;.</div><div class=""> </div><div class=""> The PS consists of 3 parts:</div><div class="delete">- placeholders ``%%{}`` to mark words in <span class="highlight"></span>``T``<span class="highlight">-messages</span></div><div class=""> - rule to give a decision which word form to use (&quot;rules/plural_rules/*.py&quot;)</div><div class=""> - dictionary with word plural forms (&quot;app/languages/plural-*.py&quot;)</div><div class=""> </div><div class=""> The value of symbols can be a single variable, a list/tuple of variables, or a dictionary.</div><div class=""> </div><div class=""> The placeholder ``%%{}`` consists of 3 parts:</div><div class=""> </div><div class=""> ``</div><div class="delete">%%{[&lt;modifier&gt;]&lt;wor<span class="highlight">l</span>d&gt;[&lt;parameter&gt;]},</div><div class=""> ``</div><div class=""> </div><div class=""> where:</div><div class=""> </div><div class=""> ``</div><div class=""> &lt;modifier&gt;::= ! | !! | !!!</div><div class=""> &lt;word&gt; ::= any word or phrase in singular in lower case (!)</div><div class=""> &lt;parameter&gt; ::= [index] | (key) | (number)</div><div class=""> ``</div><div class=""> </div><div class=""> For example:</div><div class=""> </div><div class=""> - ``%%{word}`` is equivalent to ``%%{word[0]}`` (if no modifiers are used).</div><div class=""> - ``%%{word[index]}`` is used when symbols is a tuple. symbols[index] gives us a number used to make a decision on which word form to choose.</div><div class=""> - ``%%{word(key)}`` is used to get the numeric parameter from symbols[key]</div><div class=""> - ``%%{word(number)}`` allows to set a ``number`` directly (e.g.: ``%%{word(%i)}``)</div><div class=""> - ``%%{?word?number}`` returns &quot;word&quot; if ``number==1``, returns the ``number`` otherwise</div><div class=""> - ``%%{?number} or %%{??number}`` returns ``number`` if ``number!=1``, return nothing otherwise</div><div class=""> </div><div class=""> ``T(&quot;blabla %s %%{word}&quot;, symbols=var)``</div><div class=""> error_handler = dict(application=&#x27;error&#x27;,</div><div class=""> </div><div class=""> If the ``error_handler`` is specified the action is called without user redirection and the handler action will be in charge of dealing with the error. In the event that the error-handling page itself returns an error, web2py will fall back to its old static responses.</div><div class=""> </div><div class=""> </div><div class=""> #### Static asset management</div><div class=""> </div><div class=""> Since version 2.1.0, web2py has the ability to manage static assets.</div><div class=""> </div><div class=""> When an application is in development, static file can change often, therefore web2py sends static files with no cache headers. This has the side-effect of &quot;forcing&quot; the browser to request static files at every request. This results in low performance when loading the page.</div><div class=""> </div><div class=""> In a &quot;production&quot; site, you may want to serve static files with ``cache`` headers to prevent un-necessary downloads since static files do not change.</div><div class=""> </div><div class=""> ``cache`` headers allow the browser to fetch each file only once, thus saving bandwidth and reducing loading time.</div><div class=""> </div><div class=""> Yet there is a problem: What should the cache headers declare? When should the files expire? When the files are first served, the server cannot forecast when they will be changed.</div><div class=""> </div><div class=""> A manual approach consists of creating subfolders for different versions of static files. For example an early version of &quot;layout.css&quot; can be made available at the URL &quot;/myapp/static/css/1.2.3/layout.css&quot;. When you change the file, you create a new subfolder and you link it as &quot;/myapp/static/css/1.2.4/layout.css&quot;.</div><div class=""> </div><div class=""> This procedure works but it is pedantic since every time you update the css file, you must remember to move it to another folder, change the URL of the file in your layout.html and deploy.</div><div class=""> </div><div class="delete">Static asset management solves the problem by allowing the developer to declare a version for a group of static files and they will be requested again only when the version number changes. The <span class="highlight">version number of</span> made part of the file url as in the previous example. The difference from the previous approach is that the version number only appears in the URL, not in the file system.</div><div class=""> </div><div class=""> </div><div class=""> If you want to serve &quot;/myapp/static/layout.css&quot; with the cache headers, you just need to include the file with a modified URL that includes a version number:</div><div class=""> ``</div><div class=""> /myapp/static/_1.2.3/layout.css</div><div class=""> ``</div><div class=""> (notice the URL defines a version number, it does not appear anywhere else).</div><div class=""> </div><div class=""> Notice that the URL starts with &quot;/myapp/static/&quot;, followed by a version number composed by an underscore and 3 integers separated by a period (as described in [[SemVer http://semver.org/]]), then followed by the filename. Also notice that you do not have to create a &quot;_1.2.3/&quot; folder.</div><div class=""> </div><div class=""> Every time the static file is requested with a version in the url, it will be served with &quot;far in the future&quot; cache headers, specifically:</div><div class=""> ``</div><div class=""> Cache-Control : max-age=315360000</div><div class=""> Expires: Thu, 31 Dec 2037 23:59:59 GMT</div><div class=""> ``</div><div class=""> This means that the browser will fetch those files only once, and they will be saved &quot;forever&quot; in the browser&#x27;s cache.</div><div class=""> </div><div class=""> Every time the &quot;_1.2.3/filename&quot; is requested, web2py will remove the version part from the path and serve your file with far in the future headers so they will be cached forever. If you changed the version number in the URL, this tricks the browser into thinking it is requesting a different file, and the file is fetched again.</div><div class=""> </div><div class=""> You can use &quot;_1.2.3&quot;, &quot;_0.0.0&quot;, &quot;_999.888.888&quot;, as long as the version starts with underscore followed by three numbers separated by period.</div><div class=""> By **cron** we refer to a web2py functionality not to the Unix Cron mechanism. T</div><div class=""> web2py cron is the way to go if you need tasks in the background at scheduled times and these tasks take a relatively short time compared to the time interval between two calls. Each task runs in its own process, and multiple tasks can run concurrently, but you have no control over how many tasks run. If accidentally one task overlaps with itself, it can cause a database lock and a spike in memory usage.</div><div class=""> </div><div class=""> web2py scheduler takes a different approach. The number of running processes is fixed, and they can run on different machines. Each process is called a worker. Each worker picks a task when available and executes it as soon as possible after the time when it is scheduled to run, but not necessarily at that exact time. There cannot be more processes running than the number of scheduled tasks and therefore no memory spikes. Scheduler tasks can be defined in models and are stored in the database. The web2py scheduler does not implement a distributed queue since it assumes that the time to distribute tasks is negligible compared with the time to run the tasks. Workers pick up the task from the database.</div><div class=""> </div><div class=""> Homemade tasks queues can be a simpler alternative to the web2py scheduler in some cases.</div><div class=""> </div><div class=""> #### Cron</div><div class=""> ``cron``:inxx</div><div class=""> </div><div class=""> The web2py cron provides the ability for applications to execute tasks at preset times, in a platform-independent manner.</div><div class=""> </div><div class=""> For each application, cron functionality is defined by a crontab file:</div><div class=""> </div><div class=""> ``</div><div class=""> app/cron/crontab</div><div class=""> ``</div><div class=""> </div><div class=""> It follows the syntax defined in ref. ``cron``:cite (with some extensions that are specific to web2py).</div><div class=""> </div><div class=""> ------</div><div class="delete">Before web2py 2.1.1, cron was enabled by default and could be disabled with the ``-N`` command line option<span class="highlight">,</span> Since 2.1.1, cron is disabled by default and can be enabled by the ``-Y`` option. This change was motivated by the desire to push users toward using the new scheduler (which is superior to the cron mechanism) and also because cron may impact on performance.</div><div class=""> ------</div><div class=""> </div><div class=""> This means that every application can have a separate cron configuration and that cron config can be changed from within web2py without affecting the host OS itself.</div><div class=""> </div><div class=""> Here is an example:</div><div class=""> ``</div><div class=""> 0-59/1  *  *  *  *  root python /path/to/python/script.py</div><div class=""> 30      3  *  *  *  root *applications/admin/cron/db_vacuum.py</div><div class=""> */30    *  *  *  *  root **applications/admin/cron/something.py</div><div class=""> @reboot root    *mycontroller/myfunction</div><div class=""> @hourly root    *applications/admin/cron/expire_sessions.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> The last two lines in this example use extensions to regular cron syntax to provide additional web2py functionality.</div><div class=""> </div><div class=""> -------</div><div class=""> The file &quot;applications/admin/cron/expire_sessions.py&quot; actually exists and ships with the **admin** app. It checks for expired sessions and deletes them. &quot;applications/admin/cron/crontab&quot; runs this task hourly.</div><div class=""> -------</div><div class=""> </div><div class="delete">If the task/script is prefixed with an asterisk (``*``) and ends with ``.py``, it will be executed in the web2py environment. This means you will have all the controllers and models at your disposal. If you use two asterisks (``**``), the <span class="highlight">``MODEL``</span>s will not be executed. This is the recommended way of calling, as it has less overhead and avoids potential locking problems.</div><div class=""> </div><div class=""> Notice that scripts/functions executed in the web2py environment require a manual ``db.commit()`` at the end of the function or the transaction will be reverted.</div><div class=""> </div><div class=""> web2py does not generate tickets or meaningful tracebacks in shell mode, which is how cron is run, so make sure that your web2py code runs without errors before you set it up as a cron task as you will likely not be able to see those errors when run from cron. Moreover, be careful how you use models: while the execution happens in a separate process, database locks have to be taken into account in order to avoid pages waiting for cron tasks that may be blocking the database. Use the ``**`` syntax if you don&#x27;t need to use the database in your cron task.</div><div class=""> </div><div class=""> You can also call a controller function, in which case there is no need to specify a path. The controller and function will be that of the invoking application. Take special care about the caveats listed above. Example:</div><div class=""> ``</div><div class=""> */30  *  *  *  *  root *mycontroller/myfunction</div><div class=""> ``:code</div><div class=""> </div><div class=""> If you specify ``@reboot`` in the first field in the crontab file, the given task will be executed only once, at web2py startup. You can use this feature if you want to pre-cache, check, or initialize data for an application on web2py startup. Note that cron tasks are executed in parallel with the application --- if the application is not ready to serve requests until the cron task is finished, you should implement checks to reflect this. Example:</div><div class=""> ``</div><div class=""> @reboot  *  *  *  *  root *mycontroller/myfunction</div><div class=""> ``:code</div><div class=""> </div><div class=""> Depending on how you are invoking web2py, there are four modes of operation for web2py cron.</div><div class=""> - &#x27;&#x27;soft cron&#x27;&#x27;: available under all execution modes</div><div class=""> - &#x27;&#x27;hard cron&#x27;&#x27;: available if using the built-in web server (either directly or via Apache mod_proxy)</div><div class=""> - &#x27;&#x27;external cron&#x27;&#x27;: available if you have access to the system&#x27;s own cron service</div><div class=""> - No cron</div><div class=""> Scheduler(</div><div class="">     migrate=True,</div><div class="">     worker_name=None,</div><div class="">     group_names=None,</div><div class="">     heartbeat=HEARTBEAT,</div><div class="">     max_empty_runs=0,</div><div class="">     discard_results=False,</div><div class="">     utc_time=False</div><div class=""> )</div><div class=""> ``:code</div><div class=""> </div><div class=""> Let&#x27;s see them in order:</div><div class=""> </div><div class=""> - ``db`` is the database DAL instance where you want the scheduler tables be placed.</div><div class=""> - ``tasks`` is a dictionary that maps task names into functions. If you do not pass this parameter, function will be searched in the app environment.</div><div class=""> - ``worker_name`` is None by default. As soon as the worker is started, a worker name is generated as hostname-uuid. If you want to specify that, be sure that it&#x27;s unique.</div><div class=""> - ``group_names`` is by default set to **[main]**. All tasks have a ``group_name`` parameter, set to **main** by default. Workers can only pick up tasks of their assigned group.</div><div class=""> </div><div class=""> ------</div><div class=""> NB: This is useful if you have different workers instances (e.g. on different machines) and you want to assign tasks to a specific worker.</div><div class=""> </div><div class="delete">NB2: It&#x27;s possible to assign a worker more groups, and they can be also all the same, as<span class="highlight"></span></div><div class=""> ------</div><div class="delete">-``[&#x27;mygroup&#x27;,&#x27;mygroup&#x27;]``. Tasks will be distributed taking into consideration that</div><div class="delete">-a worker with group_names ``[&#x27;mygroup&#x27;,&#x27;mygroup&#x27;]`` is able to process the double of the tasks</div><div class="delete"><span class="highlight">a worker with group_names ``[&#x27;mygroup&#x27;]`` is.</span></div><div class=""> - ``heartbeat`` is by default set to 3 seconds. This parameter is the one controlling how often a scheduler will check its status on the ``scheduler_worker`` table and see if there are any **ASSIGNED** tasks to itself to process.</div><div class=""> - ``max_empty_runs`` is 0 by default, that means that the worker will continue to process tasks as soon as they are **ASSIGNED**. If you set this to a value of, let&#x27;s say, 10, a worker will die automatically if it&#x27;s **ACTIVE** and no tasks are **ASSIGNED** to it for 10 loops. A loop is when a worker searches for tasks, every 3 seconds (or the set ``heartbeat``)</div><div class=""> - ``discard_results`` is False by default. If set to True, no scheduler_run records will be created.</div><div class=""> </div><div class=""> ------</div><div class=""> NB: scheduler_run records will be created as before for **FAILED**, **TIMEOUT** and **STOPPED** tasks&#x27;s statuses.</div><div class=""> ------</div><div class=""> </div><div class=""> - ``utc_time`` is False by default. If you need to coordinate with workers living in different timezones, or don&#x27;t have problems with solar/DST times, supplying datetimes from different countries, etc, you can set this to True. The scheduler will honor the UTC time and work leaving the local time aside. Caveat: you need to schedule tasks with UTC times (for start_time, stop_time, and so on.)</div><div class=""> </div><div class=""> Now we have the infrastructure in place: defined the tasks, told the scheduler about them, started the worker(s). What remains is to actually schedule the tasks</div><div class=""> </div><div class=""> </div><div class=""> ##### Tasks</div><div class=""> Tasks can be scheduled programmatically or via appadmin. In fact, a task is scheduled simply by adding an entry in the table &quot;scheduler_task&quot;, which you can access via appadmin:</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/myapp/appadmin/insert/db/scheduler_task</div><div class=""> ``</div><div class=""> </div><div class=""> st.validate_and_insert(function_name=&#x27;demo1&#x27;, vars=json.dumps({&#x27;a&#x27;:1,&#x27;b&#x27;:2}))</div><div class=""> </div><div class=""> Here is a more complex complete example:</div><div class=""> ``</div><div class=""> def task_add(a,b):</div><div class="">     return a+b</div><div class=""> </div><div class=""> secheduler = Scheduler(db, tasks=dict(demo1=task_add))</div><div class=""> </div><div class=""> scheduler.queue_task(&#x27;demo1&#x27;, pvars=dict(a=1,b=2),</div><div class="">                      repeats = 0, period = 180)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Since version 2.4.1 if you pass an additional parameter ``immediate=True`` it will force the main worker to reassign tasks. Until 2.4.1, the worker checks for new tasks every 5 cycles (so, ``5*heartbeats`` seconds). If you had an app that needed to check frequently for new tasks, to get a &#x27;&#x27;snappy&#x27;&#x27; behaviour you were forced to lower the ``heartbeat`` parameter, putting the db under pressure for no reason. With ``immediate=True`` you can force the check for new tasks: it will happen at most as ``heartbeat`` seconds are passed   </div><div class=""> </div><div class=""> A call to ``scheduler.queue_task`` returns the task ``id`` and ``uuid`` of the task you queued (can be the one you passed or the auto-generated one), and possible ``errors``:</div><div class=""> </div><div class=""> ``</div><div class=""> &lt;Row {&#x27;errors&#x27;: {}, &#x27;id&#x27;: 1, &#x27;uuid&#x27;: &#x27;08e6433a-cf07-4cea-a4cb-01f16ae5f414&#x27;}&gt;</div><div class=""> ``</div><div class="">  </div><div class="delete">If there are errors (usually syntax error<span class="highlight"></span> o<span class="highlight">s</span> input validation errors),</div><div class=""> you get the result of the validation, and id and uuid will be None</div><div class=""> </div><div class=""> ``</div><div class=""> &lt;Row {&#x27;errors&#x27;: {&#x27;period&#x27;: &#x27;enter an integer greater than or equal to 0&#x27;}, &#x27;id&#x27;: None, &#x27;uuid&#x27;: None}&gt;</div><div class=""> ``</div><div class=""> </div><div class=""> ##### Results and output</div><div class=""> </div><div class=""> The table &quot;scheduler_run&quot; stores the status of all running tasks. Each record references a task that has been picked up by a worker.  One task can have multiple runs. For example, a task scheduled to repeat 10 times an hour will probably have 10 runs (unless one fails or they take longer than 1 hour). Beware that if the task has no return values, it is removed from the scheduler_run table as soon as it is finished.</div><div class=""> </div><div class=""> Possible run statuses are:</div><div class=""> </div><div class=""> ``</div><div class=""> RUNNING, COMPLETED, FAILED, TIMEOUT</div><div class=""> ``</div><div class=""> </div><div class=""> If the run is completed, no exceptions are thrown, and there is no task timeout, the run is marked as ``COMPLETED`` and the task is marked as ``QUEUED`` or ``COMPLETED`` depending on whether it is supposed to run again at a later time. The output of the task is serialized in JSON and stored in the run record.</div><div class=""> </div><div class=""> When a ``RUNNING`` task throws an exception, the run is mark as ``FAILED`` and the task is marked as ``FAILED``. The traceback is stored in the run record.</div><div class=""> </div><div class=""> Similarly, when a run exceeds the timeout, it is stopped and marked as ``TIMEOUT``, and the task is marked as ``TIMEOUT``.</div><div class=""> </div><div class=""> In any case, the stdout is captured and also logged into the run record.</div><div class=""> </div><div class=""> Using appadmin, one can check all ``RUNNING`` tasks, the output of ``COMPLETED`` tasks, the error of ``FAILED`` tasks, etc.</div><div class=""> </div><div class="delete">-The scheduler also creates one more table called &quot;scheduler_worker&quot;, which stores the workers&#x27; heartbeat and their status. Possible worker statuses are:</div><div class=""> </div><div class=""> ##### Managing processes</div><div class=""> </div><div class=""> Worker fine management is hard. This module tries not to leave behind any platform (Mac, Win, Linux) .</div><div class=""> </div><div class=""> When you start a worker, you may later want to:</div><div class=""> - kill it &quot;no matter what it&#x27;s doing&quot;</div><div class=""> - kill it only if it is not processing tasks</div><div class=""> - put it to sleep</div><div class=""> Maybe you have yet some tasks queued, and you want to save some resources.</div><div class=""> You know you want them processed every hour, so, you&#x27;ll want to:</div><div class=""> - process all queued tasks and die automatically</div><div class=""> All of these things are possible managing ``Scheduler`` parameters or the ``scheduler_worker`` table.</div><div class=""> To be more precise, for started workers you can change the ``status`` value of any worker to influence</div><div class=""> its behavior.</div><div class=""> As for tasks, workers can be in one of the following statuses: ACTIVE, DISABLED, TERMINATE or KILLED.</div><div class=""> </div><div class=""> **ACTIVE** and **DISABLED** are &quot;persistent&quot;, while **TERMINATE** or **KILL**, as statuses</div><div class=""> name suggest, are more &quot;commands&quot; than real statuses.</div><div class=""> Hitting ctrl+c is equal to set a worker to **KILL**</div><div class=""> scheduler.queue_task(</div><div class="">     timeout = 120, # should take less than 120 seconds</div><div class="">     )</div><div class=""> ``:code</div><div class=""> </div><div class=""> Notice that fields &quot;times_run&quot;, &quot;last_run_time&quot; and &quot;assigned_worker_name&quot; are not provided at schedule time but are filled automatically by the workers.</div><div class=""> </div><div class=""> You can also retrieve the output of completed tasks:</div><div class=""> </div><div class=""> ``</div><div class=""> completed_runs = db(db.scheduler_run.run_status=&#x27;COMPLETED&#x27;).select()</div><div class=""> ``:code</div><div class=""> </div><div class=""> ------</div><div class=""> The scheduler is considered experimental because it needs more extensive testing and because the table structure may change as more features are added.</div><div class=""> ------</div><div class=""> </div><div class=""> ##### Reporting percentages</div><div class=""> </div><div class=""> A special &quot;word&quot; encountered in the print statements of your functions clear all</div><div class=""> the previous output. That word is ``!clear!``.</div><div class="delete">-This, coupled with the ``sync_output`` parameter, allows to report percentages</div><div class="delete">-a breeze. </div><div class=""> </div><div class=""> Here is an example:</div><div class=""> </div><div class=""> ``</div><div class=""> def reporting_percentages():</div><div class="">     time.sleep(5)</div><div class="">     print &#x27;50%&#x27;</div><div class="">     time.sleep(5)</div><div class="">     print &#x27;!clear!100%&#x27;</div><div class="">     return 1</div><div class=""> ``</div><div class=""> </div><div class=""> The function ``reporting_percentages`` sleeps for 5 seconds, outputs ``50%``.</div><div class=""> Then, it sleeps other 5 seconds and outputs ``100%``. Note that the output in the scheduler_run table is synced every 2 seconds and that the second print statement that contains ``!clear!100%`` gets the ``50%`` output cleared and replaced by ``100%`` only.</div><div class=""> </div><div class=""> ``</div><div class=""> scheduler.queue_task(reporting_percentages,</div><div class="">                      sync_output=2)</div><div class=""> ``:code</div><div class=""> </div><div class=""> result = other.some_action()</div><div class=""> ``:code</div><div class=""> </div><div class=""> In line 2, ``request=request`` is optional. It has the effect of passing the current request to the environment of &quot;other&quot;. Without this argument, the environment would contain a new and empty (apart from ``request.folder``) request object. It is also possible to pass a response and a session object to ``exec_environment``. Be careful when passing request, response and session objects --- modification by the called action or coding dependencies in the called action could lead to unexpected side effects.</div><div class=""> </div><div class=""> The function call in line 3 does not execute the view; it simply returns the dictionary unless ``response.render`` is called explicitly by &quot;some_action&quot;.</div><div class=""> </div><div class=""> One final caution: don&#x27;t use ``exec_environment`` inappropriately. If you want the results of actions in another application, you probably should implement an XML-RPC API (implementing an XML-RPC API with web2py is almost trivial). Don&#x27;t use ``exec_environment`` as a redirection mechanism; use the ``redirect`` helper.</div><div class=""> </div><div class=""> ### Cooperation</div><div class=""> ``cooperation``:inxx</div><div class=""> </div><div class=""> There are many ways applications can cooperate:</div><div class=""> - Applications can connect to the same database and thus share tables. It is not necessary that all tables in the database are defined by all applications, but they must be defined by those applications that use them. All applications that use the same table, but one, must define the table with ``migrate=False``.</div><div class=""> - Applications can embed components from other applications using the LOAD helper (described in Chapter 12).</div><div class=""> - Applications can share sessions.</div><div class=""> - Applications can call each other&#x27;s actions remotely via XML-RPC.</div><div class=""> - Applications can access each other&#x27;s files via the filesystem (assuming they share the same filesystem).</div><div class=""> - Applications can call each other&#x27;s actions locally using ``exec_environment`` as discussed above.</div><div class=""> - Applications can import each other&#x27;s modules using the syntax:</div><div class=""> ``</div><div class="delete">-from applications.appname.modules import mymodule</div><div class=""> ``:code</div><div class=""> </div><div class=""> - Applications can import any module in the ``PYTHONPATH`` search path, ``sys.path``.</div><div class=""> </div><div class=""> One app can load the session of another app using the command:</div><div class=""> </div><div class=""> ``</div><div class=""> session.connect(request, response, masterapp=&#x27;appname&#x27;, db=db)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Here &quot;appname&quot; is the name of the master application, the one that sets the initial session_id in the cookie. ``db`` is a database connection to the database that contains the session table (``web2py_session``). All apps that share sessions must use the same database for session storage.</div><div class=""> </div><div class="delete">-One application can load a module from another app using</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-import applications.otherapp.modules.othermodule</div><div class="delete">-``:code</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/1c6da8b244c40c1ebea4f3f4774db6d23c2490a4">1c6da8b</a><ul><li>Date : 2013-03-31</li><li>cache.client, thanks Niphlod</li></ul></li></ul>
<div class="row-fluid" id="com_1c6da8b244c40c1ebea4f3f4774db6d23c2490a4">
    <div class="span6"><div class="diff"><div class=""> ``cache view``:inxx</div><div class=""> ``</div><div class=""> @cache(request.env.path_info, time_expire=5, cache_model=cache.ram)</div><div class=""> def cache_controller_and_view():</div><div class="">     import time</div><div class="">     t = time.ctime()</div><div class="">     d = dict(time=t, link=A(&#x27;click to reload&#x27;, _href=request.url))</div><div class="">     return response.render(d)</div><div class=""> ``:code</div><div class=""> ``response.render(d)`` returns the rendered view as a string, which is now cached for 5 seconds. This is the best and fastest way of caching.</div><div class="insert">+------</div><div class="insert">+We recommend to use @cache.client starting from web2py 2.4.4 </div><div class="insert">+------</div><div class=""> </div><div class=""> Note, ``time_expire`` is used to compare the current time with the time the requested object was last saved in the cache. It does not affect future requests. This enables ``time_expire`` to be set dynamically when an object is requested rather than being fixed when the object is saved. For example:</div><div class=""> ``</div><div class=""> message = cache.ram(&#x27;message&#x27;, lambda: &#x27;Hello&#x27;, time_expire=5)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Now, suppose the following call is made 10 seconds after the above call:</div><div class=""> ``</div><div class=""> message = cache.ram(&#x27;message&#x27;, lambda: &#x27;Goodbye&#x27;, time_expire=20)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Because ``time_expire`` is set to 20 seconds in the second call and only 10 seconds has elapsed since the message was first saved, the value &quot;Hello&quot; will be retrieved from the cache, and it will not be updated with &quot;Goodbye&quot;. The ``time_expire`` value of 5 seconds in the first call has no impact on the second call.</div><div class=""> </div><div class=""> Setting ``time_expire=0`` (or a negative value) forces the cached item to be refreshed (because the elapsed time since the last save will always be &gt; 0), and setting ``time_expire=None`` forces retrieval of the cached value, regardless of the time elapsed since it was saved (if ``time_expire`` is always ``None``, the cached item will effectively never expire).</div><div class=""> </div><div class=""> You can clear one or more cache variables with</div><div class=""> ``cache clear``:inxx</div><div class=""> </div><div class=""> ``</div><div class=""> cache.ram.clear(regex=&#x27;...&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> where ``regex`` is a regular expression matching all the keys you want removed from the cache. You can also clear a single item with:</div><div class=""> ``</div><div class=""> cache.ram(key, None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> where ``key`` is the key of the cached item.</div><div class=""> </div><div class=""> It is also possible to define other caching mechanisms such as memcache. Memcache is available via ``gluon.contrib.memcache`` and is discussed in more details in Chapter 14.</div><div class=""> </div><div class=""> ------</div><div class=""> Be careful when caching to remeber that caching is usually at the app-level not at the user level. If you need, for example, to cache user specific content, choose a key that includes the user id.</div><div class=""> ------</div><div class=""> </div><div class="insert">+#### ``cache.client``</div><div class="insert">+Web2py by default assumes that the returned content is not going to be cached, as this reduces the shortcomings of an improper caching of the page client-side.</div><div class="insert">+</div><div class="insert">+For example, when you show a form to the user, or a list of records, the web page should not be cached, as other users may have inserted new records on the table you are showing.</div><div class="insert">+</div><div class="insert">+Instead, if you are showing to the user a wiki page whose content will never change (or it changes once a week), it is useful to store that page, but it is even more useful </div><div class="insert">+to tell the client that that page is not going to change.</div><div class="insert">+</div><div class="insert">+This is accomplished sending out some specific headers along with the page: when the client&#x27;s browser receives the content, it is stored in the browser&#x27;s cache and it will not be requested again</div><div class="insert">+to your site. Of course this is a **major** speedup for public-facing sites.</div><div class="insert">+</div><div class="insert">+Web2py 2.4.4 introduced a new ``cache.client`` decorator to allow a smarter handling of this situation.</div><div class="insert">+``cache.client`` can be used:</div><div class="insert">+- for setting smart cache headers</div><div class="insert">+- to cache the results accordingly</div><div class="insert">+------</div><div class="insert">+NB: it will do one or another or **both**.</div><div class="insert">+------</div><div class="insert">+The main problem with caching a view with ``@cache(request.env.path_info, time_expire=300, cache_model=cache.ram)`` is that request.env.path_info as a key leads to several problems, e.g.</div><div class="insert">++ URL vars are not considered</div><div class="insert">+  -- you cached the result of &#x27;&#x27;/app/default/index?**search=foo**&#x27;&#x27; : for the next 300 seconds &#x27;&#x27;/app/default/index?**search=bar**&#x27;&#x27; will return the exact same thing of &#x27;&#x27;/app/default/index?**search=foo**&#x27;&#x27;</div><div class="insert">++ User is not considered</div><div class="insert">+  -- you user accesses often a page and you choose to cache it. </div><div class="insert">+     However, you cached the result of &#x27;&#x27;/app/default/index&#x27;&#x27; using request.env.path_info as the key, so another user</div><div class="insert">+     will see a page that was not meant for him</div><div class="insert">+  -- you cached a page for &quot;Bill&quot;, but &quot;Bill&quot; accessed the page from the desktop. Now he tries to access it from its phone: if you prepared a template </div><div class="insert">+     for mobile users that is different from the standard one, &quot;Joe&quot; will not see it</div><div class="insert">++ Language is not considered</div><div class="insert">+  -- when you cache the page, if you use T() for some elements, the page will be stored with a fixed translation</div><div class="insert">++ Method is not considered</div><div class="insert">+  -- When you cache a page, you should only cache it if it&#x27;s a result of a GET operation</div><div class="insert">++ Status code is not considered</div><div class="insert">+  -- When you cached the page for the first time, something went wrong and you returned a nice 404 page.</div><div class="insert">+     You don&#x27;t want to cache errors ^_^</div><div class="insert">+</div><div class="insert">+Instead of letting users write a lot of boilerplate code to take care of all those problems, ``cache.client`` was created.</div><div class="insert">+It will by default use smart cache headers to let the browser cache the result: if you pass a cache model to it, it will also figure out the best key automatically, </div><div class="insert">+so different versions of the same page can be stored and retrieved accordingly (e.g. one for English users and one for Spanish ones)</div><div class="insert">+</div><div class="insert">+It takes several parameters, with smart defaults:</div><div class="insert">+</div><div class="insert">+- time_expire : the usual, defaults to 300 seconds</div><div class="insert">+- cache_model : by default is None. This means that @cache.client will **only** alter the default headers to let the client&#x27;s browser cache the content</div><div class="insert">+    -- if you pass, e.g., ``cache.ram``, the result will be stored in the cache as well</div><div class="insert">+- prefix : if you want to prefix the auto-generated key (useful for clearing it later with, e.g. ``cache.ram.clear(prefix*)``)</div><div class="insert">+- session : if you want to consider the session, defaults to False</div><div class="insert">+- vars : if you want to consider URL vars, defaults to True</div><div class="insert">+- lang : if you want to consider the language, defaults to True</div><div class="insert">+- user_agent : if you want to consider the user agent, defaults to False</div><div class="insert">+- public : if you want the same page for all the users that will ever access it, defaults to True</div><div class="insert">+- valid_statuses : defaults to None. cache.client will cache only pages requested with a GET method, whose status codes begin with 1,2 or 3. </div><div class="insert">+  You can pass a list of status codes (when you want pages to be cached with those statuses, e.g. status_codes=[200] will cache only pages</div><div class="insert">+  that resulted in a 200 status code) </div><div class="insert">+- quick : defaults to None, but you can pass a list of initials to set a particular feature:</div><div class="insert">+  -- **S**ession, **V**ars, **L**ang, **U**ser_agent, **P**ublic</div><div class="insert">+     e.g. ``@cache.client(time_expire=300, cache_model=cache.ram, quick=&#x27;SVP&#x27;)`` is the same as</div><div class="insert">+     ``@cache.client(time_expire=300, cache_model=cache.ram, session=True, vars=True, public=True)``</div><div class="insert">+</div><div class="insert">+&quot;Consider&quot; means for e.g. **vars**, that you want to cache different pages if **vars** are different, </div><div class="insert">+so  &#x27;&#x27;/app/default/index?**search=foo**&#x27;&#x27; will not be the same one for &#x27;&#x27;/app/default/index?**search=bar**&#x27;&#x27;</div><div class="insert">+Some settings override others, so, e.g., if you set ``session=True, public=True`` the latter will be discarded.</div><div class="insert">+Use them wisely!</div></div></div>
    <div class="span6"><div class="diff"><div class=""> ``cache view``:inxx</div><div class=""> ``</div><div class=""> @cache(request.env.path_info, time_expire=5, cache_model=cache.ram)</div><div class=""> def cache_controller_and_view():</div><div class="">     import time</div><div class="">     t = time.ctime()</div><div class="">     d = dict(time=t, link=A(&#x27;click to reload&#x27;, _href=request.url))</div><div class="">     return response.render(d)</div><div class=""> ``:code</div><div class=""> ``response.render(d)`` returns the rendered view as a string, which is now cached for 5 seconds. This is the best and fastest way of caching.</div><div class=""> </div><div class=""> Note, ``time_expire`` is used to compare the current time with the time the requested object was last saved in the cache. It does not affect future requests. This enables ``time_expire`` to be set dynamically when an object is requested rather than being fixed when the object is saved. For example:</div><div class=""> ``</div><div class=""> message = cache.ram(&#x27;message&#x27;, lambda: &#x27;Hello&#x27;, time_expire=5)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Now, suppose the following call is made 10 seconds after the above call:</div><div class=""> ``</div><div class=""> message = cache.ram(&#x27;message&#x27;, lambda: &#x27;Goodbye&#x27;, time_expire=20)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Because ``time_expire`` is set to 20 seconds in the second call and only 10 seconds has elapsed since the message was first saved, the value &quot;Hello&quot; will be retrieved from the cache, and it will not be updated with &quot;Goodbye&quot;. The ``time_expire`` value of 5 seconds in the first call has no impact on the second call.</div><div class=""> </div><div class=""> Setting ``time_expire=0`` (or a negative value) forces the cached item to be refreshed (because the elapsed time since the last save will always be &gt; 0), and setting ``time_expire=None`` forces retrieval of the cached value, regardless of the time elapsed since it was saved (if ``time_expire`` is always ``None``, the cached item will effectively never expire).</div><div class=""> </div><div class=""> You can clear one or more cache variables with</div><div class=""> ``cache clear``:inxx</div><div class=""> </div><div class=""> ``</div><div class=""> cache.ram.clear(regex=&#x27;...&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> where ``regex`` is a regular expression matching all the keys you want removed from the cache. You can also clear a single item with:</div><div class=""> ``</div><div class=""> cache.ram(key, None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> where ``key`` is the key of the cached item.</div><div class=""> </div><div class=""> It is also possible to define other caching mechanisms such as memcache. Memcache is available via ``gluon.contrib.memcache`` and is discussed in more details in Chapter 14.</div><div class=""> </div><div class=""> ------</div><div class=""> Be careful when caching to remeber that caching is usually at the app-level not at the user level. If you need, for example, to cache user specific content, choose a key that includes the user id.</div><div class=""> ------</div><div class=""> </div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/9f8f7358720ecddc06a79b90a68cc94ae5b28603">9f8f735</a><ul><li>Date : 2013-02-25</li><li>some edits</li></ul></li></ul>
<div class="row-fluid" id="com_9f8f7358720ecddc06a79b90a68cc94ae5b28603">
    <div class="span6"><div class="diff"><div class="insert"><span class="highlight">T</span>he first time you start web2py and after an upgrade, the &quot;welcome&quot; app is zipped into a &quot;welcome.w2p&quot; file to be used as a scaffolding app.</div><div class=""> -------</div><div class=""> </div><div class=""> When web2py is upgraded it comes with a file called &quot;NEWINSTALL&quot;. If web2py finds this file, it understands an upgrade was performed, hence it removed the file and creates a new &quot;welcome.w2p&quot;.</div><div class=""> </div><div class=""> The current web2py version is stored in the field &quot;VERSION&quot; and it follows standard semantic versioning notation where the build id is the build timestamp.</div><div class=""> </div><div class=""> web2py unit-tests are in</div><div class=""> ``</div><div class=""> gluon/tests/</div><div class=""> ``:code</div><div class=""> </div><div class=""> There are handlers for connecting with various web servers:</div><div class=""> ``</div><div class=""> cgihandler.py       # discouraged</div><div class=""> gaehandler.py       # for Google App Engine</div><div class=""> fcgihandler.py      # for FastCGI</div><div class=""> wsgihandler.py      # for WSGI</div><div class=""> isapiwsgihandler.py # for IIS</div><div class=""> modpythonhandler.py # deprecated</div><div class=""> ``:code</div><div class=""> web2py also contains a folder with useful scripts including</div><div class=""> ``</div><div class=""> scripts/setup-web2py-fedora.sh</div><div class=""> scripts/setup-web2py-ubuntu.sh</div><div class=""> scripts/setup-web2py-nginx-uwsgi-ubuntu.sh</div><div class=""> scripts/setup-web2py-heroku.sh</div><div class=""> scripts/update-web2py.sh</div><div class=""> scripts/make_min_web2py.py</div><div class=""> ...</div><div class=""> scripts/sessions2trash.py</div><div class=""> scripts/sync_languages.py</div><div class=""> scripts/tickets2db.py</div><div class=""> scripts/tickets2email.py</div><div class=""> ...</div><div class=""> scripts/extract_mysql_models.py</div><div class=""> scripts/extract_pgsql_models.py</div><div class=""> ...</div><div class=""> scripts/access.wsgi</div><div class=""> scripts/cpdb.py</div><div class=""> ``:code</div><div class=""> </div><div class="insert">The <span class="highlight">``</span>s<span class="highlight">e</span>t<span class="highlight">up-w</span>e<span class="highlight">b2py-*``</span> are particularly useful because they attempt a complete installation and setup of a web2py production environment from scratch.</div><div class=""> Some of these are discussed in Chapter 14, but all of them contain a documentation string inside that explains their purpose and usage.</div><div class=""> </div><div class=""> Finally web2py includes these files required to build the binary distributions.</div><div class=""> ``</div><div class=""> Makefile</div><div class=""> setup_exe.py</div><div class=""> setup_app.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> These are setup scripts for **py2exe** and **py2app**, respectively, and they are only required to build the binary distributions of web2py. YOU SHOULD NEVER NEED TO RUN THEM.</div><div class=""> </div><div class=""> web2py applications contain additional files, particularly third-party JavaScript libraries, such as jQuery, calendar, and Codemirror. Their authors are acknowledged in the files themselves.</div><div class=""> </div><div class=""> ### Applications</div><div class=""> </div><div class=""> Applications developed in web2py are composed of the following parts:</div><div class=""> - **models** describe a representation of the data as database tables and relations between tables.</div><div class=""> - **controllers** describe the application logic and workflow.</div><div class=""> - **views** describe how data should be presented to the user using HTML and JavaScript.</div><div class=""> - **languages** describe how to translate strings in the application into various supported languages.</div><div class=""> Now from a controller in &quot;myapp&quot; you can do</div><div class=""> import test</div><div class=""> def index():</div><div class="">     return &quot;Your ip is &quot; + test.ip()</div><div class=""> ``</div><div class=""> </div><div class=""> Notice a few things:</div><div class=""> </div><div class=""> - ``import test`` looks for the module first in the current app&#x27;s modules folder, then in the folders listed in ``sys.path``. Therefore, app-level modules always take precedence over Python modules. This allows different apps to ship with different versions of their modules, without conflicts.</div><div class=""> </div><div class=""> - Different users can call the same action ``index`` concurrently, which calls the function in the module, and yet there is no conflict because ``current.request`` is a different object in different threads. Just be careful not to access ``current.request`` outside of functions or classes (i.e., at the top level) in the module.</div><div class=""> </div><div class=""> - ``import test`` is a shortcut for ``from applications.appname.modules import test``. Using the longer syntax, it is possible to import modules from other applications.</div><div class=""> </div><div class=""> For uniformity with normal Python behavior, by default web2py does not reload modules when changes are made. Yet this can be changed. To turn on the auto-reload feature for modules, use the ``track_changes`` function as follows (typically in a model file, before any imports):</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.custom_import import track_changes; track_changes(True)</div><div class=""> ``:code</div><div class=""> </div><div class=""> From now on, every time a module is imported, the importer will check if the Python source file (.py) has changed. If it has changed, the module will be reloaded. </div><div class="insert">+</div><div class="insert">+------</div><div class="insert">+Do not call track_changes in the modules themselves.</div><div class="insert">+------</div><div class="insert">+</div><div class=""> Track changes only tracks changes for modules that are stored in the application.</div><div class=""> Modules that import ``current`` can access:</div><div class=""> - ``current.request``</div><div class=""> - ``current.response``</div><div class=""> - ``current.session``</div><div class=""> - ``current.cache``</div><div class=""> - ``current.T``</div><div class=""> and any other variable your application chooses to store in current. For example a model could do</div><div class=""> </div><div class=""> ``</div><div class=""> auth = Auth(db)</div><div class=""> from gluon import current</div><div class=""> current.auth = auth</div><div class=""> ``</div><div class=""> </div><div class="insert"><span class="highlight">and now all modules imported can access</span> ``current.auth``<span class="highlight">.</span></div><div class=""> </div><div class=""> ``current`` and ``import`` create a powerful mechanism to build extensible and reusable modules for your applications.</div><div class=""> </div><div class=""> -------</div><div class="insert"><span class="highlight">Beware! Given ``from gluon import current``, it is correct to use ``current.request`` and any of the other thread local ob</span>j<span class="highlight">ects but one should ne</span>ve<span class="highlight">r assign them to global </span>v<span class="highlight">ariables in the module</span>, <span class="highlight">such as in</span></div><div class=""> ``</div><div class=""> request = current.request # WRONG! DANGER!</div><div class=""> ``</div><div class=""> nor one should use it assign class attributes</div><div class=""> ``</div><div class=""> class MyClass:</div><div class="">     request = current.request # WRONG! DANGER!</div><div class=""> ``</div><div class=""> This is because the thread local object must be extracted at runtime. Global variables instead are defined only once when the model is imported for the first time.</div><div class=""> -------</div><div class=""> </div><div class=""> Another caveat has to do with cache. You cannot use the ``cache`` object to decorate functions in modules, that is because it would not behave as expected. In order to cache a function ``f`` in a module you must use ``lazy_cache``:</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.cache import lazy_cache</div><div class=""> </div><div class=""> lazy_cache(&#x27;key&#x27;, time_expire=60, cache_model=&#x27;ram&#x27;)</div><div class=""> def f(a,b,c,): ....</div><div class=""> ``:code</div><div class=""> </div><div class=""> The ``request`` object is an instance of the ubiquitous web2py class that is cal</div><div class=""> request.vars</div><div class=""> ``:code</div><div class=""> </div><div class=""> is the same as:</div><div class=""> ``</div><div class=""> request[&#x27;vars&#x27;]</div><div class=""> ``:code</div><div class=""> </div><div class=""> Unlike a dictionary, if an attribute (or key) does not exist, it does not raise an exception. Instead, it returns ``None``.</div><div class=""> </div><div class=""> -----</div><div class=""> It is sometimes useful to create your own Storage objects. You can do so as follows:</div><div class=""> ``</div><div class=""> from gluon.storage import Storage</div><div class=""> my_storage = Storage() # empty storage object</div><div class=""> my_other_storage = Storage(dict(a=1, b=2)) # convert dictionary to Storage</div><div class=""> ``:code</div><div class=""> -----</div><div class=""> </div><div class=""> ``request`` has the following items/attributes, some of which are also an instance of the ``Storage`` class:</div><div class="insert">- ``request.cookies``: a ``Cookie.SimpleCookie()`` object containing the cookies passed with the HTTP request. It acts like a dictionary of cookies. Each cookie is a Morsel object <span class="highlight">``mor</span>se<span class="highlight">l``:ci</span>t<span class="highlight"></span>e.<span class="highlight"></span></div><div class=""> - ``request.env``: a ``Storage`` object containing the environment variables passed to the controller, including HTTP header variables from the HTTP request and standard WSGI parameters. The environment variables are all converted to lower case, and dots are converted to underscores for easier memorization.</div><div class="insert">+- ``request.application``: the name of the requested application.</div><div class="insert">+- ``request.controller``: the name of the requested controller.</div><div class="insert">+- ``request.function``: the name of the requested function.</div><div class=""> - ``request.extension``: the extension of the requested action. It defaults to &quot;html&quot;. If the controller function returns a dictionary and does not specify a view, this is used to determine the extension of the view file that will render the dictionary (parsed from the ``request.env.path_info``).</div><div class=""> - ``request.folder``: the application directory. For example if the application is &quot;welcome&quot;, ``request.folder`` is set to the absolute path &quot;/path/to/welcome&quot;. In your programs, you should always use this variable and the ``os.path.join`` function to build paths to the files you need to access. Although web2py always uses absolute paths, it is a good rule never to explicitly  change the current working folder (whatever that is) since this is not a thread-safe practice.</div><div class=""> - ``request.now``: a ``datetime.datetime`` object storing the datetime of the current request.</div><div class=""> - ``request.utcnow``: a ``datetime.datetime`` object storing the UTC datetime of the current request.</div><div class=""> - ``request.args``: A list of the URL path components following the controller function name; equivalent to ``request.env.path_info.split(&#x27;/&#x27;)[3:]``</div><div class=""> - ``request.vars``: a ``gluon.storage.Storage`` object containing both the HTTP GET and HTTP POST query variables.</div><div class=""> - ``request.get_vars``: a ``gluon.storage.Storage`` object containing only the HTTP GET query variables.</div><div class=""> - ``request.post_vars``: a ``gluon.storage.Storage`` object containing only the HTTP POST query variables.</div><div class=""> - ``request.client``: The ip address of the client as determined by, if present, ``request.env.http_x_forwarded_for`` or by ``request.env.remote_addr`` otherwise. While this is useful it should not be trusted because the ``http_x_forwarded_for`` can be spoofed.</div><div class=""> - ``request.is_local``: ``True`` if the client is localhost, ``False`` otherwise. Should work behind a proxy if the proxy supports ``http_x_forwarded_for``.</div><div class=""> - ``request.is_https``: ``True`` if the request is using the HTTPS protocol, ``False`` otherwise.</div><div class=""> - ``request.body``: a read-only file stream that contains the body of the HTTP request. This is automatically parsed to get the ``request.post_vars`` and then rewinded. It can be read with ``request.body.read()``.</div><div class=""> - ``request.ajax`` is True if the function is being called via an Ajax request.</div><div class=""> - ``request.cid`` is the ``id`` of the component that generated the Ajax request (if any). You can read more about components in Chapter 12.</div><div class=""> - ``request.requires_https()`` prevents further code execution if the request is not over HTTPS and redirects the visitor to the current page over HTTPS.</div><div class=""> - ``request.restful`` this is a new and very useful decorator that can be used to change the default behavior of web2py actions by separating GET/POST/PUSH/DELETE requests. It will be discussed in some detail in Chapter 10.</div><div class=""> - ``request.user_agent()`` parses the user_agent field from the client and returns the information in the form of a dictionary. It is useful to detect mobile devices. It uses &quot;gluon/contrib/user_agent_parser.py&quot; created by Ross Peoples. To see what it does, try to embed the following code in a view:</div><div class=""> ``</div><div class=""> {{=BEAUTIFY(request.user_agent())}}</div><div class=""> ``:code</div><div class=""> Also notice the ``request.env.wsgi_*`` variables. They are specific to the wsgi</div><div class=""> ``response.status``:inxx</div><div class=""> ``response.stream``:inxx</div><div class=""> ``response.subtitle``:inxx</div><div class=""> ``response.title``:inxx</div><div class=""> ``response.toolbar``:inxx</div><div class=""> ``response.view``:inxx</div><div class=""> ``response.delimiters``:inxx</div><div class=""> ``response.js``:inxx</div><div class=""> ``response.write``:inxx</div><div class=""> ``response.include_files``:inxx</div><div class=""> ``response.include_meta``:inxx</div><div class=""> ``response.optimize_css``:inxx</div><div class=""> ``response.optimize_js``:inxx</div><div class=""> ``response._caller``:inxx</div><div class=""> </div><div class=""> ``response`` is another instance of the ``Storage`` class. It contains the following:</div><div class=""> </div><div class=""> - ``response.body``: a ``StringIO`` object into which web2py writes the output page body. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.cookies``: similar to ``request.cookies``, but while the latter contains the cookies sent from the client to the server, the former contains cookies sent by the server to the client. The session cookie is handled automatically.</div><div class=""> - ``response.download(request, db)``: a method used to implement the controller function that allows downloading of uploaded files. ``request.download`` expects the last ``arg`` in ``request.args`` to be the encoded filename (i.e., the filename generated at upload time and stored in the upload field). It extracts the upload field name and table name as well as the original filename from the encoded filename. ``response.download`` takes two optional arguments: ``chunk_size`` sets the size in bytes for chunked streaming (defaults to 64K), and ``attachments`` determines whether the downloaded file should be treated as an attachment or not (default to ``True``). Note, ``response.download`` is specifically for downloading files associated with ``db`` upload fields. Use ``response.stream`` (see below) for other types of file downloads and streaming. Also, note that it is not necessary to use ``response.download`` to access files uploaded to the /static folder -- static files can (and generally should) be accessed directly via URL (e.g., /app/static/files/myfile.pdf).</div><div class="insert">- ``response.files``: a list of <span class="highlight">``.css``, ``</span>.js<span class="highlight">``, ``coffee``, and ``.less``</span> files required by the page. They will automatically be linked in the head of the standard &quot;layout.html&quot; via the included &quot;web2py_ajax.html&quot;. To include a new CSS, JS, COFFEE, or LESS file, just append it to this list. It will handle duplicates. The order is important.</div><div class=""> - ``response.include_files()`` generates html head tags to include all ``response.files`` (used in &quot;views/web2py_ajax.html&quot;).</div><div class=""> - ``response.flash``: optional parameter that may be included in the views. Normally used to notify the user about something that happened.</div><div class=""> - ``response.headers``: a ``dict`` for HTTP response headers. Web2py sets some headers by default, including &quot;Content-Length&quot;, &quot;Content-Type&quot;, and &quot;X-Powered-By&quot; (set equal to web2py). Web2py also sets the &quot;Cache-Control&quot;, &quot;Expires&quot;, and &quot;Pragma&quot; headers to prevent client-side caching, except for static file requests, for which client-side caching is enabled. The headers that web2py sets can be overwritten or removed, and new headers can be added (e.g., ``response.headers[&#x27;Cache-Control&#x27;] = &#x27;private&#x27;``). You can remove a header by removing its key from the response.headers dict, e.g.``del response.headers[&#x27;Custom-Header&#x27;]``, however web2py&#x27;s default headers will be re-added just before returning the response. To avoid this behavior, just set the header value to None, e.g. to remove the default Content-Type header, ``response.headers[&#x27;Content-Type&#x27;] = None``</div><div class=""> - ``response.menu``: optional parameter that may be included in the views, normally used to pass a navigation menu tree to the view. It can be rendered by the MENU helper.</div><div class="insert">- ``response.meta``: a <span class="highlight">S</span>torage object <span class="highlight">that contains optional ``&lt;meta&gt;``</span> information like ``response.meta.author``, ``.description``, and/or ``.keywords``. The content of each meta variable is automatically placed in the proper ``META`` tag by the code in &quot;views/web2py_ajax.html&quot;, which is included by default in &quot;views/layout.html&quot;.</div><div class=""> - ``response.include_meta()`` generates a string that includes all ``response.meta`` headers serialized (used in &quot;views/web2py_ajax.html&quot;).</div><div class=""> - ``response.postprocessing``: this is a list of functions, empty by default. These functions are used to filter the response object at the output of an action, before the output is rendered by the view. It can be used to implement support for other template languages.</div><div class=""> - ``response.render(view, vars)``: a method used to call the view explicitly inside the controller. ``view`` is an optional parameter which is the name of the view file, ``vars`` is a dictionary of named values passed to the view.</div><div class=""> - ``response.session_file``: file stream containing the session.</div><div class=""> - ``response.session_file_name``: name of the file where the session will be saved.</div><div class=""> - ``response.session_id``: the id of the current session. It is determined automatically. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.session_id_name``: the name of the session cookie for this application. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.status``: the HTTP status code integer to be passed to the response. Default is 200 (OK).</div><div class=""> - ``response.stream(file, chunk_size, request=request, attachment=False, filename=None, headers=None)``: when a controller returns it, web2py streams the file content back to the client in blocks of size ``chunk_size``. The ``request`` parameter is required to use the chunk start in the HTTP header. ``file`` should be a file path (for backward compatibility, it can also be an open file object, but this is not recommended). As noted above, ``response.download`` should be used to retrieve files stored via an upload field. ``response.stream`` can be used in other cases, such as returning a temporary file or StringIO object created by the controller. If ``attachment`` is True, the Content-Disposition header will be set to &quot;attachment&quot;, and if ``filename`` is also provided, it will be added to the Content-Disposition header as well (but only when ``attachment`` is True). If not already included in ``response.headers``, the following response headers will be set automatically: Content-Type, Content-Length, Cache-Control, Pragma, and Last-Modified (the latter three are set to allow browser caching of the file). To override any of these automatic header settings, simply set them in ``response.headers`` before calling ``response.stream``.</div><div class=""> - ``response.subtitle``: optional parameter that may be included in the views. It should contain the subtitle of the page.</div><div class=""> - ``response.title``: optional parameter that may be included in the views. It should contain the title of the page and should be rendered by the HTML title TAG in the header.</div><div class=""> - ``response.toolbar``: a function that allows you to embed a toolbar into page for debugging purposes ``{{=response.toolbar()}}``. The toolbar displays request, response, session variables and database access time for each query.</div><div class=""> - ``response._vars``: this variable is accessible only in a view, not in the action. It contains the value returned by the action to the view.</div><div class=""> - ``response._caller``: this is a function that wraps all action calls. It defaults to the identity function, but it can be modified in order to catch special types of exception to do extra logging;</div><div class="">   ``</div><div class="">   response._caller = lambda f: f()</div><div class="">   ``</div><div class=""> - ``response.optimize_css``: if can be set to &quot;concat,minify,inline&quot; to concatenate, minify and inline the CSS files included by web2py.</div><div class=""> - ``response.optimize_js``: if can be set to &quot;concat,minify,inline&quot; to concatenate, minify and inline the JavaScript files included by web2py.</div><div class=""> - ``response.view``: the name of the view template that must render the page. This is set by default to:</div><div class=""> is simply a shortcut for:</div><div class=""> raise HTTP(303,</div><div class="">            &#x27;You are being redirected &lt;a href=&quot;%s&quot;&gt;here&lt;/a&gt;&#x27; % location,</div><div class="">            Location=&#x27;http://www.web2py.com&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The named arguments of the ``HTTP`` initializer method are translated into HTTP header directives, in this case, the redirection target location. ``redirect`` takes an optional second argument, which is the HTTP status code for the redirection (303 by default). Change this number to 307 for a temporary redirect or to 301 for a permanent redirect.</div><div class=""> </div><div class=""> The most common way to use redirect is to redirect to other pages in the same app and (optionally) pass parameters:</div><div class=""> </div><div class=""> ``</div><div class=""> redirect(URL(&#x27;index&#x27;, args=(1,2,3), vars=dict(a=&#x27;b&#x27;)))</div><div class=""> ``:code</div><div class=""> </div><div class=""> In chapter 12 we discuss web2py components. They make Ajax requests to web2py actions. If the called action performs a redirect, you may want the Ajax request to follow the redirect or you may want the entire page performing the Ajax request redirecting. In this latter case you can set:</div><div class=""> </div><div class=""> ``</div><div class=""> redirect(...,type=&#x27;auto&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class="insert">###<span class="highlight"></span> Internationalization, and Pluralization<span class="highlight"> with ``T``</span></div><div class=""> ``T``:inxx ``internationalization``:inxx</div><div class=""> </div><div class=""> The object ``T`` is the language translator. It constitutes a single global instance of the web2py class ``gluon.language.translator``. All string constants (and only string constants) should be marked by ``T``, for example:</div><div class=""> ``</div><div class=""> a = T(&quot;hello world&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Strings that are marked with ``T`` are identified by web2py as needing language translation and they will be translated when the code (in the model, controller, or view) is executed. If the string to be translated is not a constant but a variable, it will be added to the translation file at runtime (except on GAE) to be translated later.</div><div class=""> </div><div class=""> The ``T`` object can also contain interpolated variables and supports multiple equivalent syntaxes:</div><div class=""> ``</div><div class=""> a = T(&quot;hello %s&quot;, (&#x27;Tim&#x27;,))</div><div class=""> a = T(&quot;hello %(name)s&quot;, dict(name=&#x27;Tim&#x27;))</div><div class=""> a = T(&quot;hello %s&quot;) % (&#x27;Tim&#x27;,)</div><div class=""> a = T(&quot;hello %(name)s&quot;) % dict(name=&#x27;Tim&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The latter syntax is recommended because it makes translation easier.</div><div class=""> The first string is translated according to the requested language file and the ``name`` variable is replaced independently of the language.</div><div class=""> </div><div class=""> T(&quot;Hello World&quot;, lazy=False)</div><div class=""> ``:code</div><div class=""> </div><div class=""> A common issue is the following. The original application is in English. Suppose that there is a translation file (for example Italian, &quot;it-it.py&quot;) and the HTTP client declares that it accepts both English (en) and Italian (it-it) in that order. The following unwanted situation occurs: web2py does not know the default is written in English (en). Therefore, it prefers translating everything into Italian (it-it) because it only found the Italian translation file. If it had not found the &quot;it-it.py&quot; file, it would have used the default language strings (English).</div><div class=""> </div><div class=""> There are two solutions for this problem: create a translation language for English, which would be redundant and unnecessary, or better, tell web2py which languages should use the default language strings (the strings coded into the application). This can be done with:</div><div class=""> ``</div><div class=""> T.set_current_languages(&#x27;en&#x27;, &#x27;en-en&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> It stores in  ``T.current_languages`` a list of languages that do not require translation and forces a reload of the language files.</div><div class=""> </div><div class=""> Notice that &quot;it&quot; and &quot;it-it&quot; are different languages from the point of view of web2py. To support both of them, one would need two translation files, always lower case. The same is true for all other languages.</div><div class=""> </div><div class=""> The currently accepted language is stored in</div><div class=""> ``</div><div class=""> T.accepted_language</div><div class=""> ``:code</div><div class=""> </div><div class=""> #### Translating variables</div><div class=""> </div><div class="insert"><span class="highlight"></span>T(...) does not <span class="highlight">only</span> translate strings but <span class="highlight">it </span>can also trans<span class="highlight"></span>ate<span class="highlight"> values store</span>d<span class="highlight"> in</span> variables:</div><div class=""> ``</div><div class=""> &gt;&gt;&gt; a=&quot;test&quot;</div><div class=""> &gt;&gt;&gt; print T(a)</div><div class=""> ``:code</div><div class=""> </div><div class=""> In this case the word &quot;test&quot; is translated but, if not found and if the filesystem is writable, it will add it to the list of words to be translated in the language file.</div><div class=""> </div><div class=""> Notice that this can result in lots of file IO and you may want to disable it:</div><div class=""> </div><div class=""> ``</div><div class=""> T.is_writable = False</div><div class=""> ``:code</div><div class=""> </div><div class=""> prevents T from dynamically updating language files.</div><div class=""> </div><div class=""> #### Comments and multiple translations</div><div class=""> </div><div class=""> It is possible that the same string appears in different contexts in the application and needs different translations based on context. In order to do this, one can add comments to the original string. The comments will not be rendered but will be used by web2py to determine the most appropriate translation. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;hello world ## first occurrence&quot;)</div><div class=""> T(&quot;hello world ## second occurrence&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The text following the ``##``, including the double ``##``, are comments.</div><div class=""> </div><div class=""> #### Pluralization engine</div><div class=""> </div><div class=""> Since version 2.0, web2py includes a powerful pluralization system (PS). This means that when text marked for translation depends on a numeric variable, it may be translated differently based on the numeric value. For example in English we may render:</div><div class=""> </div><div class=""> ``</div><div class=""> x book(s)</div><div class=""> ``</div><div class=""> </div><div class=""> with</div><div class=""> </div><div class=""> ``</div><div class="insert">+a book (x==1)</div><div class="insert">+5 books (x==5)</div><div class=""> ``</div><div class=""> </div><div class=""> English has one singular form and one plural form. The plural form is constructed by adding a &quot;-s&quot; or &quot;-es&quot; or using an exceptional form. web2py provides a way to define pluralization rules for each languages, as well as exceptions to the default rules. In fact web2py already knows pluralization rules for many languages. It knows, for example, that Slovenian has one singular form and 3 plural forms (for x==1, x==3 or x==4 and x&gt;4). These rules are encoded in &quot;gluon/contrib/plural_rules/*.py&quot; files and new files can be created. Explicit pluralizations for words are created by editing pluralization files using the administrative interface.</div><div class=""> </div><div class=""> By default the PS is not activated. It is triggered by the ``symbol`` argument of the ``T`` function. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;You have %s %%{book}&quot;, symbols=10)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Now the PS is activated for the word &quot;book&quot; and for the number 10.</div><div class=""> The result in English will be: &quot;You have 10 books&quot;. Notice that &quot;book&quot; has been pluralized into &quot;books&quot;.</div><div class=""> </div><div class=""> The PS consists of 3 parts:</div><div class=""> - placeholders ``%%{}`` to mark words in ``T``-messages</div><div class=""> - rule to give a decision which word form to use (&quot;rules/plural_rules/*.py&quot;)</div><div class=""> - dictionary with word plural forms (&quot;app/languages/plural-*.py&quot;)</div><div class=""> </div><div class=""> The value of symbols can be a single variable, a list/tuple of variables, or a dictionary.</div><div class=""> </div><div class=""> The placeholder ``%%{}`` consists of 3 parts:</div><div class=""> </div><div class=""> ``</div><div class=""> %%{[&lt;modifier&gt;]&lt;world&gt;[&lt;parameter&gt;]},</div><div class=""> ``</div><div class=""> </div><div class=""> where:</div><div class=""> </div><div class=""> ``</div><div class=""> &lt;modifier&gt;::= ! | !! | !!!</div><div class=""> &lt;word&gt; ::= any word or phrase in singular in lower case (!)</div><div class=""> &lt;parameter&gt; ::= [index] | (key) | (number)</div><div class=""> ``</div><div class=""> </div><div class=""> For example:</div><div class=""> </div><div class="insert">- ``%%{word}`` is equivalent to <span class="highlight">``</span>%%{word[0]}<span class="highlight">``</span> (if no modifiers are used).</div><div class=""> - ``%%{word[index]}`` is used when symbols is a tuple. symbols[index] gives us a number used to make a decision on which word form to choose.</div><div class=""> - ``%%{word(key)}`` is used to get the numeric parameter from symbols[key]</div><div class=""> - ``%%{word(number)}`` allows to set a ``number`` directly (e.g.: ``%%{word(%i)}``)</div><div class=""> - ``%%{?word?number}`` returns &quot;word&quot; if ``number==1``, returns the ``number`` otherwise</div><div class=""> - ``%%{?number} or %%{??number}`` returns ``number`` if ``number!=1``, return nothing otherwise</div><div class=""> </div><div class=""> ``T(&quot;blabla %s %%{word}&quot;, symbols=var)``</div><div class=""> </div><div class=""> ``%%{word}`` by default means ``%%{word[0]}``,</div><div class=""> where ``[0]`` is an item index in symbols tuple.</div><div class=""> </div><div class=""> ``T(&quot;blabla %s %s %%{word[1]}&quot;, (var1, var2))``</div><div class=""> PS is used for &quot;word&quot; and var2 respectively.</div><div class=""> </div><div class="insert">You can use several <span class="highlight">``</span>%%{}<span class="highlight">``</span> placeholders with one index:</div><div class=""> </div><div class=""> ``T(&quot;%%{this} %%{is} %s %%{book}&quot;, var)``</div><div class=""> </div><div class=""> or</div><div class=""> </div><div class=""> ``T(&quot;%%{this[0]} %%{is[0]} %s %%{book[0]}&quot;, var)``</div><div class=""> </div><div class="insert"><span class="highlight">They g</span>enerate:</div><div class=""> </div><div class=""> ``</div><div class=""> var  output</div><div class=""> ------------------</div><div class="">  1   this is 1 book</div><div class="">  2   these are 2 books</div><div class="">  3   these are 2 books</div><div class=""> ``</div><div class=""> </div><div class=""> Similarly you can pass a dictionary to symbols:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;blabla %(var1)s %(wordcnt)s %%{word(wordcnt)}&quot;,</div><div class="">   dict(var1=&quot;tututu&quot;, wordcnt=20))</div><div class=""> ``</div><div class=""> </div><div class=""> which produces</div><div class=""> </div><div class=""> ``</div><div class=""> blabla tututu 20 words</div><div class=""> For example</div><div class=""> </div><div class=""> ``T(&quot;%%{this} %%{is} %%{?a?%s} %%{book}&quot;, var)``</div><div class=""> </div><div class=""> produces:</div><div class=""> </div><div class=""> ``</div><div class=""> var  output</div><div class=""> ------------------</div><div class="">  1   this is a book</div><div class="">  2   these are 2 books</div><div class="">  3   these are 3 books</div><div class="">  ...</div><div class=""> ``</div><div class=""> </div><div class=""> Inside ``%%{...}`` you can also use the following modifiers:</div><div class=""> </div><div class=""> - ``!`` to capitalize the text (equivalent to ``string.capitalize``)</div><div class=""> - ``!!`` to capitalize every word (equivalent to ``string.title``)</div><div class=""> - ``!!!`` to capitalize every character (equivalent to ``string.upper``)</div><div class=""> </div><div class="insert">Notice you can use <span class="highlight"></span>\<span class="highlight"></span> to escape ``!`` and ``?``.</div><div class=""> </div><div class=""> #### Translations, pluralization, and MARKMIN</div><div class=""> </div><div class=""> You can also use the powerful MARKMIN syntax inside translation strings by replacing</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;hello world&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> with</div><div class=""> </div><div class=""> ``</div><div class=""> T.M(&quot;hello world&quot;)</div><div class=""> ``</div><div class=""> </div><div class=""> Now the string accepts MARKMIN markup as described later in the book. You can also use the pluralization system inside MARKMIN.</div><div class=""> </div><div class=""> ### Cookies</div><div class=""> </div><div class=""> ``cookies``:inxx</div><div class=""> Here are four ways to set the default application:</div><div class=""> - Make a symbolic link from &quot;applications/init&quot; to your application&#x27;s folder.</div><div class=""> - Use URL rewrite as discussed in the next section.</div><div class=""> </div><div class=""> ### URL rewrite</div><div class=""> ``url rewrite``:inxx</div><div class=""> ``routes_in``:inxx</div><div class=""> ``routes_out``:inxx</div><div class=""> </div><div class=""> web2py has the ability to rewrite the URL path of incoming requests prior to calling the controller action (URL mapping), and conversely, web2py can rewrite the URL path generated by the ``URL`` function (reverse URL mapping). One reason to do this is for handling legacy URLs, another is to simplify paths and make them shorter.</div><div class=""> </div><div class=""> web2py includes two distinct URL rewrite systems: an easy-to-use &#x27;&#x27;parameter-based&#x27;&#x27; system for most use cases, and a flexible &#x27;&#x27;pattern-based&#x27;&#x27; system for more complex cases. To specify the URL rewrite rules, create a new file in the &quot;web2py&quot; folder called ``routes.py`` (the contents of ``routes.py`` will depend on which of the two rewrite systems you choose, as described in the next two sections). The two systems cannot be mixed.</div><div class=""> </div><div class=""> -------</div><div class=""> Notice that if you edit routes.py, you must reload it. This can be done in two ways: by restarting the web server or by clicking on the routes reload button in admin. If there is a bug in routes, they will not reload.</div><div class=""> -------</div><div class=""> </div><div class=""> #### Parameter-based system</div><div class=""> </div><div class=""> The parameter-based (parametric) router provides easy access to several &quot;canned&quot; URL-rewrite methods. Its capabilities include:</div><div class=""> </div><div class="insert">+- Omitting default application, controller and function names from externally-visible URLs (those created by the URL() function)</div><div class="insert">+- Mapping domains (and/or ports) to applications or controllers</div><div class="insert">+- Embedding a language selector in the URL</div><div class="insert">+- Removing a fixed prefix from incoming URLs and adding it back to outgoing URLs</div><div class="insert">+- Mapping root files such as /robots.txt to an applications static directory</div><div class=""> </div><div class=""> The parametric router also provides somewhat more flexible validation of incoming URLs.</div><div class=""> </div><div class=""> Suppose you&#x27;ve written an application called ``myapp`` and wish to make it the default, so that the application name is no longer part of the URL as seen by the user. Your default controller is still ``default``, and you want to remove its name from user-visible URLs as well. Here&#x27;s what you put in ``routes.py``:</div><div class=""> ``</div><div class=""> routers = dict(</div><div class="">   BASE  = dict(default_application=&#x27;myapp&#x27;),</div><div class=""> )</div><div class=""> ``:code</div><div class=""> </div><div class=""> That&#x27;s it. The parametric router is smart enough to know how to do the right thing with URLs such as:</div><div class=""> ``</div><div class=""> http://domain.com/myapp/default/myapp</div><div class=""> ``:code</div><div class=""> or</div><div class=""> ``</div><div class=""> http://domain.com/myapp/myapp/index</div><div class=""> ``:code</div><div class=""> where normal shortening would be ambiguous. If you have two applications, ``myapp`` and ``myapp2``, you&#x27;ll get the same effect, and additionally ``myapp2``&#x27;s default controller will be stripped from the URL whenever it&#x27;s safe (which is mostly all the time).</div><div class=""> </div><div class=""> AliasMatch ^/([^/]+)/static/(?:/_[\d]+\.[\d]+\.[\d]+)?(.*) \</div><div class="">    /home/www-data/web2py/applications/$1/static/$2</div><div class=""> ``</div><div class=""> </div><div class=""> Similarly, in Nginx change this:</div><div class=""> ``</div><div class=""> location ~* /(\w+)/static/ {</div><div class="">     root /home/www-data/web2py/applications/;</div><div class="">     expires max;</div><div class=""> }</div><div class=""> ``</div><div class=""> into this:</div><div class=""> ``</div><div class=""> location ~* /(\w+)/static(?:/_[\d]+\.[\d]+\.[\d]+)?/(.*)$ {</div><div class="">    alias /home/www-data/web2py/applications/$1/static/$2;</div><div class="">    expires max;</div><div class=""> }</div><div class=""> ``</div><div class=""> </div><div class=""> ### Running tasks in the background</div><div class=""> </div><div class="insert">In web2py, every <span class="highlight">HTTP</span> request is served in its own thread. Threads are recycled for efficiency and managed by the web server. For security, the web server sets a time-out on each request. This means that actions should not run tasks that take too long, should not create new threads, and should not fork processes (it is possible but not recommended).</div><div class=""> </div><div class=""> The proper way to run time-consuming tasks is doing it in the background. There is not a single way of doing it, but here we describe three mechanisms that are built into web2py: **cron**, **homemade task queues**, and **scheduler**.</div><div class=""> </div><div class=""> By **cron** we refer to a web2py functionality not to the Unix Cron mechanism. The web2py cron works on windows too.</div><div class=""> </div><div class=""> web2py cron is the way to go if you need tasks in the background at scheduled times and these tasks take a relatively short time compared to the time interval between two calls. Each task runs in its own process, and multiple tasks can run concurrently, but you have no control over how many tasks run. If accidentally one task overlaps with itself, it can cause a database lock and a spike in memory usage.</div><div class=""> </div><div class=""> web2py scheduler takes a different approach. The number of running processes is fixed, and they can run on different machines. Each process is called a worker. Each worker picks a task when available and executes it as soon as possible after the time when it is scheduled to run, but not necessarily at that exact time. There cannot be more processes running than the number of scheduled tasks and therefore no memory spikes. Scheduler tasks can be defined in models and are stored in the database. The web2py scheduler does not implement a distributed queue since it assumes that the time to distribute tasks is negligible compared with the time to run the tasks. Workers pick up the task from the database.</div><div class=""> </div><div class=""> Homemade tasks queues can be a simpler alternative to the web2py scheduler in some cases.</div><div class=""> </div><div class=""> #### Cron</div><div class=""> ``cron``:inxx</div><div class=""> </div><div class=""> The web2py cron provides the ability for applications to execute tasks at preset times, in a platform-independent manner.</div><div class=""> </div><div class=""> For each application, cron functionality is defined by a crontab file:</div><div class=""> </div><div class=""> ``</div><div class=""> app/cron/crontab</div><div class=""> Example of line to add to the system crontab, (usually /etc/crontab):</div><div class=""> </div><div class=""> With external ``cron``, make sure to add either ``-J`` (or ``--cronjob``, which is the same) as indicated above so that web2py knows that task is executed by cron. Web2py sets this internally with soft and hard ``cron``.</div><div class=""> </div><div class=""> #### Homemade task queues</div><div class=""> </div><div class=""> While cron is useful to run tasks at regular time intervals, it is not always the best solution to run a background task. For this purpose web2py provides the ability to run any python script as if it were inside a controller:</div><div class=""> ``</div><div class=""> python web2py.py -S app -M -R applications/app/private/myscript.py -A a b c</div><div class=""> ``:code</div><div class=""> </div><div class=""> where ``-S app`` tells web2py to run &quot;myscript.py&quot; as &quot;app&quot;, ``-M`` tells web2py to execute models, and ``-A a b c`` passes optional command line arguments ``sys.args=[&#x27;a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;]`` to &quot;myscript.py&quot;.</div><div class=""> </div><div class=""> This type of background process should not be executed via cron (except perhaps for cron @reboot) because you need to be sure that no more than one instance is running at the same time. With cron it is possible that a process starts at cron iteration 1 and is not completed by cron iteration 2, so cron starts it again, and again, and again - thus jamming the mail server.</div><div class=""> </div><div class=""> In chapter 8, we will provide an example of how to use the above method to send emails.</div><div class=""> </div><div class=""> </div><div class=""> #### Scheduler (experimental)</div><div class=""> </div><div class=""> The web2py scheduler works very much like the task queue described in the previous sub-section with some differences:</div><div class="insert">- It provides a standard mechanism for creating<span class="highlight">,</span> scheduling<span class="highlight">, and monitoring</span> tasks.</div><div class=""> - There is not a single background process but a set of workers processes.</div><div class=""> - The job of worker nodes can be monitored because their state, as well as the state of the tasks, is stored in the database.</div><div class=""> - It works without web2py but that is not documented here.</div><div class=""> </div><div class=""> The scheduler does not use cron, although one can use cron @reboot to start the worker nodes.</div><div class=""> </div><div class=""> More information about deploying the scheduler under Linux and Windows is in the Deployment recipes chapter.</div><div class=""> </div><div class=""> In the scheduler, a task is simply a function defined in a model (or in a module and imported by a model). For example:</div><div class=""> </div><div class=""> ``</div><div class=""> def task_add(a,b):</div><div class="">     return a+b</div><div class=""> ``:code</div><div class=""> </div><div class=""> Tasks will always be called in the same environment seen by controllers and therefore they see all the global variables defined in models, including database connections (``db``). Tasks differ from a controller action because they are not associated with an HTTP request and therefore there is no ``request.env``.</div><div class=""> </div><div class=""> ------</div><div class="insert"><span class="highlight">Remember to call ``</span>db.commit()<span class="highlight">``</span> at the end of every task if it involves inserts/updates to the database. <span class="highlight">w</span>eb2py commits by default at the end of a successful <span class="highlight">action but the scheduler tasks are not actions.</span></div><div class=""> ------</div><div class=""> </div><div class="insert">To enable the scheduler you <span class="highlight">mu</span>s<span class="highlight"></span>t<span class="highlight"></span> instantiat<span class="highlight">e the Scheduler class </span>i<span class="highlight">n a m</span>o<span class="highlight">del</span>.</div><div class=""> The recommended way to enable the scheduler to your app is to create a model file named ``scheduler.py`` and define your function there. After the functions, you can put the following code into the model:</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.scheduler import Scheduler</div><div class=""> scheduler = Scheduler(db)</div><div class=""> ``:code</div><div class=""> </div><div class="insert"><span class="highlight"></span>If your tasks are defined in a module (as opposed to a model) you may have to restart the workers.</div><div class=""> </div><div class=""> The task is scheduled with</div><div class=""> </div><div class=""> ``</div><div class=""> scheduler.queue_task(task_add,pvars=dict(a=1,b=2))</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> ##### Parameters</div><div class=""> </div><div class=""> The first argument of the ``Scheduler`` class must be the database to be used by the scheduler to communicate with the workers. This can be the ``db`` of the app or another dedicated ``db``, perhaps one shared by multiple apps. If you use SQLite it&#x27;s recommended to use a separate db from the one used by your app in order to keep the app responsive.</div><div class=""> Once the tasks are defined and the ``Scheduler`` is instantiated, all that is needed to do is to start the workers. You can do that in several ways:</div><div class=""> </div><div class=""> ``</div><div class=""> python web2py.py -K myapp</div><div class=""> ``</div><div class=""> starts a worker for the app ``myapp``. If you want start multiple workers for the same app, you can do so just passing ``myapp,myapp``. You can pass also the ``group_names`` (overriding the one set in your model) with</div><div class=""> </div><div class=""> ``</div><div class=""> python web2py.py -K myapp:group1:group2,myotherapp:group1</div><div class=""> You can pass the usual parameters (-i, -p, here -a prevents the window from show</div><div class=""> </div><div class=""> Scheduler&#x27;s complete signature is:</div><div class=""> </div><div class=""> ``</div><div class=""> Scheduler(</div><div class="">     db,</div><div class="">     tasks=None,</div><div class="">     migrate=True,</div><div class="">     worker_name=None,</div><div class="">     group_names=None,</div><div class="">     heartbeat=HEARTBEAT,</div><div class="">     max_empty_runs=0,</div><div class="">     discard_results=False,</div><div class="">     utc_time=False</div><div class=""> )</div><div class=""> ``:code</div><div class=""> </div><div class=""> Let&#x27;s see them in order:</div><div class=""> </div><div class=""> - ``db`` is the database DAL instance where you want the scheduler tables be placed.</div><div class="insert">- ``tasks`` <span class="highlight">is</span> a dict<span class="highlight">ionary</span> <span class="highlight">tha</span>t <span class="highlight">maps task nam</span>e<span class="highlight">s</span> <span class="highlight"></span>in<span class="highlight"></span>to<span class="highlight"></span> function<span class="highlight"></span>s<span class="highlight"></span>. If you do<span class="highlight"> </span>n<span class="highlight">o</span>t pass this parameter, function will be searched in the app environment.</div><div class=""> - ``worker_name`` is None by default. As soon as the worker is started, a worker name is generated as hostname-uuid. If you want to specify that, be sure that it&#x27;s unique.</div><div class=""> - ``group_names`` is by default set to **[main]**. All tasks have a ``group_name`` parameter, set to **main** by default. Workers can only pick up tasks of their assigned group.</div><div class=""> </div><div class=""> ------</div><div class=""> NB: This is useful if you have different workers instances (e.g. on different machines) and you want to assign tasks to a specific worker.</div><div class=""> </div><div class=""> NB2: It&#x27;s possible to assign a worker more groups, and they can be also all the same, as</div><div class=""> ------</div><div class=""> ``[&#x27;mygroup&#x27;,&#x27;mygroup&#x27;]``. Tasks will be distributed taking into consideration that</div><div class=""> a worker with group_names ``[&#x27;mygroup&#x27;,&#x27;mygroup&#x27;]`` is able to process the double of the tasks</div><div class=""> a worker with group_names ``[&#x27;mygroup&#x27;]`` is.</div><div class=""> - ``heartbeat`` is by default set to 3 seconds. This parameter is the one controlling how often a scheduler will check its status on the ``scheduler_worker`` table and see if there are any **ASSIGNED** tasks to itself to process.</div><div class=""> - ``max_empty_runs`` is 0 by default, that means that the worker will continue to process tasks as soon as they are **ASSIGNED**. If you set this to a value of, let&#x27;s say, 10, a worker will die automatically if it&#x27;s **ACTIVE** and no tasks are **ASSIGNED** to it for 10 loops. A loop is when a worker searches for tasks, every 3 seconds (or the set ``heartbeat``)</div><div class=""> - ``discard_results`` is False by default. If set to True, no scheduler_run records will be created.</div><div class=""> </div><div class=""> ------</div><div class=""> NB: scheduler_run records will be created as before for **FAILED**, **TIMEOUT** and **STOPPED** tasks&#x27;s statuses.</div><div class=""> ------</div><div class=""> </div><div class=""> - ``utc_time`` is False by default. If you need to coordinate with workers living in different timezones, or don&#x27;t have problems with solar/DST times, supplying datetimes from different countries, etc, you can set this to True. The scheduler will honor the UTC time and work leaving the local time aside. Caveat: you need to schedule tasks with UTC times (for start_time, stop_time, and so on.)</div><div class=""> http://127.0.0.1:8000/myapp/appadmin/insert/db/scheduler_task</div><div class=""> The meaning of the fields in this table is obvious. The &quot;args&quot; and &quot;vars&quot;&quot; fields are the values to be passed to the task in JSON format. In the case of the &quot;task_add&quot; above, an example of &quot;args&quot; and &quot;vars&quot; could be:</div><div class=""> </div><div class=""> ``</div><div class=""> args = [3, 4]</div><div class=""> vars = {}</div><div class=""> ``:code</div><div class=""> </div><div class=""> or</div><div class=""> </div><div class=""> ``</div><div class=""> args = []</div><div class=""> vars = {&#x27;a&#x27;:3, &#x27;b&#x27;:4}</div><div class=""> ``:code</div><div class=""> </div><div class=""> The ``scheduler_task`` table is the one where tasks are organized.</div><div class=""> </div><div class=""> All tasks follow a lifecycle</div><div class=""> </div><div class=""> [[scheduler tasks @///image/ce8edcc3.png center]]</div><div class=""> </div><div class="insert">+By default, when you send a task to the scheduler, </div><div class="insert">+it is in the **QUEUED** status.</div><div class=""> If you need it to be executed later, use the ``start_time`` parameter (default = now).</div><div class="insert">+If for some reason you need to be sure that the task does not </div><div class="insert">+get executed after a certain point in time (maybe a request to a web service</div><div class=""> that shuts down at 1AM, a mail that needs to be sent not after the working hours, etc...) you can set a ``stop_time`` (default = None) for it.</div><div class="insert">+If your task is NOT picked up by a worker before ``stop_time``, it will be set as **EXPIRED**.</div><div class="insert">+Tasks with no ``stop_time`` set or picked up **BEFORE** stop_time are **ASSIGNED** to a worker. When a workers picks up a task, its status is set to **RUNNING**.</div><div class="insert">+</div><div class=""> **RUNNING** tasks may end up:</div><div class="insert">+- **TIMEOUT** when more than ``n`` seconds passed with ``timeout`` parameter (default = 60 seconds).</div><div class="insert">+- **FAILED** when an exception is detected,</div><div class="insert">+- **COMPLETED** when they successfully complete.</div><div class=""> </div><div class=""> Values for ``start_time`` and ``stop_time`` should be datetime objects. To schedule &quot;mytask&quot; to run at 30 seconds from the current time, for example, you would do the following:</div><div class=""> </div><div class=""> ``</div><div class=""> from datetime import timedelta as timed</div><div class=""> scheduler.queue_task(&#x27;mytask&#x27;,</div><div class="">     start_time=request.now + timed(seconds=30))</div><div class=""> ``:code</div><div class=""> </div><div class=""> Additionally, you can control how many times a task should be repeated (i.e. you need to aggregate some data at specified intervals). To do so, set the ``repeats``</div><div class=""> parameter (default = 1 time only, 0 = unlimited). You can influence how many seconds should pass between executions with the ``period`` parameter (default = 60 seconds).</div><div class=""> </div><div class=""> ------</div><div class="insert"><span class="highlight">T</span>he time<span class="highlight"> period</span> is not calculated between the END of the first round and the START of the next, but from the START time of the first round to the START time of the next cycle)</div><div class=""> ------</div><div class=""> </div><div class="insert"><span class="highlight">You can also</span> set how many times the function can raise an exception (i.e. requesting data from a slow web service) and be queued again instead of stopping in **FAILED**  status <span class="highlight">using</span> the parameter ``retry_failed`` (default = 0, -1 = unlimited).</div><div class=""> </div><div class=""> [[task repeats @///image/7d8b85e4.png center]]</div><div class=""> </div><div class=""> Summary: you have</div><div class=""> - ``period`` and ``repeats`` to get an automatically rescheduled function</div><div class=""> - ``timeout`` to be sure that a function doesn&#x27;t exceed a certain amount of time</div><div class=""> - ``retry_failed`` to control how many times the task can &quot;fail&quot;</div><div class=""> - ``start_time`` and ``stop_time`` to schedule a function in a restricted timeframe</div><div class=""> </div><div class="insert"><span class="highlight">#####</span> ``<span class="highlight"></span>queue_task<span class="highlight"></span>``<span class="highlight"> and ``task_status``</span></div><div class=""> </div><div class="insert">+The method:</div><div class="insert">+``</div><div class="insert">+scheduler.queue_task(function, pargs=[], pvars={}, **kwargs)</div><div class="insert">+``:code</div><div class="insert">+allows you to queue tasks to be executed by workers. It takes the following parameters:</div><div class=""> </div><div class="insert">+- ``function`` (required): It can be a task name or a reference to an actual function.</div><div class="insert">+- ``pargs``: are the arguments to be passed to the task, stored as a Python list.</div><div class="insert">+- ``pvars`` : are the named arguments to be passed to the task, stored as a Python dictionary.</div><div class="insert">+- ``kwargs`` : all other scheduler_task columns can be passed as keywords arguments (for example repeats, period, timeout).</div><div class=""> </div><div class="insert"><span class="highlight">For</span> <span class="highlight">ex</span>a<span class="highlight">mp</span>le<span class="highlight">:</span></div><div class=""> </div><div class="insert">+``</div><div class="insert">+scheduler.queue_task(&#x27;demo1&#x27;, [1,2])</div><div class="insert">+``</div><div class="">  </div><div class="insert"><span class="highlight"></span>does the exact same thing as<span class="highlight"> </span></div><div class=""> </div><div class="insert">+``</div><div class="insert">+scheduler.queue_task(&#x27;demo1&#x27;, pvars={&#x27;a&#x27;:1, &#x27;b&#x27;:2})</div><div class="insert">+``:code</div><div class=""> </div><div class="insert"><span class="highlight"></span>as<span class="highlight"></span></div><div class=""> </div><div class="insert">+``</div><div class="insert">+st.validate_and_insert(function_name=&#x27;demo1&#x27;, args=json.dumps([1,2]))</div><div class="insert">+``:code</div><div class=""> </div><div class="insert"><span class="highlight">and</span> <span class="highlight">a</span>s<span class="highlight"></span>:<span class="highlight"></span></div><div class=""> </div><div class="insert">+``</div><div class="insert">+st.validate_and_insert(function_name=&#x27;demo1&#x27;, vars=json.dumps({&#x27;a&#x27;:1,&#x27;b&#x27;:2}))</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Here is a more complex complete example:</div><div class="insert">+``</div><div class="insert">+def task_add(a,b):</div><div class="insert">+    return a+b</div><div class=""> </div><div class="insert"><span class="highlight">s</span>e<span class="highlight">ch</span>e<span class="highlight"></span>d<span class="highlight">ul</span>er <span class="highlight">=</span> <span class="highlight">Sch</span>e<span class="highlight">dul</span>er<span class="highlight">(db,</span> t<span class="highlight"></span>a<span class="highlight">sks=dict(dem</span>o<span class="highlight">1=t</span>a<span class="highlight">sk_a</span>d<span class="highlight"></span>d<span class="highlight">))</span></div><div class=""> </div><div class="insert">+scheduler.queue_task(&#x27;demo1&#x27;, pvars=dict(a=1,b=2),</div><div class="insert">+                     repeats = 0, period = 180)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Since version 2.4.1 if you pass an additional parameter ``immediate=True`` it will force the main worker to reassign tasks. Until 2.4.1, the worker checks for new tasks every 5 cycles (so, ``5*heartbeats`` seconds). If you had an app that needed to check frequently for new tasks, to get a &#x27;&#x27;snappy&#x27;&#x27; behaviour you were forced to lower the ``heartbeat`` parameter, putting the db under pressure for no reason. With ``immediate=True`` you can force the check for new tasks: it will happen at most as ``heartbeat`` seconds are passed   </div><div class="insert">+</div><div class="insert">+A call to ``scheduler.queue_task`` returns the task ``id`` and ``uuid`` of the task you queued (can be the one you passed or the auto-generated one), and possible ``errors``:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+&lt;Row {&#x27;errors&#x27;: {}, &#x27;id&#x27;: 1, &#x27;uuid&#x27;: &#x27;08e6433a-cf07-4cea-a4cb-01f16ae5f414&#x27;}&gt;</div><div class="insert">+``</div><div class="insert">+ </div><div class="insert">+If there are errors (usually syntax error os input validation errors),</div><div class="insert">+you get the result of the validation, and id and uuid will be None</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+&lt;Row {&#x27;errors&#x27;: {&#x27;period&#x27;: &#x27;enter an integer greater than or equal to 0&#x27;}, &#x27;id&#x27;: None, &#x27;uuid&#x27;: None}&gt;</div><div class="insert">+``</div><div class=""> </div><div class=""> ##### Results and output</div><div class="insert">+</div><div class=""> The table &quot;scheduler_run&quot; stores the status of all running tasks. Each record references a task that has been picked up by a worker.  One task can have multiple runs. For example, a task scheduled to repeat 10 times an hour will probably have 10 runs (unless one fails or they take longer than 1 hour). Beware that if the task has no return values, it is removed from the scheduler_run table as soon as it is finished.</div><div class=""> </div><div class=""> Possible run statuses are:</div><div class=""> </div><div class=""> ``</div><div class=""> RUNNING, COMPLETED, FAILED, TIMEOUT</div><div class=""> ``</div><div class=""> </div><div class=""> If the run is completed, no exceptions are thrown, and there is no task timeout, the run is marked as ``COMPLETED`` and the task is marked as ``QUEUED`` or ``COMPLETED`` depending on whether it is supposed to run again at a later time. The output of the task is serialized in JSON and stored in the run record.</div><div class=""> </div><div class=""> When a ``RUNNING`` task throws an exception, the run is mark as ``FAILED`` and the task is marked as ``FAILED``. The traceback is stored in the run record.</div><div class=""> </div><div class=""> Similarly, when a run exceeds the timeout, it is stopped and marked as ``TIMEOUT``, and the task is marked as ``TIMEOUT``.</div><div class=""> </div><div class=""> In any case, the stdout is captured and also logged into the run record.</div><div class=""> </div><div class=""> Using appadmin, one can check all ``RUNNING`` tasks, the output of ``COMPLETED`` tasks, the error of ``FAILED`` tasks, etc.</div><div class=""> </div><div class=""> The scheduler also creates one more table called &quot;scheduler_worker&quot;, which stores the workers&#x27; heartbeat and their status. Possible worker statuses are:</div><div class=""> </div><div class=""> ##### Managing processes</div><div class="insert">+</div><div class=""> Worker fine management is hard. This module tries not to leave behind any platform (Mac, Win, Linux) .</div><div class=""> </div><div class="insert">When you start a worker, you may <span class="highlight"></span>later <span class="highlight">want </span>to:</div><div class=""> - kill it &quot;no matter what it&#x27;s doing&quot;</div><div class="insert">- kill it only if it<span class="highlight"> i</span>s not processing tasks</div><div class=""> - put it to sleep</div><div class=""> Maybe you have yet some tasks queued, and you want to save some resources.</div><div class=""> You know you want them processed every hour, so, you&#x27;ll want to:</div><div class=""> - process all queued tasks and die automatically</div><div class=""> All of these things are possible managing ``Scheduler`` parameters or the ``scheduler_worker`` table.</div><div class="insert">To be more precise, for started workers you <span class="highlight">can</span> change the ``status`` value of any worker to influence</div><div class=""> its behavior.</div><div class="insert">As<span class="highlight"> for</span> tasks, workers can be in <span class="highlight"></span>o<span class="highlight">ne of th</span>e f<span class="highlight">ollow</span>i<span class="highlight">ng</span> statuses<span class="highlight"></span>: ACTIVE, DISABLED, TERMINATE or KILLED.</div><div class=""> </div><div class=""> **ACTIVE** and **DISABLED** are &quot;persistent&quot;, while **TERMINATE** or **KILL**, as statuses</div><div class=""> name suggest, are more &quot;commands&quot; than real statuses.</div><div class=""> Hitting ctrl+c is equal to set a worker to **KILL**</div><div class=""> </div><div class=""> [[workers statuses @///image/bd891eed.png center]]</div><div class=""> </div><div class=""> There are a few commodity functions since version 2.4.1 (self-explanatory)</div><div class=""> ``</div><div class=""> scheduler.disable()</div><div class=""> scheduler.resume()</div><div class=""> scheduler.terminate()</div><div class=""> scheduler.kill()</div><div class=""> ``:code</div><div class=""> </div><div class=""> each function take an optional parameter, that can be a string or a list, to manage workers based on their ``group_names``. It defaults to the ``group_names`` defined in the scheduler istantiation.</div><div class=""> </div><div class=""> An example is better than a thousand words: ``scheduler.terminate(&#x27;high_prio&#x27;)`` will TERMINATE all the workers that are processing the ``high_prio`` tasks, while ``scheduler.terminate([&#x27;high_prio&#x27;, &#x27;low_prio&#x27;])`` will terminate all ``high_prio`` and ``low_prio`` workers.</div><div class=""> ------</div><div class=""> Watch out: if you have a worker processing ``high_prio`` and ``low_prio``, ``scheduler.terminate(&#x27;high_prio&#x27;)`` will terminate the worker alltogether, even if you didn&#x27;t want to terminate ``low_prio`` too.</div><div class=""> For example:</div><div class=""> ``</div><div class=""> scheduler.queue_task(</div><div class="">     function_name=&#x27;task_add&#x27;,</div><div class="">     pargs=[],</div><div class="">     pvars={&#x27;a&#x27;:3,&#x27;b&#x27;:4},</div><div class="">     repeats = 10, # run 10 times</div><div class="">     period = 3600, # every 1h</div><div class="">     timeout = 120, # should take less than 120 seconds</div><div class="">     )</div><div class=""> ``:code</div><div class=""> </div><div class=""> Notice that fields &quot;times_run&quot;, &quot;last_run_time&quot; and &quot;assigned_worker_name&quot; are not provided at schedule time but are filled automatically by the workers.</div><div class=""> </div><div class=""> You can also retrieve the output of completed tasks:</div><div class=""> </div><div class=""> ``</div><div class=""> completed_runs = db(db.scheduler_run.run_status=&#x27;COMPLETED&#x27;).select()</div><div class=""> ``:code</div><div class=""> </div><div class=""> ------</div><div class="insert">The scheduler is<span class="highlight"> considered</span> experimental because it needs more extensive testing and because the table structure may change as more features are added.</div><div class=""> ------</div><div class=""> </div><div class=""> ##### Reporting percentages</div><div class=""> </div><div class=""> A special &quot;word&quot; encountered in the print statements of your functions clear all</div><div class=""> the previous output. That word is ``!clear!``.</div><div class=""> This, coupled with the ``sync_output`` parameter, allows to report percentages</div><div class="insert">+a breeze. </div><div class="insert">+</div><div class="insert">+Here is an example:</div></div></div>
    <div class="span6"><div class="diff"><div class="delete"><span class="highlight">Also, t</span>he first time you start web2py and after an upgrade, the &quot;welcome&quot; app is zipped into a &quot;welcome.w2p&quot; file to be used as a scaffolding app.</div><div class=""> -------</div><div class=""> </div><div class=""> When web2py is upgraded it comes with a file called &quot;NEWINSTALL&quot;. If web2py finds this file, it understands an upgrade was performed, hence it removed the file and creates a new &quot;welcome.w2p&quot;.</div><div class=""> </div><div class=""> The current web2py version is stored in the field &quot;VERSION&quot; and it follows standard semantic versioning notation where the build id is the build timestamp.</div><div class=""> </div><div class=""> web2py unit-tests are in</div><div class=""> ``</div><div class=""> gluon/tests/</div><div class=""> ``:code</div><div class=""> </div><div class=""> There are handlers for connecting with various web servers:</div><div class=""> ``</div><div class=""> cgihandler.py       # discouraged</div><div class=""> gaehandler.py       # for Google App Engine</div><div class=""> fcgihandler.py      # for FastCGI</div><div class=""> wsgihandler.py      # for WSGI</div><div class=""> isapiwsgihandler.py # for IIS</div><div class=""> modpythonhandler.py # deprecated</div><div class=""> ``:code</div><div class=""> web2py also contains a folder with useful scripts including</div><div class=""> ``</div><div class=""> scripts/setup-web2py-fedora.sh</div><div class=""> scripts/setup-web2py-ubuntu.sh</div><div class=""> scripts/setup-web2py-nginx-uwsgi-ubuntu.sh</div><div class=""> scripts/setup-web2py-heroku.sh</div><div class=""> scripts/update-web2py.sh</div><div class=""> scripts/make_min_web2py.py</div><div class=""> ...</div><div class=""> scripts/sessions2trash.py</div><div class=""> scripts/sync_languages.py</div><div class=""> scripts/tickets2db.py</div><div class=""> scripts/tickets2email.py</div><div class=""> ...</div><div class=""> scripts/extract_mysql_models.py</div><div class=""> scripts/extract_pgsql_models.py</div><div class=""> ...</div><div class=""> scripts/access.wsgi</div><div class=""> scripts/cpdb.py</div><div class=""> ``:code</div><div class=""> </div><div class="delete">The <span class="highlight">fir</span>s<span class="highlight"></span>t<span class="highlight"> thr</span>e<span class="highlight">e</span> are particularly useful because they attempt a complete installation and setup of a web2py production environment from scratch.</div><div class=""> Some of these are discussed in Chapter 14, but all of them contain a documentation string inside that explains their purpose and usage.</div><div class=""> </div><div class=""> Finally web2py includes these files required to build the binary distributions.</div><div class=""> ``</div><div class=""> Makefile</div><div class=""> setup_exe.py</div><div class=""> setup_app.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> These are setup scripts for **py2exe** and **py2app**, respectively, and they are only required to build the binary distributions of web2py. YOU SHOULD NEVER NEED TO RUN THEM.</div><div class=""> </div><div class=""> web2py applications contain additional files, particularly third-party JavaScript libraries, such as jQuery, calendar, and Codemirror. Their authors are acknowledged in the files themselves.</div><div class=""> </div><div class=""> ### Applications</div><div class=""> </div><div class=""> Applications developed in web2py are composed of the following parts:</div><div class=""> - **models** describe a representation of the data as database tables and relations between tables.</div><div class=""> - **controllers** describe the application logic and workflow.</div><div class=""> - **views** describe how data should be presented to the user using HTML and JavaScript.</div><div class=""> - **languages** describe how to translate strings in the application into various supported languages.</div><div class=""> Now from a controller in &quot;myapp&quot; you can do</div><div class=""> import test</div><div class=""> def index():</div><div class="">     return &quot;Your ip is &quot; + test.ip()</div><div class=""> ``</div><div class=""> </div><div class=""> Notice a few things:</div><div class=""> </div><div class=""> - ``import test`` looks for the module first in the current app&#x27;s modules folder, then in the folders listed in ``sys.path``. Therefore, app-level modules always take precedence over Python modules. This allows different apps to ship with different versions of their modules, without conflicts.</div><div class=""> </div><div class=""> - Different users can call the same action ``index`` concurrently, which calls the function in the module, and yet there is no conflict because ``current.request`` is a different object in different threads. Just be careful not to access ``current.request`` outside of functions or classes (i.e., at the top level) in the module.</div><div class=""> </div><div class=""> - ``import test`` is a shortcut for ``from applications.appname.modules import test``. Using the longer syntax, it is possible to import modules from other applications.</div><div class=""> </div><div class=""> For uniformity with normal Python behavior, by default web2py does not reload modules when changes are made. Yet this can be changed. To turn on the auto-reload feature for modules, use the ``track_changes`` function as follows (typically in a model file, before any imports):</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.custom_import import track_changes; track_changes(True)</div><div class=""> ``:code</div><div class=""> </div><div class=""> From now on, every time a module is imported, the importer will check if the Python source file (.py) has changed. If it has changed, the module will be reloaded. </div><div class=""> Track changes only tracks changes for modules that are stored in the application.</div><div class=""> Modules that import ``current`` can access:</div><div class=""> - ``current.request``</div><div class=""> - ``current.response``</div><div class=""> - ``current.session``</div><div class=""> - ``current.cache``</div><div class=""> - ``current.T``</div><div class=""> and any other variable your application chooses to store in current. For example a model could do</div><div class=""> </div><div class=""> ``</div><div class=""> auth = Auth(db)</div><div class=""> from gluon import current</div><div class=""> current.auth = auth</div><div class=""> ``</div><div class=""> </div><div class="delete">-and now all modules imported can access</div><div class="delete">-</div><div class="delete"><span class="highlight">-</span> ``current.auth``<span class="highlight"></span></div><div class=""> </div><div class=""> ``current`` and ``import`` create a powerful mechanism to build extensible and reusable modules for your applications.</div><div class=""> </div><div class=""> -------</div><div class="delete"><span class="highlight">There is one ma</span>j<span class="highlight">or ca</span>ve<span class="highlight">at. Gi</span>v<span class="highlight">en ``from gluon import current``</span>, <span class="highlight">it is correct to use ``current.request`` and any of the other thread local objects but one should never assign them to global variables in the module, such as in</span></div><div class=""> ``</div><div class=""> request = current.request # WRONG! DANGER!</div><div class=""> ``</div><div class=""> nor one should use it assign class attributes</div><div class=""> ``</div><div class=""> class MyClass:</div><div class="">     request = current.request # WRONG! DANGER!</div><div class=""> ``</div><div class=""> This is because the thread local object must be extracted at runtime. Global variables instead are defined only once when the model is imported for the first time.</div><div class=""> -------</div><div class=""> </div><div class=""> Another caveat has to do with cache. You cannot use the ``cache`` object to decorate functions in modules, that is because it would not behave as expected. In order to cache a function ``f`` in a module you must use ``lazy_cache``:</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.cache import lazy_cache</div><div class=""> </div><div class=""> lazy_cache(&#x27;key&#x27;, time_expire=60, cache_model=&#x27;ram&#x27;)</div><div class=""> def f(a,b,c,): ....</div><div class=""> ``:code</div><div class=""> </div><div class=""> The ``request`` object is an instance of the ubiquitous web2py class that is cal</div><div class=""> request.vars</div><div class=""> ``:code</div><div class=""> </div><div class=""> is the same as:</div><div class=""> ``</div><div class=""> request[&#x27;vars&#x27;]</div><div class=""> ``:code</div><div class=""> </div><div class=""> Unlike a dictionary, if an attribute (or key) does not exist, it does not raise an exception. Instead, it returns ``None``.</div><div class=""> </div><div class=""> -----</div><div class=""> It is sometimes useful to create your own Storage objects. You can do so as follows:</div><div class=""> ``</div><div class=""> from gluon.storage import Storage</div><div class=""> my_storage = Storage() # empty storage object</div><div class=""> my_other_storage = Storage(dict(a=1, b=2)) # convert dictionary to Storage</div><div class=""> ``:code</div><div class=""> -----</div><div class=""> </div><div class=""> ``request`` has the following items/attributes, some of which are also an instance of the ``Storage`` class:</div><div class="delete">- ``request.cookies``: a ``Cookie.SimpleCookie()`` object containing the cookies passed with the HTTP request. It acts like a dictionary of cookies. Each cookie is a Morsel object <span class="highlight">(</span>se<span class="highlight">e h</span>t<span class="highlight">tp://docs.python.org/2/library/cooki</span>e.<span class="highlight">html#id2).</span></div><div class=""> - ``request.env``: a ``Storage`` object containing the environment variables passed to the controller, including HTTP header variables from the HTTP request and standard WSGI parameters. The environment variables are all converted to lower case, and dots are converted to underscores for easier memorization.</div><div class="delete">-- ``request.application``: the name of the requested application (parsed from ``request.env.path_info``).</div><div class="delete">-- ``request.controller``: the name of the requested controller (parsed from the ``request.env.path_info``).</div><div class="delete">-- ``request.function``: the name of the requested function (parsed from the ``request.env.path_info``).</div><div class=""> - ``request.extension``: the extension of the requested action. It defaults to &quot;html&quot;. If the controller function returns a dictionary and does not specify a view, this is used to determine the extension of the view file that will render the dictionary (parsed from the ``request.env.path_info``).</div><div class=""> - ``request.folder``: the application directory. For example if the application is &quot;welcome&quot;, ``request.folder`` is set to the absolute path &quot;/path/to/welcome&quot;. In your programs, you should always use this variable and the ``os.path.join`` function to build paths to the files you need to access. Although web2py always uses absolute paths, it is a good rule never to explicitly  change the current working folder (whatever that is) since this is not a thread-safe practice.</div><div class=""> - ``request.now``: a ``datetime.datetime`` object storing the datetime of the current request.</div><div class=""> - ``request.utcnow``: a ``datetime.datetime`` object storing the UTC datetime of the current request.</div><div class=""> - ``request.args``: A list of the URL path components following the controller function name; equivalent to ``request.env.path_info.split(&#x27;/&#x27;)[3:]``</div><div class=""> - ``request.vars``: a ``gluon.storage.Storage`` object containing both the HTTP GET and HTTP POST query variables.</div><div class=""> - ``request.get_vars``: a ``gluon.storage.Storage`` object containing only the HTTP GET query variables.</div><div class=""> - ``request.post_vars``: a ``gluon.storage.Storage`` object containing only the HTTP POST query variables.</div><div class=""> - ``request.client``: The ip address of the client as determined by, if present, ``request.env.http_x_forwarded_for`` or by ``request.env.remote_addr`` otherwise. While this is useful it should not be trusted because the ``http_x_forwarded_for`` can be spoofed.</div><div class=""> - ``request.is_local``: ``True`` if the client is localhost, ``False`` otherwise. Should work behind a proxy if the proxy supports ``http_x_forwarded_for``.</div><div class=""> - ``request.is_https``: ``True`` if the request is using the HTTPS protocol, ``False`` otherwise.</div><div class=""> - ``request.body``: a read-only file stream that contains the body of the HTTP request. This is automatically parsed to get the ``request.post_vars`` and then rewinded. It can be read with ``request.body.read()``.</div><div class=""> - ``request.ajax`` is True if the function is being called via an Ajax request.</div><div class=""> - ``request.cid`` is the ``id`` of the component that generated the Ajax request (if any). You can read more about components in Chapter 12.</div><div class=""> - ``request.requires_https()`` prevents further code execution if the request is not over HTTPS and redirects the visitor to the current page over HTTPS.</div><div class=""> - ``request.restful`` this is a new and very useful decorator that can be used to change the default behavior of web2py actions by separating GET/POST/PUSH/DELETE requests. It will be discussed in some detail in Chapter 10.</div><div class=""> - ``request.user_agent()`` parses the user_agent field from the client and returns the information in the form of a dictionary. It is useful to detect mobile devices. It uses &quot;gluon/contrib/user_agent_parser.py&quot; created by Ross Peoples. To see what it does, try to embed the following code in a view:</div><div class=""> ``</div><div class=""> {{=BEAUTIFY(request.user_agent())}}</div><div class=""> ``:code</div><div class=""> Also notice the ``request.env.wsgi_*`` variables. They are specific to the wsgi</div><div class=""> ``response.status``:inxx</div><div class=""> ``response.stream``:inxx</div><div class=""> ``response.subtitle``:inxx</div><div class=""> ``response.title``:inxx</div><div class=""> ``response.toolbar``:inxx</div><div class=""> ``response.view``:inxx</div><div class=""> ``response.delimiters``:inxx</div><div class=""> ``response.js``:inxx</div><div class=""> ``response.write``:inxx</div><div class=""> ``response.include_files``:inxx</div><div class=""> ``response.include_meta``:inxx</div><div class=""> ``response.optimize_css``:inxx</div><div class=""> ``response.optimize_js``:inxx</div><div class=""> ``response._caller``:inxx</div><div class=""> </div><div class=""> ``response`` is another instance of the ``Storage`` class. It contains the following:</div><div class=""> </div><div class=""> - ``response.body``: a ``StringIO`` object into which web2py writes the output page body. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.cookies``: similar to ``request.cookies``, but while the latter contains the cookies sent from the client to the server, the former contains cookies sent by the server to the client. The session cookie is handled automatically.</div><div class=""> - ``response.download(request, db)``: a method used to implement the controller function that allows downloading of uploaded files. ``request.download`` expects the last ``arg`` in ``request.args`` to be the encoded filename (i.e., the filename generated at upload time and stored in the upload field). It extracts the upload field name and table name as well as the original filename from the encoded filename. ``response.download`` takes two optional arguments: ``chunk_size`` sets the size in bytes for chunked streaming (defaults to 64K), and ``attachments`` determines whether the downloaded file should be treated as an attachment or not (default to ``True``). Note, ``response.download`` is specifically for downloading files associated with ``db`` upload fields. Use ``response.stream`` (see below) for other types of file downloads and streaming. Also, note that it is not necessary to use ``response.download`` to access files uploaded to the /static folder -- static files can (and generally should) be accessed directly via URL (e.g., /app/static/files/myfile.pdf).</div><div class="delete">- ``response.files``: a list of <span class="highlight">.css, </span>.js<span class="highlight">, coffee, and .less</span> files required by the page. They will automatically be linked in the head of the standard &quot;layout.html&quot; via the included &quot;web2py_ajax.html&quot;. To include a new CSS, JS, COFFEE, or LESS file, just append it to this list. It will handle duplicates. The order is important.</div><div class=""> - ``response.include_files()`` generates html head tags to include all ``response.files`` (used in &quot;views/web2py_ajax.html&quot;).</div><div class=""> - ``response.flash``: optional parameter that may be included in the views. Normally used to notify the user about something that happened.</div><div class=""> - ``response.headers``: a ``dict`` for HTTP response headers. Web2py sets some headers by default, including &quot;Content-Length&quot;, &quot;Content-Type&quot;, and &quot;X-Powered-By&quot; (set equal to web2py). Web2py also sets the &quot;Cache-Control&quot;, &quot;Expires&quot;, and &quot;Pragma&quot; headers to prevent client-side caching, except for static file requests, for which client-side caching is enabled. The headers that web2py sets can be overwritten or removed, and new headers can be added (e.g., ``response.headers[&#x27;Cache-Control&#x27;] = &#x27;private&#x27;``). You can remove a header by removing its key from the response.headers dict, e.g.``del response.headers[&#x27;Custom-Header&#x27;]``, however web2py&#x27;s default headers will be re-added just before returning the response. To avoid this behavior, just set the header value to None, e.g. to remove the default Content-Type header, ``response.headers[&#x27;Content-Type&#x27;] = None``</div><div class=""> - ``response.menu``: optional parameter that may be included in the views, normally used to pass a navigation menu tree to the view. It can be rendered by the MENU helper.</div><div class="delete">- ``response.meta``: a <span class="highlight">s</span>torage object <span class="highlight">(like a dict) that contains optional meta</span> information like ``response.meta.author``, ``.description``, and/or ``.keywords``. The content of each meta variable is automatically placed in the proper ``META`` tag by the code in &quot;views/web2py_ajax.html&quot;, which is included by default in &quot;views/layout.html&quot;.</div><div class=""> - ``response.include_meta()`` generates a string that includes all ``response.meta`` headers serialized (used in &quot;views/web2py_ajax.html&quot;).</div><div class=""> - ``response.postprocessing``: this is a list of functions, empty by default. These functions are used to filter the response object at the output of an action, before the output is rendered by the view. It can be used to implement support for other template languages.</div><div class=""> - ``response.render(view, vars)``: a method used to call the view explicitly inside the controller. ``view`` is an optional parameter which is the name of the view file, ``vars`` is a dictionary of named values passed to the view.</div><div class=""> - ``response.session_file``: file stream containing the session.</div><div class=""> - ``response.session_file_name``: name of the file where the session will be saved.</div><div class=""> - ``response.session_id``: the id of the current session. It is determined automatically. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.session_id_name``: the name of the session cookie for this application. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.status``: the HTTP status code integer to be passed to the response. Default is 200 (OK).</div><div class=""> - ``response.stream(file, chunk_size, request=request, attachment=False, filename=None, headers=None)``: when a controller returns it, web2py streams the file content back to the client in blocks of size ``chunk_size``. The ``request`` parameter is required to use the chunk start in the HTTP header. ``file`` should be a file path (for backward compatibility, it can also be an open file object, but this is not recommended). As noted above, ``response.download`` should be used to retrieve files stored via an upload field. ``response.stream`` can be used in other cases, such as returning a temporary file or StringIO object created by the controller. If ``attachment`` is True, the Content-Disposition header will be set to &quot;attachment&quot;, and if ``filename`` is also provided, it will be added to the Content-Disposition header as well (but only when ``attachment`` is True). If not already included in ``response.headers``, the following response headers will be set automatically: Content-Type, Content-Length, Cache-Control, Pragma, and Last-Modified (the latter three are set to allow browser caching of the file). To override any of these automatic header settings, simply set them in ``response.headers`` before calling ``response.stream``.</div><div class=""> - ``response.subtitle``: optional parameter that may be included in the views. It should contain the subtitle of the page.</div><div class=""> - ``response.title``: optional parameter that may be included in the views. It should contain the title of the page and should be rendered by the HTML title TAG in the header.</div><div class=""> - ``response.toolbar``: a function that allows you to embed a toolbar into page for debugging purposes ``{{=response.toolbar()}}``. The toolbar displays request, response, session variables and database access time for each query.</div><div class=""> - ``response._vars``: this variable is accessible only in a view, not in the action. It contains the value returned by the action to the view.</div><div class=""> - ``response._caller``: this is a function that wraps all action calls. It defaults to the identity function, but it can be modified in order to catch special types of exception to do extra logging;</div><div class="">   ``</div><div class="">   response._caller = lambda f: f()</div><div class="">   ``</div><div class=""> - ``response.optimize_css``: if can be set to &quot;concat,minify,inline&quot; to concatenate, minify and inline the CSS files included by web2py.</div><div class=""> - ``response.optimize_js``: if can be set to &quot;concat,minify,inline&quot; to concatenate, minify and inline the JavaScript files included by web2py.</div><div class=""> - ``response.view``: the name of the view template that must render the page. This is set by default to:</div><div class=""> is simply a shortcut for:</div><div class=""> raise HTTP(303,</div><div class="">            &#x27;You are being redirected &lt;a href=&quot;%s&quot;&gt;here&lt;/a&gt;&#x27; % location,</div><div class="">            Location=&#x27;http://www.web2py.com&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The named arguments of the ``HTTP`` initializer method are translated into HTTP header directives, in this case, the redirection target location. ``redirect`` takes an optional second argument, which is the HTTP status code for the redirection (303 by default). Change this number to 307 for a temporary redirect or to 301 for a permanent redirect.</div><div class=""> </div><div class=""> The most common way to use redirect is to redirect to other pages in the same app and (optionally) pass parameters:</div><div class=""> </div><div class=""> ``</div><div class=""> redirect(URL(&#x27;index&#x27;, args=(1,2,3), vars=dict(a=&#x27;b&#x27;)))</div><div class=""> ``:code</div><div class=""> </div><div class=""> In chapter 12 we discuss web2py components. They make Ajax requests to web2py actions. If the called action performs a redirect, you may want the Ajax request to follow the redirect or you may want the entire page performing the Ajax request redirecting. In this latter case you can set:</div><div class=""> </div><div class=""> ``</div><div class=""> redirect(...,type=&#x27;auto&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class="delete">###<span class="highlight"> ``T``,</span> Internationalization, and Pluralization<span class="highlight"></span></div><div class=""> ``T``:inxx ``internationalization``:inxx</div><div class=""> </div><div class=""> The object ``T`` is the language translator. It constitutes a single global instance of the web2py class ``gluon.language.translator``. All string constants (and only string constants) should be marked by ``T``, for example:</div><div class=""> ``</div><div class=""> a = T(&quot;hello world&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Strings that are marked with ``T`` are identified by web2py as needing language translation and they will be translated when the code (in the model, controller, or view) is executed. If the string to be translated is not a constant but a variable, it will be added to the translation file at runtime (except on GAE) to be translated later.</div><div class=""> </div><div class=""> The ``T`` object can also contain interpolated variables and supports multiple equivalent syntaxes:</div><div class=""> ``</div><div class=""> a = T(&quot;hello %s&quot;, (&#x27;Tim&#x27;,))</div><div class=""> a = T(&quot;hello %(name)s&quot;, dict(name=&#x27;Tim&#x27;))</div><div class=""> a = T(&quot;hello %s&quot;) % (&#x27;Tim&#x27;,)</div><div class=""> a = T(&quot;hello %(name)s&quot;) % dict(name=&#x27;Tim&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The latter syntax is recommended because it makes translation easier.</div><div class=""> The first string is translated according to the requested language file and the ``name`` variable is replaced independently of the language.</div><div class=""> </div><div class=""> T(&quot;Hello World&quot;, lazy=False)</div><div class=""> ``:code</div><div class=""> </div><div class=""> A common issue is the following. The original application is in English. Suppose that there is a translation file (for example Italian, &quot;it-it.py&quot;) and the HTTP client declares that it accepts both English (en) and Italian (it-it) in that order. The following unwanted situation occurs: web2py does not know the default is written in English (en). Therefore, it prefers translating everything into Italian (it-it) because it only found the Italian translation file. If it had not found the &quot;it-it.py&quot; file, it would have used the default language strings (English).</div><div class=""> </div><div class=""> There are two solutions for this problem: create a translation language for English, which would be redundant and unnecessary, or better, tell web2py which languages should use the default language strings (the strings coded into the application). This can be done with:</div><div class=""> ``</div><div class=""> T.set_current_languages(&#x27;en&#x27;, &#x27;en-en&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> It stores in  ``T.current_languages`` a list of languages that do not require translation and forces a reload of the language files.</div><div class=""> </div><div class=""> Notice that &quot;it&quot; and &quot;it-it&quot; are different languages from the point of view of web2py. To support both of them, one would need two translation files, always lower case. The same is true for all other languages.</div><div class=""> </div><div class=""> The currently accepted language is stored in</div><div class=""> ``</div><div class=""> T.accepted_language</div><div class=""> ``:code</div><div class=""> </div><div class=""> #### Translating variables</div><div class=""> </div><div class="delete"><span class="highlight">Mind that </span>T(...) does not <span class="highlight">just</span> translate strings but <span class="highlight"></span>can also trans<span class="highlight">l</span>ate<span class="highlight"></span>d<span class="highlight"></span> variables:</div><div class=""> ``</div><div class=""> &gt;&gt;&gt; a=&quot;test&quot;</div><div class=""> &gt;&gt;&gt; print T(a)</div><div class=""> ``:code</div><div class=""> </div><div class=""> In this case the word &quot;test&quot; is translated but, if not found and if the filesystem is writable, it will add it to the list of words to be translated in the language file.</div><div class=""> </div><div class=""> Notice that this can result in lots of file IO and you may want to disable it:</div><div class=""> </div><div class=""> ``</div><div class=""> T.is_writable = False</div><div class=""> ``:code</div><div class=""> </div><div class=""> prevents T from dynamically updating language files.</div><div class=""> </div><div class=""> #### Comments and multiple translations</div><div class=""> </div><div class=""> It is possible that the same string appears in different contexts in the application and needs different translations based on context. In order to do this, one can add comments to the original string. The comments will not be rendered but will be used by web2py to determine the most appropriate translation. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;hello world ## first occurrence&quot;)</div><div class=""> T(&quot;hello world ## second occurrence&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The text following the ``##``, including the double ``##``, are comments.</div><div class=""> </div><div class=""> #### Pluralization engine</div><div class=""> </div><div class=""> Since version 2.0, web2py includes a powerful pluralization system (PS). This means that when text marked for translation depends on a numeric variable, it may be translated differently based on the numeric value. For example in English we may render:</div><div class=""> </div><div class=""> ``</div><div class=""> x book(s)</div><div class=""> ``</div><div class=""> </div><div class=""> with</div><div class=""> </div><div class=""> ``</div><div class="delete">-a book (x==0)</div><div class="delete">-x books (x&gt;0)</div><div class=""> ``</div><div class=""> </div><div class=""> English has one singular form and one plural form. The plural form is constructed by adding a &quot;-s&quot; or &quot;-es&quot; or using an exceptional form. web2py provides a way to define pluralization rules for each languages, as well as exceptions to the default rules. In fact web2py already knows pluralization rules for many languages. It knows, for example, that Slovenian has one singular form and 3 plural forms (for x==1, x==3 or x==4 and x&gt;4). These rules are encoded in &quot;gluon/contrib/plural_rules/*.py&quot; files and new files can be created. Explicit pluralizations for words are created by editing pluralization files using the administrative interface.</div><div class=""> </div><div class=""> By default the PS is not activated. It is triggered by the ``symbol`` argument of the ``T`` function. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;You have %s %%{book}&quot;, symbols=10)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Now the PS is activated for the word &quot;book&quot; and for the number 10.</div><div class=""> The result in English will be: &quot;You have 10 books&quot;. Notice that &quot;book&quot; has been pluralized into &quot;books&quot;.</div><div class=""> </div><div class=""> The PS consists of 3 parts:</div><div class=""> - placeholders ``%%{}`` to mark words in ``T``-messages</div><div class=""> - rule to give a decision which word form to use (&quot;rules/plural_rules/*.py&quot;)</div><div class=""> - dictionary with word plural forms (&quot;app/languages/plural-*.py&quot;)</div><div class=""> </div><div class=""> The value of symbols can be a single variable, a list/tuple of variables, or a dictionary.</div><div class=""> </div><div class=""> The placeholder ``%%{}`` consists of 3 parts:</div><div class=""> </div><div class=""> ``</div><div class=""> %%{[&lt;modifier&gt;]&lt;world&gt;[&lt;parameter&gt;]},</div><div class=""> ``</div><div class=""> </div><div class=""> where:</div><div class=""> </div><div class=""> ``</div><div class=""> &lt;modifier&gt;::= ! | !! | !!!</div><div class=""> &lt;word&gt; ::= any word or phrase in singular in lower case (!)</div><div class=""> &lt;parameter&gt; ::= [index] | (key) | (number)</div><div class=""> ``</div><div class=""> </div><div class=""> For example:</div><div class=""> </div><div class="delete">- ``%%{word}`` is equivalent to <span class="highlight"></span>%%{word[0]}<span class="highlight"></span> (if no modifiers are used).</div><div class=""> - ``%%{word[index]}`` is used when symbols is a tuple. symbols[index] gives us a number used to make a decision on which word form to choose.</div><div class=""> - ``%%{word(key)}`` is used to get the numeric parameter from symbols[key]</div><div class=""> - ``%%{word(number)}`` allows to set a ``number`` directly (e.g.: ``%%{word(%i)}``)</div><div class=""> - ``%%{?word?number}`` returns &quot;word&quot; if ``number==1``, returns the ``number`` otherwise</div><div class=""> - ``%%{?number} or %%{??number}`` returns ``number`` if ``number!=1``, return nothing otherwise</div><div class=""> </div><div class=""> ``T(&quot;blabla %s %%{word}&quot;, symbols=var)``</div><div class=""> </div><div class=""> ``%%{word}`` by default means ``%%{word[0]}``,</div><div class=""> where ``[0]`` is an item index in symbols tuple.</div><div class=""> </div><div class=""> ``T(&quot;blabla %s %s %%{word[1]}&quot;, (var1, var2))``</div><div class=""> PS is used for &quot;word&quot; and var2 respectively.</div><div class=""> </div><div class="delete">You can use several <span class="highlight"></span>%%{}<span class="highlight"></span> placeholders with one index:</div><div class=""> </div><div class=""> ``T(&quot;%%{this} %%{is} %s %%{book}&quot;, var)``</div><div class=""> </div><div class=""> or</div><div class=""> </div><div class=""> ``T(&quot;%%{this[0]} %%{is[0]} %s %%{book[0]}&quot;, var)``</div><div class=""> </div><div class="delete"><span class="highlight">G</span>enerate:</div><div class=""> </div><div class=""> ``</div><div class=""> var  output</div><div class=""> ------------------</div><div class="">  1   this is 1 book</div><div class="">  2   these are 2 books</div><div class="">  3   these are 2 books</div><div class=""> ``</div><div class=""> </div><div class=""> Similarly you can pass a dictionary to symbols:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;blabla %(var1)s %(wordcnt)s %%{word(wordcnt)}&quot;,</div><div class="">   dict(var1=&quot;tututu&quot;, wordcnt=20))</div><div class=""> ``</div><div class=""> </div><div class=""> which produces</div><div class=""> </div><div class=""> ``</div><div class=""> blabla tututu 20 words</div><div class=""> For example</div><div class=""> </div><div class=""> ``T(&quot;%%{this} %%{is} %%{?a?%s} %%{book}&quot;, var)``</div><div class=""> </div><div class=""> produces:</div><div class=""> </div><div class=""> ``</div><div class=""> var  output</div><div class=""> ------------------</div><div class="">  1   this is a book</div><div class="">  2   these are 2 books</div><div class="">  3   these are 3 books</div><div class="">  ...</div><div class=""> ``</div><div class=""> </div><div class=""> Inside ``%%{...}`` you can also use the following modifiers:</div><div class=""> </div><div class=""> - ``!`` to capitalize the text (equivalent to ``string.capitalize``)</div><div class=""> - ``!!`` to capitalize every word (equivalent to ``string.title``)</div><div class=""> - ``!!!`` to capitalize every character (equivalent to ``string.upper``)</div><div class=""> </div><div class="delete">Notice you can use <span class="highlight">``</span>\<span class="highlight">\``</span> to escape ``!`` and ``?``.</div><div class=""> </div><div class=""> #### Translations, pluralization, and MARKMIN</div><div class=""> </div><div class=""> You can also use the powerful MARKMIN syntax inside translation strings by replacing</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;hello world&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> with</div><div class=""> </div><div class=""> ``</div><div class=""> T.M(&quot;hello world&quot;)</div><div class=""> ``</div><div class=""> </div><div class=""> Now the string accepts MARKMIN markup as described later in the book. You can also use the pluralization system inside MARKMIN.</div><div class=""> </div><div class=""> ### Cookies</div><div class=""> </div><div class=""> ``cookies``:inxx</div><div class=""> Here are four ways to set the default application:</div><div class=""> - Make a symbolic link from &quot;applications/init&quot; to your application&#x27;s folder.</div><div class=""> - Use URL rewrite as discussed in the next section.</div><div class=""> </div><div class=""> ### URL rewrite</div><div class=""> ``url rewrite``:inxx</div><div class=""> ``routes_in``:inxx</div><div class=""> ``routes_out``:inxx</div><div class=""> </div><div class=""> web2py has the ability to rewrite the URL path of incoming requests prior to calling the controller action (URL mapping), and conversely, web2py can rewrite the URL path generated by the ``URL`` function (reverse URL mapping). One reason to do this is for handling legacy URLs, another is to simplify paths and make them shorter.</div><div class=""> </div><div class=""> web2py includes two distinct URL rewrite systems: an easy-to-use &#x27;&#x27;parameter-based&#x27;&#x27; system for most use cases, and a flexible &#x27;&#x27;pattern-based&#x27;&#x27; system for more complex cases. To specify the URL rewrite rules, create a new file in the &quot;web2py&quot; folder called ``routes.py`` (the contents of ``routes.py`` will depend on which of the two rewrite systems you choose, as described in the next two sections). The two systems cannot be mixed.</div><div class=""> </div><div class=""> -------</div><div class=""> Notice that if you edit routes.py, you must reload it. This can be done in two ways: by restarting the web server or by clicking on the routes reload button in admin. If there is a bug in routes, they will not reload.</div><div class=""> -------</div><div class=""> </div><div class=""> #### Parameter-based system</div><div class=""> </div><div class=""> The parameter-based (parametric) router provides easy access to several &quot;canned&quot; URL-rewrite methods. Its capabilities include:</div><div class=""> </div><div class="delete">-* Omitting default application, controller and function names from externally-visible URLs (those created by the URL() function)</div><div class="delete">-</div><div class="delete">-* Mapping domains (and/or ports) to applications or controllers</div><div class="delete">-</div><div class="delete">-* Embedding a language selector in the URL</div><div class="delete">-</div><div class="delete">-* Removing a fixed prefix from incoming URLs and adding it back to outgoing URLs</div><div class="delete">-</div><div class="delete">-* Mapping root files such as /robots.txt to an applications static directory</div><div class=""> </div><div class=""> The parametric router also provides somewhat more flexible validation of incoming URLs.</div><div class=""> </div><div class=""> Suppose you&#x27;ve written an application called ``myapp`` and wish to make it the default, so that the application name is no longer part of the URL as seen by the user. Your default controller is still ``default``, and you want to remove its name from user-visible URLs as well. Here&#x27;s what you put in ``routes.py``:</div><div class=""> ``</div><div class=""> routers = dict(</div><div class="">   BASE  = dict(default_application=&#x27;myapp&#x27;),</div><div class=""> )</div><div class=""> ``:code</div><div class=""> </div><div class=""> That&#x27;s it. The parametric router is smart enough to know how to do the right thing with URLs such as:</div><div class=""> ``</div><div class=""> http://domain.com/myapp/default/myapp</div><div class=""> ``:code</div><div class=""> or</div><div class=""> ``</div><div class=""> http://domain.com/myapp/myapp/index</div><div class=""> ``:code</div><div class=""> where normal shortening would be ambiguous. If you have two applications, ``myapp`` and ``myapp2``, you&#x27;ll get the same effect, and additionally ``myapp2``&#x27;s default controller will be stripped from the URL whenever it&#x27;s safe (which is mostly all the time).</div><div class=""> </div><div class=""> AliasMatch ^/([^/]+)/static/(?:/_[\d]+\.[\d]+\.[\d]+)?(.*) \</div><div class="">    /home/www-data/web2py/applications/$1/static/$2</div><div class=""> ``</div><div class=""> </div><div class=""> Similarly, in Nginx change this:</div><div class=""> ``</div><div class=""> location ~* /(\w+)/static/ {</div><div class="">     root /home/www-data/web2py/applications/;</div><div class="">     expires max;</div><div class=""> }</div><div class=""> ``</div><div class=""> into this:</div><div class=""> ``</div><div class=""> location ~* /(\w+)/static(?:/_[\d]+\.[\d]+\.[\d]+)?/(.*)$ {</div><div class="">    alias /home/www-data/web2py/applications/$1/static/$2;</div><div class="">    expires max;</div><div class=""> }</div><div class=""> ``</div><div class=""> </div><div class=""> ### Running tasks in the background</div><div class=""> </div><div class="delete">In web2py, every <span class="highlight">http</span> request is served in its own thread. Threads are recycled for efficiency and managed by the web server. For security, the web server sets a time-out on each request. This means that actions should not run tasks that take too long, should not create new threads, and should not fork processes (it is possible but not recommended).</div><div class=""> </div><div class=""> The proper way to run time-consuming tasks is doing it in the background. There is not a single way of doing it, but here we describe three mechanisms that are built into web2py: **cron**, **homemade task queues**, and **scheduler**.</div><div class=""> </div><div class=""> By **cron** we refer to a web2py functionality not to the Unix Cron mechanism. The web2py cron works on windows too.</div><div class=""> </div><div class=""> web2py cron is the way to go if you need tasks in the background at scheduled times and these tasks take a relatively short time compared to the time interval between two calls. Each task runs in its own process, and multiple tasks can run concurrently, but you have no control over how many tasks run. If accidentally one task overlaps with itself, it can cause a database lock and a spike in memory usage.</div><div class=""> </div><div class=""> web2py scheduler takes a different approach. The number of running processes is fixed, and they can run on different machines. Each process is called a worker. Each worker picks a task when available and executes it as soon as possible after the time when it is scheduled to run, but not necessarily at that exact time. There cannot be more processes running than the number of scheduled tasks and therefore no memory spikes. Scheduler tasks can be defined in models and are stored in the database. The web2py scheduler does not implement a distributed queue since it assumes that the time to distribute tasks is negligible compared with the time to run the tasks. Workers pick up the task from the database.</div><div class=""> </div><div class=""> Homemade tasks queues can be a simpler alternative to the web2py scheduler in some cases.</div><div class=""> </div><div class=""> #### Cron</div><div class=""> ``cron``:inxx</div><div class=""> </div><div class=""> The web2py cron provides the ability for applications to execute tasks at preset times, in a platform-independent manner.</div><div class=""> </div><div class=""> For each application, cron functionality is defined by a crontab file:</div><div class=""> </div><div class=""> ``</div><div class=""> app/cron/crontab</div><div class=""> Example of line to add to the system crontab, (usually /etc/crontab):</div><div class=""> </div><div class=""> With external ``cron``, make sure to add either ``-J`` (or ``--cronjob``, which is the same) as indicated above so that web2py knows that task is executed by cron. Web2py sets this internally with soft and hard ``cron``.</div><div class=""> </div><div class=""> #### Homemade task queues</div><div class=""> </div><div class=""> While cron is useful to run tasks at regular time intervals, it is not always the best solution to run a background task. For this purpose web2py provides the ability to run any python script as if it were inside a controller:</div><div class=""> ``</div><div class=""> python web2py.py -S app -M -R applications/app/private/myscript.py -A a b c</div><div class=""> ``:code</div><div class=""> </div><div class=""> where ``-S app`` tells web2py to run &quot;myscript.py&quot; as &quot;app&quot;, ``-M`` tells web2py to execute models, and ``-A a b c`` passes optional command line arguments ``sys.args=[&#x27;a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;]`` to &quot;myscript.py&quot;.</div><div class=""> </div><div class=""> This type of background process should not be executed via cron (except perhaps for cron @reboot) because you need to be sure that no more than one instance is running at the same time. With cron it is possible that a process starts at cron iteration 1 and is not completed by cron iteration 2, so cron starts it again, and again, and again - thus jamming the mail server.</div><div class=""> </div><div class=""> In chapter 8, we will provide an example of how to use the above method to send emails.</div><div class=""> </div><div class=""> </div><div class=""> #### Scheduler (experimental)</div><div class=""> </div><div class=""> The web2py scheduler works very much like the task queue described in the previous sub-section with some differences:</div><div class="delete">- It provides a standard mechanism for creating<span class="highlight"> and</span> scheduling<span class="highlight"></span> tasks.</div><div class=""> - There is not a single background process but a set of workers processes.</div><div class=""> - The job of worker nodes can be monitored because their state, as well as the state of the tasks, is stored in the database.</div><div class=""> - It works without web2py but that is not documented here.</div><div class=""> </div><div class=""> The scheduler does not use cron, although one can use cron @reboot to start the worker nodes.</div><div class=""> </div><div class=""> More information about deploying the scheduler under Linux and Windows is in the Deployment recipes chapter.</div><div class=""> </div><div class=""> In the scheduler, a task is simply a function defined in a model (or in a module and imported by a model). For example:</div><div class=""> </div><div class=""> ``</div><div class=""> def task_add(a,b):</div><div class="">     return a+b</div><div class=""> ``:code</div><div class=""> </div><div class=""> Tasks will always be called in the same environment seen by controllers and therefore they see all the global variables defined in models, including database connections (``db``). Tasks differ from a controller action because they are not associated with an HTTP request and therefore there is no ``request.env``.</div><div class=""> </div><div class=""> ------</div><div class="delete"><span class="highlight">NB: remind to call </span>db.commit()<span class="highlight"></span> at the end of every task if it involves inserts/updates to the database. <span class="highlight">W</span>eb2py commits by default at the end of a successful <span class="highlight">function call but the scheduler doesn&#x27;t</span></div><div class=""> ------</div><div class=""> </div><div class="delete">To enable the scheduler you <span class="highlight"></span>s<span class="highlight">hould pu</span>t<span class="highlight"> into a model its</span> instantiat<span class="highlight"></span>i<span class="highlight"></span>o<span class="highlight">n</span>.</div><div class=""> The recommended way to enable the scheduler to your app is to create a model file named ``scheduler.py`` and define your function there. After the functions, you can put the following code into the model:</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.scheduler import Scheduler</div><div class=""> scheduler = Scheduler(db)</div><div class=""> ``:code</div><div class=""> </div><div class="delete"><span class="highlight">NB: </span>If your tasks are defined in a module (as opposed to a model) you may have to restart the workers.</div><div class=""> </div><div class=""> The task is scheduled with</div><div class=""> </div><div class=""> ``</div><div class=""> scheduler.queue_task(task_add,pvars=dict(a=1,b=2))</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> ##### Parameters</div><div class=""> </div><div class=""> The first argument of the ``Scheduler`` class must be the database to be used by the scheduler to communicate with the workers. This can be the ``db`` of the app or another dedicated ``db``, perhaps one shared by multiple apps. If you use SQLite it&#x27;s recommended to use a separate db from the one used by your app in order to keep the app responsive.</div><div class=""> Once the tasks are defined and the ``Scheduler`` is instantiated, all that is needed to do is to start the workers. You can do that in several ways:</div><div class=""> </div><div class=""> ``</div><div class=""> python web2py.py -K myapp</div><div class=""> ``</div><div class=""> starts a worker for the app ``myapp``. If you want start multiple workers for the same app, you can do so just passing ``myapp,myapp``. You can pass also the ``group_names`` (overriding the one set in your model) with</div><div class=""> </div><div class=""> ``</div><div class=""> python web2py.py -K myapp:group1:group2,myotherapp:group1</div><div class=""> You can pass the usual parameters (-i, -p, here -a prevents the window from show</div><div class=""> </div><div class=""> Scheduler&#x27;s complete signature is:</div><div class=""> </div><div class=""> ``</div><div class=""> Scheduler(</div><div class="">     db,</div><div class="">     tasks=None,</div><div class="">     migrate=True,</div><div class="">     worker_name=None,</div><div class="">     group_names=None,</div><div class="">     heartbeat=HEARTBEAT,</div><div class="">     max_empty_runs=0,</div><div class="">     discard_results=False,</div><div class="">     utc_time=False</div><div class=""> )</div><div class=""> ``:code</div><div class=""> </div><div class=""> Let&#x27;s see them in order:</div><div class=""> </div><div class=""> - ``db`` is the database DAL instance where you want the scheduler tables be placed.</div><div class="delete">- ``tasks`` <span class="highlight">can be</span> a dict<span class="highlight">.</span> <span class="highlight">Mus</span>t <span class="highlight">b</span>e<span class="highlight"></span> <span class="highlight">def</span>in<span class="highlight">ed if you want </span>to<span class="highlight"> call a</span> function<span class="highlight"> not by hi</span>s<span class="highlight"> name, i.e. ``tasks=dict(mynameddemo1=task_add)`` will let you execute function demo1 with ``scheduler.queue_task(&#x27;mynameddemo1&#x27;)`` instead of ``scheduler.queue_task(&#x27;task_add&#x27;)``</span>. If you do<span class="highlight"></span>n<span class="highlight">&#x27;</span>t pass this parameter, function will be searched in the app environment.</div><div class=""> - ``worker_name`` is None by default. As soon as the worker is started, a worker name is generated as hostname-uuid. If you want to specify that, be sure that it&#x27;s unique.</div><div class=""> - ``group_names`` is by default set to **[main]**. All tasks have a ``group_name`` parameter, set to **main** by default. Workers can only pick up tasks of their assigned group.</div><div class=""> </div><div class=""> ------</div><div class=""> NB: This is useful if you have different workers instances (e.g. on different machines) and you want to assign tasks to a specific worker.</div><div class=""> </div><div class=""> NB2: It&#x27;s possible to assign a worker more groups, and they can be also all the same, as</div><div class=""> ------</div><div class=""> ``[&#x27;mygroup&#x27;,&#x27;mygroup&#x27;]``. Tasks will be distributed taking into consideration that</div><div class=""> a worker with group_names ``[&#x27;mygroup&#x27;,&#x27;mygroup&#x27;]`` is able to process the double of the tasks</div><div class=""> a worker with group_names ``[&#x27;mygroup&#x27;]`` is.</div><div class=""> - ``heartbeat`` is by default set to 3 seconds. This parameter is the one controlling how often a scheduler will check its status on the ``scheduler_worker`` table and see if there are any **ASSIGNED** tasks to itself to process.</div><div class=""> - ``max_empty_runs`` is 0 by default, that means that the worker will continue to process tasks as soon as they are **ASSIGNED**. If you set this to a value of, let&#x27;s say, 10, a worker will die automatically if it&#x27;s **ACTIVE** and no tasks are **ASSIGNED** to it for 10 loops. A loop is when a worker searches for tasks, every 3 seconds (or the set ``heartbeat``)</div><div class=""> - ``discard_results`` is False by default. If set to True, no scheduler_run records will be created.</div><div class=""> </div><div class=""> ------</div><div class=""> NB: scheduler_run records will be created as before for **FAILED**, **TIMEOUT** and **STOPPED** tasks&#x27;s statuses.</div><div class=""> ------</div><div class=""> </div><div class=""> - ``utc_time`` is False by default. If you need to coordinate with workers living in different timezones, or don&#x27;t have problems with solar/DST times, supplying datetimes from different countries, etc, you can set this to True. The scheduler will honor the UTC time and work leaving the local time aside. Caveat: you need to schedule tasks with UTC times (for start_time, stop_time, and so on.)</div><div class=""> http://127.0.0.1:8000/myapp/appadmin/insert/db/scheduler_task</div><div class=""> The meaning of the fields in this table is obvious. The &quot;args&quot; and &quot;vars&quot;&quot; fields are the values to be passed to the task in JSON format. In the case of the &quot;task_add&quot; above, an example of &quot;args&quot; and &quot;vars&quot; could be:</div><div class=""> </div><div class=""> ``</div><div class=""> args = [3, 4]</div><div class=""> vars = {}</div><div class=""> ``:code</div><div class=""> </div><div class=""> or</div><div class=""> </div><div class=""> ``</div><div class=""> args = []</div><div class=""> vars = {&#x27;a&#x27;:3, &#x27;b&#x27;:4}</div><div class=""> ``:code</div><div class=""> </div><div class=""> The ``scheduler_task`` table is the one where tasks are organized.</div><div class=""> </div><div class=""> All tasks follow a lifecycle</div><div class=""> </div><div class=""> [[scheduler tasks @///image/ce8edcc3.png center]]</div><div class=""> </div><div class="delete">-Let&#x27;s go with order. By default, when you send a task to the scheduler, you&#x27;ll want that to be executed. It&#x27;s in **QUEUED** status.</div><div class=""> If you need it to be executed later, use the ``start_time`` parameter (default = now).</div><div class="delete">-If for some reason you need to be sure that the task don&#x27;t get executed after a certain point in time (maybe a request to a web service</div><div class=""> that shuts down at 1AM, a mail that needs to be sent not after the working hours, etc...) you can set a ``stop_time`` (default = None) for it.</div><div class="delete">-If your task is NOT picked up by a worker before stop_time, it will be set as **EXPIRED**.</div><div class="delete">-Tasks with no stop_time set or picked up **BEFORE** stop_time are **ASSIGNED** to a worker. When a workers picks up them, they become **RUNNING**.</div><div class=""> **RUNNING** tasks may end up:</div><div class="delete">-- **TIMEOUT** when more than n seconds passed with ``timeout`` parameter (default = 60 seconds)</div><div class="delete">-- **FAILED** when an exception is detected</div><div class="delete">-- **COMPLETED** when all went ok</div><div class=""> </div><div class=""> Values for ``start_time`` and ``stop_time`` should be datetime objects. To schedule &quot;mytask&quot; to run at 30 seconds from the current time, for example, you would do the following:</div><div class=""> </div><div class=""> ``</div><div class=""> from datetime import timedelta as timed</div><div class=""> scheduler.queue_task(&#x27;mytask&#x27;,</div><div class="">     start_time=request.now + timed(seconds=30))</div><div class=""> ``:code</div><div class=""> </div><div class=""> Additionally, you can control how many times a task should be repeated (i.e. you need to aggregate some data at specified intervals). To do so, set the ``repeats``</div><div class=""> parameter (default = 1 time only, 0 = unlimited). You can influence how many seconds should pass between executions with the ``period`` parameter (default = 60 seconds).</div><div class=""> </div><div class=""> ------</div><div class="delete"><span class="highlight">NB: t</span>he time<span class="highlight"></span> is not calculated between the END of the first round and the START of the next, but from the START time of the first round to the START time of the next cycle)</div><div class=""> ------</div><div class=""> </div><div class="delete"><span class="highlight">Another nice addition, you can</span> set how many times the function can raise an exception (i.e. requesting data from a slow web service) and be queued again instead of stopping in **FAILED**  status <span class="highlight">with</span> the parameter ``retry_failed`` (default = 0, -1 = unlimited).</div><div class=""> </div><div class=""> [[task repeats @///image/7d8b85e4.png center]]</div><div class=""> </div><div class=""> Summary: you have</div><div class=""> - ``period`` and ``repeats`` to get an automatically rescheduled function</div><div class=""> - ``timeout`` to be sure that a function doesn&#x27;t exceed a certain amount of time</div><div class=""> - ``retry_failed`` to control how many times the task can &quot;fail&quot;</div><div class=""> - ``start_time`` and ``stop_time`` to schedule a function in a restricted timeframe</div><div class=""> </div><div class="delete">-##### queue_task() and task_status()</div><div class="delete">-- ``scheduler.queue_task(function, pargs=[], pvars={}, **kwargs)`` : accepts a lot of arguments, to make your life easier....</div><div class="delete">- -- ``function`` : required. This can be a string as ``&#x27;demo2&#x27;`` or directly the function, i.e. you can use ``scheduler.queue_task(demo2)``</div><div class="delete">- -- ``pargs`` : p stands for &quot;positional&quot;. pargs will accept your args as a list, without the need to jsonify them first.</div><div class="delete">- ------</div><div class="delete"><span class="highlight"></span> ``<span class="highlight">scheduler.</span>queue_task<span class="highlight">(demo1, [1,2])</span>``<span class="highlight"></span></div><div class=""> </div><div class="delete">- does the exact same thing as </div><div class=""> </div><div class="delete">- ``st.validate_and_insert(function_name = &#x27;demo1&#x27;, args=dumps([1,2]))``</div><div class=""> </div><div class="delete"><span class="highlight"></span> <span class="highlight"></span>a<span class="highlight">nd in a lot </span>le<span class="highlight">ss characters</span></div><div class=""> </div><div class="delete">- **NB**: if you do ``scheduler.queue_task(demo1, [1,2], args=dumps([2,3]))`` , ``args`` will prevail and the task will be queued with **2,3**</div><div class="delete">- ------</div><div class="delete">- -- ``pvars`` : as with ``pargs``, will accept your vars as a dict, without the need to jsonify them first.</div><div class="delete">- ------</div><div class="delete">- ``scheduler.queue_task(demo1, [], {&#x27;a&#x27;: 1, &#x27;b&#x27; : 2})`` or ``scheduler.queue_task(demo1, pvars={&#x27;a&#x27;: 1, &#x27;b&#x27; : 2})``</div><div class="">  </div><div class="delete"><span class="highlight"> </span>does the exact same thing as<span class="highlight"></span></div><div class=""> </div><div class="delete">- ``st.validate_and_insert(function_name = &#x27;demo1&#x27;, vars=dumps({&#x27;a&#x27;: 1, &#x27;b&#x27; : 2}))``</div><div class=""> </div><div class="delete">- **NB**:  if you do ``scheduler.queue_task(demo1, None, {&#x27;a&#x27;: 1, &#x27;b&#x27;: 2}, vars=dumps({&#x27;a&#x27;: 2, &#x27;b&#x27; : 3}))`` , ``vars`` will prevail and the task will be queued with **{&#x27;a&#x27;: 2, &#x27;b&#x27; : 3}**</div><div class="delete">- ------</div><div class="delete">- -- ``kwargs`` : all other scheduler_task columns can be passed as keywords arguments, e.g. :</div><div class="delete">-  ... ``</div><div class="delete">-       scheduler.queue_task(</div><div class="delete">-          demo1, [1,2], {a: 1, b : 2},</div><div class="delete">-          repeats = 0,</div><div class="delete">-          period = 180,</div><div class="delete">-       ....</div><div class="delete">-      )``:python</div><div class="delete"><span class="highlight"> -- since version 2.4.1 if you p</span>as<span class="highlight">s an additional parameter ``immediate=True`` it will force the main worker to reassign tasks. Until 2.4.1, the worker checks for new tasks every 5 cycles (so, ``5*heartbeats`` seconds). If you had an app that needed to check frequently for new tasks, to get a &#x27;&#x27;snappy&#x27;&#x27; behaviour you were forced to lower the ``heartbeat`` parameter, putting the db under pressure for no reason. With ``immediate=True`` you can force the check for new tasks: it will happen at most as ``heartbeat`` seconds are passed   </span></div><div class=""> </div><div class="delete">-The method returns the result of validate_and_insert, with the ``uuid`` of the task you queued (can be the one you passed or the auto-generated one).</div><div class=""> </div><div class="delete"><span class="highlight">``&lt;Row</span> <span class="highlight">{&#x27;error</span>s<span class="highlight">&#x27;</span>:<span class="highlight"> {}, &#x27;id&#x27;: 1, &#x27;uuid&#x27;: &#x27;08e6433a-cf07-4cea-a4cb-01f16ae5f414&#x27;}&gt;``</span></div><div class=""> </div><div class="delete">-If there are errors (e.g. you used ``period = &#x27;a&#x27;``), you&#x27;ll get the result of the validation, and id and uuid will be None</div><div class=""> </div><div class="delete"><span class="highlight">``&lt;Row {&#x27;</span>e<span class="highlight">rrors&#x27;: {&#x27;p</span>e<span class="highlight">rio</span>d<span class="highlight">&#x27;: &#x27;ent</span>er <span class="highlight">an</span> <span class="highlight">int</span>e<span class="highlight">g</span>er<span class="highlight"> greater</span> t<span class="highlight">h</span>a<span class="highlight">n </span>o<span class="highlight">r equ</span>a<span class="highlight">l to 0&#x27;}, &#x27;i</span>d<span class="highlight">&#x27;: None, &#x27;uui</span>d<span class="highlight">&#x27;: None}&gt;``</span></div><div class=""> </div><div class=""> </div><div class=""> ##### Results and output</div><div class=""> The table &quot;scheduler_run&quot; stores the status of all running tasks. Each record references a task that has been picked up by a worker.  One task can have multiple runs. For example, a task scheduled to repeat 10 times an hour will probably have 10 runs (unless one fails or they take longer than 1 hour). Beware that if the task has no return values, it is removed from the scheduler_run table as soon as it is finished.</div><div class=""> </div><div class=""> Possible run statuses are:</div><div class=""> </div><div class=""> ``</div><div class=""> RUNNING, COMPLETED, FAILED, TIMEOUT</div><div class=""> ``</div><div class=""> </div><div class=""> If the run is completed, no exceptions are thrown, and there is no task timeout, the run is marked as ``COMPLETED`` and the task is marked as ``QUEUED`` or ``COMPLETED`` depending on whether it is supposed to run again at a later time. The output of the task is serialized in JSON and stored in the run record.</div><div class=""> </div><div class=""> When a ``RUNNING`` task throws an exception, the run is mark as ``FAILED`` and the task is marked as ``FAILED``. The traceback is stored in the run record.</div><div class=""> </div><div class=""> Similarly, when a run exceeds the timeout, it is stopped and marked as ``TIMEOUT``, and the task is marked as ``TIMEOUT``.</div><div class=""> </div><div class=""> In any case, the stdout is captured and also logged into the run record.</div><div class=""> </div><div class=""> Using appadmin, one can check all ``RUNNING`` tasks, the output of ``COMPLETED`` tasks, the error of ``FAILED`` tasks, etc.</div><div class=""> </div><div class=""> The scheduler also creates one more table called &quot;scheduler_worker&quot;, which stores the workers&#x27; heartbeat and their status. Possible worker statuses are:</div><div class=""> </div><div class=""> ##### Managing processes</div><div class=""> Worker fine management is hard. This module tries not to leave behind any platform (Mac, Win, Linux) .</div><div class=""> </div><div class="delete">When you start a worker, you may <span class="highlight">want </span>later <span class="highlight"></span>to:</div><div class=""> - kill it &quot;no matter what it&#x27;s doing&quot;</div><div class="delete">- kill it only if it<span class="highlight">&#x27;</span>s not processing tasks</div><div class=""> - put it to sleep</div><div class=""> Maybe you have yet some tasks queued, and you want to save some resources.</div><div class=""> You know you want them processed every hour, so, you&#x27;ll want to:</div><div class=""> - process all queued tasks and die automatically</div><div class=""> All of these things are possible managing ``Scheduler`` parameters or the ``scheduler_worker`` table.</div><div class="delete">To be more precise, for started workers you <span class="highlight">will</span> change the ``status`` value of any worker to influence</div><div class=""> its behavior.</div><div class="delete">As<span class="highlight"></span> tasks, workers can be in <span class="highlight">s</span>o<span class="highlight">m</span>e f<span class="highlight"></span>i<span class="highlight">xed</span> statuses<span class="highlight"> </span>: ACTIVE, DISABLED, TERMINATE or KILLED.</div><div class=""> </div><div class=""> **ACTIVE** and **DISABLED** are &quot;persistent&quot;, while **TERMINATE** or **KILL**, as statuses</div><div class=""> name suggest, are more &quot;commands&quot; than real statuses.</div><div class=""> Hitting ctrl+c is equal to set a worker to **KILL**</div><div class=""> </div><div class=""> [[workers statuses @///image/bd891eed.png center]]</div><div class=""> </div><div class=""> There are a few commodity functions since version 2.4.1 (self-explanatory)</div><div class=""> ``</div><div class=""> scheduler.disable()</div><div class=""> scheduler.resume()</div><div class=""> scheduler.terminate()</div><div class=""> scheduler.kill()</div><div class=""> ``:code</div><div class=""> </div><div class=""> each function take an optional parameter, that can be a string or a list, to manage workers based on their ``group_names``. It defaults to the ``group_names`` defined in the scheduler istantiation.</div><div class=""> </div><div class=""> An example is better than a thousand words: ``scheduler.terminate(&#x27;high_prio&#x27;)`` will TERMINATE all the workers that are processing the ``high_prio`` tasks, while ``scheduler.terminate([&#x27;high_prio&#x27;, &#x27;low_prio&#x27;])`` will terminate all ``high_prio`` and ``low_prio`` workers.</div><div class=""> ------</div><div class=""> Watch out: if you have a worker processing ``high_prio`` and ``low_prio``, ``scheduler.terminate(&#x27;high_prio&#x27;)`` will terminate the worker alltogether, even if you didn&#x27;t want to terminate ``low_prio`` too.</div><div class=""> For example:</div><div class=""> ``</div><div class=""> scheduler.queue_task(</div><div class="">     function_name=&#x27;task_add&#x27;,</div><div class="">     pargs=[],</div><div class="">     pvars={&#x27;a&#x27;:3,&#x27;b&#x27;:4},</div><div class="">     repeats = 10, # run 10 times</div><div class="">     period = 3600, # every 1h</div><div class="">     timeout = 120, # should take less than 120 seconds</div><div class="">     )</div><div class=""> ``:code</div><div class=""> </div><div class=""> Notice that fields &quot;times_run&quot;, &quot;last_run_time&quot; and &quot;assigned_worker_name&quot; are not provided at schedule time but are filled automatically by the workers.</div><div class=""> </div><div class=""> You can also retrieve the output of completed tasks:</div><div class=""> </div><div class=""> ``</div><div class=""> completed_runs = db(db.scheduler_run.run_status=&#x27;COMPLETED&#x27;).select()</div><div class=""> ``:code</div><div class=""> </div><div class=""> ------</div><div class="delete">The scheduler is<span class="highlight"></span> experimental because it needs more extensive testing and because the table structure may change as more features are added.</div><div class=""> ------</div><div class=""> </div><div class=""> ##### Reporting percentages</div><div class=""> </div><div class=""> A special &quot;word&quot; encountered in the print statements of your functions clear all</div><div class=""> the previous output. That word is ``!clear!``.</div><div class=""> This, coupled with the ``sync_output`` parameter, allows to report percentages</div><div class="delete">-a breeze. Let&#x27;s see how that works:</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/1288bf1759b4610486e060ad6fec83b90983389f">1288bf1</a><ul><li>Date : 2013-02-22</li><li>In the news group on Feb 11, Massimo told me that track_changes only works for mmodules in the application; the book says something different so I have corrected it.</li></ul></li></ul>
<div class="row-fluid" id="com_1288bf1759b4610486e060ad6fec83b90983389f">
    <div class="span6"><div class="diff"><div class="insert">+From now on, every time a module is imported, the importer will check if the Python source file (.py) has changed. If it has changed, the module will be reloaded. </div><div class="insert">+Track changes only tracks changes for modules that are stored in the application.</div><div class=""> Modules that import ``current`` can access:</div><div class=""> - ``current.request``</div><div class=""> - ``current.response``</div><div class=""> - ``current.session``</div><div class=""> - ``current.cache``</div><div class=""> - ``current.T``</div><div class=""> and any other variable your application chooses to store in current. For example a model could do</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">-From now on, every time a module is imported, the importer will check if the Python source file (.py) has changed. If it has changed, the module will be reloaded. This applies to all Python modules, even Python modules outside web2py. The mode is global and applies to all applications. Changes made to models, controllers, and views are always reloaded regardless of the mode used. To turn the mode off, use the same function with ``False`` as the argument. To know the actual tracking state, use the ``is_tracking_changes()`` function, also from ``gluon.custom_import``.</div><div class="delete">-</div><div class=""> Modules that import ``current`` can access:</div><div class=""> - ``current.request``</div><div class=""> - ``current.response``</div><div class=""> - ``current.session``</div><div class=""> - ``current.cache``</div><div class=""> - ``current.T``</div><div class=""> and any other variable your application chooses to store in current. For example a model could do</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/a95fdc684888028417662225d97c7fc3534b6cd2">a95fdc6</a><ul><li>Date : 2013-02-14</li><li>documentation for new scheduler patches, thanks Niphlod</li></ul></li></ul>
<div class="row-fluid" id="com_a95fdc684888028417662225d97c7fc3534b6cd2">
    <div class="span6"><div class="diff"><div class="insert">+ -- since version 2.4.1 if you pass an additional parameter ``immediate=True`` it will force the main worker to reassign tasks. Until 2.4.1, the worker checks for new tasks every 5 cycles (so, ``5*heartbeats`` seconds). If you had an app that needed to check frequently for new tasks, to get a &#x27;&#x27;snappy&#x27;&#x27; behaviour you were forced to lower the ``heartbeat`` parameter, putting the db under pressure for no reason. With ``immediate=True`` you can force the check for new tasks: it will happen at most as ``heartbeat`` seconds are passed   </div><div class=""> </div><div class=""> The method returns the result of validate_and_insert, with the ``uuid`` of the task you queued (can be the one you passed or the auto-generated one).</div><div class=""> </div><div class=""> ``&lt;Row {&#x27;errors&#x27;: {}, &#x27;id&#x27;: 1, &#x27;uuid&#x27;: &#x27;08e6433a-cf07-4cea-a4cb-01f16ae5f414&#x27;}&gt;``</div><div class="">  </div><div class=""> If there are errors (e.g. you used ``period = &#x27;a&#x27;``), you&#x27;ll get the result of the validation, and id and uuid will be None</div><div class=""> </div><div class=""> ``&lt;Row {&#x27;errors&#x27;: {&#x27;period&#x27;: &#x27;enter an integer greater than or equal to 0&#x27;}, &#x27;id&#x27;: None, &#x27;uuid&#x27;: None}&gt;``</div><div class=""> </div><div class=""> </div><div class=""> ##### Results and output</div><div class=""> The table &quot;scheduler_run&quot; stores the status of all running tasks. Each record references a task that has been picked up by a worker.  One task can have multiple runs. For example, a task scheduled to repeat 10 times an hour will probably have 10 runs (unless one fails or they take longer than 1 hour). Beware that if the task has no return values, it is removed from the scheduler_run table as soon as it is finished.</div><div class=""> </div><div class=""> Possible run statuses are:</div><div class=""> </div><div class=""> ``</div><div class=""> RUNNING, COMPLETED, FAILED, TIMEOUT</div><div class=""> ``</div><div class=""> </div><div class=""> If the run is completed, no exceptions are thrown, and there is no task timeout, the run is marked as ``COMPLETED`` and the task is marked as ``QUEUED`` or ``COMPLETED`` depending on whether it is supposed to run again at a later time. The output of the task is serialized in JSON and stored in the run record.</div><div class=""> The scheduler also creates one more table called &quot;scheduler_worker&quot;, which store</div><div class=""> Worker fine management is hard. This module tries not to leave behind any platform (Mac, Win, Linux) .</div><div class=""> </div><div class=""> When you start a worker, you may want later to:</div><div class=""> - kill it &quot;no matter what it&#x27;s doing&quot;</div><div class=""> - kill it only if it&#x27;s not processing tasks</div><div class=""> - put it to sleep</div><div class=""> Maybe you have yet some tasks queued, and you want to save some resources.</div><div class=""> You know you want them processed every hour, so, you&#x27;ll want to:</div><div class=""> - process all queued tasks and die automatically</div><div class=""> All of these things are possible managing ``Scheduler`` parameters or the ``scheduler_worker`` table.</div><div class=""> To be more precise, for started workers you will change the ``status`` value of any worker to influence</div><div class=""> its behavior.</div><div class=""> As tasks, workers can be in some fixed statuses : ACTIVE, DISABLED, TERMINATE or KILLED.</div><div class=""> </div><div class=""> **ACTIVE** and **DISABLED** are &quot;persistent&quot;, while **TERMINATE** or **KILL**, as statuses</div><div class=""> name suggest, are more &quot;commands&quot; than real statuses.</div><div class=""> Hitting ctrl+c is equal to set a worker to **KILL**</div><div class=""> </div><div class=""> [[workers statuses @///image/bd891eed.png center]]</div><div class=""> </div><div class="insert">+There are a few commodity functions since version 2.4.1 (self-explanatory)</div><div class="insert">+``</div><div class="insert">+scheduler.disable()</div><div class="insert">+scheduler.resume()</div><div class="insert">+scheduler.terminate()</div><div class="insert">+scheduler.kill()</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+each function take an optional parameter, that can be a string or a list, to manage workers based on their ``group_names``. It defaults to the ``group_names`` defined in the scheduler istantiation.</div><div class="insert">+</div><div class="insert">+An example is better than a thousand words: ``scheduler.terminate(&#x27;high_prio&#x27;)`` will TERMINATE all the workers that are processing the ``high_prio`` tasks, while ``scheduler.terminate([&#x27;high_prio&#x27;, &#x27;low_prio&#x27;])`` will terminate all ``high_prio`` and ``low_prio`` workers.</div><div class="insert">+------</div><div class="insert">+Watch out: if you have a worker processing ``high_prio`` and ``low_prio``, ``scheduler.terminate(&#x27;high_prio&#x27;)`` will terminate the worker alltogether, even if you didn&#x27;t want to terminate ``low_prio`` too.</div><div class="insert">+------ </div><div class="insert">+</div><div class=""> Everything that one can do via appadmin one can do programmatically by inserting and updating records in these tables.</div></div></div>
    <div class="span6"><div class="diff"><div class=""> </div><div class=""> The method returns the result of validate_and_insert, with the ``uuid`` of the task you queued (can be the one you passed or the auto-generated one).</div><div class=""> </div><div class=""> ``&lt;Row {&#x27;errors&#x27;: {}, &#x27;id&#x27;: 1, &#x27;uuid&#x27;: &#x27;08e6433a-cf07-4cea-a4cb-01f16ae5f414&#x27;}&gt;``</div><div class="">  </div><div class=""> If there are errors (e.g. you used ``period = &#x27;a&#x27;``), you&#x27;ll get the result of the validation, and id and uuid will be None</div><div class=""> </div><div class=""> ``&lt;Row {&#x27;errors&#x27;: {&#x27;period&#x27;: &#x27;enter an integer greater than or equal to 0&#x27;}, &#x27;id&#x27;: None, &#x27;uuid&#x27;: None}&gt;``</div><div class=""> </div><div class=""> </div><div class=""> ##### Results and output</div><div class=""> The table &quot;scheduler_run&quot; stores the status of all running tasks. Each record references a task that has been picked up by a worker.  One task can have multiple runs. For example, a task scheduled to repeat 10 times an hour will probably have 10 runs (unless one fails or they take longer than 1 hour). Beware that if the task has no return values, it is removed from the scheduler_run table as soon as it is finished.</div><div class=""> </div><div class=""> Possible run statuses are:</div><div class=""> </div><div class=""> ``</div><div class=""> RUNNING, COMPLETED, FAILED, TIMEOUT</div><div class=""> ``</div><div class=""> </div><div class=""> If the run is completed, no exceptions are thrown, and there is no task timeout, the run is marked as ``COMPLETED`` and the task is marked as ``QUEUED`` or ``COMPLETED`` depending on whether it is supposed to run again at a later time. The output of the task is serialized in JSON and stored in the run record.</div><div class=""> The scheduler also creates one more table called &quot;scheduler_worker&quot;, which store</div><div class=""> Worker fine management is hard. This module tries not to leave behind any platform (Mac, Win, Linux) .</div><div class=""> </div><div class=""> When you start a worker, you may want later to:</div><div class=""> - kill it &quot;no matter what it&#x27;s doing&quot;</div><div class=""> - kill it only if it&#x27;s not processing tasks</div><div class=""> - put it to sleep</div><div class=""> Maybe you have yet some tasks queued, and you want to save some resources.</div><div class=""> You know you want them processed every hour, so, you&#x27;ll want to:</div><div class=""> - process all queued tasks and die automatically</div><div class=""> All of these things are possible managing ``Scheduler`` parameters or the ``scheduler_worker`` table.</div><div class=""> To be more precise, for started workers you will change the ``status`` value of any worker to influence</div><div class=""> its behavior.</div><div class=""> As tasks, workers can be in some fixed statuses : ACTIVE, DISABLED, TERMINATE or KILLED.</div><div class=""> </div><div class=""> **ACTIVE** and **DISABLED** are &quot;persistent&quot;, while **TERMINATE** or **KILL**, as statuses</div><div class=""> name suggest, are more &quot;commands&quot; than real statuses.</div><div class=""> Hitting ctrl+c is equal to set a worker to **KILL**</div><div class=""> </div><div class=""> [[workers statuses @///image/bd891eed.png center]]</div><div class=""> </div><div class=""> Everything that one can do via appadmin one can do programmatically by inserting and updating records in these tables.</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/be7f582b3cfaff86147de6fdd55e75f820082f81">be7f582</a><ul><li>Date : 2013-02-13</li><li>scheduler corrections</li></ul></li></ul>
<div class="row-fluid" id="com_be7f582b3cfaff86147de6fdd55e75f820082f81">
    <div class="span6"><div class="diff"><div class="insert">+Values for ``start_time`` and ``stop_time`` should be datetime objects. To schedule &quot;mytask&quot; to run at 30 seconds from the current time, for example, you would do the following:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+from datetime import timedelta as timed</div><div class="insert">+scheduler.queue_task(&#x27;mytask&#x27;,</div><div class="insert">+    start_time=request.now + timed(seconds=30))</div><div class="insert">+``:code</div><div class="insert">+</div><div class=""> Additionally, you can control how many times a task should be repeated (i.e. you need to aggregate some data at specified intervals). To do so, set the ``repeats``</div><div class=""> parameter (default = 1 time only, 0 = unlimited). You can influence how many seconds should pass between executions with the ``period`` parameter (default = 60 seconds).</div></div></div>
    <div class="span6"><div class="diff"><div class=""> Additionally, you can control how many times a task should be repeated (i.e. you need to aggregate some data at specified intervals). To do so, set the ``repeats``</div><div class=""> parameter (default = 1 time only, 0 = unlimited). You can influence how many seconds should pass between executions with the ``period`` parameter (default = 60 seconds).</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/d864cef3b68d807ffe8dbc10c26845734fefb97b">d864cef</a><ul><li>Date : 2013-02-04</li><li>fixed all but chap 6</li></ul></li></ul>
<div class="row-fluid" id="com_d864cef3b68d807ffe8dbc10c26845734fefb97b">
    <div class="span6"><div class="diff"><div class=""> The web2py workflow is the following:</div><div class=""> - An HTTP requests arrives to the web server (the built-in Rocket server or a different server connected to web2py via WSGI or another adapter). The web server handles each request in its own thread, in parallel.</div><div class=""> - The HTTP request header is parsed and passed to the dispatcher (explained later in this chapter).</div><div class=""> - The dispatcher decides which of the installed application will handle the request and maps the PATH_INFO in the URL into a function call. Each URL corresponds to one function call.</div><div class=""> - Requests for files in the static folder are handled directly, and large files are automatically streamed to the client.</div><div class=""> - Requests for anything but a static file are mapped into an action (i.e. a function in a controller file, in the requested application).</div><div class=""> - Before calling the action, a few things happen: if the request header contains a session cookie for the app, the session object is retrieved; if not, a session id is created (but the session file is not saved until later); an execution environment for the request is created; models are executed in this environment.</div><div class=""> - Finally the controller action is executed in the pre-built environment.</div><div class=""> - If the action returns a string, this is returned to the client (or if the action returns a web2py HTML helper object, it is serialized and returned to the client).</div><div class=""> - If the action returns an iterable, this is used to loop and stream the data to the client.</div><div class=""> - If the action returns a dictionary, web2py tries to locate a view to render the dictionary. The view must have the same name as the action (unless specified otherwise) and the same extension as the requested page (defaults to .html); on failure, web2py may pick up a generic view (if available and if enabled). The view sees every variable defined in the models as well as those in the dictionary returned by the action, but does not see global variables defined in the controller.</div><div class="insert">- The entire user code is executed in a single <span class="highlight">database </span>transaction unless specified otherwise.</div><div class=""> - If the user code succeeds, the transaction is committed.</div><div class=""> - If the user code fails, the traceback is stored in a ticket, and a ticket ID is issued to the client. Only the system administrator can search and read the tracebacks in tickets.</div><div class=""> </div><div class=""> There are some caveats to keep in mind:</div><div class=""> - Models in the same folder/subfolder are executed in alphabetical order.</div><div class=""> - Any variable defined in a model will be visible to other models following alphabetically, to the controllers, and to the views.</div><div class=""> - Models in subfolders are executed conditionally. For example, if the user has requested &quot;/a/c/f&quot; where &quot;a&quot; is the application, &quot;c&quot; is the controller, and &quot;f&quot; is the function (action), then the following models are executed:</div><div class=""> </div><div class=""> ``</div><div class=""> applications/a/models/*.py</div><div class=""> applications/a/models/c/*.py</div><div class=""> applications/a/models/c/f/*.py</div><div class=""> ``</div><div class=""> </div><div class=""> - The requested controller is executed and the requested function is called. This means all top-level code in the controller is also executed at every request for that controller.</div><div class=""> - The view is only called if the action returns a dictionary.</div><div class=""> - If a view is not found, web2py tries to use a generic view. By default, generic views are disabled, although the &#x27;welcome&#x27; app includes a line in /models/db.py to enable them on localhost only. They can be enabled per extension type and per action (using ``response.generic_patterns``). In general, generic views are a development tool and typically should not be used in production. If you want some actions to use a generic view, list those actions in ``response.generic_patterns`` (discussed in more detail in the chapter on Services).</div><div class=""> </div><div class=""> The possible behaviors of an action are the following:</div><div class=""> </div><div class=""> Notice that web2py validates all URLs to prevent directory traversal attacks.</div><div class=""> URLs are only allowed to contain alphanumeric characters, underscores, and slashes; the ``args`` may contain non-consecutive dots. Spaces are replaced by underscores before validation. If the URL syntax is invalid, web2py returns an HTTP 400 error message``http-w``:cite ``http-o``:cite .</div><div class=""> </div><div class=""> If the URL corresponds to a request for a static file, web2py simply reads and returns (streams) the requested file.</div><div class=""> </div><div class=""> If the URL does not request a static file, web2py processes the request in the following order:</div><div class=""> - Parses cookies.</div><div class=""> - Creates an environment in which to execute the function.</div><div class=""> - Initializes ``request``, ``response``, ``cache``.</div><div class=""> - Opens the existing ``session`` or creates a new one.</div><div class=""> - Executes the models belonging to the requested application.</div><div class=""> - Executes the requested controller action function.</div><div class=""> - If the function returns a dictionary, executes the associated view.</div><div class=""> - On success, commits all open transactions.</div><div class=""> - Saves the session.</div><div class=""> - Returns an HTTP response.</div><div class=""> </div><div class=""> Notice that the controller and the view are executed in different copies of the same environment; therefore, the view does not see the controller, but it sees the models and it sees the variables returned by the controller action function.</div><div class=""> </div><div class=""> If an exception (other than HTTP) is raised, web2py does the following:</div><div class=""> - Stores the traceback in an error file and assigns a ticket number to it.</div><div class="insert">- Rolls back all open <span class="highlight">database </span>transactions.</div><div class=""> - Returns an error page reporting the ticket number.</div><div class=""> </div><div class=""> If the exception is an ``HTTP`` exception, this is assumed to be the intended behavior (for example, an ``HTTP`` redirect), and all open database transactions are committed. The behavior after that is specified by the ``HTTP`` exception itself. The ``HTTP`` exception class is not a standard Python exception; it is defined by web2py.</div><div class=""> </div><div class=""> ### Libraries</div><div class=""> </div><div class=""> The web2py libraries are exposed to the user applications as global objects. For example (``request``, ``response``, ``session``, ``cache``), classes (helpers,  validators, DAL API), and functions (``T`` and ``redirect``).</div><div class=""> </div><div class=""> These objects are defined in the following core files:</div><div class=""> ``</div><div class=""> web2py.py</div><div class=""> gluon/__init__.py    gluon/highlight.py   gluon/restricted.py  gluon/streamer.py</div><div class=""> gluon/admin.py       gluon/html.py        gluon/rewrite.py     gluon/template.py</div><div class=""> gluon/cache.py       gluon/http.py        gluon/rocket.py      gluon/storage.py</div><div class=""> gluon/cfs.py         gluon/import_all.py  gluon/sanitizer.py   gluon/tools.py</div><div class=""> gluon/compileapp.py  gluon/languages.py   gluon/serializers.py gluon/utils.py</div><div class=""> gluon/contenttype.py gluon/main.py        gluon/settings.py    gluon/validators.py</div><div class=""> gluon/dal.py         gluon/myregex.py     gluon/shell.py       gluon/widget.py</div><div class=""> gluon/decoder.py     gluon/newcron.py     gluon/sql.py         gluon/winservice.py</div><div class=""> gluon/fileutils.py   gluon/portalocker.py gluon/sqlhtml.py     gluon/xmlrpc.py</div><div class=""> gluon/globals.py     gluon/reserved_sql_keywords.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> ------</div><div class=""> Notice that many of these modules, specifically ``dal`` (the Database Abstraction Layer), ``template`` (the template language), ``rocket`` (the web server), and</div><div class=""> ``html`` (the helpers) have no dependencies and can be used outside of web2py.</div><div class=""> -----</div><div class=""> </div><div class=""> The tar gzipped scaffolding app that ship with web2py is</div><div class=""> ``</div><div class=""> welcome.w2p</div><div class=""> ``:code</div><div class=""> </div><div class=""> This is created upon installation and overwritten on upgrade.</div><div class=""> </div><div class=""> -------</div><div class=""> The first time you start web2py, two new folders are created: deposit and applications. The deposit folder is used as temporary storage for installing and uninstalling applications.</div><div class=""> </div><div class=""> Also, the first time you start web2py and after an upgrade, the &quot;welcome&quot; app is zipped into a &quot;welcome.w2p&quot; file to be used as a scaffolding app.</div><div class=""> -------</div><div class=""> </div><div class="insert">When web2py is upgraded it comes with a file called &quot;NEWINSTALL&quot;. If web2py finds this file, it understand<span class="highlight">s</span> an upgrade was performed, hence it removed the file and creates a new &quot;welcome.w2p&quot;.</div><div class=""> </div><div class=""> The current web2py version is stored in the field &quot;VERSION&quot; and it follows standard semantic versioning notation where the build id is the build timestamp.</div><div class=""> </div><div class=""> web2py unit-tests are in</div><div class=""> ``</div><div class=""> gluon/tests/</div><div class=""> ``:code</div><div class=""> </div><div class=""> There are handlers for connecting with various web servers:</div><div class=""> ``</div><div class=""> cgihandler.py       # discouraged</div><div class=""> gaehandler.py       # for Google App Engine</div><div class=""> fcgihandler.py      # for FastCGI</div><div class=""> wsgihandler.py      # for WSGI</div><div class=""> isapiwsgihandler.py # for IIS</div><div class=""> modpythonhandler.py # deprecated</div><div class=""> ``:code</div><div class=""> </div><div class=""> (&quot;fcgihandler&quot; calls  &quot;gluon/contrib/gateways/fcgi.py&quot; developed by Allan Saddi) and</div><div class=""> </div><div class=""> gluon/contrib/rss2.py</div><div class=""> ``</div><div class=""> gluon/contrib/simplejson/</div><div class=""> ``:code</div><div class=""> </div><div class=""> **Google Wallet** ``googlewallet``:cite</div><div class=""> provides &quot;pay now&quot; buttons which link Google as payment processor:</div><div class=""> ``</div><div class=""> gluon/contrib/google_wallet.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> **Stripe.com** ``stripe``:cite provides a simple API for accepting credit card payments:</div><div class=""> ``</div><div class=""> gluon/contrib/stripe.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> **AuthorizeNet** ``authorizenet``:cite  provides API to accept credit card payments via Authorize.net network</div><div class=""> ``</div><div class=""> gluon/contrib/AuthorizeNet.py</div><div class=""> ``:code</div><div class=""> </div><div class="insert">**Dowcommerce** ``dowcommerce``:cite credit car<span class="highlight">d</span> processing API:</div><div class=""> ``</div><div class=""> gluon/contrib/DowCommerce.py</div><div class=""> ``:code</div><div class=""> </div><div class="insert">**PaymentTech** credit car<span class="highlight">d</span> processing API:</div><div class=""> </div><div class=""> ``</div><div class=""> gluon/contrib/paymentech.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> **PAM**``PAM``:cite  authentication API created by Chris AtLee:</div><div class=""> ``</div><div class=""> gluon/contrib/pam.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> A Bayesian classifier to populate the database with dummy data for testing purposes:</div><div class=""> ``</div><div class=""> gluon/contrib/populate.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> A file with API for running on Heroku.com : ``heroku``:inxx</div><div class=""> </div><div class=""> ``</div><div class=""> gluon/contrib/heroku.py</div><div class=""> ``:code</div><div class=""> Applications developed in web2py are composed of the following parts:</div><div class=""> - **databases** store SQLite databases and additional table information.</div><div class=""> - **cache** store cached application items.</div><div class=""> - **modules** are other optional Python modules.</div><div class=""> - **private** files are accessed by the controllers but not directly by the developer.</div><div class=""> - **uploads** files are accessed by the models but not directly by the developer (e.g., files uploaded by users of the application).</div><div class=""> - **tests** is a directory for storing test scripts, fixtures and mocks.</div><div class=""> </div><div class=""> Models, views, controllers, languages, and static files are accessible via the web administration [design] interface. ABOUT, README, and errors are also accessible via the administration interface through the corresponding menu items. Sessions, cache, modules and private files are accessible to the applications but not via the administration interface.</div><div class=""> </div><div class=""> Everything is neatly organized in a clear directory structure that is replicated for every installed web2py application, although the user never needs to access the filesystem directly:</div><div class=""> </div><div class=""> ``about``:inxx ``license``:inxx ``cache``:inxx ``controllers``:inxx ``databases``:inxx ``errors``:inxx ``languages``:inxx ``models``:inxx ``modules``:inxx ``private``:inxx ``session``:inxx ``static``:inxx ``tests``:inxx ``uploads``:inxx ``views``:inxx ``__init__.py``:inxx</div><div class=""> ``</div><div class=""> __init__.py  ABOUT        LICENSE    models    views</div><div class=""> controllers  modules      private    tests     cron</div><div class=""> cache        errors       upload     sessions  static</div><div class=""> ``:code</div><div class=""> </div><div class=""> &quot;__init__.py&quot; is an empty file which is required in order to allow Python (and web2py) to import the modules in the ``modules`` directory.</div><div class=""> </div><div class="insert">Notice that the **admin** application simply provides a web interface to web2py applications on the server file system. web2py applications can also be created and developed from the command-line<span class="highlight"> or your preferred text editor/IDE</span>; you don&#x27;t have to use the browser **admin** interface.  A new application can be created manually by replicating the above directory structure under ,e.g., &quot;applications/newapp/&quot; (or simply untar the ``welcome.w2p`` file into your new application directory). Application files can also be created and edited from the command-line without having to use the web **admin** interface.</div><div class=""> </div><div class=""> ### API</div><div class=""> </div><div class=""> Models, controllers, and views are executed in an environment where the following objects are already imported for us:</div><div class=""> </div><div class=""> **Global Objects:** ``request``:inxx ``response``:inxx ``session``:inxx ``cache``:inxx</div><div class=""> </div><div class=""> ``</div><div class=""> request, response, session, cache</div><div class=""> ``:code</div><div class=""> </div><div class=""> **Internationalization:** ``T``:inxx ``internationalization``:inxx</div><div class=""> </div><div class=""> ``</div><div class=""> T</div><div class=""> ``:code</div><div class=""> </div><div class=""> **Navigation:** ``redirect``:inxx ``HTTP``:inxx</div><div class=""> </div><div class=""> ``</div><div class=""> IS_UPLOAD_FILENAME, IS_UPPER, IS_URL</div><div class=""> </div><div class=""> **Database:** ``DAL``:inxx</div><div class=""> </div><div class=""> ``</div><div class=""> DAL, Field</div><div class=""> ``:code</div><div class=""> </div><div class=""> For backward compatibility ``SQLDB=DAL`` and ``SQLField=Field``. We encourage you to use the new syntax ``DAL`` and ``Field``, instead of the old syntax.</div><div class=""> </div><div class=""> Other objects and modules are defined in the libraries, but they are not automatically imported since they are not used as often.</div><div class=""> </div><div class=""> The core API entities in the web2py execution environment are ``request``, ``response``, ``session``, ``cache``, ``URL``, ``HTTP``, ``redirect`` and ``T`` and are discussed below.</div><div class=""> </div><div class=""> A few objects and functions, including **Auth**, **Crud** and **Service**, are defined in &quot;gluon/tools.py&quot; and they need to be imported as necessary:</div><div class=""> ``</div><div class=""> from gluon.tools import Auth, Crud, Service</div><div class=""> ``:code</div><div class=""> </div><div class=""> #### Accessing the API from Python modules</div><div class=""> </div><div class="insert">Your models or controller may import python modules, and these may need to use some of the web2py API. The way <span class="highlight"></span>to do it is<span class="highlight"> by</span> importing them:</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon import *</div><div class=""> ``</div><div class=""> </div><div class=""> In fact, any Python module, even if not imported by a web2py application, can import the web2py API as long as web2py is in the ``sys.path``.</div><div class=""> </div><div class=""> There is one caveat, though. Web2py defines some global objects (request, response, session, cache, T) that can only exist when an HTTP request is present (or is faked). Therefore, modules can access them only if they are called from an application. For this reasons they are placed into a container caller ``current``, which is a thread local object. Here is an example.</div><div class=""> </div><div class=""> Create a module &quot;/myapp/modules/test.py&quot; that contains:</div><div class=""> ``</div><div class=""> from gluon import *</div><div class=""> def ip(): return current.request.client</div><div class=""> ``</div><div class=""> Now from a controller in &quot;myapp&quot; you can do</div><div class=""> ``</div><div class=""> import test</div><div class=""> def index():</div><div class="">     return &quot;Your ip is &quot; + test.ip()</div><div class=""> ``</div><div class=""> Unlike a dictionary, if an attribute (or key) does not exist, it does not raise</div><div class=""> -----</div><div class=""> It is sometimes useful to create your own Storage objects. You can do so as follows:</div><div class=""> ``</div><div class=""> from gluon.storage import Storage</div><div class=""> my_storage = Storage() # empty storage object</div><div class=""> my_other_storage = Storage(dict(a=1, b=2)) # convert dictionary to Storage</div><div class=""> ``:code</div><div class=""> -----</div><div class=""> </div><div class=""> ``request`` has the following items/attributes, some of which are also an instance of the ``Storage`` class:</div><div class=""> - ``request.cookies``: a ``Cookie.SimpleCookie()`` object containing the cookies passed with the HTTP request. It acts like a dictionary of cookies. Each cookie is a Morsel object (see http://docs.python.org/2/library/cookie.html#id2).</div><div class=""> - ``request.env``: a ``Storage`` object containing the environment variables passed to the controller, including HTTP header variables from the HTTP request and standard WSGI parameters. The environment variables are all converted to lower case, and dots are converted to underscores for easier memorization.</div><div class=""> - ``request.application``: the name of the requested application (parsed from ``request.env.path_info``).</div><div class=""> - ``request.controller``: the name of the requested controller (parsed from the ``request.env.path_info``).</div><div class=""> - ``request.function``: the name of the requested function (parsed from the ``request.env.path_info``).</div><div class=""> - ``request.extension``: the extension of the requested action. It defaults to &quot;html&quot;. If the controller function returns a dictionary and does not specify a view, this is used to determine the extension of the view file that will render the dictionary (parsed from the ``request.env.path_info``).</div><div class=""> - ``request.folder``: the application directory. For example if the application is &quot;welcome&quot;, ``request.folder`` is set to the absolute path &quot;/path/to/welcome&quot;. In your programs, you should always use this variable and the ``os.path.join`` function to build paths to the files you need to access. Although web2py always uses absolute paths, it is a good rule never to explicitly  change the current working folder (whatever that is) since this is not a thread-safe practice.</div><div class=""> - ``request.now``: a ``datetime.datetime`` object storing the datetime of the current request.</div><div class=""> - ``request.utcnow``: a ``datetime.datetime`` object storing the UTC datetime of the current request.</div><div class=""> - ``request.args``: A list of the URL path components following the controller function name; equivalent to ``request.env.path_info.split(&#x27;/&#x27;)[3:]``</div><div class="insert">- ``request.vars``: a ``gluon.storage.Storage`` object containing <span class="highlight">both </span>the HTTP GET and HTTP POST query variables.</div><div class=""> - ``request.get_vars``: a ``gluon.storage.Storage`` object containing only the HTTP GET query variables.</div><div class=""> - ``request.post_vars``: a ``gluon.storage.Storage`` object containing only the HTTP POST query variables.</div><div class=""> - ``request.client``: The ip address of the client as determined by, if present, ``request.env.http_x_forwarded_for`` or by ``request.env.remote_addr`` otherwise. While this is useful it should not be trusted because the ``http_x_forwarded_for`` can be spoofed.</div><div class=""> - ``request.is_local``: ``True`` if the client is localhost, ``False`` otherwise. Should work behind a proxy if the proxy supports ``http_x_forwarded_for``.</div><div class=""> - ``request.is_https``: ``True`` if the request is using the HTTPS protocol, ``False`` otherwise.</div><div class=""> - ``request.body``: a read-only file stream that contains the body of the HTTP request. This is automatically parsed to get the ``request.post_vars`` and then rewinded. It can be read with ``request.body.read()``.</div><div class=""> - ``request.ajax`` is True if the function is being called via an Ajax request.</div><div class=""> - ``request.cid`` is the ``id`` of the component that generated the Ajax request (if any). You can read more about components in Chapter 12.</div><div class=""> - ``request.requires_https()`` prevents further code execution if the request is not over HTTPS and redirects the visitor to the current page over HTTPS.</div><div class=""> - ``request.restful`` this is a new and very useful decorator that can be used to change the default behavior of web2py actions by separating GET/POST/PUSH/DELETE requests. It will be discussed in some detail in Chapter 10.</div><div class=""> - ``request.user_agent()`` parses the user_agent field from the client and returns the information in the form of a dictionary. It is useful to detect mobile devices. It uses &quot;gluon/contrib/user_agent_parser.py&quot; created by Ross Peoples. To see what it does, try to embed the following code in a view:</div><div class=""> ``</div><div class=""> {{=BEAUTIFY(request.user_agent())}}</div><div class=""> ``:code</div><div class=""> </div><div class="insert">- ``request.global_settings`` ``request.global_settings``:inxx contains web2py <span class="highlight">system </span>wide s<span class="highlight"></span>ettings. They are set automatically a<span class="highlight">nd you should not </span>c<span class="highlight">hange them. For example ``request.global_settings.gluon_parent``</span> c<span class="highlight">ontains the full path to the web2py folder,</span> ``request.global_settings.<span class="highlight">is_pypy`` determines i</span>f<span class="highlight"></span> web2py <span class="highlight"></span>is running on PyPy.</div><div class=""> </div><div class=""> - ``request.wsgi`` is a hook that allows you to call third party WSGI applications from inside actions</div><div class=""> </div><div class=""> The latter includes:</div><div class=""> - ``request.wsgi.environ``</div><div class=""> - ``request.wsgi.start_response``</div><div class=""> - ``request.wsgi.middleware``</div><div class=""> their usage is discussed at the end of this Chapter.</div><div class=""> </div><div class=""> As an example, the following call on a typical system:</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/examples/default/status/x/y/z?p=1&amp;q=2</div><div class=""> ``:code</div><div class=""> </div><div class=""> results in the following ``request`` object:</div><div class=""> ``request``:inxx ``env``:inxx</div><div class=""> </div><div class=""> ----------</div><div class=""> **variable** | **value**</div><div class=""> Also notice the ``request.env.wsgi_*`` variables. They are specific to the wsgi</div><div class=""> ``response.status``:inxx</div><div class=""> ``response.stream``:inxx</div><div class=""> ``response.subtitle``:inxx</div><div class=""> ``response.title``:inxx</div><div class=""> ``response.toolbar``:inxx</div><div class=""> ``response.view``:inxx</div><div class=""> ``response.delimiters``:inxx</div><div class=""> ``response.js``:inxx</div><div class=""> ``response.write``:inxx</div><div class=""> ``response.include_files``:inxx</div><div class=""> ``response.include_meta``:inxx</div><div class=""> ``response.optimize_css``:inxx</div><div class=""> ``response.optimize_js``:inxx</div><div class=""> ``response._caller``:inxx</div><div class=""> </div><div class=""> ``response`` is another instance of the ``Storage`` class. It contains the following:</div><div class=""> </div><div class=""> - ``response.body``: a ``StringIO`` object into which web2py writes the output page body. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.cookies``: similar to ``request.cookies``, but while the latter contains the cookies sent from the client to the server, the former contains cookies sent by the server to the client. The session cookie is handled automatically.</div><div class=""> - ``response.download(request, db)``: a method used to implement the controller function that allows downloading of uploaded files. ``request.download`` expects the last ``arg`` in ``request.args`` to be the encoded filename (i.e., the filename generated at upload time and stored in the upload field). It extracts the upload field name and table name as well as the original filename from the encoded filename. ``response.download`` takes two optional arguments: ``chunk_size`` sets the size in bytes for chunked streaming (defaults to 64K), and ``attachments`` determines whether the downloaded file should be treated as an attachment or not (default to ``True``). Note, ``response.download`` is specifically for downloading files associated with ``db`` upload fields. Use ``response.stream`` (see below) for other types of file downloads and streaming. Also, note that it is not necessary to use ``response.download`` to access files uploaded to the /static folder -- static files can (and generally should) be accessed directly via URL (e.g., /app/static/files/myfile.pdf).</div><div class="insert">- ``response.files``: a list of .css, .js, coffee, and .less files required by the page. They will automatically be linked in the head of the standard &quot;layout.html&quot; via the included &quot;web2py_ajax.html&quot;. To include a new CSS, JS, COFFEE, or LESS file, just append it to this list. It will handle duplicates. The order is <span class="highlight">important.</span></div><div class=""> - ``response.include_files()`` generates html head tags to include all ``response.files`` (used in &quot;views/web2py_ajax.html&quot;).</div><div class=""> - ``response.flash``: optional parameter that may be included in the views. Normally used to notify the user about something that happened.</div><div class="insert">- ``response.headers``: a ``dict`` for HTTP response headers. Web2py sets some headers by default, including &quot;Content-Length&quot;, &quot;Content-Type&quot;, and &quot;X-Powered-By&quot; (set equal to web2py). Web2py also sets the &quot;Cache-Control&quot;, &quot;Expires&quot;, and &quot;Pragma&quot; headers to prevent client-side caching, except for static file requests, for which client-side caching is enabled. The headers that web2py sets can be overwritten or removed, and new headers can be added (e.g., ``response.headers[&#x27;Cache-Control&#x27;] = &#x27;private&#x27;``). You can remove a header <span class="highlight">by </span>removing its key from the response.headers dict, e.g.``del response.headers[&#x27;Custom-Header&#x27;]``, however web2py&#x27;s default headers will be re-added just before returning the response. To avoid this behavior, just set the header value to None, e.g. to remove the default Content-Type header, ``response.headers[&#x27;Content-Type&#x27;] = None``</div><div class=""> - ``response.menu``: optional parameter that may be included in the views, normally used to pass a navigation menu tree to the view. It can be rendered by the MENU helper.</div><div class=""> - ``response.meta``: a storage object (like a dict) that contains optional meta information like ``response.meta.author``, ``.description``, and/or ``.keywords``. The content of each meta variable is automatically placed in the proper ``META`` tag by the code in &quot;views/web2py_ajax.html&quot;, which is included by default in &quot;views/layout.html&quot;.</div><div class=""> - ``response.include_meta()`` generates a string that includes all ``response.meta`` headers serialized (used in &quot;views/web2py_ajax.html&quot;).</div><div class=""> - ``response.postprocessing``: this is a list of functions, empty by default. These functions are used to filter the response object at the output of an action, before the output is rendered by the view. It can be used to implement support for other template languages.</div><div class=""> - ``response.render(view, vars)``: a method used to call the view explicitly inside the controller. ``view`` is an optional parameter which is the name of the view file, ``vars`` is a dictionary of named values passed to the view.</div><div class=""> - ``response.session_file``: file stream containing the session.</div><div class=""> - ``response.session_file_name``: name of the file where the session will be saved.</div><div class=""> - ``response.session_id``: the id of the current session. It is determined automatically. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.session_id_name``: the name of the session cookie for this application. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.status``: the HTTP status code integer to be passed to the response. Default is 200 (OK).</div><div class=""> - ``response.stream(file, chunk_size, request=request, attachment=False, filename=None, headers=None)``: when a controller returns it, web2py streams the file content back to the client in blocks of size ``chunk_size``. The ``request`` parameter is required to use the chunk start in the HTTP header. ``file`` should be a file path (for backward compatibility, it can also be an open file object, but this is not recommended). As noted above, ``response.download`` should be used to retrieve files stored via an upload field. ``response.stream`` can be used in other cases, such as returning a temporary file or StringIO object created by the controller. If ``attachment`` is True, the Content-Disposition header will be set to &quot;attachment&quot;, and if ``filename`` is also provided, it will be added to the Content-Disposition header as well (but only when ``attachment`` is True). If not already included in ``response.headers``, the following response headers will be set automatically: Content-Type, Content-Length, Cache-Control, Pragma, and Last-Modified (the latter three are set to allow browser caching of the file). To override any of these automatic header settings, simply set them in ``response.headers`` before calling ``response.stream``.</div><div class=""> - ``response.subtitle``: optional parameter that may be included in the views. It should contain the subtitle of the page.</div><div class=""> - ``response.title``: optional parameter that may be included in the views. It should contain the title of the page and should be rendered by the HTML title TAG in the header.</div><div class=""> - ``response.toolbar``: a function that allows you to embed a toolbar into page for debugging purposes ``{{=response.toolbar()}}``. The toolbar displays request, response, session variables and database access time for each query.</div><div class=""> - ``response._vars``: this variable is accessible only in a view, not in the action. It contains the value returned by the action to the view.</div><div class="insert">- ``response._caller``: this is a function that wraps all action calls. It defaults to the identity function, but it can be modif<span class="highlight">i</span>ed in order to catch special types of exception to do extra logging;</div><div class="">   ``</div><div class="">   response._caller = lambda f: f()</div><div class="">   ``</div><div class=""> - ``response.optimize_css``: if can be set to &quot;concat,minify,inline&quot; to concatenate, minify and inline the CSS files included by web2py.</div><div class=""> - ``response.optimize_js``: if can be set to &quot;concat,minify,inline&quot; to concatenate, minify and inline the JavaScript files included by web2py.</div><div class=""> - ``response.view``: the name of the view template that must render the page. This is set by default to:</div><div class="">   ``</div><div class="">   &quot;%s/%s.%s&quot; % (request.controller, request.function, request.extension)</div><div class="">   ``:code</div><div class="">   or, if the above file cannot be located, to</div><div class="">   ``</div><div class="">   &quot;generic.%s&quot; % (request.extension)</div><div class="">   ``:code</div><div class="">   Change the value of this variable to modify the view file associated with a particular action.</div><div class=""> </div><div class=""> - ``response.delimiters`` defaults to ``(&#x27;{{&#x27;,&#x27;}}&#x27;)``. It allows you to change the delimiter of code embedded in views.</div><div class=""> - ``response.xmlrpc(request, methods)``: when a controller returns it, this function exposes the methods via XML-RPC``xmlrpc``:cite . This function is deprecated since a better mechanism is available and described in Chapter 10.</div><div class=""> - ``response.write(text)``: a method to write text into the output page body.</div><div class=""> - ``response.js`` can contain Javascript code. This code will be executed if and only if the response is received by a web2py component as discussed in Chapter 12.</div><div class=""> </div><div class=""> Since ``response`` is a ``gluon.storage.Storage`` object, it can be used to store other attributes that you may want to pass to the view. While there is no technical restriction, our recommendation is to store only variables that are to be rendered by all pages in the overall layout (&quot;layout.html&quot;).</div><div class=""> </div><div class=""> Anyway, we strongly suggest to stick to the variables listed here:</div><div class=""> ``</div><div class=""> response.title</div><div class=""> response.subtitle</div><div class=""> response.flash</div><div class=""> response.menu</div><div class=""> response.meta.author</div><div class=""> response.meta.description</div><div class=""> response.meta.keywords</div><div class=""> response.meta.*</div><div class=""> ``:code</div><div class=""> </div><div class=""> because this will make it easier for you to replace the standard &quot;layout.html&quot; file that comes with web2py with another layout file, one that uses the same set of variables.</div><div class=""> </div><div class="insert">Old versions of web2py use<span class="highlight">d</span> ``response.author`` instead of ``response.meta.author`` and similar for the other meta attributes.</div><div class=""> </div><div class=""> ### ``session``</div><div class=""> ``session``:inxx ``session.connect``:inxx ``session.forget``:inxx ``session.secure``:inxx</div><div class=""> ``session`` is another instance of the ``Storage`` class. Whatever is stored into ``session`` for example:</div><div class=""> ``</div><div class=""> session.myvariable = &quot;hello&quot;</div><div class=""> ``:code</div><div class=""> </div><div class=""> can be retrieved at a later time:</div><div class=""> ``</div><div class=""> a = session.myvariable</div><div class=""> ``:code</div><div class=""> </div><div class="insert">as long as the code is executed within the same session by the same user (provided the user has not deleted session cookies and the session <span class="highlight">has</span> not expire<span class="highlight">d</span>). Because ``session`` is a ``Storage`` object, trying to access an attribute/key that has not been set does not raise an exception; it returns ``None`` instead.</div><div class=""> </div><div class=""> The session object has three important methods. One is ``forget``:</div><div class=""> ``</div><div class=""> session.forget(response)</div><div class=""> ``:code</div><div class=""> </div><div class="insert">It tells web2py not to save the session. This should be used in those controllers whose actions are called often and do not need to track user activity. ``session.forget()`` prevents the session file from being written, regardless of whether it has been modified. ``session.forget(response)`` additionally unlocks and closes the session file. You rarely need to call this method since sessions are not saved when they are not changed. However, if the page makes multiple simultaneous Ajax requests, it is a good idea for the actions called via Ajax to call ``session.forget(response)`` (assuming the session is not needed by the action). Otherwise, each Ajax action will have to wait for the previous one to complete (and unlock the session file) before proceeding, which will slow down the page loading. Notice that sessions are not locked when stored in <span class="highlight">the </span>database.</div><div class=""> </div><div class=""> Another method is:</div><div class=""> </div><div class=""> ``</div><div class=""> session.secure()</div><div class=""> ``:code</div><div class=""> </div><div class=""> which tells web2py to set the session cookie to be a secure cookie. This should be set if the app is going over https. By setting the session cookie to be secure, the server is asking the browser not to send the session cookie back to the server unless over an https connection.</div><div class=""> </div><div class=""> The other method is ``connect``.</div><div class=""> By default sessions are stored on the filesystem and a session cookie is used to store and retrieve the ``session.id``. Using the connect method it is possible to tell web2y to store sessions in the database or in the cookies thus eliminating need to access the filesystem for session management.</div><div class=""> </div><div class=""> For example to **store sessions in the database**:</div><div class=""> </div><div class=""> ``</div><div class=""> session.connect(request, response, db, masterapp=None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> where ``db`` is the name of an open database connection (as returned by the DAL). It tells web2py that you want to store the sessions in the database and not on the filesystem. ``session.connect`` must come after ``db=DAL(...)``, but before any other logic that requires session, for example, setting up ``Auth``.</div><div class=""> </div><div class=""> To **store sessions in cookies** instead you can do:</div><div class=""> session.connect(request,response,cookie_key=&#x27;yoursecret&#x27;,compression_level=None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Here ``cookie_key`` is a symmetric encryption key.</div><div class=""> ``compression_level`` is an optional ``zlib`` encryption level.</div><div class=""> </div><div class=""> While sessions in cookie are often recommended for scalability reason they are limited in size. Large sessions will result in broken cookies.</div><div class=""> </div><div class=""> You can check the state of your application at any time by printing the ``request``, ``session`` and ``response`` system variables. One way to do it is to create a dedicated action:</div><div class=""> ``</div><div class=""> def status():</div><div class="">     return dict(request=request, session=session, response=response)</div><div class=""> ``:code</div><div class=""> </div><div class=""> In the &quot;generic.html&quot; view this is done using ``{{=response.toolbar()}}``.</div><div class=""> </div><div class=""> </div><div class=""> #### Separate sessions</div><div class=""> </div><div class=""> If you are storing sessions on filesystems and you have lots of them, the file system access may become a bottle-neck. One solution is the following:</div><div class="insert">+If you are storing sessions on filesystem and you have lots of them, the file system access may become a bottle-neck. One solution is the following:</div><div class=""> ``</div><div class=""> session.connect(request, response, separate=True)</div><div class=""> ``:code</div><div class=""> </div><div class=""> By setting ``separate=True`` web2py will store sessions not in the &quot;sessions/&quot; folder but in subfolders of the &quot;sessions/&quot; folder. The subfolder will be created automatically. Sessions with the same prefix will be in the same subfolder. Again, note that the above must be called before any logic that might require the session.</div><div class=""> </div><div class=""> ### ``cache``</div><div class=""> ``cache``:inxx ``cache.ram``:inxx ``cache.disk``:inxx</div><div class=""> ``cache`` a global object also available in the web2py execution environment. It has two attributes:</div><div class=""> - ``cache.ram``: the application cache in main memory.</div><div class=""> - ``cache.disk``: the application cache on disk.</div><div class=""> ``cache`` is callable, this allows it to be used as a decorator for caching actions and views.</div><div class=""> </div><div class=""> The following example caches the ``time.ctime()`` function in RAM:</div><div class=""> ``</div><div class=""> def cache_in_ram():</div><div class="">     import time</div><div class="">     t = cache.ram(&#x27;time&#x27;, lambda: time.ctime(), time_expire=5)</div><div class="">     return dict(time=t, link=A(&#x27;click me&#x27;, _href=request.url))</div><div class=""> ``:code</div><div class=""> def cache_on_disk():</div><div class="">     return dict(time=t, link=A(&#x27;click me&#x27;, _href=request.url))</div><div class=""> ``:code</div><div class=""> </div><div class=""> The output of ``lambda: time.ctime()`` is cached on disk (using the shelve module) for 5 seconds.</div><div class=""> </div><div class=""> Note, the second argument to ``cache.ram`` and ``cache.disk`` must be a function or callable object. If you want to cache an existing object rather than the output of a function, you can simply return it via a lambda function:</div><div class=""> ``</div><div class=""> cache.ram(&#x27;myobject&#x27;, lambda: myobject, time_expire=60*60*24)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The next example caches the ``time.ctime()`` function to both RAM and disk:</div><div class=""> ``</div><div class=""> def cache_in_ram_and_disk():</div><div class="">     import time</div><div class="">     t = cache.ram(&#x27;time&#x27;, lambda: cache.disk(&#x27;time&#x27;,</div><div class="">                        lambda: time.ctime(), time_expire=5),</div><div class="">                        time_expire=5)</div><div class="">     return dict(time=t, link=A(&#x27;click me&#x27;, _href=request.url))</div><div class=""> ``:code</div><div class=""> </div><div class="insert">The output of ``lambda: time.ctime()`` is cached on disk (using the shelve module) and then in RAM for 5 seconds. web2py looks in RAM first and if not there it looks on disk. If it is not in RAM or on disk, ``lambda: time.ctime()`` is executed and the cache is updated. This technique is useful in a multiprocess<span class="highlight">or</span> environment. The two times do not have to be the same.</div><div class=""> </div><div class=""> The following example is caching in RAM the output of the controller function (but not the view):</div><div class=""> </div><div class=""> ``cache controller``:inxx</div><div class=""> ``</div><div class=""> @cache(request.env.path_info, time_expire=5, cache_model=cache.ram)</div><div class=""> def cache_controller_in_ram():</div><div class="">     import time</div><div class="">     t = time.ctime()</div><div class="">     return dict(time=t, link=A(&#x27;click me&#x27;, _href=request.url))</div><div class=""> ``:code</div><div class=""> </div><div class="insert">The dictionary returned by ``cache_controller_in_ram`` is cached in RAM for 5 seconds. Note that the result of a database select cannot be cached without first being serialized. A better way is to cache the database select directly using the ``select`` method<span class="highlight">&#x27;s</span> ``cache`` argument.</div><div class=""> </div><div class=""> The following example is caching the output of the controller function on disk (but not the view):</div><div class=""> ``</div><div class=""> @cache(request.env.path_info, time_expire=5, cache_model=cache.disk)</div><div class=""> def cache_controller_on_disk():</div><div class="">     import time</div><div class="">     t = time.ctime()</div><div class="">     return dict(time=t, link=A(&#x27;click to reload&#x27;,</div><div class="">                               _href=request.url))</div><div class=""> ``:code</div><div class=""> </div><div class=""> The dictionary returned by ``cache_controller_on_disk``  is cached on disk for 5 seconds. Remember that web2py cannot cache a dictionary that contains un-pickleable objects.</div><div class=""> </div><div class=""> It is also possible to cache the view. The trick is to render the view in the controller function, so that the controller returns a string. This is done by returning ``response.render(d)`` where ``d`` is the dictionary we intended to pass to the view. The following example caches the output of the controller function in RAM (including the rendered view):</div><div class=""> </div><div class=""> ``cache view``:inxx</div><div class=""> ``</div><div class=""> @cache(request.env.path_info, time_expire=5, cache_model=cache.ram)</div><div class=""> def cache_controller_and_view():</div><div class="">     import time</div><div class=""> Note, ``time_expire`` is used to compare the current time with the time the requ</div><div class=""> ``</div><div class=""> message = cache.ram(&#x27;message&#x27;, lambda: &#x27;Hello&#x27;, time_expire=5)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Now, suppose the following call is made 10 seconds after the above call:</div><div class=""> ``</div><div class=""> message = cache.ram(&#x27;message&#x27;, lambda: &#x27;Goodbye&#x27;, time_expire=20)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Because ``time_expire`` is set to 20 seconds in the second call and only 10 seconds has elapsed since the message was first saved, the value &quot;Hello&quot; will be retrieved from the cache, and it will not be updated with &quot;Goodbye&quot;. The ``time_expire`` value of 5 seconds in the first call has no impact on the second call.</div><div class=""> </div><div class=""> Setting ``time_expire=0`` (or a negative value) forces the cached item to be refreshed (because the elapsed time since the last save will always be &gt; 0), and setting ``time_expire=None`` forces retrieval of the cached value, regardless of the time elapsed since it was saved (if ``time_expire`` is always ``None``, the cached item will effectively never expire).</div><div class=""> </div><div class=""> You can clear one or more cache variables with</div><div class=""> ``cache clear``:inxx</div><div class=""> </div><div class=""> ``</div><div class=""> cache.ram.clear(regex=&#x27;...&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class="insert">where ``regex`` is a regular expression matching all the keys you want removed from the cache. You can also clear a<span class="highlight"></span> single item with:</div><div class=""> ``</div><div class=""> cache.ram(key, None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> where ``key`` is the key of the cached item.</div><div class=""> </div><div class=""> It is also possible to define other caching mechanisms such as memcache. Memcache is available via ``gluon.contrib.memcache`` and is discussed in more details in Chapter 14.</div><div class=""> </div><div class=""> ------</div><div class="insert">Be careful when caching<span class="highlight"> to remeber</span> that caching is usually at the app-level not at the user level. If you need, for example, to cache user specific content, choose a key that includes the user id.</div><div class=""> ------</div><div class=""> </div><div class=""> </div><div class=""> ### ``URL``</div><div class=""> ``URL``:inxx</div><div class=""> The ``URL`` function is one of the most important functions in web2py. It generates internal URL paths for the actions and the static files.</div><div class=""> </div><div class=""> Here is an example:</div><div class=""> </div><div class=""> ``</div><div class=""> URL(&#x27;f&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> is mapped into</div><div class=""> </div><div class=""> ``</div><div class=""> /[application]/[controller]/f</div><div class=""> ``:code</div><div class=""> </div><div class=""> Notice that the output of the ``URL`` function depends on the name of the current application, the calling controller, and other parameters. web2py supports URL mapping and reverse URL mapping. URL mapping allows you to redefine the format of external URLs. If you use the ``URL`` function to generate all the internal URLs, then additions or changes to URL mappings will prevent broken links within the web2py application.</div><div class=""> The most common way to use redirect is to redirect to other pages in the same ap</div><div class=""> redirect(URL(&#x27;index&#x27;, args=(1,2,3), vars=dict(a=&#x27;b&#x27;)))</div><div class=""> ``:code</div><div class=""> </div><div class=""> In chapter 12 we discuss web2py components. They make Ajax requests to web2py actions. If the called action performs a redirect, you may want the Ajax request to follow the redirect or you may want the entire page performing the Ajax request redirecting. In this latter case you can set:</div><div class=""> </div><div class=""> ``</div><div class=""> redirect(...,type=&#x27;auto&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> ### ``T``, Internationalization, and Pluralization</div><div class=""> ``T``:inxx ``internationalization``:inxx</div><div class=""> </div><div class=""> The object ``T`` is the language translator. It constitutes a single global instance of the web2py class ``gluon.language.translator``. All string constants (and only string constants) should be marked by ``T``, for example:</div><div class=""> ``</div><div class=""> a = T(&quot;hello world&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Strings that are marked with ``T`` are identified by web2py as needing language translation and they will be translated when the code (in the model, controller, or view) is executed. If the string to be translated is not a constant but a variable, it will be added to the translation file at runtime (except on GAE) to be translated later.</div><div class=""> </div><div class="insert">The ``T`` object can also contain interpolated variables and support<span class="highlight">s</span> multiple equivalent syntax<span class="highlight">es</span>:</div><div class=""> ``</div><div class=""> a = T(&quot;hello %s&quot;, (&#x27;Tim&#x27;,))</div><div class=""> a = T(&quot;hello %(name)s&quot;, dict(name=&#x27;Tim&#x27;))</div><div class=""> a = T(&quot;hello %s&quot;) % (&#x27;Tim&#x27;,)</div><div class=""> a = T(&quot;hello %(name)s&quot;) % dict(name=&#x27;Tim&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The latter syntax is recommended because it makes translation easier.</div><div class=""> The first string is translated according to the requested language file and the ``name`` variable is replaced independently of the language.</div><div class=""> </div><div class=""> You can concatenating translated strings and normal strings:</div><div class=""> ``</div><div class=""> T(&quot;blah &quot;) + name + T(&quot; blah&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The following code is also allowed and often preferable:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;blah %(name)s blah&quot;, dict(name=&#x27;Tim&#x27;))</div><div class=""> ``:code</div><div class=""> T(&quot;blah %(name)s blah&quot; % dict(name=&#x27;Tim&#x27;))</div><div class=""> ``:code</div><div class=""> </div><div class=""> because translation would occur after substitution.</div><div class=""> </div><div class=""> #### Determining the language</div><div class=""> </div><div class=""> The requested language is determined by the &quot;Accept-Language&quot; field in the HTTP header, but this selection can be overwritten programmatically by requesting a specific file, for example:</div><div class=""> ``</div><div class=""> T.force(&#x27;it-it&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> which reads the &quot;languages/it-it.py&quot; language file. Language files can be created and edited via the administrative interface.</div><div class=""> </div><div class=""> You can also force a per-string language:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;Hello World&quot;, language=&quot;it-it&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> --------------</div><div class="insert">In the case multiple languages are requested, for example &quot;it-it, fr-ft&quot;, web2py tries to locate &quot;it-it.py&quot; and &quot;fr-fr.py&quot; translation files. If none of the requested files is present, it tries to fall<span class="highlight"> </span>back on &quot;it.py&quot; and &quot;fr.py&quot;. If these files are not present it defaults to &quot;default.py&quot;. If this is not present either, it default to no-translation. The more general rule is that web2py tries &quot;xx-xy-yy.py&quot;, &quot;xx-xy.py&quot;, &quot;xx.py&quot;, &quot;default.py&quot; for each of the &quot;xx-xy-yy&quot; accepted languages trying to find the closest match to the visitor&#x27;s preferences.</div><div class=""> -------------</div><div class=""> </div><div class=""> You can turn off translations completely via</div><div class=""> </div><div class=""> ``</div><div class=""> T.force(None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Normally, string translation is evaluated lazily when the view is rendered; hence, the translator ``force`` method should not be called inside a view.</div><div class=""> </div><div class=""> It is possible to disable lazy evaluation via</div><div class=""> ``</div><div class=""> T.lazy = False</div><div class=""> ``:code</div><div class=""> </div><div class=""> In this way, strings are translated immediately by the ``T`` operator based on the currently accepted or forced language.</div><div class=""> </div><div class=""> It is also possible to disable lazy evaluation for individual strings:</div><div class=""> </div><div class=""> ``</div><div class=""> Notice that this can result in lots of file IO and you may want to disable it:</div><div class=""> </div><div class=""> ``</div><div class=""> T.is_writable = False</div><div class=""> ``:code</div><div class=""> </div><div class=""> prevents T from dynamically updating language files.</div><div class=""> </div><div class=""> #### Comments and multiple translations</div><div class=""> </div><div class=""> It is possible that the same string appears in different contexts in the application and needs different translations based on context. In order to do this, one can add comments to the original string. The comments will not be rendered but will be used by web2py to determine the most appropriate translation. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;hello world ## first occurrence&quot;)</div><div class=""> T(&quot;hello world ## second occurrence&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The text following the ``##``, including the double ``##``, are comments.</div><div class=""> </div><div class=""> #### Pluralization engine</div><div class=""> </div><div class="insert">Since version 2.0, web2py includes a powerful pluralization system (PS). This means that when text marked for translation depends on a numeric variable, it may be translated differently based on the numeric value. For example in <span class="highlight">E</span>nglish we may render:</div><div class=""> </div><div class=""> ``</div><div class=""> x book(s)</div><div class=""> ``</div><div class=""> </div><div class=""> with</div><div class=""> </div><div class=""> ``</div><div class=""> a book (x==0)</div><div class=""> x books (x&gt;0)</div><div class=""> ``</div><div class=""> </div><div class=""> English has one singular form and one plural form. The plural form is constructed by adding a &quot;-s&quot; or &quot;-es&quot; or using an exceptional form. web2py provides a way to define pluralization rules for each languages, as well as exceptions to the default rules. In fact web2py already knows pluralization rules for many languages. It knows, for example, that Slovenian has one singular form and 3 plural forms (for x==1, x==3 or x==4 and x&gt;4). These rules are encoded in &quot;gluon/contrib/plural_rules/*.py&quot; files and new files can be created. Explicit pluralizations for words are created by editing pluralization files using the administrative interface.</div><div class=""> </div><div class=""> By default the PS is not activated. It is triggered by the ``symbol`` argument of the ``T`` function. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;You have %s %%{book}&quot;, symbols=10)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Now the PS is activated for the word &quot;book&quot; and for the number 10.</div><div class="insert">The result in <span class="highlight">E</span>nglish will be: &quot;You have 10 books&quot;. Notice that &quot;book&quot; has been pluralized into &quot;books&quot;.</div><div class=""> </div><div class="insert">The PS consists <span class="highlight">o</span>f<span class="highlight"></span> 3 parts:</div><div class=""> - placeholders ``%%{}`` to mark words in ``T``-messages</div><div class=""> - rule to give a decision which word form to use (&quot;rules/plural_rules/*.py&quot;)</div><div class=""> - dictionary with word plural forms (&quot;app/languages/plural-*.py&quot;)</div><div class=""> </div><div class=""> The value of symbols can be a single variable, a list/tuple of variables, or a dictionary.</div><div class=""> </div><div class=""> The placeholder ``%%{}`` consists of 3 parts:</div><div class=""> </div><div class=""> ``</div><div class=""> %%{[&lt;modifier&gt;]&lt;world&gt;[&lt;parameter&gt;]},</div><div class=""> ``</div><div class=""> </div><div class=""> where:</div><div class=""> </div><div class=""> ``</div><div class=""> &lt;modifier&gt;::= ! | !! | !!!</div><div class=""> &lt;word&gt; ::= any word or phrase in singular in lower case (!)</div><div class=""> &lt;parameter&gt; ::= [index] | (key) | (number)</div><div class=""> ``</div><div class=""> </div><div class=""> T(&quot;blabla %(var1)s %(wordcnt)s %%{word(wordcnt)}&quot;,</div><div class=""> ``</div><div class=""> </div><div class=""> which produces</div><div class=""> </div><div class=""> ``</div><div class=""> blabla tututu 20 words</div><div class=""> ``</div><div class=""> </div><div class=""> You can replace &quot;1&quot; with any word you wish by this placeholder ``%%{?word?number}``.</div><div class=""> For example</div><div class=""> </div><div class=""> ``T(&quot;%%{this} %%{is} %%{?a?%s} %%{book}&quot;, var)``</div><div class=""> </div><div class=""> produces:</div><div class=""> </div><div class=""> ``</div><div class=""> var  output</div><div class=""> ------------------</div><div class="">  1   this is a book</div><div class="">  2   these are 2 books</div><div class="insert"> 3   these are <span class="highlight">3</span> books</div><div class="">  ...</div><div class=""> ``</div><div class=""> </div><div class=""> Inside ``%%{...}`` you can also use the following modifiers:</div><div class=""> </div><div class=""> - ``!`` to capitalize the text (equivalent to ``string.capitalize``)</div><div class=""> - ``!!`` to capitalize every word (equivalent to ``string.title``)</div><div class=""> - ``!!!`` to capitalize every character (equivalent to ``string.upper``)</div><div class=""> </div><div class=""> Notice you can use ``\\`` to escape ``!`` and ``?``.</div><div class=""> </div><div class=""> #### Translations, pluralization, and MARKMIN</div><div class=""> </div><div class=""> You can also use the powerful MARKMIN syntax inside translation strings by replacing</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;hello world&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> with</div><div class=""> python web2py.py -a yourpass -K myapp -X</div><div class=""> You can pass the usual parameters (-i, -p, here -a prevents the window from showing up), pass whatever app in the -K parameter and append a -X. The scheduler will run alongside the webserver!</div><div class=""> </div><div class=""> Scheduler&#x27;s complete signature is:</div><div class=""> </div><div class=""> ``</div><div class=""> Scheduler(</div><div class="">     db,</div><div class="">     tasks=None,</div><div class="">     migrate=True,</div><div class="">     worker_name=None,</div><div class="">     group_names=None,</div><div class="">     heartbeat=HEARTBEAT,</div><div class="">     max_empty_runs=0,</div><div class="">     discard_results=False,</div><div class="">     utc_time=False</div><div class=""> )</div><div class=""> ``:code</div><div class=""> </div><div class=""> Let&#x27;s see them in order:</div><div class=""> </div><div class="insert">- ``db`` is the database DAL instance w<span class="highlight">h</span>ere you want the scheduler tables be placed.</div><div class=""> - ``tasks`` can be a dict. Must be defined if you want to call a function not by his name, i.e. ``tasks=dict(mynameddemo1=task_add)`` will let you execute function demo1 with ``scheduler.queue_task(&#x27;mynameddemo1&#x27;)`` instead of ``scheduler.queue_task(&#x27;task_add&#x27;)``. If you don&#x27;t pass this parameter, function will be searched in the app environment.</div><div class=""> - ``worker_name`` is None by default. As soon as the worker is started, a worker name is generated as hostname-uuid. If you want to specify that, be sure that it&#x27;s unique.</div><div class=""> - ``group_names`` is by default set to **[main]**. All tasks have a ``group_name`` parameter, set to **main** by default. Workers can only pick up tasks of their assigned group.</div><div class=""> </div><div class=""> ------</div><div class=""> NB: This is useful if you have different workers instances (e.g. on different machines) and you want to assign tasks to a specific worker.</div><div class=""> </div><div class=""> NB2: It&#x27;s possible to assign a worker more groups, and they can be also all the same, as</div><div class=""> ------</div><div class=""> ``[&#x27;mygroup&#x27;,&#x27;mygroup&#x27;]``. Tasks will be distributed taking into consideration that</div><div class=""> a worker with group_names ``[&#x27;mygroup&#x27;,&#x27;mygroup&#x27;]`` is able to process the double of the tasks</div><div class=""> a worker with group_names ``[&#x27;mygroup&#x27;]`` is.</div><div class=""> - ``heartbeat`` is by default set to 3 seconds. This parameter is the one controlling how often a scheduler will check its status on the ``scheduler_worker`` table and see if there are any **ASSIGNED** tasks to itself to process.</div><div class=""> - ``max_empty_runs`` is 0 by default, that means that the worker will continue to process tasks as soon as they are **ASSIGNED**. If you set this to a value of, let&#x27;s say, 10, a worker will die automatically if it&#x27;s **ACTIVE** and no tasks are **ASSIGNED** to it for 10 loops. A loop is when a worker searches for tasks, every 3 seconds (or the set ``heartbeat``)</div><div class=""> - ``discard_results`` is False by default. If set to True, no scheduler_run records will be created.</div><div class=""> </div><div class=""> ------</div><div class=""> NB: scheduler_run records will be created as before for **FAILED**, **TIMEOUT** and **STOPPED** tasks&#x27;s statuses.</div><div class=""> ------</div><div class=""> </div><div class=""> The meaning of the fields in this table is obvious. The &quot;args&quot; and &quot;vars&quot;&quot; field</div><div class=""> ``</div><div class=""> args = [3, 4]</div><div class=""> vars = {}</div><div class=""> ``:code</div><div class=""> </div><div class=""> or</div><div class=""> </div><div class=""> ``</div><div class=""> args = []</div><div class=""> vars = {&#x27;a&#x27;:3, &#x27;b&#x27;:4}</div><div class=""> ``:code</div><div class=""> </div><div class=""> The ``scheduler_task`` table is the one where tasks are organized.</div><div class=""> </div><div class=""> All tasks follow a lifecycle</div><div class=""> </div><div class=""> [[scheduler tasks @///image/ce8edcc3.png center]]</div><div class=""> </div><div class=""> Let&#x27;s go with order. By default, when you send a task to the scheduler, you&#x27;ll want that to be executed. It&#x27;s in **QUEUED** status.</div><div class=""> If you need it to be executed later, use the ``start_time`` parameter (default = now).</div><div class="insert">If for some reason you need to be sure that the task don&#x27;t get executed after a certain point in time (maybe a request to a web<span class="highlight"> </span>service</div><div class=""> that shuts down at 1AM, a mail that needs to be sent not after the working hours, etc...) you can set a ``stop_time`` (default = None) for it.</div><div class=""> If your task is NOT picked up by a worker before stop_time, it will be set as **EXPIRED**.</div><div class=""> Tasks with no stop_time set or picked up **BEFORE** stop_time are **ASSIGNED** to a worker. When a workers picks up them, they become **RUNNING**.</div><div class=""> **RUNNING** tasks may end up:</div><div class=""> - **TIMEOUT** when more than n seconds passed with ``timeout`` parameter (default = 60 seconds)</div><div class=""> - **FAILED** when an exception is detected</div><div class=""> - **COMPLETED** when all went ok</div><div class=""> </div><div class=""> Additionally, you can control how many times a task should be repeated (i.e. you need to aggregate some data at specified intervals). To do so, set the ``repeats``</div><div class=""> parameter (default = 1 time only, 0 = unlimited). You can influence how many seconds should pass between executions with the ``period`` parameter (default = 60 seconds).</div><div class=""> </div><div class=""> ------</div><div class=""> NB: the time is not calculated between the END of the first round and the START of the next, but from the START time of the first round to the START time of the next cycle)</div><div class=""> ------</div><div class=""> </div><div class="insert">Another nice addition, you can set how many times the function can raise an exception (i.e. requesting data from a slow web<span class="highlight"> </span>service) and be queued again instead of stopping in **FAILED**  status with the parameter ``retry_failed`` (default = 0, -1 = unlimited).</div></div></div>
    <div class="span6"><div class="diff"><div class=""> The web2py workflow is the following:</div><div class=""> - An HTTP requests arrives to the web server (the built-in Rocket server or a different server connected to web2py via WSGI or another adapter). The web server handles each request in its own thread, in parallel.</div><div class=""> - The HTTP request header is parsed and passed to the dispatcher (explained later in this chapter).</div><div class=""> - The dispatcher decides which of the installed application will handle the request and maps the PATH_INFO in the URL into a function call. Each URL corresponds to one function call.</div><div class=""> - Requests for files in the static folder are handled directly, and large files are automatically streamed to the client.</div><div class=""> - Requests for anything but a static file are mapped into an action (i.e. a function in a controller file, in the requested application).</div><div class=""> - Before calling the action, a few things happen: if the request header contains a session cookie for the app, the session object is retrieved; if not, a session id is created (but the session file is not saved until later); an execution environment for the request is created; models are executed in this environment.</div><div class=""> - Finally the controller action is executed in the pre-built environment.</div><div class=""> - If the action returns a string, this is returned to the client (or if the action returns a web2py HTML helper object, it is serialized and returned to the client).</div><div class=""> - If the action returns an iterable, this is used to loop and stream the data to the client.</div><div class=""> - If the action returns a dictionary, web2py tries to locate a view to render the dictionary. The view must have the same name as the action (unless specified otherwise) and the same extension as the requested page (defaults to .html); on failure, web2py may pick up a generic view (if available and if enabled). The view sees every variable defined in the models as well as those in the dictionary returned by the action, but does not see global variables defined in the controller.</div><div class="delete">- The entire user code is executed in a single <span class="highlight"></span>transaction unless specified otherwise.</div><div class=""> - If the user code succeeds, the transaction is committed.</div><div class=""> - If the user code fails, the traceback is stored in a ticket, and a ticket ID is issued to the client. Only the system administrator can search and read the tracebacks in tickets.</div><div class=""> </div><div class=""> There are some caveats to keep in mind:</div><div class=""> - Models in the same folder/subfolder are executed in alphabetical order.</div><div class=""> - Any variable defined in a model will be visible to other models following alphabetically, to the controllers, and to the views.</div><div class=""> - Models in subfolders are executed conditionally. For example, if the user has requested &quot;/a/c/f&quot; where &quot;a&quot; is the application, &quot;c&quot; is the controller, and &quot;f&quot; is the function (action), then the following models are executed:</div><div class=""> </div><div class=""> ``</div><div class=""> applications/a/models/*.py</div><div class=""> applications/a/models/c/*.py</div><div class=""> applications/a/models/c/f/*.py</div><div class=""> ``</div><div class=""> </div><div class=""> - The requested controller is executed and the requested function is called. This means all top-level code in the controller is also executed at every request for that controller.</div><div class=""> - The view is only called if the action returns a dictionary.</div><div class=""> - If a view is not found, web2py tries to use a generic view. By default, generic views are disabled, although the &#x27;welcome&#x27; app includes a line in /models/db.py to enable them on localhost only. They can be enabled per extension type and per action (using ``response.generic_patterns``). In general, generic views are a development tool and typically should not be used in production. If you want some actions to use a generic view, list those actions in ``response.generic_patterns`` (discussed in more detail in the chapter on Services).</div><div class=""> </div><div class=""> The possible behaviors of an action are the following:</div><div class=""> </div><div class=""> Notice that web2py validates all URLs to prevent directory traversal attacks.</div><div class=""> URLs are only allowed to contain alphanumeric characters, underscores, and slashes; the ``args`` may contain non-consecutive dots. Spaces are replaced by underscores before validation. If the URL syntax is invalid, web2py returns an HTTP 400 error message``http-w``:cite ``http-o``:cite .</div><div class=""> </div><div class=""> If the URL corresponds to a request for a static file, web2py simply reads and returns (streams) the requested file.</div><div class=""> </div><div class=""> If the URL does not request a static file, web2py processes the request in the following order:</div><div class=""> - Parses cookies.</div><div class=""> - Creates an environment in which to execute the function.</div><div class=""> - Initializes ``request``, ``response``, ``cache``.</div><div class=""> - Opens the existing ``session`` or creates a new one.</div><div class=""> - Executes the models belonging to the requested application.</div><div class=""> - Executes the requested controller action function.</div><div class=""> - If the function returns a dictionary, executes the associated view.</div><div class=""> - On success, commits all open transactions.</div><div class=""> - Saves the session.</div><div class=""> - Returns an HTTP response.</div><div class=""> </div><div class=""> Notice that the controller and the view are executed in different copies of the same environment; therefore, the view does not see the controller, but it sees the models and it sees the variables returned by the controller action function.</div><div class=""> </div><div class=""> If an exception (other than HTTP) is raised, web2py does the following:</div><div class=""> - Stores the traceback in an error file and assigns a ticket number to it.</div><div class="delete">- Rolls back all open <span class="highlight"></span>transactions.</div><div class=""> - Returns an error page reporting the ticket number.</div><div class=""> </div><div class=""> If the exception is an ``HTTP`` exception, this is assumed to be the intended behavior (for example, an ``HTTP`` redirect), and all open database transactions are committed. The behavior after that is specified by the ``HTTP`` exception itself. The ``HTTP`` exception class is not a standard Python exception; it is defined by web2py.</div><div class=""> </div><div class=""> ### Libraries</div><div class=""> </div><div class=""> The web2py libraries are exposed to the user applications as global objects. For example (``request``, ``response``, ``session``, ``cache``), classes (helpers,  validators, DAL API), and functions (``T`` and ``redirect``).</div><div class=""> </div><div class=""> These objects are defined in the following core files:</div><div class=""> ``</div><div class=""> web2py.py</div><div class=""> gluon/__init__.py    gluon/highlight.py   gluon/restricted.py  gluon/streamer.py</div><div class=""> gluon/admin.py       gluon/html.py        gluon/rewrite.py     gluon/template.py</div><div class=""> gluon/cache.py       gluon/http.py        gluon/rocket.py      gluon/storage.py</div><div class=""> gluon/cfs.py         gluon/import_all.py  gluon/sanitizer.py   gluon/tools.py</div><div class=""> gluon/compileapp.py  gluon/languages.py   gluon/serializers.py gluon/utils.py</div><div class=""> gluon/contenttype.py gluon/main.py        gluon/settings.py    gluon/validators.py</div><div class=""> gluon/dal.py         gluon/myregex.py     gluon/shell.py       gluon/widget.py</div><div class=""> gluon/decoder.py     gluon/newcron.py     gluon/sql.py         gluon/winservice.py</div><div class=""> gluon/fileutils.py   gluon/portalocker.py gluon/sqlhtml.py     gluon/xmlrpc.py</div><div class=""> gluon/globals.py     gluon/reserved_sql_keywords.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> ------</div><div class=""> Notice that many of these modules, specifically ``dal`` (the Database Abstraction Layer), ``template`` (the template language), ``rocket`` (the web server), and</div><div class=""> ``html`` (the helpers) have no dependencies and can be used outside of web2py.</div><div class=""> -----</div><div class=""> </div><div class=""> The tar gzipped scaffolding app that ship with web2py is</div><div class=""> ``</div><div class=""> welcome.w2p</div><div class=""> ``:code</div><div class=""> </div><div class=""> This is created upon installation and overwritten on upgrade.</div><div class=""> </div><div class=""> -------</div><div class=""> The first time you start web2py, two new folders are created: deposit and applications. The deposit folder is used as temporary storage for installing and uninstalling applications.</div><div class=""> </div><div class=""> Also, the first time you start web2py and after an upgrade, the &quot;welcome&quot; app is zipped into a &quot;welcome.w2p&quot; file to be used as a scaffolding app.</div><div class=""> -------</div><div class=""> </div><div class="delete">When web2py is upgraded it comes with a file called &quot;NEWINSTALL&quot;. If web2py finds this file, it understand<span class="highlight"></span> an upgrade was performed, hence it removed the file and creates a new &quot;welcome.w2p&quot;.</div><div class=""> </div><div class=""> The current web2py version is stored in the field &quot;VERSION&quot; and it follows standard semantic versioning notation where the build id is the build timestamp.</div><div class=""> </div><div class=""> web2py unit-tests are in</div><div class=""> ``</div><div class=""> gluon/tests/</div><div class=""> ``:code</div><div class=""> </div><div class=""> There are handlers for connecting with various web servers:</div><div class=""> ``</div><div class=""> cgihandler.py       # discouraged</div><div class=""> gaehandler.py       # for Google App Engine</div><div class=""> fcgihandler.py      # for FastCGI</div><div class=""> wsgihandler.py      # for WSGI</div><div class=""> isapiwsgihandler.py # for IIS</div><div class=""> modpythonhandler.py # deprecated</div><div class=""> ``:code</div><div class=""> </div><div class=""> (&quot;fcgihandler&quot; calls  &quot;gluon/contrib/gateways/fcgi.py&quot; developed by Allan Saddi) and</div><div class=""> </div><div class=""> gluon/contrib/rss2.py</div><div class=""> ``</div><div class=""> gluon/contrib/simplejson/</div><div class=""> ``:code</div><div class=""> </div><div class=""> **Google Wallet** ``googlewallet``:cite</div><div class=""> provides &quot;pay now&quot; buttons which link Google as payment processor:</div><div class=""> ``</div><div class=""> gluon/contrib/google_wallet.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> **Stripe.com** ``stripe``:cite provides a simple API for accepting credit card payments:</div><div class=""> ``</div><div class=""> gluon/contrib/stripe.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> **AuthorizeNet** ``authorizenet``:cite  provides API to accept credit card payments via Authorize.net network</div><div class=""> ``</div><div class=""> gluon/contrib/AuthorizeNet.py</div><div class=""> ``:code</div><div class=""> </div><div class="delete">**Dowcommerce** ``dowcommerce``:cite credit car<span class="highlight">t</span> processing API:</div><div class=""> ``</div><div class=""> gluon/contrib/DowCommerce.py</div><div class=""> ``:code</div><div class=""> </div><div class="delete">**PaymentTech** credit car<span class="highlight">t</span> processing API:</div><div class=""> </div><div class=""> ``</div><div class=""> gluon/contrib/paymentech.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> **PAM**``PAM``:cite  authentication API created by Chris AtLee:</div><div class=""> ``</div><div class=""> gluon/contrib/pam.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> A Bayesian classifier to populate the database with dummy data for testing purposes:</div><div class=""> ``</div><div class=""> gluon/contrib/populate.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> A file with API for running on Heroku.com : ``heroku``:inxx</div><div class=""> </div><div class=""> ``</div><div class=""> gluon/contrib/heroku.py</div><div class=""> ``:code</div><div class=""> Applications developed in web2py are composed of the following parts:</div><div class=""> - **databases** store SQLite databases and additional table information.</div><div class=""> - **cache** store cached application items.</div><div class=""> - **modules** are other optional Python modules.</div><div class=""> - **private** files are accessed by the controllers but not directly by the developer.</div><div class=""> - **uploads** files are accessed by the models but not directly by the developer (e.g., files uploaded by users of the application).</div><div class=""> - **tests** is a directory for storing test scripts, fixtures and mocks.</div><div class=""> </div><div class=""> Models, views, controllers, languages, and static files are accessible via the web administration [design] interface. ABOUT, README, and errors are also accessible via the administration interface through the corresponding menu items. Sessions, cache, modules and private files are accessible to the applications but not via the administration interface.</div><div class=""> </div><div class=""> Everything is neatly organized in a clear directory structure that is replicated for every installed web2py application, although the user never needs to access the filesystem directly:</div><div class=""> </div><div class=""> ``about``:inxx ``license``:inxx ``cache``:inxx ``controllers``:inxx ``databases``:inxx ``errors``:inxx ``languages``:inxx ``models``:inxx ``modules``:inxx ``private``:inxx ``session``:inxx ``static``:inxx ``tests``:inxx ``uploads``:inxx ``views``:inxx ``__init__.py``:inxx</div><div class=""> ``</div><div class=""> __init__.py  ABOUT        LICENSE    models    views</div><div class=""> controllers  modules      private    tests     cron</div><div class=""> cache        errors       upload     sessions  static</div><div class=""> ``:code</div><div class=""> </div><div class=""> &quot;__init__.py&quot; is an empty file which is required in order to allow Python (and web2py) to import the modules in the ``modules`` directory.</div><div class=""> </div><div class="delete">Notice that the **admin** application simply provides a web interface to web2py applications on the server file system. web2py applications can also be created and developed from the command-line<span class="highlight"></span>; you don&#x27;t have to use the browser **admin** interface.  A new application can be created manually by replicating the above directory structure under ,e.g., &quot;applications/newapp/&quot; (or simply untar the ``welcome.w2p`` file into your new application directory). Application files can also be created and edited from the command-line without having to use the web **admin** interface.</div><div class=""> </div><div class=""> ### API</div><div class=""> </div><div class=""> Models, controllers, and views are executed in an environment where the following objects are already imported for us:</div><div class=""> </div><div class=""> **Global Objects:** ``request``:inxx ``response``:inxx ``session``:inxx ``cache``:inxx</div><div class=""> </div><div class=""> ``</div><div class=""> request, response, session, cache</div><div class=""> ``:code</div><div class=""> </div><div class=""> **Internationalization:** ``T``:inxx ``internationalization``:inxx</div><div class=""> </div><div class=""> ``</div><div class=""> T</div><div class=""> ``:code</div><div class=""> </div><div class=""> **Navigation:** ``redirect``:inxx ``HTTP``:inxx</div><div class=""> </div><div class=""> ``</div><div class=""> IS_UPLOAD_FILENAME, IS_UPPER, IS_URL</div><div class=""> </div><div class=""> **Database:** ``DAL``:inxx</div><div class=""> </div><div class=""> ``</div><div class=""> DAL, Field</div><div class=""> ``:code</div><div class=""> </div><div class=""> For backward compatibility ``SQLDB=DAL`` and ``SQLField=Field``. We encourage you to use the new syntax ``DAL`` and ``Field``, instead of the old syntax.</div><div class=""> </div><div class=""> Other objects and modules are defined in the libraries, but they are not automatically imported since they are not used as often.</div><div class=""> </div><div class=""> The core API entities in the web2py execution environment are ``request``, ``response``, ``session``, ``cache``, ``URL``, ``HTTP``, ``redirect`` and ``T`` and are discussed below.</div><div class=""> </div><div class=""> A few objects and functions, including **Auth**, **Crud** and **Service**, are defined in &quot;gluon/tools.py&quot; and they need to be imported as necessary:</div><div class=""> ``</div><div class=""> from gluon.tools import Auth, Crud, Service</div><div class=""> ``:code</div><div class=""> </div><div class=""> #### Accessing the API from Python modules</div><div class=""> </div><div class="delete">Your models or controller may import python modules, and these may need to use some of the web2py API. The way <span class="highlight">for them </span>to do it is<span class="highlight"></span> importing them:</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon import *</div><div class=""> ``</div><div class=""> </div><div class=""> In fact, any Python module, even if not imported by a web2py application, can import the web2py API as long as web2py is in the ``sys.path``.</div><div class=""> </div><div class=""> There is one caveat, though. Web2py defines some global objects (request, response, session, cache, T) that can only exist when an HTTP request is present (or is faked). Therefore, modules can access them only if they are called from an application. For this reasons they are placed into a container caller ``current``, which is a thread local object. Here is an example.</div><div class=""> </div><div class=""> Create a module &quot;/myapp/modules/test.py&quot; that contains:</div><div class=""> ``</div><div class=""> from gluon import *</div><div class=""> def ip(): return current.request.client</div><div class=""> ``</div><div class=""> Now from a controller in &quot;myapp&quot; you can do</div><div class=""> ``</div><div class=""> import test</div><div class=""> def index():</div><div class="">     return &quot;Your ip is &quot; + test.ip()</div><div class=""> ``</div><div class=""> Unlike a dictionary, if an attribute (or key) does not exist, it does not raise</div><div class=""> -----</div><div class=""> It is sometimes useful to create your own Storage objects. You can do so as follows:</div><div class=""> ``</div><div class=""> from gluon.storage import Storage</div><div class=""> my_storage = Storage() # empty storage object</div><div class=""> my_other_storage = Storage(dict(a=1, b=2)) # convert dictionary to Storage</div><div class=""> ``:code</div><div class=""> -----</div><div class=""> </div><div class=""> ``request`` has the following items/attributes, some of which are also an instance of the ``Storage`` class:</div><div class=""> - ``request.cookies``: a ``Cookie.SimpleCookie()`` object containing the cookies passed with the HTTP request. It acts like a dictionary of cookies. Each cookie is a Morsel object (see http://docs.python.org/2/library/cookie.html#id2).</div><div class=""> - ``request.env``: a ``Storage`` object containing the environment variables passed to the controller, including HTTP header variables from the HTTP request and standard WSGI parameters. The environment variables are all converted to lower case, and dots are converted to underscores for easier memorization.</div><div class=""> - ``request.application``: the name of the requested application (parsed from ``request.env.path_info``).</div><div class=""> - ``request.controller``: the name of the requested controller (parsed from the ``request.env.path_info``).</div><div class=""> - ``request.function``: the name of the requested function (parsed from the ``request.env.path_info``).</div><div class=""> - ``request.extension``: the extension of the requested action. It defaults to &quot;html&quot;. If the controller function returns a dictionary and does not specify a view, this is used to determine the extension of the view file that will render the dictionary (parsed from the ``request.env.path_info``).</div><div class=""> - ``request.folder``: the application directory. For example if the application is &quot;welcome&quot;, ``request.folder`` is set to the absolute path &quot;/path/to/welcome&quot;. In your programs, you should always use this variable and the ``os.path.join`` function to build paths to the files you need to access. Although web2py always uses absolute paths, it is a good rule never to explicitly  change the current working folder (whatever that is) since this is not a thread-safe practice.</div><div class=""> - ``request.now``: a ``datetime.datetime`` object storing the datetime of the current request.</div><div class=""> - ``request.utcnow``: a ``datetime.datetime`` object storing the UTC datetime of the current request.</div><div class=""> - ``request.args``: A list of the URL path components following the controller function name; equivalent to ``request.env.path_info.split(&#x27;/&#x27;)[3:]``</div><div class="delete">- ``request.vars``: a ``gluon.storage.Storage`` object containing <span class="highlight"></span>the HTTP GET and HTTP POST query variables.</div><div class=""> - ``request.get_vars``: a ``gluon.storage.Storage`` object containing only the HTTP GET query variables.</div><div class=""> - ``request.post_vars``: a ``gluon.storage.Storage`` object containing only the HTTP POST query variables.</div><div class=""> - ``request.client``: The ip address of the client as determined by, if present, ``request.env.http_x_forwarded_for`` or by ``request.env.remote_addr`` otherwise. While this is useful it should not be trusted because the ``http_x_forwarded_for`` can be spoofed.</div><div class=""> - ``request.is_local``: ``True`` if the client is localhost, ``False`` otherwise. Should work behind a proxy if the proxy supports ``http_x_forwarded_for``.</div><div class=""> - ``request.is_https``: ``True`` if the request is using the HTTPS protocol, ``False`` otherwise.</div><div class=""> - ``request.body``: a read-only file stream that contains the body of the HTTP request. This is automatically parsed to get the ``request.post_vars`` and then rewinded. It can be read with ``request.body.read()``.</div><div class=""> - ``request.ajax`` is True if the function is being called via an Ajax request.</div><div class=""> - ``request.cid`` is the ``id`` of the component that generated the Ajax request (if any). You can read more about components in Chapter 12.</div><div class=""> - ``request.requires_https()`` prevents further code execution if the request is not over HTTPS and redirects the visitor to the current page over HTTPS.</div><div class=""> - ``request.restful`` this is a new and very useful decorator that can be used to change the default behavior of web2py actions by separating GET/POST/PUSH/DELETE requests. It will be discussed in some detail in Chapter 10.</div><div class=""> - ``request.user_agent()`` parses the user_agent field from the client and returns the information in the form of a dictionary. It is useful to detect mobile devices. It uses &quot;gluon/contrib/user_agent_parser.py&quot; created by Ross Peoples. To see what it does, try to embed the following code in a view:</div><div class=""> ``</div><div class=""> {{=BEAUTIFY(request.user_agent())}}</div><div class=""> ``:code</div><div class=""> </div><div class="delete">- ``request.global_settings`` ``request.global_settings``:inxx contains web2py <span class="highlight"></span>wide s<span class="highlight">ystem s</span>ettings. They are set automatically a<span class="highlight">utomati</span>c<span class="highlight">ally and you should not</span> c<span class="highlight">hange them. For example</span> ``request.global_settings.<span class="highlight">gluon_parent`` contains the </span>f<span class="highlight">ull path to the</span> web2py <span class="highlight">folder, ``request.global_settings.is_pypy`` determines if web2py </span>is running on PyPy.</div><div class=""> </div><div class=""> - ``request.wsgi`` is a hook that allows you to call third party WSGI applications from inside actions</div><div class=""> </div><div class=""> The latter includes:</div><div class=""> - ``request.wsgi.environ``</div><div class=""> - ``request.wsgi.start_response``</div><div class=""> - ``request.wsgi.middleware``</div><div class=""> their usage is discussed at the end of this Chapter.</div><div class=""> </div><div class=""> As an example, the following call on a typical system:</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/examples/default/status/x/y/z?p=1&amp;q=2</div><div class=""> ``:code</div><div class=""> </div><div class=""> results in the following ``request`` object:</div><div class=""> ``request``:inxx ``env``:inxx</div><div class=""> </div><div class=""> ----------</div><div class=""> **variable** | **value**</div><div class=""> Also notice the ``request.env.wsgi_*`` variables. They are specific to the wsgi</div><div class=""> ``response.status``:inxx</div><div class=""> ``response.stream``:inxx</div><div class=""> ``response.subtitle``:inxx</div><div class=""> ``response.title``:inxx</div><div class=""> ``response.toolbar``:inxx</div><div class=""> ``response.view``:inxx</div><div class=""> ``response.delimiters``:inxx</div><div class=""> ``response.js``:inxx</div><div class=""> ``response.write``:inxx</div><div class=""> ``response.include_files``:inxx</div><div class=""> ``response.include_meta``:inxx</div><div class=""> ``response.optimize_css``:inxx</div><div class=""> ``response.optimize_js``:inxx</div><div class=""> ``response._caller``:inxx</div><div class=""> </div><div class=""> ``response`` is another instance of the ``Storage`` class. It contains the following:</div><div class=""> </div><div class=""> - ``response.body``: a ``StringIO`` object into which web2py writes the output page body. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.cookies``: similar to ``request.cookies``, but while the latter contains the cookies sent from the client to the server, the former contains cookies sent by the server to the client. The session cookie is handled automatically.</div><div class=""> - ``response.download(request, db)``: a method used to implement the controller function that allows downloading of uploaded files. ``request.download`` expects the last ``arg`` in ``request.args`` to be the encoded filename (i.e., the filename generated at upload time and stored in the upload field). It extracts the upload field name and table name as well as the original filename from the encoded filename. ``response.download`` takes two optional arguments: ``chunk_size`` sets the size in bytes for chunked streaming (defaults to 64K), and ``attachments`` determines whether the downloaded file should be treated as an attachment or not (default to ``True``). Note, ``response.download`` is specifically for downloading files associated with ``db`` upload fields. Use ``response.stream`` (see below) for other types of file downloads and streaming. Also, note that it is not necessary to use ``response.download`` to access files uploaded to the /static folder -- static files can (and generally should) be accessed directly via URL (e.g., /app/static/files/myfile.pdf).</div><div class="delete">- ``response.files``: a list of .css, .js, coffee, and .less files required by the page. They will automatically be linked in the head of the standard &quot;layout.html&quot; via the included &quot;web2py_ajax.html&quot;. To include a new CSS, JS, COFFEE, or LESS file, just append it to this list. It will handle duplicates. The order is <span class="highlight">significant.</span></div><div class=""> - ``response.include_files()`` generates html head tags to include all ``response.files`` (used in &quot;views/web2py_ajax.html&quot;).</div><div class=""> - ``response.flash``: optional parameter that may be included in the views. Normally used to notify the user about something that happened.</div><div class="delete">- ``response.headers``: a ``dict`` for HTTP response headers. Web2py sets some headers by default, including &quot;Content-Length&quot;, &quot;Content-Type&quot;, and &quot;X-Powered-By&quot; (set equal to web2py). Web2py also sets the &quot;Cache-Control&quot;, &quot;Expires&quot;, and &quot;Pragma&quot; headers to prevent client-side caching, except for static file requests, for which client-side caching is enabled. The headers that web2py sets can be overwritten or removed, and new headers can be added (e.g., ``response.headers[&#x27;Cache-Control&#x27;] = &#x27;private&#x27;``). You can remove a header <span class="highlight"></span>removing its key from the response.headers dict, e.g.``del response.headers[&#x27;Custom-Header&#x27;]``, however web2py&#x27;s default headers will be re-added just before returning the response. To avoid this behavior, just set the header value to None, e.g. to remove the default Content-Type header, ``response.headers[&#x27;Content-Type&#x27;] = None``</div><div class=""> - ``response.menu``: optional parameter that may be included in the views, normally used to pass a navigation menu tree to the view. It can be rendered by the MENU helper.</div><div class=""> - ``response.meta``: a storage object (like a dict) that contains optional meta information like ``response.meta.author``, ``.description``, and/or ``.keywords``. The content of each meta variable is automatically placed in the proper ``META`` tag by the code in &quot;views/web2py_ajax.html&quot;, which is included by default in &quot;views/layout.html&quot;.</div><div class=""> - ``response.include_meta()`` generates a string that includes all ``response.meta`` headers serialized (used in &quot;views/web2py_ajax.html&quot;).</div><div class=""> - ``response.postprocessing``: this is a list of functions, empty by default. These functions are used to filter the response object at the output of an action, before the output is rendered by the view. It can be used to implement support for other template languages.</div><div class=""> - ``response.render(view, vars)``: a method used to call the view explicitly inside the controller. ``view`` is an optional parameter which is the name of the view file, ``vars`` is a dictionary of named values passed to the view.</div><div class=""> - ``response.session_file``: file stream containing the session.</div><div class=""> - ``response.session_file_name``: name of the file where the session will be saved.</div><div class=""> - ``response.session_id``: the id of the current session. It is determined automatically. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.session_id_name``: the name of the session cookie for this application. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.status``: the HTTP status code integer to be passed to the response. Default is 200 (OK).</div><div class=""> - ``response.stream(file, chunk_size, request=request, attachment=False, filename=None, headers=None)``: when a controller returns it, web2py streams the file content back to the client in blocks of size ``chunk_size``. The ``request`` parameter is required to use the chunk start in the HTTP header. ``file`` should be a file path (for backward compatibility, it can also be an open file object, but this is not recommended). As noted above, ``response.download`` should be used to retrieve files stored via an upload field. ``response.stream`` can be used in other cases, such as returning a temporary file or StringIO object created by the controller. If ``attachment`` is True, the Content-Disposition header will be set to &quot;attachment&quot;, and if ``filename`` is also provided, it will be added to the Content-Disposition header as well (but only when ``attachment`` is True). If not already included in ``response.headers``, the following response headers will be set automatically: Content-Type, Content-Length, Cache-Control, Pragma, and Last-Modified (the latter three are set to allow browser caching of the file). To override any of these automatic header settings, simply set them in ``response.headers`` before calling ``response.stream``.</div><div class=""> - ``response.subtitle``: optional parameter that may be included in the views. It should contain the subtitle of the page.</div><div class=""> - ``response.title``: optional parameter that may be included in the views. It should contain the title of the page and should be rendered by the HTML title TAG in the header.</div><div class=""> - ``response.toolbar``: a function that allows you to embed a toolbar into page for debugging purposes ``{{=response.toolbar()}}``. The toolbar displays request, response, session variables and database access time for each query.</div><div class=""> - ``response._vars``: this variable is accessible only in a view, not in the action. It contains the value returned by the action to the view.</div><div class="delete">- ``response._caller``: this is a function that wraps all action calls. It defaults to the identity function, but it can be modif<span class="highlight"></span>ed in order to catch special types of exception to do extra logging;</div><div class="">   ``</div><div class="">   response._caller = lambda f: f()</div><div class="">   ``</div><div class=""> - ``response.optimize_css``: if can be set to &quot;concat,minify,inline&quot; to concatenate, minify and inline the CSS files included by web2py.</div><div class=""> - ``response.optimize_js``: if can be set to &quot;concat,minify,inline&quot; to concatenate, minify and inline the JavaScript files included by web2py.</div><div class=""> - ``response.view``: the name of the view template that must render the page. This is set by default to:</div><div class="">   ``</div><div class="">   &quot;%s/%s.%s&quot; % (request.controller, request.function, request.extension)</div><div class="">   ``:code</div><div class="">   or, if the above file cannot be located, to</div><div class="">   ``</div><div class="">   &quot;generic.%s&quot; % (request.extension)</div><div class="">   ``:code</div><div class="">   Change the value of this variable to modify the view file associated with a particular action.</div><div class=""> </div><div class=""> - ``response.delimiters`` defaults to ``(&#x27;{{&#x27;,&#x27;}}&#x27;)``. It allows you to change the delimiter of code embedded in views.</div><div class=""> - ``response.xmlrpc(request, methods)``: when a controller returns it, this function exposes the methods via XML-RPC``xmlrpc``:cite . This function is deprecated since a better mechanism is available and described in Chapter 10.</div><div class=""> - ``response.write(text)``: a method to write text into the output page body.</div><div class=""> - ``response.js`` can contain Javascript code. This code will be executed if and only if the response is received by a web2py component as discussed in Chapter 12.</div><div class=""> </div><div class=""> Since ``response`` is a ``gluon.storage.Storage`` object, it can be used to store other attributes that you may want to pass to the view. While there is no technical restriction, our recommendation is to store only variables that are to be rendered by all pages in the overall layout (&quot;layout.html&quot;).</div><div class=""> </div><div class=""> Anyway, we strongly suggest to stick to the variables listed here:</div><div class=""> ``</div><div class=""> response.title</div><div class=""> response.subtitle</div><div class=""> response.flash</div><div class=""> response.menu</div><div class=""> response.meta.author</div><div class=""> response.meta.description</div><div class=""> response.meta.keywords</div><div class=""> response.meta.*</div><div class=""> ``:code</div><div class=""> </div><div class=""> because this will make it easier for you to replace the standard &quot;layout.html&quot; file that comes with web2py with another layout file, one that uses the same set of variables.</div><div class=""> </div><div class="delete">Old versions of web2py use<span class="highlight">r</span> ``response.author`` instead of ``response.meta.author`` and similar for the other meta attributes.</div><div class=""> </div><div class=""> ### ``session``</div><div class=""> ``session``:inxx ``session.connect``:inxx ``session.forget``:inxx ``session.secure``:inxx</div><div class=""> ``session`` is another instance of the ``Storage`` class. Whatever is stored into ``session`` for example:</div><div class=""> ``</div><div class=""> session.myvariable = &quot;hello&quot;</div><div class=""> ``:code</div><div class=""> </div><div class=""> can be retrieved at a later time:</div><div class=""> ``</div><div class=""> a = session.myvariable</div><div class=""> ``:code</div><div class=""> </div><div class="delete">as long as the code is executed within the same session by the same user (provided the user has not deleted session cookies and the session <span class="highlight">did</span> not expire<span class="highlight"></span>). Because ``session`` is a ``Storage`` object, trying to access an attribute/key that has not been set does not raise an exception; it returns ``None`` instead.</div><div class=""> </div><div class=""> The session object has three important methods. One is ``forget``:</div><div class=""> ``</div><div class=""> session.forget(response)</div><div class=""> ``:code</div><div class=""> </div><div class="delete">It tells web2py not to save the session. This should be used in those controllers whose actions are called often and do not need to track user activity. ``session.forget()`` prevents the session file from being written, regardless of whether it has been modified. ``session.forget(response)`` additionally unlocks and closes the session file. You rarely need to call this method since sessions are not saved when they are not changed. However, if the page makes multiple simultaneous Ajax requests, it is a good idea for the actions called via Ajax to call ``session.forget(response)`` (assuming the session is not needed by the action). Otherwise, each Ajax action will have to wait for the previous one to complete (and unlock the session file) before proceeding, which will slow down the page loading. Notice that sessions are not locked when stored in <span class="highlight"></span>database.</div><div class=""> </div><div class=""> Another method is:</div><div class=""> </div><div class=""> ``</div><div class=""> session.secure()</div><div class=""> ``:code</div><div class=""> </div><div class=""> which tells web2py to set the session cookie to be a secure cookie. This should be set if the app is going over https. By setting the session cookie to be secure, the server is asking the browser not to send the session cookie back to the server unless over an https connection.</div><div class=""> </div><div class=""> The other method is ``connect``.</div><div class=""> By default sessions are stored on the filesystem and a session cookie is used to store and retrieve the ``session.id``. Using the connect method it is possible to tell web2y to store sessions in the database or in the cookies thus eliminating need to access the filesystem for session management.</div><div class=""> </div><div class=""> For example to **store sessions in the database**:</div><div class=""> </div><div class=""> ``</div><div class=""> session.connect(request, response, db, masterapp=None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> where ``db`` is the name of an open database connection (as returned by the DAL). It tells web2py that you want to store the sessions in the database and not on the filesystem. ``session.connect`` must come after ``db=DAL(...)``, but before any other logic that requires session, for example, setting up ``Auth``.</div><div class=""> </div><div class=""> To **store sessions in cookies** instead you can do:</div><div class=""> session.connect(request,response,cookie_key=&#x27;yoursecret&#x27;,compression_level=None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Here ``cookie_key`` is a symmetric encryption key.</div><div class=""> ``compression_level`` is an optional ``zlib`` encryption level.</div><div class=""> </div><div class=""> While sessions in cookie are often recommended for scalability reason they are limited in size. Large sessions will result in broken cookies.</div><div class=""> </div><div class=""> You can check the state of your application at any time by printing the ``request``, ``session`` and ``response`` system variables. One way to do it is to create a dedicated action:</div><div class=""> ``</div><div class=""> def status():</div><div class="">     return dict(request=request, session=session, response=response)</div><div class=""> ``:code</div><div class=""> </div><div class=""> In the &quot;generic.html&quot; view this is done using ``{{=response.toolbar()}}``.</div><div class=""> </div><div class=""> </div><div class=""> #### Separate sessions</div><div class=""> </div><div class=""> If you are storing sessions on filesystems and you have lots of them, the file system access may become a bottle-neck. One solution is the following:</div><div class=""> ``</div><div class=""> session.connect(request, response, separate=True)</div><div class=""> ``:code</div><div class=""> </div><div class=""> By setting ``separate=True`` web2py will store sessions not in the &quot;sessions/&quot; folder but in subfolders of the &quot;sessions/&quot; folder. The subfolder will be created automatically. Sessions with the same prefix will be in the same subfolder. Again, note that the above must be called before any logic that might require the session.</div><div class=""> </div><div class=""> ### ``cache``</div><div class=""> ``cache``:inxx ``cache.ram``:inxx ``cache.disk``:inxx</div><div class=""> ``cache`` a global object also available in the web2py execution environment. It has two attributes:</div><div class=""> - ``cache.ram``: the application cache in main memory.</div><div class=""> - ``cache.disk``: the application cache on disk.</div><div class=""> ``cache`` is callable, this allows it to be used as a decorator for caching actions and views.</div><div class=""> </div><div class=""> The following example caches the ``time.ctime()`` function in RAM:</div><div class=""> ``</div><div class=""> def cache_in_ram():</div><div class="">     import time</div><div class="">     t = cache.ram(&#x27;time&#x27;, lambda: time.ctime(), time_expire=5)</div><div class="">     return dict(time=t, link=A(&#x27;click me&#x27;, _href=request.url))</div><div class=""> ``:code</div><div class=""> def cache_on_disk():</div><div class="">     return dict(time=t, link=A(&#x27;click me&#x27;, _href=request.url))</div><div class=""> ``:code</div><div class=""> </div><div class=""> The output of ``lambda: time.ctime()`` is cached on disk (using the shelve module) for 5 seconds.</div><div class=""> </div><div class=""> Note, the second argument to ``cache.ram`` and ``cache.disk`` must be a function or callable object. If you want to cache an existing object rather than the output of a function, you can simply return it via a lambda function:</div><div class=""> ``</div><div class=""> cache.ram(&#x27;myobject&#x27;, lambda: myobject, time_expire=60*60*24)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The next example caches the ``time.ctime()`` function to both RAM and disk:</div><div class=""> ``</div><div class=""> def cache_in_ram_and_disk():</div><div class="">     import time</div><div class="">     t = cache.ram(&#x27;time&#x27;, lambda: cache.disk(&#x27;time&#x27;,</div><div class="">                        lambda: time.ctime(), time_expire=5),</div><div class="">                        time_expire=5)</div><div class="">     return dict(time=t, link=A(&#x27;click me&#x27;, _href=request.url))</div><div class=""> ``:code</div><div class=""> </div><div class="delete">The output of ``lambda: time.ctime()`` is cached on disk (using the shelve module) and then in RAM for 5 seconds. web2py looks in RAM first and if not there it looks on disk. If it is not in RAM or on disk, ``lambda: time.ctime()`` is executed and the cache is updated. This technique is useful in a multiprocess<span class="highlight"></span> environment. The two times do not have to be the same.</div><div class=""> </div><div class=""> The following example is caching in RAM the output of the controller function (but not the view):</div><div class=""> </div><div class=""> ``cache controller``:inxx</div><div class=""> ``</div><div class=""> @cache(request.env.path_info, time_expire=5, cache_model=cache.ram)</div><div class=""> def cache_controller_in_ram():</div><div class="">     import time</div><div class="">     t = time.ctime()</div><div class="">     return dict(time=t, link=A(&#x27;click me&#x27;, _href=request.url))</div><div class=""> ``:code</div><div class=""> </div><div class="delete">The dictionary returned by ``cache_controller_in_ram`` is cached in RAM for 5 seconds. Note that the result of a database select cannot be cached without first being serialized. A better way is to cache the database select directly using the ``select`` method<span class="highlight"></span> ``cache`` argument.</div><div class=""> </div><div class=""> The following example is caching the output of the controller function on disk (but not the view):</div><div class=""> ``</div><div class=""> @cache(request.env.path_info, time_expire=5, cache_model=cache.disk)</div><div class=""> def cache_controller_on_disk():</div><div class="">     import time</div><div class="">     t = time.ctime()</div><div class="">     return dict(time=t, link=A(&#x27;click to reload&#x27;,</div><div class="">                               _href=request.url))</div><div class=""> ``:code</div><div class=""> </div><div class=""> The dictionary returned by ``cache_controller_on_disk``  is cached on disk for 5 seconds. Remember that web2py cannot cache a dictionary that contains un-pickleable objects.</div><div class=""> </div><div class=""> It is also possible to cache the view. The trick is to render the view in the controller function, so that the controller returns a string. This is done by returning ``response.render(d)`` where ``d`` is the dictionary we intended to pass to the view. The following example caches the output of the controller function in RAM (including the rendered view):</div><div class=""> </div><div class=""> ``cache view``:inxx</div><div class=""> ``</div><div class=""> @cache(request.env.path_info, time_expire=5, cache_model=cache.ram)</div><div class=""> def cache_controller_and_view():</div><div class="">     import time</div><div class=""> Note, ``time_expire`` is used to compare the current time with the time the requ</div><div class=""> ``</div><div class=""> message = cache.ram(&#x27;message&#x27;, lambda: &#x27;Hello&#x27;, time_expire=5)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Now, suppose the following call is made 10 seconds after the above call:</div><div class=""> ``</div><div class=""> message = cache.ram(&#x27;message&#x27;, lambda: &#x27;Goodbye&#x27;, time_expire=20)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Because ``time_expire`` is set to 20 seconds in the second call and only 10 seconds has elapsed since the message was first saved, the value &quot;Hello&quot; will be retrieved from the cache, and it will not be updated with &quot;Goodbye&quot;. The ``time_expire`` value of 5 seconds in the first call has no impact on the second call.</div><div class=""> </div><div class=""> Setting ``time_expire=0`` (or a negative value) forces the cached item to be refreshed (because the elapsed time since the last save will always be &gt; 0), and setting ``time_expire=None`` forces retrieval of the cached value, regardless of the time elapsed since it was saved (if ``time_expire`` is always ``None``, the cached item will effectively never expire).</div><div class=""> </div><div class=""> You can clear one or more cache variables with</div><div class=""> ``cache clear``:inxx</div><div class=""> </div><div class=""> ``</div><div class=""> cache.ram.clear(regex=&#x27;...&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class="delete">where ``regex`` is a regular expression matching all the keys you want removed from the cache. You can also clear a<span class="highlight">n</span> single item with:</div><div class=""> ``</div><div class=""> cache.ram(key, None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> where ``key`` is the key of the cached item.</div><div class=""> </div><div class=""> It is also possible to define other caching mechanisms such as memcache. Memcache is available via ``gluon.contrib.memcache`` and is discussed in more details in Chapter 14.</div><div class=""> </div><div class=""> ------</div><div class="delete">Be careful when caching<span class="highlight"></span> that caching is usually at the app-level not at the user level. If you need, for example, to cache user specific content, choose a key that includes the user id.</div><div class=""> ------</div><div class=""> </div><div class=""> </div><div class=""> ### ``URL``</div><div class=""> ``URL``:inxx</div><div class=""> The ``URL`` function is one of the most important functions in web2py. It generates internal URL paths for the actions and the static files.</div><div class=""> </div><div class=""> Here is an example:</div><div class=""> </div><div class=""> ``</div><div class=""> URL(&#x27;f&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> is mapped into</div><div class=""> </div><div class=""> ``</div><div class=""> /[application]/[controller]/f</div><div class=""> ``:code</div><div class=""> </div><div class=""> Notice that the output of the ``URL`` function depends on the name of the current application, the calling controller, and other parameters. web2py supports URL mapping and reverse URL mapping. URL mapping allows you to redefine the format of external URLs. If you use the ``URL`` function to generate all the internal URLs, then additions or changes to URL mappings will prevent broken links within the web2py application.</div><div class=""> The most common way to use redirect is to redirect to other pages in the same ap</div><div class=""> redirect(URL(&#x27;index&#x27;, args=(1,2,3), vars=dict(a=&#x27;b&#x27;)))</div><div class=""> ``:code</div><div class=""> </div><div class=""> In chapter 12 we discuss web2py components. They make Ajax requests to web2py actions. If the called action performs a redirect, you may want the Ajax request to follow the redirect or you may want the entire page performing the Ajax request redirecting. In this latter case you can set:</div><div class=""> </div><div class=""> ``</div><div class=""> redirect(...,type=&#x27;auto&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> ### ``T``, Internationalization, and Pluralization</div><div class=""> ``T``:inxx ``internationalization``:inxx</div><div class=""> </div><div class=""> The object ``T`` is the language translator. It constitutes a single global instance of the web2py class ``gluon.language.translator``. All string constants (and only string constants) should be marked by ``T``, for example:</div><div class=""> ``</div><div class=""> a = T(&quot;hello world&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Strings that are marked with ``T`` are identified by web2py as needing language translation and they will be translated when the code (in the model, controller, or view) is executed. If the string to be translated is not a constant but a variable, it will be added to the translation file at runtime (except on GAE) to be translated later.</div><div class=""> </div><div class="delete">The ``T`` object can also contain interpolated variables and support<span class="highlight"></span> multiple equivalent syntax<span class="highlight"></span>:</div><div class=""> ``</div><div class=""> a = T(&quot;hello %s&quot;, (&#x27;Tim&#x27;,))</div><div class=""> a = T(&quot;hello %(name)s&quot;, dict(name=&#x27;Tim&#x27;))</div><div class=""> a = T(&quot;hello %s&quot;) % (&#x27;Tim&#x27;,)</div><div class=""> a = T(&quot;hello %(name)s&quot;) % dict(name=&#x27;Tim&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The latter syntax is recommended because it makes translation easier.</div><div class=""> The first string is translated according to the requested language file and the ``name`` variable is replaced independently of the language.</div><div class=""> </div><div class=""> You can concatenating translated strings and normal strings:</div><div class=""> ``</div><div class=""> T(&quot;blah &quot;) + name + T(&quot; blah&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The following code is also allowed and often preferable:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;blah %(name)s blah&quot;, dict(name=&#x27;Tim&#x27;))</div><div class=""> ``:code</div><div class=""> T(&quot;blah %(name)s blah&quot; % dict(name=&#x27;Tim&#x27;))</div><div class=""> ``:code</div><div class=""> </div><div class=""> because translation would occur after substitution.</div><div class=""> </div><div class=""> #### Determining the language</div><div class=""> </div><div class=""> The requested language is determined by the &quot;Accept-Language&quot; field in the HTTP header, but this selection can be overwritten programmatically by requesting a specific file, for example:</div><div class=""> ``</div><div class=""> T.force(&#x27;it-it&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> which reads the &quot;languages/it-it.py&quot; language file. Language files can be created and edited via the administrative interface.</div><div class=""> </div><div class=""> You can also force a per-string language:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;Hello World&quot;, language=&quot;it-it&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> --------------</div><div class="delete">In the case multiple languages are requested, for example &quot;it-it, fr-ft&quot;, web2py tries to locate &quot;it-it.py&quot; and &quot;fr-fr.py&quot; translation files. If none of the requested files is present, it tries to fall<span class="highlight"></span>back on &quot;it.py&quot; and &quot;fr.py&quot;. If these files are not present it defaults to &quot;default.py&quot;. If this is not present either, it default to no-translation. The more general rule is that web2py tries &quot;xx-xy-yy.py&quot;, &quot;xx-xy.py&quot;, &quot;xx.py&quot;, &quot;default.py&quot; for each of the &quot;xx-xy-yy&quot; accepted languages trying to find the closest match to the visitor&#x27;s preferences.</div><div class=""> -------------</div><div class=""> </div><div class=""> You can turn off translations completely via</div><div class=""> </div><div class=""> ``</div><div class=""> T.force(None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Normally, string translation is evaluated lazily when the view is rendered; hence, the translator ``force`` method should not be called inside a view.</div><div class=""> </div><div class=""> It is possible to disable lazy evaluation via</div><div class=""> ``</div><div class=""> T.lazy = False</div><div class=""> ``:code</div><div class=""> </div><div class=""> In this way, strings are translated immediately by the ``T`` operator based on the currently accepted or forced language.</div><div class=""> </div><div class=""> It is also possible to disable lazy evaluation for individual strings:</div><div class=""> </div><div class=""> ``</div><div class=""> Notice that this can result in lots of file IO and you may want to disable it:</div><div class=""> </div><div class=""> ``</div><div class=""> T.is_writable = False</div><div class=""> ``:code</div><div class=""> </div><div class=""> prevents T from dynamically updating language files.</div><div class=""> </div><div class=""> #### Comments and multiple translations</div><div class=""> </div><div class=""> It is possible that the same string appears in different contexts in the application and needs different translations based on context. In order to do this, one can add comments to the original string. The comments will not be rendered but will be used by web2py to determine the most appropriate translation. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;hello world ## first occurrence&quot;)</div><div class=""> T(&quot;hello world ## second occurrence&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The text following the ``##``, including the double ``##``, are comments.</div><div class=""> </div><div class=""> #### Pluralization engine</div><div class=""> </div><div class="delete">Since version 2.0, web2py includes a powerful pluralization system (PS). This means that when text marked for translation depends on a numeric variable, it may be translated differently based on the numeric value. For example in <span class="highlight">e</span>nglish we may render:</div><div class=""> </div><div class=""> ``</div><div class=""> x book(s)</div><div class=""> ``</div><div class=""> </div><div class=""> with</div><div class=""> </div><div class=""> ``</div><div class=""> a book (x==0)</div><div class=""> x books (x&gt;0)</div><div class=""> ``</div><div class=""> </div><div class=""> English has one singular form and one plural form. The plural form is constructed by adding a &quot;-s&quot; or &quot;-es&quot; or using an exceptional form. web2py provides a way to define pluralization rules for each languages, as well as exceptions to the default rules. In fact web2py already knows pluralization rules for many languages. It knows, for example, that Slovenian has one singular form and 3 plural forms (for x==1, x==3 or x==4 and x&gt;4). These rules are encoded in &quot;gluon/contrib/plural_rules/*.py&quot; files and new files can be created. Explicit pluralizations for words are created by editing pluralization files using the administrative interface.</div><div class=""> </div><div class=""> By default the PS is not activated. It is triggered by the ``symbol`` argument of the ``T`` function. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;You have %s %%{book}&quot;, symbols=10)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Now the PS is activated for the word &quot;book&quot; and for the number 10.</div><div class="delete">The result in <span class="highlight">e</span>nglish will be: &quot;You have 10 books&quot;. Notice that &quot;book&quot; has been pluralized into &quot;books&quot;.</div><div class=""> </div><div class="delete">The PS consists <span class="highlight"></span>f<span class="highlight">rom</span> 3 parts:</div><div class=""> - placeholders ``%%{}`` to mark words in ``T``-messages</div><div class=""> - rule to give a decision which word form to use (&quot;rules/plural_rules/*.py&quot;)</div><div class=""> - dictionary with word plural forms (&quot;app/languages/plural-*.py&quot;)</div><div class=""> </div><div class=""> The value of symbols can be a single variable, a list/tuple of variables, or a dictionary.</div><div class=""> </div><div class=""> The placeholder ``%%{}`` consists of 3 parts:</div><div class=""> </div><div class=""> ``</div><div class=""> %%{[&lt;modifier&gt;]&lt;world&gt;[&lt;parameter&gt;]},</div><div class=""> ``</div><div class=""> </div><div class=""> where:</div><div class=""> </div><div class=""> ``</div><div class=""> &lt;modifier&gt;::= ! | !! | !!!</div><div class=""> &lt;word&gt; ::= any word or phrase in singular in lower case (!)</div><div class=""> &lt;parameter&gt; ::= [index] | (key) | (number)</div><div class=""> ``</div><div class=""> </div><div class=""> T(&quot;blabla %(var1)s %(wordcnt)s %%{word(wordcnt)}&quot;,</div><div class=""> ``</div><div class=""> </div><div class=""> which produces</div><div class=""> </div><div class=""> ``</div><div class=""> blabla tututu 20 words</div><div class=""> ``</div><div class=""> </div><div class=""> You can replace &quot;1&quot; with any word you wish by this placeholder ``%%{?word?number}``.</div><div class=""> For example</div><div class=""> </div><div class=""> ``T(&quot;%%{this} %%{is} %%{?a?%s} %%{book}&quot;, var)``</div><div class=""> </div><div class=""> produces:</div><div class=""> </div><div class=""> ``</div><div class=""> var  output</div><div class=""> ------------------</div><div class="">  1   this is a book</div><div class="">  2   these are 2 books</div><div class="delete"> 3   these are <span class="highlight">2</span> books</div><div class="">  ...</div><div class=""> ``</div><div class=""> </div><div class=""> Inside ``%%{...}`` you can also use the following modifiers:</div><div class=""> </div><div class=""> - ``!`` to capitalize the text (equivalent to ``string.capitalize``)</div><div class=""> - ``!!`` to capitalize every word (equivalent to ``string.title``)</div><div class=""> - ``!!!`` to capitalize every character (equivalent to ``string.upper``)</div><div class=""> </div><div class=""> Notice you can use ``\\`` to escape ``!`` and ``?``.</div><div class=""> </div><div class=""> #### Translations, pluralization, and MARKMIN</div><div class=""> </div><div class=""> You can also use the powerful MARKMIN syntax inside translation strings by replacing</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;hello world&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> with</div><div class=""> python web2py.py -a yourpass -K myapp -X</div><div class=""> You can pass the usual parameters (-i, -p, here -a prevents the window from showing up), pass whatever app in the -K parameter and append a -X. The scheduler will run alongside the webserver!</div><div class=""> </div><div class=""> Scheduler&#x27;s complete signature is:</div><div class=""> </div><div class=""> ``</div><div class=""> Scheduler(</div><div class="">     db,</div><div class="">     tasks=None,</div><div class="">     migrate=True,</div><div class="">     worker_name=None,</div><div class="">     group_names=None,</div><div class="">     heartbeat=HEARTBEAT,</div><div class="">     max_empty_runs=0,</div><div class="">     discard_results=False,</div><div class="">     utc_time=False</div><div class=""> )</div><div class=""> ``:code</div><div class=""> </div><div class=""> Let&#x27;s see them in order:</div><div class=""> </div><div class="delete">- ``db`` is the database DAL instance w<span class="highlight"></span>ere you want the scheduler tables be placed.</div><div class=""> - ``tasks`` can be a dict. Must be defined if you want to call a function not by his name, i.e. ``tasks=dict(mynameddemo1=task_add)`` will let you execute function demo1 with ``scheduler.queue_task(&#x27;mynameddemo1&#x27;)`` instead of ``scheduler.queue_task(&#x27;task_add&#x27;)``. If you don&#x27;t pass this parameter, function will be searched in the app environment.</div><div class=""> - ``worker_name`` is None by default. As soon as the worker is started, a worker name is generated as hostname-uuid. If you want to specify that, be sure that it&#x27;s unique.</div><div class=""> - ``group_names`` is by default set to **[main]**. All tasks have a ``group_name`` parameter, set to **main** by default. Workers can only pick up tasks of their assigned group.</div><div class=""> </div><div class=""> ------</div><div class=""> NB: This is useful if you have different workers instances (e.g. on different machines) and you want to assign tasks to a specific worker.</div><div class=""> </div><div class=""> NB2: It&#x27;s possible to assign a worker more groups, and they can be also all the same, as</div><div class=""> ------</div><div class=""> ``[&#x27;mygroup&#x27;,&#x27;mygroup&#x27;]``. Tasks will be distributed taking into consideration that</div><div class=""> a worker with group_names ``[&#x27;mygroup&#x27;,&#x27;mygroup&#x27;]`` is able to process the double of the tasks</div><div class=""> a worker with group_names ``[&#x27;mygroup&#x27;]`` is.</div><div class=""> - ``heartbeat`` is by default set to 3 seconds. This parameter is the one controlling how often a scheduler will check its status on the ``scheduler_worker`` table and see if there are any **ASSIGNED** tasks to itself to process.</div><div class=""> - ``max_empty_runs`` is 0 by default, that means that the worker will continue to process tasks as soon as they are **ASSIGNED**. If you set this to a value of, let&#x27;s say, 10, a worker will die automatically if it&#x27;s **ACTIVE** and no tasks are **ASSIGNED** to it for 10 loops. A loop is when a worker searches for tasks, every 3 seconds (or the set ``heartbeat``)</div><div class=""> - ``discard_results`` is False by default. If set to True, no scheduler_run records will be created.</div><div class=""> </div><div class=""> ------</div><div class=""> NB: scheduler_run records will be created as before for **FAILED**, **TIMEOUT** and **STOPPED** tasks&#x27;s statuses.</div><div class=""> ------</div><div class=""> </div><div class=""> The meaning of the fields in this table is obvious. The &quot;args&quot; and &quot;vars&quot;&quot; field</div><div class=""> ``</div><div class=""> args = [3, 4]</div><div class=""> vars = {}</div><div class=""> ``:code</div><div class=""> </div><div class=""> or</div><div class=""> </div><div class=""> ``</div><div class=""> args = []</div><div class=""> vars = {&#x27;a&#x27;:3, &#x27;b&#x27;:4}</div><div class=""> ``:code</div><div class=""> </div><div class=""> The ``scheduler_task`` table is the one where tasks are organized.</div><div class=""> </div><div class=""> All tasks follow a lifecycle</div><div class=""> </div><div class=""> [[scheduler tasks @///image/ce8edcc3.png center]]</div><div class=""> </div><div class=""> Let&#x27;s go with order. By default, when you send a task to the scheduler, you&#x27;ll want that to be executed. It&#x27;s in **QUEUED** status.</div><div class=""> If you need it to be executed later, use the ``start_time`` parameter (default = now).</div><div class="delete">If for some reason you need to be sure that the task don&#x27;t get executed after a certain point in time (maybe a request to a web<span class="highlight"></span>service</div><div class=""> that shuts down at 1AM, a mail that needs to be sent not after the working hours, etc...) you can set a ``stop_time`` (default = None) for it.</div><div class=""> If your task is NOT picked up by a worker before stop_time, it will be set as **EXPIRED**.</div><div class=""> Tasks with no stop_time set or picked up **BEFORE** stop_time are **ASSIGNED** to a worker. When a workers picks up them, they become **RUNNING**.</div><div class=""> **RUNNING** tasks may end up:</div><div class=""> - **TIMEOUT** when more than n seconds passed with ``timeout`` parameter (default = 60 seconds)</div><div class=""> - **FAILED** when an exception is detected</div><div class=""> - **COMPLETED** when all went ok</div><div class=""> </div><div class=""> Additionally, you can control how many times a task should be repeated (i.e. you need to aggregate some data at specified intervals). To do so, set the ``repeats``</div><div class=""> parameter (default = 1 time only, 0 = unlimited). You can influence how many seconds should pass between executions with the ``period`` parameter (default = 60 seconds).</div><div class=""> </div><div class=""> ------</div><div class=""> NB: the time is not calculated between the END of the first round and the START of the next, but from the START time of the first round to the START time of the next cycle)</div><div class=""> ------</div><div class=""> </div><div class="delete">Another nice addition, you can set how many times the function can raise an exception (i.e. requesting data from a slow web<span class="highlight"></span>service) and be queued again instead of stopping in **FAILED**  status with the parameter ``retry_failed`` (default = 0, -1 = unlimited).</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/6feb49d47e68077713b316da11a6533e1d639add">6feb49d</a><ul><li>Date : 2013-01-11</li><li>May spell fixes, thanks Denes</li></ul></li></ul>
<div class="row-fluid" id="com_6feb49d47e68077713b316da11a6533e1d639add">
    <div class="span6"><div class="diff"><div class=""> ------</div><div class=""> Notice that many of these modules, specifically ``dal`` (the Database Abstraction Layer), ``template`` (the template language), ``rocket`` (the web server), and</div><div class="insert">``html`` (the helper<span class="highlight">s</span>) have no dependencies and can be used outside of web2py.</div><div class=""> -----</div><div class=""> </div><div class=""> The tar gzipped scaffolding app that ship with web2py is</div><div class=""> ``</div><div class=""> welcome.w2p</div><div class=""> ``:code</div><div class=""> </div><div class=""> This is created upon installation and overwritten on upgrade.</div><div class=""> </div><div class=""> -------</div><div class=""> The first time you start web2py, two new folders are created: deposit and applications. The deposit folder is used as temporary storage for installing and uninstalling applications.</div><div class=""> </div><div class=""> Also, the first time you start web2py and after an upgrade, the &quot;welcome&quot; app is zipped into a &quot;welcome.w2p&quot; file to be used as a scaffolding app.</div><div class=""> -------</div><div class=""> </div><div class=""> When web2py is upgraded it comes with a file called &quot;NEWINSTALL&quot;. If web2py finds this file, it understand an upgrade was performed, hence it removed the file and creates a new &quot;welcome.w2p&quot;.</div><div class=""> </div><div class=""> The current web2py version is stored in the field &quot;VERSION&quot; and it follows standard semantic versioning notation where the build id is the build timestamp.</div><div class=""> </div><div class=""> web2py unit-tests are in</div><div class=""> current.auth = auth</div><div class=""> </div><div class=""> and now all modules imported can access</div><div class=""> </div><div class=""> - ``current.auth``</div><div class=""> </div><div class=""> ``current`` and ``import`` create a powerful mechanism to build extensible and reusable modules for your applications.</div><div class=""> </div><div class=""> -------</div><div class=""> There is one major caveat. Given ``from gluon import current``, it is correct to use ``current.request`` and any of the other thread local objects but one should never assign them to global variables in the module, such as in</div><div class=""> ``</div><div class=""> request = current.request # WRONG! DANGER!</div><div class=""> ``</div><div class=""> nor one should use it assign class attributes</div><div class=""> ``</div><div class=""> class MyClass:</div><div class="">     request = current.request # WRONG! DANGER!</div><div class=""> ``</div><div class=""> This is because the thread local object must be extracted at runtime. Global variables instead are defined only once when the model is imported for the first time.</div><div class=""> -------</div><div class=""> </div><div class="insert">Another caveat has to do with cache. You cannot use the ``cache`` object to decorate functions in modules, that is because it would not behave as expected. In order to cache a function ``f`` in a module you must use<span class="highlight"></span> ``lazy_cache``:</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.cache import lazy_cache</div><div class=""> </div><div class=""> lazy_cache(&#x27;key&#x27;, time_expire=60, cache_model=&#x27;ram&#x27;)</div><div class=""> def f(a,b,c,): ....</div><div class=""> ``:code</div><div class=""> </div><div class=""> Mind that the key is user defined but must be uniquely associated to the function. If omitted web2py will automatically determine a key.</div><div class=""> </div><div class=""> ### ``request``</div><div class=""> ``request``:inxx ``Storage``:inxx ``request.cookies``:inxx ``user_agent``:inxx</div><div class=""> </div><div class=""> The ``request`` object is an instance of the ubiquitous web2py class that is called ``gluon.storage.Storage``, which extends the Python ``dict`` class. It is basically a dictionary, but the item values can also be accessed as attributes:</div><div class=""> ``</div><div class=""> request.vars</div><div class=""> ``:code</div><div class=""> </div><div class=""> is the same as:</div><div class=""> ``</div><div class=""> Also notice the ``request.env.wsgi_*`` variables. They are specific to the wsgi</div><div class=""> ``response.stream``:inxx</div><div class=""> ``response.subtitle``:inxx</div><div class=""> ``response.title``:inxx</div><div class=""> ``response.toolbar``:inxx</div><div class=""> ``response.view``:inxx</div><div class=""> ``response.delimiters``:inxx</div><div class=""> ``response.js``:inxx</div><div class=""> ``response.write``:inxx</div><div class=""> ``response.include_files``:inxx</div><div class=""> ``response.include_meta``:inxx</div><div class=""> ``response.optimize_css``:inxx</div><div class=""> ``response.optimize_js``:inxx</div><div class=""> ``response._caller``:inxx</div><div class=""> </div><div class=""> ``response`` is another instance of the ``Storage`` class. It contains the following:</div><div class=""> </div><div class=""> - ``response.body``: a ``StringIO`` object into which web2py writes the output page body. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.cookies``: similar to ``request.cookies``, but while the latter contains the cookies sent from the client to the server, the former contains cookies sent by the server to the client. The session cookie is handled automatically.</div><div class=""> - ``response.download(request, db)``: a method used to implement the controller function that allows downloading of uploaded files. ``request.download`` expects the last ``arg`` in ``request.args`` to be the encoded filename (i.e., the filename generated at upload time and stored in the upload field). It extracts the upload field name and table name as well as the original filename from the encoded filename. ``response.download`` takes two optional arguments: ``chunk_size`` sets the size in bytes for chunked streaming (defaults to 64K), and ``attachments`` determines whether the downloaded file should be treated as an attachment or not (default to ``True``). Note, ``response.download`` is specifically for downloading files associated with ``db`` upload fields. Use ``response.stream`` (see below) for other types of file downloads and streaming. Also, note that it is not necessary to use ``response.download`` to access files uploaded to the /static folder -- static files can (and generally should) be accessed directly via URL (e.g., /app/static/files/myfile.pdf).</div><div class=""> - ``response.files``: a list of .css, .js, coffee, and .less files required by the page. They will automatically be linked in the head of the standard &quot;layout.html&quot; via the included &quot;web2py_ajax.html&quot;. To include a new CSS, JS, COFFEE, or LESS file, just append it to this list. It will handle duplicates. The order is significant.</div><div class="insert">- ``response.include_files()`` generates html head tags to include<span class="highlight"></span> all ``response.files`` (used in &quot;views/web2py_ajax.html&quot;).</div><div class=""> - ``response.flash``: optional parameter that may be included in the views. Normally used to notify the user about something that happened.</div><div class=""> - ``response.headers``: a ``dict`` for HTTP response headers. Web2py sets some headers by default, including &quot;Content-Length&quot;, &quot;Content-Type&quot;, and &quot;X-Powered-By&quot; (set equal to web2py). Web2py also sets the &quot;Cache-Control&quot;, &quot;Expires&quot;, and &quot;Pragma&quot; headers to prevent client-side caching, except for static file requests, for which client-side caching is enabled. The headers that web2py sets can be overwritten or removed, and new headers can be added (e.g., ``response.headers[&#x27;Cache-Control&#x27;] = &#x27;private&#x27;``). You can remove a header removing its key from the response.headers dict, e.g.``del response.headers[&#x27;Custom-Header&#x27;]``, however web2py&#x27;s default headers will be re-added just before returning the response. To avoid this behavior, just set the header value to None, e.g. to remove the default Content-Type header, ``response.headers[&#x27;Content-Type&#x27;] = None``</div><div class=""> - ``response.menu``: optional parameter that may be included in the views, normally used to pass a navigation menu tree to the view. It can be rendered by the MENU helper.</div><div class=""> - ``response.meta``: a storage object (like a dict) that contains optional meta information like ``response.meta.author``, ``.description``, and/or ``.keywords``. The content of each meta variable is automatically placed in the proper ``META`` tag by the code in &quot;views/web2py_ajax.html&quot;, which is included by default in &quot;views/layout.html&quot;.</div><div class=""> - ``response.include_meta()`` generates a string that includes all ``response.meta`` headers serialized (used in &quot;views/web2py_ajax.html&quot;).</div><div class=""> - ``response.postprocessing``: this is a list of functions, empty by default. These functions are used to filter the response object at the output of an action, before the output is rendered by the view. It can be used to implement support for other template languages.</div><div class=""> - ``response.render(view, vars)``: a method used to call the view explicitly inside the controller. ``view`` is an optional parameter which is the name of the view file, ``vars`` is a dictionary of named values passed to the view.</div><div class=""> - ``response.session_file``: file stream containing the session.</div><div class=""> - ``response.session_file_name``: name of the file where the session will be saved.</div><div class=""> - ``response.session_id``: the id of the current session. It is determined automatically. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.session_id_name``: the name of the session cookie for this application. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.status``: the HTTP status code integer to be passed to the response. Default is 200 (OK).</div><div class=""> - ``response.stream(file, chunk_size, request=request, attachment=False, filename=None, headers=None)``: when a controller returns it, web2py streams the file content back to the client in blocks of size ``chunk_size``. The ``request`` parameter is required to use the chunk start in the HTTP header. ``file`` should be a file path (for backward compatibility, it can also be an open file object, but this is not recommended). As noted above, ``response.download`` should be used to retrieve files stored via an upload field. ``response.stream`` can be used in other cases, such as returning a temporary file or StringIO object created by the controller. If ``attachment`` is True, the Content-Disposition header will be set to &quot;attachment&quot;, and if ``filename`` is also provided, it will be added to the Content-Disposition header as well (but only when ``attachment`` is True). If not already included in ``response.headers``, the following response headers will be set automatically: Content-Type, Content-Length, Cache-Control, Pragma, and Last-Modified (the latter three are set to allow browser caching of the file). To override any of these automatic header settings, simply set them in ``response.headers`` before calling ``response.stream``.</div><div class=""> - ``response.subtitle``: optional parameter that may be included in the views. It should contain the subtitle of the page.</div><div class=""> - ``response.title``: optional parameter that may be included in the views. It should contain the title of the page and should be rendered by the HTML title TAG in the header.</div><div class="insert">- ``response.toolbar``: a function that allows you <span class="highlight">to </span>embed a toolbar into page for<span class="highlight"></span> debugging purposes ``{{=response.toolbar()}}``. The toolbar displays request, response, session variables and database access time for each query.</div><div class=""> - ``response._vars``: this variable is accessible only in a view, not in the action. It contains the value returned by the action to the view.</div><div class=""> - ``response._caller``: this is a function that wraps all action calls. It defaults to the identity function, but it can be modifed in order to catch special types of exception to do extra logging;</div><div class="">   ``</div><div class="">   response._caller = lambda f: f()</div><div class="">   ``</div><div class=""> - ``response.optimize_css``: if can be set to &quot;concat,minify,inline&quot; to concatenate, minify and inline the CSS files included by web2py.</div><div class=""> - ``response.optimize_js``: if can be set to &quot;concat,minify,inline&quot; to concatenate, minify and inline the JavaScript files included by web2py.</div><div class=""> - ``response.view``: the name of the view template that must render the page. This is set by default to:</div><div class="">   ``</div><div class="">   &quot;%s/%s.%s&quot; % (request.controller, request.function, request.extension)</div><div class="">   ``:code</div><div class="">   or, if the above file cannot be located, to</div><div class="">   ``</div><div class="">   &quot;generic.%s&quot; % (request.extension)</div><div class="">   ``:code</div><div class="">   Change the value of this variable to modify the view file associated with a particular action.</div><div class=""> </div><div class=""> - ``response.delimiters`` defaults to ``(&#x27;{{&#x27;,&#x27;}}&#x27;)``. It allows you to change the delimiter of code embedded in views.</div><div class=""> - ``response.xmlrpc(request, methods)``: when a controller returns it, this function exposes the methods via XML-RPC``xmlrpc``:cite . This function is deprecated since a better mechanism is available and described in Chapter 10.</div><div class=""> - ``response.write(text)``: a method to write text into the output page body.</div><div class=""> redirect(...,type=&#x27;auto&#x27;)</div><div class=""> ``T``:inxx ``internationalization``:inxx</div><div class=""> </div><div class=""> The object ``T`` is the language translator. It constitutes a single global instance of the web2py class ``gluon.language.translator``. All string constants (and only string constants) should be marked by ``T``, for example:</div><div class=""> ``</div><div class=""> a = T(&quot;hello world&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Strings that are marked with ``T`` are identified by web2py as needing language translation and they will be translated when the code (in the model, controller, or view) is executed. If the string to be translated is not a constant but a variable, it will be added to the translation file at runtime (except on GAE) to be translated later.</div><div class=""> </div><div class=""> The ``T`` object can also contain interpolated variables and support multiple equivalent syntax:</div><div class=""> ``</div><div class=""> a = T(&quot;hello %s&quot;, (&#x27;Tim&#x27;,))</div><div class=""> a = T(&quot;hello %(name)s&quot;, dict(name=&#x27;Tim&#x27;))</div><div class=""> a = T(&quot;hello %s&quot;) % (&#x27;Tim&#x27;,)</div><div class=""> a = T(&quot;hello %(name)s&quot;) % dict(name=&#x27;Tim&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The latter syntax is recommended because it makes translation easier.</div><div class=""> The first string is translated according to the requested language file and the ``name`` variable is replaced independently of the language.</div><div class=""> </div><div class="insert"><span class="highlight">You can c</span>oncatenating<span class="highlight"></span> translated strings and normal strings<span class="highlight"></span>:</div><div class=""> ``</div><div class="insert"><span class="highlight">T(&quot;blah &quot;) + </span>name + T(&quot; blah&quot;)<span class="highlight"></span></div><div class=""> ``:code</div><div class=""> </div><div class=""> The following code is also allowed and often preferable:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;blah %(name)s blah&quot;, dict(name=&#x27;Tim&#x27;))</div><div class=""> ``:code</div><div class=""> </div><div class=""> or the alternative syntax</div><div class=""> ``</div><div class=""> T(&quot;blah %(name)s blah&quot;) % dict(name=&#x27;Tim&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> In both cases the translation occurs before the variable name is substituted in the &quot;%(name)s&quot; slot. The following alternative should NOT BE USED:</div><div class=""> ``</div><div class=""> T(&quot;blah %(name)s blah&quot; % dict(name=&#x27;Tim&#x27;))</div><div class=""> ``:code</div><div class=""> </div><div class=""> because translation would occur after substitution.</div><div class=""> </div><div class=""> Notice that this can result in lots of file IO and you may want to disable it:</div><div class=""> </div><div class=""> ``</div><div class=""> T.is_writable = False</div><div class=""> ``:code</div><div class=""> </div><div class=""> prevents T from dynamically updating language files.</div><div class=""> </div><div class=""> #### Comments and multiple translations</div><div class=""> </div><div class=""> It is possible that the same string appears in different contexts in the application and needs different translations based on context. In order to do this, one can add comments to the original string. The comments will not be rendered but will be used by web2py to determine the most appropriate translation. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;hello world ## first occurrence&quot;)</div><div class=""> T(&quot;hello world ## second occurrence&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The text following the ``##``, including the double ``##``, are comments.</div><div class=""> </div><div class=""> #### Pluralization engine</div><div class=""> </div><div class="insert">Since version 2.0, web2py include<span class="highlight">s a powerful</span> pluralization system (PS). This means that when text marked for translation depends on a numeric variable, it may be translated differently based on the numeric value. For example in english we may render:</div><div class=""> </div><div class=""> ``</div><div class=""> x book(s)</div><div class=""> ``</div><div class=""> </div><div class=""> with</div><div class=""> </div><div class=""> ``</div><div class=""> a book (x==0)</div><div class=""> x books (x&gt;0)</div><div class=""> ``</div><div class=""> </div><div class=""> English has one singular form and one plural form. The plural form is constructed by adding a &quot;-s&quot; or &quot;-es&quot; or using an exceptional form. web2py provides a way to define pluralization rules for each languages, as well as exceptions to the default rules. In fact web2py already knows pluralization rules for many languages. It knows, for example, that Slovenian has one singular form and 3 plural forms (for x==1, x==3 or x==4 and x&gt;4). These rules are encoded in &quot;gluon/contrib/plural_rules/*.py&quot; files and new files can be created. Explicit pluralizations for words are created by editing pluralization files using the administrative interface.</div><div class=""> </div><div class=""> By default the PS is not activated. It is triggered by the ``symbol`` argument of the ``T`` function. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;You have %s %%{book}&quot;, symbols=10)</div><div class=""> ``:code</div><div class=""> </div><div class="insert">+Now the PS is activated for the word &quot;book&quot; and for the number 10.</div><div class="insert">+The result in english will be: &quot;You have 10 books&quot;. Notice that &quot;book&quot; has been pluralized into &quot;books&quot;.</div><div class=""> </div><div class=""> The PS consists from 3 parts:</div><div class=""> - placeholders ``%%{}`` to mark words in ``T``-messages</div><div class=""> - rule to give a decision which word form to use (&quot;rules/plural_rules/*.py&quot;)</div><div class=""> - dictionary with word plural forms (&quot;app/languages/plural-*.py&quot;)</div><div class=""> </div><div class=""> The value of symbols can be a single variable, a list/tuple of variables, or a dictionary.</div><div class=""> </div><div class=""> The placeholder ``%%{}`` consists of 3 parts:</div><div class=""> </div><div class=""> ``</div><div class=""> %%{[&lt;modifier&gt;]&lt;world&gt;[&lt;parameter&gt;]},</div><div class=""> ``</div><div class=""> </div><div class=""> where:</div><div class=""> </div><div class=""> ``</div><div class=""> &lt;modifier&gt;::= ! | !! | !!!</div><div class="insert">&lt;word&gt; ::= any wor<span class="highlight"></span>d or phrase in singular in lower case (!)</div><div class=""> &lt;parameter&gt; ::= [index] | (key) | (number)</div><div class=""> ``</div><div class=""> </div><div class=""> For example:</div><div class=""> </div><div class=""> - ``%%{word}`` is equivalent to %%{word[0]} (if no modifiers are used).</div><div class=""> - ``%%{word[index]}`` is used when symbols is a tuple. symbols[index] gives us a number used to make a decision on which word form to choose.</div><div class=""> - ``%%{word(key)}`` is used to get the numeric parameter from symbols[key]</div><div class=""> - ``%%{word(number)}`` allows to set a ``number`` directly (e.g.: ``%%{word(%i)}``)</div><div class=""> - ``%%{?word?number}`` returns &quot;word&quot; if ``number==1``, returns the ``number`` otherwise</div><div class=""> - ``%%{?number} or %%{??number}`` returns ``number`` if ``number!=1``, return nothing otherwise</div><div class=""> </div><div class=""> ``T(&quot;blabla %s %%{word}&quot;, symbols=var)``</div><div class=""> </div><div class=""> ``%%{word}`` by default means ``%%{word[0]}``,</div><div class=""> where ``[0]`` is an item index in symbols tuple.</div><div class=""> </div><div class=""> ``T(&quot;blabla %s %s %%{word[1]}&quot;, (var1, var2))``</div><div class=""> PS is used for &quot;word&quot; and var2 respectively.</div><div class=""> </div><div class=""> For example</div><div class=""> </div><div class=""> ``T(&quot;%%{this} %%{is} %%{?a?%s} %%{book}&quot;, var)``</div><div class=""> </div><div class=""> produces:</div><div class=""> </div><div class=""> ``</div><div class=""> var  output</div><div class=""> ------------------</div><div class="">  1   this is a book</div><div class="">  2   these are 2 books</div><div class="">  3   these are 2 books</div><div class="">  ...</div><div class=""> ``</div><div class=""> </div><div class=""> Inside ``%%{...}`` you can also use the following modifiers:</div><div class=""> </div><div class=""> - ``!`` to capitalize the text (equivalent to ``string.capitalize``)</div><div class=""> - ``!!`` to capitalize every word (equivalent to ``string.title``)</div><div class=""> - ``!!!`` to capitalize every character (equivalent to ``string.upper``)</div><div class=""> </div><div class="insert">Notice you can use ``\\`` to <span class="highlight">e</span>scape ``!`` and ``?``.</div><div class=""> </div><div class=""> #### Translations, pluralization, and MARKMIN</div><div class=""> </div><div class=""> You can also use the powerful MARKMIN syntax inside translation strings by replacing</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;hello world&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> with</div><div class=""> </div><div class=""> ``</div><div class=""> T.M(&quot;hello world&quot;)</div><div class=""> ``</div><div class=""> </div><div class=""> Now the string accepts MARKMIN markup as described later in the book. You can also use the pluralization system inside MARKMIN.</div><div class=""> </div><div class=""> ### Cookies</div><div class=""> </div><div class=""> ``cookies``:inxx</div><div class=""> For each tuple, the first string is matched against &quot;[app name]/[error code]&quot;. I</div><div class=""> - ``code``: the HTTP status code (e.g., 404, 500)</div><div class=""> - ``ticket``: in the form of &quot;[app name]/[ticket number]&quot; (or &quot;None&quot; if no ticket)</div><div class=""> - ``requested_uri``: equivalent to ``request.env.request_uri``</div><div class=""> - ``request_url``: equivalent to ``request.url``</div><div class=""> </div><div class=""> These variables will be accessible to the error handling action via ``request.vars`` and can be used in generating the error response. In particular, it is a good idea for the error action to return the original HTTP error code instead of the default 200 (OK) status code. This can be done by setting ``response.status = request.vars.code``. It is also possible to have the error action send (or queue) an email to an administrator, including a link to the ticket in ``admin``.</div><div class=""> </div><div class=""> Unmatched errors display a default error page. This default error page can also be customized here (see ``router.example.py`` and ``routes.example.py`` in the root web2py folder):</div><div class=""> ``</div><div class=""> error_message = &#x27;&lt;html&gt;&lt;body&gt;&lt;h1&gt;%s&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&#x27;</div><div class=""> error_message_ticket = &#x27;&#x27;&#x27;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Internal error&lt;/h1&gt;</div><div class="">      Ticket issued: &lt;a href=&quot;/admin/default/ticket/%(ticket)s&quot;</div><div class="">      target=&quot;_blank&quot;&gt;%(ticket)s&lt;/a&gt;&lt;/body&gt;&lt;/html&gt;&#x27;&#x27;&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class=""> The first variable contains the error message when an invalid application or function is requested. The second variable contains the error message when a ticket is issued.</div><div class=""> </div><div class=""> ``routes_onerror`` work with both routing mechanisms.</div><div class=""> </div><div class=""> ``error_handler``:inxx</div><div class="insert">In &quot;routes.py&quot; <span class="highlight">you</span> can also specify an action in charge of error handling:</div><div class=""> </div><div class=""> ``</div><div class=""> error_handler = dict(application=&#x27;error&#x27;,</div><div class="">                       controller=&#x27;default&#x27;,</div><div class="">                       function=&#x27;index&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> If the ``error_handler`` is specified the action is called without user redirection and the handler action will be in charge of dealing with the error. In the event that the error-handling page itself returns an error, web2py will fall back to its old static responses.</div><div class=""> </div><div class=""> </div><div class=""> #### Static asset management</div><div class=""> </div><div class=""> Since version 2.1.0, web2py has the ability to manage static assets.</div><div class=""> </div><div class=""> When an application is in development, static file can change often, therefore web2py sends static files with no cache headers. This has the side-effect of &quot;forcing&quot; the browser to request static files at every request. This results in low performance when loading the page.</div><div class=""> </div><div class=""> In a &quot;production&quot; site, you may want to serve static files with ``cache`` headers to prevent un-necessary downloads since static files do not change.</div><div class=""> </div><div class=""> ``cache`` headers allow the browser to fetch each file only once, thus saving bandwidth and reducing loading time.</div><div class=""> </div><div class=""> Yet there is a problem: What should the cache headers declare? When should the f</div><div class=""> A manual approach consists of creating subfolders for different versions of static files. For example an early version of &quot;layout.css&quot; can be made available at the URL &quot;/myapp/static/css/1.2.3/layout.css&quot;. When you change the file, you create a new subfolder and you link it as &quot;/myapp/static/css/1.2.4/layout.css&quot;.</div><div class=""> </div><div class=""> This procedure works but it is pedantic since every time you update the css file, you must remember to move it to another folder, change the URL of the file in your layout.html and deploy.</div><div class=""> </div><div class=""> Static asset management solves the problem by allowing the developer to declare a version for a group of static files and they will be requested again only when the version number changes. The version number of made part of the file url as in the previous example. The difference from the previous approach is that the version number only appears in the URL, not in the file system.</div><div class=""> </div><div class=""> </div><div class=""> If you want to serve &quot;/myapp/static/layout.css&quot; with the cache headers, you just need to include the file with a modified URL that includes a version number:</div><div class=""> ``</div><div class=""> /myapp/static/_1.2.3/layout.css</div><div class=""> ``</div><div class=""> (notice the URL defines a version number, it does not appear anywhere else).</div><div class=""> </div><div class=""> Notice that the URL starts with &quot;/myapp/static/&quot;, followed by a version number composed by an underscore and 3 integers separated by a period (as described in [[SemVer http://semver.org/]]), then followed by the filename. Also notice that you do not have to create a &quot;_1.2.3/&quot; folder.</div><div class=""> </div><div class=""> Every time the static file is requested with a version in the url, it will be served with &quot;far in the future&quot; cache headers, specifically:</div><div class=""> ``</div><div class=""> Cache-Control : max-age=315360000</div><div class=""> Expires: Thu, 31 Dec 2037 23:59:59 GMT</div><div class=""> ``</div><div class="insert">This means that the browser will fetch those file<span class="highlight">s</span> only once, and they will be saved &quot;forever&quot; in the browser&#x27;s cache.</div><div class=""> </div><div class=""> Every time the &quot;_1.2.3/filename&quot; is requested, web2py will remove the version part from the path and serve your file with far in the future headers so they will be cached forever. If you changed the version number in the URL, this tricks the browser into thinking it is requesting a different file, and the file is fetched again.</div><div class=""> </div><div class=""> You can use &quot;_1.2.3&quot;, &quot;_0.0.0&quot;, &quot;_999.888.888&quot;, as long as the version starts with underscore followed by three numbers separated by period.</div><div class=""> </div><div class=""> When in development, you can use ``response.files.append(...)`` to link the static URLs of static files. In this case you can include the &quot;_1.2.3/&quot; part manually, or you take advantage of a new parameter of the response object: ``response.static_version``.</div><div class=""> Just include the files the way you used to, for example</div><div class=""> ``</div><div class=""> {{response.files.append(URL(&#x27;static&#x27;,&#x27;layout.css&#x27;))}}</div><div class=""> ``</div><div class=""> and in models set</div><div class=""> ``</div><div class=""> response.static_version = &#x27;1.2.3&#x27;</div><div class=""> ``:code</div><div class=""> This will rewrite automatically every &quot;/myapp/static/layout.css&quot; url as &quot;/myapp/static/_1.2.3/layout.css&quot;, for every file included in ``response.files``.</div><div class=""> </div><div class=""> Often in production you let the webserver (apache, nginx, etc.) serve the static files. You need to adjust your configuration in such a way that it will &quot;skip&quot; the &quot;_1.2.3/&quot; part.</div><div class=""> </div><div class=""> For example, in Apache, change this:</div><div class=""> ``</div><div class=""> AliasMatch ^/([^/]+)/static/(?:/_[\d]+\.[\d]+\.[\d]+)?(.*) \</div><div class=""> </div><div class=""> Similarly, in Nginx change this:</div><div class=""> ``</div><div class=""> location ~* /(\w+)/static/ {</div><div class="">     root /home/www-data/web2py/applications/;</div><div class="">     expires max;</div><div class=""> }</div><div class=""> ``</div><div class=""> into this:</div><div class=""> ``</div><div class=""> location ~* /(\w+)/static(?:/_[\d]+\.[\d]+\.[\d]+)?/(.*)$ {</div><div class="">    alias /home/www-data/web2py/applications/$1/static/$2;</div><div class="">    expires max;</div><div class=""> }</div><div class=""> ``</div><div class=""> </div><div class=""> ### Running tasks in the background</div><div class=""> </div><div class=""> In web2py, every http request is served in its own thread. Threads are recycled for efficiency and managed by the web server. For security, the web server sets a time-out on each request. This means that actions should not run tasks that take too long, should not create new threads, and should not fork processes (it is possible but not recommended).</div><div class=""> </div><div class="insert">The proper way to run time-consuming tasks is doing it in the background. There is not a single wa<span class="highlight">y</span> of doing it, but here we describe three mechanisms that are built into web2py: **cron**, **homemade task queues**, and **scheduler**.</div><div class=""> </div><div class=""> By **cron** we refer to a web2py functionality not to the Unix Cron mechanism. The web2py cron works on windows too.</div><div class=""> </div><div class=""> web2py cron is the way to go if you need tasks in the background at scheduled times and these tasks take a relatively short time compared to the time interval between two calls. Each task runs in its own process, and multiple tasks can run concurrently, but you have no control over how many tasks run. If accidentally one task overlaps with itself, it can cause a database lock and a spike in memory usage.</div><div class=""> </div><div class=""> web2py scheduler takes a different approach. The number of running processes is fixed, and they can run on different machines. Each process is called a worker. Each worker picks a task when available and executes it as soon as possible after the time when it is scheduled to run, but not necessarily at that exact time. There cannot be more processes running than the number of scheduled tasks and therefore no memory spikes. Scheduler tasks can be defined in models and are stored in the database. The web2py scheduler does not implement a distributed queue since it assumes that the time to distribute tasks is negligible compared with the time to run the tasks. Workers pick up the task from the database.</div><div class=""> </div><div class=""> Homemade tasks queues can be a simpler alternative to the web2py scheduler in some cases.</div><div class=""> </div><div class=""> #### Cron</div><div class=""> ``cron``:inxx</div><div class=""> </div><div class=""> The web2py cron provides the ability for applications to execute tasks at preset times, in a platform-independent manner.</div><div class=""> </div><div class=""> For each application, cron functionality is defined by a crontab file:</div><div class=""> </div><div class=""> ``</div><div class=""> app/cron/crontab</div><div class=""> ``</div><div class=""> </div><div class=""> If you specify ``@reboot`` in the first field in the crontab file, the given tas</div><div class=""> </div><div class=""> Depending on how you are invoking web2py, there are four modes of operation for web2py cron.</div><div class=""> - &#x27;&#x27;soft cron&#x27;&#x27;: available under all execution modes</div><div class=""> - &#x27;&#x27;hard cron&#x27;&#x27;: available if using the built-in web server (either directly or via Apache mod_proxy)</div><div class=""> - &#x27;&#x27;external cron&#x27;&#x27;: available if you have access to the system&#x27;s own cron service</div><div class=""> - No cron</div><div class=""> </div><div class=""> The default is hard cron if you are using the built-in web server; in all other cases, the default is soft cron.  Soft cron is the default method if you are using CGI, FASTCGI or WSGI (but note that soft cron is not ``enabled`` by default in the standard ``wsgihandler.py`` file provided with web2py).</div><div class=""> </div><div class=""> Your tasks will be executed on the first call (page load) to web2py after the time specified in crontab; but only after processing the page, so no delay will be observed by the user. Obviously, there is some uncertainty regarding precisely when the task will be executed, depending on the traffic the site receives. Also, the cron task may get interrupted if the web server has a page load timeout set. If these limitations are not acceptable, see &#x27;&#x27;external cron&#x27;&#x27;. Soft cron is a reasonable last resort, but if your web server allows other cron methods, they should be preferred over soft cron.</div><div class=""> </div><div class=""> Hard cron is the default if you are using the built-in web server (either directly or via Apache mod_proxy). Hard cron is executed in a parallel thread, so unlike soft cron, there are no limitations with regard to run time or execution time precision.</div><div class=""> </div><div class=""> External cron is not default in any scenario, but requires you to have access to the system cron facilities. It runs in a parallel process, so none of the limitations of soft cron apply. This is the recommended way of using cron under WSGI or FASTCGI.</div><div class=""> </div><div class=""> Example of line to add to the system crontab, (usually /etc/crontab):</div><div class=""> ``</div><div class=""> 0-59/1 * * * * web2py cd /var/www/web2py/ &amp;&amp; python web2py.py -J -C -D 1 &gt;&gt; /tmp/cron.output 2&gt;&amp;1</div><div class=""> ``:code</div><div class=""> </div><div class="insert"><span class="highlight">With external ``cron``, make sure to add either ``</span>-<span class="highlight">J`` (or ``--cronjob``, which is the same) as indicated above so that web2py knows that task is exec</span>u<span class="highlight">ted by cron. Web2</span>p<span class="highlight">y sets this interna</span>l<span class="highlight">ly with so</span>f<span class="highlight">t and hard ``cron``</span>.</div><div class=""> </div><div class=""> #### Homemade task queues</div><div class=""> </div><div class=""> While cron is useful to run tasks at regular time intervals, it is not always the best solution to run a background task. For this purpose web2py provides the ability to run any python script as if it were inside a controller:</div><div class=""> ``</div><div class=""> python web2py.py -S app -M -R applications/app/private/myscript.py -A a b c</div><div class=""> ``:code</div><div class=""> </div><div class=""> where ``-S app`` tells web2py to run &quot;myscript.py&quot; as &quot;app&quot;, ``-M`` tells web2py to execute models, and ``-A a b c`` passes optional command line arguments ``sys.args=[&#x27;a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;]`` to &quot;myscript.py&quot;.</div><div class=""> </div><div class=""> This type of background process should not be executed via cron (except perhaps for cron @reboot) because you need to be sure that no more than one instance is running at the same time. With cron it is possible that a process starts at cron iteration 1 and is not completed by cron iteration 2, so cron starts it again, and again, and again - thus jamming the mail server.</div><div class=""> </div><div class=""> In chapter 8, we will provide an example of how to use the above method to send emails.</div><div class=""> </div><div class=""> </div><div class=""> #### Scheduler (experimental)</div><div class=""> </div><div class=""> The web2py scheduler works very much like the task queue described in the previous sub-section with some differences:</div><div class=""> - It provides a standard mechanism for creating and scheduling tasks.</div><div class=""> - There is not a single background process but a set of workers processes.</div><div class=""> - The job of worker nodes can be monitored because their state, as well as the state of the tasks, is stored in the database.</div><div class=""> - It works without web2py but that is not documented here.</div><div class=""> </div><div class=""> The scheduler does not use cron, although one can use cron @reboot to start the worker nodes.</div><div class=""> </div><div class=""> More information about deploying the scheduler under Linux and Windows is in the Deployment recipes chapter.</div><div class=""> </div><div class=""> In the scheduler, a task is simply a function defined in a model (or in a module and imported by a model). For example:</div><div class=""> </div><div class=""> ``</div><div class=""> def task_add(a,b):</div><div class="">     return a+b</div><div class=""> ``:code</div><div class=""> </div><div class=""> Tasks will always be called in the same environment seen by controllers and therefore they see all the global variables defined in models, including database connections (``db``). Tasks differ from a controller action because they are not associated with an HTTP request and therefore there is no ``request.env``.</div><div class=""> </div><div class=""> ------</div><div class="insert">NB: remind to call<span class="highlight"></span> db.commit() at the end of every task if it involves inserts/updates to the database. Web2py commits by default at the end of a successful function call but the scheduler doesn&#x27;t</div><div class=""> ------</div></div></div>
    <div class="span6"><div class="diff"><div class=""> ------</div><div class=""> Notice that many of these modules, specifically ``dal`` (the Database Abstraction Layer), ``template`` (the template language), ``rocket`` (the web server), and</div><div class="delete">``html`` (the helper<span class="highlight"></span>) have no dependencies and can be used outside of web2py.</div><div class=""> -----</div><div class=""> </div><div class=""> The tar gzipped scaffolding app that ship with web2py is</div><div class=""> ``</div><div class=""> welcome.w2p</div><div class=""> ``:code</div><div class=""> </div><div class=""> This is created upon installation and overwritten on upgrade.</div><div class=""> </div><div class=""> -------</div><div class=""> The first time you start web2py, two new folders are created: deposit and applications. The deposit folder is used as temporary storage for installing and uninstalling applications.</div><div class=""> </div><div class=""> Also, the first time you start web2py and after an upgrade, the &quot;welcome&quot; app is zipped into a &quot;welcome.w2p&quot; file to be used as a scaffolding app.</div><div class=""> -------</div><div class=""> </div><div class=""> When web2py is upgraded it comes with a file called &quot;NEWINSTALL&quot;. If web2py finds this file, it understand an upgrade was performed, hence it removed the file and creates a new &quot;welcome.w2p&quot;.</div><div class=""> </div><div class=""> The current web2py version is stored in the field &quot;VERSION&quot; and it follows standard semantic versioning notation where the build id is the build timestamp.</div><div class=""> </div><div class=""> web2py unit-tests are in</div><div class=""> current.auth = auth</div><div class=""> </div><div class=""> and now all modules imported can access</div><div class=""> </div><div class=""> - ``current.auth``</div><div class=""> </div><div class=""> ``current`` and ``import`` create a powerful mechanism to build extensible and reusable modules for your applications.</div><div class=""> </div><div class=""> -------</div><div class=""> There is one major caveat. Given ``from gluon import current``, it is correct to use ``current.request`` and any of the other thread local objects but one should never assign them to global variables in the module, such as in</div><div class=""> ``</div><div class=""> request = current.request # WRONG! DANGER!</div><div class=""> ``</div><div class=""> nor one should use it assign class attributes</div><div class=""> ``</div><div class=""> class MyClass:</div><div class="">     request = current.request # WRONG! DANGER!</div><div class=""> ``</div><div class=""> This is because the thread local object must be extracted at runtime. Global variables instead are defined only once when the model is imported for the first time.</div><div class=""> -------</div><div class=""> </div><div class="delete">Another caveat has to do with cache. You cannot use the ``cache`` object to decorate functions in modules, that is because it would not behave as expected. In order to cache a function ``f`` in a module you must use<span class="highlight">r</span> ``lazy_cache``:</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.cache import lazy_cache</div><div class=""> </div><div class=""> lazy_cache(&#x27;key&#x27;, time_expire=60, cache_model=&#x27;ram&#x27;)</div><div class=""> def f(a,b,c,): ....</div><div class=""> ``:code</div><div class=""> </div><div class=""> Mind that the key is user defined but must be uniquely associated to the function. If omitted web2py will automatically determine a key.</div><div class=""> </div><div class=""> ### ``request``</div><div class=""> ``request``:inxx ``Storage``:inxx ``request.cookies``:inxx ``user_agent``:inxx</div><div class=""> </div><div class=""> The ``request`` object is an instance of the ubiquitous web2py class that is called ``gluon.storage.Storage``, which extends the Python ``dict`` class. It is basically a dictionary, but the item values can also be accessed as attributes:</div><div class=""> ``</div><div class=""> request.vars</div><div class=""> ``:code</div><div class=""> </div><div class=""> is the same as:</div><div class=""> ``</div><div class=""> Also notice the ``request.env.wsgi_*`` variables. They are specific to the wsgi</div><div class=""> ``response.stream``:inxx</div><div class=""> ``response.subtitle``:inxx</div><div class=""> ``response.title``:inxx</div><div class=""> ``response.toolbar``:inxx</div><div class=""> ``response.view``:inxx</div><div class=""> ``response.delimiters``:inxx</div><div class=""> ``response.js``:inxx</div><div class=""> ``response.write``:inxx</div><div class=""> ``response.include_files``:inxx</div><div class=""> ``response.include_meta``:inxx</div><div class=""> ``response.optimize_css``:inxx</div><div class=""> ``response.optimize_js``:inxx</div><div class=""> ``response._caller``:inxx</div><div class=""> </div><div class=""> ``response`` is another instance of the ``Storage`` class. It contains the following:</div><div class=""> </div><div class=""> - ``response.body``: a ``StringIO`` object into which web2py writes the output page body. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.cookies``: similar to ``request.cookies``, but while the latter contains the cookies sent from the client to the server, the former contains cookies sent by the server to the client. The session cookie is handled automatically.</div><div class=""> - ``response.download(request, db)``: a method used to implement the controller function that allows downloading of uploaded files. ``request.download`` expects the last ``arg`` in ``request.args`` to be the encoded filename (i.e., the filename generated at upload time and stored in the upload field). It extracts the upload field name and table name as well as the original filename from the encoded filename. ``response.download`` takes two optional arguments: ``chunk_size`` sets the size in bytes for chunked streaming (defaults to 64K), and ``attachments`` determines whether the downloaded file should be treated as an attachment or not (default to ``True``). Note, ``response.download`` is specifically for downloading files associated with ``db`` upload fields. Use ``response.stream`` (see below) for other types of file downloads and streaming. Also, note that it is not necessary to use ``response.download`` to access files uploaded to the /static folder -- static files can (and generally should) be accessed directly via URL (e.g., /app/static/files/myfile.pdf).</div><div class=""> - ``response.files``: a list of .css, .js, coffee, and .less files required by the page. They will automatically be linked in the head of the standard &quot;layout.html&quot; via the included &quot;web2py_ajax.html&quot;. To include a new CSS, JS, COFFEE, or LESS file, just append it to this list. It will handle duplicates. The order is significant.</div><div class="delete">- ``response.include_files()`` generates html head tags to include<span class="highlight">s</span> all ``response.files`` (used in &quot;views/web2py_ajax.html&quot;).</div><div class=""> - ``response.flash``: optional parameter that may be included in the views. Normally used to notify the user about something that happened.</div><div class=""> - ``response.headers``: a ``dict`` for HTTP response headers. Web2py sets some headers by default, including &quot;Content-Length&quot;, &quot;Content-Type&quot;, and &quot;X-Powered-By&quot; (set equal to web2py). Web2py also sets the &quot;Cache-Control&quot;, &quot;Expires&quot;, and &quot;Pragma&quot; headers to prevent client-side caching, except for static file requests, for which client-side caching is enabled. The headers that web2py sets can be overwritten or removed, and new headers can be added (e.g., ``response.headers[&#x27;Cache-Control&#x27;] = &#x27;private&#x27;``). You can remove a header removing its key from the response.headers dict, e.g.``del response.headers[&#x27;Custom-Header&#x27;]``, however web2py&#x27;s default headers will be re-added just before returning the response. To avoid this behavior, just set the header value to None, e.g. to remove the default Content-Type header, ``response.headers[&#x27;Content-Type&#x27;] = None``</div><div class=""> - ``response.menu``: optional parameter that may be included in the views, normally used to pass a navigation menu tree to the view. It can be rendered by the MENU helper.</div><div class=""> - ``response.meta``: a storage object (like a dict) that contains optional meta information like ``response.meta.author``, ``.description``, and/or ``.keywords``. The content of each meta variable is automatically placed in the proper ``META`` tag by the code in &quot;views/web2py_ajax.html&quot;, which is included by default in &quot;views/layout.html&quot;.</div><div class=""> - ``response.include_meta()`` generates a string that includes all ``response.meta`` headers serialized (used in &quot;views/web2py_ajax.html&quot;).</div><div class=""> - ``response.postprocessing``: this is a list of functions, empty by default. These functions are used to filter the response object at the output of an action, before the output is rendered by the view. It can be used to implement support for other template languages.</div><div class=""> - ``response.render(view, vars)``: a method used to call the view explicitly inside the controller. ``view`` is an optional parameter which is the name of the view file, ``vars`` is a dictionary of named values passed to the view.</div><div class=""> - ``response.session_file``: file stream containing the session.</div><div class=""> - ``response.session_file_name``: name of the file where the session will be saved.</div><div class=""> - ``response.session_id``: the id of the current session. It is determined automatically. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.session_id_name``: the name of the session cookie for this application. NEVER CHANGE THIS VARIABLE.</div><div class=""> - ``response.status``: the HTTP status code integer to be passed to the response. Default is 200 (OK).</div><div class=""> - ``response.stream(file, chunk_size, request=request, attachment=False, filename=None, headers=None)``: when a controller returns it, web2py streams the file content back to the client in blocks of size ``chunk_size``. The ``request`` parameter is required to use the chunk start in the HTTP header. ``file`` should be a file path (for backward compatibility, it can also be an open file object, but this is not recommended). As noted above, ``response.download`` should be used to retrieve files stored via an upload field. ``response.stream`` can be used in other cases, such as returning a temporary file or StringIO object created by the controller. If ``attachment`` is True, the Content-Disposition header will be set to &quot;attachment&quot;, and if ``filename`` is also provided, it will be added to the Content-Disposition header as well (but only when ``attachment`` is True). If not already included in ``response.headers``, the following response headers will be set automatically: Content-Type, Content-Length, Cache-Control, Pragma, and Last-Modified (the latter three are set to allow browser caching of the file). To override any of these automatic header settings, simply set them in ``response.headers`` before calling ``response.stream``.</div><div class=""> - ``response.subtitle``: optional parameter that may be included in the views. It should contain the subtitle of the page.</div><div class=""> - ``response.title``: optional parameter that may be included in the views. It should contain the title of the page and should be rendered by the HTML title TAG in the header.</div><div class="delete">- ``response.toolbar``: a function that allows you <span class="highlight"></span>embed a toolbar into page for<span class="highlight">m</span> debugging purposes ``{{=response.toolbar()}}``. The toolbar displays request, response, session variables and database access time for each query.</div><div class=""> - ``response._vars``: this variable is accessible only in a view, not in the action. It contains the value returned by the action to the view.</div><div class=""> - ``response._caller``: this is a function that wraps all action calls. It defaults to the identity function, but it can be modifed in order to catch special types of exception to do extra logging;</div><div class="">   ``</div><div class="">   response._caller = lambda f: f()</div><div class="">   ``</div><div class=""> - ``response.optimize_css``: if can be set to &quot;concat,minify,inline&quot; to concatenate, minify and inline the CSS files included by web2py.</div><div class=""> - ``response.optimize_js``: if can be set to &quot;concat,minify,inline&quot; to concatenate, minify and inline the JavaScript files included by web2py.</div><div class=""> - ``response.view``: the name of the view template that must render the page. This is set by default to:</div><div class="">   ``</div><div class="">   &quot;%s/%s.%s&quot; % (request.controller, request.function, request.extension)</div><div class="">   ``:code</div><div class="">   or, if the above file cannot be located, to</div><div class="">   ``</div><div class="">   &quot;generic.%s&quot; % (request.extension)</div><div class="">   ``:code</div><div class="">   Change the value of this variable to modify the view file associated with a particular action.</div><div class=""> </div><div class=""> - ``response.delimiters`` defaults to ``(&#x27;{{&#x27;,&#x27;}}&#x27;)``. It allows you to change the delimiter of code embedded in views.</div><div class=""> - ``response.xmlrpc(request, methods)``: when a controller returns it, this function exposes the methods via XML-RPC``xmlrpc``:cite . This function is deprecated since a better mechanism is available and described in Chapter 10.</div><div class=""> - ``response.write(text)``: a method to write text into the output page body.</div><div class=""> redirect(...,type=&#x27;auto&#x27;)</div><div class=""> ``T``:inxx ``internationalization``:inxx</div><div class=""> </div><div class=""> The object ``T`` is the language translator. It constitutes a single global instance of the web2py class ``gluon.language.translator``. All string constants (and only string constants) should be marked by ``T``, for example:</div><div class=""> ``</div><div class=""> a = T(&quot;hello world&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Strings that are marked with ``T`` are identified by web2py as needing language translation and they will be translated when the code (in the model, controller, or view) is executed. If the string to be translated is not a constant but a variable, it will be added to the translation file at runtime (except on GAE) to be translated later.</div><div class=""> </div><div class=""> The ``T`` object can also contain interpolated variables and support multiple equivalent syntax:</div><div class=""> ``</div><div class=""> a = T(&quot;hello %s&quot;, (&#x27;Tim&#x27;,))</div><div class=""> a = T(&quot;hello %(name)s&quot;, dict(name=&#x27;Tim&#x27;))</div><div class=""> a = T(&quot;hello %s&quot;) % (&#x27;Tim&#x27;,)</div><div class=""> a = T(&quot;hello %(name)s&quot;) % dict(name=&#x27;Tim&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The latter syntax is recommended because it makes translation easier.</div><div class=""> The first string is translated according to the requested language file and the ``name`` variable is replaced independently of the language.</div><div class=""> </div><div class="delete"><span class="highlight">C</span>oncatenating<span class="highlight"> translation</span> translated strings and normal strings<span class="highlight"> is possible</span>:</div><div class=""> ``</div><div class="delete">-T(&quot;blah &quot;) + name + T(&quot; blah&quot;)   # invalid!</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-but the opposite no:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete"><span class="highlight"></span>name + T(&quot; blah&quot;)<span class="highlight">   # invalid!</span></div><div class=""> ``:code</div><div class=""> </div><div class=""> The following code is also allowed and often preferable:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;blah %(name)s blah&quot;, dict(name=&#x27;Tim&#x27;))</div><div class=""> ``:code</div><div class=""> </div><div class=""> or the alternative syntax</div><div class=""> ``</div><div class=""> T(&quot;blah %(name)s blah&quot;) % dict(name=&#x27;Tim&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> In both cases the translation occurs before the variable name is substituted in the &quot;%(name)s&quot; slot. The following alternative should NOT BE USED:</div><div class=""> ``</div><div class=""> T(&quot;blah %(name)s blah&quot; % dict(name=&#x27;Tim&#x27;))</div><div class=""> ``:code</div><div class=""> </div><div class=""> because translation would occur after substitution.</div><div class=""> </div><div class=""> Notice that this can result in lots of file IO and you may want to disable it:</div><div class=""> </div><div class=""> ``</div><div class=""> T.is_writable = False</div><div class=""> ``:code</div><div class=""> </div><div class=""> prevents T from dynamically updating language files.</div><div class=""> </div><div class=""> #### Comments and multiple translations</div><div class=""> </div><div class=""> It is possible that the same string appears in different contexts in the application and needs different translations based on context. In order to do this, one can add comments to the original string. The comments will not be rendered but will be used by web2py to determine the most appropriate translation. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;hello world ## first occurrence&quot;)</div><div class=""> T(&quot;hello world ## second occurrence&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The text following the ``##``, including the double ``##``, are comments.</div><div class=""> </div><div class=""> #### Pluralization engine</div><div class=""> </div><div class="delete">Since version 2.0, web2py include<span class="highlight"> s power</span> pluralization system (PS). This means that when text marked for translation depends on a numeric variable, it may be translated differently based on the numeric value. For example in english we may render:</div><div class=""> </div><div class=""> ``</div><div class=""> x book(s)</div><div class=""> ``</div><div class=""> </div><div class=""> with</div><div class=""> </div><div class=""> ``</div><div class=""> a book (x==0)</div><div class=""> x books (x&gt;0)</div><div class=""> ``</div><div class=""> </div><div class=""> English has one singular form and one plural form. The plural form is constructed by adding a &quot;-s&quot; or &quot;-es&quot; or using an exceptional form. web2py provides a way to define pluralization rules for each languages, as well as exceptions to the default rules. In fact web2py already knows pluralization rules for many languages. It knows, for example, that Slovenian has one singular form and 3 plural forms (for x==1, x==3 or x==4 and x&gt;4). These rules are encoded in &quot;gluon/contrib/plural_rules/*.py&quot; files and new files can be created. Explicit pluralizations for words are created by editing pluralization files using the administrative interface.</div><div class=""> </div><div class=""> By default the PS is not activated. It is triggered by the ``symbol`` argument of the ``T`` function. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;You have %s %%{book}&quot;, symbols=10)</div><div class=""> ``:code</div><div class=""> </div><div class="delete">-Now the PS is activated for the work &quot;book&quot; and for the number 10.</div><div class="delete">-The result in english will be: &quot;You have 10 words&quot;. Notice that &quot;word&quot; has been pluralized into &quot;words&quot;.</div><div class=""> </div><div class=""> The PS consists from 3 parts:</div><div class=""> - placeholders ``%%{}`` to mark words in ``T``-messages</div><div class=""> - rule to give a decision which word form to use (&quot;rules/plural_rules/*.py&quot;)</div><div class=""> - dictionary with word plural forms (&quot;app/languages/plural-*.py&quot;)</div><div class=""> </div><div class=""> The value of symbols can be a single variable, a list/tuple of variables, or a dictionary.</div><div class=""> </div><div class=""> The placeholder ``%%{}`` consists of 3 parts:</div><div class=""> </div><div class=""> ``</div><div class=""> %%{[&lt;modifier&gt;]&lt;world&gt;[&lt;parameter&gt;]},</div><div class=""> ``</div><div class=""> </div><div class=""> where:</div><div class=""> </div><div class=""> ``</div><div class=""> &lt;modifier&gt;::= ! | !! | !!!</div><div class="delete">&lt;word&gt; ::= any wor<span class="highlight">l</span>d or phrase in singular in lower case (!)</div><div class=""> &lt;parameter&gt; ::= [index] | (key) | (number)</div><div class=""> ``</div><div class=""> </div><div class=""> For example:</div><div class=""> </div><div class=""> - ``%%{word}`` is equivalent to %%{word[0]} (if no modifiers are used).</div><div class=""> - ``%%{word[index]}`` is used when symbols is a tuple. symbols[index] gives us a number used to make a decision on which word form to choose.</div><div class=""> - ``%%{word(key)}`` is used to get the numeric parameter from symbols[key]</div><div class=""> - ``%%{word(number)}`` allows to set a ``number`` directly (e.g.: ``%%{word(%i)}``)</div><div class=""> - ``%%{?word?number}`` returns &quot;word&quot; if ``number==1``, returns the ``number`` otherwise</div><div class=""> - ``%%{?number} or %%{??number}`` returns ``number`` if ``number!=1``, return nothing otherwise</div><div class=""> </div><div class=""> ``T(&quot;blabla %s %%{word}&quot;, symbols=var)``</div><div class=""> </div><div class=""> ``%%{word}`` by default means ``%%{word[0]}``,</div><div class=""> where ``[0]`` is an item index in symbols tuple.</div><div class=""> </div><div class=""> ``T(&quot;blabla %s %s %%{word[1]}&quot;, (var1, var2))``</div><div class=""> PS is used for &quot;word&quot; and var2 respectively.</div><div class=""> </div><div class=""> For example</div><div class=""> </div><div class=""> ``T(&quot;%%{this} %%{is} %%{?a?%s} %%{book}&quot;, var)``</div><div class=""> </div><div class=""> produces:</div><div class=""> </div><div class=""> ``</div><div class=""> var  output</div><div class=""> ------------------</div><div class="">  1   this is a book</div><div class="">  2   these are 2 books</div><div class="">  3   these are 2 books</div><div class="">  ...</div><div class=""> ``</div><div class=""> </div><div class=""> Inside ``%%{...}`` you can also use the following modifiers:</div><div class=""> </div><div class=""> - ``!`` to capitalize the text (equivalent to ``string.capitalize``)</div><div class=""> - ``!!`` to capitalize every word (equivalent to ``string.title``)</div><div class=""> - ``!!!`` to capitalize every character (equivalent to ``string.upper``)</div><div class=""> </div><div class="delete">Notice you can use ``\\`` to <span class="highlight"></span>scape ``!`` and ``?``.</div><div class=""> </div><div class=""> #### Translations, pluralization, and MARKMIN</div><div class=""> </div><div class=""> You can also use the powerful MARKMIN syntax inside translation strings by replacing</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;hello world&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> with</div><div class=""> </div><div class=""> ``</div><div class=""> T.M(&quot;hello world&quot;)</div><div class=""> ``</div><div class=""> </div><div class=""> Now the string accepts MARKMIN markup as described later in the book. You can also use the pluralization system inside MARKMIN.</div><div class=""> </div><div class=""> ### Cookies</div><div class=""> </div><div class=""> ``cookies``:inxx</div><div class=""> For each tuple, the first string is matched against &quot;[app name]/[error code]&quot;. I</div><div class=""> - ``code``: the HTTP status code (e.g., 404, 500)</div><div class=""> - ``ticket``: in the form of &quot;[app name]/[ticket number]&quot; (or &quot;None&quot; if no ticket)</div><div class=""> - ``requested_uri``: equivalent to ``request.env.request_uri``</div><div class=""> - ``request_url``: equivalent to ``request.url``</div><div class=""> </div><div class=""> These variables will be accessible to the error handling action via ``request.vars`` and can be used in generating the error response. In particular, it is a good idea for the error action to return the original HTTP error code instead of the default 200 (OK) status code. This can be done by setting ``response.status = request.vars.code``. It is also possible to have the error action send (or queue) an email to an administrator, including a link to the ticket in ``admin``.</div><div class=""> </div><div class=""> Unmatched errors display a default error page. This default error page can also be customized here (see ``router.example.py`` and ``routes.example.py`` in the root web2py folder):</div><div class=""> ``</div><div class=""> error_message = &#x27;&lt;html&gt;&lt;body&gt;&lt;h1&gt;%s&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&#x27;</div><div class=""> error_message_ticket = &#x27;&#x27;&#x27;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Internal error&lt;/h1&gt;</div><div class="">      Ticket issued: &lt;a href=&quot;/admin/default/ticket/%(ticket)s&quot;</div><div class="">      target=&quot;_blank&quot;&gt;%(ticket)s&lt;/a&gt;&lt;/body&gt;&lt;/html&gt;&#x27;&#x27;&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class=""> The first variable contains the error message when an invalid application or function is requested. The second variable contains the error message when a ticket is issued.</div><div class=""> </div><div class=""> ``routes_onerror`` work with both routing mechanisms.</div><div class=""> </div><div class=""> ``error_handler``:inxx</div><div class="delete">In &quot;routes.py&quot; <span class="highlight">ne</span> can also specify an action in charge of error handling:</div><div class=""> </div><div class=""> ``</div><div class=""> error_handler = dict(application=&#x27;error&#x27;,</div><div class="">                       controller=&#x27;default&#x27;,</div><div class="">                       function=&#x27;index&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> If the ``error_handler`` is specified the action is called without user redirection and the handler action will be in charge of dealing with the error. In the event that the error-handling page itself returns an error, web2py will fall back to its old static responses.</div><div class=""> </div><div class=""> </div><div class=""> #### Static asset management</div><div class=""> </div><div class=""> Since version 2.1.0, web2py has the ability to manage static assets.</div><div class=""> </div><div class=""> When an application is in development, static file can change often, therefore web2py sends static files with no cache headers. This has the side-effect of &quot;forcing&quot; the browser to request static files at every request. This results in low performance when loading the page.</div><div class=""> </div><div class=""> In a &quot;production&quot; site, you may want to serve static files with ``cache`` headers to prevent un-necessary downloads since static files do not change.</div><div class=""> </div><div class=""> ``cache`` headers allow the browser to fetch each file only once, thus saving bandwidth and reducing loading time.</div><div class=""> </div><div class=""> Yet there is a problem: What should the cache headers declare? When should the f</div><div class=""> A manual approach consists of creating subfolders for different versions of static files. For example an early version of &quot;layout.css&quot; can be made available at the URL &quot;/myapp/static/css/1.2.3/layout.css&quot;. When you change the file, you create a new subfolder and you link it as &quot;/myapp/static/css/1.2.4/layout.css&quot;.</div><div class=""> </div><div class=""> This procedure works but it is pedantic since every time you update the css file, you must remember to move it to another folder, change the URL of the file in your layout.html and deploy.</div><div class=""> </div><div class=""> Static asset management solves the problem by allowing the developer to declare a version for a group of static files and they will be requested again only when the version number changes. The version number of made part of the file url as in the previous example. The difference from the previous approach is that the version number only appears in the URL, not in the file system.</div><div class=""> </div><div class=""> </div><div class=""> If you want to serve &quot;/myapp/static/layout.css&quot; with the cache headers, you just need to include the file with a modified URL that includes a version number:</div><div class=""> ``</div><div class=""> /myapp/static/_1.2.3/layout.css</div><div class=""> ``</div><div class=""> (notice the URL defines a version number, it does not appear anywhere else).</div><div class=""> </div><div class=""> Notice that the URL starts with &quot;/myapp/static/&quot;, followed by a version number composed by an underscore and 3 integers separated by a period (as described in [[SemVer http://semver.org/]]), then followed by the filename. Also notice that you do not have to create a &quot;_1.2.3/&quot; folder.</div><div class=""> </div><div class=""> Every time the static file is requested with a version in the url, it will be served with &quot;far in the future&quot; cache headers, specifically:</div><div class=""> ``</div><div class=""> Cache-Control : max-age=315360000</div><div class=""> Expires: Thu, 31 Dec 2037 23:59:59 GMT</div><div class=""> ``</div><div class="delete">This means that the browser will fetch those file<span class="highlight"></span> only once, and they will be saved &quot;forever&quot; in the browser&#x27;s cache.</div><div class=""> </div><div class=""> Every time the &quot;_1.2.3/filename&quot; is requested, web2py will remove the version part from the path and serve your file with far in the future headers so they will be cached forever. If you changed the version number in the URL, this tricks the browser into thinking it is requesting a different file, and the file is fetched again.</div><div class=""> </div><div class=""> You can use &quot;_1.2.3&quot;, &quot;_0.0.0&quot;, &quot;_999.888.888&quot;, as long as the version starts with underscore followed by three numbers separated by period.</div><div class=""> </div><div class=""> When in development, you can use ``response.files.append(...)`` to link the static URLs of static files. In this case you can include the &quot;_1.2.3/&quot; part manually, or you take advantage of a new parameter of the response object: ``response.static_version``.</div><div class=""> Just include the files the way you used to, for example</div><div class=""> ``</div><div class=""> {{response.files.append(URL(&#x27;static&#x27;,&#x27;layout.css&#x27;))}}</div><div class=""> ``</div><div class=""> and in models set</div><div class=""> ``</div><div class=""> response.static_version = &#x27;1.2.3&#x27;</div><div class=""> ``:code</div><div class=""> This will rewrite automatically every &quot;/myapp/static/layout.css&quot; url as &quot;/myapp/static/_1.2.3/layout.css&quot;, for every file included in ``response.files``.</div><div class=""> </div><div class=""> Often in production you let the webserver (apache, nginx, etc.) serve the static files. You need to adjust your configuration in such a way that it will &quot;skip&quot; the &quot;_1.2.3/&quot; part.</div><div class=""> </div><div class=""> For example, in Apache, change this:</div><div class=""> ``</div><div class=""> AliasMatch ^/([^/]+)/static/(?:/_[\d]+\.[\d]+\.[\d]+)?(.*) \</div><div class=""> </div><div class=""> Similarly, in Nginx change this:</div><div class=""> ``</div><div class=""> location ~* /(\w+)/static/ {</div><div class="">     root /home/www-data/web2py/applications/;</div><div class="">     expires max;</div><div class=""> }</div><div class=""> ``</div><div class=""> into this:</div><div class=""> ``</div><div class=""> location ~* /(\w+)/static(?:/_[\d]+\.[\d]+\.[\d]+)?/(.*)$ {</div><div class="">    alias /home/www-data/web2py/applications/$1/static/$2;</div><div class="">    expires max;</div><div class=""> }</div><div class=""> ``</div><div class=""> </div><div class=""> ### Running tasks in the background</div><div class=""> </div><div class=""> In web2py, every http request is served in its own thread. Threads are recycled for efficiency and managed by the web server. For security, the web server sets a time-out on each request. This means that actions should not run tasks that take too long, should not create new threads, and should not fork processes (it is possible but not recommended).</div><div class=""> </div><div class="delete">The proper way to run time-consuming tasks is doing it in the background. There is not a single wa<span class="highlight">s</span> of doing it, but here we describe three mechanisms that are built into web2py: **cron**, **homemade task queues**, and **scheduler**.</div><div class=""> </div><div class=""> By **cron** we refer to a web2py functionality not to the Unix Cron mechanism. The web2py cron works on windows too.</div><div class=""> </div><div class=""> web2py cron is the way to go if you need tasks in the background at scheduled times and these tasks take a relatively short time compared to the time interval between two calls. Each task runs in its own process, and multiple tasks can run concurrently, but you have no control over how many tasks run. If accidentally one task overlaps with itself, it can cause a database lock and a spike in memory usage.</div><div class=""> </div><div class=""> web2py scheduler takes a different approach. The number of running processes is fixed, and they can run on different machines. Each process is called a worker. Each worker picks a task when available and executes it as soon as possible after the time when it is scheduled to run, but not necessarily at that exact time. There cannot be more processes running than the number of scheduled tasks and therefore no memory spikes. Scheduler tasks can be defined in models and are stored in the database. The web2py scheduler does not implement a distributed queue since it assumes that the time to distribute tasks is negligible compared with the time to run the tasks. Workers pick up the task from the database.</div><div class=""> </div><div class=""> Homemade tasks queues can be a simpler alternative to the web2py scheduler in some cases.</div><div class=""> </div><div class=""> #### Cron</div><div class=""> ``cron``:inxx</div><div class=""> </div><div class=""> The web2py cron provides the ability for applications to execute tasks at preset times, in a platform-independent manner.</div><div class=""> </div><div class=""> For each application, cron functionality is defined by a crontab file:</div><div class=""> </div><div class=""> ``</div><div class=""> app/cron/crontab</div><div class=""> ``</div><div class=""> </div><div class=""> If you specify ``@reboot`` in the first field in the crontab file, the given tas</div><div class=""> </div><div class=""> Depending on how you are invoking web2py, there are four modes of operation for web2py cron.</div><div class=""> - &#x27;&#x27;soft cron&#x27;&#x27;: available under all execution modes</div><div class=""> - &#x27;&#x27;hard cron&#x27;&#x27;: available if using the built-in web server (either directly or via Apache mod_proxy)</div><div class=""> - &#x27;&#x27;external cron&#x27;&#x27;: available if you have access to the system&#x27;s own cron service</div><div class=""> - No cron</div><div class=""> </div><div class=""> The default is hard cron if you are using the built-in web server; in all other cases, the default is soft cron.  Soft cron is the default method if you are using CGI, FASTCGI or WSGI (but note that soft cron is not ``enabled`` by default in the standard ``wsgihandler.py`` file provided with web2py).</div><div class=""> </div><div class=""> Your tasks will be executed on the first call (page load) to web2py after the time specified in crontab; but only after processing the page, so no delay will be observed by the user. Obviously, there is some uncertainty regarding precisely when the task will be executed, depending on the traffic the site receives. Also, the cron task may get interrupted if the web server has a page load timeout set. If these limitations are not acceptable, see &#x27;&#x27;external cron&#x27;&#x27;. Soft cron is a reasonable last resort, but if your web server allows other cron methods, they should be preferred over soft cron.</div><div class=""> </div><div class=""> Hard cron is the default if you are using the built-in web server (either directly or via Apache mod_proxy). Hard cron is executed in a parallel thread, so unlike soft cron, there are no limitations with regard to run time or execution time precision.</div><div class=""> </div><div class=""> External cron is not default in any scenario, but requires you to have access to the system cron facilities. It runs in a parallel process, so none of the limitations of soft cron apply. This is the recommended way of using cron under WSGI or FASTCGI.</div><div class=""> </div><div class=""> Example of line to add to the system crontab, (usually /etc/crontab):</div><div class=""> ``</div><div class=""> 0-59/1 * * * * web2py cd /var/www/web2py/ &amp;&amp; python web2py.py -J -C -D 1 &gt;&gt; /tmp/cron.output 2&gt;&amp;1</div><div class=""> ``:code</div><div class=""> </div><div class="delete">-If you are running external cron, make sure you add the -N command line parameter to your web2py startup script or config so there is no collision of multiple types of cron.  Also, with external ``cron``, make sure to add either ``-J`` (or ``--cronjob``, which is the same) as indicated above so that web2py knows that task is executed by cron. Web2py sets this internally with soft and hard ``cron``.</div><div class="delete">-</div><div class="delete">-In cases where you do not need any cron functionality within a particular process, you can use the -N command line parameter to disable it. Note that this might disable some maintenance tasks (like the automatic cleaning of session folders). The most common use of this function is when you:</div><div class="delete">-- have already set up external cron triggered from the system (most common with WSGI setup).</div><div class="delete"><span class="highlight"></span>-<span class="highlight"> want to deb</span>u<span class="highlight">g your a</span>p<span class="highlight">p</span>l<span class="highlight">ication without cron inter</span>f<span class="highlight">ering either with actions or with output</span>.</div><div class=""> </div><div class=""> #### Homemade task queues</div><div class=""> </div><div class=""> While cron is useful to run tasks at regular time intervals, it is not always the best solution to run a background task. For this purpose web2py provides the ability to run any python script as if it were inside a controller:</div><div class=""> ``</div><div class=""> python web2py.py -S app -M -R applications/app/private/myscript.py -A a b c</div><div class=""> ``:code</div><div class=""> </div><div class=""> where ``-S app`` tells web2py to run &quot;myscript.py&quot; as &quot;app&quot;, ``-M`` tells web2py to execute models, and ``-A a b c`` passes optional command line arguments ``sys.args=[&#x27;a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;]`` to &quot;myscript.py&quot;.</div><div class=""> </div><div class=""> This type of background process should not be executed via cron (except perhaps for cron @reboot) because you need to be sure that no more than one instance is running at the same time. With cron it is possible that a process starts at cron iteration 1 and is not completed by cron iteration 2, so cron starts it again, and again, and again - thus jamming the mail server.</div><div class=""> </div><div class=""> In chapter 8, we will provide an example of how to use the above method to send emails.</div><div class=""> </div><div class=""> </div><div class=""> #### Scheduler (experimental)</div><div class=""> </div><div class=""> The web2py scheduler works very much like the task queue described in the previous sub-section with some differences:</div><div class=""> - It provides a standard mechanism for creating and scheduling tasks.</div><div class=""> - There is not a single background process but a set of workers processes.</div><div class=""> - The job of worker nodes can be monitored because their state, as well as the state of the tasks, is stored in the database.</div><div class=""> - It works without web2py but that is not documented here.</div><div class=""> </div><div class=""> The scheduler does not use cron, although one can use cron @reboot to start the worker nodes.</div><div class=""> </div><div class=""> More information about deploying the scheduler under Linux and Windows is in the Deployment recipes chapter.</div><div class=""> </div><div class=""> In the scheduler, a task is simply a function defined in a model (or in a module and imported by a model). For example:</div><div class=""> </div><div class=""> ``</div><div class=""> def task_add(a,b):</div><div class="">     return a+b</div><div class=""> ``:code</div><div class=""> </div><div class=""> Tasks will always be called in the same environment seen by controllers and therefore they see all the global variables defined in models, including database connections (``db``). Tasks differ from a controller action because they are not associated with an HTTP request and therefore there is no ``request.env``.</div><div class=""> </div><div class=""> ------</div><div class="delete">NB: remind to call<span class="highlight"> a</span> db.commit() at the end of every task if it involves inserts/updates to the database. Web2py commits by default at the end of a successful function call but the scheduler doesn&#x27;t</div><div class=""> ------</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/f17d5b525d8d9d8b4698838c1482d5cff64144a4">f17d5b5</a><ul><li>Date : 2013-01-01</li><li>removed duplicate session</li></ul></li></ul>
<div class="row-fluid" id="com_f17d5b525d8d9d8b4698838c1482d5cff64144a4">
    <div class="span6"><div class="diff"><div class=""> -------</div><div class="insert">web2py normally runs with CPython (the C implementation of the Python interpreter created by Guido van Rossum), but it can also run with <span class="highlight">PyPy and </span>Jython<span class="highlight"></span>. The latter possibility allows the use of web2py in the context of a J2EE infrastructure. To use Jython, simply replace &quot;python web2py.py ...&quot; with &quot;jython web2py.py&quot;. Details about installing Jython, zxJDBC modules required to access the databases can be found in Chapter 14.</div><div class=""> -------</div></div></div>
    <div class="span6"><div class="diff"><div class=""> -------</div><div class="delete">web2py normally runs with CPython (the C implementation of the Python interpreter created by Guido van Rossum), but it can also run with <span class="highlight"></span>Jython<span class="highlight"> (the Java implementation of the interpreter)</span>. The latter possibility allows the use of web2py in the context of a J2EE infrastructure. To use Jython, simply replace &quot;python web2py.py ...&quot; with &quot;jython web2py.py&quot;. Details about installing Jython, zxJDBC modules required to access the databases can be found in Chapter 14.</div><div class=""> -------</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/5f1db951d80eabbaa41f72575cbdb44cb068d065">5f1db95</a><ul><li>Date : 2013-01-01</li><li>lots of edits and niphlod patch</li></ul></li></ul>
<div class="row-fluid" id="com_5f1db951d80eabbaa41f72575cbdb44cb068d065">
    <div class="span6"><div class="diff"><div class=""> ip = &#x27;0.0.0.0&#x27;</div><div class=""> port = 80</div><div class="insert">+interfaces = [(&#x27;0.0.0.0&#x27;, 80)]</div><div class="insert">+               #,(&#x27;0.0.0.0&#x27;,443,&#x27;ssl_private_key.pem&#x27;,&#x27;ssl_certificate.pem&#x27;)]</div><div class=""> password = &#x27;&lt;recycle&gt;&#x27;  # ## &lt;recycle&gt; means use the previous password</div><div class=""> pid_filename = &#x27;httpserver.pid&#x27;</div><div class=""> log_filename = &#x27;httpserver.log&#x27;</div><div class=""> profiler_filename = None</div><div class="insert">+ssl_certificate = None  # &#x27;ssl_certificate.pem&#x27;  # ## path to certificate file</div><div class="insert">+ssl_private_key = None  # &#x27;ssl_private_key.pem&#x27;  # ## path to private key file</div><div class="insert">+#numthreads = 50 # ## deprecated; remove</div><div class=""> minthreads = None</div><div class=""> maxthreads = None</div><div class=""> server_name = socket.gethostname()</div><div class=""> request_queue_size = 5</div><div class=""> timeout = 30</div><div class=""> shutdown_timeout = 5</div><div class=""> folder = os.getcwd()</div><div class=""> extcron = None</div><div class="insert"><span class="highlight"></span>n<span class="highlight">o</span>cron = <span class="highlight">Non</span>e</div><div class=""> ``:code</div><div class=""> </div><div class=""> This file contains the web2py defaults. If you edit this file, you need to import it explicitly with the ``-L`` command-line option. It only works if you run web2py as a Windows Service.</div><div class=""> </div><div class=""> ### Workflow</div><div class=""> </div><div class=""> The web2py workflow is the following:</div><div class=""> - An HTTP requests arrives to the web server (the built-in Rocket server or a different server connected to web2py via WSGI or another adapter). The web server handles each request in its own thread, in parallel.</div><div class=""> - The HTTP request header is parsed and passed to the dispatcher (explained later in this chapter).</div><div class=""> - The dispatcher decides which of the installed application will handle the request and maps the PATH_INFO in the URL into a function call. Each URL corresponds to one function call.</div><div class=""> - Requests for files in the static folder are handled directly, and large files are automatically streamed to the client.</div><div class=""> - Requests for anything but a static file are mapped into an action (i.e. a function in a controller file, in the requested application).</div><div class=""> - Before calling the action, a few things happen: if the request header contains a session cookie for the app, the session object is retrieved; if not, a session id is created (but the session file is not saved until later); an execution environment for the request is created; models are executed in this environment.</div><div class=""> - Finally the controller action is executed in the pre-built environment.</div><div class=""> - If the action returns a string, this is returned to the client (or if the action returns a web2py HTML helper object, it is serialized and returned to the client).</div><div class=""> - If the action returns an iterable, this is used to loop and stream the data to the client.</div><div class=""> - If the action returns a dictionary, web2py tries to locate a view to render the dictionary. The view must have the same name as the action (unless specified otherwise) and the same extension as the requested page (defaults to .html); on failure, web2py may pick up a generic view (if available and if enabled). The view sees every variable defined in the models as well as those in the dictionary returned by the action, but does not see global variables defined in the controller.</div><div class=""> - The entire user code is executed in a single transaction unless specified otherwise.</div><div class=""> - If the user code succeeds, the transaction is committed.</div><div class=""> - If the user code fails, the traceback is stored in a ticket, and a ticket ID is issued to the client. Only the system administrator can search and read the tracebacks in tickets.</div><div class=""> gluon/contrib/AuthorizeNet.py</div><div class=""> ``</div><div class=""> gluon/contrib/DowCommerce.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> **PaymentTech** credit cart processing API:</div><div class=""> </div><div class=""> ``</div><div class=""> gluon/contrib/paymentech.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> **PAM**``PAM``:cite  authentication API created by Chris AtLee:</div><div class=""> ``</div><div class=""> gluon/contrib/pam.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> A Bayesian classifier to populate the database with dummy data for testing purposes:</div><div class=""> ``</div><div class=""> gluon/contrib/populate.py</div><div class=""> ``:code</div><div class=""> </div><div class="insert">A file with API for running on Heroku.com <span class="highlight">: </span>``heroku``:inxx<span class="highlight"></span></div><div class=""> </div><div class=""> ``</div><div class=""> gluon/contrib/heroku.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> A file that allows interaction with the taskbar in windows, when web2py is running as a service:</div><div class=""> ``</div><div class=""> gluon/contrib/taskbar_widget.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> Optional **login_methods** and login_forms to be used for authentication:</div><div class=""> ``</div><div class=""> gluon/contrib/login_methods/__init__.py</div><div class=""> gluon/contrib/login_methods/basic_auth.py</div><div class=""> gluon/contrib/login_methods/browserid_account.py</div><div class=""> gluon/contrib/login_methods/cas_auth.py</div><div class=""> gluon/contrib/login_methods/dropbox_account.py</div><div class=""> gluon/contrib/login_methods/email_auth.py</div><div class=""> gluon/contrib/login_methods/extended_login_form.py</div><div class=""> gluon/contrib/login_methods/gae_google_account.py</div><div class=""> Also notice the ``request.env.wsgi_*`` variables. They are specific to the wsgi</div><div class=""> ``response.menu``:inxx</div><div class=""> ``response.postprocessing``:inxx</div><div class=""> ``response.render``:inxx</div><div class=""> ``response.status``:inxx</div><div class=""> ``response.stream``:inxx</div><div class=""> ``response.subtitle``:inxx</div><div class=""> ``response.title``:inxx</div><div class=""> ``response.toolbar``:inxx</div><div class=""> ``response.view``:inxx</div><div class=""> ``response.delimiters``:inxx</div><div class=""> ``response.js``:inxx</div><div class=""> ``response.write``:inxx</div><div class=""> ``response.include_files``:inxx</div><div class=""> ``response.include_meta``:inxx</div><div class=""> ``response.optimize_css``:inxx</div><div class=""> ``response.optimize_js``:inxx</div><div class=""> ``response._caller``:inxx</div><div class=""> </div><div class=""> ``response`` is another instance of the ``Storage`` class. It contains the following:</div><div class=""> </div><div class="insert">+- ``response.body``: a ``StringIO`` object into which web2py writes the output page body. NEVER CHANGE THIS VARIABLE.</div><div class="insert">+- ``response.cookies``: similar to ``request.cookies``, but while the latter contains the cookies sent from the client to the server, the former contains cookies sent by the server to the client. The session cookie is handled automatically.</div><div class="insert">+- ``response.download(request, db)``: a method used to implement the controller function that allows downloading of uploaded files. ``request.download`` expects the last ``arg`` in ``request.args`` to be the encoded filename (i.e., the filename generated at upload time and stored in the upload field). It extracts the upload field name and table name as well as the original filename from the encoded filename. ``response.download`` takes two optional arguments: ``chunk_size`` sets the size in bytes for chunked streaming (defaults to 64K), and ``attachments`` determines whether the downloaded file should be treated as an attachment or not (default to ``True``). Note, ``response.download`` is specifically for downloading files associated with ``db`` upload fields. Use ``response.stream`` (see below) for other types of file downloads and streaming. Also, note that it is not necessary to use ``response.download`` to access files uploaded to the /static folder -- static files can (and generally should) be accessed directly via URL (e.g., /app/static/files/myfile.pdf).</div><div class="insert">+- ``response.files``: a list of .css, .js, coffee, and .less files required by the page. They will automatically be linked in the head of the standard &quot;layout.html&quot; via the included &quot;web2py_ajax.html&quot;. To include a new CSS, JS, COFFEE, or LESS file, just append it to this list. It will handle duplicates. The order is significant.</div><div class="insert">+- ``response.include_files()`` generates html head tags to includes all ``response.files`` (used in &quot;views/web2py_ajax.html&quot;).</div><div class="insert">+- ``response.flash``: optional parameter that may be included in the views. Normally used to notify the user about something that happened.</div><div class="insert">+- ``response.headers``: a ``dict`` for HTTP response headers. Web2py sets some headers by default, including &quot;Content-Length&quot;, &quot;Content-Type&quot;, and &quot;X-Powered-By&quot; (set equal to web2py). Web2py also sets the &quot;Cache-Control&quot;, &quot;Expires&quot;, and &quot;Pragma&quot; headers to prevent client-side caching, except for static file requests, for which client-side caching is enabled. The headers that web2py sets can be overwritten or removed, and new headers can be added (e.g., ``response.headers[&#x27;Cache-Control&#x27;] = &#x27;private&#x27;``). You can remove a header removing its key from the response.headers dict, e.g.``del response.headers[&#x27;Custom-Header&#x27;]``, however web2py&#x27;s default headers will be re-added just before returning the response. To avoid this behavior, just set the header value to None, e.g. to remove the default Content-Type header, ``response.headers[&#x27;Content-Type&#x27;] = None``</div><div class="insert">+- ``response.menu``: optional parameter that may be included in the views, normally used to pass a navigation menu tree to the view. It can be rendered by the MENU helper.</div><div class="insert">+- ``response.meta``: a storage object (like a dict) that contains optional meta information like ``response.meta.author``, ``.description``, and/or ``.keywords``. The content of each meta variable is automatically placed in the proper ``META`` tag by the code in &quot;views/web2py_ajax.html&quot;, which is included by default in &quot;views/layout.html&quot;.</div><div class="insert">+- ``response.include_meta()`` generates a string that includes all ``response.meta`` headers serialized (used in &quot;views/web2py_ajax.html&quot;).</div><div class="insert">+- ``response.postprocessing``: this is a list of functions, empty by default. These functions are used to filter the response object at the output of an action, before the output is rendered by the view. It can be used to implement support for other template languages.</div><div class="insert">+- ``response.render(view, vars)``: a method used to call the view explicitly inside the controller. ``view`` is an optional parameter which is the name of the view file, ``vars`` is a dictionary of named values passed to the view.</div><div class="insert">+- ``response.session_file``: file stream containing the session.</div><div class="insert">+- ``response.session_file_name``: name of the file where the session will be saved.</div><div class="insert">+- ``response.session_id``: the id of the current session. It is determined automatically. NEVER CHANGE THIS VARIABLE.</div><div class="insert">+- ``response.session_id_name``: the name of the session cookie for this application. NEVER CHANGE THIS VARIABLE.</div><div class="insert">+- ``response.status``: the HTTP status code integer to be passed to the response. Default is 200 (OK).</div><div class="insert">+- ``response.stream(file, chunk_size, request=request, attachment=False, filename=None, headers=None)``: when a controller returns it, web2py streams the file content back to the client in blocks of size ``chunk_size``. The ``request`` parameter is required to use the chunk start in the HTTP header. ``file`` should be a file path (for backward compatibility, it can also be an open file object, but this is not recommended). As noted above, ``response.download`` should be used to retrieve files stored via an upload field. ``response.stream`` can be used in other cases, such as returning a temporary file or StringIO object created by the controller. If ``attachment`` is True, the Content-Disposition header will be set to &quot;attachment&quot;, and if ``filename`` is also provided, it will be added to the Content-Disposition header as well (but only when ``attachment`` is True). If not already included in ``response.headers``, the following response headers will be set automatically: Content-Type, Content-Length, Cache-Control, Pragma, and Last-Modified (the latter three are set to allow browser caching of the file). To override any of these automatic header settings, simply set them in ``response.headers`` before calling ``response.stream``.</div><div class="insert">+- ``response.subtitle``: optional parameter that may be included in the views. It should contain the subtitle of the page.</div><div class="insert">+- ``response.title``: optional parameter that may be included in the views. It should contain the title of the page and should be rendered by the HTML title TAG in the header.</div><div class="insert">+- ``response.toolbar``: a function that allows you embed a toolbar into page form debugging purposes ``{{=response.toolbar()}}``. The toolbar displays request, response, session variables and database access time for each query.</div><div class="insert">+- ``response._vars``: this variable is accessible only in a view, not in the action. It contains the value returned by the action to the view.</div><div class="insert">+- ``response._caller``: this is a function that wraps all action calls. It defaults to the identity function, but it can be modifed in order to catch special types of exception to do extra logging;</div><div class="insert">+  ``</div><div class="insert">+  response._caller = lambda f: f()</div><div class="insert">+  ``</div><div class="insert">+- ``response.optimize_css``: if can be set to &quot;concat,minify,inline&quot; to concatenate, minify and inline the CSS files included by web2py.</div><div class="insert">+- ``response.optimize_js``: if can be set to &quot;concat,minify,inline&quot; to concatenate, minify and inline the JavaScript files included by web2py.</div><div class="insert">+- ``response.view``: the name of the view template that must render the page. This is set by default to:</div><div class="insert">+  ``</div><div class="insert">+  &quot;%s/%s.%s&quot; % (request.controller, request.function, request.extension)</div><div class="insert">+  ``:code</div><div class="insert">+  or, if the above file cannot be located, to</div><div class="insert">+  ``</div><div class="insert">+  &quot;generic.%s&quot; % (request.extension)</div><div class="insert">+  ``:code</div><div class="insert">+  Change the value of this variable to modify the view file associated with a particular action.</div><div class="insert">+</div><div class="insert">+- ``response.delimiters`` defaults to ``(&#x27;{{&#x27;,&#x27;}}&#x27;)``. It allows you to change the delimiter of code embedded in views.</div><div class="insert">+- ``response.xmlrpc(request, methods)``: when a controller returns it, this function exposes the methods via XML-RPC``xmlrpc``:cite . This function is deprecated since a better mechanism is available and described in Chapter 10.</div><div class="insert">+- ``response.write(text)``: a method to write text into the output page body.</div><div class="insert">+- ``response.js`` can contain Javascript code. This code will be executed if and only if the response is received by a web2py component as discussed in Chapter 12.</div><div class=""> </div><div class=""> Since ``response`` is a ``gluon.storage.Storage`` object, it can be used to store other attributes that you may want to pass to the view. While there is no technical restriction, our recommendation is to store only variables that are to be rendered by all pages in the overall layout (&quot;layout.html&quot;).</div><div class=""> </div><div class=""> Anyway, we strongly suggest to stick to the variables listed here:</div><div class=""> ``</div><div class=""> response.title</div><div class=""> response.subtitle</div><div class=""> response.flash</div><div class=""> response.menu</div><div class=""> response.meta.author</div><div class=""> response.meta.description</div><div class=""> response.meta.keywords</div><div class=""> response.meta.*</div><div class=""> ``:code</div><div class=""> </div><div class=""> because this will make it easier for you to replace the standard &quot;layout.html&quot; file that comes with web2py with another layout file, one that uses the same set of variables.</div><div class=""> </div><div class=""> Old versions of web2py user ``response.author`` instead of ``response.meta.author`` and similar for the other meta attributes.</div><div class=""> </div><div class=""> ### ``session``</div><div class=""> If you want to serve &quot;/myapp/static/layout.css&quot; with the cache headers, you just</div><div class=""> </div><div class=""> Notice that the URL starts with &quot;/myapp/static/&quot;, followed by a version number composed by an underscore and 3 integers separated by a period (as described in [[SemVer http://semver.org/]]), then followed by the filename. Also notice that you do not have to create a &quot;_1.2.3/&quot; folder.</div><div class=""> </div><div class=""> Every time the static file is requested with a version in the url, it will be served with &quot;far in the future&quot; cache headers, specifically:</div><div class=""> ``</div><div class=""> Cache-Control : max-age=315360000</div><div class=""> Expires: Thu, 31 Dec 2037 23:59:59 GMT</div><div class=""> ``</div><div class=""> This means that the browser will fetch those file only once, and they will be saved &quot;forever&quot; in the browser&#x27;s cache.</div><div class=""> </div><div class=""> Every time the &quot;_1.2.3/filename&quot; is requested, web2py will remove the version part from the path and serve your file with far in the future headers so they will be cached forever. If you changed the version number in the URL, this tricks the browser into thinking it is requesting a different file, and the file is fetched again.</div><div class=""> </div><div class=""> You can use &quot;_1.2.3&quot;, &quot;_0.0.0&quot;, &quot;_999.888.888&quot;, as long as the version starts with underscore followed by three numbers separated by period.</div><div class=""> </div><div class=""> When in development, you can use ``response.files.append(...)`` to link the static URLs of static files. In this case you can include the &quot;_1.2.3/&quot; part manually, or you take advantage of a new parameter of the response object: ``response.static_version``.</div><div class=""> Just include the files the way you used to, for example</div><div class=""> ``</div><div class=""> {{response.files.append(URL(&#x27;static&#x27;,&#x27;layout.css&#x27;))}}</div><div class=""> ``</div><div class=""> and in models set</div><div class="insert">``<span class="highlight"></span></div><div class=""> response.static_version = &#x27;1.2.3&#x27;</div><div class=""> ``:code</div><div class=""> This will rewrite automatically every &quot;/myapp/static/layout.css&quot; url as &quot;/myapp/static/_1.2.3/layout.css&quot;, for every file included in ``response.files``.</div><div class=""> </div><div class=""> Often in production you let the webserver (apache, nginx, etc.) serve the static files. You need to adjust your configuration in such a way that it will &quot;skip&quot; the &quot;_1.2.3/&quot; part.</div><div class=""> </div><div class=""> For example, in Apache, change this:</div><div class=""> ``</div><div class=""> AliasMatch ^/([^/]+)/static/(.*) \</div><div class="">    /home/www-data/web2py/applications/$1/static/$2</div><div class=""> ``</div><div class=""> into this:</div><div class=""> ``</div><div class=""> AliasMatch ^/([^/]+)/static/(?:/_[\d]+\.[\d]+\.[\d]+)?(.*) \</div><div class="">    /home/www-data/web2py/applications/$1/static/$2</div><div class=""> ``</div><div class=""> </div><div class=""> Similarly, in Nginx change this:</div><div class=""> ``</div><div class=""> location ~* /(\w+)/static/ {</div><div class=""> In chapter 8, we will provide an example of how to use the above method to send</div><div class=""> </div><div class=""> The web2py scheduler works very much like the task queue described in the previous sub-section with some differences:</div><div class=""> - It provides a standard mechanism for creating and scheduling tasks.</div><div class=""> - There is not a single background process but a set of workers processes.</div><div class=""> - The job of worker nodes can be monitored because their state, as well as the state of the tasks, is stored in the database.</div><div class=""> - It works without web2py but that is not documented here.</div><div class=""> </div><div class=""> The scheduler does not use cron, although one can use cron @reboot to start the worker nodes.</div><div class=""> </div><div class=""> More information about deploying the scheduler under Linux and Windows is in the Deployment recipes chapter.</div><div class=""> </div><div class=""> In the scheduler, a task is simply a function defined in a model (or in a module and imported by a model). For example:</div><div class=""> </div><div class=""> ``</div><div class=""> def task_add(a,b):</div><div class="">     return a+b</div><div class=""> ``:code</div><div class=""> </div><div class=""> Tasks will always be called in the same environment seen by controllers and therefore they see all the global variables defined in models, including database connections (``db``). Tasks differ from a controller action because they are not associated with an HTTP request and therefore there is no ``request.env``.</div><div class=""> </div><div class="insert">+------</div><div class="insert">+NB: remind to call a db.commit() at the end of every task if it involves inserts/updates to the database. Web2py commits by default at the end of a successful function call but the scheduler doesn&#x27;t</div><div class="insert">+------</div><div class="insert">+</div><div class=""> To enable the scheduler you should put into a model its instantiation.</div><div class=""> The recommended way to enable the scheduler to your app is to create a model file named ``scheduler.py`` and define your function there. After the functions, you can put the following code into the model:</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.scheduler import Scheduler</div><div class=""> scheduler = Scheduler(db)</div><div class=""> ``:code</div><div class=""> </div><div class=""> NB: If your tasks are defined in a module (as opposed to a model) you may have to restart the workers.</div><div class=""> </div><div class=""> The task is scheduled with</div><div class=""> </div><div class=""> ``</div><div class="insert">scheduler.queue_task(<span class="highlight"></span>task_add<span class="highlight"></span>,pvars=dict(a=1,b=2))</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> ##### Parameters</div><div class=""> </div><div class=""> The first argument of the ``Scheduler`` class must be the database to be used by the scheduler to communicate with the workers. This can be the ``db`` of the app or another dedicated ``db``, perhaps one shared by multiple apps. If you use SQLite it&#x27;s recommended to use a separate db from the one used by your app in order to keep the app responsive.</div><div class=""> Once the tasks are defined and the ``Scheduler`` is instantiated, all that is needed to do is to start the workers. You can do that in several ways:</div><div class=""> </div><div class=""> ``</div><div class=""> python web2py.py -K myapp</div><div class=""> ``</div><div class=""> starts a worker for the app ``myapp``. If you want start multiple workers for the same app, you can do so just passing ``myapp,myapp``. You can pass also the ``group_names`` (overriding the one set in your model) with</div><div class=""> </div><div class=""> ``</div><div class=""> python web2py.py -K myapp:group1:group2,myotherapp:group1</div><div class=""> ``</div><div class=""> </div><div class=""> If you have a model called ``scheduler.py`` you can start/stop the workers from web2py&#x27;s default window (the one you use to set the ip address and the port).</div><div class=""> </div><div class="insert">One last nice addition: if you use the embedded webserver, you can start the webserver and the scheduler with just one line of code (this assumes you don&#x27;t want the web2py window popping up, <span class="highlight">else</span> you can use the &quot;Schedulers&quot; menu instead)</div><div class=""> </div><div class=""> ``</div><div class=""> python web2py.py -a yourpass -K myapp -X</div><div class=""> ``</div><div class=""> You can pass the usual parameters (-i, -p, here -a prevents the window from showing up), pass whatever app in the -K parameter and append a -X. The scheduler will run alongside the webserver!</div><div class=""> </div><div class=""> Scheduler&#x27;s complete signature is:</div><div class=""> </div><div class=""> ``</div><div class=""> Scheduler(</div><div class="">     db,</div><div class="">     tasks=None,</div><div class="">     migrate=True,</div><div class="">     worker_name=None,</div><div class="">     group_names=None,</div><div class="">     heartbeat=HEARTBEAT,</div><div class="">     max_empty_runs=0,</div><div class="">     discard_results=False,</div><div class="">     utc_time=False</div><div class=""> )</div><div class=""> ``:code</div><div class=""> </div><div class=""> Let&#x27;s see them in order:</div><div class=""> </div><div class=""> - ``db`` is the database DAL instance were you want the scheduler tables be placed.</div><div class="insert">- ``tasks`` can be a dict. Must be defined if you want to call a function not by his name, i.e. ``tasks=dict(mynameddemo1=<span class="highlight">task_add)`` will let you execute function </span>demo1<span class="highlight"> with ``scheduler.queue_task(&#x27;mynameddemo1&#x27;</span>)`` <span class="highlight">instead of ``scheduler.queue_task</span>(<span class="highlight">&#x27;</span>task_<span class="highlight">add</span>&#x27;)``. If you don&#x27;t pass this parameter, function will be searched in the app environment.</div><div class=""> - ``worker_name`` is None by default. As soon as the worker is started, a worker name is generated as hostname-uuid. If you want to specify that, be sure that it&#x27;s unique.</div><div class=""> - ``group_names`` is by default set to **[main]**. All tasks have a ``group_name`` parameter, set to **main** by default. Workers can only pick up tasks of their assigned group.</div><div class="insert">+</div><div class="insert">+------</div><div class=""> NB: This is useful if you have different workers instances (e.g. on different machines) and you want to assign tasks to a specific worker.</div><div class="insert">+</div><div class=""> NB2: It&#x27;s possible to assign a worker more groups, and they can be also all the same, as</div><div class="insert">+------</div><div class=""> ``[&#x27;mygroup&#x27;,&#x27;mygroup&#x27;]``. Tasks will be distributed taking into consideration that</div><div class=""> a worker with group_names ``[&#x27;mygroup&#x27;,&#x27;mygroup&#x27;]`` is able to process the double of the tasks</div><div class=""> a worker with group_names ``[&#x27;mygroup&#x27;]`` is.</div><div class=""> - ``heartbeat`` is by default set to 3 seconds. This parameter is the one controlling how often a scheduler will check its status on the ``scheduler_worker`` table and see if there are any **ASSIGNED** tasks to itself to process.</div><div class=""> - ``max_empty_runs`` is 0 by default, that means that the worker will continue to process tasks as soon as they are **ASSIGNED**. If you set this to a value of, let&#x27;s say, 10, a worker will die automatically if it&#x27;s **ACTIVE** and no tasks are **ASSIGNED** to it for 10 loops. A loop is when a worker searches for tasks, every 3 seconds (or the set ``heartbeat``)</div><div class=""> - ``discard_results`` is False by default. If set to True, no scheduler_run records will be created.</div><div class="insert">+</div><div class="insert">+------</div><div class="insert">+NB: scheduler_run records will be created as before for **FAILED**, **TIMEOUT** and **STOPPED** tasks&#x27;s statuses.</div><div class="insert">+------</div><div class="insert">+</div><div class=""> - ``utc_time`` is False by default. If you need to coordinate with workers living in different timezones, or don&#x27;t have problems with solar/DST times, supplying datetimes from different countries, etc, you can set this to True. The scheduler will honor the UTC time and work leaving the local time aside. Caveat: you need to schedule tasks with UTC times (for start_time, stop_time, and so on.)</div><div class=""> </div><div class=""> Now we have the infrastructure in place: defined the tasks, told the scheduler about them, started the worker(s). What remains is to actually schedule the tasks</div><div class=""> </div><div class=""> </div><div class=""> ##### Tasks</div><div class=""> Tasks can be scheduled programmatically or via appadmin. In fact, a task is scheduled simply by adding an entry in the table &quot;scheduler_task&quot;, which you can access via appadmin:</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/myapp/appadmin/insert/db/scheduler_task</div><div class=""> ``</div><div class=""> </div><div class=""> The meaning of the fields in this table is obvious. The &quot;args&quot; and &quot;vars&quot;&quot; fields are the values to be passed to the task in JSON format. In the case of the &quot;task_add&quot; above, an example of &quot;args&quot; and &quot;vars&quot; could be:</div><div class=""> </div><div class=""> ``</div><div class=""> args = [3, 4]</div><div class=""> vars = {}</div><div class=""> ``:code</div><div class=""> </div><div class=""> or</div><div class=""> vars = {&#x27;a&#x27;:3, &#x27;b&#x27;:4}</div><div class=""> </div><div class=""> The ``scheduler_task`` table is the one where tasks are organized.</div><div class=""> </div><div class=""> All tasks follow a lifecycle</div><div class=""> </div><div class=""> [[scheduler tasks @///image/ce8edcc3.png center]]</div><div class=""> </div><div class=""> Let&#x27;s go with order. By default, when you send a task to the scheduler, you&#x27;ll want that to be executed. It&#x27;s in **QUEUED** status.</div><div class=""> If you need it to be executed later, use the ``start_time`` parameter (default = now).</div><div class=""> If for some reason you need to be sure that the task don&#x27;t get executed after a certain point in time (maybe a request to a webservice</div><div class=""> that shuts down at 1AM, a mail that needs to be sent not after the working hours, etc...) you can set a ``stop_time`` (default = None) for it.</div><div class=""> If your task is NOT picked up by a worker before stop_time, it will be set as **EXPIRED**.</div><div class=""> Tasks with no stop_time set or picked up **BEFORE** stop_time are **ASSIGNED** to a worker. When a workers picks up them, they become **RUNNING**.</div><div class=""> **RUNNING** tasks may end up:</div><div class=""> - **TIMEOUT** when more than n seconds passed with ``timeout`` parameter (default = 60 seconds)</div><div class=""> - **FAILED** when an exception is detected</div><div class=""> - **COMPLETED** when all went ok</div><div class=""> </div><div class=""> Additionally, you can control how many times a task should be repeated (i.e. you need to aggregate some data at specified intervals). To do so, set the ``repeats``</div><div class=""> parameter (default = 1 time only, 0 = unlimited). You can influence how many seconds should pass between executions with the ``period`` parameter (default = 60 seconds).</div><div class="insert">+</div><div class="insert">+------</div><div class=""> NB: the time is not calculated between the END of the first round and the START of the next, but from the START time of the first round to the START time of the next cycle)</div><div class="insert">+------</div><div class=""> </div><div class=""> Another nice addition, you can set how many times the function can raise an exception (i.e. requesting data from a slow webservice) and be queued again instead of stopping in **FAILED**  status with the parameter ``retry_failed`` (default = 0, -1 = unlimited).</div><div class=""> </div><div class=""> [[task repeats @///image/7d8b85e4.png center]]</div><div class=""> </div><div class=""> Summary: you have</div><div class=""> - ``period`` and ``repeats`` to get an automatically rescheduled function</div><div class=""> - ``timeout`` to be sure that a function doesn&#x27;t exceed a certain amount of time</div><div class=""> - ``retry_failed`` to control how many times the task can &quot;fail&quot;</div><div class=""> - ``start_time`` and ``stop_time`` to schedule a function in a restricted timeframe</div><div class=""> </div><div class="insert">+##### queue_task() and task_status()</div><div class="insert">+- ``scheduler.queue_task(function, pargs=[], pvars={}, **kwargs)`` : accepts a lot of arguments, to make your life easier....</div><div class="insert">+ -- ``function`` : required. This can be a string as ``&#x27;demo2&#x27;`` or directly the function, i.e. you can use ``scheduler.queue_task(demo2)``</div><div class="insert">+ -- ``pargs`` : p stands for &quot;positional&quot;. pargs will accept your args as a list, without the need to jsonify them first.</div><div class="insert">+ ------</div><div class="insert">+ ``scheduler.queue_task(demo1, [1,2])``</div><div class="insert">+ </div><div class="insert">+ does the exact same thing as </div><div class="insert">+</div><div class="insert">+ ``st.validate_and_insert(function_name = &#x27;demo1&#x27;, args=dumps([1,2]))``</div><div class="insert">+</div><div class="insert">+ and in a lot less characters</div><div class="insert">+</div><div class="insert">+ **NB**: if you do ``scheduler.queue_task(demo1, [1,2], args=dumps([2,3]))`` , ``args`` will prevail and the task will be queued with **2,3**</div><div class="insert">+ ------</div><div class="insert">+ -- ``pvars`` : as with ``pargs``, will accept your vars as a dict, without the need to jsonify them first.</div><div class="insert">+ ------</div><div class="insert">+ ``scheduler.queue_task(demo1, [], {&#x27;a&#x27;: 1, &#x27;b&#x27; : 2})`` or ``scheduler.queue_task(demo1, pvars={&#x27;a&#x27;: 1, &#x27;b&#x27; : 2})``</div><div class="insert">+ </div><div class="insert">+ does the exact same thing as</div><div class="insert">+ </div><div class="insert">+ ``st.validate_and_insert(function_name = &#x27;demo1&#x27;, vars=dumps({&#x27;a&#x27;: 1, &#x27;b&#x27; : 2}))``</div><div class="insert">+ </div><div class="insert">+ **NB**:  if you do ``scheduler.queue_task(demo1, None, {&#x27;a&#x27;: 1, &#x27;b&#x27;: 2}, vars=dumps({&#x27;a&#x27;: 2, &#x27;b&#x27; : 3}))`` , ``vars`` will prevail and the task will be queued with **{&#x27;a&#x27;: 2, &#x27;b&#x27; : 3}**</div><div class="insert">+ ------</div><div class="insert">+ -- ``kwargs`` : all other scheduler_task columns can be passed as keywords arguments, e.g. :</div><div class="insert">+  ... ``</div><div class="insert">+       scheduler.queue_task(</div><div class="insert">+          demo1, [1,2], {a: 1, b : 2},</div><div class="insert">+          repeats = 0,</div><div class="insert">+          period = 180,</div><div class="insert">+       ....</div><div class="insert">+      )``:python</div><div class="insert">+</div><div class="insert">+The method returns the result of validate_and_insert, with the ``uuid`` of the task you queued (can be the one you passed or the auto-generated one).</div><div class="insert">+</div><div class="insert">+``&lt;Row {&#x27;errors&#x27;: {}, &#x27;id&#x27;: 1, &#x27;uuid&#x27;: &#x27;08e6433a-cf07-4cea-a4cb-01f16ae5f414&#x27;}&gt;``</div><div class="insert">+ </div><div class="insert">+If there are errors (e.g. you used ``period = &#x27;a&#x27;``), you&#x27;ll get the result of the validation, and id and uuid will be None</div><div class="insert">+</div><div class="insert">+``&lt;Row {&#x27;errors&#x27;: {&#x27;period&#x27;: &#x27;enter an integer greater than or equal to 0&#x27;}, &#x27;id&#x27;: None, &#x27;uuid&#x27;: None}&gt;``</div><div class="insert">+</div><div class=""> </div><div class=""> ##### Results and output</div><div class=""> The table &quot;scheduler_run&quot; stores the status of all running tasks. Each record references a task that has been picked up by a worker.  One task can have multiple runs. For example, a task scheduled to repeat 10 times an hour will probably have 10 runs (unless one fails or they take longer than 1 hour). Beware that if the task has no return values, it is removed from the scheduler_run table as soon as it is finished.</div><div class=""> </div><div class=""> Possible run statuses are:</div><div class=""> </div><div class=""> ``</div><div class=""> RUNNING, COMPLETED, FAILED, TIMEOUT</div><div class=""> ``</div><div class=""> </div><div class=""> If the run is completed, no exceptions are thrown, and there is no task timeout, the run is marked as ``COMPLETED`` and the task is marked as ``QUEUED`` or ``COMPLETED`` depending on whether it is supposed to run again at a later time. The output of the task is serialized in JSON and stored in the run record.</div><div class=""> </div><div class=""> When a ``RUNNING`` task throws an exception, the run is mark as ``FAILED`` and the task is marked as ``FAILED``. The traceback is stored in the run record.</div><div class=""> </div><div class=""> Similarly, when a run exceeds the timeout, it is stopped and marked as ``TIMEOUT``, and the task is marked as ``TIMEOUT``.</div><div class=""> </div><div class=""> In any case, the stdout is captured and also logged into the run record.</div><div class=""> </div><div class=""> Using appadmin, one can check all ``RUNNING`` tasks, the output of ``COMPLETED`` tasks, the error of ``FAILED`` tasks, etc.</div><div class=""> </div><div class=""> Worker fine management is hard. This module tries not to leave behind any platfo</div><div class=""> When you start a worker, you may want later to:</div><div class=""> - kill it &quot;no matter what it&#x27;s doing&quot;</div><div class=""> - kill it only if it&#x27;s not processing tasks</div><div class=""> - put it to sleep</div><div class=""> Maybe you have yet some tasks queued, and you want to save some resources.</div><div class=""> You know you want them processed every hour, so, you&#x27;ll want to:</div><div class=""> - process all queued tasks and die automatically</div><div class=""> All of these things are possible managing ``Scheduler`` parameters or the ``scheduler_worker`` table.</div><div class=""> To be more precise, for started workers you will change the ``status`` value of any worker to influence</div><div class=""> its behavior.</div><div class=""> As tasks, workers can be in some fixed statuses : ACTIVE, DISABLED, TERMINATE or KILLED.</div><div class=""> </div><div class=""> **ACTIVE** and **DISABLED** are &quot;persistent&quot;, while **TERMINATE** or **KILL**, as statuses</div><div class=""> name suggest, are more &quot;commands&quot; than real statuses.</div><div class=""> Hitting ctrl+c is equal to set a worker to **KILL**</div><div class=""> </div><div class=""> [[workers statuses @///image/bd891eed.png center]]</div><div class=""> </div><div class=""> Everything that one can do via appadmin one can do programmatically by inserting and updating records in these tables.</div><div class=""> </div><div class="insert">Anyway, one should not update records relative to ``RUNNING`` tasks as this may create an un-expected behavior. The best practice is to queue tasks using <span class="highlight">the </span>&quot;queue_task&quot;<span class="highlight"> method</span>.</div><div class=""> </div><div class=""> For example:</div><div class=""> </div><div class=""> ``</div><div class=""> scheduler.queue_task(</div><div class="">     function_name=&#x27;task_add&#x27;,</div><div class="">     pargs=[],</div><div class="">     pvars={&#x27;a&#x27;:3,&#x27;b&#x27;:4},</div><div class="">     repeats = 10, # run 10 times</div><div class="">     period = 3600, # every 1h</div><div class="">     timeout = 120, # should take less than 120 seconds</div><div class="">     )</div><div class=""> ``:code</div><div class=""> </div><div class=""> Notice that fields &quot;times_run&quot;, &quot;last_run_time&quot; and &quot;assigned_worker_name&quot; are not provided at schedule time but are filled automatically by the workers.</div><div class=""> </div><div class=""> You can also retrieve the output of completed tasks:</div><div class=""> </div><div class=""> ``</div><div class="insert">completed_runs = db(db.scheduler_run.<span class="highlight">run_</span>status=&#x27;COMPLETED&#x27;).select()</div><div class=""> ``:code</div><div class=""> </div><div class=""> ------</div><div class=""> The scheduler is experimental because it needs more extensive testing and because the table structure may change as more features are added.</div><div class=""> ------</div><div class=""> </div><div class=""> ##### Reporting percentages</div><div class=""> </div><div class=""> A special &quot;word&quot; encountered in the print statements of your functions clear all</div><div class=""> the previous output. That word is ``!clear!``.</div><div class=""> This, coupled with the ``sync_output`` parameter, allows to report percentages</div><div class=""> a breeze. Let&#x27;s see how that works:</div><div class=""> </div><div class=""> ``</div><div class=""> def reporting_percentages():</div><div class="">     time.sleep(5)</div><div class="">     print &#x27;50%&#x27;</div><div class="">     time.sleep(5)</div><div class="">     print &#x27;!clear!100%&#x27;</div><div class="">     return 1</div><div class=""> ``</div><div class=""> </div><div class="insert">The function ``<span class="highlight">r</span>e<span class="highlight">p</span>o<span class="highlight">rting_percentages</span>`` sleeps for 5 seconds, outputs ``50%``.</div><div class=""> Then, it sleeps other 5 seconds and outputs ``100%``. Note that the output in the scheduler_run table is synced every 2 seconds and that the second print statement that contains ``!clear!100%`` gets the ``50%`` output cleared and replaced by ``100%`` only.</div><div class=""> </div><div class=""> ``</div><div class="insert">+scheduler.queue_task(reporting_percentages,</div><div class="insert">+                     sync_output=2)</div><div class=""> ``:code</div></div></div>
    <div class="span6"><div class="diff"><div class=""> ip = &#x27;0.0.0.0&#x27;</div><div class=""> port = 80</div><div class="delete">-interfaces=[(&#x27;0.0.0.0&#x27;,80)]</div><div class="delete">-#interfaces.append((&#x27;0.0.0.0&#x27;,443,&#x27;ssl_private_key.pem&#x27;,&#x27;ssl_certificate.pem&#x27;))</div><div class=""> password = &#x27;&lt;recycle&gt;&#x27;  # ## &lt;recycle&gt; means use the previous password</div><div class=""> pid_filename = &#x27;httpserver.pid&#x27;</div><div class=""> log_filename = &#x27;httpserver.log&#x27;</div><div class=""> profiler_filename = None</div><div class=""> minthreads = None</div><div class=""> maxthreads = None</div><div class=""> server_name = socket.gethostname()</div><div class=""> request_queue_size = 5</div><div class=""> timeout = 30</div><div class=""> shutdown_timeout = 5</div><div class=""> folder = os.getcwd()</div><div class=""> extcron = None</div><div class="delete"><span class="highlight">ru</span>n<span class="highlight"></span>cron = <span class="highlight">Fals</span>e</div><div class=""> ``:code</div><div class=""> </div><div class=""> This file contains the web2py defaults. If you edit this file, you need to import it explicitly with the ``-L`` command-line option. It only works if you run web2py as a Windows Service.</div><div class=""> </div><div class=""> ### Workflow</div><div class=""> </div><div class=""> The web2py workflow is the following:</div><div class=""> - An HTTP requests arrives to the web server (the built-in Rocket server or a different server connected to web2py via WSGI or another adapter). The web server handles each request in its own thread, in parallel.</div><div class=""> - The HTTP request header is parsed and passed to the dispatcher (explained later in this chapter).</div><div class=""> - The dispatcher decides which of the installed application will handle the request and maps the PATH_INFO in the URL into a function call. Each URL corresponds to one function call.</div><div class=""> - Requests for files in the static folder are handled directly, and large files are automatically streamed to the client.</div><div class=""> - Requests for anything but a static file are mapped into an action (i.e. a function in a controller file, in the requested application).</div><div class=""> - Before calling the action, a few things happen: if the request header contains a session cookie for the app, the session object is retrieved; if not, a session id is created (but the session file is not saved until later); an execution environment for the request is created; models are executed in this environment.</div><div class=""> - Finally the controller action is executed in the pre-built environment.</div><div class=""> - If the action returns a string, this is returned to the client (or if the action returns a web2py HTML helper object, it is serialized and returned to the client).</div><div class=""> - If the action returns an iterable, this is used to loop and stream the data to the client.</div><div class=""> - If the action returns a dictionary, web2py tries to locate a view to render the dictionary. The view must have the same name as the action (unless specified otherwise) and the same extension as the requested page (defaults to .html); on failure, web2py may pick up a generic view (if available and if enabled). The view sees every variable defined in the models as well as those in the dictionary returned by the action, but does not see global variables defined in the controller.</div><div class=""> - The entire user code is executed in a single transaction unless specified otherwise.</div><div class=""> - If the user code succeeds, the transaction is committed.</div><div class=""> - If the user code fails, the traceback is stored in a ticket, and a ticket ID is issued to the client. Only the system administrator can search and read the tracebacks in tickets.</div><div class=""> gluon/contrib/AuthorizeNet.py</div><div class=""> ``</div><div class=""> gluon/contrib/DowCommerce.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> **PaymentTech** credit cart processing API:</div><div class=""> </div><div class=""> ``</div><div class=""> gluon/contrib/paymentech.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> **PAM**``PAM``:cite  authentication API created by Chris AtLee:</div><div class=""> ``</div><div class=""> gluon/contrib/pam.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> A Bayesian classifier to populate the database with dummy data for testing purposes:</div><div class=""> ``</div><div class=""> gluon/contrib/populate.py</div><div class=""> ``:code</div><div class=""> </div><div class="delete">A file with API for running on Heroku.com <span class="highlight"></span>``heroku``:inxx<span class="highlight">:</span></div><div class=""> </div><div class=""> ``</div><div class=""> gluon/contrib/heroku.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> A file that allows interaction with the taskbar in windows, when web2py is running as a service:</div><div class=""> ``</div><div class=""> gluon/contrib/taskbar_widget.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> Optional **login_methods** and login_forms to be used for authentication:</div><div class=""> ``</div><div class=""> gluon/contrib/login_methods/__init__.py</div><div class=""> gluon/contrib/login_methods/basic_auth.py</div><div class=""> gluon/contrib/login_methods/browserid_account.py</div><div class=""> gluon/contrib/login_methods/cas_auth.py</div><div class=""> gluon/contrib/login_methods/dropbox_account.py</div><div class=""> gluon/contrib/login_methods/email_auth.py</div><div class=""> gluon/contrib/login_methods/extended_login_form.py</div><div class=""> gluon/contrib/login_methods/gae_google_account.py</div><div class=""> Also notice the ``request.env.wsgi_*`` variables. They are specific to the wsgi</div><div class=""> ``response.menu``:inxx</div><div class=""> ``response.postprocessing``:inxx</div><div class=""> ``response.render``:inxx</div><div class=""> ``response.status``:inxx</div><div class=""> ``response.stream``:inxx</div><div class=""> ``response.subtitle``:inxx</div><div class=""> ``response.title``:inxx</div><div class=""> ``response.toolbar``:inxx</div><div class=""> ``response.view``:inxx</div><div class=""> ``response.delimiters``:inxx</div><div class=""> ``response.js``:inxx</div><div class=""> ``response.write``:inxx</div><div class=""> ``response.include_files``:inxx</div><div class=""> ``response.include_meta``:inxx</div><div class=""> ``response.optimize_css``:inxx</div><div class=""> ``response.optimize_js``:inxx</div><div class=""> ``response._caller``:inxx</div><div class=""> </div><div class=""> ``response`` is another instance of the ``Storage`` class. It contains the following:</div><div class=""> </div><div class="delete">-``response.body``: a ``StringIO`` object into which web2py writes the output page body. NEVER CHANGE THIS VARIABLE.</div><div class="delete">-</div><div class="delete">-``response.cookies``: similar to ``request.cookies``, but while the latter contains the cookies sent from the client to the server, the former contains cookies sent by the server to the client. The session cookie is handled automatically.</div><div class="delete">-</div><div class="delete">-``response.download(request, db)``: a method used to implement the controller function that allows downloading of uploaded files. ``request.download`` expects the last ``arg`` in ``request.args`` to be the encoded filename (i.e., the filename generated at upload time and stored in the upload field). It extracts the upload field name and table name as well as the original filename from the encoded filename. ``response.download`` takes two optional arguments: ``chunk_size`` sets the size in bytes for chunked streaming (defaults to 64K), and ``attachments`` determines whether the downloaded file should be treated as an attachment or not (default to ``True``). Note, ``response.download`` is specifically for downloading files associated with ``db`` upload fields. Use ``response.stream`` (see below) for other types of file downloads and streaming. Also, note that it is not necessary to use ``response.download`` to access files uploaded to the /static folder -- static files can (and generally should) be accessed directly via URL (e.g., /app/static/files/myfile.pdf).</div><div class="delete">-</div><div class="delete">-``response.files``: a list of .css, .js, coffee, and .less files required by the page. They will automatically be linked in the head of the standard &quot;layout.html&quot; via the included &quot;web2py_ajax.html&quot;. To include a new CSS, JS, COFFEE, or LESS file, just append it to this list. It will handle duplicates. The order is significant.</div><div class="delete">-</div><div class="delete">-``response.include_files()`` generates html head tags to includes all ``response.files`` (used in &quot;views/web2py_ajax.html&quot;).</div><div class="delete">-</div><div class="delete">-``response.flash``: optional parameter that may be included in the views. Normally used to notify the user about something that happened.</div><div class="delete">-</div><div class="delete">-``response.headers``: a ``dict`` for HTTP response headers. Web2py sets some headers by default, including &quot;Content-Length&quot;, &quot;Content-Type&quot;, and &quot;X-Powered-By&quot; (set equal to web2py). Web2py also sets the &quot;Cache-Control&quot;, &quot;Expires&quot;, and &quot;Pragma&quot; headers to prevent client-side caching, except for static file requests, for which client-side caching is enabled. The headers that web2py sets can be overwritten or removed, and new headers can be added (e.g., ``response.headers[&#x27;Cache-Control&#x27;] = &#x27;private&#x27;``). You can remove a header removing its key from the response.headers dict, e.g.``del response.headers[&#x27;Custom-Header&#x27;]``, however web2py&#x27;s default headers will be re-added just before returning the response. To avoid this behavior, just set the header value to None, e.g. to remove the default Content-Type header, ``response.headers[&#x27;Content-Type&#x27;] = None``</div><div class="delete">-</div><div class="delete">-``response.menu``: optional parameter that may be included in the views, normally used to pass a navigation menu tree to the view. It can be rendered by the MENU helper.</div><div class="delete">-</div><div class="delete">-</div><div class="delete">-``response.meta``: a storage object (like a dict) that contains optional meta information like ``response.meta.author``, ``.description``, and/or ``.keywords``. The content of each meta variable is automatically placed in the proper ``META`` tag by the code in &quot;views/web2py_ajax.html&quot;, which is included by default in &quot;views/layout.html&quot;.</div><div class="delete">-</div><div class="delete">-``response.include_meta()`` generates a string that includes all ``response.meta`` headers serialized (used in &quot;views/web2py_ajax.html&quot;).</div><div class="delete">-</div><div class="delete">-``response.postprocessing``: this is a list of functions, empty by default. These functions are used to filter the response object at the output of an action, before the output is rendered by the view. It can be used to implement support for other template languages.</div><div class="delete">-</div><div class="delete">-``response.render(view, vars)``: a method used to call the view explicitly inside the controller. ``view`` is an optional parameter which is the name of the view file, ``vars`` is a dictionary of named values passed to the view.</div><div class="delete">-</div><div class="delete">-``response.session_file``: file stream containing the session.</div><div class="delete">-</div><div class="delete">-``response.session_file_name``: name of the file where the session will be saved.</div><div class="delete">-</div><div class="delete">-``response.session_id``: the id of the current session. It is determined automatically. NEVER CHANGE THIS VARIABLE.</div><div class="delete">-</div><div class="delete">-``response.session_id_name``: the name of the session cookie for this application. NEVER CHANGE THIS VARIABLE.</div><div class="delete">-</div><div class="delete">-``response.status``: the HTTP status code integer to be passed to the response. Default is 200 (OK).</div><div class="delete">-</div><div class="delete">-``response.stream(file, chunk_size, request=request, attachment=False, filename=None, headers=None)``: when a controller returns it, web2py streams the file content back to the client in blocks of size ``chunk_size``. The ``request`` parameter is required to use the chunk start in the HTTP header. ``file`` should be a file path (for backward compatibility, it can also be an open file object, but this is not recommended). As noted above, ``response.download`` should be used to retrieve files stored via an upload field. ``response.stream`` can be used in other cases, such as returning a temporary file or StringIO object created by the controller. If ``attachment`` is True, the Content-Disposition header will be set to &quot;attachment&quot;, and if ``filename`` is also provided, it will be added to the Content-Disposition header as well (but only when ``attachment`` is True). If not already included in ``response.headers``, the following response headers will be set automatically: Content-Type, Content-Length, Cache-Control, Pragma, and Last-Modified (the latter three are set to allow browser caching of the file). To override any of these automatic header settings, simply set them in ``response.headers`` before calling ``response.stream``.</div><div class="delete">-</div><div class="delete">-``response.subtitle``: optional parameter that may be included in the views. It should contain the subtitle of the page.</div><div class="delete">-</div><div class="delete">-``response.title``: optional parameter that may be included in the views. It should contain the title of the page and should be rendered by the HTML title TAG in the header.</div><div class="delete">-</div><div class="delete">-``response.toolbar``: a function that allows you embed a toolbar into page form debugging purposes ``{{=response.toolbar()}}``. The toolbar displays request, response, session variables and database access time for each query.</div><div class="delete">-</div><div class="delete">-``response._vars``: this variable is accessible only in a view, not in the action. It contains the value returned by the action to the view.</div><div class="delete">-</div><div class="delete">-``response._caller``: this is a function that wraps all action calls. It defaults to the identity function, but it can be modifed in order to catch special types of exception to do extra logging;</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-response._caller = lambda f: f()</div><div class="delete">-``</div><div class="delete">-</div><div class="delete">-``response.optimize_css``: if can be set to &quot;concat,minify,inline&quot; to concatenate, minify and inline the CSS files included by web2py.</div><div class="delete">-</div><div class="delete">-``response.optimize_js``: if can be set to &quot;concat,minify,inline&quot; to concatenate, minify and inline the JavaScript files included by web2py.</div><div class="delete">-</div><div class="delete">-``response.view``: the name of the view template that must render the page. This is set by default to:</div><div class="delete">-``</div><div class="delete">-&quot;%s/%s.%s&quot; % (request.controller, request.function, request.extension)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-or, if the above file cannot be located, to</div><div class="delete">-``</div><div class="delete">-&quot;generic.%s&quot; % (request.extension)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Change the value of this variable to modify the view file associated with a particular action.</div><div class="delete">-</div><div class="delete">-``response.delimiters`` defaults to ``(&#x27;{{&#x27;,&#x27;}}&#x27;)``. It allows you to change the delimiter of code embedded in views.</div><div class="delete">-</div><div class="delete">-``response.xmlrpc(request, methods)``: when a controller returns it, this function exposes the methods via XML-RPC``xmlrpc``:cite . This function is deprecated since a better mechanism is available and described in Chapter 10.</div><div class="delete">-</div><div class="delete">-``response.write(text)``: a method to write text into the output page body.</div><div class="delete">-</div><div class="delete">-``response.js`` can contain Javascript code. This code will be executed if and only if the response is received by a web2py component as discussed in Chapter 12.</div><div class=""> </div><div class=""> Since ``response`` is a ``gluon.storage.Storage`` object, it can be used to store other attributes that you may want to pass to the view. While there is no technical restriction, our recommendation is to store only variables that are to be rendered by all pages in the overall layout (&quot;layout.html&quot;).</div><div class=""> </div><div class=""> Anyway, we strongly suggest to stick to the variables listed here:</div><div class=""> ``</div><div class=""> response.title</div><div class=""> response.subtitle</div><div class=""> response.flash</div><div class=""> response.menu</div><div class=""> response.meta.author</div><div class=""> response.meta.description</div><div class=""> response.meta.keywords</div><div class=""> response.meta.*</div><div class=""> ``:code</div><div class=""> </div><div class=""> because this will make it easier for you to replace the standard &quot;layout.html&quot; file that comes with web2py with another layout file, one that uses the same set of variables.</div><div class=""> </div><div class=""> Old versions of web2py user ``response.author`` instead of ``response.meta.author`` and similar for the other meta attributes.</div><div class=""> </div><div class=""> ### ``session``</div><div class=""> If you want to serve &quot;/myapp/static/layout.css&quot; with the cache headers, you just</div><div class=""> </div><div class=""> Notice that the URL starts with &quot;/myapp/static/&quot;, followed by a version number composed by an underscore and 3 integers separated by a period (as described in [[SemVer http://semver.org/]]), then followed by the filename. Also notice that you do not have to create a &quot;_1.2.3/&quot; folder.</div><div class=""> </div><div class=""> Every time the static file is requested with a version in the url, it will be served with &quot;far in the future&quot; cache headers, specifically:</div><div class=""> ``</div><div class=""> Cache-Control : max-age=315360000</div><div class=""> Expires: Thu, 31 Dec 2037 23:59:59 GMT</div><div class=""> ``</div><div class=""> This means that the browser will fetch those file only once, and they will be saved &quot;forever&quot; in the browser&#x27;s cache.</div><div class=""> </div><div class=""> Every time the &quot;_1.2.3/filename&quot; is requested, web2py will remove the version part from the path and serve your file with far in the future headers so they will be cached forever. If you changed the version number in the URL, this tricks the browser into thinking it is requesting a different file, and the file is fetched again.</div><div class=""> </div><div class=""> You can use &quot;_1.2.3&quot;, &quot;_0.0.0&quot;, &quot;_999.888.888&quot;, as long as the version starts with underscore followed by three numbers separated by period.</div><div class=""> </div><div class=""> When in development, you can use ``response.files.append(...)`` to link the static URLs of static files. In this case you can include the &quot;_1.2.3/&quot; part manually, or you take advantage of a new parameter of the response object: ``response.static_version``.</div><div class=""> Just include the files the way you used to, for example</div><div class=""> ``</div><div class=""> {{response.files.append(URL(&#x27;static&#x27;,&#x27;layout.css&#x27;))}}</div><div class=""> ``</div><div class=""> and in models set</div><div class="delete">``<span class="highlight">:code</span></div><div class=""> response.static_version = &#x27;1.2.3&#x27;</div><div class=""> ``:code</div><div class=""> This will rewrite automatically every &quot;/myapp/static/layout.css&quot; url as &quot;/myapp/static/_1.2.3/layout.css&quot;, for every file included in ``response.files``.</div><div class=""> </div><div class=""> Often in production you let the webserver (apache, nginx, etc.) serve the static files. You need to adjust your configuration in such a way that it will &quot;skip&quot; the &quot;_1.2.3/&quot; part.</div><div class=""> </div><div class=""> For example, in Apache, change this:</div><div class=""> ``</div><div class=""> AliasMatch ^/([^/]+)/static/(.*) \</div><div class="">    /home/www-data/web2py/applications/$1/static/$2</div><div class=""> ``</div><div class=""> into this:</div><div class=""> ``</div><div class=""> AliasMatch ^/([^/]+)/static/(?:/_[\d]+\.[\d]+\.[\d]+)?(.*) \</div><div class="">    /home/www-data/web2py/applications/$1/static/$2</div><div class=""> ``</div><div class=""> </div><div class=""> Similarly, in Nginx change this:</div><div class=""> ``</div><div class=""> location ~* /(\w+)/static/ {</div><div class=""> In chapter 8, we will provide an example of how to use the above method to send</div><div class=""> </div><div class=""> The web2py scheduler works very much like the task queue described in the previous sub-section with some differences:</div><div class=""> - It provides a standard mechanism for creating and scheduling tasks.</div><div class=""> - There is not a single background process but a set of workers processes.</div><div class=""> - The job of worker nodes can be monitored because their state, as well as the state of the tasks, is stored in the database.</div><div class=""> - It works without web2py but that is not documented here.</div><div class=""> </div><div class=""> The scheduler does not use cron, although one can use cron @reboot to start the worker nodes.</div><div class=""> </div><div class=""> More information about deploying the scheduler under Linux and Windows is in the Deployment recipes chapter.</div><div class=""> </div><div class=""> In the scheduler, a task is simply a function defined in a model (or in a module and imported by a model). For example:</div><div class=""> </div><div class=""> ``</div><div class=""> def task_add(a,b):</div><div class="">     return a+b</div><div class=""> ``:code</div><div class=""> </div><div class=""> Tasks will always be called in the same environment seen by controllers and therefore they see all the global variables defined in models, including database connections (``db``). Tasks differ from a controller action because they are not associated with an HTTP request and therefore there is no ``request.env``.</div><div class=""> </div><div class=""> To enable the scheduler you should put into a model its instantiation.</div><div class=""> The recommended way to enable the scheduler to your app is to create a model file named ``scheduler.py`` and define your function there. After the functions, you can put the following code into the model:</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.scheduler import Scheduler</div><div class=""> scheduler = Scheduler(db)</div><div class=""> ``:code</div><div class=""> </div><div class=""> NB: If your tasks are defined in a module (as opposed to a model) you may have to restart the workers.</div><div class=""> </div><div class=""> The task is scheduled with</div><div class=""> </div><div class=""> ``</div><div class="delete">scheduler.queue_task(<span class="highlight">&#x27;</span>task_add<span class="highlight">&#x27;</span>,pvars=dict(a=1,b=2))</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> ##### Parameters</div><div class=""> </div><div class=""> The first argument of the ``Scheduler`` class must be the database to be used by the scheduler to communicate with the workers. This can be the ``db`` of the app or another dedicated ``db``, perhaps one shared by multiple apps. If you use SQLite it&#x27;s recommended to use a separate db from the one used by your app in order to keep the app responsive.</div><div class=""> Once the tasks are defined and the ``Scheduler`` is instantiated, all that is needed to do is to start the workers. You can do that in several ways:</div><div class=""> </div><div class=""> ``</div><div class=""> python web2py.py -K myapp</div><div class=""> ``</div><div class=""> starts a worker for the app ``myapp``. If you want start multiple workers for the same app, you can do so just passing ``myapp,myapp``. You can pass also the ``group_names`` (overriding the one set in your model) with</div><div class=""> </div><div class=""> ``</div><div class=""> python web2py.py -K myapp:group1:group2,myotherapp:group1</div><div class=""> ``</div><div class=""> </div><div class=""> If you have a model called ``scheduler.py`` you can start/stop the workers from web2py&#x27;s default window (the one you use to set the ip address and the port).</div><div class=""> </div><div class="delete">One last nice addition: if you use the embedded webserver, you can start the webserver and the scheduler with just one line of code (this assumes you don&#x27;t want the web2py window popping up, <span class="highlight">or</span> you can use the &quot;Schedulers&quot; menu instead)</div><div class=""> </div><div class=""> ``</div><div class=""> python web2py.py -a yourpass -K myapp -X</div><div class=""> ``</div><div class=""> You can pass the usual parameters (-i, -p, here -a prevents the window from showing up), pass whatever app in the -K parameter and append a -X. The scheduler will run alongside the webserver!</div><div class=""> </div><div class=""> Scheduler&#x27;s complete signature is:</div><div class=""> </div><div class=""> ``</div><div class=""> Scheduler(</div><div class="">     db,</div><div class="">     tasks=None,</div><div class="">     migrate=True,</div><div class="">     worker_name=None,</div><div class="">     group_names=None,</div><div class="">     heartbeat=HEARTBEAT,</div><div class="">     max_empty_runs=0,</div><div class="">     discard_results=False,</div><div class="">     utc_time=False</div><div class=""> )</div><div class=""> ``:code</div><div class=""> </div><div class=""> Let&#x27;s see them in order:</div><div class=""> </div><div class=""> - ``db`` is the database DAL instance were you want the scheduler tables be placed.</div><div class="delete">- ``tasks`` can be a dict. Must be defined if you want to call a function not by his name, i.e. ``tasks=dict(mynameddemo1=<span class="highlight"></span>demo1<span class="highlight"></span>)`` <span class="highlight">will let you execute function demo1 with ``st.insert</span>(<span class="highlight"></span>task_<span class="highlight">name=&#x27;mytask&#x27;, function_name=&#x27;mynameddemo1&#x27;)`` or ``st.insert(task_name=&#x27;mytask&#x27;, function_name=&#x27;demo1</span>&#x27;)``. If you don&#x27;t pass this parameter, function will be searched in the app environment.</div><div class=""> - ``worker_name`` is None by default. As soon as the worker is started, a worker name is generated as hostname-uuid. If you want to specify that, be sure that it&#x27;s unique.</div><div class=""> - ``group_names`` is by default set to **[main]**. All tasks have a ``group_name`` parameter, set to **main** by default. Workers can only pick up tasks of their assigned group.</div><div class=""> NB: This is useful if you have different workers instances (e.g. on different machines) and you want to assign tasks to a specific worker.</div><div class=""> NB2: It&#x27;s possible to assign a worker more groups, and they can be also all the same, as</div><div class=""> ``[&#x27;mygroup&#x27;,&#x27;mygroup&#x27;]``. Tasks will be distributed taking into consideration that</div><div class=""> a worker with group_names ``[&#x27;mygroup&#x27;,&#x27;mygroup&#x27;]`` is able to process the double of the tasks</div><div class=""> a worker with group_names ``[&#x27;mygroup&#x27;]`` is.</div><div class=""> - ``heartbeat`` is by default set to 3 seconds. This parameter is the one controlling how often a scheduler will check its status on the ``scheduler_worker`` table and see if there are any **ASSIGNED** tasks to itself to process.</div><div class=""> - ``max_empty_runs`` is 0 by default, that means that the worker will continue to process tasks as soon as they are **ASSIGNED**. If you set this to a value of, let&#x27;s say, 10, a worker will die automatically if it&#x27;s **ACTIVE** and no tasks are **ASSIGNED** to it for 10 loops. A loop is when a worker searches for tasks, every 3 seconds (or the set ``heartbeat``)</div><div class=""> - ``discard_results`` is False by default. If set to True, no scheduler_run records will be created.</div><div class="delete">-NB: scheduler_run records will be created as before for **FAILED**, **TIMEOUT** and</div><div class="delete">-**STOPPED** tasks&#x27;s statuses.</div><div class=""> - ``utc_time`` is False by default. If you need to coordinate with workers living in different timezones, or don&#x27;t have problems with solar/DST times, supplying datetimes from different countries, etc, you can set this to True. The scheduler will honor the UTC time and work leaving the local time aside. Caveat: you need to schedule tasks with UTC times (for start_time, stop_time, and so on.)</div><div class=""> </div><div class=""> Now we have the infrastructure in place: defined the tasks, told the scheduler about them, started the worker(s). What remains is to actually schedule the tasks</div><div class=""> </div><div class=""> </div><div class=""> ##### Tasks</div><div class=""> Tasks can be scheduled programmatically or via appadmin. In fact, a task is scheduled simply by adding an entry in the table &quot;scheduler_task&quot;, which you can access via appadmin:</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/myapp/appadmin/insert/db/scheduler_task</div><div class=""> ``</div><div class=""> </div><div class=""> The meaning of the fields in this table is obvious. The &quot;args&quot; and &quot;vars&quot;&quot; fields are the values to be passed to the task in JSON format. In the case of the &quot;task_add&quot; above, an example of &quot;args&quot; and &quot;vars&quot; could be:</div><div class=""> </div><div class=""> ``</div><div class=""> args = [3, 4]</div><div class=""> vars = {}</div><div class=""> ``:code</div><div class=""> </div><div class=""> or</div><div class=""> vars = {&#x27;a&#x27;:3, &#x27;b&#x27;:4}</div><div class=""> </div><div class=""> The ``scheduler_task`` table is the one where tasks are organized.</div><div class=""> </div><div class=""> All tasks follow a lifecycle</div><div class=""> </div><div class=""> [[scheduler tasks @///image/ce8edcc3.png center]]</div><div class=""> </div><div class=""> Let&#x27;s go with order. By default, when you send a task to the scheduler, you&#x27;ll want that to be executed. It&#x27;s in **QUEUED** status.</div><div class=""> If you need it to be executed later, use the ``start_time`` parameter (default = now).</div><div class=""> If for some reason you need to be sure that the task don&#x27;t get executed after a certain point in time (maybe a request to a webservice</div><div class=""> that shuts down at 1AM, a mail that needs to be sent not after the working hours, etc...) you can set a ``stop_time`` (default = None) for it.</div><div class=""> If your task is NOT picked up by a worker before stop_time, it will be set as **EXPIRED**.</div><div class=""> Tasks with no stop_time set or picked up **BEFORE** stop_time are **ASSIGNED** to a worker. When a workers picks up them, they become **RUNNING**.</div><div class=""> **RUNNING** tasks may end up:</div><div class=""> - **TIMEOUT** when more than n seconds passed with ``timeout`` parameter (default = 60 seconds)</div><div class=""> - **FAILED** when an exception is detected</div><div class=""> - **COMPLETED** when all went ok</div><div class=""> </div><div class=""> Additionally, you can control how many times a task should be repeated (i.e. you need to aggregate some data at specified intervals). To do so, set the ``repeats``</div><div class=""> parameter (default = 1 time only, 0 = unlimited). You can influence how many seconds should pass between executions with the ``period`` parameter (default = 60 seconds).</div><div class=""> NB: the time is not calculated between the END of the first round and the START of the next, but from the START time of the first round to the START time of the next cycle)</div><div class=""> </div><div class=""> Another nice addition, you can set how many times the function can raise an exception (i.e. requesting data from a slow webservice) and be queued again instead of stopping in **FAILED**  status with the parameter ``retry_failed`` (default = 0, -1 = unlimited).</div><div class=""> </div><div class=""> [[task repeats @///image/7d8b85e4.png center]]</div><div class=""> </div><div class=""> Summary: you have</div><div class=""> - ``period`` and ``repeats`` to get an automatically rescheduled function</div><div class=""> - ``timeout`` to be sure that a function doesn&#x27;t exceed a certain amount of time</div><div class=""> - ``retry_failed`` to control how many times the task can &quot;fail&quot;</div><div class=""> - ``start_time`` and ``stop_time`` to schedule a function in a restricted timeframe</div><div class=""> </div><div class=""> </div><div class=""> ##### Results and output</div><div class=""> The table &quot;scheduler_run&quot; stores the status of all running tasks. Each record references a task that has been picked up by a worker.  One task can have multiple runs. For example, a task scheduled to repeat 10 times an hour will probably have 10 runs (unless one fails or they take longer than 1 hour). Beware that if the task has no return values, it is removed from the scheduler_run table as soon as it is finished.</div><div class=""> </div><div class=""> Possible run statuses are:</div><div class=""> </div><div class=""> ``</div><div class=""> RUNNING, COMPLETED, FAILED, TIMEOUT</div><div class=""> ``</div><div class=""> </div><div class=""> If the run is completed, no exceptions are thrown, and there is no task timeout, the run is marked as ``COMPLETED`` and the task is marked as ``QUEUED`` or ``COMPLETED`` depending on whether it is supposed to run again at a later time. The output of the task is serialized in JSON and stored in the run record.</div><div class=""> </div><div class=""> When a ``RUNNING`` task throws an exception, the run is mark as ``FAILED`` and the task is marked as ``FAILED``. The traceback is stored in the run record.</div><div class=""> </div><div class=""> Similarly, when a run exceeds the timeout, it is stopped and marked as ``TIMEOUT``, and the task is marked as ``TIMEOUT``.</div><div class=""> </div><div class=""> In any case, the stdout is captured and also logged into the run record.</div><div class=""> </div><div class=""> Using appadmin, one can check all ``RUNNING`` tasks, the output of ``COMPLETED`` tasks, the error of ``FAILED`` tasks, etc.</div><div class=""> </div><div class=""> Worker fine management is hard. This module tries not to leave behind any platfo</div><div class=""> When you start a worker, you may want later to:</div><div class=""> - kill it &quot;no matter what it&#x27;s doing&quot;</div><div class=""> - kill it only if it&#x27;s not processing tasks</div><div class=""> - put it to sleep</div><div class=""> Maybe you have yet some tasks queued, and you want to save some resources.</div><div class=""> You know you want them processed every hour, so, you&#x27;ll want to:</div><div class=""> - process all queued tasks and die automatically</div><div class=""> All of these things are possible managing ``Scheduler`` parameters or the ``scheduler_worker`` table.</div><div class=""> To be more precise, for started workers you will change the ``status`` value of any worker to influence</div><div class=""> its behavior.</div><div class=""> As tasks, workers can be in some fixed statuses : ACTIVE, DISABLED, TERMINATE or KILLED.</div><div class=""> </div><div class=""> **ACTIVE** and **DISABLED** are &quot;persistent&quot;, while **TERMINATE** or **KILL**, as statuses</div><div class=""> name suggest, are more &quot;commands&quot; than real statuses.</div><div class=""> Hitting ctrl+c is equal to set a worker to **KILL**</div><div class=""> </div><div class=""> [[workers statuses @///image/bd891eed.png center]]</div><div class=""> </div><div class=""> Everything that one can do via appadmin one can do programmatically by inserting and updating records in these tables.</div><div class=""> </div><div class="delete">Anyway, one should not update records relative to ``RUNNING`` tasks as this may create an un-expected behavior. The best practice is to queue tasks using <span class="highlight"></span>&quot;queue_task&quot;<span class="highlight"></span>.</div><div class=""> </div><div class=""> For example:</div><div class=""> </div><div class=""> ``</div><div class=""> scheduler.queue_task(</div><div class="">     function_name=&#x27;task_add&#x27;,</div><div class="">     pargs=[],</div><div class="">     pvars={&#x27;a&#x27;:3,&#x27;b&#x27;:4},</div><div class="">     repeats = 10, # run 10 times</div><div class="">     period = 3600, # every 1h</div><div class="">     timeout = 120, # should take less than 120 seconds</div><div class="">     )</div><div class=""> ``:code</div><div class=""> </div><div class=""> Notice that fields &quot;times_run&quot;, &quot;last_run_time&quot; and &quot;assigned_worker_name&quot; are not provided at schedule time but are filled automatically by the workers.</div><div class=""> </div><div class=""> You can also retrieve the output of completed tasks:</div><div class=""> </div><div class=""> ``</div><div class="delete">completed_runs = db(db.scheduler_run.<span class="highlight"></span>status=&#x27;COMPLETED&#x27;).select()</div><div class=""> ``:code</div><div class=""> </div><div class=""> ------</div><div class=""> The scheduler is experimental because it needs more extensive testing and because the table structure may change as more features are added.</div><div class=""> ------</div><div class=""> </div><div class=""> ##### Reporting percentages</div><div class=""> </div><div class=""> A special &quot;word&quot; encountered in the print statements of your functions clear all</div><div class=""> the previous output. That word is ``!clear!``.</div><div class=""> This, coupled with the ``sync_output`` parameter, allows to report percentages</div><div class=""> a breeze. Let&#x27;s see how that works:</div><div class=""> </div><div class=""> ``</div><div class=""> def reporting_percentages():</div><div class="">     time.sleep(5)</div><div class="">     print &#x27;50%&#x27;</div><div class="">     time.sleep(5)</div><div class="">     print &#x27;!clear!100%&#x27;</div><div class="">     return 1</div><div class=""> ``</div><div class=""> </div><div class="delete">The function ``<span class="highlight">d</span>e<span class="highlight">m</span>o<span class="highlight">6</span>`` sleeps for 5 seconds, outputs ``50%``.</div><div class=""> Then, it sleeps other 5 seconds and outputs ``100%``. Note that the output in the scheduler_run table is synced every 2 seconds and that the second print statement that contains ``!clear!100%`` gets the ``50%`` output cleared and replaced by ``100%`` only.</div><div class=""> </div><div class=""> ``</div><div class="delete">-scheduler.queue_task(task_name=&#x27;reporting_percentages&#x27;,</div><div class="delete">-                     function_name=&#x27;demo6&#x27;, sync_output=2)</div><div class=""> ``:code</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/f2fd41dd2a0d4bf68f5cd4f0989fb32bdc35eac5">f2fd41d</a><ul><li>Date : 2012-12-31</li><li>spell check of diffs, thanks Joanthan</li></ul></li></ul>
<div class="row-fluid" id="com_f2fd41dd2a0d4bf68f5cd4f0989fb32bdc35eac5">
    <div class="span6"><div class="diff"><div class="insert">``response.headers``: a ``dict`` for HTTP response headers. Web2py sets some headers by default, including &quot;Content-Length&quot;, &quot;Content-Type&quot;, and &quot;X-Powered-By&quot; (set equal to web2py). Web2py also sets the &quot;Cache-Control&quot;, &quot;Expires&quot;, and &quot;Pragma&quot; headers to prevent client-side caching, except for static file requests, for which client-side caching is enabled. The headers that web2py sets can be overwritten or removed, and new headers can be added (e.g., ``response.headers[&#x27;Cache-Control&#x27;] = &#x27;private&#x27;``). You can remove a header removing its key from the response.headers dict, e.g.``del response.headers[&#x27;Custom-Header&#x27;]``, however web2py&#x27;s default headers will be re-added just before returning the response. To avoid this behavio<span class="highlight"></span>r, just set the header value to None, e.g. to remove the default Content-Type header, ``response.headers[&#x27;Content-Type&#x27;] = None``</div><div class=""> </div><div class=""> ``response.menu``: optional parameter that may be included in the views, normally used to pass a navigation menu tree to the view. It can be rendered by the MENU helper.</div><div class=""> </div><div class=""> </div><div class=""> ``response.meta``: a storage object (like a dict) that contains optional meta information like ``response.meta.author``, ``.description``, and/or ``.keywords``. The content of each meta variable is automatically placed in the proper ``META`` tag by the code in &quot;views/web2py_ajax.html&quot;, which is included by default in &quot;views/layout.html&quot;.</div><div class=""> </div><div class=""> ``response.include_meta()`` generates a string that includes all ``response.meta`` headers serialized (used in &quot;views/web2py_ajax.html&quot;).</div><div class=""> </div><div class=""> ``response.postprocessing``: this is a list of functions, empty by default. These functions are used to filter the response object at the output of an action, before the output is rendered by the view. It can be used to implement support for other template languages.</div><div class=""> </div><div class=""> ``response.render(view, vars)``: a method used to call the view explicitly inside the controller. ``view`` is an optional parameter which is the name of the view file, ``vars`` is a dictionary of named values passed to the view.</div><div class=""> </div><div class=""> ``response.session_file``: file stream containing the session.</div><div class=""> </div><div class=""> ``response.session_file_name``: name of the file where the session will be saved.</div><div class=""> </div><div class=""> ``response.session_id``: the id of the current session. It is determined automatically. NEVER CHANGE THIS VARIABLE.</div><div class=""> </div><div class=""> ``response.session_id_name``: the name of the session cookie for this application. NEVER CHANGE THIS VARIABLE.</div><div class=""> </div><div class=""> ``response.status``: the HTTP status code integer to be passed to the response. Default is 200 (OK).</div><div class=""> </div><div class=""> ``response.stream(file, chunk_size, request=request, attachment=False, filename=None, headers=None)``: when a controller returns it, web2py streams the file content back to the client in blocks of size ``chunk_size``. The ``request`` parameter is required to use the chunk start in the HTTP header. ``file`` should be a file path (for backward compatibility, it can also be an open file object, but this is not recommended). As noted above, ``response.download`` should be used to retrieve files stored via an upload field. ``response.stream`` can be used in other cases, such as returning a temporary file or StringIO object created by the controller. If ``attachment`` is True, the Content-Disposition header will be set to &quot;attachment&quot;, and if ``filename`` is also provided, it will be added to the Content-Disposition header as well (but only when ``attachment`` is True). If not already included in ``response.headers``, the following response headers will be set automatically: Content-Type, Content-Length, Cache-Control, Pragma, and Last-Modified (the latter three are set to allow browser caching of the file). To override any of these automatic header settings, simply set them in ``response.headers`` before calling ``response.stream``.</div><div class=""> </div><div class=""> ``response.subtitle``: optional parameter that may be included in the views. It should contain the subtitle of the page.</div><div class=""> </div><div class=""> ``response.title``: optional parameter that may be included in the views. It should contain the title of the page and should be rendered by the HTML title TAG in the header.</div><div class=""> </div><div class=""> ``response.toolbar``: a function that allows you embed a toolbar into page form debugging purposes ``{{=response.toolbar()}}``. The toolbar displays request, response, session variables and database access time for each query.</div><div class=""> </div><div class=""> ``response._vars``: this variable is accessible only in a view, not in the action. It contains the value returned by the action to the view.</div><div class=""> </div><div class="insert">``response._caller``: this is a function that wraps all action calls. It defaults to the iden<span class="highlight">t</span>ity function<span class="highlight">,</span> but it can be modifed in order to catch special types of exception <span class="highlight">t</span>o<span class="highlight"></span> do extra logging;</div><div class=""> </div><div class=""> ``</div><div class=""> response._caller = lambda f: f()</div><div class=""> ``</div><div class=""> </div><div class=""> ``response.optimize_css``: if can be set to &quot;concat,minify,inline&quot; to concatenate, minify and inline the CSS files included by web2py.</div><div class=""> </div><div class=""> ``response.optimize_js``: if can be set to &quot;concat,minify,inline&quot; to concatenate, minify and inline the JavaScript files included by web2py.</div><div class=""> </div><div class=""> ``response.view``: the name of the view template that must render the page. This is set by default to:</div><div class=""> ``</div><div class=""> &quot;%s/%s.%s&quot; % (request.controller, request.function, request.extension)</div><div class=""> ``:code</div><div class=""> </div><div class=""> or, if the above file cannot be located, to</div><div class=""> ``</div><div class=""> &quot;generic.%s&quot; % (request.extension)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Change the value of this variable to modify the view file associated with a particular action.</div><div class=""> db.define_table(&#x27;web2py_session&#x27;,</div><div class="">                  Field(&#x27;created_datetime&#x27;, &#x27;datetime&#x27;, default=now),</div><div class="">                  Field(&#x27;modified_datetime&#x27;, &#x27;datetime&#x27;),</div><div class="">                  Field(&#x27;unique_key&#x27;),</div><div class="">                  Field(&#x27;session_data&#x27;, &#x27;text&#x27;))</div><div class=""> ``:code</div><div class=""> </div><div class=""> and stores cPickled sessions in the ``session_data`` field.</div><div class=""> </div><div class=""> The option ``masterapp=None``, by default, tells web2py to try to retrieve an existing session for the application with name in ``request.application``, in the running application.</div><div class=""> </div><div class=""> If you want two or more applications to share sessions, set ``masterapp`` to the name of the master application.</div><div class=""> </div><div class=""> </div><div class=""> To **store sessions in cookies** instead you can do:</div><div class=""> </div><div class=""> ``</div><div class=""> session.connect(request,response,cookie_key=&#x27;yoursecret&#x27;,compression_level=None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Here ``cookie_key`` is a symmetric encryption key.</div><div class="insert">``compression_level`` is an option<span class="highlight">a</span>l ``zlib`` encryption level.</div><div class=""> </div><div class=""> While sessions in cookie are often recommended for scalability reason they are limited in size. Large sessions will result in broken cookies.</div><div class=""> </div><div class=""> You can check the state of your application at any time by printing the ``request``, ``session`` and ``response`` system variables. One way to do it is to create a dedicated action:</div><div class=""> ``</div><div class=""> def status():</div><div class="">     return dict(request=request, session=session, response=response)</div><div class=""> ``:code</div><div class=""> </div><div class=""> In the &quot;generic.html&quot; view this is done using ``{{=response.toolbar()}}``.</div><div class=""> </div><div class=""> </div><div class=""> #### Separate sessions</div><div class=""> </div><div class=""> If you are storing sessions on filesystems and you have lots of them, the file system access may become a bottle-neck. One solution is the following:</div><div class=""> ``</div><div class=""> session.connect(request, response, separate=True)</div><div class=""> ``:code</div><div class=""> </div><div class=""> By setting ``separate=True`` web2py will store sessions not in the &quot;sessions/&quot; folder but in subfolders of the &quot;sessions/&quot; folder. The subfolder will be created automatically. Sessions with the same prefix will be in the same subfolder. Again, note that the above must be called before any logic that might require the session.</div><div class=""> T(&quot;blah %(name)s blah&quot; % dict(name=&#x27;Tim&#x27;))</div><div class=""> ``:code</div><div class=""> </div><div class=""> because translation would occur after substitution.</div><div class=""> </div><div class=""> #### Determining the language</div><div class=""> </div><div class=""> The requested language is determined by the &quot;Accept-Language&quot; field in the HTTP header, but this selection can be overwritten programmatically by requesting a specific file, for example:</div><div class=""> ``</div><div class=""> T.force(&#x27;it-it&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> which reads the &quot;languages/it-it.py&quot; language file. Language files can be created and edited via the administrative interface.</div><div class=""> </div><div class=""> You can also force a per-string language:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;Hello World&quot;, language=&quot;it-it&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> --------------</div><div class="insert">In the case multiple languages are requested, for example &quot;it-it, fr-ft&quot;, web2py tries to locate &quot;it-it.py&quot; and &quot;fr-fr.py&quot; translation files. If none of the requested files is present, it tries to fallback on &quot;it.py&quot; and &quot;fr.py&quot;. If these files are not present it defaults to &quot;default.py&quot;. If this is not present either, it default to no-translation. The more gen<span class="highlight">e</span>ral rule is that web2py tries &quot;xx-xy-yy.py&quot;, &quot;xx-xy.py&quot;, &quot;xx.py&quot;, &quot;default.py&quot; for each of the &quot;xx-xy-yy&quot; accepted languages trying to find the closest match to the visitor&#x27;s preferences.</div><div class=""> -------------</div><div class=""> </div><div class=""> You can turn off translations completely via</div><div class=""> </div><div class=""> ``</div><div class=""> T.force(None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Normally, string translation is evaluated lazily when the view is rendered; hence, the translator ``force`` method should not be called inside a view.</div><div class=""> </div><div class=""> It is possible to disable lazy evaluation via</div><div class=""> ``</div><div class=""> T.lazy = False</div><div class=""> ``:code</div><div class=""> </div><div class=""> In this way, strings are translated immediately by the ``T`` operator based on the currently accepted or forced language.</div><div class=""> </div><div class=""> It is also possible to disable lazy evaluation for individual strings:</div><div class=""> </div><div class=""> ``</div><div class=""> The currently accepted language is stored in</div><div class=""> ``</div><div class=""> T.accepted_language</div><div class=""> ``:code</div><div class=""> </div><div class=""> #### Translating variables</div><div class=""> </div><div class=""> Mind that T(...) does not just translate strings but can also translated variables:</div><div class=""> ``</div><div class=""> &gt;&gt;&gt; a=&quot;test&quot;</div><div class=""> &gt;&gt;&gt; print T(a)</div><div class=""> ``:code</div><div class=""> </div><div class=""> In this case the word &quot;test&quot; is translated but, if not found and if the filesystem is writable, it will add it to the list of words to be translated in the language file.</div><div class=""> </div><div class=""> Notice that this can result in lots of file IO and you may want to disable it:</div><div class=""> </div><div class=""> ``</div><div class=""> T.is_writable = False</div><div class=""> ``:code</div><div class=""> </div><div class="insert">prevents T from dynamically updating lang<span class="highlight">u</span>a<span class="highlight"></span>ge files.</div><div class=""> </div><div class=""> #### Comments and multiple translations</div><div class=""> </div><div class="insert">It is possible that the same string appe<span class="highlight">a</span>rs in different contexts in the application and needs different translations based on context. In order to do this, one can add comments to the original string. The comments will not be rendered but will be used by web2py to determine the most appropriate translation. For example:</div><div class=""> </div><div class=""> ``</div><div class="insert">+T(&quot;hello world ## first occurrence&quot;)</div><div class="insert">+T(&quot;hello world ## second occurrence&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class="insert">The text follo<span class="highlight">w</span>ing the ``##``, including the double ``##``, are comments.</div><div class=""> </div><div class=""> #### Pluralization engine</div><div class=""> </div><div class=""> Since version 2.0, web2py include s power pluralization system (PS). This means that when text marked for translation depends on a numeric variable, it may be translated differently based on the numeric value. For example in english we may render:</div><div class=""> </div><div class=""> ``</div><div class=""> x book(s)</div><div class=""> ``</div><div class=""> </div><div class=""> with</div><div class=""> </div><div class=""> ``</div><div class=""> a book (x==0)</div><div class=""> x books (x&gt;0)</div><div class=""> ``</div><div class=""> </div><div class="insert">English has one singular form and one plural form. The plural form is constructed by adding a &quot;-s&quot; or &quot;-es&quot; or using an exceptional form. web2py provides a way to define pluralization rules for each languages, as well as exceptions to the default rules. In fact web2py already knows pluralization rules for many languages. It knows, for example, that Slovenian has one singular form and 3 plural forms (for x==1, x==3 or x==4 and x&gt;4). These <span class="highlight">r</span>ules are encoded in &quot;gluon/contrib/plural_rules/*.py&quot; files and new files can be created. Explicit pluralizations for words are created by editing pluralization files using the administrative interface.</div><div class=""> </div><div class=""> By default the PS is not activated. It is triggered by the ``symbol`` argument of the ``T`` function. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;You have %s %%{book}&quot;, symbols=10)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Now the PS is activated for the work &quot;book&quot; and for the number 10.</div><div class=""> The result in english will be: &quot;You have 10 words&quot;. Notice that &quot;word&quot; has been pluralized into &quot;words&quot;.</div><div class=""> </div><div class=""> The PS consists from 3 parts:</div><div class=""> - placeholders ``%%{}`` to mark words in ``T``-messages</div><div class=""> - rule to give a decision which word form to use (&quot;rules/plural_rules/*.py&quot;)</div><div class=""> - dictionary with word plural forms (&quot;app/languages/plural-*.py&quot;)</div><div class=""> </div><div class=""> The value of symbols can be a single variable, a list/tuple of variables, or a dictionary.</div><div class=""> </div><div class=""> The placeholder ``%%{}`` consists of 3 parts:</div><div class=""> </div><div class=""> ``</div><div class=""> For example</div><div class=""> </div><div class=""> produces:</div><div class=""> </div><div class=""> ``</div><div class=""> var  output</div><div class=""> ------------------</div><div class="">  1   this is a book</div><div class="">  2   these are 2 books</div><div class="">  3   these are 2 books</div><div class="">  ...</div><div class=""> ``</div><div class=""> </div><div class=""> Inside ``%%{...}`` you can also use the following modifiers:</div><div class=""> </div><div class=""> - ``!`` to capitalize the text (equivalent to ``string.capitalize``)</div><div class=""> - ``!!`` to capitalize every word (equivalent to ``string.title``)</div><div class=""> - ``!!!`` to capitalize every character (equivalent to ``string.upper``)</div><div class=""> </div><div class=""> Notice you can use ``\\`` to scape ``!`` and ``?``.</div><div class=""> </div><div class="insert">#### Translations, plur<span class="highlight">a</span>l<span class="highlight"></span>ization, and MARKMIN</div><div class=""> </div><div class=""> You can also use the powerful MARKMIN syntax inside translation strings by replacing</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;hello world&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> with</div><div class=""> </div><div class=""> ``</div><div class=""> T.M(&quot;hello world&quot;)</div><div class=""> ``</div><div class=""> </div><div class=""> Now the string accepts MARKMIN markup as described later in the book. You can also use the pluralization system inside MARKMIN.</div><div class=""> </div><div class=""> ### Cookies</div><div class=""> </div><div class=""> ``cookies``:inxx</div><div class=""> </div><div class=""> web2py uses the Python cookies modules for handling cookies.</div><div class=""> error_message_ticket = &#x27;&#x27;&#x27;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Internal error&lt;/h1&gt;</div><div class=""> The first variable contains the error message when an invalid application or function is requested. The second variable contains the error message when a ticket is issued.</div><div class=""> </div><div class=""> ``routes_onerror`` work with both routing mechanisms.</div><div class=""> </div><div class=""> ``error_handler``:inxx</div><div class=""> In &quot;routes.py&quot; ne can also specify an action in charge of error handling:</div><div class=""> </div><div class=""> ``</div><div class=""> error_handler = dict(application=&#x27;error&#x27;,</div><div class="">                       controller=&#x27;default&#x27;,</div><div class="">                       function=&#x27;index&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> If the ``error_handler`` is specified the action is called without user redirection and the handler action will be in charge of dealing with the error. In the event that the error-handling page itself returns an error, web2py will fall back to its old static responses.</div><div class=""> </div><div class=""> </div><div class=""> #### Static asset management</div><div class=""> </div><div class=""> Since version 2.1.0, web2py has the ability to manage static assets.</div><div class=""> </div><div class="insert">When an application is in development, static file can change often, therefore web2py sends static files with no cache headers. This has the side-effect of &quot;forcing&quot; the browser to request static files at every request. This resul<span class="highlight">ts</span> in low performance when loading the page.</div><div class=""> </div><div class=""> In a &quot;production&quot; site, you may want to serve static files with ``cache`` headers to prevent un-necessary downloads since static files do not change.</div><div class=""> </div><div class=""> ``cache`` headers allow the browser to fetch each file only once, thus saving bandwidth and reducing loading time.</div><div class=""> </div><div class=""> Yet there is a problem: What should the cache headers declare? When should the files expire? When the files are first served, the server cannot forecast when they will be changed.</div><div class=""> </div><div class="insert">A manual approach consists of creating subfolders for different versions of static files. For example an early version of &quot;layout.css&quot; can be made available at the URL &quot;/myapp/static/css/1.2.3/layout.css&quot;. When you c<span class="highlight">ha</span>nge the file, you create a new subfolder and you link it as &quot;/myapp/static/css/1.2.4/layout.css&quot;.</div><div class=""> </div><div class="insert">This procedure works but it is pedantic since every<span class="highlight"> </span>time you update the css file, you must remember to move it to another folder, change the <span class="highlight">URL</span> of the file in your layout.html and deploy.</div><div class=""> </div><div class=""> Static asset management solves the problem by allowing the developer to declare a version for a group of static files and they will be requested again only when the version number changes. The version number of made part of the file url as in the previous example. The difference from the previous approach is that the version number only appears in the URL, not in the file system.</div><div class=""> </div><div class=""> </div><div class=""> If you want to serve &quot;/myapp/static/layout.css&quot; with the cache headers, you just need to include the file with a modified URL that includes a version number:</div><div class=""> ``</div><div class=""> /myapp/static/_1.2.3/layout.css</div><div class=""> ``</div><div class=""> (notice the URL defines a version number, it does not appear anywhere else).</div><div class=""> </div><div class="insert">Notice tha<span class="highlight">t the</span> URL starts with &quot;/myapp/static/&quot;, followed by a version number composed by an underscore and 3 integers separated by a period (as descri<span class="highlight">b</span>ed in [[SemVer http://semver.org/]]), then followed by the filename. Also notice that you do not have to create a &quot;_1.2.3/&quot; folder.</div><div class=""> </div><div class=""> Every time the static file is requested with a version in the url, it will be served with &quot;far in the future&quot; cache headers, specifically:</div><div class=""> ``</div><div class=""> Cache-Control : max-age=315360000</div><div class=""> Expires: Thu, 31 Dec 2037 23:59:59 GMT</div><div class=""> ``</div><div class=""> This means that the browser will fetch those file only once, and they will be saved &quot;forever&quot; in the browser&#x27;s cache.</div><div class=""> </div><div class=""> Every time the &quot;_1.2.3/filename&quot; is requested, web2py will remove the version part from the path and serve your file with far in the future headers so they will be cached forever. If you changed the version number in the URL, this tricks the browser into thinking it is requesting a different file, and the file is fetched again.</div><div class=""> </div><div class=""> You can use &quot;_1.2.3&quot;, &quot;_0.0.0&quot;, &quot;_999.888.888&quot;, as long as the version starts with underscore followed by three numbers separated by period.</div><div class=""> </div><div class=""> When in development, you can use ``response.files.append(...)`` to link the static URLs of static files. In this case you can include the &quot;_1.2.3/&quot; part manually, or you take advantage of a new parameter of the response object: ``response.static_version``.</div><div class=""> Just include the files the way you used to, for example</div><div class=""> ``</div><div class=""> {{response.files.append(URL(&#x27;static&#x27;,&#x27;layout.css&#x27;))}}</div><div class=""> ``</div><div class=""> and in models set</div><div class=""> ``:code</div><div class=""> response.static_version = &#x27;1.2.3&#x27;</div><div class=""> More information about deploying the scheduler under Linux and Windows is in the</div><div class=""> </div><div class=""> In the scheduler, a task is simply a function defined in a model (or in a module and imported by a model). For example:</div><div class=""> </div><div class=""> ``</div><div class=""> def task_add(a,b):</div><div class="">     return a+b</div><div class=""> ``:code</div><div class=""> </div><div class=""> Tasks will always be called in the same environment seen by controllers and therefore they see all the global variables defined in models, including database connections (``db``). Tasks differ from a controller action because they are not associated with an HTTP request and therefore there is no ``request.env``.</div><div class=""> </div><div class=""> To enable the scheduler you should put into a model its instantiation.</div><div class=""> The recommended way to enable the scheduler to your app is to create a model file named ``scheduler.py`` and define your function there. After the functions, you can put the following code into the model:</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.scheduler import Scheduler</div><div class=""> scheduler = Scheduler(db)</div><div class=""> ``:code</div><div class=""> </div><div class=""> NB: If your tasks are defined in a module (as opposed to a model) you may have to restart the workers.</div><div class=""> </div><div class="insert">The task is sch<span class="highlight">e</span>duled with</div><div class=""> </div><div class=""> ``</div><div class=""> scheduler.queue_task(&#x27;task_add&#x27;,pvars=dict(a=1,b=2))</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> ##### Parameters</div><div class=""> </div><div class=""> The first argument of the ``Scheduler`` class must be the database to be used by the scheduler to communicate with the workers. This can be the ``db`` of the app or another dedicated ``db``, perhaps one shared by multiple apps. If you use SQLite it&#x27;s recommended to use a separate db from the one used by your app in order to keep the app responsive.</div><div class=""> Once the tasks are defined and the ``Scheduler`` is instantiated, all that is needed to do is to start the workers. You can do that in several ways:</div><div class=""> </div><div class=""> ``</div><div class=""> python web2py.py -K myapp</div><div class=""> ``</div><div class=""> starts a worker for the app ``myapp``. If you want start multiple workers for the same app, you can do so just passing ``myapp,myapp``. You can pass also the ``group_names`` (overriding the one set in your model) with</div><div class=""> </div><div class=""> ``</div><div class=""> python web2py.py -K myapp:group1:group2,myotherapp:group1</div><div class=""> ``</div><div class=""> </div><div class=""> The ``scheduler_task`` table is the one where tasks are organized.</div><div class=""> </div><div class=""> All tasks follow a lifecycle</div><div class=""> </div><div class=""> [[scheduler tasks @///image/ce8edcc3.png center]]</div><div class=""> </div><div class=""> Let&#x27;s go with order. By default, when you send a task to the scheduler, you&#x27;ll want that to be executed. It&#x27;s in **QUEUED** status.</div><div class=""> If you need it to be executed later, use the ``start_time`` parameter (default = now).</div><div class=""> If for some reason you need to be sure that the task don&#x27;t get executed after a certain point in time (maybe a request to a webservice</div><div class=""> that shuts down at 1AM, a mail that needs to be sent not after the working hours, etc...) you can set a ``stop_time`` (default = None) for it.</div><div class=""> If your task is NOT picked up by a worker before stop_time, it will be set as **EXPIRED**.</div><div class=""> Tasks with no stop_time set or picked up **BEFORE** stop_time are **ASSIGNED** to a worker. When a workers picks up them, they become **RUNNING**.</div><div class=""> **RUNNING** tasks may end up:</div><div class=""> - **TIMEOUT** when more than n seconds passed with ``timeout`` parameter (default = 60 seconds)</div><div class=""> - **FAILED** when an exception is detected</div><div class=""> - **COMPLETED** when all went ok</div><div class=""> </div><div class=""> Additionally, you can control how many times a task should be repeated (i.e. you need to aggregate some data at specified intervals). To do so, set the ``repeats``</div><div class=""> parameter (default = 1 time only, 0 = unlimited). You can influence how many seconds should pass between executions with the ``period`` parameter (default = 60 seconds).</div><div class=""> NB: the time is not calculated between the END of the first round and the START of the next, but from the START time of the first round to the START time of the next cycle)</div><div class=""> </div><div class="insert">Another nice addition, you can set how many times the function can raise an exception (i.e. requesting data from a sl<span class="highlight"></span>ow webservice) and be queued again instead of stopping in **FAILED**  status with the parameter ``retry_failed`` (default = 0, -1 = unlimited).</div><div class=""> </div><div class=""> [[task repeats @///image/7d8b85e4.png center]]</div><div class=""> </div><div class=""> Summary: you have</div><div class=""> - ``period`` and ``repeats`` to get an automatically rescheduled function</div><div class=""> - ``timeout`` to be sure that a function doesn&#x27;t exceed a certain amount of time</div><div class=""> - ``retry_failed`` to control how many times the task can &quot;fail&quot;</div><div class=""> - ``start_time`` and ``stop_time`` to schedule a function in a restricted timeframe</div><div class=""> </div><div class=""> </div><div class=""> ##### Results and output</div><div class=""> The table &quot;scheduler_run&quot; stores the status of all running tasks. Each record references a task that has been picked up by a worker.  One task can have multiple runs. For example, a task scheduled to repeat 10 times an hour will probably have 10 runs (unless one fails or they take longer than 1 hour). Beware that if the task has no return values, it is removed from the scheduler_run table as soon as it is finished.</div><div class=""> </div><div class=""> Possible run statuses are:</div><div class=""> </div><div class=""> ``</div><div class=""> RUNNING, COMPLETED, FAILED, TIMEOUT</div><div class=""> ``</div><div class=""> </div><div class=""> If the run is completed, no exceptions are thrown, and there is no task timeout, the run is marked as ``COMPLETED`` and the task is marked as ``QUEUED`` or ``COMPLETED`` depending on whether it is supposed to run again at a later time. The output of the task is serialized in JSON and stored in the run record.</div><div class=""> Maybe you have yet some tasks queued, and you want to save some resources.</div><div class=""> You know you want them processed every hour, so, you&#x27;ll want to:</div><div class=""> - process all queued tasks and die automatically</div><div class=""> All of these things are possible managing ``Scheduler`` parameters or the ``scheduler_worker`` table.</div><div class=""> To be more precise, for started workers you will change the ``status`` value of any worker to influence</div><div class=""> its behavior.</div><div class=""> As tasks, workers can be in some fixed statuses : ACTIVE, DISABLED, TERMINATE or KILLED.</div><div class=""> </div><div class=""> **ACTIVE** and **DISABLED** are &quot;persistent&quot;, while **TERMINATE** or **KILL**, as statuses</div><div class=""> name suggest, are more &quot;commands&quot; than real statuses.</div><div class=""> Hitting ctrl+c is equal to set a worker to **KILL**</div><div class=""> </div><div class=""> [[workers statuses @///image/bd891eed.png center]]</div><div class=""> </div><div class=""> Everything that one can do via appadmin one can do programmatically by inserting and updating records in these tables.</div><div class=""> </div><div class=""> Anyway, one should not update records relative to ``RUNNING`` tasks as this may create an un-expected behavior. The best practice is to queue tasks using &quot;queue_task&quot;.</div><div class=""> </div><div class=""> For example:</div><div class=""> </div><div class=""> ``</div><div class="insert">scheduler.queu<span class="highlight">e</span>_task(</div><div class="">     function_name=&#x27;task_add&#x27;,</div><div class="">     pargs=[],</div><div class="">     pvars={&#x27;a&#x27;:3,&#x27;b&#x27;:4},</div><div class="">     repeats = 10, # run 10 times</div><div class="">     period = 3600, # every 1h</div><div class="">     timeout = 120, # should take less than 120 seconds</div><div class="">     )</div><div class=""> ``:code</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">``response.headers``: a ``dict`` for HTTP response headers. Web2py sets some headers by default, including &quot;Content-Length&quot;, &quot;Content-Type&quot;, and &quot;X-Powered-By&quot; (set equal to web2py). Web2py also sets the &quot;Cache-Control&quot;, &quot;Expires&quot;, and &quot;Pragma&quot; headers to prevent client-side caching, except for static file requests, for which client-side caching is enabled. The headers that web2py sets can be overwritten or removed, and new headers can be added (e.g., ``response.headers[&#x27;Cache-Control&#x27;] = &#x27;private&#x27;``). You can remove a header removing its key from the response.headers dict, e.g.``del response.headers[&#x27;Custom-Header&#x27;]``, however web2py&#x27;s default headers will be re-added just before returning the response. To avoid this behavio<span class="highlight">u</span>r, just set the header value to None, e.g. to remove the default Content-Type header, ``response.headers[&#x27;Content-Type&#x27;] = None``</div><div class=""> </div><div class=""> ``response.menu``: optional parameter that may be included in the views, normally used to pass a navigation menu tree to the view. It can be rendered by the MENU helper.</div><div class=""> </div><div class=""> </div><div class=""> ``response.meta``: a storage object (like a dict) that contains optional meta information like ``response.meta.author``, ``.description``, and/or ``.keywords``. The content of each meta variable is automatically placed in the proper ``META`` tag by the code in &quot;views/web2py_ajax.html&quot;, which is included by default in &quot;views/layout.html&quot;.</div><div class=""> </div><div class=""> ``response.include_meta()`` generates a string that includes all ``response.meta`` headers serialized (used in &quot;views/web2py_ajax.html&quot;).</div><div class=""> </div><div class=""> ``response.postprocessing``: this is a list of functions, empty by default. These functions are used to filter the response object at the output of an action, before the output is rendered by the view. It can be used to implement support for other template languages.</div><div class=""> </div><div class=""> ``response.render(view, vars)``: a method used to call the view explicitly inside the controller. ``view`` is an optional parameter which is the name of the view file, ``vars`` is a dictionary of named values passed to the view.</div><div class=""> </div><div class=""> ``response.session_file``: file stream containing the session.</div><div class=""> </div><div class=""> ``response.session_file_name``: name of the file where the session will be saved.</div><div class=""> </div><div class=""> ``response.session_id``: the id of the current session. It is determined automatically. NEVER CHANGE THIS VARIABLE.</div><div class=""> </div><div class=""> ``response.session_id_name``: the name of the session cookie for this application. NEVER CHANGE THIS VARIABLE.</div><div class=""> </div><div class=""> ``response.status``: the HTTP status code integer to be passed to the response. Default is 200 (OK).</div><div class=""> </div><div class=""> ``response.stream(file, chunk_size, request=request, attachment=False, filename=None, headers=None)``: when a controller returns it, web2py streams the file content back to the client in blocks of size ``chunk_size``. The ``request`` parameter is required to use the chunk start in the HTTP header. ``file`` should be a file path (for backward compatibility, it can also be an open file object, but this is not recommended). As noted above, ``response.download`` should be used to retrieve files stored via an upload field. ``response.stream`` can be used in other cases, such as returning a temporary file or StringIO object created by the controller. If ``attachment`` is True, the Content-Disposition header will be set to &quot;attachment&quot;, and if ``filename`` is also provided, it will be added to the Content-Disposition header as well (but only when ``attachment`` is True). If not already included in ``response.headers``, the following response headers will be set automatically: Content-Type, Content-Length, Cache-Control, Pragma, and Last-Modified (the latter three are set to allow browser caching of the file). To override any of these automatic header settings, simply set them in ``response.headers`` before calling ``response.stream``.</div><div class=""> </div><div class=""> ``response.subtitle``: optional parameter that may be included in the views. It should contain the subtitle of the page.</div><div class=""> </div><div class=""> ``response.title``: optional parameter that may be included in the views. It should contain the title of the page and should be rendered by the HTML title TAG in the header.</div><div class=""> </div><div class=""> ``response.toolbar``: a function that allows you embed a toolbar into page form debugging purposes ``{{=response.toolbar()}}``. The toolbar displays request, response, session variables and database access time for each query.</div><div class=""> </div><div class=""> ``response._vars``: this variable is accessible only in a view, not in the action. It contains the value returned by the action to the view.</div><div class=""> </div><div class="delete">``response._caller``: this is a function that wraps all action calls. It defaults to the iden<span class="highlight"></span>ity function<span class="highlight"></span> but it can be modifed in order to catch special types of exception <span class="highlight"></span>o<span class="highlight">f</span> do extra logging;</div><div class=""> </div><div class=""> ``</div><div class=""> response._caller = lambda f: f()</div><div class=""> ``</div><div class=""> </div><div class=""> ``response.optimize_css``: if can be set to &quot;concat,minify,inline&quot; to concatenate, minify and inline the CSS files included by web2py.</div><div class=""> </div><div class=""> ``response.optimize_js``: if can be set to &quot;concat,minify,inline&quot; to concatenate, minify and inline the JavaScript files included by web2py.</div><div class=""> </div><div class=""> ``response.view``: the name of the view template that must render the page. This is set by default to:</div><div class=""> ``</div><div class=""> &quot;%s/%s.%s&quot; % (request.controller, request.function, request.extension)</div><div class=""> ``:code</div><div class=""> </div><div class=""> or, if the above file cannot be located, to</div><div class=""> ``</div><div class=""> &quot;generic.%s&quot; % (request.extension)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Change the value of this variable to modify the view file associated with a particular action.</div><div class=""> db.define_table(&#x27;web2py_session&#x27;,</div><div class="">                  Field(&#x27;created_datetime&#x27;, &#x27;datetime&#x27;, default=now),</div><div class="">                  Field(&#x27;modified_datetime&#x27;, &#x27;datetime&#x27;),</div><div class="">                  Field(&#x27;unique_key&#x27;),</div><div class="">                  Field(&#x27;session_data&#x27;, &#x27;text&#x27;))</div><div class=""> ``:code</div><div class=""> </div><div class=""> and stores cPickled sessions in the ``session_data`` field.</div><div class=""> </div><div class=""> The option ``masterapp=None``, by default, tells web2py to try to retrieve an existing session for the application with name in ``request.application``, in the running application.</div><div class=""> </div><div class=""> If you want two or more applications to share sessions, set ``masterapp`` to the name of the master application.</div><div class=""> </div><div class=""> </div><div class=""> To **store sessions in cookies** instead you can do:</div><div class=""> </div><div class=""> ``</div><div class=""> session.connect(request,response,cookie_key=&#x27;yoursecret&#x27;,compression_level=None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Here ``cookie_key`` is a symmetric encryption key.</div><div class="delete">``compression_level`` is an option<span class="highlight"></span>l ``zlib`` encryption level.</div><div class=""> </div><div class=""> While sessions in cookie are often recommended for scalability reason they are limited in size. Large sessions will result in broken cookies.</div><div class=""> </div><div class=""> You can check the state of your application at any time by printing the ``request``, ``session`` and ``response`` system variables. One way to do it is to create a dedicated action:</div><div class=""> ``</div><div class=""> def status():</div><div class="">     return dict(request=request, session=session, response=response)</div><div class=""> ``:code</div><div class=""> </div><div class=""> In the &quot;generic.html&quot; view this is done using ``{{=response.toolbar()}}``.</div><div class=""> </div><div class=""> </div><div class=""> #### Separate sessions</div><div class=""> </div><div class=""> If you are storing sessions on filesystems and you have lots of them, the file system access may become a bottle-neck. One solution is the following:</div><div class=""> ``</div><div class=""> session.connect(request, response, separate=True)</div><div class=""> ``:code</div><div class=""> </div><div class=""> By setting ``separate=True`` web2py will store sessions not in the &quot;sessions/&quot; folder but in subfolders of the &quot;sessions/&quot; folder. The subfolder will be created automatically. Sessions with the same prefix will be in the same subfolder. Again, note that the above must be called before any logic that might require the session.</div><div class=""> T(&quot;blah %(name)s blah&quot; % dict(name=&#x27;Tim&#x27;))</div><div class=""> ``:code</div><div class=""> </div><div class=""> because translation would occur after substitution.</div><div class=""> </div><div class=""> #### Determining the language</div><div class=""> </div><div class=""> The requested language is determined by the &quot;Accept-Language&quot; field in the HTTP header, but this selection can be overwritten programmatically by requesting a specific file, for example:</div><div class=""> ``</div><div class=""> T.force(&#x27;it-it&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> which reads the &quot;languages/it-it.py&quot; language file. Language files can be created and edited via the administrative interface.</div><div class=""> </div><div class=""> You can also force a per-string language:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;Hello World&quot;, language=&quot;it-it&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> --------------</div><div class="delete">In the case multiple languages are requested, for example &quot;it-it, fr-ft&quot;, web2py tries to locate &quot;it-it.py&quot; and &quot;fr-fr.py&quot; translation files. If none of the requested files is present, it tries to fallback on &quot;it.py&quot; and &quot;fr.py&quot;. If these files are not present it defaults to &quot;default.py&quot;. If this is not present either, it default to no-translation. The more gen<span class="highlight"></span>ral rule is that web2py tries &quot;xx-xy-yy.py&quot;, &quot;xx-xy.py&quot;, &quot;xx.py&quot;, &quot;default.py&quot; for each of the &quot;xx-xy-yy&quot; accepted languages trying to find the closest match to the visitor&#x27;s preferences.</div><div class=""> -------------</div><div class=""> </div><div class=""> You can turn off translations completely via</div><div class=""> </div><div class=""> ``</div><div class=""> T.force(None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Normally, string translation is evaluated lazily when the view is rendered; hence, the translator ``force`` method should not be called inside a view.</div><div class=""> </div><div class=""> It is possible to disable lazy evaluation via</div><div class=""> ``</div><div class=""> T.lazy = False</div><div class=""> ``:code</div><div class=""> </div><div class=""> In this way, strings are translated immediately by the ``T`` operator based on the currently accepted or forced language.</div><div class=""> </div><div class=""> It is also possible to disable lazy evaluation for individual strings:</div><div class=""> </div><div class=""> ``</div><div class=""> The currently accepted language is stored in</div><div class=""> ``</div><div class=""> T.accepted_language</div><div class=""> ``:code</div><div class=""> </div><div class=""> #### Translating variables</div><div class=""> </div><div class=""> Mind that T(...) does not just translate strings but can also translated variables:</div><div class=""> ``</div><div class=""> &gt;&gt;&gt; a=&quot;test&quot;</div><div class=""> &gt;&gt;&gt; print T(a)</div><div class=""> ``:code</div><div class=""> </div><div class=""> In this case the word &quot;test&quot; is translated but, if not found and if the filesystem is writable, it will add it to the list of words to be translated in the language file.</div><div class=""> </div><div class=""> Notice that this can result in lots of file IO and you may want to disable it:</div><div class=""> </div><div class=""> ``</div><div class=""> T.is_writable = False</div><div class=""> ``:code</div><div class=""> </div><div class="delete">prevents T from dynamically updating lang<span class="highlight"></span>a<span class="highlight">u</span>ge files.</div><div class=""> </div><div class=""> #### Comments and multiple translations</div><div class=""> </div><div class="delete">It is possible that the same string appe<span class="highlight"></span>rs in different contexts in the application and needs different translations based on context. In order to do this, one can add comments to the original string. The comments will not be rendered but will be used by web2py to determine the most appropriate translation. For example:</div><div class=""> </div><div class=""> ``</div><div class="delete">-T(&quot;hello world ## first occurence&quot;)</div><div class="delete">-T(&quot;hello world ## second occurence&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class="delete">The text follo<span class="highlight"></span>ing the ``##``, including the double ``##``, are comments.</div><div class=""> </div><div class=""> #### Pluralization engine</div><div class=""> </div><div class=""> Since version 2.0, web2py include s power pluralization system (PS). This means that when text marked for translation depends on a numeric variable, it may be translated differently based on the numeric value. For example in english we may render:</div><div class=""> </div><div class=""> ``</div><div class=""> x book(s)</div><div class=""> ``</div><div class=""> </div><div class=""> with</div><div class=""> </div><div class=""> ``</div><div class=""> a book (x==0)</div><div class=""> x books (x&gt;0)</div><div class=""> ``</div><div class=""> </div><div class="delete">English has one singular form and one plural form. The plural form is constructed by adding a &quot;-s&quot; or &quot;-es&quot; or using an exceptional form. web2py provides a way to define pluralization rules for each languages, as well as exceptions to the default rules. In fact web2py already knows pluralization rules for many languages. It knows, for example, that Slovenian has one singular form and 3 plural forms (for x==1, x==3 or x==4 and x&gt;4). These <span class="highlight"></span>ules are encoded in &quot;gluon/contrib/plural_rules/*.py&quot; files and new files can be created. Explicit pluralizations for words are created by editing pluralization files using the administrative interface.</div><div class=""> </div><div class=""> By default the PS is not activated. It is triggered by the ``symbol`` argument of the ``T`` function. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;You have %s %%{book}&quot;, symbols=10)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Now the PS is activated for the work &quot;book&quot; and for the number 10.</div><div class=""> The result in english will be: &quot;You have 10 words&quot;. Notice that &quot;word&quot; has been pluralized into &quot;words&quot;.</div><div class=""> </div><div class=""> The PS consists from 3 parts:</div><div class=""> - placeholders ``%%{}`` to mark words in ``T``-messages</div><div class=""> - rule to give a decision which word form to use (&quot;rules/plural_rules/*.py&quot;)</div><div class=""> - dictionary with word plural forms (&quot;app/languages/plural-*.py&quot;)</div><div class=""> </div><div class=""> The value of symbols can be a single variable, a list/tuple of variables, or a dictionary.</div><div class=""> </div><div class=""> The placeholder ``%%{}`` consists of 3 parts:</div><div class=""> </div><div class=""> ``</div><div class=""> For example</div><div class=""> </div><div class=""> produces:</div><div class=""> </div><div class=""> ``</div><div class=""> var  output</div><div class=""> ------------------</div><div class="">  1   this is a book</div><div class="">  2   these are 2 books</div><div class="">  3   these are 2 books</div><div class="">  ...</div><div class=""> ``</div><div class=""> </div><div class=""> Inside ``%%{...}`` you can also use the following modifiers:</div><div class=""> </div><div class=""> - ``!`` to capitalize the text (equivalent to ``string.capitalize``)</div><div class=""> - ``!!`` to capitalize every word (equivalent to ``string.title``)</div><div class=""> - ``!!!`` to capitalize every character (equivalent to ``string.upper``)</div><div class=""> </div><div class=""> Notice you can use ``\\`` to scape ``!`` and ``?``.</div><div class=""> </div><div class="delete">#### Translations, plur<span class="highlight"></span>l<span class="highlight">a</span>ization, and MARKMIN</div><div class=""> </div><div class=""> You can also use the powerful MARKMIN syntax inside translation strings by replacing</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;hello world&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> with</div><div class=""> </div><div class=""> ``</div><div class=""> T.M(&quot;hello world&quot;)</div><div class=""> ``</div><div class=""> </div><div class=""> Now the string accepts MARKMIN markup as described later in the book. You can also use the pluralization system inside MARKMIN.</div><div class=""> </div><div class=""> ### Cookies</div><div class=""> </div><div class=""> ``cookies``:inxx</div><div class=""> </div><div class=""> web2py uses the Python cookies modules for handling cookies.</div><div class=""> error_message_ticket = &#x27;&#x27;&#x27;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Internal error&lt;/h1&gt;</div><div class=""> The first variable contains the error message when an invalid application or function is requested. The second variable contains the error message when a ticket is issued.</div><div class=""> </div><div class=""> ``routes_onerror`` work with both routing mechanisms.</div><div class=""> </div><div class=""> ``error_handler``:inxx</div><div class=""> In &quot;routes.py&quot; ne can also specify an action in charge of error handling:</div><div class=""> </div><div class=""> ``</div><div class=""> error_handler = dict(application=&#x27;error&#x27;,</div><div class="">                       controller=&#x27;default&#x27;,</div><div class="">                       function=&#x27;index&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> If the ``error_handler`` is specified the action is called without user redirection and the handler action will be in charge of dealing with the error. In the event that the error-handling page itself returns an error, web2py will fall back to its old static responses.</div><div class=""> </div><div class=""> </div><div class=""> #### Static asset management</div><div class=""> </div><div class=""> Since version 2.1.0, web2py has the ability to manage static assets.</div><div class=""> </div><div class="delete">When an application is in development, static file can change often, therefore web2py sends static files with no cache headers. This has the side-effect of &quot;forcing&quot; the browser to request static files at every request. This resul<span class="highlight">st</span> in low performance when loading the page.</div><div class=""> </div><div class=""> In a &quot;production&quot; site, you may want to serve static files with ``cache`` headers to prevent un-necessary downloads since static files do not change.</div><div class=""> </div><div class=""> ``cache`` headers allow the browser to fetch each file only once, thus saving bandwidth and reducing loading time.</div><div class=""> </div><div class=""> Yet there is a problem: What should the cache headers declare? When should the files expire? When the files are first served, the server cannot forecast when they will be changed.</div><div class=""> </div><div class="delete">A manual approach consists of creating subfolders for different versions of static files. For example an early version of &quot;layout.css&quot; can be made available at the URL &quot;/myapp/static/css/1.2.3/layout.css&quot;. When you c<span class="highlight">ah</span>nge the file, you create a new subfolder and you link it as &quot;/myapp/static/css/1.2.4/layout.css&quot;.</div><div class=""> </div><div class="delete">This procedure works but it is pedantic since every<span class="highlight"></span>time you update the css file, you must remember to move it to another folder, change the <span class="highlight">url</span> of the file in your layout.html and deploy.</div><div class=""> </div><div class=""> Static asset management solves the problem by allowing the developer to declare a version for a group of static files and they will be requested again only when the version number changes. The version number of made part of the file url as in the previous example. The difference from the previous approach is that the version number only appears in the URL, not in the file system.</div><div class=""> </div><div class=""> </div><div class=""> If you want to serve &quot;/myapp/static/layout.css&quot; with the cache headers, you just need to include the file with a modified URL that includes a version number:</div><div class=""> ``</div><div class=""> /myapp/static/_1.2.3/layout.css</div><div class=""> ``</div><div class=""> (notice the URL defines a version number, it does not appear anywhere else).</div><div class=""> </div><div class="delete">Notice tha<span class="highlight"></span> URL starts with &quot;/myapp/static/&quot;, followed by a version number composed by an underscore and 3 integers separated by a period (as descri<span class="highlight">v</span>ed in [[SemVer http://semver.org/]]), then followed by the filename. Also notice that you do not have to create a &quot;_1.2.3/&quot; folder.</div><div class=""> </div><div class=""> Every time the static file is requested with a version in the url, it will be served with &quot;far in the future&quot; cache headers, specifically:</div><div class=""> ``</div><div class=""> Cache-Control : max-age=315360000</div><div class=""> Expires: Thu, 31 Dec 2037 23:59:59 GMT</div><div class=""> ``</div><div class=""> This means that the browser will fetch those file only once, and they will be saved &quot;forever&quot; in the browser&#x27;s cache.</div><div class=""> </div><div class=""> Every time the &quot;_1.2.3/filename&quot; is requested, web2py will remove the version part from the path and serve your file with far in the future headers so they will be cached forever. If you changed the version number in the URL, this tricks the browser into thinking it is requesting a different file, and the file is fetched again.</div><div class=""> </div><div class=""> You can use &quot;_1.2.3&quot;, &quot;_0.0.0&quot;, &quot;_999.888.888&quot;, as long as the version starts with underscore followed by three numbers separated by period.</div><div class=""> </div><div class=""> When in development, you can use ``response.files.append(...)`` to link the static URLs of static files. In this case you can include the &quot;_1.2.3/&quot; part manually, or you take advantage of a new parameter of the response object: ``response.static_version``.</div><div class=""> Just include the files the way you used to, for example</div><div class=""> ``</div><div class=""> {{response.files.append(URL(&#x27;static&#x27;,&#x27;layout.css&#x27;))}}</div><div class=""> ``</div><div class=""> and in models set</div><div class=""> ``:code</div><div class=""> response.static_version = &#x27;1.2.3&#x27;</div><div class=""> More information about deploying the scheduler under Linux and Windows is in the</div><div class=""> </div><div class=""> In the scheduler, a task is simply a function defined in a model (or in a module and imported by a model). For example:</div><div class=""> </div><div class=""> ``</div><div class=""> def task_add(a,b):</div><div class="">     return a+b</div><div class=""> ``:code</div><div class=""> </div><div class=""> Tasks will always be called in the same environment seen by controllers and therefore they see all the global variables defined in models, including database connections (``db``). Tasks differ from a controller action because they are not associated with an HTTP request and therefore there is no ``request.env``.</div><div class=""> </div><div class=""> To enable the scheduler you should put into a model its instantiation.</div><div class=""> The recommended way to enable the scheduler to your app is to create a model file named ``scheduler.py`` and define your function there. After the functions, you can put the following code into the model:</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.scheduler import Scheduler</div><div class=""> scheduler = Scheduler(db)</div><div class=""> ``:code</div><div class=""> </div><div class=""> NB: If your tasks are defined in a module (as opposed to a model) you may have to restart the workers.</div><div class=""> </div><div class="delete">The task is sch<span class="highlight"></span>duled with</div><div class=""> </div><div class=""> ``</div><div class=""> scheduler.queue_task(&#x27;task_add&#x27;,pvars=dict(a=1,b=2))</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> ##### Parameters</div><div class=""> </div><div class=""> The first argument of the ``Scheduler`` class must be the database to be used by the scheduler to communicate with the workers. This can be the ``db`` of the app or another dedicated ``db``, perhaps one shared by multiple apps. If you use SQLite it&#x27;s recommended to use a separate db from the one used by your app in order to keep the app responsive.</div><div class=""> Once the tasks are defined and the ``Scheduler`` is instantiated, all that is needed to do is to start the workers. You can do that in several ways:</div><div class=""> </div><div class=""> ``</div><div class=""> python web2py.py -K myapp</div><div class=""> ``</div><div class=""> starts a worker for the app ``myapp``. If you want start multiple workers for the same app, you can do so just passing ``myapp,myapp``. You can pass also the ``group_names`` (overriding the one set in your model) with</div><div class=""> </div><div class=""> ``</div><div class=""> python web2py.py -K myapp:group1:group2,myotherapp:group1</div><div class=""> ``</div><div class=""> </div><div class=""> The ``scheduler_task`` table is the one where tasks are organized.</div><div class=""> </div><div class=""> All tasks follow a lifecycle</div><div class=""> </div><div class=""> [[scheduler tasks @///image/ce8edcc3.png center]]</div><div class=""> </div><div class=""> Let&#x27;s go with order. By default, when you send a task to the scheduler, you&#x27;ll want that to be executed. It&#x27;s in **QUEUED** status.</div><div class=""> If you need it to be executed later, use the ``start_time`` parameter (default = now).</div><div class=""> If for some reason you need to be sure that the task don&#x27;t get executed after a certain point in time (maybe a request to a webservice</div><div class=""> that shuts down at 1AM, a mail that needs to be sent not after the working hours, etc...) you can set a ``stop_time`` (default = None) for it.</div><div class=""> If your task is NOT picked up by a worker before stop_time, it will be set as **EXPIRED**.</div><div class=""> Tasks with no stop_time set or picked up **BEFORE** stop_time are **ASSIGNED** to a worker. When a workers picks up them, they become **RUNNING**.</div><div class=""> **RUNNING** tasks may end up:</div><div class=""> - **TIMEOUT** when more than n seconds passed with ``timeout`` parameter (default = 60 seconds)</div><div class=""> - **FAILED** when an exception is detected</div><div class=""> - **COMPLETED** when all went ok</div><div class=""> </div><div class=""> Additionally, you can control how many times a task should be repeated (i.e. you need to aggregate some data at specified intervals). To do so, set the ``repeats``</div><div class=""> parameter (default = 1 time only, 0 = unlimited). You can influence how many seconds should pass between executions with the ``period`` parameter (default = 60 seconds).</div><div class=""> NB: the time is not calculated between the END of the first round and the START of the next, but from the START time of the first round to the START time of the next cycle)</div><div class=""> </div><div class="delete">Another nice addition, you can set how many times the function can raise an exception (i.e. requesting data from a sl<span class="highlight">ooo</span>ow webservice) and be queued again instead of stopping in **FAILED**  status with the parameter ``retry_failed`` (default = 0, -1 = unlimited).</div><div class=""> </div><div class=""> [[task repeats @///image/7d8b85e4.png center]]</div><div class=""> </div><div class=""> Summary: you have</div><div class=""> - ``period`` and ``repeats`` to get an automatically rescheduled function</div><div class=""> - ``timeout`` to be sure that a function doesn&#x27;t exceed a certain amount of time</div><div class=""> - ``retry_failed`` to control how many times the task can &quot;fail&quot;</div><div class=""> - ``start_time`` and ``stop_time`` to schedule a function in a restricted timeframe</div><div class=""> </div><div class=""> </div><div class=""> ##### Results and output</div><div class=""> The table &quot;scheduler_run&quot; stores the status of all running tasks. Each record references a task that has been picked up by a worker.  One task can have multiple runs. For example, a task scheduled to repeat 10 times an hour will probably have 10 runs (unless one fails or they take longer than 1 hour). Beware that if the task has no return values, it is removed from the scheduler_run table as soon as it is finished.</div><div class=""> </div><div class=""> Possible run statuses are:</div><div class=""> </div><div class=""> ``</div><div class=""> RUNNING, COMPLETED, FAILED, TIMEOUT</div><div class=""> ``</div><div class=""> </div><div class=""> If the run is completed, no exceptions are thrown, and there is no task timeout, the run is marked as ``COMPLETED`` and the task is marked as ``QUEUED`` or ``COMPLETED`` depending on whether it is supposed to run again at a later time. The output of the task is serialized in JSON and stored in the run record.</div><div class=""> Maybe you have yet some tasks queued, and you want to save some resources.</div><div class=""> You know you want them processed every hour, so, you&#x27;ll want to:</div><div class=""> - process all queued tasks and die automatically</div><div class=""> All of these things are possible managing ``Scheduler`` parameters or the ``scheduler_worker`` table.</div><div class=""> To be more precise, for started workers you will change the ``status`` value of any worker to influence</div><div class=""> its behavior.</div><div class=""> As tasks, workers can be in some fixed statuses : ACTIVE, DISABLED, TERMINATE or KILLED.</div><div class=""> </div><div class=""> **ACTIVE** and **DISABLED** are &quot;persistent&quot;, while **TERMINATE** or **KILL**, as statuses</div><div class=""> name suggest, are more &quot;commands&quot; than real statuses.</div><div class=""> Hitting ctrl+c is equal to set a worker to **KILL**</div><div class=""> </div><div class=""> [[workers statuses @///image/bd891eed.png center]]</div><div class=""> </div><div class=""> Everything that one can do via appadmin one can do programmatically by inserting and updating records in these tables.</div><div class=""> </div><div class=""> Anyway, one should not update records relative to ``RUNNING`` tasks as this may create an un-expected behavior. The best practice is to queue tasks using &quot;queue_task&quot;.</div><div class=""> </div><div class=""> For example:</div><div class=""> </div><div class=""> ``</div><div class="delete">scheduler.queu<span class="highlight">r</span>_task(</div><div class="">     function_name=&#x27;task_add&#x27;,</div><div class="">     pargs=[],</div><div class="">     pvars={&#x27;a&#x27;:3,&#x27;b&#x27;:4},</div><div class="">     repeats = 10, # run 10 times</div><div class="">     period = 3600, # every 1h</div><div class="">     timeout = 120, # should take less than 120 seconds</div><div class="">     )</div><div class=""> ``:code</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/056a1bdee4d0dd56ee506979ef272d4c0de9dfb0">056a1bd</a><ul><li>Date : 2012-12-27</li><li>replaced some diagrams</li></ul></li></ul>
<div class="row-fluid" id="com_056a1bdee4d0dd56ee506979ef272d4c0de9dfb0">
    <div class="span6"><div class="diff"><div class=""> [[image @///image/en5700.png center 480px]]</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">-(The names of the default application, controller and function can be overridden in routes.py; see &#x27;&#x27;[[Default Application, Controller and Function #Default-Application,-Controller-and-Function]]&#x27;&#x27; below.</div><div class="delete">-</div><div class=""> [[image @///image/en5700.png center 480px]]</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/25fcabc8e16dd81e067560c2a68a60687b7e7217">25fcabc</a><ul><li>Date : 2012-12-27</li><li>fixed space</li></ul></li></ul>
<div class="row-fluid" id="com_25fcabc8e16dd81e067560c2a68a60687b7e7217">
    <div class="span6"><div class="diff"><div class="insert">web2py applications contain additional files, particularly third-party JavaScript libraries, such as jQuery, calendar<span class="highlight"></span>,<span class="highlight"></span> and <span class="highlight">Codem</span>i<span class="highlight">rror</span>. Their authors are acknowledged in the files themselves.</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">-In summary, web2py libraries provide the following functionality:</div><div class="delete">-- Map URLs into function calls.</div><div class="delete">-- Handle passing and returning parameters via HTTP.</div><div class="delete">-- Perform validation of those parameters.</div><div class="delete">-- Protect the applications from most security issues.</div><div class="delete">-- Handle data persistence (database, session, cache, cookies).</div><div class="delete">-- Perform string translations for various supported languages.</div><div class="delete">-- Generate HTML programmatically (e.g. from database tables).</div><div class="delete">-- Generate SQL via a Database Abstraction Layer (DAL).</div><div class="delete">-- Generate Rich Text Format (RTF) output.</div><div class="delete">-- Generate Comma-Separated Value (CSV) output from database tables.</div><div class="delete">-- Generate Really Simple Syndication (RSS) feeds.</div><div class="delete">-- Generate JavaScript Object Notation (JSON) serialization strings for Ajax.</div><div class="delete">-- Translate wiki markup (Markdown) to HTML.</div><div class="delete">-- Expose XML-RPC web services.</div><div class="delete">-- Upload and download large files via streaming.</div><div class="delete">-</div><div class="delete">web2py applications contain additional files, particularly third-party JavaScript libraries, such as jQuery, calendar<span class="highlight">/datepicker</span>,<span class="highlight"> EditArea</span> and <span class="highlight">n</span>i<span class="highlight">cEdit</span>. Their authors are acknowledged in the files themselves.</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/097d699dc16179206ccb7e4aee863d6523cd471c">097d699</a><ul><li>Date : 2012-12-27</li><li>fixed typo, thanks Andrew</li></ul></li></ul>
<div class="row-fluid" id="com_097d699dc16179206ccb7e4aee863d6523cd471c">
    <div class="span6"><div class="diff"><div class=""> ``request.env.wsgi_url_scheme`` | ``http``</div><div class=""> --------</div><div class=""> </div><div class=""> Which environment variables are actually defined depends on the web server. Here we are assuming the built-in Rocket wsgi server. The set of variables is not much different when using the Apache web server.</div><div class=""> </div><div class=""> The ``request.env.http_*`` variables are parsed from the request HTTP header.</div><div class=""> </div><div class=""> The ``request.env.web2py_*`` variables are not parsed from the web server environment, but are created by web2py in case your applications need to know about the web2py location and version, and whether it is running on the Google App Engine (because specific optimizations may be necessary).</div><div class=""> </div><div class=""> Also notice the ``request.env.wsgi_*`` variables. They are specific to the wsgi adapter.</div><div class=""> </div><div class=""> ### ``response``</div><div class=""> ``response``:inxx</div><div class=""> ``response.body``:inxx</div><div class=""> ``response.cookies``:inxx</div><div class=""> ``response.download``:inxx</div><div class=""> ``response.files``:inxx</div><div class=""> ``response.flash``:inxx</div><div class=""> ``response.headers``:inxx</div><div class=""> ``response.meta``:inxx</div><div class=""> ``response.menu``:inxx</div><div class=""> routes_onerror = [</div><div class=""> ``:code</div><div class=""> </div><div class=""> For each tuple, the first string is matched against &quot;[app name]/[error code]&quot;. If a match is found, the failed request is re-routed to the URL in the second string of the matching tuple. If the error handling URL is a not a static file, the following GET variables will be passed to the error action:</div><div class=""> - ``code``: the HTTP status code (e.g., 404, 500)</div><div class=""> - ``ticket``: in the form of &quot;[app name]/[ticket number]&quot; (or &quot;None&quot; if no ticket)</div><div class=""> - ``requested_uri``: equivalent to ``request.env.request_uri``</div><div class=""> - ``request_url``: equivalent to ``request.url``</div><div class=""> </div><div class=""> These variables will be accessible to the error handling action via ``request.vars`` and can be used in generating the error response. In particular, it is a good idea for the error action to return the original HTTP error code instead of the default 200 (OK) status code. This can be done by setting ``response.status = request.vars.code``. It is also possible to have the error action send (or queue) an email to an administrator, including a link to the ticket in ``admin``.</div><div class=""> </div><div class=""> Unmatched errors display a default error page. This default error page can also be customized here (see ``router.example.py`` and ``routes.example.py`` in the root web2py folder):</div><div class=""> ``</div><div class=""> error_message = &#x27;&lt;html&gt;&lt;body&gt;&lt;h1&gt;%s&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&#x27;</div><div class=""> error_message_ticket = &#x27;&#x27;&#x27;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Internal error&lt;/h1&gt;</div><div class="">      Ticket issued: &lt;a href=&quot;/admin/default/ticket/%(ticket)s&quot;</div><div class="">      target=&quot;_blank&quot;&gt;%(ticket)s&lt;/a&gt;&lt;/body&gt;&lt;/html&gt;&#x27;&#x27;&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class=""> The first variable contains the error message when an invalid application or function is requested. The second variable contains the error message when a ticket is issued.</div><div class=""> </div><div class="insert">``routes_onerror`` work with both routing mechanisms<span class="highlight">.</span></div><div class=""> </div><div class=""> ``error_handler``:inxx</div><div class=""> In &quot;routes.py&quot; ne can also specify an action in charge of error handling:</div><div class=""> </div><div class=""> ``</div><div class=""> error_handler = dict(application=&#x27;error&#x27;,</div><div class="">                       controller=&#x27;default&#x27;,</div><div class="">                       function=&#x27;index&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> If the ``error_handler`` is specified the action is called without user redirection and the handler action will be in charge of dealing with the error. In the event that the error-handling page itself returns an error, web2py will fall back to its old static responses.</div><div class=""> </div><div class=""> </div><div class=""> #### Static asset management</div><div class=""> </div><div class=""> Since version 2.1.0, web2py has the ability to manage static assets.</div><div class=""> </div><div class=""> When an application is in development, static file can change often, therefore web2py sends static files with no cache headers. This has the side-effect of &quot;forcing&quot; the browser to request static files at every request. This resulst in low performance when loading the page.</div><div class=""> </div><div class=""> In a &quot;production&quot; site, you may want to serve static files with ``cache`` headers to prevent un-necessary downloads since static files do not change.</div><div class=""> We cannot promise that all third party middleware will work with this mechanism.</div><div class=""> It is easy to call WSGI app from a web2py action. Here is an example:</div><div class=""> ``</div><div class=""> def test_wsgi_app(environ, start_response):</div><div class="">     &quot;&quot;&quot;this is a test WSGI app&quot;&quot;&quot;</div><div class="">     status = &#x27;200 OK&#x27;</div><div class="">     response_headers = [(&#x27;Content-type&#x27;,&#x27;text/plain&#x27;),</div><div class="">                         (&#x27;Content-Length&#x27;,&#x27;13&#x27;)]</div><div class="">     start_response(status, response_headers)</div><div class="">     return [&#x27;hello world!\n&#x27;]</div><div class=""> </div><div class=""> def index():</div><div class="">     &quot;&quot;&quot;a test action that calls the previous app and escapes output&quot;&quot;&quot;</div><div class="">     items = test_wsgi_app(request.wsgi.environ,</div><div class="">                           request.wsgi.start_response)</div><div class="">     for item in items:</div><div class="">         response.write(item,escape=False)</div><div class="">     return response.body.getvalue()</div><div class=""> ``:code</div><div class=""> </div><div class=""> In this case, the ``index`` action calls ``test_wsgi_app`` and escapes the returned value before returning it. Notice that ``index`` is not itself a WSGI app and it must use the normal web2py API (such as ``response.write`` to write to the socket).</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">-``request.env.wsgi_multiprocess`` | ``False``</div><div class="delete">-``request.env.wsgi_multithread`` | ``True``</div><div class=""> ``request.env.wsgi_url_scheme`` | ``http``</div><div class="delete">-``request.env.wsgi_version`` | ``10``</div><div class=""> --------</div><div class=""> </div><div class=""> Which environment variables are actually defined depends on the web server. Here we are assuming the built-in Rocket wsgi server. The set of variables is not much different when using the Apache web server.</div><div class=""> </div><div class=""> The ``request.env.http_*`` variables are parsed from the request HTTP header.</div><div class=""> </div><div class=""> The ``request.env.web2py_*`` variables are not parsed from the web server environment, but are created by web2py in case your applications need to know about the web2py location and version, and whether it is running on the Google App Engine (because specific optimizations may be necessary).</div><div class=""> </div><div class=""> Also notice the ``request.env.wsgi_*`` variables. They are specific to the wsgi adapter.</div><div class=""> </div><div class=""> ### ``response``</div><div class=""> ``response``:inxx</div><div class=""> ``response.body``:inxx</div><div class=""> ``response.cookies``:inxx</div><div class=""> ``response.download``:inxx</div><div class=""> ``response.files``:inxx</div><div class=""> ``response.flash``:inxx</div><div class=""> ``response.headers``:inxx</div><div class=""> ``response.meta``:inxx</div><div class=""> ``response.menu``:inxx</div><div class=""> routes_onerror = [</div><div class=""> ``:code</div><div class=""> </div><div class=""> For each tuple, the first string is matched against &quot;[app name]/[error code]&quot;. If a match is found, the failed request is re-routed to the URL in the second string of the matching tuple. If the error handling URL is a not a static file, the following GET variables will be passed to the error action:</div><div class=""> - ``code``: the HTTP status code (e.g., 404, 500)</div><div class=""> - ``ticket``: in the form of &quot;[app name]/[ticket number]&quot; (or &quot;None&quot; if no ticket)</div><div class=""> - ``requested_uri``: equivalent to ``request.env.request_uri``</div><div class=""> - ``request_url``: equivalent to ``request.url``</div><div class=""> </div><div class=""> These variables will be accessible to the error handling action via ``request.vars`` and can be used in generating the error response. In particular, it is a good idea for the error action to return the original HTTP error code instead of the default 200 (OK) status code. This can be done by setting ``response.status = request.vars.code``. It is also possible to have the error action send (or queue) an email to an administrator, including a link to the ticket in ``admin``.</div><div class=""> </div><div class=""> Unmatched errors display a default error page. This default error page can also be customized here (see ``router.example.py`` and ``routes.example.py`` in the root web2py folder):</div><div class=""> ``</div><div class=""> error_message = &#x27;&lt;html&gt;&lt;body&gt;&lt;h1&gt;%s&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&#x27;</div><div class=""> error_message_ticket = &#x27;&#x27;&#x27;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Internal error&lt;/h1&gt;</div><div class="">      Ticket issued: &lt;a href=&quot;/admin/default/ticket/%(ticket)s&quot;</div><div class="">      target=&quot;_blank&quot;&gt;%(ticket)s&lt;/a&gt;&lt;/body&gt;&lt;/html&gt;&#x27;&#x27;&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class=""> The first variable contains the error message when an invalid application or function is requested. The second variable contains the error message when a ticket is issued.</div><div class=""> </div><div class="delete">``routes_onerror`` work with both routing mechanisms<span class="highlight"></span></div><div class=""> </div><div class=""> ``error_handler``:inxx</div><div class=""> In &quot;routes.py&quot; ne can also specify an action in charge of error handling:</div><div class=""> </div><div class=""> ``</div><div class=""> error_handler = dict(application=&#x27;error&#x27;,</div><div class="">                       controller=&#x27;default&#x27;,</div><div class="">                       function=&#x27;index&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> If the ``error_handler`` is specified the action is called without user redirection and the handler action will be in charge of dealing with the error. In the event that the error-handling page itself returns an error, web2py will fall back to its old static responses.</div><div class=""> </div><div class=""> </div><div class=""> #### Static asset management</div><div class=""> </div><div class=""> Since version 2.1.0, web2py has the ability to manage static assets.</div><div class=""> </div><div class=""> When an application is in development, static file can change often, therefore web2py sends static files with no cache headers. This has the side-effect of &quot;forcing&quot; the browser to request static files at every request. This resulst in low performance when loading the page.</div><div class=""> </div><div class=""> In a &quot;production&quot; site, you may want to serve static files with ``cache`` headers to prevent un-necessary downloads since static files do not change.</div><div class=""> We cannot promise that all third party middleware will work with this mechanism.</div><div class=""> It is easy to call WSGI app from a web2py action. Here is an example:</div><div class=""> ``</div><div class=""> def test_wsgi_app(environ, start_response):</div><div class="">     &quot;&quot;&quot;this is a test WSGI app&quot;&quot;&quot;</div><div class="">     status = &#x27;200 OK&#x27;</div><div class="">     response_headers = [(&#x27;Content-type&#x27;,&#x27;text/plain&#x27;),</div><div class="">                         (&#x27;Content-Length&#x27;,&#x27;13&#x27;)]</div><div class="">     start_response(status, response_headers)</div><div class="">     return [&#x27;hello world!\n&#x27;]</div><div class=""> </div><div class=""> def index():</div><div class="">     &quot;&quot;&quot;a test action that calls the previous app and escapes output&quot;&quot;&quot;</div><div class="">     items = test_wsgi_app(request.wsgi.environ,</div><div class="">                           request.wsgi.start_response)</div><div class="">     for item in items:</div><div class="">         response.write(item,escape=False)</div><div class="">     return response.body.getvalue()</div><div class=""> ``:code</div><div class=""> </div><div class=""> In this case, the ``index`` action calls ``test_wsgi_app`` and escapes the returned value before returning it. Notice that ``index`` is not itself a WSGI app and it must use the normal web2py API (such as ``response.write`` to write to the socket).</div><div class="delete">-</div><div class="delete">-</div><div class="delete">-</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/49f38ab7ef56de1eb4ef48f68427ebf8a46b505d">49f38ab</a><ul><li>Date : 2012-12-26</li><li>more small edits</li></ul></li></ul>
<div class="row-fluid" id="com_49f38ab7ef56de1eb4ef48f68427ebf8a46b505d">
    <div class="span6"><div class="diff"><div class=""> **pyrtf**``pyrtf``:cite  for generating Rich Text Format (RTF) documents, developed by Simon Cusack and revised by Grant Edwards:</div><div class=""> ``</div><div class="insert">gluon/contrib/pyrtf/<span class="highlight"></span></div><div class=""> ``:code</div><div class=""> </div><div class=""> **PyRSS2Gen**``pyrss2gen``:cite  developed by Dalke Scientific Software, to generate RSS feeds:</div><div class=""> ``</div><div class=""> gluon/contrib/rss2.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> **simplejson**``simplejson``:cite  by Bob Ippolito, the standard library for parsing and writing JSON objects:</div><div class=""> ``</div><div class="insert">gluon/contrib/simplejson/<span class="highlight"></span></div><div class=""> ``:code</div><div class=""> </div><div class=""> **Google Wallet** ``googlewallet``:cite </div><div class=""> provides &quot;pay now&quot; buttons which link Google as payment processor:</div><div class=""> ``</div><div class=""> gluon/contrib/google_wallet.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> **Stripe.com** ``stripe``:cite provides a simple API for accepting credit card payments:</div><div class=""> ``</div><div class=""> gluon/contrib/stripe.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> **AuthorizeNet** ``authorizenet``:cite  provides API to accept credit card payments via Authorize.net network</div><div class=""> ``</div><div class=""> gluon/contrib/AuthorizeNet.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> **Dowcommerce** ``dowcommerce``:cite credit cart processing API:</div><div class=""> ``</div><div class=""> gluon/contrib/DowCommerce.py</div><div class=""> ``:code</div><div class=""> </div><div class="insert"><span class="highlight"></span>**PaymentTech** credit cart processing API:</div><div class=""> </div><div class=""> ``</div><div class=""> gluon/contrib/paymentech.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> **PAM**``PAM``:cite  authentication API created by Chris AtLee:</div><div class=""> ``</div><div class=""> gluon/contrib/pam.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> A Bayesian classifier to populate the database with dummy data for testing purposes:</div><div class=""> ``</div><div class=""> gluon/contrib/populate.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> A file with API for running on Heroku.com ``heroku``:inxx:</div><div class=""> </div><div class=""> ``</div><div class=""> gluon/contrib/heroku.py</div><div class=""> ``:code</div><div class=""> current.auth = auth</div><div class=""> </div><div class=""> and now all modules imported can access</div><div class=""> </div><div class=""> - ``current.auth``</div><div class=""> </div><div class=""> ``current`` and ``import`` create a powerful mechanism to build extensible and reusable modules for your applications.</div><div class=""> </div><div class=""> -------</div><div class=""> There is one major caveat. Given ``from gluon import current``, it is correct to use ``current.request`` and any of the other thread local objects but one should never assign them to global variables in the module, such as in</div><div class=""> ``</div><div class=""> request = current.request # WRONG! DANGER!</div><div class=""> ``</div><div class=""> nor one should use it assign class attributes</div><div class=""> ``</div><div class=""> class MyClass:</div><div class="">     request = current.request # WRONG! DANGER!</div><div class=""> ``</div><div class=""> This is because the thread local object must be extracted at runtime. Global variables instead are defined only once when the model is imported for the first time.</div><div class=""> -------</div><div class=""> </div><div class="insert">+Another caveat has to do with cache. You cannot use the ``cache`` object to decorate functions in modules, that is because it would not behave as expected. In order to cache a function ``f`` in a module you must user ``lazy_cache``:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+from gluon.cache import lazy_cache</div><div class="insert">+</div><div class="insert">+lazy_cache(&#x27;key&#x27;, time_expire=60, cache_model=&#x27;ram&#x27;)</div><div class="insert">+def f(a,b,c,): ....</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Mind that the key is user defined but must be uniquely associated to the function. If omitted web2py will automatically determine a key.</div><div class=""> </div><div class=""> ### ``request``</div><div class=""> ``request``:inxx ``Storage``:inxx ``request.cookies``:inxx ``user_agent``:inxx</div><div class=""> </div><div class=""> The ``request`` object is an instance of the ubiquitous web2py class that is called ``gluon.storage.Storage``, which extends the Python ``dict`` class. It is basically a dictionary, but the item values can also be accessed as attributes:</div><div class=""> ``</div><div class=""> request.vars</div><div class=""> ``:code</div><div class=""> </div><div class=""> is the same as:</div><div class=""> ``</div><div class=""> request[&#x27;vars&#x27;]</div><div class=""> ``:code</div><div class=""> </div><div class=""> Unlike a dictionary, if an attribute (or key) does not exist, it does not raise an exception. Instead, it returns ``None``.</div><div class=""> </div><div class=""> -----</div><div class=""> It is sometimes useful to create your own Storage objects. You can do so as follows:</div><div class=""> ``</div><div class=""> from gluon.storage import Storage</div><div class=""> my_other_storage = Storage(dict(a=1, b=2)) # convert dictionary to Storage</div><div class=""> - ``request.global_settings`` ``request.global_settings``:inxx contains web2py wide system settings. They are set automatically automatically and you should not change them. For example ``request.global_settings.gluon_parent`` contains the full path to the web2py folder, ``request.global_settings.is_pypy`` determines if web2py is running on PyPy.</div><div class=""> </div><div class=""> - ``request.wsgi`` is a hook that allows you to call third party WSGI applications from inside actions</div><div class=""> </div><div class=""> The latter includes:</div><div class=""> - ``request.wsgi.environ``</div><div class=""> - ``request.wsgi.start_response``</div><div class=""> - ``request.wsgi.middleware``</div><div class=""> their usage is discussed at the end of this Chapter.</div><div class=""> </div><div class=""> As an example, the following call on a typical system:</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/examples/default/status/x/y/z?p=1&amp;q=2</div><div class=""> ``:code</div><div class=""> </div><div class=""> results in the following ``request`` object:</div><div class=""> ``request``:inxx ``env``:inxx</div><div class=""> </div><div class=""> ----------</div><div class="insert">+**variable** | **value**</div><div class="insert">+``request.application`` | ``examples``</div><div class="insert">+``request.controller`` | ``default``</div><div class="insert">+``request.function`` | ``index``</div><div class="insert">+``request.extension`` | ``html``</div><div class="insert">+``request.view`` | ``status``</div><div class="insert">+``request.folder`` | ``applications/examples/``</div><div class="insert">+``request.args`` | ``[&#x27;x&#x27;, &#x27;y&#x27;, &#x27;z&#x27;]``</div><div class="insert">+``request.vars`` | ``&lt;Storage {&#x27;p&#x27;: 1, &#x27;q&#x27;: 2}&gt;``</div><div class="insert">+``request.get_vars`` | ``&lt;Storage {&#x27;p&#x27;: 1, &#x27;q&#x27;: 2}&gt;``</div><div class="insert">+``request.post_vars`` | ``&lt;Storage {}&gt;``</div><div class="insert">+``request.is_local`` | ``False``</div><div class="insert">+``request.is_https`` | ``False``</div><div class="insert">+``request.ajax`` | ``False``</div><div class="insert">+``request.cid`` | ``None``</div><div class="insert">+``request.wsgi`` | ``&lt;hook&gt;``</div><div class="insert">+``request.env.content_length`` | ``0``</div><div class="insert">+``request.env.content_type`` | ````</div><div class="insert">+``request.env.http_accept`` | ``text/xml,text/html;``</div><div class="insert">+``request.env.http_accept_encoding`` | ``gzip, deflate``</div><div class="insert">+``request.env.http_accept_language`` | ``en``</div><div class="insert">+``request.env.http_cookie`` | ``session_id_examples=127.0.0.1.119725``</div><div class="insert">+``request.env.http_host`` | ``127.0.0.1:8000``</div><div class="insert">+``request.env.http_referer`` | ``http://web2py.com/``</div><div class="insert">+``request.env.http_user_agent`` | ``Mozilla/5.0``</div><div class="insert">+``request.env.path_info`` | ``/examples/simple_examples/status``</div><div class="insert">+``request.env.query_string`` | ``remote_addr:127.0.0.1``</div><div class="insert">+``request.env.request_method`` | ``GET``</div><div class="insert">+``request.env.script_name`` | ````</div><div class="insert">+``request.env.server_name`` | ``127.0.0.1``</div><div class="insert">+``request.env.server_port`` | ``8000``</div><div class="insert">+``request.env.server_protocol`` | ``HTTP/1.1``</div><div class="insert">+``request.env.server_software`` | ``Rocket 1.2.6``</div><div class="insert">+``request.env.web2py_path`` | ``/Users/mdipierro/web2py``</div><div class="insert">+``request.env.web2py_version`` | ``Version 2.4.1``</div><div class="insert">+``request.env.wsgi_errors`` | ``&lt;open file, mode &#x27;w&#x27; at &gt;``</div><div class="insert">+``request.env.wsgi_input`` | ````</div><div class="insert">+``request.env.wsgi_multiprocess`` | ``False``</div><div class="insert">+``request.env.wsgi_multithread`` | ``True``</div><div class="insert">+``request.env.wsgi_url_scheme`` | ``http``</div><div class="insert">+``request.env.wsgi_version`` | ``10``</div><div class=""> --------</div><div class=""> </div><div class=""> Which environment variables are actually defined depends on the web server. Here we are assuming the built-in Rocket wsgi server. The set of variables is not much different when using the Apache web server.</div><div class=""> </div><div class=""> The ``request.env.http_*`` variables are parsed from the request HTTP header.</div><div class=""> </div><div class=""> The ``request.env.web2py_*`` variables are not parsed from the web server environment, but are created by web2py in case your applications need to know about the web2py location and version, and whether it is running on the Google App Engine (because specific optimizations may be necessary).</div><div class=""> </div><div class="insert">Also notice the ``request.env.wsgi_*`` variables. They are specific to the wsgi adapt<span class="highlight">e</span>r.</div><div class=""> </div><div class=""> ### ``response``</div><div class=""> ``response``:inxx</div><div class=""> ``response.body``:inxx</div><div class=""> ``response.cookies``:inxx</div><div class=""> ``response.download``:inxx</div><div class=""> ``response.files``:inxx</div><div class=""> ``response.flash``:inxx</div><div class=""> ``response.headers``:inxx</div><div class=""> ``response.meta``:inxx</div><div class=""> ``response.menu``:inxx</div><div class=""> ``response.postprocessing``:inxx</div><div class=""> ``response.render``:inxx</div><div class=""> ``response.status``:inxx</div><div class=""> ``response.stream``:inxx</div><div class=""> ``response.subtitle``:inxx</div><div class=""> ``response.title``:inxx</div><div class=""> ``response.toolbar``:inxx</div><div class=""> ``response.view``:inxx</div><div class=""> ``response.delimiters``:inxx</div><div class=""> into this:</div><div class=""> location ~* /(\w+)/static(?:/_[\d]+\.[\d]+\.[\d]+)?/(.*)$ {</div><div class="">    alias /home/www-data/web2py/applications/$1/static/$2;</div><div class="">    expires max;</div><div class=""> }</div><div class=""> ``</div><div class=""> </div><div class=""> ### Running tasks in the background</div><div class=""> </div><div class=""> In web2py, every http request is served in its own thread. Threads are recycled for efficiency and managed by the web server. For security, the web server sets a time-out on each request. This means that actions should not run tasks that take too long, should not create new threads, and should not fork processes (it is possible but not recommended).</div><div class=""> </div><div class=""> The proper way to run time-consuming tasks is doing it in the background. There is not a single was of doing it, but here we describe three mechanisms that are built into web2py: **cron**, **homemade task queues**, and **scheduler**.</div><div class=""> </div><div class=""> By **cron** we refer to a web2py functionality not to the Unix Cron mechanism. The web2py cron works on windows too.</div><div class=""> </div><div class=""> web2py cron is the way to go if you need tasks in the background at scheduled times and these tasks take a relatively short time compared to the time interval between two calls. Each task runs in its own process, and multiple tasks can run concurrently, but you have no control over how many tasks run. If accidentally one task overlaps with itself, it can cause a database lock and a spike in memory usage.</div><div class=""> </div><div class=""> web2py scheduler takes a different approach. The number of running processes is fixed, and they can run on different machines. Each process is called a worker. Each worker picks a task when available and executes it as soon as possible after the time when it is scheduled to run, but not necessarily at that exact time. There cannot be more processes running than the number of scheduled tasks and therefore no memory spikes. Scheduler tasks can be defined in models and are stored in the database. The web2py scheduler does not implement a distributed queue since it assumes that the time to distribute tasks is negligible compared with the time to run the tasks. Workers pick up the task from the database.</div><div class=""> </div><div class=""> Homemade tasks queues can be a simpler alternative to the web2py scheduler in some cases.</div><div class=""> </div><div class="insert">#### <span class="highlight"></span>Cron<span class="highlight"></span></div><div class=""> ``cron``:inxx</div><div class=""> </div><div class=""> The web2py cron provides the ability for applications to execute tasks at preset times, in a platform-independent manner.</div><div class=""> </div><div class=""> For each application, cron functionality is defined by a crontab file:</div><div class=""> </div><div class=""> ``</div><div class=""> app/cron/crontab</div><div class=""> ``</div><div class=""> </div><div class=""> It follows the syntax defined in ref. ``cron``:cite (with some extensions that are specific to web2py).</div><div class=""> </div><div class=""> ------</div><div class=""> Before web2py 2.1.1, cron was enabled by default and could be disabled with the ``-N`` command line option, Since 2.1.1, cron is disabled by default and can be enabled by the ``-Y`` option. This change was motivated by the desire to push users toward using the new scheduler (which is superior to the cron mechanism) and also because cron may impact on performance.</div><div class=""> ------</div><div class=""> </div><div class=""> This means that every application can have a separate cron configuration and that cron config can be changed from within web2py without affecting the host OS itself.</div><div class=""> </div><div class=""> Here is an example:</div><div class=""> ``</div><div class=""> This file is self documenting, so you should open it and read it.</div><div class=""> To create a configurable logger for application &quot;myapp&quot;, you must add myapp to</div><div class=""> the [loggers] keys list:</div><div class=""> </div><div class=""> ``</div><div class=""> [loggers]</div><div class=""> keys=root,rocket,markdown,web2py,rewrite,app,welcome,myapp</div><div class=""> ``:code</div><div class=""> </div><div class=""> and you must add a [logger_myapp] section, using [logger_welcome] as a starting point.</div><div class=""> </div><div class=""> ``</div><div class=""> [logger_myapp]</div><div class=""> level=WARNING</div><div class=""> qualname=web2py.app.myapp</div><div class=""> handlers=consoleHandler</div><div class=""> propagate=0</div><div class=""> ``:code</div><div class=""> </div><div class=""> The &quot;handlers&quot; directive specifies the type of logging and here it is logging &quot;myapp&quot; to the console.</div><div class=""> </div><div class="insert">### <span class="highlight"></span>WSGI<span class="highlight"></span></div><div class=""> ``WSGI``:inxx</div></div></div>
    <div class="span6"><div class="diff"><div class=""> **pyrtf**``pyrtf``:cite  for generating Rich Text Format (RTF) documents, developed by Simon Cusack and revised by Grant Edwards:</div><div class=""> ``</div><div class="delete">-gluon/contrib/pyrtf</div><div class="delete">-gluon/contrib/pyrtf/__init__.py</div><div class="delete">-gluon/contrib/pyrtf/Constants.py</div><div class="delete">-gluon/contrib/pyrtf/Elements.py</div><div class="delete">-gluon/contrib/pyrtf/PropertySets.py</div><div class="delete">-gluon/contrib/pyrtf/README</div><div class="delete">-gluon/contrib/pyrtf/Renderer.py</div><div class="delete">gluon/contrib/pyrtf/<span class="highlight">Styles.py</span></div><div class=""> ``:code</div><div class=""> </div><div class=""> **PyRSS2Gen**``pyrss2gen``:cite  developed by Dalke Scientific Software, to generate RSS feeds:</div><div class=""> ``</div><div class=""> gluon/contrib/rss2.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> **simplejson**``simplejson``:cite  by Bob Ippolito, the standard library for parsing and writing JSON objects:</div><div class=""> ``</div><div class="delete">-gluon/contrib/simplejson/__init__.py</div><div class="delete">-gluon/contrib/simplejson/decoder.py</div><div class="delete">-gluon/contrib/simplejson/encoder.py</div><div class="delete">-gluon/contrib/simplejson/jsonfilter.py</div><div class="delete">gluon/contrib/simplejson/<span class="highlight">scanner.py</span></div><div class=""> ``:code</div><div class=""> </div><div class=""> **Google Wallet** ``googlewallet``:cite </div><div class=""> provides &quot;pay now&quot; buttons which link Google as payment processor:</div><div class=""> ``</div><div class=""> gluon/contrib/google_wallet.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> **Stripe.com** ``stripe``:cite provides a simple API for accepting credit card payments:</div><div class=""> ``</div><div class=""> gluon/contrib/stripe.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> **AuthorizeNet** ``authorizenet``:cite  provides API to accept credit card payments via Authorize.net network</div><div class=""> ``</div><div class=""> gluon/contrib/AuthorizeNet.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> **Dowcommerce** ``dowcommerce``:cite credit cart processing API:</div><div class=""> ``</div><div class=""> gluon/contrib/DowCommerce.py</div><div class=""> ``:code</div><div class=""> </div><div class="delete"><span class="highlight">and </span>**PaymentTech** credit cart processing API:</div><div class=""> </div><div class=""> ``</div><div class=""> gluon/contrib/paymentech.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> **PAM**``PAM``:cite  authentication API created by Chris AtLee:</div><div class=""> ``</div><div class=""> gluon/contrib/pam.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> A Bayesian classifier to populate the database with dummy data for testing purposes:</div><div class=""> ``</div><div class=""> gluon/contrib/populate.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> A file with API for running on Heroku.com ``heroku``:inxx:</div><div class=""> </div><div class=""> ``</div><div class=""> gluon/contrib/heroku.py</div><div class=""> ``:code</div><div class=""> current.auth = auth</div><div class=""> </div><div class=""> and now all modules imported can access</div><div class=""> </div><div class=""> - ``current.auth``</div><div class=""> </div><div class=""> ``current`` and ``import`` create a powerful mechanism to build extensible and reusable modules for your applications.</div><div class=""> </div><div class=""> -------</div><div class=""> There is one major caveat. Given ``from gluon import current``, it is correct to use ``current.request`` and any of the other thread local objects but one should never assign them to global variables in the module, such as in</div><div class=""> ``</div><div class=""> request = current.request # WRONG! DANGER!</div><div class=""> ``</div><div class=""> nor one should use it assign class attributes</div><div class=""> ``</div><div class=""> class MyClass:</div><div class="">     request = current.request # WRONG! DANGER!</div><div class=""> ``</div><div class=""> This is because the thread local object must be extracted at runtime. Global variables instead are defined only once when the model is imported for the first time.</div><div class=""> -------</div><div class=""> </div><div class=""> </div><div class=""> ### ``request``</div><div class=""> ``request``:inxx ``Storage``:inxx ``request.cookies``:inxx ``user_agent``:inxx</div><div class=""> </div><div class=""> The ``request`` object is an instance of the ubiquitous web2py class that is called ``gluon.storage.Storage``, which extends the Python ``dict`` class. It is basically a dictionary, but the item values can also be accessed as attributes:</div><div class=""> ``</div><div class=""> request.vars</div><div class=""> ``:code</div><div class=""> </div><div class=""> is the same as:</div><div class=""> ``</div><div class=""> request[&#x27;vars&#x27;]</div><div class=""> ``:code</div><div class=""> </div><div class=""> Unlike a dictionary, if an attribute (or key) does not exist, it does not raise an exception. Instead, it returns ``None``.</div><div class=""> </div><div class=""> -----</div><div class=""> It is sometimes useful to create your own Storage objects. You can do so as follows:</div><div class=""> ``</div><div class=""> from gluon.storage import Storage</div><div class=""> my_other_storage = Storage(dict(a=1, b=2)) # convert dictionary to Storage</div><div class=""> - ``request.global_settings`` ``request.global_settings``:inxx contains web2py wide system settings. They are set automatically automatically and you should not change them. For example ``request.global_settings.gluon_parent`` contains the full path to the web2py folder, ``request.global_settings.is_pypy`` determines if web2py is running on PyPy.</div><div class=""> </div><div class=""> - ``request.wsgi`` is a hook that allows you to call third party WSGI applications from inside actions</div><div class=""> </div><div class=""> The latter includes:</div><div class=""> - ``request.wsgi.environ``</div><div class=""> - ``request.wsgi.start_response``</div><div class=""> - ``request.wsgi.middleware``</div><div class=""> their usage is discussed at the end of this Chapter.</div><div class=""> </div><div class=""> As an example, the following call on a typical system:</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/examples/default/status/x/y/z?p=1&amp;q=2</div><div class=""> ``:code</div><div class=""> </div><div class=""> results in the following ``request`` object:</div><div class=""> ``request``:inxx ``env``:inxx</div><div class=""> </div><div class=""> ----------</div><div class="delete">-variable | value</div><div class="delete">-request.application | examples</div><div class="delete">-request.controller | default</div><div class="delete">-request.function | index</div><div class="delete">-request.extension | html</div><div class="delete">-request.view | status</div><div class="delete">-request.folder | applications/examples/</div><div class="delete">-request.args | [&#x27;x&#x27;, &#x27;y&#x27;, &#x27;z&#x27;]</div><div class="delete">-request.vars | &lt;Storage {&#x27;p&#x27;: 1, &#x27;q&#x27;: 2}&gt;</div><div class="delete">-request.get_vars | &lt;Storage {&#x27;p&#x27;: 1, &#x27;q&#x27;: 2}&gt;</div><div class="delete">-request.post_vars | &lt;Storage {}&gt;</div><div class="delete">-request.is_local | False</div><div class="delete">-request.is_https | False</div><div class="delete">-request.ajax | False</div><div class="delete">-request.cid | None</div><div class="delete">-request.wsgi | hook</div><div class="delete">-request.env.content_length | 0</div><div class="delete">-request.env.content_type | ````</div><div class="delete">-request.env.http_accept | text/xml,text/html;</div><div class="delete">-request.env.http_accept_encoding | gzip, deflate</div><div class="delete">-request.env.http_accept_language | en</div><div class="delete">-request.env.http_cookie | session_id_examples=127.0.0.1.119725</div><div class="delete">-request.env.http_host | 127.0.0.1:8000</div><div class="delete">-request.env.http_max_forwards | 10</div><div class="delete">-request.env.http_referer | http://web2py.com/</div><div class="delete">-request.env.http_user_agent | Mozilla/5.0</div><div class="delete">-request.env.http_via | 1.1 web2py.com</div><div class="delete">-request.env.http_x_forwarded_for | 76.224.34.5</div><div class="delete">-request.env.http_x_forwarded_host | web2py.com</div><div class="delete">-request.env.http_x_forwarded_server | 127.0.0.1</div><div class="delete">-request.env.path_info | /examples/simple_examples/status</div><div class="delete">-request.env.query_string | remote_addr:127.0.0.1</div><div class="delete">-request.env.request_method | GET</div><div class="delete">-request.env.script_name | ````</div><div class="delete">-request.env.server_name | 127.0.0.1</div><div class="delete">-request.env.server_port | 8000</div><div class="delete">-request.env.server_protocol | HTTP/1.1</div><div class="delete">-request.env.server_software | Rocket 1.2.6</div><div class="delete">-request.env.web2py_path | /Users/mdipierro/web2py</div><div class="delete">-request.env.web2py_version | Version 2.4.1</div><div class="delete">-request.env.web2py_runtime_gae | (optional, defined only if GAE detected)</div><div class="delete">-request.env.wsgi_errors | &lt;open file, mode &#x27;w&#x27; at &gt;</div><div class="delete">-request.env.wsgi_input | ````</div><div class="delete">-request.env.wsgi_multiprocess | False</div><div class="delete">-request.env.wsgi_multithread | True</div><div class="delete">-request.env.wsgi_run_once | False</div><div class="delete">-request.env.wsgi_url_scheme | http</div><div class="delete">-request.env.wsgi_version | 10</div><div class=""> --------</div><div class=""> </div><div class=""> Which environment variables are actually defined depends on the web server. Here we are assuming the built-in Rocket wsgi server. The set of variables is not much different when using the Apache web server.</div><div class=""> </div><div class=""> The ``request.env.http_*`` variables are parsed from the request HTTP header.</div><div class=""> </div><div class=""> The ``request.env.web2py_*`` variables are not parsed from the web server environment, but are created by web2py in case your applications need to know about the web2py location and version, and whether it is running on the Google App Engine (because specific optimizations may be necessary).</div><div class=""> </div><div class="delete">Also notice the ``request.env.wsgi_*`` variables. They are specific to the wsgi adapt<span class="highlight">o</span>r.</div><div class=""> </div><div class=""> ### ``response``</div><div class=""> ``response``:inxx</div><div class=""> ``response.body``:inxx</div><div class=""> ``response.cookies``:inxx</div><div class=""> ``response.download``:inxx</div><div class=""> ``response.files``:inxx</div><div class=""> ``response.flash``:inxx</div><div class=""> ``response.headers``:inxx</div><div class=""> ``response.meta``:inxx</div><div class=""> ``response.menu``:inxx</div><div class=""> ``response.postprocessing``:inxx</div><div class=""> ``response.render``:inxx</div><div class=""> ``response.status``:inxx</div><div class=""> ``response.stream``:inxx</div><div class=""> ``response.subtitle``:inxx</div><div class=""> ``response.title``:inxx</div><div class=""> ``response.toolbar``:inxx</div><div class=""> ``response.view``:inxx</div><div class=""> ``response.delimiters``:inxx</div><div class=""> into this:</div><div class=""> location ~* /(\w+)/static(?:/_[\d]+\.[\d]+\.[\d]+)?/(.*)$ {</div><div class="">    alias /home/www-data/web2py/applications/$1/static/$2;</div><div class="">    expires max;</div><div class=""> }</div><div class=""> ``</div><div class=""> </div><div class=""> ### Running tasks in the background</div><div class=""> </div><div class=""> In web2py, every http request is served in its own thread. Threads are recycled for efficiency and managed by the web server. For security, the web server sets a time-out on each request. This means that actions should not run tasks that take too long, should not create new threads, and should not fork processes (it is possible but not recommended).</div><div class=""> </div><div class=""> The proper way to run time-consuming tasks is doing it in the background. There is not a single was of doing it, but here we describe three mechanisms that are built into web2py: **cron**, **homemade task queues**, and **scheduler**.</div><div class=""> </div><div class=""> By **cron** we refer to a web2py functionality not to the Unix Cron mechanism. The web2py cron works on windows too.</div><div class=""> </div><div class=""> web2py cron is the way to go if you need tasks in the background at scheduled times and these tasks take a relatively short time compared to the time interval between two calls. Each task runs in its own process, and multiple tasks can run concurrently, but you have no control over how many tasks run. If accidentally one task overlaps with itself, it can cause a database lock and a spike in memory usage.</div><div class=""> </div><div class=""> web2py scheduler takes a different approach. The number of running processes is fixed, and they can run on different machines. Each process is called a worker. Each worker picks a task when available and executes it as soon as possible after the time when it is scheduled to run, but not necessarily at that exact time. There cannot be more processes running than the number of scheduled tasks and therefore no memory spikes. Scheduler tasks can be defined in models and are stored in the database. The web2py scheduler does not implement a distributed queue since it assumes that the time to distribute tasks is negligible compared with the time to run the tasks. Workers pick up the task from the database.</div><div class=""> </div><div class=""> Homemade tasks queues can be a simpler alternative to the web2py scheduler in some cases.</div><div class=""> </div><div class="delete">#### <span class="highlight">&#x27;&#x27;</span>Cron<span class="highlight">&#x27;&#x27;</span></div><div class=""> ``cron``:inxx</div><div class=""> </div><div class=""> The web2py cron provides the ability for applications to execute tasks at preset times, in a platform-independent manner.</div><div class=""> </div><div class=""> For each application, cron functionality is defined by a crontab file:</div><div class=""> </div><div class=""> ``</div><div class=""> app/cron/crontab</div><div class=""> ``</div><div class=""> </div><div class=""> It follows the syntax defined in ref. ``cron``:cite (with some extensions that are specific to web2py).</div><div class=""> </div><div class=""> ------</div><div class=""> Before web2py 2.1.1, cron was enabled by default and could be disabled with the ``-N`` command line option, Since 2.1.1, cron is disabled by default and can be enabled by the ``-Y`` option. This change was motivated by the desire to push users toward using the new scheduler (which is superior to the cron mechanism) and also because cron may impact on performance.</div><div class=""> ------</div><div class=""> </div><div class=""> This means that every application can have a separate cron configuration and that cron config can be changed from within web2py without affecting the host OS itself.</div><div class=""> </div><div class=""> Here is an example:</div><div class=""> ``</div><div class=""> This file is self documenting, so you should open it and read it.</div><div class=""> To create a configurable logger for application &quot;myapp&quot;, you must add myapp to</div><div class=""> the [loggers] keys list:</div><div class=""> </div><div class=""> ``</div><div class=""> [loggers]</div><div class=""> keys=root,rocket,markdown,web2py,rewrite,app,welcome,myapp</div><div class=""> ``:code</div><div class=""> </div><div class=""> and you must add a [logger_myapp] section, using [logger_welcome] as a starting point.</div><div class=""> </div><div class=""> ``</div><div class=""> [logger_myapp]</div><div class=""> level=WARNING</div><div class=""> qualname=web2py.app.myapp</div><div class=""> handlers=consoleHandler</div><div class=""> propagate=0</div><div class=""> ``:code</div><div class=""> </div><div class=""> The &quot;handlers&quot; directive specifies the type of logging and here it is logging &quot;myapp&quot; to the console.</div><div class=""> </div><div class="delete">### <span class="highlight">&#x27;&#x27;</span>WSGI<span class="highlight">&#x27;&#x27;</span></div><div class=""> ``WSGI``:inxx</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/60ecdf04f0802a47a3fb83116d1449f8c3e6f141">60ecdf0</a><ul><li>Date : 2012-12-26</li><li>added wiki info</li></ul></li></ul>
<div class="row-fluid" id="com_60ecdf04f0802a47a3fb83116d1449f8c3e6f141">
    <div class="span6"><div class="diff"><div class="insert">### <span class="highlight"></span>Cookies<span class="highlight"></span></div></div></div>
    <div class="span6"><div class="diff"><div class="delete">### <span class="highlight">&#x27;&#x27;</span>Cookies<span class="highlight">&#x27;&#x27; </span></div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/eaaa0e14bf17cdc4d0edd2ea9daa9af5f3484c09">eaaa0e1</a><ul><li>Date : 2012-12-25</li><li>changes to style</li></ul></li></ul>
<div class="row-fluid" id="com_eaaa0e14bf17cdc4d0edd2ea9daa9af5f3484c09">
    <div class="span6"><div class="diff"><div class="insert"><span class="highlight">#</span>### Routes on error</div><div class=""> ``routes_onerror``:inxx</div><div class=""> </div><div class=""> You can also use ``routes.py`` to re-route requests to special actions in case there is an error on the server. You can specify this mapping globally, for each app, for each error code, or for each app and error code. Here is an example:</div><div class=""> ``</div><div class=""> routes_onerror = [</div><div class="">   (&#x27;init/400&#x27;, &#x27;/init/default/login&#x27;),</div><div class="">   (&#x27;init/*&#x27;, &#x27;/init/static/fail.html&#x27;),</div><div class="">   (&#x27;*/404&#x27;, &#x27;/init/static/cantfind.html&#x27;),</div><div class="">   (&#x27;*/*&#x27;, &#x27;/init/error/index&#x27;)</div><div class=""> ]</div><div class=""> ``:code</div><div class=""> </div><div class=""> For each tuple, the first string is matched against &quot;[app name]/[error code]&quot;. If a match is found, the failed request is re-routed to the URL in the second string of the matching tuple. If the error handling URL is a not a static file, the following GET variables will be passed to the error action:</div><div class=""> - ``code``: the HTTP status code (e.g., 404, 500)</div><div class=""> - ``ticket``: in the form of &quot;[app name]/[ticket number]&quot; (or &quot;None&quot; if no ticket)</div><div class=""> - ``requested_uri``: equivalent to ``request.env.request_uri``</div><div class=""> - ``request_url``: equivalent to ``request.url``</div><div class=""> </div><div class=""> These variables will be accessible to the error handling action via ``request.vars`` and can be used in generating the error response. In particular, it is a good idea for the error action to return the original HTTP error code instead of the default 200 (OK) status code. This can be done by setting ``response.status = request.vars.code``. It is also possible to have the error action send (or queue) an email to an administrator, including a link to the ticket in ``admin``.</div><div class=""> </div><div class=""> error_message_ticket = &#x27;&#x27;&#x27;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Internal error&lt;/h1&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> The first variable contains the error message when an invalid application or function is requested. The second variable contains the error message when a ticket is issued.</div><div class=""> </div><div class=""> -------</div><div class=""> ``routes_onerror`` work with both routing mechanisms</div><div class=""> -------</div><div class=""> </div><div class=""> ``error_handler``:inxx</div><div class=""> In &quot;routes.py&quot; ne can also specify an action in charge of error handling:</div><div class=""> </div><div class=""> ``</div><div class=""> error_handler = dict(application=&#x27;error&#x27;,                                               </div><div class="">                       controller=&#x27;default&#x27;,                                              </div><div class="">                       function=&#x27;index&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> If the ``error_handler`` is specified the action is called without user redirection and the handler action will be in charge of dealing with the error. In the event that the error-handling page itself returns an error, web2py will fall back to its old static responses.</div><div class=""> </div><div class=""> </div><div class="insert"><span class="highlight">#</span>### Static asset management</div></div></div>
    <div class="span6"><div class="diff"><div class="delete"><span class="highlight"></span>### Routes on error</div><div class=""> ``routes_onerror``:inxx</div><div class=""> </div><div class=""> You can also use ``routes.py`` to re-route requests to special actions in case there is an error on the server. You can specify this mapping globally, for each app, for each error code, or for each app and error code. Here is an example:</div><div class=""> ``</div><div class=""> routes_onerror = [</div><div class="">   (&#x27;init/400&#x27;, &#x27;/init/default/login&#x27;),</div><div class="">   (&#x27;init/*&#x27;, &#x27;/init/static/fail.html&#x27;),</div><div class="">   (&#x27;*/404&#x27;, &#x27;/init/static/cantfind.html&#x27;),</div><div class="">   (&#x27;*/*&#x27;, &#x27;/init/error/index&#x27;)</div><div class=""> ]</div><div class=""> ``:code</div><div class=""> </div><div class=""> For each tuple, the first string is matched against &quot;[app name]/[error code]&quot;. If a match is found, the failed request is re-routed to the URL in the second string of the matching tuple. If the error handling URL is a not a static file, the following GET variables will be passed to the error action:</div><div class=""> - ``code``: the HTTP status code (e.g., 404, 500)</div><div class=""> - ``ticket``: in the form of &quot;[app name]/[ticket number]&quot; (or &quot;None&quot; if no ticket)</div><div class=""> - ``requested_uri``: equivalent to ``request.env.request_uri``</div><div class=""> - ``request_url``: equivalent to ``request.url``</div><div class=""> </div><div class=""> These variables will be accessible to the error handling action via ``request.vars`` and can be used in generating the error response. In particular, it is a good idea for the error action to return the original HTTP error code instead of the default 200 (OK) status code. This can be done by setting ``response.status = request.vars.code``. It is also possible to have the error action send (or queue) an email to an administrator, including a link to the ticket in ``admin``.</div><div class=""> </div><div class=""> error_message_ticket = &#x27;&#x27;&#x27;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Internal error&lt;/h1&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> The first variable contains the error message when an invalid application or function is requested. The second variable contains the error message when a ticket is issued.</div><div class=""> </div><div class=""> -------</div><div class=""> ``routes_onerror`` work with both routing mechanisms</div><div class=""> -------</div><div class=""> </div><div class=""> ``error_handler``:inxx</div><div class=""> In &quot;routes.py&quot; ne can also specify an action in charge of error handling:</div><div class=""> </div><div class=""> ``</div><div class=""> error_handler = dict(application=&#x27;error&#x27;,                                               </div><div class="">                       controller=&#x27;default&#x27;,                                              </div><div class="">                       function=&#x27;index&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> If the ``error_handler`` is specified the action is called without user redirection and the handler action will be in charge of dealing with the error. In the event that the error-handling page itself returns an error, web2py will fall back to its old static responses.</div><div class=""> </div><div class=""> </div><div class="delete"><span class="highlight"></span>### Static asset management</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/28816a98948c4a6577f73bdeb2b7424dc55d2582">28816a9</a><ul><li>Date : 2012-12-23</li><li>code building book</li></ul></li></ul>
<div class="row-fluid" id="com_28816a98948c4a6577f73bdeb2b7424dc55d2582">
    <div class="span6"><div class="diff"><div class="insert">[[scheduler tasks <span class="highlight">@</span>//<span class="highlight">/i</span>m<span class="highlight">ag</span>e/ce8edcc3.<span class="highlight"></span>p<span class="highlight">n</span>g center]]</div><div class=""> </div><div class=""> Let&#x27;s go with order. By default, when you send a task to the scheduler, you&#x27;ll want that to be executed. It&#x27;s in **QUEUED** status.</div><div class=""> If you need it to be executed later, use the ``start_time`` parameter (default = now).</div><div class=""> If for some reason you need to be sure that the task don&#x27;t get executed after a certain point in time (maybe a request to a webservice</div><div class=""> that shuts down at 1AM, a mail that needs to be sent not after the working hours, etc...) you can set a ``stop_time`` (default = None) for it.</div><div class=""> If your task is NOT picked up by a worker before stop_time, it will be set as **EXPIRED**.</div><div class=""> Tasks with no stop_time set or picked up **BEFORE** stop_time are **ASSIGNED** to a worker. When a workers picks up them, they become **RUNNING**.</div><div class=""> **RUNNING** tasks may end up:</div><div class=""> - **TIMEOUT** when more than n seconds passed with ``timeout`` parameter (default = 60 seconds)</div><div class=""> - **FAILED** when an exception is detected</div><div class=""> - **COMPLETED** when all went ok</div><div class=""> </div><div class=""> Additionally, you can control how many times a task should be repeated (i.e. you need to aggregate some data at specified intervals). To do so, set the ``repeats``</div><div class=""> parameter (default = 1 time only, 0 = unlimited). You can influence how many seconds should pass between executions with the ``period`` parameter (default = 60 seconds).</div><div class=""> NB: the time is not calculated between the END of the first round and the START of the next, but from the START time of the first round to the START time of the next cycle)</div><div class=""> </div><div class=""> Another nice addition, you can set how many times the function can raise an exception (i.e. requesting data from a sloooow webservice) and be queued again instead of stopping in **FAILED**  status with the parameter ``retry_failed`` (default = 0, -1 = unlimited).</div><div class=""> </div><div class="insert">[[task repeats <span class="highlight">@</span>//<span class="highlight">/i</span>m<span class="highlight">ag</span>e/7d8b85e4.<span class="highlight"></span>p<span class="highlight">n</span>g center]]</div><div class=""> </div><div class=""> Summary: you have</div><div class=""> - ``period`` and ``repeats`` to get an automatically rescheduled function</div><div class=""> - ``timeout`` to be sure that a function doesn&#x27;t exceed a certain amount of time</div><div class=""> - ``retry_failed`` to control how many times the task can &quot;fail&quot;</div><div class=""> - ``start_time`` and ``stop_time`` to schedule a function in a restricted timeframe</div><div class=""> </div><div class=""> </div><div class=""> ##### Results and output</div><div class=""> The table &quot;scheduler_run&quot; stores the status of all running tasks. Each record references a task that has been picked up by a worker.  One task can have multiple runs. For example, a task scheduled to repeat 10 times an hour will probably have 10 runs (unless one fails or they take longer than 1 hour). Beware that if the task has no return values, it is removed from the scheduler_run table as soon as it is finished.</div><div class=""> </div><div class=""> Possible run statuses are:</div><div class=""> </div><div class=""> ``</div><div class=""> RUNNING, COMPLETED, FAILED, TIMEOUT</div><div class=""> ``</div><div class=""> </div><div class=""> If the run is completed, no exceptions are thrown, and there is no task timeout, the run is marked as ``COMPLETED`` and the task is marked as ``QUEUED`` or ``COMPLETED`` depending on whether it is supposed to run again at a later time. The output of the task is serialized in JSON and stored in the run record.</div><div class=""> </div><div class=""> When a ``RUNNING`` task throws an exception, the run is mark as ``FAILED`` and the task is marked as ``FAILED``. The traceback is stored in the run record.</div><div class=""> The scheduler also creates one more table called &quot;scheduler_worker&quot;, which store</div><div class=""> </div><div class=""> ##### Managing processes</div><div class=""> Worker fine management is hard. This module tries not to leave behind any platform (Mac, Win, Linux) .</div><div class=""> </div><div class=""> When you start a worker, you may want later to:</div><div class=""> - kill it &quot;no matter what it&#x27;s doing&quot;</div><div class=""> - kill it only if it&#x27;s not processing tasks</div><div class=""> - put it to sleep</div><div class=""> Maybe you have yet some tasks queued, and you want to save some resources.</div><div class=""> You know you want them processed every hour, so, you&#x27;ll want to:</div><div class=""> - process all queued tasks and die automatically</div><div class=""> All of these things are possible managing ``Scheduler`` parameters or the ``scheduler_worker`` table.</div><div class=""> To be more precise, for started workers you will change the ``status`` value of any worker to influence</div><div class=""> its behavior.</div><div class=""> As tasks, workers can be in some fixed statuses : ACTIVE, DISABLED, TERMINATE or KILLED.</div><div class=""> </div><div class=""> **ACTIVE** and **DISABLED** are &quot;persistent&quot;, while **TERMINATE** or **KILL**, as statuses</div><div class=""> name suggest, are more &quot;commands&quot; than real statuses.</div><div class=""> Hitting ctrl+c is equal to set a worker to **KILL**</div><div class=""> </div><div class="insert">[[workers statuses <span class="highlight">@</span>//<span class="highlight">/i</span>m<span class="highlight">ag</span>e/bd891eed.<span class="highlight"></span>p<span class="highlight">n</span>g center]]</div><div class=""> </div><div class=""> Everything that one can do via appadmin one can do programmatically by inserting and updating records in these tables.</div><div class=""> </div><div class=""> Anyway, one should not update records relative to ``RUNNING`` tasks as this may create an un-expected behavior. The best practice is to queue tasks using &quot;queue_task&quot;. </div><div class=""> </div><div class=""> For example:</div><div class=""> </div><div class=""> ``</div><div class=""> scheduler.queur_task(</div><div class="">     function_name=&#x27;task_add&#x27;,</div><div class="">     pargs=[],</div><div class="">     pvars={&#x27;a&#x27;:3,&#x27;b&#x27;:4},</div><div class="">     repeats = 10, # run 10 times</div><div class="">     period = 3600, # every 1h</div><div class="">     timeout = 120, # should take less than 120 seconds</div><div class="">     )</div><div class=""> ``:code</div><div class=""> </div><div class=""> Notice that fields &quot;times_run&quot;, &quot;last_run_time&quot; and &quot;assigned_worker_name&quot; are not provided at schedule time but are filled automatically by the workers.</div><div class=""> </div><div class=""> def reporting_percentages():</div><div class="">     print &#x27;50%&#x27;</div><div class="">     time.sleep(5)</div><div class="">     print &#x27;!clear!100%&#x27;</div><div class="">     return 1</div><div class=""> ``</div><div class=""> </div><div class=""> The function ``demo6`` sleeps for 5 seconds, outputs ``50%``.</div><div class=""> Then, it sleeps other 5 seconds and outputs ``100%``. Note that the output in the scheduler_run table is synced every 2 seconds and that the second print statement that contains ``!clear!100%`` gets the ``50%`` output cleared and replaced by ``100%`` only.</div><div class=""> </div><div class=""> ``</div><div class=""> scheduler.queue_task(task_name=&#x27;reporting_percentages&#x27;, </div><div class="">                      function_name=&#x27;demo6&#x27;, sync_output=2)</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> ### Third party modules</div><div class=""> ``import``:inxx</div><div class=""> </div><div class=""> web2py is written in Python, so it can import and use any Python module, including third party modules. It just needs to be able to find them. As with any Python application, modules can be installed in the official Python &quot;site-packages&quot; directory, and they can then be imported from anywhere inside your code.</div><div class=""> </div><div class="insert">Modules in the &quot;site-packages&quot; directory are, as the name suggests, site-level packages. Applications requiring site-packages are not portable unless these modules are installed separately. The advantage of having modules in &quot;site-packages&quot; is that multiple applications can share them. Let&#x27;s consider, for example, the plotting package called &quot;matplotlib&quot;. You can install it from the shell using the PEAK ``easy_install`` command ``easy<span class="highlight">-</span>install``:cite (or its modern replacement ``pip`` ``PIP``:cite ):</div><div class=""> ``</div><div class=""> easy_install py-matplotlib</div><div class=""> ``:code</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">[[scheduler tasks <span class="highlight">http:</span>//<span class="highlight">yu</span>m<span class="highlight">l.m</span>e/ce8edcc3.<span class="highlight">j</span>p<span class="highlight"></span>g center]]</div><div class=""> </div><div class=""> Let&#x27;s go with order. By default, when you send a task to the scheduler, you&#x27;ll want that to be executed. It&#x27;s in **QUEUED** status.</div><div class=""> If you need it to be executed later, use the ``start_time`` parameter (default = now).</div><div class=""> If for some reason you need to be sure that the task don&#x27;t get executed after a certain point in time (maybe a request to a webservice</div><div class=""> that shuts down at 1AM, a mail that needs to be sent not after the working hours, etc...) you can set a ``stop_time`` (default = None) for it.</div><div class=""> If your task is NOT picked up by a worker before stop_time, it will be set as **EXPIRED**.</div><div class=""> Tasks with no stop_time set or picked up **BEFORE** stop_time are **ASSIGNED** to a worker. When a workers picks up them, they become **RUNNING**.</div><div class=""> **RUNNING** tasks may end up:</div><div class=""> - **TIMEOUT** when more than n seconds passed with ``timeout`` parameter (default = 60 seconds)</div><div class=""> - **FAILED** when an exception is detected</div><div class=""> - **COMPLETED** when all went ok</div><div class=""> </div><div class=""> Additionally, you can control how many times a task should be repeated (i.e. you need to aggregate some data at specified intervals). To do so, set the ``repeats``</div><div class=""> parameter (default = 1 time only, 0 = unlimited). You can influence how many seconds should pass between executions with the ``period`` parameter (default = 60 seconds).</div><div class=""> NB: the time is not calculated between the END of the first round and the START of the next, but from the START time of the first round to the START time of the next cycle)</div><div class=""> </div><div class=""> Another nice addition, you can set how many times the function can raise an exception (i.e. requesting data from a sloooow webservice) and be queued again instead of stopping in **FAILED**  status with the parameter ``retry_failed`` (default = 0, -1 = unlimited).</div><div class=""> </div><div class="delete">[[task repeats <span class="highlight">http:</span>//<span class="highlight">yu</span>m<span class="highlight">l.m</span>e/7d8b85e4.<span class="highlight">j</span>p<span class="highlight"></span>g center]]</div><div class=""> </div><div class=""> Summary: you have</div><div class=""> - ``period`` and ``repeats`` to get an automatically rescheduled function</div><div class=""> - ``timeout`` to be sure that a function doesn&#x27;t exceed a certain amount of time</div><div class=""> - ``retry_failed`` to control how many times the task can &quot;fail&quot;</div><div class=""> - ``start_time`` and ``stop_time`` to schedule a function in a restricted timeframe</div><div class=""> </div><div class=""> </div><div class=""> ##### Results and output</div><div class=""> The table &quot;scheduler_run&quot; stores the status of all running tasks. Each record references a task that has been picked up by a worker.  One task can have multiple runs. For example, a task scheduled to repeat 10 times an hour will probably have 10 runs (unless one fails or they take longer than 1 hour). Beware that if the task has no return values, it is removed from the scheduler_run table as soon as it is finished.</div><div class=""> </div><div class=""> Possible run statuses are:</div><div class=""> </div><div class=""> ``</div><div class=""> RUNNING, COMPLETED, FAILED, TIMEOUT</div><div class=""> ``</div><div class=""> </div><div class=""> If the run is completed, no exceptions are thrown, and there is no task timeout, the run is marked as ``COMPLETED`` and the task is marked as ``QUEUED`` or ``COMPLETED`` depending on whether it is supposed to run again at a later time. The output of the task is serialized in JSON and stored in the run record.</div><div class=""> </div><div class=""> When a ``RUNNING`` task throws an exception, the run is mark as ``FAILED`` and the task is marked as ``FAILED``. The traceback is stored in the run record.</div><div class=""> The scheduler also creates one more table called &quot;scheduler_worker&quot;, which store</div><div class=""> </div><div class=""> ##### Managing processes</div><div class=""> Worker fine management is hard. This module tries not to leave behind any platform (Mac, Win, Linux) .</div><div class=""> </div><div class=""> When you start a worker, you may want later to:</div><div class=""> - kill it &quot;no matter what it&#x27;s doing&quot;</div><div class=""> - kill it only if it&#x27;s not processing tasks</div><div class=""> - put it to sleep</div><div class=""> Maybe you have yet some tasks queued, and you want to save some resources.</div><div class=""> You know you want them processed every hour, so, you&#x27;ll want to:</div><div class=""> - process all queued tasks and die automatically</div><div class=""> All of these things are possible managing ``Scheduler`` parameters or the ``scheduler_worker`` table.</div><div class=""> To be more precise, for started workers you will change the ``status`` value of any worker to influence</div><div class=""> its behavior.</div><div class=""> As tasks, workers can be in some fixed statuses : ACTIVE, DISABLED, TERMINATE or KILLED.</div><div class=""> </div><div class=""> **ACTIVE** and **DISABLED** are &quot;persistent&quot;, while **TERMINATE** or **KILL**, as statuses</div><div class=""> name suggest, are more &quot;commands&quot; than real statuses.</div><div class=""> Hitting ctrl+c is equal to set a worker to **KILL**</div><div class=""> </div><div class="delete">[[workers statuses <span class="highlight">http:</span>//<span class="highlight">yu</span>m<span class="highlight">l.m</span>e/bd891eed.<span class="highlight">j</span>p<span class="highlight"></span>g center]]</div><div class=""> </div><div class=""> Everything that one can do via appadmin one can do programmatically by inserting and updating records in these tables.</div><div class=""> </div><div class=""> Anyway, one should not update records relative to ``RUNNING`` tasks as this may create an un-expected behavior. The best practice is to queue tasks using &quot;queue_task&quot;. </div><div class=""> </div><div class=""> For example:</div><div class=""> </div><div class=""> ``</div><div class=""> scheduler.queur_task(</div><div class="">     function_name=&#x27;task_add&#x27;,</div><div class="">     pargs=[],</div><div class="">     pvars={&#x27;a&#x27;:3,&#x27;b&#x27;:4},</div><div class="">     repeats = 10, # run 10 times</div><div class="">     period = 3600, # every 1h</div><div class="">     timeout = 120, # should take less than 120 seconds</div><div class="">     )</div><div class=""> ``:code</div><div class=""> </div><div class=""> Notice that fields &quot;times_run&quot;, &quot;last_run_time&quot; and &quot;assigned_worker_name&quot; are not provided at schedule time but are filled automatically by the workers.</div><div class=""> </div><div class=""> def reporting_percentages():</div><div class="">     print &#x27;50%&#x27;</div><div class="">     time.sleep(5)</div><div class="">     print &#x27;!clear!100%&#x27;</div><div class="">     return 1</div><div class=""> ``</div><div class=""> </div><div class=""> The function ``demo6`` sleeps for 5 seconds, outputs ``50%``.</div><div class=""> Then, it sleeps other 5 seconds and outputs ``100%``. Note that the output in the scheduler_run table is synced every 2 seconds and that the second print statement that contains ``!clear!100%`` gets the ``50%`` output cleared and replaced by ``100%`` only.</div><div class=""> </div><div class=""> ``</div><div class=""> scheduler.queue_task(task_name=&#x27;reporting_percentages&#x27;, </div><div class="">                      function_name=&#x27;demo6&#x27;, sync_output=2)</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> ### Third party modules</div><div class=""> ``import``:inxx</div><div class=""> </div><div class=""> web2py is written in Python, so it can import and use any Python module, including third party modules. It just needs to be able to find them. As with any Python application, modules can be installed in the official Python &quot;site-packages&quot; directory, and they can then be imported from anywhere inside your code.</div><div class=""> </div><div class="delete">Modules in the &quot;site-packages&quot; directory are, as the name suggests, site-level packages. Applications requiring site-packages are not portable unless these modules are installed separately. The advantage of having modules in &quot;site-packages&quot; is that multiple applications can share them. Let&#x27;s consider, for example, the plotting package called &quot;matplotlib&quot;. You can install it from the shell using the PEAK ``easy_install`` command ``easy<span class="highlight">_</span>install``:cite (or its modern replacement ``pip`` ``PIP``:cite ):</div><div class=""> ``</div><div class=""> easy_install py-matplotlib</div><div class=""> ``:code</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/b3a7d279a1568aca7ae3fe29ef436c7f924fd681">b3a7d27</a><ul><li>Date : 2012-12-23</li><li>Minor reference to deployment recipes chapter</li></ul></li></ul>
<div class="row-fluid" id="com_b3a7d279a1568aca7ae3fe29ef436c7f924fd681">
    <div class="span6"><div class="diff"><div class="insert">+More information about deploying the scheduler under Linux and Windows is in the Deployment recipes chapter.</div><div class="insert">+</div><div class=""> In the scheduler, a task is simply a function defined in a model (or in a module and imported by a model). For example:</div></div></div>
    <div class="span6"><div class="diff"><div class=""> In the scheduler, a task is simply a function defined in a model (or in a module and imported by a model). For example:</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/c4e4f430a3fe8433d95790170768d74eaf109a49">c4e4f43</a><ul><li>Date : 2012-12-22</li><li>fixed subsection level</li></ul></li></ul>
<div class="row-fluid" id="com_c4e4f430a3fe8433d95790170768d74eaf109a49">
    <div class="span6"><div class="diff"><div class="insert">+### &#x27;&#x27;Cookies&#x27;&#x27; </div><div class="insert">+</div><div class="insert">+``cookies``:inxx</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">-### &#x27;&#x27;Cookies&#x27;&#x27; ``cookies``:inxx</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/76c0363755694c36971ffc9db176312fe5c14276">76c0363</a><ul><li>Date : 2012-12-22</li><li>more and more additions and corrections</li></ul></li></ul>
<div class="row-fluid" id="com_76c0363755694c36971ffc9db176312fe5c14276">
    <div class="span6"><div class="diff"><div class="insert">There are also additional libraries, <span class="highlight"></span>s<span class="highlight">ome</span> developed by a third party:</div><div class=""> </div><div class=""> **feedparser**``feedparser``:cite  by Mark Pilgrim for reading RSS and Atom feeds:</div><div class=""> ``</div><div class=""> gluon/contrib/__init__.py</div><div class=""> gluon/contrib/feedparser.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> **markdown2**``markdown2``:cite  by Trent Mick for wiki markup:</div><div class=""> ``</div><div class=""> gluon/contrib/markdown/__init__.py</div><div class=""> gluon/contrib/markdown/markdown2.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> **markmin** markup:</div><div class=""> ``</div><div class=""> gluon/contrib/markmin</div><div class=""> ``:code</div><div class=""> </div><div class=""> **fpdf** created my Mariano Reingart for generating PDF documents:</div><div class=""> ``</div><div class=""> gluon/contrib/AuthorizeNet.py</div><div class=""> ``</div><div class=""> gluon/contrib/DowCommerce.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> and **PaymentTech** credit cart processing API:</div><div class=""> </div><div class=""> ``</div><div class=""> gluon/contrib/paymentech.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> **PAM**``PAM``:cite  authentication API created by Chris AtLee:</div><div class=""> ``</div><div class=""> gluon/contrib/pam.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> A Bayesian classifier to populate the database with dummy data for testing purposes:</div><div class=""> ``</div><div class=""> gluon/contrib/populate.py</div><div class=""> ``:code</div><div class=""> </div><div class="insert">+A file with API for running on Heroku.com ``heroku``:inxx:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+gluon/contrib/heroku.py</div><div class="insert">+``:code</div><div class="insert">+</div><div class=""> A file that allows interaction with the taskbar in windows, when web2py is running as a service:</div><div class=""> ``</div><div class=""> gluon/contrib/taskbar_widget.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> Optional **login_methods** and login_forms to be used for authentication:</div><div class=""> ``</div><div class=""> gluon/contrib/login_methods/__init__.py</div><div class=""> gluon/contrib/login_methods/basic_auth.py</div><div class=""> gluon/contrib/login_methods/browserid_account.py</div><div class=""> gluon/contrib/login_methods/cas_auth.py</div><div class=""> gluon/contrib/login_methods/dropbox_account.py</div><div class=""> gluon/contrib/login_methods/email_auth.py</div><div class=""> gluon/contrib/login_methods/extended_login_form.py</div><div class=""> gluon/contrib/login_methods/gae_google_account.py</div><div class=""> gluon/contrib/login_methods/ldap_auth.py</div><div class=""> gluon/contrib/login_methods/linkedin_account.py</div><div class=""> gluon/contrib/login_methods/loginza.py</div><div class=""> gluon/contrib/login_methods/oauth10a_account.py</div><div class=""> gluon/contrib/login_methods/oauth20_account.py</div><div class=""> gluon/contrib/login_methods/oneall_account.py</div><div class=""> gluon/contrib/login_methods/openid_auth.py</div><div class=""> gluon/contrib/login_methods/pam_auth.py</div><div class=""> gluon/contrib/login_methods/rpx_account.py</div><div class=""> gluon/contrib/login_methods/x509_auth.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> web2py also contains a folder with useful scripts including</div><div class=""> ``</div><div class=""> scripts/setup-web2py-fedora.sh</div><div class=""> scripts/setup-web2py-ubuntu.sh</div><div class=""> scripts/setup-web2py-nginx-uwsgi-ubuntu.sh</div><div class="insert">+scripts/setup-web2py-heroku.sh</div><div class=""> scripts/update-web2py.sh</div><div class=""> scripts/make_min_web2py.py</div><div class=""> ...</div><div class=""> scripts/sessions2trash.py</div><div class=""> scripts/sync_languages.py</div><div class=""> scripts/tickets2db.py</div><div class=""> scripts/tickets2email.py</div><div class=""> ...</div><div class=""> scripts/extract_mysql_models.py</div><div class=""> scripts/extract_pgsql_models.py</div><div class=""> ...</div><div class=""> scripts/access.wsgi</div><div class=""> scripts/cpdb.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> The first three are particularly useful because they attempt a complete installation and setup of a web2py production environment from scratch.</div><div class=""> Some of these are discussed in Chapter 14, but all of them contain a documentation string inside that explains their purpose and usage.</div><div class=""> </div><div class=""> Finally web2py includes these files required to build the binary distributions.</div><div class=""> ``</div><div class=""> can be retrieved at a later time:</div><div class=""> a = session.myvariable</div><div class=""> ``:code</div><div class=""> </div><div class=""> as long as the code is executed within the same session by the same user (provided the user has not deleted session cookies and the session did not expire). Because ``session`` is a ``Storage`` object, trying to access an attribute/key that has not been set does not raise an exception; it returns ``None`` instead.</div><div class=""> </div><div class=""> The session object has three important methods. One is ``forget``:</div><div class=""> ``</div><div class=""> session.forget(response)</div><div class=""> ``:code</div><div class=""> </div><div class=""> It tells web2py not to save the session. This should be used in those controllers whose actions are called often and do not need to track user activity. ``session.forget()`` prevents the session file from being written, regardless of whether it has been modified. ``session.forget(response)`` additionally unlocks and closes the session file. You rarely need to call this method since sessions are not saved when they are not changed. However, if the page makes multiple simultaneous Ajax requests, it is a good idea for the actions called via Ajax to call ``session.forget(response)`` (assuming the session is not needed by the action). Otherwise, each Ajax action will have to wait for the previous one to complete (and unlock the session file) before proceeding, which will slow down the page loading. Notice that sessions are not locked when stored in database.</div><div class=""> </div><div class=""> Another method is:</div><div class=""> </div><div class=""> ``</div><div class=""> session.secure()</div><div class=""> ``:code</div><div class=""> </div><div class=""> which tells web2py to set the session cookie to be a secure cookie. This should be set if the app is going over https. By setting the session cookie to be secure, the server is asking the browser not to send the session cookie back to the server unless over an https connection.</div><div class=""> </div><div class="insert">+The other method is ``connect``.</div><div class="insert">+By default sessions are stored on the filesystem and a session cookie is used to store and retrieve the ``session.id``. Using the connect method it is possible to tell web2y to store sessions in the database or in the cookies thus eliminating need to access the filesystem for session management.</div><div class="insert">+</div><div class="insert">+For example to **store sessions in the database**:</div><div class="insert">+</div><div class=""> ``</div><div class=""> session.connect(request, response, db, masterapp=None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> where ``db`` is the name of an open database connection (as returned by the DAL). It tells web2py that you want to store the sessions in the database and not on the filesystem. ``session.connect`` must come after ``db=DAL(...)``, but before any other logic that requires session, for example, setting up ``Auth``.</div><div class=""> </div><div class=""> web2py creates a table:</div><div class=""> ``</div><div class=""> db.define_table(&#x27;web2py_session&#x27;,</div><div class="">                  Field(&#x27;locked&#x27;, &#x27;boolean&#x27;, default=False),</div><div class="">                  Field(&#x27;client_ip&#x27;),</div><div class="">                  Field(&#x27;created_datetime&#x27;, &#x27;datetime&#x27;, default=now),</div><div class="">                  Field(&#x27;modified_datetime&#x27;, &#x27;datetime&#x27;),</div><div class="">                  Field(&#x27;unique_key&#x27;),</div><div class="">                  Field(&#x27;session_data&#x27;, &#x27;text&#x27;))</div><div class=""> ``:code</div><div class=""> </div><div class=""> and stores cPickled sessions in the ``session_data`` field.</div><div class=""> </div><div class=""> The option ``masterapp=None``, by default, tells web2py to try to retrieve an existing session for the application with name in ``request.application``, in the running application.</div><div class=""> </div><div class=""> If you want two or more applications to share sessions, set ``masterapp`` to the name of the master application.</div><div class=""> </div><div class="insert">+</div><div class="insert">+To **store sessions in cookies** instead you can do:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+session.connect(request,response,cookie_key=&#x27;yoursecret&#x27;,compression_level=None)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Here ``cookie_key`` is a symmetric encryption key.</div><div class="insert">+``compression_level`` is an optionl ``zlib`` encryption level.</div><div class="insert">+</div><div class="insert">+While sessions in cookie are often recommended for scalability reason they are limited in size. Large sessions will result in broken cookies.</div><div class="insert">+</div><div class=""> You can check the state of your application at any time by printing the ``request``, ``session`` and ``response`` system variables. One way to do it is to create a dedicated action:</div><div class=""> ``</div><div class=""> def status():</div><div class="">     return dict(request=request, session=session, response=response)</div><div class=""> ``:code</div><div class=""> </div><div class="insert">+In the &quot;generic.html&quot; view this is done using ``{{=response.toolbar()}}``.</div><div class="insert">+</div><div class="insert">+</div><div class=""> #### Separate sessions</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">There are also additional libraries, <span class="highlight">u</span>s<span class="highlight">ually</span> developed by a third party:</div><div class=""> </div><div class=""> **feedparser**``feedparser``:cite  by Mark Pilgrim for reading RSS and Atom feeds:</div><div class=""> ``</div><div class=""> gluon/contrib/__init__.py</div><div class=""> gluon/contrib/feedparser.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> **markdown2**``markdown2``:cite  by Trent Mick for wiki markup:</div><div class=""> ``</div><div class=""> gluon/contrib/markdown/__init__.py</div><div class=""> gluon/contrib/markdown/markdown2.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> **markmin** markup:</div><div class=""> ``</div><div class=""> gluon/contrib/markmin</div><div class=""> ``:code</div><div class=""> </div><div class=""> **fpdf** created my Mariano Reingart for generating PDF documents:</div><div class=""> ``</div><div class=""> gluon/contrib/AuthorizeNet.py</div><div class=""> ``</div><div class=""> gluon/contrib/DowCommerce.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> and **PaymentTech** credit cart processing API:</div><div class=""> </div><div class=""> ``</div><div class=""> gluon/contrib/paymentech.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> **PAM**``PAM``:cite  authentication API created by Chris AtLee:</div><div class=""> ``</div><div class=""> gluon/contrib/pam.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> A Bayesian classifier to populate the database with dummy data for testing purposes:</div><div class=""> ``</div><div class=""> gluon/contrib/populate.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> A file that allows interaction with the taskbar in windows, when web2py is running as a service:</div><div class=""> ``</div><div class=""> gluon/contrib/taskbar_widget.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> Optional **login_methods** and login_forms to be used for authentication:</div><div class=""> ``</div><div class=""> gluon/contrib/login_methods/__init__.py</div><div class=""> gluon/contrib/login_methods/basic_auth.py</div><div class=""> gluon/contrib/login_methods/browserid_account.py</div><div class=""> gluon/contrib/login_methods/cas_auth.py</div><div class=""> gluon/contrib/login_methods/dropbox_account.py</div><div class=""> gluon/contrib/login_methods/email_auth.py</div><div class=""> gluon/contrib/login_methods/extended_login_form.py</div><div class=""> gluon/contrib/login_methods/gae_google_account.py</div><div class=""> gluon/contrib/login_methods/ldap_auth.py</div><div class=""> gluon/contrib/login_methods/linkedin_account.py</div><div class=""> gluon/contrib/login_methods/loginza.py</div><div class=""> gluon/contrib/login_methods/oauth10a_account.py</div><div class=""> gluon/contrib/login_methods/oauth20_account.py</div><div class=""> gluon/contrib/login_methods/oneall_account.py</div><div class=""> gluon/contrib/login_methods/openid_auth.py</div><div class=""> gluon/contrib/login_methods/pam_auth.py</div><div class=""> gluon/contrib/login_methods/rpx_account.py</div><div class=""> gluon/contrib/login_methods/x509_auth.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> web2py also contains a folder with useful scripts including</div><div class=""> ``</div><div class=""> scripts/setup-web2py-fedora.sh</div><div class=""> scripts/setup-web2py-ubuntu.sh</div><div class=""> scripts/setup-web2py-nginx-uwsgi-ubuntu.sh</div><div class=""> scripts/update-web2py.sh</div><div class=""> scripts/make_min_web2py.py</div><div class=""> ...</div><div class=""> scripts/sessions2trash.py</div><div class=""> scripts/sync_languages.py</div><div class=""> scripts/tickets2db.py</div><div class=""> scripts/tickets2email.py</div><div class=""> ...</div><div class=""> scripts/extract_mysql_models.py</div><div class=""> scripts/extract_pgsql_models.py</div><div class=""> ...</div><div class=""> scripts/access.wsgi</div><div class=""> scripts/cpdb.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> The first three are particularly useful because they attempt a complete installation and setup of a web2py production environment from scratch.</div><div class=""> Some of these are discussed in Chapter 14, but all of them contain a documentation string inside that explains their purpose and usage.</div><div class=""> </div><div class=""> Finally web2py includes these files required to build the binary distributions.</div><div class=""> ``</div><div class=""> can be retrieved at a later time:</div><div class=""> a = session.myvariable</div><div class=""> ``:code</div><div class=""> </div><div class=""> as long as the code is executed within the same session by the same user (provided the user has not deleted session cookies and the session did not expire). Because ``session`` is a ``Storage`` object, trying to access an attribute/key that has not been set does not raise an exception; it returns ``None`` instead.</div><div class=""> </div><div class=""> The session object has three important methods. One is ``forget``:</div><div class=""> ``</div><div class=""> session.forget(response)</div><div class=""> ``:code</div><div class=""> </div><div class=""> It tells web2py not to save the session. This should be used in those controllers whose actions are called often and do not need to track user activity. ``session.forget()`` prevents the session file from being written, regardless of whether it has been modified. ``session.forget(response)`` additionally unlocks and closes the session file. You rarely need to call this method since sessions are not saved when they are not changed. However, if the page makes multiple simultaneous Ajax requests, it is a good idea for the actions called via Ajax to call ``session.forget(response)`` (assuming the session is not needed by the action). Otherwise, each Ajax action will have to wait for the previous one to complete (and unlock the session file) before proceeding, which will slow down the page loading. Notice that sessions are not locked when stored in database.</div><div class=""> </div><div class=""> Another method is:</div><div class=""> </div><div class=""> ``</div><div class=""> session.secure()</div><div class=""> ``:code</div><div class=""> </div><div class=""> which tells web2py to set the session cookie to be a secure cookie. This should be set if the app is going over https. By setting the session cookie to be secure, the server is asking the browser not to send the session cookie back to the server unless over an https connection.</div><div class=""> </div><div class="delete">-The other method is ``connect``:</div><div class=""> ``</div><div class=""> session.connect(request, response, db, masterapp=None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> where ``db`` is the name of an open database connection (as returned by the DAL). It tells web2py that you want to store the sessions in the database and not on the filesystem. ``session.connect`` must come after ``db=DAL(...)``, but before any other logic that requires session, for example, setting up ``Auth``.</div><div class=""> </div><div class=""> web2py creates a table:</div><div class=""> ``</div><div class=""> db.define_table(&#x27;web2py_session&#x27;,</div><div class="">                  Field(&#x27;locked&#x27;, &#x27;boolean&#x27;, default=False),</div><div class="">                  Field(&#x27;client_ip&#x27;),</div><div class="">                  Field(&#x27;created_datetime&#x27;, &#x27;datetime&#x27;, default=now),</div><div class="">                  Field(&#x27;modified_datetime&#x27;, &#x27;datetime&#x27;),</div><div class="">                  Field(&#x27;unique_key&#x27;),</div><div class="">                  Field(&#x27;session_data&#x27;, &#x27;text&#x27;))</div><div class=""> ``:code</div><div class=""> </div><div class=""> and stores cPickled sessions in the ``session_data`` field.</div><div class=""> </div><div class=""> The option ``masterapp=None``, by default, tells web2py to try to retrieve an existing session for the application with name in ``request.application``, in the running application.</div><div class=""> </div><div class=""> If you want two or more applications to share sessions, set ``masterapp`` to the name of the master application.</div><div class=""> </div><div class=""> You can check the state of your application at any time by printing the ``request``, ``session`` and ``response`` system variables. One way to do it is to create a dedicated action:</div><div class=""> ``</div><div class=""> def status():</div><div class="">     return dict(request=request, session=session, response=response)</div><div class=""> ``:code</div><div class=""> </div><div class=""> #### Separate sessions</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/7bce1473ce90f4e60f49d72bf1b61d32f430cb54">7bce147</a><ul><li>Date : 2012-12-22</li><li>scheduler.queue_task</li></ul></li></ul>
<div class="row-fluid" id="com_7bce1473ce90f4e60f49d72bf1b61d32f430cb54">
    <div class="span6"><div class="diff"><div class=""> ``</div><div class=""> from gluon.scheduler import Scheduler</div><div class="insert">+scheduler = Scheduler(db)</div><div class="insert">+``:code</div><div class="insert">+</div><div class=""> NB: If your tasks are defined in a module (as opposed to a model) you may have to restart the workers.</div><div class=""> </div><div class="insert">+The task is schduled with</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+scheduler.queue_task(&#x27;task_add&#x27;,pvars=dict(a=1,b=2))</div><div class="insert">+``:code</div><div class="insert">+</div><div class=""> </div><div class=""> ##### Parameters</div><div class="insert">+</div><div class=""> The first argument of the ``Scheduler`` class must be the database to be used by the scheduler to communicate with the workers. This can be the ``db`` of the app or another dedicated ``db``, perhaps one shared by multiple apps. If you use SQLite it&#x27;s recommended to use a separate db from the one used by your app in order to keep the app responsive.</div><div class=""> Once the tasks are defined and the ``Scheduler`` is instantiated, all that is needed to do is to start the workers. You can do that in several ways:</div><div class=""> </div><div class=""> ``</div><div class=""> python web2py.py -K myapp</div><div class=""> ``</div><div class=""> starts a worker for the app ``myapp``. If you want start multiple workers for the same app, you can do so just passing ``myapp,myapp``. You can pass also the ``group_names`` (overriding the one set in your model) with</div><div class=""> </div><div class=""> ``</div><div class=""> python web2py.py -K myapp:group1:group2,myotherapp:group1</div><div class=""> ``</div><div class=""> </div><div class=""> If you have a model called ``scheduler.py`` you can start/stop the workers from web2py&#x27;s default window (the one you use to set the ip address and the port).</div><div class=""> </div><div class=""> One last nice addition: if you use the embedded webserver, you can start the webserver and the scheduler with just one line of code (this assumes you don&#x27;t want the web2py window popping up, or you can use the &quot;Schedulers&quot; menu instead)</div><div class=""> </div><div class=""> ``</div><div class=""> python web2py.py -a yourpass -K myapp -X</div><div class=""> ``</div><div class=""> You can pass the usual parameters (-i, -p, here -a prevents the window from showing up), pass whatever app in the -K parameter and append a -X. The scheduler will run alongside the webserver!</div><div class=""> a worker with group_names ``[&#x27;mygroup&#x27;]`` is.</div><div class=""> - ``discard_results`` is False by default. If set to True, no scheduler_run records will be created.</div><div class=""> NB: scheduler_run records will be created as before for **FAILED**, **TIMEOUT** and</div><div class=""> **STOPPED** tasks&#x27;s statuses.</div><div class=""> - ``utc_time`` is False by default. If you need to coordinate with workers living in different timezones, or don&#x27;t have problems with solar/DST times, supplying datetimes from different countries, etc, you can set this to True. The scheduler will honor the UTC time and work leaving the local time aside. Caveat: you need to schedule tasks with UTC times (for start_time, stop_time, and so on.)</div><div class=""> </div><div class=""> Now we have the infrastructure in place: defined the tasks, told the scheduler about them, started the worker(s). What remains is to actually schedule the tasks</div><div class=""> </div><div class=""> </div><div class=""> ##### Tasks</div><div class=""> Tasks can be scheduled programmatically or via appadmin. In fact, a task is scheduled simply by adding an entry in the table &quot;scheduler_task&quot;, which you can access via appadmin:</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/myapp/appadmin/insert/db/scheduler_task</div><div class=""> ``</div><div class=""> </div><div class=""> The meaning of the fields in this table is obvious. The &quot;args&quot; and &quot;vars&quot;&quot; fields are the values to be passed to the task in JSON format. In the case of the &quot;task_add&quot; above, an example of &quot;args&quot; and &quot;vars&quot; could be:</div><div class=""> </div><div class=""> ``</div><div class=""> args = [3, 4]</div><div class=""> vars = {}</div><div class="insert">``<span class="highlight">:code</span></div><div class=""> </div><div class=""> or</div><div class=""> </div><div class=""> ``</div><div class=""> args = []</div><div class=""> vars = {&#x27;a&#x27;:3, &#x27;b&#x27;:4}</div><div class="insert">``<span class="highlight">:code</span></div><div class=""> </div><div class=""> The ``scheduler_task`` table is the one where tasks are organized.</div><div class=""> </div><div class=""> All tasks follow a lifecycle</div><div class=""> </div><div class=""> [[scheduler tasks http://yuml.me/ce8edcc3.jpg center]]</div><div class=""> </div><div class=""> Let&#x27;s go with order. By default, when you send a task to the scheduler, you&#x27;ll want that to be executed. It&#x27;s in **QUEUED** status.</div><div class=""> If you need it to be executed later, use the ``start_time`` parameter (default = now).</div><div class=""> If for some reason you need to be sure that the task don&#x27;t get executed after a certain point in time (maybe a request to a webservice</div><div class=""> that shuts down at 1AM, a mail that needs to be sent not after the working hours, etc...) you can set a ``stop_time`` (default = None) for it.</div><div class=""> If your task is NOT picked up by a worker before stop_time, it will be set as **EXPIRED**.</div><div class=""> Tasks with no stop_time set or picked up **BEFORE** stop_time are **ASSIGNED** to a worker. When a workers picks up them, they become **RUNNING**.</div><div class=""> **RUNNING** tasks may end up:</div><div class=""> - **TIMEOUT** when more than n seconds passed with ``timeout`` parameter (default = 60 seconds)</div><div class=""> - **FAILED** when an exception is detected</div><div class=""> - **COMPLETED** when all went ok</div><div class=""> </div><div class=""> Additionally, you can control how many times a task should be repeated (i.e. you need to aggregate some data at specified intervals). To do so, set the ``repeats``</div><div class=""> parameter (default = 1 time only, 0 = unlimited). You can influence how many seconds should pass between executions with the ``period`` parameter (default = 60 seconds).</div><div class=""> NB: the time is not calculated between the END of the first round and the START of the next, but from the START time of the first round to the START time of the next cycle)</div><div class=""> </div><div class=""> Another nice addition, you can set how many times the function can raise an exception (i.e. requesting data from a sloooow webservice) and be queued again instead of stopping in **FAILED**  status with the parameter ``retry_failed`` (default = 0, -1 = unlimited).</div><div class=""> </div><div class=""> [[task repeats http://yuml.me/7d8b85e4.jpg center]]</div><div class=""> </div><div class=""> Summary: you have</div><div class=""> - ``period`` and ``repeats`` to get an automatically rescheduled function</div><div class=""> - ``timeout`` to be sure that a function doesn&#x27;t exceed a certain amount of time</div><div class=""> - ``retry_failed`` to control how many times the task can &quot;fail&quot;</div><div class=""> - ``start_time`` and ``stop_time`` to schedule a function in a restricted timeframe</div><div class=""> </div><div class=""> </div><div class=""> ##### Results and output</div><div class=""> The table &quot;scheduler_run&quot; stores the status of all running tasks. Each record references a task that has been picked up by a worker.  One task can have multiple runs. For example, a task scheduled to repeat 10 times an hour will probably have 10 runs (unless one fails or they take longer than 1 hour). Beware that if the task has no return values, it is removed from the scheduler_run table as soon as it is finished.</div><div class=""> </div><div class=""> Possible run statuses are:</div><div class=""> </div><div class=""> ``</div><div class=""> RUNNING, COMPLETED, FAILED, TIMEOUT</div><div class=""> ``</div><div class=""> </div><div class=""> If the run is completed, no exceptions are thrown, and there is no task timeout, the run is marked as ``COMPLETED`` and the task is marked as ``QUEUED`` or ``COMPLETED`` depending on whether it is supposed to run again at a later time. The output of the task is serialized in JSON and stored in the run record.</div><div class=""> </div><div class=""> When a ``RUNNING`` task throws an exception, the run is mark as ``FAILED`` and the task is marked as ``FAILED``. The traceback is stored in the run record.</div><div class=""> </div><div class=""> Similarly, when a run exceeds the timeout, it is stopped and marked as ``TIMEOUT``, and the task is marked as ``TIMEOUT``.</div><div class=""> </div><div class=""> In any case, the stdout is captured and also logged into the run record.</div><div class=""> </div><div class=""> Using appadmin, one can check all ``RUNNING`` tasks, the output of ``COMPLETED`` tasks, the error of ``FAILED`` tasks, etc.</div><div class=""> </div><div class=""> The scheduler also creates one more table called &quot;scheduler_worker&quot;, which stores the workers&#x27; heartbeat and their status. Possible worker statuses are:</div><div class=""> Worker fine management is hard. This module tries not to leave behind any platfo</div><div class=""> When you start a worker, you may want later to:</div><div class=""> - kill it &quot;no matter what it&#x27;s doing&quot;</div><div class=""> - kill it only if it&#x27;s not processing tasks</div><div class=""> - put it to sleep</div><div class=""> Maybe you have yet some tasks queued, and you want to save some resources.</div><div class=""> You know you want them processed every hour, so, you&#x27;ll want to:</div><div class=""> - process all queued tasks and die automatically</div><div class=""> All of these things are possible managing ``Scheduler`` parameters or the ``scheduler_worker`` table.</div><div class=""> To be more precise, for started workers you will change the ``status`` value of any worker to influence</div><div class=""> its behavior.</div><div class=""> As tasks, workers can be in some fixed statuses : ACTIVE, DISABLED, TERMINATE or KILLED.</div><div class=""> </div><div class=""> **ACTIVE** and **DISABLED** are &quot;persistent&quot;, while **TERMINATE** or **KILL**, as statuses</div><div class=""> name suggest, are more &quot;commands&quot; than real statuses.</div><div class=""> Hitting ctrl+c is equal to set a worker to **KILL**</div><div class=""> </div><div class=""> [[workers statuses http://yuml.me/bd891eed.jpg center]]</div><div class=""> </div><div class=""> Everything that one can do via appadmin one can do programmatically by inserting and updating records in these tables.</div><div class=""> </div><div class="insert">+Anyway, one should not update records relative to ``RUNNING`` tasks as this may create an un-expected behavior. The best practice is to queue tasks using &quot;queue_task&quot;. </div><div class="insert">+</div><div class="insert">+For example:</div><div class=""> </div><div class=""> ``</div><div class="insert"><span class="highlight"></span>scheduler<span class="highlight">.queur</span>_task<span class="highlight"></span>(</div><div class="">     function_name=&#x27;task_add&#x27;,</div><div class="insert">+    pargs=[],</div><div class="insert">+    pvars={&#x27;a&#x27;:3,&#x27;b&#x27;:4},</div><div class="">     repeats = 10, # run 10 times</div><div class="">     period = 3600, # every 1h</div><div class="">     timeout = 120, # should take less than 120 seconds</div><div class="">     )</div><div class=""> ``:code</div><div class=""> </div><div class=""> Notice that fields &quot;times_run&quot;, &quot;last_run_time&quot; and &quot;assigned_worker_name&quot; are not provided at schedule time but are filled automatically by the workers.</div><div class=""> </div><div class=""> You can also retrieve the output of completed tasks:</div><div class=""> </div><div class=""> ``</div><div class=""> completed_runs = db(db.scheduler_run.status=&#x27;COMPLETED&#x27;).select()</div><div class=""> ``:code</div><div class=""> </div><div class=""> ------</div><div class=""> The scheduler is experimental because it needs more extensive testing and because the table structure may change as more features are added.</div><div class=""> ------</div><div class=""> </div><div class="insert">+##### Reporting percentages</div><div class="insert">+</div><div class="insert">+A special &quot;word&quot; encountered in the print statements of your functions clear all</div><div class="insert">+the previous output. That word is ``!clear!``.</div><div class="insert">+This, coupled with the ``sync_output`` parameter, allows to report percentages</div><div class="insert">+a breeze. Let&#x27;s see how that works:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+def reporting_percentages():</div><div class="insert">+    time.sleep(5)</div><div class="insert">+    print &#x27;50%&#x27;</div><div class="insert">+    time.sleep(5)</div><div class="insert">+    print &#x27;!clear!100%&#x27;</div><div class="insert">+    return 1</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+The function ``demo6`` sleeps for 5 seconds, outputs ``50%``.</div><div class="insert">+Then, it sleeps other 5 seconds and outputs ``100%``. Note that the output in the scheduler_run table is synced every 2 seconds and that the second print statement that contains ``!clear!100%`` gets the ``50%`` output cleared and replaced by ``100%`` only.</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+scheduler.queue_task(task_name=&#x27;reporting_percentages&#x27;, </div><div class="insert">+                     function_name=&#x27;demo6&#x27;, sync_output=2)</div><div class="insert">+``:code</div><div class="insert">+</div></div></div>
    <div class="span6"><div class="diff"><div class=""> ``</div><div class=""> from gluon.scheduler import Scheduler</div><div class="delete">-myscheduler = Scheduler(db)</div><div class="delete">-``</div><div class=""> NB: If your tasks are defined in a module (as opposed to a model) you may have to restart the workers.</div><div class=""> </div><div class=""> </div><div class=""> ##### Parameters</div><div class=""> The first argument of the ``Scheduler`` class must be the database to be used by the scheduler to communicate with the workers. This can be the ``db`` of the app or another dedicated ``db``, perhaps one shared by multiple apps. If you use SQLite it&#x27;s recommended to use a separate db from the one used by your app in order to keep the app responsive.</div><div class=""> Once the tasks are defined and the ``Scheduler`` is instantiated, all that is needed to do is to start the workers. You can do that in several ways:</div><div class=""> </div><div class=""> ``</div><div class=""> python web2py.py -K myapp</div><div class=""> ``</div><div class=""> starts a worker for the app ``myapp``. If you want start multiple workers for the same app, you can do so just passing ``myapp,myapp``. You can pass also the ``group_names`` (overriding the one set in your model) with</div><div class=""> </div><div class=""> ``</div><div class=""> python web2py.py -K myapp:group1:group2,myotherapp:group1</div><div class=""> ``</div><div class=""> </div><div class=""> If you have a model called ``scheduler.py`` you can start/stop the workers from web2py&#x27;s default window (the one you use to set the ip address and the port).</div><div class=""> </div><div class=""> One last nice addition: if you use the embedded webserver, you can start the webserver and the scheduler with just one line of code (this assumes you don&#x27;t want the web2py window popping up, or you can use the &quot;Schedulers&quot; menu instead)</div><div class=""> </div><div class=""> ``</div><div class=""> python web2py.py -a yourpass -K myapp -X</div><div class=""> ``</div><div class=""> You can pass the usual parameters (-i, -p, here -a prevents the window from showing up), pass whatever app in the -K parameter and append a -X. The scheduler will run alongside the webserver!</div><div class=""> a worker with group_names ``[&#x27;mygroup&#x27;]`` is.</div><div class=""> - ``discard_results`` is False by default. If set to True, no scheduler_run records will be created.</div><div class=""> NB: scheduler_run records will be created as before for **FAILED**, **TIMEOUT** and</div><div class=""> **STOPPED** tasks&#x27;s statuses.</div><div class=""> - ``utc_time`` is False by default. If you need to coordinate with workers living in different timezones, or don&#x27;t have problems with solar/DST times, supplying datetimes from different countries, etc, you can set this to True. The scheduler will honor the UTC time and work leaving the local time aside. Caveat: you need to schedule tasks with UTC times (for start_time, stop_time, and so on.)</div><div class=""> </div><div class=""> Now we have the infrastructure in place: defined the tasks, told the scheduler about them, started the worker(s). What remains is to actually schedule the tasks</div><div class=""> </div><div class=""> </div><div class=""> ##### Tasks</div><div class=""> Tasks can be scheduled programmatically or via appadmin. In fact, a task is scheduled simply by adding an entry in the table &quot;scheduler_task&quot;, which you can access via appadmin:</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/myapp/appadmin/insert/db/scheduler_task</div><div class=""> ``</div><div class=""> </div><div class=""> The meaning of the fields in this table is obvious. The &quot;args&quot; and &quot;vars&quot;&quot; fields are the values to be passed to the task in JSON format. In the case of the &quot;task_add&quot; above, an example of &quot;args&quot; and &quot;vars&quot; could be:</div><div class=""> </div><div class=""> ``</div><div class=""> args = [3, 4]</div><div class=""> vars = {}</div><div class="delete">``<span class="highlight"></span></div><div class=""> </div><div class=""> or</div><div class=""> </div><div class=""> ``</div><div class=""> args = []</div><div class=""> vars = {&#x27;a&#x27;:3, &#x27;b&#x27;:4}</div><div class="delete">``<span class="highlight"></span></div><div class=""> </div><div class=""> The ``scheduler_task`` table is the one where tasks are organized.</div><div class=""> </div><div class=""> All tasks follow a lifecycle</div><div class=""> </div><div class=""> [[scheduler tasks http://yuml.me/ce8edcc3.jpg center]]</div><div class=""> </div><div class=""> Let&#x27;s go with order. By default, when you send a task to the scheduler, you&#x27;ll want that to be executed. It&#x27;s in **QUEUED** status.</div><div class=""> If you need it to be executed later, use the ``start_time`` parameter (default = now).</div><div class=""> If for some reason you need to be sure that the task don&#x27;t get executed after a certain point in time (maybe a request to a webservice</div><div class=""> that shuts down at 1AM, a mail that needs to be sent not after the working hours, etc...) you can set a ``stop_time`` (default = None) for it.</div><div class=""> If your task is NOT picked up by a worker before stop_time, it will be set as **EXPIRED**.</div><div class=""> Tasks with no stop_time set or picked up **BEFORE** stop_time are **ASSIGNED** to a worker. When a workers picks up them, they become **RUNNING**.</div><div class=""> **RUNNING** tasks may end up:</div><div class=""> - **TIMEOUT** when more than n seconds passed with ``timeout`` parameter (default = 60 seconds)</div><div class=""> - **FAILED** when an exception is detected</div><div class=""> - **COMPLETED** when all went ok</div><div class=""> </div><div class=""> Additionally, you can control how many times a task should be repeated (i.e. you need to aggregate some data at specified intervals). To do so, set the ``repeats``</div><div class=""> parameter (default = 1 time only, 0 = unlimited). You can influence how many seconds should pass between executions with the ``period`` parameter (default = 60 seconds).</div><div class=""> NB: the time is not calculated between the END of the first round and the START of the next, but from the START time of the first round to the START time of the next cycle)</div><div class=""> </div><div class=""> Another nice addition, you can set how many times the function can raise an exception (i.e. requesting data from a sloooow webservice) and be queued again instead of stopping in **FAILED**  status with the parameter ``retry_failed`` (default = 0, -1 = unlimited).</div><div class=""> </div><div class=""> [[task repeats http://yuml.me/7d8b85e4.jpg center]]</div><div class=""> </div><div class=""> Summary: you have</div><div class=""> - ``period`` and ``repeats`` to get an automatically rescheduled function</div><div class=""> - ``timeout`` to be sure that a function doesn&#x27;t exceed a certain amount of time</div><div class=""> - ``retry_failed`` to control how many times the task can &quot;fail&quot;</div><div class=""> - ``start_time`` and ``stop_time`` to schedule a function in a restricted timeframe</div><div class=""> </div><div class=""> </div><div class="delete">-##### Reporting percentages</div><div class="delete">-</div><div class="delete">-A special &quot;word&quot; encountered in the print statements of your functions clear all</div><div class="delete">-the previous output. That word is ``!clear!``.</div><div class="delete">-This, coupled with the ``sync_output`` parameter, allows to report percentages</div><div class="delete">-a breeze. Let&#x27;s see how that works:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-def reporting_percentages():</div><div class="delete">-    time.sleep(5)</div><div class="delete">-    print &#x27;50%&#x27;</div><div class="delete">-    time.sleep(5)</div><div class="delete">-    print &#x27;!clear!100%&#x27;</div><div class="delete">-    return 1</div><div class="delete">-``</div><div class="delete">-</div><div class="delete">-The function ``demo6`` sleeps for 5 seconds, outputs ``50%``.</div><div class="delete">-Then, it sleeps other 5 seconds and outputs ``100%``. Note that the output in the scheduler_run table is synced every 2 seconds and that the second print statement that contains ``!clear!100%`` gets the ``50%`` output cleared and replaced by ``100%`` only.</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-st.validate_and_insert(task_name=&#x27;percentages&#x27;, function_name=&#x27;demo6&#x27;, sync_output=2)</div><div class="delete">-``</div><div class="delete">-</div><div class=""> ##### Results and output</div><div class=""> The table &quot;scheduler_run&quot; stores the status of all running tasks. Each record references a task that has been picked up by a worker.  One task can have multiple runs. For example, a task scheduled to repeat 10 times an hour will probably have 10 runs (unless one fails or they take longer than 1 hour). Beware that if the task has no return values, it is removed from the scheduler_run table as soon as it is finished.</div><div class=""> </div><div class=""> Possible run statuses are:</div><div class=""> </div><div class=""> ``</div><div class=""> RUNNING, COMPLETED, FAILED, TIMEOUT</div><div class=""> ``</div><div class=""> </div><div class=""> If the run is completed, no exceptions are thrown, and there is no task timeout, the run is marked as ``COMPLETED`` and the task is marked as ``QUEUED`` or ``COMPLETED`` depending on whether it is supposed to run again at a later time. The output of the task is serialized in JSON and stored in the run record.</div><div class=""> </div><div class=""> When a ``RUNNING`` task throws an exception, the run is mark as ``FAILED`` and the task is marked as ``FAILED``. The traceback is stored in the run record.</div><div class=""> </div><div class=""> Similarly, when a run exceeds the timeout, it is stopped and marked as ``TIMEOUT``, and the task is marked as ``TIMEOUT``.</div><div class=""> </div><div class=""> In any case, the stdout is captured and also logged into the run record.</div><div class=""> </div><div class=""> Using appadmin, one can check all ``RUNNING`` tasks, the output of ``COMPLETED`` tasks, the error of ``FAILED`` tasks, etc.</div><div class=""> </div><div class=""> The scheduler also creates one more table called &quot;scheduler_worker&quot;, which stores the workers&#x27; heartbeat and their status. Possible worker statuses are:</div><div class=""> Worker fine management is hard. This module tries not to leave behind any platfo</div><div class=""> When you start a worker, you may want later to:</div><div class=""> - kill it &quot;no matter what it&#x27;s doing&quot;</div><div class=""> - kill it only if it&#x27;s not processing tasks</div><div class=""> - put it to sleep</div><div class=""> Maybe you have yet some tasks queued, and you want to save some resources.</div><div class=""> You know you want them processed every hour, so, you&#x27;ll want to:</div><div class=""> - process all queued tasks and die automatically</div><div class=""> All of these things are possible managing ``Scheduler`` parameters or the ``scheduler_worker`` table.</div><div class=""> To be more precise, for started workers you will change the ``status`` value of any worker to influence</div><div class=""> its behavior.</div><div class=""> As tasks, workers can be in some fixed statuses : ACTIVE, DISABLED, TERMINATE or KILLED.</div><div class=""> </div><div class=""> **ACTIVE** and **DISABLED** are &quot;persistent&quot;, while **TERMINATE** or **KILL**, as statuses</div><div class=""> name suggest, are more &quot;commands&quot; than real statuses.</div><div class=""> Hitting ctrl+c is equal to set a worker to **KILL**</div><div class=""> </div><div class=""> [[workers statuses http://yuml.me/bd891eed.jpg center]]</div><div class=""> </div><div class=""> Everything that one can do via appadmin one can do programmatically by inserting and updating records in these tables.</div><div class=""> </div><div class="delete">-Anyway, one should not update records relative to ``RUNNING`` tasks as this may create an un-expected behavior. The best practice is to queue tasks using &quot;validate_and_insert&quot;. For example:</div><div class=""> </div><div class=""> ``</div><div class="delete"><span class="highlight">db.</span>scheduler<span class="highlight"></span>_task<span class="highlight">.validate_and_insert</span>(</div><div class="">     function_name=&#x27;task_add&#x27;,</div><div class="delete">-    args=&#x27;[]&#x27;,</div><div class="delete">-    vars=&quot;{&#x27;a&#x27;:3,&#x27;b&#x27;:4}&quot;,</div><div class="">     repeats = 10, # run 10 times</div><div class="">     period = 3600, # every 1h</div><div class="">     timeout = 120, # should take less than 120 seconds</div><div class="">     )</div><div class=""> ``:code</div><div class=""> </div><div class=""> Notice that fields &quot;times_run&quot;, &quot;last_run_time&quot; and &quot;assigned_worker_name&quot; are not provided at schedule time but are filled automatically by the workers.</div><div class=""> </div><div class=""> You can also retrieve the output of completed tasks:</div><div class=""> </div><div class=""> ``</div><div class=""> completed_runs = db(db.scheduler_run.status=&#x27;COMPLETED&#x27;).select()</div><div class=""> ``:code</div><div class=""> </div><div class=""> ------</div><div class=""> The scheduler is experimental because it needs more extensive testing and because the table structure may change as more features are added.</div><div class=""> ------</div><div class=""> </div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/e234f6edf67361b3ba718ea10184ba8e7c2f773d">e234f6e</a><ul><li>Date : 2012-12-20</li><li>lots of improvements</li></ul></li></ul>
<div class="row-fluid" id="com_e234f6edf67361b3ba718ea10184ba8e7c2f773d">
    <div class="span6"><div class="diff"><div class=""> Options:</div><div class="">   --version             show program&#x27;s version number and exit</div><div class="">   -h, --help            show this help message and exit</div><div class="insert">+  -i IP, --ip=IP        IP address of the server (e.g., 127.0.0.1 or ::1);</div><div class="insert">+                        Note: This value is ignored when using the</div><div class="insert">+                        &#x27;interfaces&#x27; option.</div><div class="">   -p PORT, --port=PORT  port of server (8000)</div><div class="">   -a PASSWORD, --password=PASSWORD</div><div class="">                         password to be used for administration (use -a</div><div class="">                         &quot;&lt;recycle&gt;&quot; to reuse the last password))</div><div class="">   -c SSL_CERTIFICATE, --ssl_certificate=SSL_CERTIFICATE</div><div class="insert">                        file that contains <span class="highlight">ssl</span> certificate</div><div class="">   -k SSL_PRIVATE_KEY, --ssl_private_key=SSL_PRIVATE_KEY</div><div class="insert">                        file that contains <span class="highlight">ssl</span> private key</div><div class="">   --ca-cert=SSL_CA_CERTIFICATE</div><div class="">                         Use this file containing the CA certificate to</div><div class="">                         validate X509 certificates from clients</div><div class="">   -d PID_FILENAME, --pid_filename=PID_FILENAME</div><div class="">                         file to store the pid of the server</div><div class="">   -l LOG_FILENAME, --log_filename=LOG_FILENAME</div><div class="">                         file to log connections</div><div class="">   -n NUMTHREADS, --numthreads=NUMTHREADS</div><div class="">                         number of threads (deprecated)</div><div class="">   --minthreads=MINTHREADS</div><div class="">                         minimum number of server threads</div><div class="">   --maxthreads=MAXTHREADS</div><div class="">                         maximum number of server threads</div><div class="">   -s SERVER_NAME, --server_name=SERVER_NAME</div><div class="">                         server name for the web server</div><div class="">   -q REQUEST_QUEUE_SIZE, --request_queue_size=REQUEST_QUEUE_SIZE</div><div class="">                         max number of queued requests when server unavailable</div><div class="">   -o TIMEOUT, --timeout=TIMEOUT</div><div class="">                         timeout for individual request (10 seconds)</div><div class="">   -z SHUTDOWN_TIMEOUT, --shutdown_timeout=SHUTDOWN_TIMEOUT</div><div class="">                         timeout on shutdown of server (5 seconds)</div><div class="">   --socket-timeout=SOCKET_TIMEOUT</div><div class="">                         timeout for socket (5 second)</div><div class="">   -f FOLDER, --folder=FOLDER</div><div class="">                         folder from which to run web2py</div><div class="">   -v, --verbose         increase --test verbosity</div><div class="">   -Q, --quiet           disable all output</div><div class="">   -D DEBUGLEVEL, --debug=DEBUGLEVEL</div><div class="">                         set debug output level (0-100, 0 means all, 100 means</div><div class="">                         none; default is 30)</div><div class="">   -S APPNAME, --shell=APPNAME</div><div class="">                         run web2py in interactive shell or IPython (if</div><div class="">                         installed) with specified appname (if app does not</div><div class="">                         exist it will be created). APPNAME like a/c/f (c,f</div><div class="">                         optional)</div><div class="">   -B, --bpython         run web2py in interactive shell or bpython (if</div><div class="">                         installed) with specified appname (if app does not</div><div class="insert">                        exist it will be created). <span class="highlight"></span>Use combined with --shell</div><div class="">   -P, --plain           only use plain python shell; should be used with</div><div class="">                         --shell option</div><div class="">   -M, --import_models   auto import model files; default is False; should be</div><div class="">                         used with --shell option</div><div class="">   -R PYTHON_FILE, --run=PYTHON_FILE</div><div class="">                         run PYTHON_FILE in web2py environment; should be used</div><div class="">                         with --shell option</div><div class="">   -K SCHEDULER, --scheduler=SCHEDULER</div><div class="">                         run scheduled tasks for the specified apps: expects a</div><div class="">                         list of app names as -K app1,app2,app3 or a list of</div><div class="">                         app:groups as -K app1:group1:group2,app2:group1 to</div><div class="">                         override specific group_names. (only strings, no</div><div class="">                         spaces allowed. Requires a scheduler defined in the</div><div class="">                         models</div><div class="">   -X, --with-scheduler  run schedulers alongside webserver</div><div class="">   -T TEST_PATH, --test=TEST_PATH</div><div class="">                         run doctests in web2py environment; TEST_PATH like</div><div class="">                         a/c/f (c,f optional)</div><div class="">   -W WINSERVICE, --winservice=WINSERVICE</div><div class="insert">                        -W install|start|stop as Windows service<span class="highlight"></span></div><div class="">   -C, --cron            trigger a cron run manually; usually invoked from a</div><div class="">                         system crontab</div><div class="">   --softcron            triggers the use of softcron</div><div class="insert">  -Y, --run-cron        start<span class="highlight"> the background</span> cron<span class="highlight"> process</span></div><div class="">   -J, --cronjob         identify cron-initiated command</div><div class="">   -L CONFIG, --config=CONFIG</div><div class="">                         config file</div><div class="">   -F PROFILER_FILENAME, --profiler=PROFILER_FILENAME</div><div class="">                         profiler filename</div><div class="">   -t, --taskbar         use web2py gui and run in taskbar (system tray)</div><div class="">   --nogui               text-only, no GUI</div><div class="">   -A ARGS, --args=ARGS  should be followed by a list of arguments to be passed</div><div class="">                         to script, to be used with -S, -A must be the last</div><div class="">                         option</div><div class="">   --no-banner           Do not print header banner</div><div class="">   --interfaces=INTERFACES</div><div class="insert">+                        listen on multiple addresses: &quot;ip1:port1:key1:cert1:ca</div><div class="insert">+                        _cert1;ip2:port2:key2:cert2:ca_cert2;...&quot;</div><div class="insert">+                        (:key:cert:ca_cert optional; no spaces; IPv6 addresses</div><div class="insert">+                        must be in square [] brackets)</div><div class="">   --run_system_tests    runs web2py tests</div><div class=""> ``:code</div><div class=""> </div><div class=""> Lower-case options are used to configure the web server. The ``-L`` option tells web2py to read configuration options from a file, ``-W`` installs web2py as a windows service, while ``-S``, ``-P`` and ``-M`` options start an interactive Python shell. The ``-T`` option finds and runs controller doctests in a web2py execution environment. For example, the following example runs doctests from all controllers in the &quot;welcome&quot; application:</div><div class=""> ``</div><div class=""> python web2py.py -vT welcome</div><div class=""> ``:code</div><div class=""> </div><div class=""> if you run web2py as Windows Service, ``-W``,  it is not convenient to pass the configuration using command line arguments. For this reason, in the web2py folder there is a sample &quot;options_std.py&quot; configuration file for the internal web server:</div><div class=""> </div><div class=""> ``</div><div class=""> import socket</div><div class=""> import os</div><div class=""> </div><div class=""> ip = &#x27;0.0.0.0&#x27;</div><div class=""> port = 80</div><div class=""> interfaces=[(&#x27;0.0.0.0&#x27;,80)]</div><div class=""> #interfaces.append((&#x27;0.0.0.0&#x27;,443,&#x27;ssl_private_key.pem&#x27;,&#x27;ssl_certificate.pem&#x27;))</div><div class=""> password = &#x27;&lt;recycle&gt;&#x27;  # ## &lt;recycle&gt; means use the previous password</div><div class=""> pid_filename = &#x27;httpserver.pid&#x27;</div><div class=""> log_filename = &#x27;httpserver.log&#x27;</div><div class=""> If the exception is an ``HTTP`` exception, this is assumed to be the intended be</div><div class=""> </div><div class=""> ### Libraries</div><div class=""> </div><div class=""> The web2py libraries are exposed to the user applications as global objects. For example (``request``, ``response``, ``session``, ``cache``), classes (helpers,  validators, DAL API), and functions (``T`` and ``redirect``).</div><div class=""> </div><div class=""> These objects are defined in the following core files:</div><div class=""> ``</div><div class=""> web2py.py</div><div class=""> gluon/__init__.py    gluon/highlight.py   gluon/restricted.py  gluon/streamer.py</div><div class=""> gluon/admin.py       gluon/html.py        gluon/rewrite.py     gluon/template.py</div><div class=""> gluon/cache.py       gluon/http.py        gluon/rocket.py      gluon/storage.py</div><div class=""> gluon/cfs.py         gluon/import_all.py  gluon/sanitizer.py   gluon/tools.py</div><div class=""> gluon/compileapp.py  gluon/languages.py   gluon/serializers.py gluon/utils.py</div><div class=""> gluon/contenttype.py gluon/main.py        gluon/settings.py    gluon/validators.py</div><div class=""> gluon/dal.py         gluon/myregex.py     gluon/shell.py       gluon/widget.py</div><div class=""> gluon/decoder.py     gluon/newcron.py     gluon/sql.py         gluon/winservice.py</div><div class=""> gluon/fileutils.py   gluon/portalocker.py gluon/sqlhtml.py     gluon/xmlrpc.py</div><div class=""> gluon/globals.py     gluon/reserved_sql_keywords.py</div><div class=""> ``:code</div><div class=""> </div><div class="insert">+------</div><div class="insert">+Notice that many of these modules, specifically ``dal`` (the Database Abstraction Layer), ``template`` (the template language), ``rocket`` (the web server), and</div><div class="insert">+``html`` (the helper) have no dependencies and can be used outside of web2py.</div><div class="insert">+-----</div><div class="insert">+</div><div class=""> The tar gzipped scaffolding app that ship with web2py is</div><div class=""> ``</div><div class=""> welcome.w2p</div><div class=""> ``:code</div><div class=""> </div><div class="insert"><span class="highlight">This</span> is created upon installation and overwritten on upgrade.</div><div class=""> </div><div class=""> -------</div><div class="insert">+The first time you start web2py, two new folders are created: deposit and applications. The deposit folder is used as temporary storage for installing and uninstalling applications.</div><div class="insert">+</div><div class="insert">+Also, the first time you start web2py and after an upgrade, the &quot;welcome&quot; app is zipped into a &quot;welcome.w2p&quot; file to be used as a scaffolding app. </div><div class=""> -------</div><div class=""> </div><div class="insert">+When web2py is upgraded it comes with a file called &quot;NEWINSTALL&quot;. If web2py finds this file, it understand an upgrade was performed, hence it removed the file and creates a new &quot;welcome.w2p&quot;.</div><div class="insert">+</div><div class="insert">+The current web2py version is stored in the field &quot;VERSION&quot; and it follows standard semantic versioning notation where the build id is the build timestamp.</div><div class="insert">+</div><div class=""> web2py unit-tests are in</div><div class=""> ``</div><div class=""> gluon/tests/</div><div class=""> ``:code</div><div class=""> </div><div class=""> There are handlers for connecting with various web servers:</div><div class=""> ``</div><div class=""> cgihandler.py       # discouraged</div><div class=""> gaehandler.py       # for Google App Engine</div><div class=""> fcgihandler.py      # for FastCGI</div><div class=""> wsgihandler.py      # for WSGI</div><div class=""> isapiwsgihandler.py # for IIS</div><div class=""> modpythonhandler.py # deprecated</div><div class=""> ``:code</div><div class=""> </div><div class=""> (&quot;fcgihandler&quot; calls  &quot;gluon/contrib/gateways/fcgi.py&quot; developed by Allan Saddi) and</div><div class=""> </div><div class=""> ``</div><div class=""> anyserver.py</div><div class=""> ``</div><div class=""> my_other_storage = Storage(dict(a=1, b=2)) # convert dictionary to Storage</div><div class=""> ``request`` has the following items/attributes, some of which are also an instance of the ``Storage`` class:</div><div class=""> - ``request.cookies``: a ``Cookie.SimpleCookie()`` object containing the cookies passed with the HTTP request. It acts like a dictionary of cookies. Each cookie is a Morsel object (see http://docs.python.org/2/library/cookie.html#id2).</div><div class=""> - ``request.env``: a ``Storage`` object containing the environment variables passed to the controller, including HTTP header variables from the HTTP request and standard WSGI parameters. The environment variables are all converted to lower case, and dots are converted to underscores for easier memorization.</div><div class=""> - ``request.application``: the name of the requested application (parsed from ``request.env.path_info``).</div><div class=""> - ``request.controller``: the name of the requested controller (parsed from the ``request.env.path_info``).</div><div class=""> - ``request.function``: the name of the requested function (parsed from the ``request.env.path_info``).</div><div class=""> - ``request.extension``: the extension of the requested action. It defaults to &quot;html&quot;. If the controller function returns a dictionary and does not specify a view, this is used to determine the extension of the view file that will render the dictionary (parsed from the ``request.env.path_info``).</div><div class=""> - ``request.folder``: the application directory. For example if the application is &quot;welcome&quot;, ``request.folder`` is set to the absolute path &quot;/path/to/welcome&quot;. In your programs, you should always use this variable and the ``os.path.join`` function to build paths to the files you need to access. Although web2py always uses absolute paths, it is a good rule never to explicitly  change the current working folder (whatever that is) since this is not a thread-safe practice.</div><div class=""> - ``request.now``: a ``datetime.datetime`` object storing the datetime of the current request.</div><div class=""> - ``request.utcnow``: a ``datetime.datetime`` object storing the UTC datetime of the current request.</div><div class=""> - ``request.args``: A list of the URL path components following the controller function name; equivalent to ``request.env.path_info.split(&#x27;/&#x27;)[3:]``</div><div class=""> - ``request.vars``: a ``gluon.storage.Storage`` object containing the HTTP GET and HTTP POST query variables.</div><div class=""> - ``request.get_vars``: a ``gluon.storage.Storage`` object containing only the HTTP GET query variables.</div><div class=""> - ``request.post_vars``: a ``gluon.storage.Storage`` object containing only the HTTP POST query variables.</div><div class=""> - ``request.client``: The ip address of the client as determined by, if present, ``request.env.http_x_forwarded_for`` or by ``request.env.remote_addr`` otherwise. While this is useful it should not be trusted because the ``http_x_forwarded_for`` can be spoofed.</div><div class=""> - ``request.is_local``: ``True`` if the client is localhost, ``False`` otherwise. Should work behind a proxy if the proxy supports ``http_x_forwarded_for``.</div><div class=""> - ``request.is_https``: ``True`` if the request is using the HTTPS protocol, ``False`` otherwise.</div><div class=""> - ``request.body``: a read-only file stream that contains the body of the HTTP request. This is automatically parsed to get the ``request.post_vars`` and then rewinded. It can be read with ``request.body.read()``.</div><div class=""> - ``request.ajax`` is True if the function is being called via an Ajax request.</div><div class=""> - ``request.cid`` is the ``id`` of the component that generated the Ajax request (if any). You can read more about components in Chapter 12.</div><div class="insert">+- ``request.requires_https()`` prevents further code execution if the request is not over HTTPS and redirects the visitor to the current page over HTTPS.</div><div class=""> - ``request.restful`` this is a new and very useful decorator that can be used to change the default behavior of web2py actions by separating GET/POST/PUSH/DELETE requests. It will be discussed in some detail in Chapter 10.</div><div class=""> - ``request.user_agent()`` parses the user_agent field from the client and returns the information in the form of a dictionary. It is useful to detect mobile devices. It uses &quot;gluon/contrib/user_agent_parser.py&quot; created by Ross Peoples. To see what it does, try to embed the following code in a view:</div><div class=""> ``</div><div class=""> {{=BEAUTIFY(request.user_agent())}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> - ``request.global_settings`` ``request.global_settings``:inxx contains web2py wide system settings. They are set automatically automatically and you should not change them. For example ``request.global_settings.gluon_parent`` contains the full path to the web2py folder, ``request.global_settings.is_pypy`` determines if web2py is running on PyPy.</div><div class=""> </div><div class=""> - ``request.wsgi`` is a hook that allows you to call third party WSGI applications from inside actions</div><div class=""> </div><div class=""> The latter includes:</div><div class=""> - ``request.wsgi.environ``</div><div class=""> - ``request.wsgi.start_response``</div><div class=""> - ``request.wsgi.middleware``</div><div class=""> their usage is discussed at the end of this Chapter.</div><div class=""> </div><div class=""> As an example, the following call on a typical system:</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/examples/default/status/x/y/z?p=1&amp;q=2</div><div class=""> request.env.content_length | 0</div><div class=""> request.env.content_type | ````</div><div class=""> request.env.http_accept | text/xml,text/html;</div><div class=""> request.env.http_accept_encoding | gzip, deflate</div><div class=""> request.env.http_accept_language | en</div><div class=""> request.env.http_cookie | session_id_examples=127.0.0.1.119725</div><div class=""> request.env.http_host | 127.0.0.1:8000</div><div class=""> request.env.http_max_forwards | 10</div><div class=""> request.env.http_referer | http://web2py.com/</div><div class=""> request.env.http_user_agent | Mozilla/5.0</div><div class=""> request.env.http_via | 1.1 web2py.com</div><div class=""> request.env.http_x_forwarded_for | 76.224.34.5</div><div class=""> request.env.http_x_forwarded_host | web2py.com</div><div class=""> request.env.http_x_forwarded_server | 127.0.0.1</div><div class=""> request.env.path_info | /examples/simple_examples/status</div><div class=""> request.env.query_string | remote_addr:127.0.0.1</div><div class=""> request.env.request_method | GET</div><div class=""> request.env.script_name | ````</div><div class=""> request.env.server_name | 127.0.0.1</div><div class=""> request.env.server_port | 8000</div><div class=""> request.env.server_protocol | HTTP/1.1</div><div class="insert">request.env.server_software | Rocket 1.2.<span class="highlight">6</span></div><div class=""> request.env.web2py_path | /Users/mdipierro/web2py</div><div class="insert">request.env.web2py_version | Version <span class="highlight">2</span>.<span class="highlight">4</span>.1</div><div class=""> request.env.web2py_runtime_gae | (optional, defined only if GAE detected)</div><div class=""> request.env.wsgi_errors | &lt;open file, mode &#x27;w&#x27; at &gt;</div><div class=""> request.env.wsgi_input | ````</div><div class=""> request.env.wsgi_multiprocess | False</div><div class=""> request.env.wsgi_multithread | True</div><div class=""> request.env.wsgi_run_once | False</div><div class=""> request.env.wsgi_url_scheme | http</div><div class=""> request.env.wsgi_version | 10</div><div class=""> --------</div><div class=""> </div><div class=""> Which environment variables are actually defined depends on the web server. Here we are assuming the built-in Rocket wsgi server. The set of variables is not much different when using the Apache web server.</div><div class=""> </div><div class=""> The ``request.env.http_*`` variables are parsed from the request HTTP header.</div><div class=""> </div><div class=""> The ``request.env.web2py_*`` variables are not parsed from the web server environment, but are created by web2py in case your applications need to know about the web2py location and version, and whether it is running on the Google App Engine (because specific optimizations may be necessary).</div><div class=""> </div><div class=""> Also notice the ``request.env.wsgi_*`` variables. They are specific to the wsgi adaptor.</div><div class=""> </div><div class=""> ### ``response``</div><div class=""> ``response``:inxx</div><div class=""> For example</div><div class=""> </div><div class=""> ``T(&quot;%%{this} %%{is} %%{?a?%s} %%{book}&quot;, var)``</div><div class=""> </div><div class=""> produces:</div><div class=""> </div><div class=""> ``</div><div class=""> var  output</div><div class=""> ------------------</div><div class="">  1   this is a book</div><div class="">  2   these are 2 books</div><div class="">  3   these are 2 books</div><div class="">  ... </div><div class=""> ``</div><div class=""> </div><div class=""> Inside ``%%{...}`` you can also use the following modifiers:</div><div class=""> </div><div class=""> - ``!`` to capitalize the text (equivalent to ``string.capitalize``)</div><div class=""> - ``!!`` to capitalize every word (equivalent to ``string.title``)</div><div class=""> - ``!!!`` to capitalize every character (equivalent to ``string.upper``)</div><div class=""> </div><div class="insert">Notice you can use ``<span class="highlight">\</span>\`` to scape ``!`` and ``?``.</div><div class=""> </div><div class=""> #### Translations, plurlaization, and MARKMIN</div><div class=""> </div><div class=""> You can also use the powerful MARKMIN syntax inside translation strings by replacing</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;hello world&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> with</div><div class=""> </div><div class=""> ``</div><div class=""> T.M(&quot;hello world&quot;)</div><div class=""> ``</div><div class=""> </div><div class=""> Now the string accepts MARKMIN markup as described later in the book. You can also use the pluralization system inside MARKMIN.</div><div class=""> </div><div class="insert"><span class="highlight">### &#x27;&#x27;Cookies&#x27;&#x27; </span>``cookies``:inxx</div></div></div>
    <div class="span6"><div class="diff"><div class=""> Options:</div><div class="">   --version             show program&#x27;s version number and exit</div><div class="">   -h, --help            show this help message and exit</div><div class="delete">-  -i IP, --ip=IP        ip address of the server (127.0.0.1)</div><div class="">   -p PORT, --port=PORT  port of server (8000)</div><div class="">   -a PASSWORD, --password=PASSWORD</div><div class="">                         password to be used for administration (use -a</div><div class="">                         &quot;&lt;recycle&gt;&quot; to reuse the last password))</div><div class="">   -c SSL_CERTIFICATE, --ssl_certificate=SSL_CERTIFICATE</div><div class="delete">                        file that contains <span class="highlight">SSL</span> certificate</div><div class="">   -k SSL_PRIVATE_KEY, --ssl_private_key=SSL_PRIVATE_KEY</div><div class="delete">                        file that contains <span class="highlight">SSL</span> private key</div><div class="">   --ca-cert=SSL_CA_CERTIFICATE</div><div class="">                         Use this file containing the CA certificate to</div><div class="">                         validate X509 certificates from clients</div><div class="">   -d PID_FILENAME, --pid_filename=PID_FILENAME</div><div class="">                         file to store the pid of the server</div><div class="">   -l LOG_FILENAME, --log_filename=LOG_FILENAME</div><div class="">                         file to log connections</div><div class="">   -n NUMTHREADS, --numthreads=NUMTHREADS</div><div class="">                         number of threads (deprecated)</div><div class="">   --minthreads=MINTHREADS</div><div class="">                         minimum number of server threads</div><div class="">   --maxthreads=MAXTHREADS</div><div class="">                         maximum number of server threads</div><div class="">   -s SERVER_NAME, --server_name=SERVER_NAME</div><div class="">                         server name for the web server</div><div class="">   -q REQUEST_QUEUE_SIZE, --request_queue_size=REQUEST_QUEUE_SIZE</div><div class="">                         max number of queued requests when server unavailable</div><div class="">   -o TIMEOUT, --timeout=TIMEOUT</div><div class="">                         timeout for individual request (10 seconds)</div><div class="">   -z SHUTDOWN_TIMEOUT, --shutdown_timeout=SHUTDOWN_TIMEOUT</div><div class="">                         timeout on shutdown of server (5 seconds)</div><div class="">   --socket-timeout=SOCKET_TIMEOUT</div><div class="">                         timeout for socket (5 second)</div><div class="">   -f FOLDER, --folder=FOLDER</div><div class="">                         folder from which to run web2py</div><div class="">   -v, --verbose         increase --test verbosity</div><div class="">   -Q, --quiet           disable all output</div><div class="">   -D DEBUGLEVEL, --debug=DEBUGLEVEL</div><div class="">                         set debug output level (0-100, 0 means all, 100 means</div><div class="">                         none; default is 30)</div><div class="">   -S APPNAME, --shell=APPNAME</div><div class="">                         run web2py in interactive shell or IPython (if</div><div class="">                         installed) with specified appname (if app does not</div><div class="">                         exist it will be created). APPNAME like a/c/f (c,f</div><div class="">                         optional)</div><div class="">   -B, --bpython         run web2py in interactive shell or bpython (if</div><div class="">                         installed) with specified appname (if app does not</div><div class="delete">                        exist it will be created). <span class="highlight"> </span>Use combined with --shell</div><div class="">   -P, --plain           only use plain python shell; should be used with</div><div class="">                         --shell option</div><div class="">   -M, --import_models   auto import model files; default is False; should be</div><div class="">                         used with --shell option</div><div class="">   -R PYTHON_FILE, --run=PYTHON_FILE</div><div class="">                         run PYTHON_FILE in web2py environment; should be used</div><div class="">                         with --shell option</div><div class="">   -K SCHEDULER, --scheduler=SCHEDULER</div><div class="">                         run scheduled tasks for the specified apps: expects a</div><div class="">                         list of app names as -K app1,app2,app3 or a list of</div><div class="">                         app:groups as -K app1:group1:group2,app2:group1 to</div><div class="">                         override specific group_names. (only strings, no</div><div class="">                         spaces allowed. Requires a scheduler defined in the</div><div class="">                         models</div><div class="">   -X, --with-scheduler  run schedulers alongside webserver</div><div class="">   -T TEST_PATH, --test=TEST_PATH</div><div class="">                         run doctests in web2py environment; TEST_PATH like</div><div class="">                         a/c/f (c,f optional)</div><div class="">   -W WINSERVICE, --winservice=WINSERVICE</div><div class="delete">                        -W install|start|stop as Windows service<span class="highlight"> (use with -L)</span></div><div class="">   -C, --cron            trigger a cron run manually; usually invoked from a</div><div class="">                         system crontab</div><div class="">   --softcron            triggers the use of softcron</div><div class="delete">  -Y, --run-cron        start<span class="highlight">s</span> cron<span class="highlight"></span></div><div class="">   -J, --cronjob         identify cron-initiated command</div><div class="">   -L CONFIG, --config=CONFIG</div><div class="">                         config file</div><div class="">   -F PROFILER_FILENAME, --profiler=PROFILER_FILENAME</div><div class="">                         profiler filename</div><div class="">   -t, --taskbar         use web2py gui and run in taskbar (system tray)</div><div class="">   --nogui               text-only, no GUI</div><div class="">   -A ARGS, --args=ARGS  should be followed by a list of arguments to be passed</div><div class="">                         to script, to be used with -S, -A must be the last</div><div class="">                         option</div><div class="">   --no-banner           Do not print header banner</div><div class="">   --interfaces=INTERFACES</div><div class="delete">-                        listen on multiple addresses: &quot;ip:port:cert:key:ca_cer</div><div class="delete">-                        t;ip2:port2:cert2:key2:ca_cert2;...&quot; (:cert:key</div><div class="delete">-                        optional; no spaces)</div><div class="">   --run_system_tests    runs web2py tests</div><div class="delete">-</div><div class=""> ``:code</div><div class=""> </div><div class=""> Lower-case options are used to configure the web server. The ``-L`` option tells web2py to read configuration options from a file, ``-W`` installs web2py as a windows service, while ``-S``, ``-P`` and ``-M`` options start an interactive Python shell. The ``-T`` option finds and runs controller doctests in a web2py execution environment. For example, the following example runs doctests from all controllers in the &quot;welcome&quot; application:</div><div class=""> ``</div><div class=""> python web2py.py -vT welcome</div><div class=""> ``:code</div><div class=""> </div><div class=""> if you run web2py as Windows Service, ``-W``,  it is not convenient to pass the configuration using command line arguments. For this reason, in the web2py folder there is a sample &quot;options_std.py&quot; configuration file for the internal web server:</div><div class=""> </div><div class=""> ``</div><div class=""> import socket</div><div class=""> import os</div><div class=""> </div><div class=""> ip = &#x27;0.0.0.0&#x27;</div><div class=""> port = 80</div><div class=""> interfaces=[(&#x27;0.0.0.0&#x27;,80)]</div><div class=""> #interfaces.append((&#x27;0.0.0.0&#x27;,443,&#x27;ssl_private_key.pem&#x27;,&#x27;ssl_certificate.pem&#x27;))</div><div class=""> password = &#x27;&lt;recycle&gt;&#x27;  # ## &lt;recycle&gt; means use the previous password</div><div class=""> pid_filename = &#x27;httpserver.pid&#x27;</div><div class=""> log_filename = &#x27;httpserver.log&#x27;</div><div class=""> If the exception is an ``HTTP`` exception, this is assumed to be the intended be</div><div class=""> </div><div class=""> ### Libraries</div><div class=""> </div><div class=""> The web2py libraries are exposed to the user applications as global objects. For example (``request``, ``response``, ``session``, ``cache``), classes (helpers,  validators, DAL API), and functions (``T`` and ``redirect``).</div><div class=""> </div><div class=""> These objects are defined in the following core files:</div><div class=""> ``</div><div class=""> web2py.py</div><div class=""> gluon/__init__.py    gluon/highlight.py   gluon/restricted.py  gluon/streamer.py</div><div class=""> gluon/admin.py       gluon/html.py        gluon/rewrite.py     gluon/template.py</div><div class=""> gluon/cache.py       gluon/http.py        gluon/rocket.py      gluon/storage.py</div><div class=""> gluon/cfs.py         gluon/import_all.py  gluon/sanitizer.py   gluon/tools.py</div><div class=""> gluon/compileapp.py  gluon/languages.py   gluon/serializers.py gluon/utils.py</div><div class=""> gluon/contenttype.py gluon/main.py        gluon/settings.py    gluon/validators.py</div><div class=""> gluon/dal.py         gluon/myregex.py     gluon/shell.py       gluon/widget.py</div><div class=""> gluon/decoder.py     gluon/newcron.py     gluon/sql.py         gluon/winservice.py</div><div class=""> gluon/fileutils.py   gluon/portalocker.py gluon/sqlhtml.py     gluon/xmlrpc.py</div><div class=""> gluon/globals.py     gluon/reserved_sql_keywords.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> The tar gzipped scaffolding app that ship with web2py is</div><div class=""> ``</div><div class=""> welcome.w2p</div><div class=""> ``:code</div><div class=""> </div><div class="delete"><span class="highlight">It</span> is created upon installation and overwritten on upgrade.</div><div class=""> </div><div class=""> -------</div><div class="delete">-The first time you start web2py, two new folders are created: deposit and applications. The &quot;welcome&quot; app is zipped into a &quot;welcome.w2p&quot; file to be used as a scaffolding app.</div><div class="delete">-The deposit folder is used as temporary storage for installing and uninstalling applications.</div><div class=""> -------</div><div class=""> </div><div class=""> web2py unit-tests are in</div><div class=""> ``</div><div class=""> gluon/tests/</div><div class=""> ``:code</div><div class=""> </div><div class=""> There are handlers for connecting with various web servers:</div><div class=""> ``</div><div class=""> cgihandler.py       # discouraged</div><div class=""> gaehandler.py       # for Google App Engine</div><div class=""> fcgihandler.py      # for FastCGI</div><div class=""> wsgihandler.py      # for WSGI</div><div class=""> isapiwsgihandler.py # for IIS</div><div class=""> modpythonhandler.py # deprecated</div><div class=""> ``:code</div><div class=""> </div><div class=""> (&quot;fcgihandler&quot; calls  &quot;gluon/contrib/gateways/fcgi.py&quot; developed by Allan Saddi) and</div><div class=""> </div><div class=""> ``</div><div class=""> anyserver.py</div><div class=""> ``</div><div class=""> my_other_storage = Storage(dict(a=1, b=2)) # convert dictionary to Storage</div><div class=""> ``request`` has the following items/attributes, some of which are also an instance of the ``Storage`` class:</div><div class=""> - ``request.cookies``: a ``Cookie.SimpleCookie()`` object containing the cookies passed with the HTTP request. It acts like a dictionary of cookies. Each cookie is a Morsel object (see http://docs.python.org/2/library/cookie.html#id2).</div><div class=""> - ``request.env``: a ``Storage`` object containing the environment variables passed to the controller, including HTTP header variables from the HTTP request and standard WSGI parameters. The environment variables are all converted to lower case, and dots are converted to underscores for easier memorization.</div><div class=""> - ``request.application``: the name of the requested application (parsed from ``request.env.path_info``).</div><div class=""> - ``request.controller``: the name of the requested controller (parsed from the ``request.env.path_info``).</div><div class=""> - ``request.function``: the name of the requested function (parsed from the ``request.env.path_info``).</div><div class=""> - ``request.extension``: the extension of the requested action. It defaults to &quot;html&quot;. If the controller function returns a dictionary and does not specify a view, this is used to determine the extension of the view file that will render the dictionary (parsed from the ``request.env.path_info``).</div><div class=""> - ``request.folder``: the application directory. For example if the application is &quot;welcome&quot;, ``request.folder`` is set to the absolute path &quot;/path/to/welcome&quot;. In your programs, you should always use this variable and the ``os.path.join`` function to build paths to the files you need to access. Although web2py always uses absolute paths, it is a good rule never to explicitly  change the current working folder (whatever that is) since this is not a thread-safe practice.</div><div class=""> - ``request.now``: a ``datetime.datetime`` object storing the datetime of the current request.</div><div class=""> - ``request.utcnow``: a ``datetime.datetime`` object storing the UTC datetime of the current request.</div><div class=""> - ``request.args``: A list of the URL path components following the controller function name; equivalent to ``request.env.path_info.split(&#x27;/&#x27;)[3:]``</div><div class=""> - ``request.vars``: a ``gluon.storage.Storage`` object containing the HTTP GET and HTTP POST query variables.</div><div class=""> - ``request.get_vars``: a ``gluon.storage.Storage`` object containing only the HTTP GET query variables.</div><div class=""> - ``request.post_vars``: a ``gluon.storage.Storage`` object containing only the HTTP POST query variables.</div><div class=""> - ``request.client``: The ip address of the client as determined by, if present, ``request.env.http_x_forwarded_for`` or by ``request.env.remote_addr`` otherwise. While this is useful it should not be trusted because the ``http_x_forwarded_for`` can be spoofed.</div><div class=""> - ``request.is_local``: ``True`` if the client is localhost, ``False`` otherwise. Should work behind a proxy if the proxy supports ``http_x_forwarded_for``.</div><div class=""> - ``request.is_https``: ``True`` if the request is using the HTTPS protocol, ``False`` otherwise.</div><div class=""> - ``request.body``: a read-only file stream that contains the body of the HTTP request. This is automatically parsed to get the ``request.post_vars`` and then rewinded. It can be read with ``request.body.read()``.</div><div class=""> - ``request.ajax`` is True if the function is being called via an Ajax request.</div><div class=""> - ``request.cid`` is the ``id`` of the component that generated the Ajax request (if any). You can read more about components in Chapter 12.</div><div class=""> - ``request.restful`` this is a new and very useful decorator that can be used to change the default behavior of web2py actions by separating GET/POST/PUSH/DELETE requests. It will be discussed in some detail in Chapter 10.</div><div class=""> - ``request.user_agent()`` parses the user_agent field from the client and returns the information in the form of a dictionary. It is useful to detect mobile devices. It uses &quot;gluon/contrib/user_agent_parser.py&quot; created by Ross Peoples. To see what it does, try to embed the following code in a view:</div><div class=""> ``</div><div class=""> {{=BEAUTIFY(request.user_agent())}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> - ``request.global_settings`` ``request.global_settings``:inxx contains web2py wide system settings. They are set automatically automatically and you should not change them. For example ``request.global_settings.gluon_parent`` contains the full path to the web2py folder, ``request.global_settings.is_pypy`` determines if web2py is running on PyPy.</div><div class=""> </div><div class=""> - ``request.wsgi`` is a hook that allows you to call third party WSGI applications from inside actions</div><div class=""> </div><div class=""> The latter includes:</div><div class=""> - ``request.wsgi.environ``</div><div class=""> - ``request.wsgi.start_response``</div><div class=""> - ``request.wsgi.middleware``</div><div class=""> their usage is discussed at the end of this Chapter.</div><div class=""> </div><div class=""> As an example, the following call on a typical system:</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/examples/default/status/x/y/z?p=1&amp;q=2</div><div class=""> request.env.content_length | 0</div><div class=""> request.env.content_type | ````</div><div class=""> request.env.http_accept | text/xml,text/html;</div><div class=""> request.env.http_accept_encoding | gzip, deflate</div><div class=""> request.env.http_accept_language | en</div><div class=""> request.env.http_cookie | session_id_examples=127.0.0.1.119725</div><div class=""> request.env.http_host | 127.0.0.1:8000</div><div class=""> request.env.http_max_forwards | 10</div><div class=""> request.env.http_referer | http://web2py.com/</div><div class=""> request.env.http_user_agent | Mozilla/5.0</div><div class=""> request.env.http_via | 1.1 web2py.com</div><div class=""> request.env.http_x_forwarded_for | 76.224.34.5</div><div class=""> request.env.http_x_forwarded_host | web2py.com</div><div class=""> request.env.http_x_forwarded_server | 127.0.0.1</div><div class=""> request.env.path_info | /examples/simple_examples/status</div><div class=""> request.env.query_string | remote_addr:127.0.0.1</div><div class=""> request.env.request_method | GET</div><div class=""> request.env.script_name | ````</div><div class=""> request.env.server_name | 127.0.0.1</div><div class=""> request.env.server_port | 8000</div><div class=""> request.env.server_protocol | HTTP/1.1</div><div class="delete">request.env.server_software | Rocket 1.2.<span class="highlight">4</span></div><div class=""> request.env.web2py_path | /Users/mdipierro/web2py</div><div class="delete">request.env.web2py_version | Version <span class="highlight">1</span>.<span class="highlight">99</span>.1</div><div class=""> request.env.web2py_runtime_gae | (optional, defined only if GAE detected)</div><div class=""> request.env.wsgi_errors | &lt;open file, mode &#x27;w&#x27; at &gt;</div><div class=""> request.env.wsgi_input | ````</div><div class=""> request.env.wsgi_multiprocess | False</div><div class=""> request.env.wsgi_multithread | True</div><div class=""> request.env.wsgi_run_once | False</div><div class=""> request.env.wsgi_url_scheme | http</div><div class=""> request.env.wsgi_version | 10</div><div class=""> --------</div><div class=""> </div><div class=""> Which environment variables are actually defined depends on the web server. Here we are assuming the built-in Rocket wsgi server. The set of variables is not much different when using the Apache web server.</div><div class=""> </div><div class=""> The ``request.env.http_*`` variables are parsed from the request HTTP header.</div><div class=""> </div><div class=""> The ``request.env.web2py_*`` variables are not parsed from the web server environment, but are created by web2py in case your applications need to know about the web2py location and version, and whether it is running on the Google App Engine (because specific optimizations may be necessary).</div><div class=""> </div><div class=""> Also notice the ``request.env.wsgi_*`` variables. They are specific to the wsgi adaptor.</div><div class=""> </div><div class=""> ### ``response``</div><div class=""> ``response``:inxx</div><div class=""> For example</div><div class=""> </div><div class=""> ``T(&quot;%%{this} %%{is} %%{?a?%s} %%{book}&quot;, var)``</div><div class=""> </div><div class=""> produces:</div><div class=""> </div><div class=""> ``</div><div class=""> var  output</div><div class=""> ------------------</div><div class="">  1   this is a book</div><div class="">  2   these are 2 books</div><div class="">  3   these are 2 books</div><div class="">  ... </div><div class=""> ``</div><div class=""> </div><div class=""> Inside ``%%{...}`` you can also use the following modifiers:</div><div class=""> </div><div class=""> - ``!`` to capitalize the text (equivalent to ``string.capitalize``)</div><div class=""> - ``!!`` to capitalize every word (equivalent to ``string.title``)</div><div class=""> - ``!!!`` to capitalize every character (equivalent to ``string.upper``)</div><div class=""> </div><div class="delete">Notice you can use ``<span class="highlight"></span>\`` to scape ``!`` and ``?``.</div><div class=""> </div><div class=""> #### Translations, plurlaization, and MARKMIN</div><div class=""> </div><div class=""> You can also use the powerful MARKMIN syntax inside translation strings by replacing</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;hello world&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> with</div><div class=""> </div><div class=""> ``</div><div class=""> T.M(&quot;hello world&quot;)</div><div class=""> ``</div><div class=""> </div><div class=""> Now the string accepts MARKMIN markup as described later in the book. You can also use the pluralization system inside MARKMIN.</div><div class=""> </div><div class="delete">-### &#x27;&#x27;Cookies&#x27;&#x27;</div><div class="delete"><span class="highlight"></span>``cookies``:inxx</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/d3f20357877157ed6c1368276a97f432517ebc0c">d3f2035</a><ul><li>Date : 2012-12-19</li><li>updated README</li></ul></li></ul>
<div class="row-fluid" id="com_d3f20357877157ed6c1368276a97f432517ebc0c">
    <div class="span6"><div class="diff"><div class="insert">**Dowcommerce** ``dowcommerce``:cite <span class="highlight"></span>credit cart processing API:</div><div class=""> ``</div><div class=""> gluon/contrib/DowCommerce.py</div><div class=""> ``:code</div><div class=""> </div><div class="insert">+and **PaymentTech** credit cart processing API:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+gluon/contrib/paymentech.py</div><div class="insert">+``:code</div><div class="insert">+</div><div class=""> **PAM**``PAM``:cite  authentication API created by Chris AtLee:</div><div class=""> ``</div><div class=""> gluon/contrib/pam.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> A Bayesian classifier to populate the database with dummy data for testing purposes:</div><div class=""> ``</div><div class=""> gluon/contrib/populate.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> A file that allows interaction with the taskbar in windows, when web2py is running as a service:</div><div class=""> ``</div><div class=""> gluon/contrib/taskbar_widget.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> Optional **login_methods** and login_forms to be used for authentication:</div><div class=""> ``</div><div class=""> gluon/contrib/login_methods/__init__.py</div><div class=""> gluon/contrib/login_methods/basic_auth.py</div><div class="insert">+gluon/contrib/login_methods/browserid_account.py</div><div class=""> gluon/contrib/login_methods/cas_auth.py</div><div class=""> gluon/contrib/login_methods/dropbox_account.py</div><div class=""> gluon/contrib/login_methods/email_auth.py</div><div class=""> gluon/contrib/login_methods/extended_login_form.py</div><div class=""> gluon/contrib/login_methods/gae_google_account.py</div><div class=""> gluon/contrib/login_methods/ldap_auth.py</div><div class=""> gluon/contrib/login_methods/linkedin_account.py</div><div class=""> gluon/contrib/login_methods/loginza.py</div><div class=""> gluon/contrib/login_methods/oauth10a_account.py</div><div class=""> gluon/contrib/login_methods/oauth20_account.py</div><div class="insert">+gluon/contrib/login_methods/oneall_account.py</div><div class=""> gluon/contrib/login_methods/openid_auth.py</div><div class=""> gluon/contrib/login_methods/pam_auth.py</div><div class=""> gluon/contrib/login_methods/rpx_account.py</div><div class=""> gluon/contrib/login_methods/x509_auth.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> web2py also contains a folder with useful scripts including</div><div class=""> ``</div><div class=""> scripts/setup-web2py-fedora.sh</div><div class=""> scripts/setup-web2py-ubuntu.sh</div><div class=""> scripts/setup-web2py-nginx-uwsgi-ubuntu.sh</div><div class=""> scripts/update-web2py.sh</div><div class=""> scripts/make_min_web2py.py</div><div class=""> ...</div><div class=""> scripts/sessions2trash.py</div><div class=""> scripts/sync_languages.py</div><div class=""> scripts/tickets2db.py</div><div class=""> scripts/tickets2email.py</div><div class=""> ...</div><div class=""> scripts/extract_mysql_models.py</div><div class=""> T.set_current_languages(&#x27;en&#x27;, &#x27;en-en&#x27;)</div><div class=""> </div><div class=""> It stores in  ``T.current_languages`` a list of languages that do not require translation and forces a reload of the language files.</div><div class=""> </div><div class=""> Notice that &quot;it&quot; and &quot;it-it&quot; are different languages from the point of view of web2py. To support both of them, one would need two translation files, always lower case. The same is true for all other languages.</div><div class=""> </div><div class=""> The currently accepted language is stored in</div><div class=""> ``</div><div class=""> T.accepted_language</div><div class=""> ``:code</div><div class=""> </div><div class=""> #### Translating variables</div><div class=""> </div><div class=""> Mind that T(...) does not just translate strings but can also translated variables:</div><div class=""> ``</div><div class=""> &gt;&gt;&gt; a=&quot;test&quot;</div><div class=""> &gt;&gt;&gt; print T(a)</div><div class=""> ``:code</div><div class=""> </div><div class=""> In this case the word &quot;test&quot; is translated but, if not found and if the filesystem is writable, it will add it to the list of words to be translated in the language file.</div><div class=""> </div><div class="insert">+Notice that this can result in lots of file IO and you may want to disable it:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+T.is_writable = False</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+prevents T from dynamically updating langauge files.</div><div class="insert">+</div><div class=""> #### Comments and multiple translations</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">**Dowcommerce** ``dowcommerce``:cite <span class="highlight">is yet another </span>credit cart processing API:</div><div class=""> ``</div><div class=""> gluon/contrib/DowCommerce.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> **PAM**``PAM``:cite  authentication API created by Chris AtLee:</div><div class=""> ``</div><div class=""> gluon/contrib/pam.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> A Bayesian classifier to populate the database with dummy data for testing purposes:</div><div class=""> ``</div><div class=""> gluon/contrib/populate.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> A file that allows interaction with the taskbar in windows, when web2py is running as a service:</div><div class=""> ``</div><div class=""> gluon/contrib/taskbar_widget.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> Optional **login_methods** and login_forms to be used for authentication:</div><div class=""> ``</div><div class=""> gluon/contrib/login_methods/__init__.py</div><div class=""> gluon/contrib/login_methods/basic_auth.py</div><div class=""> gluon/contrib/login_methods/cas_auth.py</div><div class=""> gluon/contrib/login_methods/dropbox_account.py</div><div class=""> gluon/contrib/login_methods/email_auth.py</div><div class=""> gluon/contrib/login_methods/extended_login_form.py</div><div class=""> gluon/contrib/login_methods/gae_google_account.py</div><div class=""> gluon/contrib/login_methods/ldap_auth.py</div><div class=""> gluon/contrib/login_methods/linkedin_account.py</div><div class=""> gluon/contrib/login_methods/loginza.py</div><div class=""> gluon/contrib/login_methods/oauth10a_account.py</div><div class=""> gluon/contrib/login_methods/oauth20_account.py</div><div class=""> gluon/contrib/login_methods/openid_auth.py</div><div class=""> gluon/contrib/login_methods/pam_auth.py</div><div class=""> gluon/contrib/login_methods/rpx_account.py</div><div class=""> gluon/contrib/login_methods/x509_auth.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> web2py also contains a folder with useful scripts including</div><div class=""> ``</div><div class=""> scripts/setup-web2py-fedora.sh</div><div class=""> scripts/setup-web2py-ubuntu.sh</div><div class=""> scripts/setup-web2py-nginx-uwsgi-ubuntu.sh</div><div class=""> scripts/update-web2py.sh</div><div class=""> scripts/make_min_web2py.py</div><div class=""> ...</div><div class=""> scripts/sessions2trash.py</div><div class=""> scripts/sync_languages.py</div><div class=""> scripts/tickets2db.py</div><div class=""> scripts/tickets2email.py</div><div class=""> ...</div><div class=""> scripts/extract_mysql_models.py</div><div class=""> T.set_current_languages(&#x27;en&#x27;, &#x27;en-en&#x27;)</div><div class=""> </div><div class=""> It stores in  ``T.current_languages`` a list of languages that do not require translation and forces a reload of the language files.</div><div class=""> </div><div class=""> Notice that &quot;it&quot; and &quot;it-it&quot; are different languages from the point of view of web2py. To support both of them, one would need two translation files, always lower case. The same is true for all other languages.</div><div class=""> </div><div class=""> The currently accepted language is stored in</div><div class=""> ``</div><div class=""> T.accepted_language</div><div class=""> ``:code</div><div class=""> </div><div class=""> #### Translating variables</div><div class=""> </div><div class=""> Mind that T(...) does not just translate strings but can also translated variables:</div><div class=""> ``</div><div class=""> &gt;&gt;&gt; a=&quot;test&quot;</div><div class=""> &gt;&gt;&gt; print T(a)</div><div class=""> ``:code</div><div class=""> </div><div class=""> In this case the word &quot;test&quot; is translated but, if not found and if the filesystem is writable, it will add it to the list of words to be translated in the language file.</div><div class=""> </div><div class=""> #### Comments and multiple translations</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/82dc64e7baa231edd3896ca7a0d41393e426f123">82dc64e</a><ul><li>Date : 2012-12-19</li><li>lots of small additions</li></ul></li></ul>
<div class="row-fluid" id="com_82dc64e7baa231edd3896ca7a0d41393e426f123">
    <div class="span6"><div class="diff"><div class="insert">+- ``request.global_settings`` ``request.global_settings``:inxx contains web2py wide system settings. They are set automatically automatically and you should not change them. For example ``request.global_settings.gluon_parent`` contains the full path to the web2py folder, ``request.global_settings.is_pypy`` determines if web2py is running on PyPy.</div><div class="insert">+</div><div class=""> - ``request.wsgi`` is a hook that allows you to call third party WSGI applications from inside actions</div><div class=""> </div><div class=""> The latter includes:</div><div class=""> - ``request.wsgi.environ``</div><div class=""> - ``request.wsgi.start_response``</div><div class=""> - ``request.wsgi.middleware``</div><div class=""> their usage is discussed at the end of this Chapter.</div><div class=""> </div><div class=""> As an example, the following call on a typical system:</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/examples/default/status/x/y/z?p=1&amp;q=2</div><div class=""> ``:code</div><div class=""> </div><div class=""> results in the following ``request`` object:</div><div class=""> ``request``:inxx ``env``:inxx</div><div class=""> </div><div class=""> ----------</div><div class=""> variable | value</div><div class=""> request.application | examples</div><div class=""> Also notice the ``request.env.wsgi_*`` variables. They are specific to the wsgi</div><div class=""> ``response.files``:inxx</div><div class=""> ``response.flash``:inxx</div><div class=""> ``response.headers``:inxx</div><div class=""> ``response.meta``:inxx</div><div class=""> ``response.menu``:inxx</div><div class=""> ``response.postprocessing``:inxx</div><div class=""> ``response.render``:inxx</div><div class=""> ``response.status``:inxx</div><div class=""> ``response.stream``:inxx</div><div class=""> ``response.subtitle``:inxx</div><div class=""> ``response.title``:inxx</div><div class=""> ``response.toolbar``:inxx</div><div class=""> ``response.view``:inxx</div><div class=""> ``response.delimiters``:inxx</div><div class=""> ``response.js``:inxx</div><div class=""> ``response.write``:inxx</div><div class=""> ``response.include_files``:inxx</div><div class=""> ``response.include_meta``:inxx</div><div class=""> ``response.optimize_css``:inxx</div><div class=""> ``response.optimize_js``:inxx</div><div class="insert">+``response._caller``:inxx</div><div class=""> </div><div class=""> ``response`` is another instance of the ``Storage`` class. It contains the following:</div><div class=""> </div><div class=""> ``response.body``: a ``StringIO`` object into which web2py writes the output page body. NEVER CHANGE THIS VARIABLE.</div><div class=""> </div><div class=""> ``response.cookies``: similar to ``request.cookies``, but while the latter contains the cookies sent from the client to the server, the former contains cookies sent by the server to the client. The session cookie is handled automatically.</div><div class=""> </div><div class=""> ``response.download(request, db)``: a method used to implement the controller function that allows downloading of uploaded files. ``request.download`` expects the last ``arg`` in ``request.args`` to be the encoded filename (i.e., the filename generated at upload time and stored in the upload field). It extracts the upload field name and table name as well as the original filename from the encoded filename. ``response.download`` takes two optional arguments: ``chunk_size`` sets the size in bytes for chunked streaming (defaults to 64K), and ``attachments`` determines whether the downloaded file should be treated as an attachment or not (default to ``True``). Note, ``response.download`` is specifically for downloading files associated with ``db`` upload fields. Use ``response.stream`` (see below) for other types of file downloads and streaming. Also, note that it is not necessary to use ``response.download`` to access files uploaded to the /static folder -- static files can (and generally should) be accessed directly via URL (e.g., /app/static/files/myfile.pdf).</div><div class=""> </div><div class=""> ``response.files``: a list of .css, .js, coffee, and .less files required by the page. They will automatically be linked in the head of the standard &quot;layout.html&quot; via the included &quot;web2py_ajax.html&quot;. To include a new CSS, JS, COFFEE, or LESS file, just append it to this list. It will handle duplicates. The order is significant.</div><div class=""> </div><div class=""> ``response.include_files()`` generates html head tags to includes all ``response.files`` (used in &quot;views/web2py_ajax.html&quot;).</div><div class=""> </div><div class=""> ``response.flash``: optional parameter that may be included in the views. Normally used to notify the user about something that happened.</div><div class=""> </div><div class=""> ``response.headers``: a ``dict`` for HTTP response headers. Web2py sets some headers by default, including &quot;Content-Length&quot;, &quot;Content-Type&quot;, and &quot;X-Powered-By&quot; (set equal to web2py). Web2py also sets the &quot;Cache-Control&quot;, &quot;Expires&quot;, and &quot;Pragma&quot; headers to prevent client-side caching, except for static file requests, for which client-side caching is enabled. The headers that web2py sets can be overwritten or removed, and new headers can be added (e.g., ``response.headers[&#x27;Cache-Control&#x27;] = &#x27;private&#x27;``). You can remove a header removing its key from the response.headers dict, e.g.``del response.headers[&#x27;Custom-Header&#x27;]``, however web2py&#x27;s default headers will be re-added just before returning the response. To avoid this behaviour, just set the header value to None, e.g. to remove the default Content-Type header, ``response.headers[&#x27;Content-Type&#x27;] = None``</div><div class=""> </div><div class=""> ``response.menu``: optional parameter that may be included in the views, normally used to pass a navigation menu tree to the view. It can be rendered by the MENU helper.</div><div class=""> </div><div class=""> </div><div class=""> Also notice the ``request.env.wsgi_*`` variables. They are specific to the wsgi</div><div class=""> ``response.session_file``: file stream containing the session.</div><div class=""> </div><div class=""> ``response.session_file_name``: name of the file where the session will be saved.</div><div class=""> </div><div class=""> ``response.session_id``: the id of the current session. It is determined automatically. NEVER CHANGE THIS VARIABLE.</div><div class=""> </div><div class=""> ``response.session_id_name``: the name of the session cookie for this application. NEVER CHANGE THIS VARIABLE.</div><div class=""> </div><div class=""> ``response.status``: the HTTP status code integer to be passed to the response. Default is 200 (OK).</div><div class=""> </div><div class=""> ``response.stream(file, chunk_size, request=request, attachment=False, filename=None, headers=None)``: when a controller returns it, web2py streams the file content back to the client in blocks of size ``chunk_size``. The ``request`` parameter is required to use the chunk start in the HTTP header. ``file`` should be a file path (for backward compatibility, it can also be an open file object, but this is not recommended). As noted above, ``response.download`` should be used to retrieve files stored via an upload field. ``response.stream`` can be used in other cases, such as returning a temporary file or StringIO object created by the controller. If ``attachment`` is True, the Content-Disposition header will be set to &quot;attachment&quot;, and if ``filename`` is also provided, it will be added to the Content-Disposition header as well (but only when ``attachment`` is True). If not already included in ``response.headers``, the following response headers will be set automatically: Content-Type, Content-Length, Cache-Control, Pragma, and Last-Modified (the latter three are set to allow browser caching of the file). To override any of these automatic header settings, simply set them in ``response.headers`` before calling ``response.stream``.</div><div class=""> </div><div class=""> ``response.subtitle``: optional parameter that may be included in the views. It should contain the subtitle of the page.</div><div class=""> </div><div class=""> ``response.title``: optional parameter that may be included in the views. It should contain the title of the page and should be rendered by the HTML title TAG in the header.</div><div class=""> </div><div class=""> ``response.toolbar``: a function that allows you embed a toolbar into page form debugging purposes ``{{=response.toolbar()}}``. The toolbar displays request, response, session variables and database access time for each query.</div><div class=""> </div><div class=""> ``response._vars``: this variable is accessible only in a view, not in the action. It contains the value returned by the action to the view.</div><div class=""> </div><div class="insert">+``response._caller``: this is a function that wraps all action calls. It defaults to the idenity function but it can be modifed in order to catch special types of exception of do extra logging;</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+response._caller = lambda f: f()</div><div class="insert">+``</div><div class="insert">+</div><div class=""> ``response.optimize_css``: if can be set to &quot;concat,minify,inline&quot; to concatenate, minify and inline the CSS files included by web2py.</div><div class=""> </div><div class=""> ``response.optimize_js``: if can be set to &quot;concat,minify,inline&quot; to concatenate, minify and inline the JavaScript files included by web2py.</div><div class=""> </div><div class=""> ``response.view``: the name of the view template that must render the page. This is set by default to:</div><div class=""> ``</div><div class=""> &quot;%s/%s.%s&quot; % (request.controller, request.function, request.extension)</div><div class=""> ``:code</div><div class=""> </div><div class=""> or, if the above file cannot be located, to</div><div class=""> ``</div><div class=""> &quot;generic.%s&quot; % (request.extension)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Change the value of this variable to modify the view file associated with a particular action.</div><div class=""> </div><div class=""> ``response.delimiters`` defaults to ``(&#x27;{{&#x27;,&#x27;}}&#x27;)``. It allows you to change the delimiter of code embedded in views.</div><div class=""> </div><div class=""> ``response.xmlrpc(request, methods)``: when a controller returns it, this function exposes the methods via XML-RPC``xmlrpc``:cite . This function is deprecated since a better mechanism is available and described in Chapter 10.</div><div class=""> </div><div class=""> is simply a shortcut for:</div><div class=""> raise HTTP(303,</div><div class="">            &#x27;You are being redirected &lt;a href=&quot;%s&quot;&gt;here&lt;/a&gt;&#x27; % location,</div><div class="">            Location=&#x27;http://www.web2py.com&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The named arguments of the ``HTTP`` initializer method are translated into HTTP header directives, in this case, the redirection target location. ``redirect`` takes an optional second argument, which is the HTTP status code for the redirection (303 by default). Change this number to 307 for a temporary redirect or to 301 for a permanent redirect.</div><div class=""> </div><div class=""> The most common way to use redirect is to redirect to other pages in the same app and (optionally) pass parameters:</div><div class=""> </div><div class=""> ``</div><div class=""> redirect(URL(&#x27;index&#x27;, args=(1,2,3), vars=dict(a=&#x27;b&#x27;)))</div><div class=""> ``:code</div><div class=""> </div><div class=""> In chapter 12 we discuss web2py components. They make Ajax requests to web2py actions. If the called action performs a redirect, you may want the Ajax request to follow the redirect or you may want the entire page performing the Ajax request redirecting. In this latter case you can set:</div><div class=""> </div><div class=""> ``</div><div class=""> redirect(...,type=&#x27;auto&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class="insert">### ``T``<span class="highlight">,</span> Internationalization<span class="highlight">, and Pluralization</span></div><div class=""> ``T``:inxx ``internationalization``:inxx</div><div class=""> </div><div class=""> The object ``T`` is the language translator. It constitutes a single global instance of the web2py class ``gluon.language.translator``. All string constants (and only string constants) should be marked by ``T``, for example:</div><div class=""> ``</div><div class=""> a = T(&quot;hello world&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Strings that are marked with ``T`` are identified by web2py as needing language translation and they will be translated when the code (in the model, controller, or view) is executed. If the string to be translated is not a constant but a variable, it will be added to the translation file at runtime (except on GAE) to be translated later.</div><div class=""> </div><div class=""> The ``T`` object can also contain interpolated variables and support multiple equivalent syntax:</div><div class=""> ``</div><div class=""> a = T(&quot;hello %s&quot;, (&#x27;Tim&#x27;,))</div><div class=""> a = T(&quot;hello %(name)s&quot;, dict(name=&#x27;Tim&#x27;))</div><div class=""> a = T(&quot;hello %s&quot;) % (&#x27;Tim&#x27;,)</div><div class=""> a = T(&quot;hello %(name)s&quot;) % dict(name=&#x27;Tim&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The latter syntax is recommended because it makes translation easier.</div><div class=""> The first string is translated according to the requested language file and the ``name`` variable is replaced independently of the language.</div><div class=""> </div><div class=""> name + T(&quot; blah&quot;)   # invalid!</div><div class=""> ``:code</div><div class=""> </div><div class=""> The following code is also allowed and often preferable:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;blah %(name)s blah&quot;, dict(name=&#x27;Tim&#x27;))</div><div class=""> ``:code</div><div class=""> </div><div class=""> or the alternative syntax</div><div class=""> ``</div><div class=""> T(&quot;blah %(name)s blah&quot;) % dict(name=&#x27;Tim&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> In both cases the translation occurs before the variable name is substituted in the &quot;%(name)s&quot; slot. The following alternative should NOT BE USED:</div><div class=""> ``</div><div class=""> T(&quot;blah %(name)s blah&quot; % dict(name=&#x27;Tim&#x27;))</div><div class=""> ``:code</div><div class=""> </div><div class=""> because translation would occur after substitution.</div><div class=""> </div><div class="insert">+#### Determining the language</div><div class="insert">+</div><div class=""> The requested language is determined by the &quot;Accept-Language&quot; field in the HTTP header, but this selection can be overwritten programmatically by requesting a specific file, for example:</div><div class=""> ``</div><div class=""> T.force(&#x27;it-it&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> which reads the &quot;languages/it-it.py&quot; language file. Language files can be created and edited via the administrative interface.</div><div class=""> </div><div class=""> You can also force a per-string language:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;Hello World&quot;, language=&quot;it-it&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class="insert">+--------------</div><div class="insert">+In the case multiple languages are requested, for example &quot;it-it, fr-ft&quot;, web2py tries to locate &quot;it-it.py&quot; and &quot;fr-fr.py&quot; translation files. If none of the requested files is present, it tries to fallback on &quot;it.py&quot; and &quot;fr.py&quot;. If these files are not present it defaults to &quot;default.py&quot;. If this is not present either, it default to no-translation. The more genral rule is that web2py tries &quot;xx-xy-yy.py&quot;, &quot;xx-xy.py&quot;, &quot;xx.py&quot;, &quot;default.py&quot; for each of the &quot;xx-xy-yy&quot; accepted languages trying to find the closest match to the visitor&#x27;s preferences.</div><div class="insert">+-------------</div><div class="insert">+</div><div class=""> You can turn off translations completely via</div><div class=""> </div><div class=""> ``</div><div class=""> T.force(None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Normally, string translation is evaluated lazily when the view is rendered; hence, the translator ``force`` method should not be called inside a view.</div><div class=""> </div><div class=""> It is possible to disable lazy evaluation via</div><div class=""> ``</div><div class=""> T.lazy = False</div><div class=""> ``:code</div><div class=""> </div><div class=""> In this way, strings are translated immediately by the ``T`` operator based on the currently accepted or forced language.</div><div class=""> </div><div class=""> It is also possible to disable lazy evaluation for individual strings:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;Hello World&quot;, lazy=False)</div><div class=""> ``:code</div><div class=""> </div><div class=""> A common issue is the following. The original application is in English. Suppose that there is a translation file (for example Italian, &quot;it-it.py&quot;) and the HTTP client declares that it accepts both English (en) and Italian (it-it) in that order. The following unwanted situation occurs: web2py does not know the default is written in English (en). Therefore, it prefers translating everything into Italian (it-it) because it only found the Italian translation file. If it had not found the &quot;it-it.py&quot; file, it would have used the default language strings (English).</div><div class=""> </div><div class=""> There are two solutions for this problem: create a translation language for English, which would be redundant and unnecessary, or better, tell web2py which languages should use the default language strings (the strings coded into the application). This can be done with:</div><div class=""> ``</div><div class=""> T.set_current_languages(&#x27;en&#x27;, &#x27;en-en&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> It stores in  ``T.current_languages`` a list of languages that do not require translation and forces a reload of the language files.</div><div class=""> </div><div class=""> Notice that &quot;it&quot; and &quot;it-it&quot; are different languages from the point of view of web2py. To support both of them, one would need two translation files, always lower case. The same is true for all other languages.</div><div class=""> </div><div class=""> The currently accepted language is stored in</div><div class=""> ``</div><div class=""> T.accepted_language</div><div class=""> ``:code</div><div class=""> </div><div class="insert">+#### Translating variables</div><div class="insert">+</div><div class=""> Mind that T(...) does not just translate strings but can also translated variables:</div><div class=""> ``</div><div class=""> &gt;&gt;&gt; a=&quot;test&quot;</div><div class=""> &gt;&gt;&gt; print T(a)</div><div class=""> ``:code</div><div class=""> </div><div class=""> In this case the word &quot;test&quot; is translated but, if not found and if the filesystem is writable, it will add it to the list of words to be translated in the language file.</div><div class=""> </div><div class="insert">+#### Comments and multiple translations</div><div class="insert">+</div><div class="insert">+It is possible that the same string appers in different contexts in the application and needs different translations based on context. In order to do this, one can add comments to the original string. The comments will not be rendered but will be used by web2py to determine the most appropriate translation. For example:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+T(&quot;hello world ## first occurence&quot;)</div><div class="insert">+T(&quot;hello world ## second occurence&quot;)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+The text folloing the ``##``, including the double ``##``, are comments.</div><div class="insert">+</div><div class="insert">+#### Pluralization engine</div><div class="insert">+</div><div class="insert">+Since version 2.0, web2py include s power pluralization system (PS). This means that when text marked for translation depends on a numeric variable, it may be translated differently based on the numeric value. For example in english we may render: </div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+x book(s)</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+with</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+a book (x==0)</div><div class="insert">+x books (x&gt;0)</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+English has one singular form and one plural form. The plural form is constructed by adding a &quot;-s&quot; or &quot;-es&quot; or using an exceptional form. web2py provides a way to define pluralization rules for each languages, as well as exceptions to the default rules. In fact web2py already knows pluralization rules for many languages. It knows, for example, that Slovenian has one singular form and 3 plural forms (for x==1, x==3 or x==4 and x&gt;4). These ules are encoded in &quot;gluon/contrib/plural_rules/*.py&quot; files and new files can be created. Explicit pluralizations for words are created by editing pluralization files using the administrative interface.</div><div class="insert">+</div><div class="insert">+By default the PS is not activated. It is triggered by the ``symbol`` argument of the ``T`` function. For example:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+T(&quot;You have %s %%{book}&quot;, symbols=10)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Now the PS is activated for the work &quot;book&quot; and for the number 10.</div><div class="insert">+The result in english will be: &quot;You have 10 words&quot;. Notice that &quot;word&quot; has been pluralized into &quot;words&quot;.</div><div class="insert">+</div><div class="insert">+The PS consists from 3 parts:</div><div class="insert">+- placeholders ``%%{}`` to mark words in ``T``-messages</div><div class="insert">+- rule to give a decision which word form to use (&quot;rules/plural_rules/*.py&quot;)</div><div class="insert">+- dictionary with word plural forms (&quot;app/languages/plural-*.py&quot;)</div><div class="insert">+</div><div class="insert">+The value of symbols can be a single variable, a list/tuple of variables, or a dictionary.</div><div class="insert">+</div><div class="insert">+The placeholder ``%%{}`` consists of 3 parts:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+%%{[&lt;modifier&gt;]&lt;world&gt;[&lt;parameter&gt;]},</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+where:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+&lt;modifier&gt;::= ! | !! | !!!</div><div class="insert">+&lt;word&gt; ::= any world or phrase in singular in lower case (!)</div><div class="insert">+&lt;parameter&gt; ::= [index] | (key) | (number)</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+For example:</div><div class="insert">+</div><div class="insert">+- ``%%{word}`` is equivalent to %%{word[0]} (if no modifiers are used). </div><div class="insert">+- ``%%{word[index]}`` is used when symbols is a tuple. symbols[index] gives us a number used to make a decision on which word form to choose.</div><div class="insert">+- ``%%{word(key)}`` is used to get the numeric parameter from symbols[key]</div><div class="insert">+- ``%%{word(number)}`` allows to set a ``number`` directly (e.g.: ``%%{word(%i)}``)</div><div class="insert">+- ``%%{?word?number}`` returns &quot;word&quot; if ``number==1``, returns the ``number`` otherwise</div><div class="insert">+- ``%%{?number} or %%{??number}`` returns ``number`` if ``number!=1``, return nothing otherwise</div><div class="insert">+</div><div class="insert">+``T(&quot;blabla %s %%{word}&quot;, symbols=var)``</div><div class="insert">+</div><div class="insert">+``%%{word}`` by default means ``%%{word[0]}``, </div><div class="insert">+where ``[0]`` is an item index in symbols tuple.</div><div class="insert">+</div><div class="insert">+``T(&quot;blabla %s %s %%{word[1]}&quot;, (var1, var2))`` </div><div class="insert">+PS is used for &quot;word&quot; and var2 respectively.</div><div class="insert">+</div><div class="insert">+You can use several %%{} placeholders with one index:</div><div class="insert">+</div><div class="insert">+``T(&quot;%%{this} %%{is} %s %%{book}&quot;, var)``</div><div class="insert">+</div><div class="insert">+or</div><div class="insert">+</div><div class="insert">+``T(&quot;%%{this[0]} %%{is[0]} %s %%{book[0]}&quot;, var)``</div><div class="insert">+</div><div class="insert">+Generate:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+var  output</div><div class="insert">+------------------</div><div class="insert">+ 1   this is 1 book</div><div class="insert">+ 2   these are 2 books</div><div class="insert">+ 3   these are 2 books</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+Similarly you can pass a dictionary to symbols:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+T(&quot;blabla %(var1)s %(wordcnt)s %%{word(wordcnt)}&quot;, </div><div class="insert">+  dict(var1=&quot;tututu&quot;, wordcnt=20))</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+which produces </div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+blabla tututu 20 words</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+You can replace &quot;1&quot; with any word you wish by this placeholder ``%%{?word?number}``. </div><div class="insert">+For example</div><div class="insert">+</div><div class="insert">+``T(&quot;%%{this} %%{is} %%{?a?%s} %%{book}&quot;, var)``</div><div class="insert">+</div><div class="insert">+produces:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+var  output</div><div class="insert">+------------------</div><div class="insert">+ 1   this is a book</div><div class="insert">+ 2   these are 2 books</div><div class="insert">+ 3   these are 2 books</div><div class="insert">+ ... </div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+Inside ``%%{...}`` you can also use the following modifiers:</div><div class="insert">+</div><div class="insert">+- ``!`` to capitalize the text (equivalent to ``string.capitalize``)</div><div class="insert">+- ``!!`` to capitalize every word (equivalent to ``string.title``)</div><div class="insert">+- ``!!!`` to capitalize every character (equivalent to ``string.upper``)</div><div class="insert">+</div><div class="insert">+Notice you can use ``\`` to scape ``!`` and ``?``.</div><div class="insert">+</div><div class="insert">+#### Translations, plurlaization, and MARKMIN</div><div class="insert">+</div><div class="insert">+You can also use the powerful MARKMIN syntax inside translation strings by replacing</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+T(&quot;hello world&quot;)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+with</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+T.M(&quot;hello world&quot;)</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+Now the string accepts MARKMIN markup as described later in the book. You can also use the pluralization system inside MARKMIN.</div><div class="insert">+</div><div class=""> ### &#x27;&#x27;Cookies&#x27;&#x27;</div><div class=""> ``cookies``:inxx</div><div class=""> </div><div class=""> web2py uses the Python cookies modules for handling cookies.</div><div class=""> </div><div class=""> Cookies from the browser are in ``request.cookies`` and cookies sent by the server are in ``response.cookies``.</div><div class=""> </div><div class=""> You can set a cookie as follows:</div><div class=""> ``</div><div class=""> response.cookies[&#x27;mycookie&#x27;] = &#x27;somevalue&#x27;</div><div class=""> response.cookies[&#x27;mycookie&#x27;][&#x27;expires&#x27;] = 24 * 3600</div><div class=""> response.cookies[&#x27;mycookie&#x27;][&#x27;path&#x27;] = &#x27;/&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class=""> The second line tells the browser to keep the cookie for 24 hours. The third line tells the browser to send the cookie back to any application (URL path) at the current domain. Note, if you do not specify a path for the cookie, the browser will assume the path of the URL that was requested, so the cookie will only be returned to the server when that same URL path is requested.</div><div class=""> </div><div class=""> The cookie can be made secure with:</div><div class=""> ``</div><div class=""> response.cookies[&#x27;mycookie&#x27;][&#x27;secure&#x27;] = True</div><div class=""> ``:code</div><div class=""> For each tuple, the first string is matched against &quot;[app name]/[error code]&quot;. I</div><div class=""> - ``ticket``: in the form of &quot;[app name]/[ticket number]&quot; (or &quot;None&quot; if no ticket)</div><div class=""> - ``requested_uri``: equivalent to ``request.env.request_uri``</div><div class=""> - ``request_url``: equivalent to ``request.url``</div><div class=""> </div><div class=""> These variables will be accessible to the error handling action via ``request.vars`` and can be used in generating the error response. In particular, it is a good idea for the error action to return the original HTTP error code instead of the default 200 (OK) status code. This can be done by setting ``response.status = request.vars.code``. It is also possible to have the error action send (or queue) an email to an administrator, including a link to the ticket in ``admin``.</div><div class=""> </div><div class=""> Unmatched errors display a default error page. This default error page can also be customized here (see ``router.example.py`` and ``routes.example.py`` in the root web2py folder):</div><div class=""> ``</div><div class=""> error_message = &#x27;&lt;html&gt;&lt;body&gt;&lt;h1&gt;%s&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&#x27;</div><div class=""> error_message_ticket = &#x27;&#x27;&#x27;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Internal error&lt;/h1&gt;</div><div class="">      Ticket issued: &lt;a href=&quot;/admin/default/ticket/%(ticket)s&quot;</div><div class="">      target=&quot;_blank&quot;&gt;%(ticket)s&lt;/a&gt;&lt;/body&gt;&lt;/html&gt;&#x27;&#x27;&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class=""> The first variable contains the error message when an invalid application or function is requested. The second variable contains the error message when a ticket is issued.</div><div class=""> </div><div class=""> -------</div><div class=""> ``routes_onerror`` work with both routing mechanisms</div><div class=""> -------</div><div class=""> </div><div class="insert">+``error_handler``:inxx</div><div class="insert">+In &quot;routes.py&quot; ne can also specify an action in charge of error handling:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+error_handler = dict(application=&#x27;error&#x27;,                                               </div><div class="insert">+                      controller=&#x27;default&#x27;,                                              </div><div class="insert">+                      function=&#x27;index&#x27;)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+If the ``error_handler`` is specified the action is called without user redirection and the handler action will be in charge of dealing with the error. In the event that the error-handling page itself returns an error, web2py will fall back to its old static responses.</div><div class="insert">+</div><div class="insert">+</div><div class="insert">+### Static asset management</div><div class=""> </div><div class=""> Since version 2.1.0, web2py has the ability to manage static assets.</div><div class=""> </div><div class=""> When an application is in development, static file can change often, therefore web2py sends static files with no cache headers. This has the side-effect of &quot;forcing&quot; the browser to request static files at every request. This resulst in low performance when loading the page.</div><div class=""> </div><div class=""> In a &quot;production&quot; site, you may want to serve static files with ``cache`` headers to prevent un-necessary downloads since static files do not change.</div><div class=""> </div><div class=""> ``cache`` headers allow the browser to fetch each file only once, thus saving bandwidth and reducing loading time.</div><div class=""> </div><div class=""> Yet there is a problem: What should the cache headers declare? When should the files expire? When the files are first served, the server cannot forecast when they will be changed. </div><div class=""> </div><div class=""> A manual approach consists of creating subfolders for different versions of static files. For example an early version of &quot;layout.css&quot; can be made available at the URL &quot;/myapp/static/css/1.2.3/layout.css&quot;. When you cahnge the file, you create a new subfolder and you link it as &quot;/myapp/static/css/1.2.4/layout.css&quot;.</div><div class=""> </div><div class=""> This procedure works but it is pedantic since everytime you update the css file, you must remember to move it to another folder, change the url of the file in your layout.html and deploy.</div><div class=""> </div><div class=""> Static asset management solves the problem by allowing the developer to declare a version for a group of static files and they will be requested again only when the version number changes. The version number of made part of the file url as in the previous example. The difference from the previous approach is that the version number only appears in the URL, not in the file system.</div><div class=""> </div><div class=""> </div><div class=""> If you want to serve &quot;/myapp/static/layout.css&quot; with the cache headers, you just need to include the file with a modified URL that includes a version number:</div><div class=""> ``</div><div class=""> into this:</div><div class=""> ``</div><div class=""> AliasMatch ^/([^/]+)/static/(?:/_[\d]+\.[\d]+\.[\d]+)?(.*) \</div><div class="">    /home/www-data/web2py/applications/$1/static/$2</div><div class=""> ``</div><div class=""> </div><div class=""> Similarly, in Nginx change this:</div><div class=""> ``</div><div class=""> location ~* /(\w+)/static/ {</div><div class="">     root /home/www-data/web2py/applications/;</div><div class="">     expires max;</div><div class=""> }</div><div class=""> ``</div><div class=""> into this:</div><div class=""> ``</div><div class=""> location ~* /(\w+)/static(?:/_[\d]+\.[\d]+\.[\d]+)?/(.*)$ {</div><div class="">    alias /home/www-data/web2py/applications/$1/static/$2;</div><div class="">    expires max;</div><div class=""> }</div><div class=""> ``</div><div class=""> </div><div class=""> ### Running tasks in the background</div></div></div>
    <div class="span6"><div class="diff"><div class=""> - ``request.wsgi`` is a hook that allows you to call third party WSGI applications from inside actions</div><div class=""> </div><div class=""> The latter includes:</div><div class=""> - ``request.wsgi.environ``</div><div class=""> - ``request.wsgi.start_response``</div><div class=""> - ``request.wsgi.middleware``</div><div class=""> their usage is discussed at the end of this Chapter.</div><div class=""> </div><div class=""> As an example, the following call on a typical system:</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/examples/default/status/x/y/z?p=1&amp;q=2</div><div class=""> ``:code</div><div class=""> </div><div class=""> results in the following ``request`` object:</div><div class=""> ``request``:inxx ``env``:inxx</div><div class=""> </div><div class=""> ----------</div><div class=""> variable | value</div><div class=""> request.application | examples</div><div class=""> Also notice the ``request.env.wsgi_*`` variables. They are specific to the wsgi</div><div class=""> ``response.files``:inxx</div><div class=""> ``response.flash``:inxx</div><div class=""> ``response.headers``:inxx</div><div class=""> ``response.meta``:inxx</div><div class=""> ``response.menu``:inxx</div><div class=""> ``response.postprocessing``:inxx</div><div class=""> ``response.render``:inxx</div><div class=""> ``response.status``:inxx</div><div class=""> ``response.stream``:inxx</div><div class=""> ``response.subtitle``:inxx</div><div class=""> ``response.title``:inxx</div><div class=""> ``response.toolbar``:inxx</div><div class=""> ``response.view``:inxx</div><div class=""> ``response.delimiters``:inxx</div><div class=""> ``response.js``:inxx</div><div class=""> ``response.write``:inxx</div><div class=""> ``response.include_files``:inxx</div><div class=""> ``response.include_meta``:inxx</div><div class=""> ``response.optimize_css``:inxx</div><div class=""> ``response.optimize_js``:inxx</div><div class=""> </div><div class=""> ``response`` is another instance of the ``Storage`` class. It contains the following:</div><div class=""> </div><div class=""> ``response.body``: a ``StringIO`` object into which web2py writes the output page body. NEVER CHANGE THIS VARIABLE.</div><div class=""> </div><div class=""> ``response.cookies``: similar to ``request.cookies``, but while the latter contains the cookies sent from the client to the server, the former contains cookies sent by the server to the client. The session cookie is handled automatically.</div><div class=""> </div><div class=""> ``response.download(request, db)``: a method used to implement the controller function that allows downloading of uploaded files. ``request.download`` expects the last ``arg`` in ``request.args`` to be the encoded filename (i.e., the filename generated at upload time and stored in the upload field). It extracts the upload field name and table name as well as the original filename from the encoded filename. ``response.download`` takes two optional arguments: ``chunk_size`` sets the size in bytes for chunked streaming (defaults to 64K), and ``attachments`` determines whether the downloaded file should be treated as an attachment or not (default to ``True``). Note, ``response.download`` is specifically for downloading files associated with ``db`` upload fields. Use ``response.stream`` (see below) for other types of file downloads and streaming. Also, note that it is not necessary to use ``response.download`` to access files uploaded to the /static folder -- static files can (and generally should) be accessed directly via URL (e.g., /app/static/files/myfile.pdf).</div><div class=""> </div><div class=""> ``response.files``: a list of .css, .js, coffee, and .less files required by the page. They will automatically be linked in the head of the standard &quot;layout.html&quot; via the included &quot;web2py_ajax.html&quot;. To include a new CSS, JS, COFFEE, or LESS file, just append it to this list. It will handle duplicates. The order is significant.</div><div class=""> </div><div class=""> ``response.include_files()`` generates html head tags to includes all ``response.files`` (used in &quot;views/web2py_ajax.html&quot;).</div><div class=""> </div><div class=""> ``response.flash``: optional parameter that may be included in the views. Normally used to notify the user about something that happened.</div><div class=""> </div><div class=""> ``response.headers``: a ``dict`` for HTTP response headers. Web2py sets some headers by default, including &quot;Content-Length&quot;, &quot;Content-Type&quot;, and &quot;X-Powered-By&quot; (set equal to web2py). Web2py also sets the &quot;Cache-Control&quot;, &quot;Expires&quot;, and &quot;Pragma&quot; headers to prevent client-side caching, except for static file requests, for which client-side caching is enabled. The headers that web2py sets can be overwritten or removed, and new headers can be added (e.g., ``response.headers[&#x27;Cache-Control&#x27;] = &#x27;private&#x27;``). You can remove a header removing its key from the response.headers dict, e.g.``del response.headers[&#x27;Custom-Header&#x27;]``, however web2py&#x27;s default headers will be re-added just before returning the response. To avoid this behaviour, just set the header value to None, e.g. to remove the default Content-Type header, ``response.headers[&#x27;Content-Type&#x27;] = None``</div><div class=""> </div><div class=""> ``response.menu``: optional parameter that may be included in the views, normally used to pass a navigation menu tree to the view. It can be rendered by the MENU helper.</div><div class=""> </div><div class=""> </div><div class=""> Also notice the ``request.env.wsgi_*`` variables. They are specific to the wsgi</div><div class=""> ``response.session_file``: file stream containing the session.</div><div class=""> </div><div class=""> ``response.session_file_name``: name of the file where the session will be saved.</div><div class=""> </div><div class=""> ``response.session_id``: the id of the current session. It is determined automatically. NEVER CHANGE THIS VARIABLE.</div><div class=""> </div><div class=""> ``response.session_id_name``: the name of the session cookie for this application. NEVER CHANGE THIS VARIABLE.</div><div class=""> </div><div class=""> ``response.status``: the HTTP status code integer to be passed to the response. Default is 200 (OK).</div><div class=""> </div><div class=""> ``response.stream(file, chunk_size, request=request, attachment=False, filename=None, headers=None)``: when a controller returns it, web2py streams the file content back to the client in blocks of size ``chunk_size``. The ``request`` parameter is required to use the chunk start in the HTTP header. ``file`` should be a file path (for backward compatibility, it can also be an open file object, but this is not recommended). As noted above, ``response.download`` should be used to retrieve files stored via an upload field. ``response.stream`` can be used in other cases, such as returning a temporary file or StringIO object created by the controller. If ``attachment`` is True, the Content-Disposition header will be set to &quot;attachment&quot;, and if ``filename`` is also provided, it will be added to the Content-Disposition header as well (but only when ``attachment`` is True). If not already included in ``response.headers``, the following response headers will be set automatically: Content-Type, Content-Length, Cache-Control, Pragma, and Last-Modified (the latter three are set to allow browser caching of the file). To override any of these automatic header settings, simply set them in ``response.headers`` before calling ``response.stream``.</div><div class=""> </div><div class=""> ``response.subtitle``: optional parameter that may be included in the views. It should contain the subtitle of the page.</div><div class=""> </div><div class=""> ``response.title``: optional parameter that may be included in the views. It should contain the title of the page and should be rendered by the HTML title TAG in the header.</div><div class=""> </div><div class=""> ``response.toolbar``: a function that allows you embed a toolbar into page form debugging purposes ``{{=response.toolbar()}}``. The toolbar displays request, response, session variables and database access time for each query.</div><div class=""> </div><div class=""> ``response._vars``: this variable is accessible only in a view, not in the action. It contains the value returned by the action to the view.</div><div class=""> </div><div class=""> ``response.optimize_css``: if can be set to &quot;concat,minify,inline&quot; to concatenate, minify and inline the CSS files included by web2py.</div><div class=""> </div><div class=""> ``response.optimize_js``: if can be set to &quot;concat,minify,inline&quot; to concatenate, minify and inline the JavaScript files included by web2py.</div><div class=""> </div><div class=""> ``response.view``: the name of the view template that must render the page. This is set by default to:</div><div class=""> ``</div><div class=""> &quot;%s/%s.%s&quot; % (request.controller, request.function, request.extension)</div><div class=""> ``:code</div><div class=""> </div><div class=""> or, if the above file cannot be located, to</div><div class=""> ``</div><div class=""> &quot;generic.%s&quot; % (request.extension)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Change the value of this variable to modify the view file associated with a particular action.</div><div class=""> </div><div class=""> ``response.delimiters`` defaults to ``(&#x27;{{&#x27;,&#x27;}}&#x27;)``. It allows you to change the delimiter of code embedded in views.</div><div class=""> </div><div class=""> ``response.xmlrpc(request, methods)``: when a controller returns it, this function exposes the methods via XML-RPC``xmlrpc``:cite . This function is deprecated since a better mechanism is available and described in Chapter 10.</div><div class=""> </div><div class=""> is simply a shortcut for:</div><div class=""> raise HTTP(303,</div><div class="">            &#x27;You are being redirected &lt;a href=&quot;%s&quot;&gt;here&lt;/a&gt;&#x27; % location,</div><div class="">            Location=&#x27;http://www.web2py.com&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The named arguments of the ``HTTP`` initializer method are translated into HTTP header directives, in this case, the redirection target location. ``redirect`` takes an optional second argument, which is the HTTP status code for the redirection (303 by default). Change this number to 307 for a temporary redirect or to 301 for a permanent redirect.</div><div class=""> </div><div class=""> The most common way to use redirect is to redirect to other pages in the same app and (optionally) pass parameters:</div><div class=""> </div><div class=""> ``</div><div class=""> redirect(URL(&#x27;index&#x27;, args=(1,2,3), vars=dict(a=&#x27;b&#x27;)))</div><div class=""> ``:code</div><div class=""> </div><div class=""> In chapter 12 we discuss web2py components. They make Ajax requests to web2py actions. If the called action performs a redirect, you may want the Ajax request to follow the redirect or you may want the entire page performing the Ajax request redirecting. In this latter case you can set:</div><div class=""> </div><div class=""> ``</div><div class=""> redirect(...,type=&#x27;auto&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class="delete">### ``T``<span class="highlight"> and</span> Internationalization<span class="highlight"></span></div><div class=""> ``T``:inxx ``internationalization``:inxx</div><div class=""> </div><div class=""> The object ``T`` is the language translator. It constitutes a single global instance of the web2py class ``gluon.language.translator``. All string constants (and only string constants) should be marked by ``T``, for example:</div><div class=""> ``</div><div class=""> a = T(&quot;hello world&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Strings that are marked with ``T`` are identified by web2py as needing language translation and they will be translated when the code (in the model, controller, or view) is executed. If the string to be translated is not a constant but a variable, it will be added to the translation file at runtime (except on GAE) to be translated later.</div><div class=""> </div><div class=""> The ``T`` object can also contain interpolated variables and support multiple equivalent syntax:</div><div class=""> ``</div><div class=""> a = T(&quot;hello %s&quot;, (&#x27;Tim&#x27;,))</div><div class=""> a = T(&quot;hello %(name)s&quot;, dict(name=&#x27;Tim&#x27;))</div><div class=""> a = T(&quot;hello %s&quot;) % (&#x27;Tim&#x27;,)</div><div class=""> a = T(&quot;hello %(name)s&quot;) % dict(name=&#x27;Tim&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The latter syntax is recommended because it makes translation easier.</div><div class=""> The first string is translated according to the requested language file and the ``name`` variable is replaced independently of the language.</div><div class=""> </div><div class=""> name + T(&quot; blah&quot;)   # invalid!</div><div class=""> ``:code</div><div class=""> </div><div class=""> The following code is also allowed and often preferable:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;blah %(name)s blah&quot;, dict(name=&#x27;Tim&#x27;))</div><div class=""> ``:code</div><div class=""> </div><div class=""> or the alternative syntax</div><div class=""> ``</div><div class=""> T(&quot;blah %(name)s blah&quot;) % dict(name=&#x27;Tim&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> In both cases the translation occurs before the variable name is substituted in the &quot;%(name)s&quot; slot. The following alternative should NOT BE USED:</div><div class=""> ``</div><div class=""> T(&quot;blah %(name)s blah&quot; % dict(name=&#x27;Tim&#x27;))</div><div class=""> ``:code</div><div class=""> </div><div class=""> because translation would occur after substitution.</div><div class=""> </div><div class=""> The requested language is determined by the &quot;Accept-Language&quot; field in the HTTP header, but this selection can be overwritten programmatically by requesting a specific file, for example:</div><div class=""> ``</div><div class=""> T.force(&#x27;it-it&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> which reads the &quot;languages/it-it.py&quot; language file. Language files can be created and edited via the administrative interface.</div><div class=""> </div><div class=""> You can also force a per-string language:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;Hello World&quot;, language=&quot;it-it&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> You can turn off translations completely via</div><div class=""> </div><div class=""> ``</div><div class=""> T.force(None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Normally, string translation is evaluated lazily when the view is rendered; hence, the translator ``force`` method should not be called inside a view.</div><div class=""> </div><div class=""> It is possible to disable lazy evaluation via</div><div class=""> ``</div><div class=""> T.lazy = False</div><div class=""> ``:code</div><div class=""> </div><div class=""> In this way, strings are translated immediately by the ``T`` operator based on the currently accepted or forced language.</div><div class=""> </div><div class=""> It is also possible to disable lazy evaluation for individual strings:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;Hello World&quot;, lazy=False)</div><div class=""> ``:code</div><div class=""> </div><div class=""> A common issue is the following. The original application is in English. Suppose that there is a translation file (for example Italian, &quot;it-it.py&quot;) and the HTTP client declares that it accepts both English (en) and Italian (it-it) in that order. The following unwanted situation occurs: web2py does not know the default is written in English (en). Therefore, it prefers translating everything into Italian (it-it) because it only found the Italian translation file. If it had not found the &quot;it-it.py&quot; file, it would have used the default language strings (English).</div><div class=""> </div><div class=""> There are two solutions for this problem: create a translation language for English, which would be redundant and unnecessary, or better, tell web2py which languages should use the default language strings (the strings coded into the application). This can be done with:</div><div class=""> ``</div><div class=""> T.set_current_languages(&#x27;en&#x27;, &#x27;en-en&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> It stores in  ``T.current_languages`` a list of languages that do not require translation and forces a reload of the language files.</div><div class=""> </div><div class=""> Notice that &quot;it&quot; and &quot;it-it&quot; are different languages from the point of view of web2py. To support both of them, one would need two translation files, always lower case. The same is true for all other languages.</div><div class=""> </div><div class=""> The currently accepted language is stored in</div><div class=""> ``</div><div class=""> T.accepted_language</div><div class=""> ``:code</div><div class=""> </div><div class=""> Mind that T(...) does not just translate strings but can also translated variables:</div><div class=""> ``</div><div class=""> &gt;&gt;&gt; a=&quot;test&quot;</div><div class=""> &gt;&gt;&gt; print T(a)</div><div class=""> ``:code</div><div class=""> </div><div class=""> In this case the word &quot;test&quot; is translated but, if not found and if the filesystem is writable, it will add it to the list of words to be translated in the language file.</div><div class=""> </div><div class=""> ### &#x27;&#x27;Cookies&#x27;&#x27;</div><div class=""> ``cookies``:inxx</div><div class=""> </div><div class=""> web2py uses the Python cookies modules for handling cookies.</div><div class=""> </div><div class=""> Cookies from the browser are in ``request.cookies`` and cookies sent by the server are in ``response.cookies``.</div><div class=""> </div><div class=""> You can set a cookie as follows:</div><div class=""> ``</div><div class=""> response.cookies[&#x27;mycookie&#x27;] = &#x27;somevalue&#x27;</div><div class=""> response.cookies[&#x27;mycookie&#x27;][&#x27;expires&#x27;] = 24 * 3600</div><div class=""> response.cookies[&#x27;mycookie&#x27;][&#x27;path&#x27;] = &#x27;/&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class=""> The second line tells the browser to keep the cookie for 24 hours. The third line tells the browser to send the cookie back to any application (URL path) at the current domain. Note, if you do not specify a path for the cookie, the browser will assume the path of the URL that was requested, so the cookie will only be returned to the server when that same URL path is requested.</div><div class=""> </div><div class=""> The cookie can be made secure with:</div><div class=""> ``</div><div class=""> response.cookies[&#x27;mycookie&#x27;][&#x27;secure&#x27;] = True</div><div class=""> ``:code</div><div class=""> For each tuple, the first string is matched against &quot;[app name]/[error code]&quot;. I</div><div class=""> - ``ticket``: in the form of &quot;[app name]/[ticket number]&quot; (or &quot;None&quot; if no ticket)</div><div class=""> - ``requested_uri``: equivalent to ``request.env.request_uri``</div><div class=""> - ``request_url``: equivalent to ``request.url``</div><div class=""> </div><div class=""> These variables will be accessible to the error handling action via ``request.vars`` and can be used in generating the error response. In particular, it is a good idea for the error action to return the original HTTP error code instead of the default 200 (OK) status code. This can be done by setting ``response.status = request.vars.code``. It is also possible to have the error action send (or queue) an email to an administrator, including a link to the ticket in ``admin``.</div><div class=""> </div><div class=""> Unmatched errors display a default error page. This default error page can also be customized here (see ``router.example.py`` and ``routes.example.py`` in the root web2py folder):</div><div class=""> ``</div><div class=""> error_message = &#x27;&lt;html&gt;&lt;body&gt;&lt;h1&gt;%s&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&#x27;</div><div class=""> error_message_ticket = &#x27;&#x27;&#x27;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Internal error&lt;/h1&gt;</div><div class="">      Ticket issued: &lt;a href=&quot;/admin/default/ticket/%(ticket)s&quot;</div><div class="">      target=&quot;_blank&quot;&gt;%(ticket)s&lt;/a&gt;&lt;/body&gt;&lt;/html&gt;&#x27;&#x27;&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class=""> The first variable contains the error message when an invalid application or function is requested. The second variable contains the error message when a ticket is issued.</div><div class=""> </div><div class=""> -------</div><div class=""> ``routes_onerror`` work with both routing mechanisms</div><div class=""> -------</div><div class=""> </div><div class="delete">-#### Static asset management</div><div class=""> </div><div class=""> Since version 2.1.0, web2py has the ability to manage static assets.</div><div class=""> </div><div class=""> When an application is in development, static file can change often, therefore web2py sends static files with no cache headers. This has the side-effect of &quot;forcing&quot; the browser to request static files at every request. This resulst in low performance when loading the page.</div><div class=""> </div><div class=""> In a &quot;production&quot; site, you may want to serve static files with ``cache`` headers to prevent un-necessary downloads since static files do not change.</div><div class=""> </div><div class=""> ``cache`` headers allow the browser to fetch each file only once, thus saving bandwidth and reducing loading time.</div><div class=""> </div><div class=""> Yet there is a problem: What should the cache headers declare? When should the files expire? When the files are first served, the server cannot forecast when they will be changed. </div><div class=""> </div><div class=""> A manual approach consists of creating subfolders for different versions of static files. For example an early version of &quot;layout.css&quot; can be made available at the URL &quot;/myapp/static/css/1.2.3/layout.css&quot;. When you cahnge the file, you create a new subfolder and you link it as &quot;/myapp/static/css/1.2.4/layout.css&quot;.</div><div class=""> </div><div class=""> This procedure works but it is pedantic since everytime you update the css file, you must remember to move it to another folder, change the url of the file in your layout.html and deploy.</div><div class=""> </div><div class=""> Static asset management solves the problem by allowing the developer to declare a version for a group of static files and they will be requested again only when the version number changes. The version number of made part of the file url as in the previous example. The difference from the previous approach is that the version number only appears in the URL, not in the file system.</div><div class=""> </div><div class=""> </div><div class=""> If you want to serve &quot;/myapp/static/layout.css&quot; with the cache headers, you just need to include the file with a modified URL that includes a version number:</div><div class=""> ``</div><div class=""> into this:</div><div class=""> ``</div><div class=""> AliasMatch ^/([^/]+)/static/(?:/_[\d]+\.[\d]+\.[\d]+)?(.*) \</div><div class="">    /home/www-data/web2py/applications/$1/static/$2</div><div class=""> ``</div><div class=""> </div><div class=""> Similarly, in Nginx change this:</div><div class=""> ``</div><div class=""> location ~* /(\w+)/static/ {</div><div class="">     root /home/www-data/web2py/applications/;</div><div class="">     expires max;</div><div class=""> }</div><div class=""> ``</div><div class=""> into this:</div><div class=""> ``</div><div class=""> location ~* /(\w+)/static(?:/_[\d]+\.[\d]+\.[\d]+)?/(.*)$ {</div><div class="">    alias /home/www-data/web2py/applications/$1/static/$2;</div><div class="">    expires max;</div><div class=""> }</div><div class=""> ``</div><div class=""> </div><div class="delete">-</div><div class=""> ### Running tasks in the background</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/1cb1624695d89442155ab19b3a6a64640d6ba973">1cb1624</a><ul><li>Date : 2012-12-14</li><li>fixed book share.js</li></ul></li></ul>
<div class="row-fluid" id="com_1cb1624695d89442155ab19b3a6a64640d6ba973">
    <div class="span6"><div class="diff"><div class="insert">                        -W install|start|stop as Windows service<span class="highlight"> (use with -L)</span></div></div></div>
    <div class="span6"><div class="diff"><div class="delete">                        -W install|start|stop as Windows service<span class="highlight"></span></div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/8ea3f6b22b9717bd3d68e501bb882b71fa3117fa">8ea3f6b</a><ul><li>Date : 2012-12-05</li><li>info on static asset management, thanks Niphlod</li></ul></li></ul>
<div class="row-fluid" id="com_8ea3f6b22b9717bd3d68e501bb882b71fa3117fa">
    <div class="span6"><div class="diff"><div class="insert">+#### Static asset management</div><div class="insert">+</div><div class="insert">+Since version 2.1.0, web2py has the ability to manage static assets.</div><div class="insert">+</div><div class="insert">+When an application is in development, static file can change often, therefore web2py sends static files with no cache headers. This has the side-effect of &quot;forcing&quot; the browser to request static files at every request. This resulst in low performance when loading the page.</div><div class="insert">+</div><div class="insert">+In a &quot;production&quot; site, you may want to serve static files with ``cache`` headers to prevent un-necessary downloads since static files do not change.</div><div class="insert">+</div><div class="insert">+``cache`` headers allow the browser to fetch each file only once, thus saving bandwidth and reducing loading time.</div><div class="insert">+</div><div class="insert">+Yet there is a problem: What should the cache headers declare? When should the files expire? When the files are first served, the server cannot forecast when they will be changed. </div><div class="insert">+</div><div class="insert">+A manual approach consists of creating subfolders for different versions of static files. For example an early version of &quot;layout.css&quot; can be made available at the URL &quot;/myapp/static/css/1.2.3/layout.css&quot;. When you cahnge the file, you create a new subfolder and you link it as &quot;/myapp/static/css/1.2.4/layout.css&quot;.</div><div class="insert">+</div><div class="insert">+This procedure works but it is pedantic since everytime you update the css file, you must remember to move it to another folder, change the url of the file in your layout.html and deploy.</div><div class="insert">+</div><div class="insert">+Static asset management solves the problem by allowing the developer to declare a version for a group of static files and they will be requested again only when the version number changes. The version number of made part of the file url as in the previous example. The difference from the previous approach is that the version number only appears in the URL, not in the file system.</div><div class="insert">+</div><div class="insert">+</div><div class="insert">+If you want to serve &quot;/myapp/static/layout.css&quot; with the cache headers, you just need to include the file with a modified URL that includes a version number:</div><div class="insert">+``</div><div class="insert">+/myapp/static/_1.2.3/layout.css</div><div class="insert">+``</div><div class="insert">+(notice the URL defines a version number, it does not appear anywhere else).</div><div class="insert">+</div><div class="insert">+Notice tha URL starts with &quot;/myapp/static/&quot;, followed by a version number composed by an underscore and 3 integers separated by a period (as descrived in [[SemVer http://semver.org/]]), then followed by the filename. Also notice that you do not have to create a &quot;_1.2.3/&quot; folder.</div><div class="insert">+</div><div class="insert">+Every time the static file is requested with a version in the url, it will be served with &quot;far in the future&quot; cache headers, specifically:</div><div class="insert">+``</div><div class="insert">+Cache-Control : max-age=315360000</div><div class="insert">+Expires: Thu, 31 Dec 2037 23:59:59 GMT</div><div class="insert">+``</div><div class="insert">+This means that the browser will fetch those file only once, and they will be saved &quot;forever&quot; in the browser&#x27;s cache.</div><div class="insert">+</div><div class="insert">+Every time the &quot;_1.2.3/filename&quot; is requested, web2py will remove the version part from the path and serve your file with far in the future headers so they will be cached forever. If you changed the version number in the URL, this tricks the browser into thinking it is requesting a different file, and the file is fetched again.</div><div class="insert">+</div><div class="insert">+You can use &quot;_1.2.3&quot;, &quot;_0.0.0&quot;, &quot;_999.888.888&quot;, as long as the version starts with underscore followed by three numbers separated by period.</div><div class="insert">+ </div><div class="insert">+When in development, you can use ``response.files.append(...)`` to link the static URLs of static files. In this case you can include the &quot;_1.2.3/&quot; part manually, or you take advantage of a new parameter of the response object: ``response.static_version``.</div><div class="insert">+Just include the files the way you used to, for example</div><div class="insert">+``</div><div class="insert">+{{response.files.append(URL(&#x27;static&#x27;,&#x27;layout.css&#x27;))}}</div><div class="insert">+``</div><div class="insert">+and in models set</div><div class="insert">+``:code</div><div class="insert">+response.static_version = &#x27;1.2.3&#x27;</div><div class="insert">+``:code</div><div class="insert">+This will rewrite automatically every &quot;/myapp/static/layout.css&quot; url as &quot;/myapp/static/_1.2.3/layout.css&quot;, for every file included in ``response.files``.</div><div class="insert">+</div><div class="insert">+Often in production you let the webserver (apache, nginx, etc.) serve the static files. You need to adjust your configuration in such a way that it will &quot;skip&quot; the &quot;_1.2.3/&quot; part.</div><div class="insert">+</div><div class="insert">+For example, in Apache, change this:</div><div class="insert">+``</div><div class="insert">+AliasMatch ^/([^/]+)/static/(.*) \</div><div class="insert">+   /home/www-data/web2py/applications/$1/static/$2</div><div class="insert">+``</div><div class="insert">+into this:</div><div class="insert">+``</div><div class="insert">+AliasMatch ^/([^/]+)/static/(?:/_[\d]+\.[\d]+\.[\d]+)?(.*) \</div><div class="insert">+   /home/www-data/web2py/applications/$1/static/$2</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+Similarly, in Nginx change this:</div><div class="insert">+``</div><div class="insert">+location ~* /(\w+)/static/ {</div><div class="insert">+    root /home/www-data/web2py/applications/;</div><div class="insert">+    expires max;</div><div class="insert">+}</div><div class="insert">+``</div><div class="insert">+into this:</div><div class="insert">+``</div><div class="insert">+location ~* /(\w+)/static(?:/_[\d]+\.[\d]+\.[\d]+)?/(.*)$ {</div><div class="insert">+   alias /home/www-data/web2py/applications/$1/static/$2;</div><div class="insert">+   expires max;</div><div class="insert">+}</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+</div><div class=""> ### Running tasks in the background</div></div></div>
    <div class="span6"><div class="diff"><div class=""> ### Running tasks in the background</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/cff9eceaf2725218af443dfeafc2d37b98c5fb21">cff9ece</a><ul><li>Date : 2012-11-15</li><li>instruction to remove a response.headers thanks niphlod</li></ul></li></ul>
<div class="row-fluid" id="com_cff9eceaf2725218af443dfeafc2d37b98c5fb21">
    <div class="span6"><div class="diff"><div class="insert">``response.headers``: a ``dict`` for HTTP response headers. Web2py sets some headers by default, including &quot;Content-Length&quot;, &quot;Content-Type&quot;, and &quot;X-Powered-By&quot; (set equal to web2py). Web2py also sets the &quot;Cache-Control&quot;, &quot;Expires&quot;, and &quot;Pragma&quot; headers to prevent client-side caching, except for static file requests, for which client-side caching is enabled. The headers that web2py sets can be overwritten or removed, and new headers can be added (e.g., ``response.headers[&#x27;Cache-Control&#x27;] = &#x27;private&#x27;``).<span class="highlight"> You can remove a header removing its key from the response.headers dict, e.g.``del response.headers[&#x27;Custom-Header&#x27;]``, however web2py&#x27;s default headers will be re-added just before returning the response. To avoid this behaviour, just set the header value to None, e.g. to remove the default Content-Type header, ``response.headers[&#x27;Content-Type&#x27;] = None``</span></div></div></div>
    <div class="span6"><div class="diff"><div class="delete">``response.headers``: a ``dict`` for HTTP response headers. Web2py sets some headers by default, including &quot;Content-Length&quot;, &quot;Content-Type&quot;, and &quot;X-Powered-By&quot; (set equal to web2py). Web2py also sets the &quot;Cache-Control&quot;, &quot;Expires&quot;, and &quot;Pragma&quot; headers to prevent client-side caching, except for static file requests, for which client-side caching is enabled. The headers that web2py sets can be overwritten or removed, and new headers can be added (e.g., ``response.headers[&#x27;Cache-Control&#x27;] = &#x27;private&#x27;``).<span class="highlight"></span></div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/edfb809206bafa44b393537366c2ab240226941a">edfb809</a><ul><li>Date : 2012-11-14</li><li>typos and updates</li></ul></li></ul>
<div class="row-fluid" id="com_edfb809206bafa44b393537366c2ab240226941a">
    <div class="span6"><div class="diff"><div class="insert">URLs are only allowed to contain alphanumeric characters, underscores, and slashes; the ``args`` may contain non-consecutive dots. Spaces are replaced by underscores before validation. If the URL syntax is invalid, web2py returns an HTTP 400 error message``http<span class="highlight">-w``</span>:<span class="highlight">cite ``http-o``</span>:<span class="highlight"></span>cite .</div><div class=""> </div><div class=""> If the URL corresponds to a request for a static file, web2py simply reads and returns (streams) the requested file.</div><div class=""> </div><div class=""> If the URL does not request a static file, web2py processes the request in the following order:</div><div class=""> - Parses cookies.</div><div class=""> - Creates an environment in which to execute the function.</div><div class=""> - Initializes ``request``, ``response``, ``cache``.</div><div class=""> - Opens the existing ``session`` or creates a new one.</div><div class=""> - Executes the models belonging to the requested application.</div><div class=""> - Executes the requested controller action function.</div><div class=""> - If the function returns a dictionary, executes the associated view.</div><div class=""> - On success, commits all open transactions.</div><div class=""> - Saves the session.</div><div class=""> - Returns an HTTP response.</div><div class=""> </div><div class=""> Notice that the controller and the view are executed in different copies of the same environment; therefore, the view does not see the controller, but it sees the models and it sees the variables returned by the controller action function.</div><div class=""> </div><div class=""> If an exception (other than HTTP) is raised, web2py does the following:</div><div class=""> - Stores the traceback in an error file and assigns a ticket number to it.</div><div class=""> - Rolls back all open transactions.</div><div class=""> gluon/__init__.py    gluon/highlight.py   gluon/restricted.py  gluon/streamer.py</div><div class=""> gluon/admin.py       gluon/html.py        gluon/rewrite.py     gluon/template.py</div><div class=""> gluon/cache.py       gluon/http.py        gluon/rocket.py      gluon/storage.py</div><div class=""> gluon/cfs.py         gluon/import_all.py  gluon/sanitizer.py   gluon/tools.py</div><div class=""> gluon/compileapp.py  gluon/languages.py   gluon/serializers.py gluon/utils.py</div><div class=""> gluon/contenttype.py gluon/main.py        gluon/settings.py    gluon/validators.py</div><div class=""> gluon/dal.py         gluon/myregex.py     gluon/shell.py       gluon/widget.py</div><div class=""> gluon/decoder.py     gluon/newcron.py     gluon/sql.py         gluon/winservice.py</div><div class=""> gluon/fileutils.py   gluon/portalocker.py gluon/sqlhtml.py     gluon/xmlrpc.py</div><div class=""> gluon/globals.py     gluon/reserved_sql_keywords.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> The tar gzipped scaffolding app that ship with web2py is</div><div class=""> ``</div><div class=""> welcome.w2p</div><div class=""> ``:code</div><div class=""> </div><div class=""> It is created upon installation and overwritten on upgrade.</div><div class=""> </div><div class=""> -------</div><div class=""> The first time you start web2py, two new folders are created: deposit and applications. The &quot;welcome&quot; app is zipped into a &quot;welcome.w2p&quot; file to be used as a scaffolding app.</div><div class=""> The deposit folder is used as temporary storage for installing and uninstalling applications.</div><div class=""> -------</div><div class=""> </div><div class=""> web2py unit-tests are in</div><div class=""> ``</div><div class=""> gluon/tests/</div><div class=""> ``:code</div><div class=""> </div><div class=""> There are handlers for connecting with various web servers:</div><div class=""> ``</div><div class=""> cgihandler.py       # discouraged</div><div class=""> gaehandler.py       # for Google App Engine</div><div class=""> fcgihandler.py      # for FastCGI</div><div class=""> wsgihandler.py      # for WSGI</div><div class=""> isapiwsgihandler.py # for IIS</div><div class=""> modpythonhandler.py # deprecated</div><div class=""> ``:code</div><div class=""> </div><div class=""> (&quot;fcgihandler&quot; calls  &quot;gluon/contrib/gateways/fcgi.py&quot; developed by Allan Saddi) and</div><div class=""> </div><div class=""> ``</div><div class=""> anyserver.py</div><div class=""> ``</div><div class=""> </div><div class=""> which is a script to interface with many different web servers, described in Chapter 13.</div><div class=""> </div><div class=""> There are three example files:</div><div class=""> ``</div><div class=""> options_std.py</div><div class=""> routes.example.py</div><div class=""> router.example.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> The former is an optional configuration file that can be passed to web2py.py with the ``-L`` option. The second is an example of a URL mapping file. It is loaded automatically when renamed &quot;routes.py&quot;. The third is an alternative syntax for URL mapping, and can also be renamed (or copied to) &quot;routes.py&quot;.</div><div class=""> </div><div class=""> The files</div><div class=""> ``</div><div class="insert">+app.example.yaml</div><div class="insert">+queue.example.yaml</div><div class=""> ``:code</div><div class=""> </div><div class="insert">ar<span class="highlight">e exampl</span>e configuration files used for deployment on the Google App Engine. You can read more about them in the Deployment Recipes chapter and on the Google Documentation pages.</div><div class=""> </div><div class=""> There are also additional libraries, usually developed by a third party:</div><div class=""> </div><div class=""> **feedparser**``feedparser``:cite  by Mark Pilgrim for reading RSS and Atom feeds:</div><div class=""> ``</div><div class=""> gluon/contrib/__init__.py</div><div class=""> gluon/contrib/feedparser.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> **markdown2**``markdown2``:cite  by Trent Mick for wiki markup:</div><div class=""> ``</div><div class=""> gluon/contrib/markdown/__init__.py</div><div class=""> gluon/contrib/markdown/markdown2.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> **markmin** markup:</div><div class=""> ``</div><div class="insert">gluon/contrib/markmin<span class="highlight"></span></div><div class=""> ``:code</div><div class=""> </div><div class=""> **fpdf** created my Mariano Reingart for generating PDF documents:</div><div class=""> ``</div><div class=""> gluon/contrib/fpdf</div><div class=""> ``</div><div class=""> This is not documented in this book but it is hosted and documented here:</div><div class=""> ``</div><div class="insert">http://code.google.com/p/<span class="highlight">py</span>fpdf/</div><div class=""> ``</div><div class=""> </div><div class=""> **pysimplesoap** is a lightweight SOAP server implementation created by Mariano Reingart:</div><div class=""> </div><div class=""> ``</div><div class=""> gluon/contrib/pysimplesoap/</div><div class=""> ``:code</div><div class=""> </div><div class=""> **simplejsonrpc** is a lightweight JSON-RPC client also created by Mariano Reingart: ``jsonrpc``:inxx</div><div class=""> </div><div class=""> ``</div><div class=""> gluon/contrib/simplejsonrpc.py</div><div class=""> ``</div><div class=""> </div><div class=""> **memcache**``memcache``:cite  Python API by Evan Martin:</div><div class=""> ``</div><div class=""> gluon/contrib/memcache/__init__.py</div><div class=""> gluon/contrib/memcache/memcache.py</div><div class=""> ``</div><div class=""> </div><div class=""> The ``request`` object is an instance of the ubiquitous web2py class that is cal</div><div class=""> request.vars</div><div class=""> ``:code</div><div class=""> </div><div class=""> is the same as:</div><div class=""> ``</div><div class=""> request[&#x27;vars&#x27;]</div><div class=""> ``:code</div><div class=""> </div><div class=""> Unlike a dictionary, if an attribute (or key) does not exist, it does not raise an exception. Instead, it returns ``None``.</div><div class=""> </div><div class=""> -----</div><div class=""> It is sometimes useful to create your own Storage objects. You can do so as follows:</div><div class=""> ``</div><div class=""> from gluon.storage import Storage</div><div class=""> my_storage = Storage() # empty storage object</div><div class=""> my_other_storage = Storage(dict(a=1, b=2)) # convert dictionary to Storage</div><div class=""> ``:code</div><div class=""> -----</div><div class=""> </div><div class=""> ``request`` has the following items/attributes, some of which are also an instance of the ``Storage`` class:</div><div class="insert">- ``request.cookies``: a ``Cookie.SimpleCookie()`` object containing the cookies passed with the HTTP request. It acts like a dictionary of cookies. Each cookie is a Morsel object<span class="highlight"> (see http://docs.python.org/2/library/cookie.html#id2).</span></div><div class=""> - ``request.env``: a ``Storage`` object containing the environment variables passed to the controller, including HTTP header variables from the HTTP request and standard WSGI parameters. The environment variables are all converted to lower case, and dots are converted to underscores for easier memorization.</div><div class=""> - ``request.application``: the name of the requested application (parsed from ``request.env.path_info``).</div><div class=""> - ``request.controller``: the name of the requested controller (parsed from the ``request.env.path_info``).</div><div class=""> - ``request.function``: the name of the requested function (parsed from the ``request.env.path_info``).</div><div class=""> - ``request.extension``: the extension of the requested action. It defaults to &quot;html&quot;. If the controller function returns a dictionary and does not specify a view, this is used to determine the extension of the view file that will render the dictionary (parsed from the ``request.env.path_info``).</div><div class=""> - ``request.folder``: the application directory. For example if the application is &quot;welcome&quot;, ``request.folder`` is set to the absolute path &quot;/path/to/welcome&quot;. In your programs, you should always use this variable and the ``os.path.join`` function to build paths to the files you need to access. Although web2py always uses absolute paths, it is a good rule never to explicitly  change the current working folder (whatever that is) since this is not a thread-safe practice.</div><div class=""> - ``request.now``: a ``datetime.datetime`` object storing the datetime of the current request.</div><div class=""> - ``request.utcnow``: a ``datetime.datetime`` object storing the UTC datetime of the current request.</div><div class=""> - ``request.args``: A list of the URL path components following the controller function name; equivalent to ``request.env.path_info.split(&#x27;/&#x27;)[3:]``</div><div class=""> - ``request.vars``: a ``gluon.storage.Storage`` object containing the HTTP GET and HTTP POST query variables.</div><div class=""> - ``request.get_vars``: a ``gluon.storage.Storage`` object containing only the HTTP GET query variables.</div><div class=""> - ``request.post_vars``: a ``gluon.storage.Storage`` object containing only the HTTP POST query variables.</div><div class=""> - ``request.client``: The ip address of the client as determined by, if present, ``request.env.http_x_forwarded_for`` or by ``request.env.remote_addr`` otherwise. While this is useful it should not be trusted because the ``http_x_forwarded_for`` can be spoofed.</div><div class=""> - ``request.is_local``: ``True`` if the client is localhost, ``False`` otherwise. Should work behind a proxy if the proxy supports ``http_x_forwarded_for``.</div><div class=""> - ``request.is_https``: ``True`` if the request is using the HTTPS protocol, ``False`` otherwise.</div><div class=""> - ``request.body``: a read-only file stream that contains the body of the HTTP request. This is automatically parsed to get the ``request.post_vars`` and then rewinded. It can be read with ``request.body.read()``.</div><div class=""> - ``request.ajax`` is True if the function is being called via an Ajax request.</div><div class=""> - ``request.cid`` is the ``id`` of the component that generated the Ajax request (if any). You can read more about components in Chapter 12.</div><div class=""> - ``request.restful`` this is a new and very useful decorator that can be used to change the default behavior of web2py actions by separating GET/POST/PUSH/DELETE requests. It will be discussed in some detail in Chapter 10.</div><div class=""> - ``request.user_agent()`` parses the user_agent field from the client and returns the information in the form of a dictionary. It is useful to detect mobile devices. It uses &quot;gluon/contrib/user_agent_parser.py&quot; created by Ross Peoples. To see what it does, try to embed the following code in a view:</div><div class=""> request.env.content_length | 0</div><div class=""> request.env.content_type | ````</div><div class=""> request.env.http_accept | text/xml,text/html;</div><div class=""> request.env.http_accept_encoding | gzip, deflate</div><div class=""> request.env.http_accept_language | en</div><div class=""> request.env.http_cookie | session_id_examples=127.0.0.1.119725</div><div class=""> request.env.http_host | 127.0.0.1:8000</div><div class=""> request.env.http_max_forwards | 10</div><div class=""> request.env.http_referer | http://web2py.com/</div><div class=""> request.env.http_user_agent | Mozilla/5.0</div><div class=""> request.env.http_via | 1.1 web2py.com</div><div class=""> request.env.http_x_forwarded_for | 76.224.34.5</div><div class=""> request.env.http_x_forwarded_host | web2py.com</div><div class=""> request.env.http_x_forwarded_server | 127.0.0.1</div><div class=""> request.env.path_info | /examples/simple_examples/status</div><div class=""> request.env.query_string | remote_addr:127.0.0.1</div><div class=""> request.env.request_method | GET</div><div class=""> request.env.script_name | ````</div><div class=""> request.env.server_name | 127.0.0.1</div><div class=""> request.env.server_port | 8000</div><div class=""> request.env.server_protocol | HTTP/1.1</div><div class="insert">+request.env.server_software | Rocket 1.2.4</div><div class=""> request.env.web2py_path | /Users/mdipierro/web2py</div><div class=""> request.env.web2py_version | Version 1.99.1</div><div class=""> request.env.web2py_runtime_gae | (optional, defined only if GAE detected)</div><div class=""> request.env.wsgi_errors | &lt;open file, mode &#x27;w&#x27; at &gt;</div><div class=""> request.env.wsgi_input | ````</div><div class=""> request.env.wsgi_multiprocess | False</div><div class=""> request.env.wsgi_multithread | True</div><div class=""> request.env.wsgi_run_once | False</div><div class=""> request.env.wsgi_url_scheme | http</div><div class=""> request.env.wsgi_version | 10</div><div class=""> --------</div><div class=""> </div><div class=""> Which environment variables are actually defined depends on the web server. Here we are assuming the built-in Rocket wsgi server. The set of variables is not much different when using the Apache web server.</div><div class=""> </div><div class=""> The ``request.env.http_*`` variables are parsed from the request HTTP header.</div><div class=""> </div><div class=""> The ``request.env.web2py_*`` variables are not parsed from the web server environment, but are created by web2py in case your applications need to know about the web2py location and version, and whether it is running on the Google App Engine (because specific optimizations may be necessary).</div><div class=""> </div><div class=""> Also notice the ``request.env.wsgi_*`` variables. They are specific to the wsgi adaptor.</div><div class=""> </div><div class=""> A common issue is the following. The original application is in English. Suppose</div><div class=""> There are two solutions for this problem: create a translation language for English, which would be redundant and unnecessary, or better, tell web2py which languages should use the default language strings (the strings coded into the application). This can be done with:</div><div class=""> ``</div><div class=""> T.set_current_languages(&#x27;en&#x27;, &#x27;en-en&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> It stores in  ``T.current_languages`` a list of languages that do not require translation and forces a reload of the language files.</div><div class=""> </div><div class=""> Notice that &quot;it&quot; and &quot;it-it&quot; are different languages from the point of view of web2py. To support both of them, one would need two translation files, always lower case. The same is true for all other languages.</div><div class=""> </div><div class=""> The currently accepted language is stored in</div><div class=""> ``</div><div class=""> T.accepted_language</div><div class=""> ``:code</div><div class=""> </div><div class=""> Mind that T(...) does not just translate strings but can also translated variables:</div><div class=""> ``</div><div class=""> &gt;&gt;&gt; a=&quot;test&quot;</div><div class=""> &gt;&gt;&gt; print T(a)</div><div class=""> ``:code</div><div class=""> </div><div class="insert">In this case the word &quot;test&quot; i<span class="highlight">s</span> translated but, if not found and if the filesystem is writable, it will add it to the list of words to be translated in the language file.</div><div class=""> </div><div class=""> ### &#x27;&#x27;Cookies&#x27;&#x27;</div><div class=""> ``cookies``:inxx</div><div class=""> </div><div class=""> web2py uses the Python cookies modules for handling cookies.</div><div class=""> </div><div class=""> Cookies from the browser are in ``request.cookies`` and cookies sent by the server are in ``response.cookies``.</div><div class=""> </div><div class=""> You can set a cookie as follows:</div><div class=""> ``</div><div class=""> response.cookies[&#x27;mycookie&#x27;] = &#x27;somevalue&#x27;</div><div class=""> response.cookies[&#x27;mycookie&#x27;][&#x27;expires&#x27;] = 24 * 3600</div><div class=""> response.cookies[&#x27;mycookie&#x27;][&#x27;path&#x27;] = &#x27;/&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class=""> The second line tells the browser to keep the cookie for 24 hours. The third line tells the browser to send the cookie back to any application (URL path) at the current domain. Note, if you do not specify a path for the cookie, the browser will assume the path of the URL that was requested, so the cookie will only be returned to the server when that same URL path is requested.</div><div class=""> </div><div class=""> The cookie can be made secure with:</div><div class=""> ``</div><div class=""> response.cookies[&#x27;mycookie&#x27;][&#x27;secure&#x27;] = True</div><div class=""> Your tasks will be executed on the first call (page load) to web2py after the ti</div><div class=""> </div><div class=""> Hard cron is the default if you are using the built-in web server (either directly or via Apache mod_proxy). Hard cron is executed in a parallel thread, so unlike soft cron, there are no limitations with regard to run time or execution time precision.</div><div class=""> </div><div class=""> External cron is not default in any scenario, but requires you to have access to the system cron facilities. It runs in a parallel process, so none of the limitations of soft cron apply. This is the recommended way of using cron under WSGI or FASTCGI.</div><div class=""> </div><div class=""> Example of line to add to the system crontab, (usually /etc/crontab):</div><div class=""> ``</div><div class=""> 0-59/1 * * * * web2py cd /var/www/web2py/ &amp;&amp; python web2py.py -J -C -D 1 &gt;&gt; /tmp/cron.output 2&gt;&amp;1</div><div class=""> ``:code</div><div class=""> </div><div class=""> If you are running external cron, make sure you add the -N command line parameter to your web2py startup script or config so there is no collision of multiple types of cron.  Also, with external ``cron``, make sure to add either ``-J`` (or ``--cronjob``, which is the same) as indicated above so that web2py knows that task is executed by cron. Web2py sets this internally with soft and hard ``cron``.</div><div class=""> </div><div class=""> In cases where you do not need any cron functionality within a particular process, you can use the -N command line parameter to disable it. Note that this might disable some maintenance tasks (like the automatic cleaning of session folders). The most common use of this function is when you:</div><div class=""> - have already set up external cron triggered from the system (most common with WSGI setup).</div><div class=""> - want to debug your application without cron interfering either with actions or with output.</div><div class=""> </div><div class=""> #### Homemade task queues</div><div class=""> </div><div class=""> While cron is useful to run tasks at regular time intervals, it is not always the best solution to run a background task. For this purpose web2py provides the ability to run any python script as if it were inside a controller:</div><div class=""> ``</div><div class="insert">python web2py.py -S app -M<span class="highlight"></span> -R applications/app/private/myscript.py -A a b c</div><div class=""> ``:code</div><div class=""> </div><div class="insert">where ``-S app`` tells web2py to run &quot;myscript.py&quot; as &quot;app&quot;, ``-M`` tells web2py to execute models, <span class="highlight"></span>and ``-A a b c`` passes optional command line arguments ``sys.args=[&#x27;a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;]`` to &quot;myscript.py&quot;.</div><div class=""> </div><div class=""> This type of background process should not be executed via cron (except perhaps for cron @reboot) because you need to be sure that no more than one instance is running at the same time. With cron it is possible that a process starts at cron iteration 1 and is not completed by cron iteration 2, so cron starts it again, and again, and again - thus jamming the mail server.</div><div class=""> </div><div class=""> In chapter 8, we will provide an example of how to use the above method to send emails.</div><div class=""> </div><div class=""> </div><div class=""> #### Scheduler (experimental)</div><div class=""> </div><div class=""> The web2py scheduler works very much like the task queue described in the previous sub-section with some differences:</div><div class=""> - It provides a standard mechanism for creating and scheduling tasks.</div><div class=""> - There is not a single background process but a set of workers processes.</div><div class=""> - The job of worker nodes can be monitored because their state, as well as the state of the tasks, is stored in the database.</div><div class=""> - It works without web2py but that is not documented here.</div><div class=""> </div><div class=""> The scheduler does not use cron, although one can use cron @reboot to start the worker nodes.</div><div class=""> </div><div class=""> In the scheduler, a task is simply a function defined in a model (or in a module and imported by a model). For example:</div><div class=""> </div><div class=""> ``</div><div class=""> def task_add(a,b):</div><div class=""> db.scheduler_task.validate_and_insert(</div><div class=""> ``:code</div><div class=""> </div><div class=""> Notice that fields &quot;times_run&quot;, &quot;last_run_time&quot; and &quot;assigned_worker_name&quot; are not provided at schedule time but are filled automatically by the workers.</div><div class=""> </div><div class=""> You can also retrieve the output of completed tasks:</div><div class=""> </div><div class=""> ``</div><div class=""> completed_runs = db(db.scheduler_run.status=&#x27;COMPLETED&#x27;).select()</div><div class=""> ``:code</div><div class=""> </div><div class=""> ------</div><div class=""> The scheduler is experimental because it needs more extensive testing and because the table structure may change as more features are added.</div><div class=""> ------</div><div class=""> </div><div class=""> </div><div class=""> ### Third party modules</div><div class=""> ``import``:inxx</div><div class=""> </div><div class=""> web2py is written in Python, so it can import and use any Python module, including third party modules. It just needs to be able to find them. As with any Python application, modules can be installed in the official Python &quot;site-packages&quot; directory, and they can then be imported from anywhere inside your code.</div><div class=""> </div><div class="insert">Modules in the &quot;site-packages&quot; directory are, as the name suggests, site-level packages. Applications requiring site-packages are not portable unless these modules are installed separately. The advantage of having modules in &quot;site-packages&quot; is that multiple applications can share them. Let&#x27;s consider, for example, the plotting package called &quot;matplotlib&quot;. You can install it from the shell using the PEAK ``easy_install`` command<span class="highlight"> ``easy_install``</span>:<span class="highlight">cite (or its modern replacement ``pip`` ``PIP``:cite ):</span></div><div class=""> ``</div><div class=""> easy_install py-matplotlib</div><div class=""> ``:code</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">URLs are only allowed to contain alphanumeric characters, underscores, and slashes; the ``args`` may contain non-consecutive dots. Spaces are replaced by underscores before validation. If the URL syntax is invalid, web2py returns an HTTP 400 error message``http<span class="highlight"></span>:<span class="highlight">w,http</span>:<span class="highlight">o``:</span>cite .</div><div class=""> </div><div class=""> If the URL corresponds to a request for a static file, web2py simply reads and returns (streams) the requested file.</div><div class=""> </div><div class=""> If the URL does not request a static file, web2py processes the request in the following order:</div><div class=""> - Parses cookies.</div><div class=""> - Creates an environment in which to execute the function.</div><div class=""> - Initializes ``request``, ``response``, ``cache``.</div><div class=""> - Opens the existing ``session`` or creates a new one.</div><div class=""> - Executes the models belonging to the requested application.</div><div class=""> - Executes the requested controller action function.</div><div class=""> - If the function returns a dictionary, executes the associated view.</div><div class=""> - On success, commits all open transactions.</div><div class=""> - Saves the session.</div><div class=""> - Returns an HTTP response.</div><div class=""> </div><div class=""> Notice that the controller and the view are executed in different copies of the same environment; therefore, the view does not see the controller, but it sees the models and it sees the variables returned by the controller action function.</div><div class=""> </div><div class=""> If an exception (other than HTTP) is raised, web2py does the following:</div><div class=""> - Stores the traceback in an error file and assigns a ticket number to it.</div><div class=""> - Rolls back all open transactions.</div><div class=""> gluon/__init__.py    gluon/highlight.py   gluon/restricted.py  gluon/streamer.py</div><div class=""> gluon/admin.py       gluon/html.py        gluon/rewrite.py     gluon/template.py</div><div class=""> gluon/cache.py       gluon/http.py        gluon/rocket.py      gluon/storage.py</div><div class=""> gluon/cfs.py         gluon/import_all.py  gluon/sanitizer.py   gluon/tools.py</div><div class=""> gluon/compileapp.py  gluon/languages.py   gluon/serializers.py gluon/utils.py</div><div class=""> gluon/contenttype.py gluon/main.py        gluon/settings.py    gluon/validators.py</div><div class=""> gluon/dal.py         gluon/myregex.py     gluon/shell.py       gluon/widget.py</div><div class=""> gluon/decoder.py     gluon/newcron.py     gluon/sql.py         gluon/winservice.py</div><div class=""> gluon/fileutils.py   gluon/portalocker.py gluon/sqlhtml.py     gluon/xmlrpc.py</div><div class=""> gluon/globals.py     gluon/reserved_sql_keywords.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> The tar gzipped scaffolding app that ship with web2py is</div><div class=""> ``</div><div class=""> welcome.w2p</div><div class=""> ``:code</div><div class=""> </div><div class=""> It is created upon installation and overwritten on upgrade.</div><div class=""> </div><div class=""> -------</div><div class=""> The first time you start web2py, two new folders are created: deposit and applications. The &quot;welcome&quot; app is zipped into a &quot;welcome.w2p&quot; file to be used as a scaffolding app.</div><div class="delete">-The first time you start web2py, two new folders are created: deposit and applications. The &quot;welcome&quot; app is zipped into a &quot;welcome.w2p&quot; file to be used as scaffolding app.</div><div class=""> The deposit folder is used as temporary storage for installing and uninstalling applications.</div><div class=""> -------</div><div class=""> </div><div class=""> web2py unit-tests are in</div><div class=""> ``</div><div class=""> gluon/tests/</div><div class=""> ``:code</div><div class=""> </div><div class=""> There are handlers for connecting with various web servers:</div><div class=""> ``</div><div class=""> cgihandler.py       # discouraged</div><div class=""> gaehandler.py       # for Google App Engine</div><div class=""> fcgihandler.py      # for FastCGI</div><div class=""> wsgihandler.py      # for WSGI</div><div class=""> isapiwsgihandler.py # for IIS</div><div class=""> modpythonhandler.py # deprecated</div><div class=""> ``:code</div><div class=""> </div><div class=""> (&quot;fcgihandler&quot; calls  &quot;gluon/contrib/gateways/fcgi.py&quot; developed by Allan Saddi) and</div><div class=""> </div><div class=""> ``</div><div class=""> anyserver.py</div><div class=""> ``</div><div class=""> </div><div class=""> which is a script to interface with many different web servers, described in Chapter 13.</div><div class=""> </div><div class=""> There are three example files:</div><div class=""> ``</div><div class=""> options_std.py</div><div class=""> routes.example.py</div><div class=""> router.example.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> The former is an optional configuration file that can be passed to web2py.py with the ``-L`` option. The second is an example of a URL mapping file. It is loaded automatically when renamed &quot;routes.py&quot;. The third is an alternative syntax for URL mapping, and can also be renamed (or copied to) &quot;routes.py&quot;.</div><div class=""> </div><div class=""> The files</div><div class=""> ``</div><div class="delete">-app.yaml</div><div class="delete">-index.yaml</div><div class="delete">-queue.yaml</div><div class=""> ``:code</div><div class=""> </div><div class="delete">ar<span class="highlight"></span>e configuration files used for deployment on the Google App Engine. You can read more about them in the Deployment Recipes chapter and on the Google Documentation pages.</div><div class=""> </div><div class=""> There are also additional libraries, usually developed by a third party:</div><div class=""> </div><div class=""> **feedparser**``feedparser``:cite  by Mark Pilgrim for reading RSS and Atom feeds:</div><div class=""> ``</div><div class=""> gluon/contrib/__init__.py</div><div class=""> gluon/contrib/feedparser.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> **markdown2**``markdown2``:cite  by Trent Mick for wiki markup:</div><div class=""> ``</div><div class=""> gluon/contrib/markdown/__init__.py</div><div class=""> gluon/contrib/markdown/markdown2.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> **markmin** markup:</div><div class=""> ``</div><div class="delete">gluon/contrib/markmin<span class="highlight">.py</span></div><div class=""> ``:code</div><div class=""> </div><div class=""> **fpdf** created my Mariano Reingart for generating PDF documents:</div><div class=""> ``</div><div class=""> gluon/contrib/fpdf</div><div class=""> ``</div><div class=""> This is not documented in this book but it is hosted and documented here:</div><div class=""> ``</div><div class="delete">http://code.google.com/p/<span class="highlight"></span>fpdf/</div><div class=""> ``</div><div class=""> </div><div class=""> **pysimplesoap** is a lightweight SOAP server implementation created by Mariano Reingart:</div><div class=""> </div><div class=""> ``</div><div class=""> gluon/contrib/pysimplesoap/</div><div class=""> ``:code</div><div class=""> </div><div class=""> **simplejsonrpc** is a lightweight JSON-RPC client also created by Mariano Reingart: ``jsonrpc``:inxx</div><div class=""> </div><div class=""> ``</div><div class=""> gluon/contrib/simplejsonrpc.py</div><div class=""> ``</div><div class=""> </div><div class=""> **memcache**``memcache``:cite  Python API by Evan Martin:</div><div class=""> ``</div><div class=""> gluon/contrib/memcache/__init__.py</div><div class=""> gluon/contrib/memcache/memcache.py</div><div class=""> ``</div><div class=""> </div><div class=""> The ``request`` object is an instance of the ubiquitous web2py class that is cal</div><div class=""> request.vars</div><div class=""> ``:code</div><div class=""> </div><div class=""> is the same as:</div><div class=""> ``</div><div class=""> request[&#x27;vars&#x27;]</div><div class=""> ``:code</div><div class=""> </div><div class=""> Unlike a dictionary, if an attribute (or key) does not exist, it does not raise an exception. Instead, it returns ``None``.</div><div class=""> </div><div class=""> -----</div><div class=""> It is sometimes useful to create your own Storage objects. You can do so as follows:</div><div class=""> ``</div><div class=""> from gluon.storage import Storage</div><div class=""> my_storage = Storage() # empty storage object</div><div class=""> my_other_storage = Storage(dict(a=1, b=2)) # convert dictionary to Storage</div><div class=""> ``:code</div><div class=""> -----</div><div class=""> </div><div class=""> ``request`` has the following items/attributes, some of which are also an instance of the ``Storage`` class:</div><div class="delete">- ``request.cookies``: a ``Cookie.SimpleCookie()`` object containing the cookies passed with the HTTP request. It acts like a dictionary of cookies. Each cookie is a Morsel object<span class="highlight">.</span></div><div class=""> - ``request.env``: a ``Storage`` object containing the environment variables passed to the controller, including HTTP header variables from the HTTP request and standard WSGI parameters. The environment variables are all converted to lower case, and dots are converted to underscores for easier memorization.</div><div class=""> - ``request.application``: the name of the requested application (parsed from ``request.env.path_info``).</div><div class=""> - ``request.controller``: the name of the requested controller (parsed from the ``request.env.path_info``).</div><div class=""> - ``request.function``: the name of the requested function (parsed from the ``request.env.path_info``).</div><div class=""> - ``request.extension``: the extension of the requested action. It defaults to &quot;html&quot;. If the controller function returns a dictionary and does not specify a view, this is used to determine the extension of the view file that will render the dictionary (parsed from the ``request.env.path_info``).</div><div class=""> - ``request.folder``: the application directory. For example if the application is &quot;welcome&quot;, ``request.folder`` is set to the absolute path &quot;/path/to/welcome&quot;. In your programs, you should always use this variable and the ``os.path.join`` function to build paths to the files you need to access. Although web2py always uses absolute paths, it is a good rule never to explicitly  change the current working folder (whatever that is) since this is not a thread-safe practice.</div><div class=""> - ``request.now``: a ``datetime.datetime`` object storing the datetime of the current request.</div><div class=""> - ``request.utcnow``: a ``datetime.datetime`` object storing the UTC datetime of the current request.</div><div class=""> - ``request.args``: A list of the URL path components following the controller function name; equivalent to ``request.env.path_info.split(&#x27;/&#x27;)[3:]``</div><div class=""> - ``request.vars``: a ``gluon.storage.Storage`` object containing the HTTP GET and HTTP POST query variables.</div><div class=""> - ``request.get_vars``: a ``gluon.storage.Storage`` object containing only the HTTP GET query variables.</div><div class=""> - ``request.post_vars``: a ``gluon.storage.Storage`` object containing only the HTTP POST query variables.</div><div class=""> - ``request.client``: The ip address of the client as determined by, if present, ``request.env.http_x_forwarded_for`` or by ``request.env.remote_addr`` otherwise. While this is useful it should not be trusted because the ``http_x_forwarded_for`` can be spoofed.</div><div class=""> - ``request.is_local``: ``True`` if the client is localhost, ``False`` otherwise. Should work behind a proxy if the proxy supports ``http_x_forwarded_for``.</div><div class=""> - ``request.is_https``: ``True`` if the request is using the HTTPS protocol, ``False`` otherwise.</div><div class=""> - ``request.body``: a read-only file stream that contains the body of the HTTP request. This is automatically parsed to get the ``request.post_vars`` and then rewinded. It can be read with ``request.body.read()``.</div><div class=""> - ``request.ajax`` is True if the function is being called via an Ajax request.</div><div class=""> - ``request.cid`` is the ``id`` of the component that generated the Ajax request (if any). You can read more about components in Chapter 12.</div><div class=""> - ``request.restful`` this is a new and very useful decorator that can be used to change the default behavior of web2py actions by separating GET/POST/PUSH/DELETE requests. It will be discussed in some detail in Chapter 10.</div><div class=""> - ``request.user_agent()`` parses the user_agent field from the client and returns the information in the form of a dictionary. It is useful to detect mobile devices. It uses &quot;gluon/contrib/user_agent_parser.py&quot; created by Ross Peoples. To see what it does, try to embed the following code in a view:</div><div class=""> request.env.content_length | 0</div><div class=""> request.env.content_type | ````</div><div class=""> request.env.http_accept | text/xml,text/html;</div><div class=""> request.env.http_accept_encoding | gzip, deflate</div><div class=""> request.env.http_accept_language | en</div><div class=""> request.env.http_cookie | session_id_examples=127.0.0.1.119725</div><div class=""> request.env.http_host | 127.0.0.1:8000</div><div class=""> request.env.http_max_forwards | 10</div><div class=""> request.env.http_referer | http://web2py.com/</div><div class=""> request.env.http_user_agent | Mozilla/5.0</div><div class=""> request.env.http_via | 1.1 web2py.com</div><div class=""> request.env.http_x_forwarded_for | 76.224.34.5</div><div class=""> request.env.http_x_forwarded_host | web2py.com</div><div class=""> request.env.http_x_forwarded_server | 127.0.0.1</div><div class=""> request.env.path_info | /examples/simple_examples/status</div><div class=""> request.env.query_string | remote_addr:127.0.0.1</div><div class=""> request.env.request_method | GET</div><div class=""> request.env.script_name | ````</div><div class=""> request.env.server_name | 127.0.0.1</div><div class=""> request.env.server_port | 8000</div><div class=""> request.env.server_protocol | HTTP/1.1</div><div class=""> request.env.web2py_path | /Users/mdipierro/web2py</div><div class=""> request.env.web2py_version | Version 1.99.1</div><div class=""> request.env.web2py_runtime_gae | (optional, defined only if GAE detected)</div><div class=""> request.env.wsgi_errors | &lt;open file, mode &#x27;w&#x27; at &gt;</div><div class=""> request.env.wsgi_input | ````</div><div class=""> request.env.wsgi_multiprocess | False</div><div class=""> request.env.wsgi_multithread | True</div><div class=""> request.env.wsgi_run_once | False</div><div class=""> request.env.wsgi_url_scheme | http</div><div class=""> request.env.wsgi_version | 10</div><div class=""> --------</div><div class=""> </div><div class=""> Which environment variables are actually defined depends on the web server. Here we are assuming the built-in Rocket wsgi server. The set of variables is not much different when using the Apache web server.</div><div class=""> </div><div class=""> The ``request.env.http_*`` variables are parsed from the request HTTP header.</div><div class=""> </div><div class=""> The ``request.env.web2py_*`` variables are not parsed from the web server environment, but are created by web2py in case your applications need to know about the web2py location and version, and whether it is running on the Google App Engine (because specific optimizations may be necessary).</div><div class=""> </div><div class=""> Also notice the ``request.env.wsgi_*`` variables. They are specific to the wsgi adaptor.</div><div class=""> </div><div class=""> A common issue is the following. The original application is in English. Suppose</div><div class=""> There are two solutions for this problem: create a translation language for English, which would be redundant and unnecessary, or better, tell web2py which languages should use the default language strings (the strings coded into the application). This can be done with:</div><div class=""> ``</div><div class=""> T.set_current_languages(&#x27;en&#x27;, &#x27;en-en&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> It stores in  ``T.current_languages`` a list of languages that do not require translation and forces a reload of the language files.</div><div class=""> </div><div class=""> Notice that &quot;it&quot; and &quot;it-it&quot; are different languages from the point of view of web2py. To support both of them, one would need two translation files, always lower case. The same is true for all other languages.</div><div class=""> </div><div class=""> The currently accepted language is stored in</div><div class=""> ``</div><div class=""> T.accepted_language</div><div class=""> ``:code</div><div class=""> </div><div class=""> Mind that T(...) does not just translate strings but can also translated variables:</div><div class=""> ``</div><div class=""> &gt;&gt;&gt; a=&quot;test&quot;</div><div class=""> &gt;&gt;&gt; print T(a)</div><div class=""> ``:code</div><div class=""> </div><div class="delete">In this case the word &quot;test&quot; i<span class="highlight">n</span> translated but, if not found and if the filesystem is writable, it will add it to the list of words to be translated in the language file.</div><div class=""> </div><div class=""> ### &#x27;&#x27;Cookies&#x27;&#x27;</div><div class=""> ``cookies``:inxx</div><div class=""> </div><div class=""> web2py uses the Python cookies modules for handling cookies.</div><div class=""> </div><div class=""> Cookies from the browser are in ``request.cookies`` and cookies sent by the server are in ``response.cookies``.</div><div class=""> </div><div class=""> You can set a cookie as follows:</div><div class=""> ``</div><div class=""> response.cookies[&#x27;mycookie&#x27;] = &#x27;somevalue&#x27;</div><div class=""> response.cookies[&#x27;mycookie&#x27;][&#x27;expires&#x27;] = 24 * 3600</div><div class=""> response.cookies[&#x27;mycookie&#x27;][&#x27;path&#x27;] = &#x27;/&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class=""> The second line tells the browser to keep the cookie for 24 hours. The third line tells the browser to send the cookie back to any application (URL path) at the current domain. Note, if you do not specify a path for the cookie, the browser will assume the path of the URL that was requested, so the cookie will only be returned to the server when that same URL path is requested.</div><div class=""> </div><div class=""> The cookie can be made secure with:</div><div class=""> ``</div><div class=""> response.cookies[&#x27;mycookie&#x27;][&#x27;secure&#x27;] = True</div><div class=""> Your tasks will be executed on the first call (page load) to web2py after the ti</div><div class=""> </div><div class=""> Hard cron is the default if you are using the built-in web server (either directly or via Apache mod_proxy). Hard cron is executed in a parallel thread, so unlike soft cron, there are no limitations with regard to run time or execution time precision.</div><div class=""> </div><div class=""> External cron is not default in any scenario, but requires you to have access to the system cron facilities. It runs in a parallel process, so none of the limitations of soft cron apply. This is the recommended way of using cron under WSGI or FASTCGI.</div><div class=""> </div><div class=""> Example of line to add to the system crontab, (usually /etc/crontab):</div><div class=""> ``</div><div class=""> 0-59/1 * * * * web2py cd /var/www/web2py/ &amp;&amp; python web2py.py -J -C -D 1 &gt;&gt; /tmp/cron.output 2&gt;&amp;1</div><div class=""> ``:code</div><div class=""> </div><div class=""> If you are running external cron, make sure you add the -N command line parameter to your web2py startup script or config so there is no collision of multiple types of cron.  Also, with external ``cron``, make sure to add either ``-J`` (or ``--cronjob``, which is the same) as indicated above so that web2py knows that task is executed by cron. Web2py sets this internally with soft and hard ``cron``.</div><div class=""> </div><div class=""> In cases where you do not need any cron functionality within a particular process, you can use the -N command line parameter to disable it. Note that this might disable some maintenance tasks (like the automatic cleaning of session folders). The most common use of this function is when you:</div><div class=""> - have already set up external cron triggered from the system (most common with WSGI setup).</div><div class=""> - want to debug your application without cron interfering either with actions or with output.</div><div class=""> </div><div class=""> #### Homemade task queues</div><div class=""> </div><div class=""> While cron is useful to run tasks at regular time intervals, it is not always the best solution to run a background task. For this purpose web2py provides the ability to run any python script as if it were inside a controller:</div><div class=""> ``</div><div class="delete">python web2py.py -S app -M<span class="highlight"> -N</span> -R applications/app/private/myscript.py -A a b c</div><div class=""> ``:code</div><div class=""> </div><div class="delete">where ``-S app`` tells web2py to run &quot;myscript.py&quot; as &quot;app&quot;, ``-M`` tells web2py to execute models, <span class="highlight">``-N`` tells web2py not to run cron, </span>and ``-A a b c`` passes optional command line arguments ``sys.args=[&#x27;a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;]`` to &quot;myscript.py&quot;.</div><div class=""> </div><div class=""> This type of background process should not be executed via cron (except perhaps for cron @reboot) because you need to be sure that no more than one instance is running at the same time. With cron it is possible that a process starts at cron iteration 1 and is not completed by cron iteration 2, so cron starts it again, and again, and again - thus jamming the mail server.</div><div class=""> </div><div class=""> In chapter 8, we will provide an example of how to use the above method to send emails.</div><div class=""> </div><div class=""> </div><div class=""> #### Scheduler (experimental)</div><div class=""> </div><div class=""> The web2py scheduler works very much like the task queue described in the previous sub-section with some differences:</div><div class=""> - It provides a standard mechanism for creating and scheduling tasks.</div><div class=""> - There is not a single background process but a set of workers processes.</div><div class=""> - The job of worker nodes can be monitored because their state, as well as the state of the tasks, is stored in the database.</div><div class=""> - It works without web2py but that is not documented here.</div><div class=""> </div><div class=""> The scheduler does not use cron, although one can use cron @reboot to start the worker nodes.</div><div class=""> </div><div class=""> In the scheduler, a task is simply a function defined in a model (or in a module and imported by a model). For example:</div><div class=""> </div><div class=""> ``</div><div class=""> def task_add(a,b):</div><div class=""> db.scheduler_task.validate_and_insert(</div><div class=""> ``:code</div><div class=""> </div><div class=""> Notice that fields &quot;times_run&quot;, &quot;last_run_time&quot; and &quot;assigned_worker_name&quot; are not provided at schedule time but are filled automatically by the workers.</div><div class=""> </div><div class=""> You can also retrieve the output of completed tasks:</div><div class=""> </div><div class=""> ``</div><div class=""> completed_runs = db(db.scheduler_run.status=&#x27;COMPLETED&#x27;).select()</div><div class=""> ``:code</div><div class=""> </div><div class=""> ------</div><div class=""> The scheduler is experimental because it needs more extensive testing and because the table structure may change as more features are added.</div><div class=""> ------</div><div class=""> </div><div class=""> </div><div class=""> ### Third party modules</div><div class=""> ``import``:inxx</div><div class=""> </div><div class=""> web2py is written in Python, so it can import and use any Python module, including third party modules. It just needs to be able to find them. As with any Python application, modules can be installed in the official Python &quot;site-packages&quot; directory, and they can then be imported from anywhere inside your code.</div><div class=""> </div><div class="delete">Modules in the &quot;site-packages&quot; directory are, as the name suggests, site-level packages. Applications requiring site-packages are not portable unless these modules are installed separately. The advantage of having modules in &quot;site-packages&quot; is that multiple applications can share them. Let&#x27;s consider, for example, the plotting package called &quot;matplotlib&quot;. You can install it from the shell using the PEAK ``easy_install`` command<span class="highlight"></span>:<span class="highlight"></span></div><div class=""> ``</div><div class=""> easy_install py-matplotlib</div><div class=""> ``:code</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/703ae1c98c20d735ce9564d95fa0380eb0ee76d4">703ae1c</a><ul><li>Date : 2012-10-15</li><li>more about cron</li></ul></li></ul>
<div class="row-fluid" id="com_703ae1c98c20d735ce9564d95fa0380eb0ee76d4">
    <div class="span6"><div class="diff"><div class="insert">  -<span class="highlight">Y</span>, --<span class="highlight">ru</span>n<span class="highlight"></span>-cron        <span class="highlight"></span>start<span class="highlight">s</span> cron<span class="highlight"></span></div><div class="">   -J, --cronjob         identify cron-initiated command</div><div class="">   -L CONFIG, --config=CONFIG</div><div class="">                         config file</div><div class="">   -F PROFILER_FILENAME, --profiler=PROFILER_FILENAME</div><div class="">                         profiler filename</div><div class="">   -t, --taskbar         use web2py gui and run in taskbar (system tray)</div><div class="">   --nogui               text-only, no GUI</div><div class="">   -A ARGS, --args=ARGS  should be followed by a list of arguments to be passed</div><div class="">                         to script, to be used with -S, -A must be the last</div><div class="">                         option</div><div class="">   --no-banner           Do not print header banner</div><div class="">   --interfaces=INTERFACES</div><div class="">                         listen on multiple addresses: &quot;ip:port:cert:key:ca_cer</div><div class="">                         t;ip2:port2:cert2:key2:ca_cert2;...&quot; (:cert:key</div><div class="">                         optional; no spaces)</div><div class="">   --run_system_tests    runs web2py tests</div><div class=""> </div><div class=""> ``:code</div><div class=""> </div><div class=""> Lower-case options are used to configure the web server. The ``-L`` option tells web2py to read configuration options from a file, ``-W`` installs web2py as a windows service, while ``-S``, ``-P`` and ``-M`` options start an interactive Python shell. The ``-T`` option finds and runs controller doctests in a web2py execution environment. For example, the following example runs doctests from all controllers in the &quot;welcome&quot; application:</div><div class=""> if you run web2py as Windows Service, ``-W``,  it is not convenient to pass the</div><div class=""> ``</div><div class=""> import socket</div><div class=""> import os</div><div class=""> </div><div class=""> ip = &#x27;0.0.0.0&#x27;</div><div class=""> port = 80</div><div class=""> interfaces=[(&#x27;0.0.0.0&#x27;,80)]</div><div class=""> #interfaces.append((&#x27;0.0.0.0&#x27;,443,&#x27;ssl_private_key.pem&#x27;,&#x27;ssl_certificate.pem&#x27;))</div><div class=""> password = &#x27;&lt;recycle&gt;&#x27;  # ## &lt;recycle&gt; means use the previous password</div><div class=""> pid_filename = &#x27;httpserver.pid&#x27;</div><div class=""> log_filename = &#x27;httpserver.log&#x27;</div><div class=""> profiler_filename = None</div><div class=""> minthreads = None</div><div class=""> maxthreads = None</div><div class=""> server_name = socket.gethostname()</div><div class=""> request_queue_size = 5</div><div class=""> timeout = 30</div><div class=""> shutdown_timeout = 5</div><div class=""> folder = os.getcwd()</div><div class=""> extcron = None</div><div class="insert"><span class="highlight">ru</span>n<span class="highlight"></span>cron = <span class="highlight">Fals</span>e</div><div class=""> ``:code</div><div class=""> </div><div class=""> This file contains the web2py defaults. If you edit this file, you need to import it explicitly with the ``-L`` command-line option. It only works if you run web2py as a Windows Service.</div><div class=""> </div><div class=""> ### Workflow</div><div class=""> </div><div class=""> The web2py workflow is the following:</div><div class=""> - An HTTP requests arrives to the web server (the built-in Rocket server or a different server connected to web2py via WSGI or another adapter). The web server handles each request in its own thread, in parallel.</div><div class=""> - The HTTP request header is parsed and passed to the dispatcher (explained later in this chapter).</div><div class=""> - The dispatcher decides which of the installed application will handle the request and maps the PATH_INFO in the URL into a function call. Each URL corresponds to one function call.</div><div class=""> - Requests for files in the static folder are handled directly, and large files are automatically streamed to the client.</div><div class=""> - Requests for anything but a static file are mapped into an action (i.e. a function in a controller file, in the requested application).</div><div class=""> - Before calling the action, a few things happen: if the request header contains a session cookie for the app, the session object is retrieved; if not, a session id is created (but the session file is not saved until later); an execution environment for the request is created; models are executed in this environment.</div><div class=""> - Finally the controller action is executed in the pre-built environment.</div><div class=""> - If the action returns a string, this is returned to the client (or if the action returns a web2py HTML helper object, it is serialized and returned to the client).</div><div class=""> - If the action returns an iterable, this is used to loop and stream the data to the client.</div><div class=""> - If the action returns a dictionary, web2py tries to locate a view to render the dictionary. The view must have the same name as the action (unless specified otherwise) and the same extension as the requested page (defaults to .html); on failure, web2py may pick up a generic view (if available and if enabled). The view sees every variable defined in the models as well as those in the dictionary returned by the action, but does not see global variables defined in the controller.</div><div class=""> - The entire user code is executed in a single transaction unless specified otherwise.</div><div class=""> - If the user code succeeds, the transaction is committed.</div><div class=""> - If the user code fails, the traceback is stored in a ticket, and a ticket ID is issued to the client. Only the system administrator can search and read the tracebacks in tickets.</div><div class=""> By **cron** we refer to a web2py functionality not to the Unix Cron mechanism. T</div><div class=""> </div><div class=""> web2py cron is the way to go if you need tasks in the background at scheduled times and these tasks take a relatively short time compared to the time interval between two calls. Each task runs in its own process, and multiple tasks can run concurrently, but you have no control over how many tasks run. If accidentally one task overlaps with itself, it can cause a database lock and a spike in memory usage.</div><div class=""> </div><div class=""> web2py scheduler takes a different approach. The number of running processes is fixed, and they can run on different machines. Each process is called a worker. Each worker picks a task when available and executes it as soon as possible after the time when it is scheduled to run, but not necessarily at that exact time. There cannot be more processes running than the number of scheduled tasks and therefore no memory spikes. Scheduler tasks can be defined in models and are stored in the database. The web2py scheduler does not implement a distributed queue since it assumes that the time to distribute tasks is negligible compared with the time to run the tasks. Workers pick up the task from the database.</div><div class=""> </div><div class=""> Homemade tasks queues can be a simpler alternative to the web2py scheduler in some cases.</div><div class=""> </div><div class=""> #### &#x27;&#x27;Cron&#x27;&#x27;</div><div class=""> ``cron``:inxx</div><div class=""> </div><div class=""> The web2py cron provides the ability for applications to execute tasks at preset times, in a platform-independent manner.</div><div class=""> </div><div class=""> For each application, cron functionality is defined by a crontab file:</div><div class=""> </div><div class=""> ``</div><div class=""> app/cron/crontab</div><div class=""> ``</div><div class=""> </div><div class=""> It follows the syntax defined in ref. ``cron``:cite (with some extensions that are specific to web2py).</div><div class=""> </div><div class="insert">+------</div><div class="insert">+Before web2py 2.1.1, cron was enabled by default and could be disabled with the ``-N`` command line option, Since 2.1.1, cron is disabled by default and can be enabled by the ``-Y`` option. This change was motivated by the desire to push users toward using the new scheduler (which is superior to the cron mechanism) and also because cron may impact on performance.</div><div class="insert">+------</div><div class="insert">+</div><div class=""> This means that every application can have a separate cron configuration and that cron config can be changed from within web2py without affecting the host OS itself.</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">  -<span class="highlight">N</span>, --<span class="highlight"></span>n<span class="highlight">o</span>-cron        <span class="highlight"> do not </span>start<span class="highlight"></span> cron<span class="highlight"> automatically</span></div><div class="">   -J, --cronjob         identify cron-initiated command</div><div class="">   -L CONFIG, --config=CONFIG</div><div class="">                         config file</div><div class="">   -F PROFILER_FILENAME, --profiler=PROFILER_FILENAME</div><div class="">                         profiler filename</div><div class="">   -t, --taskbar         use web2py gui and run in taskbar (system tray)</div><div class="">   --nogui               text-only, no GUI</div><div class="">   -A ARGS, --args=ARGS  should be followed by a list of arguments to be passed</div><div class="">                         to script, to be used with -S, -A must be the last</div><div class="">                         option</div><div class="">   --no-banner           Do not print header banner</div><div class="">   --interfaces=INTERFACES</div><div class="">                         listen on multiple addresses: &quot;ip:port:cert:key:ca_cer</div><div class="">                         t;ip2:port2:cert2:key2:ca_cert2;...&quot; (:cert:key</div><div class="">                         optional; no spaces)</div><div class="">   --run_system_tests    runs web2py tests</div><div class=""> </div><div class=""> ``:code</div><div class=""> </div><div class=""> Lower-case options are used to configure the web server. The ``-L`` option tells web2py to read configuration options from a file, ``-W`` installs web2py as a windows service, while ``-S``, ``-P`` and ``-M`` options start an interactive Python shell. The ``-T`` option finds and runs controller doctests in a web2py execution environment. For example, the following example runs doctests from all controllers in the &quot;welcome&quot; application:</div><div class=""> if you run web2py as Windows Service, ``-W``,  it is not convenient to pass the</div><div class=""> ``</div><div class=""> import socket</div><div class=""> import os</div><div class=""> </div><div class=""> ip = &#x27;0.0.0.0&#x27;</div><div class=""> port = 80</div><div class=""> interfaces=[(&#x27;0.0.0.0&#x27;,80)]</div><div class=""> #interfaces.append((&#x27;0.0.0.0&#x27;,443,&#x27;ssl_private_key.pem&#x27;,&#x27;ssl_certificate.pem&#x27;))</div><div class=""> password = &#x27;&lt;recycle&gt;&#x27;  # ## &lt;recycle&gt; means use the previous password</div><div class=""> pid_filename = &#x27;httpserver.pid&#x27;</div><div class=""> log_filename = &#x27;httpserver.log&#x27;</div><div class=""> profiler_filename = None</div><div class=""> minthreads = None</div><div class=""> maxthreads = None</div><div class=""> server_name = socket.gethostname()</div><div class=""> request_queue_size = 5</div><div class=""> timeout = 30</div><div class=""> shutdown_timeout = 5</div><div class=""> folder = os.getcwd()</div><div class=""> extcron = None</div><div class="delete"><span class="highlight"></span>n<span class="highlight">o</span>cron = <span class="highlight">Non</span>e</div><div class=""> ``:code</div><div class=""> </div><div class=""> This file contains the web2py defaults. If you edit this file, you need to import it explicitly with the ``-L`` command-line option. It only works if you run web2py as a Windows Service.</div><div class=""> </div><div class=""> ### Workflow</div><div class=""> </div><div class=""> The web2py workflow is the following:</div><div class=""> - An HTTP requests arrives to the web server (the built-in Rocket server or a different server connected to web2py via WSGI or another adapter). The web server handles each request in its own thread, in parallel.</div><div class=""> - The HTTP request header is parsed and passed to the dispatcher (explained later in this chapter).</div><div class=""> - The dispatcher decides which of the installed application will handle the request and maps the PATH_INFO in the URL into a function call. Each URL corresponds to one function call.</div><div class=""> - Requests for files in the static folder are handled directly, and large files are automatically streamed to the client.</div><div class=""> - Requests for anything but a static file are mapped into an action (i.e. a function in a controller file, in the requested application).</div><div class=""> - Before calling the action, a few things happen: if the request header contains a session cookie for the app, the session object is retrieved; if not, a session id is created (but the session file is not saved until later); an execution environment for the request is created; models are executed in this environment.</div><div class=""> - Finally the controller action is executed in the pre-built environment.</div><div class=""> - If the action returns a string, this is returned to the client (or if the action returns a web2py HTML helper object, it is serialized and returned to the client).</div><div class=""> - If the action returns an iterable, this is used to loop and stream the data to the client.</div><div class=""> - If the action returns a dictionary, web2py tries to locate a view to render the dictionary. The view must have the same name as the action (unless specified otherwise) and the same extension as the requested page (defaults to .html); on failure, web2py may pick up a generic view (if available and if enabled). The view sees every variable defined in the models as well as those in the dictionary returned by the action, but does not see global variables defined in the controller.</div><div class=""> - The entire user code is executed in a single transaction unless specified otherwise.</div><div class=""> - If the user code succeeds, the transaction is committed.</div><div class=""> - If the user code fails, the traceback is stored in a ticket, and a ticket ID is issued to the client. Only the system administrator can search and read the tracebacks in tickets.</div><div class=""> By **cron** we refer to a web2py functionality not to the Unix Cron mechanism. T</div><div class=""> </div><div class=""> web2py cron is the way to go if you need tasks in the background at scheduled times and these tasks take a relatively short time compared to the time interval between two calls. Each task runs in its own process, and multiple tasks can run concurrently, but you have no control over how many tasks run. If accidentally one task overlaps with itself, it can cause a database lock and a spike in memory usage.</div><div class=""> </div><div class=""> web2py scheduler takes a different approach. The number of running processes is fixed, and they can run on different machines. Each process is called a worker. Each worker picks a task when available and executes it as soon as possible after the time when it is scheduled to run, but not necessarily at that exact time. There cannot be more processes running than the number of scheduled tasks and therefore no memory spikes. Scheduler tasks can be defined in models and are stored in the database. The web2py scheduler does not implement a distributed queue since it assumes that the time to distribute tasks is negligible compared with the time to run the tasks. Workers pick up the task from the database.</div><div class=""> </div><div class=""> Homemade tasks queues can be a simpler alternative to the web2py scheduler in some cases.</div><div class=""> </div><div class=""> #### &#x27;&#x27;Cron&#x27;&#x27;</div><div class=""> ``cron``:inxx</div><div class=""> </div><div class=""> The web2py cron provides the ability for applications to execute tasks at preset times, in a platform-independent manner.</div><div class=""> </div><div class=""> For each application, cron functionality is defined by a crontab file:</div><div class=""> </div><div class=""> ``</div><div class=""> app/cron/crontab</div><div class=""> ``</div><div class=""> </div><div class=""> It follows the syntax defined in ref. ``cron``:cite (with some extensions that are specific to web2py).</div><div class=""> </div><div class=""> This means that every application can have a separate cron configuration and that cron config can be changed from within web2py without affecting the host OS itself.</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/f2639bb0d5b3d8cd41114b0de8f6209830d6edeb">f2639bb</a><ul><li>Date : 2012-10-04</li><li>fixed typo in validate_and_insert example, thanks Niphlod</li></ul></li></ul>
<div class="row-fluid" id="com_f2639bb0d5b3d8cd41114b0de8f6209830d6edeb">
    <div class="span6"><div class="diff"><div class=""> ``</div><div class="insert">db.scheduler_task.<span class="highlight"></span>validate_and_insert(</div><div class="">     function_name=&#x27;task_add&#x27;,</div><div class="">     args=&#x27;[]&#x27;,</div><div class="">     vars=&quot;{&#x27;a&#x27;:3,&#x27;b&#x27;:4}&quot;,</div><div class="">     repeats = 10, # run 10 times</div><div class="">     period = 3600, # every 1h</div><div class="">     timeout = 120, # should take less than 120 seconds</div><div class="">     )</div><div class=""> ``:code</div></div></div>
    <div class="span6"><div class="diff"><div class=""> ``</div><div class="delete">db.scheduler_task.<span class="highlight">_</span>validate_and_insert(</div><div class="">     function_name=&#x27;task_add&#x27;,</div><div class="">     args=&#x27;[]&#x27;,</div><div class="">     vars=&quot;{&#x27;a&#x27;:3,&#x27;b&#x27;:4}&quot;,</div><div class="">     repeats = 10, # run 10 times</div><div class="">     period = 3600, # every 1h</div><div class="">     timeout = 120, # should take less than 120 seconds</div><div class="">     )</div><div class=""> ``:code</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/040c3ddf5bf14f3346445ac1082ad627ce6bc0b1">040c3dd</a><ul><li>Date : 2012-09-12</li><li>another response.stream update in ch. 4</li></ul></li></ul>
<div class="row-fluid" id="com_040c3ddf5bf14f3346445ac1082ad627ce6bc0b1">
    <div class="span6"><div class="diff"><div class="insert">``response.stream(file, chunk_size, request=request, attachment=False, filename=None, headers=None)``: when a controller returns it, web2py streams the file content back to the client in blocks of size ``chunk_size``. The ``request`` parameter is required to use the chunk start in the HTTP header. ``file`` should be a file path (for backward compatibility, it can also be an open file object, but this is not recommended). As noted above, ``response.download`` should be used to retrieve files stored via an upload field. ``response.stream`` can be used in other cases, such as returning a temporary file or StringIO object created by the controller. If ``attachment`` is True, the Content-Disposition header will be set to &quot;attachment&quot;, and if ``filename`` is also provided, it will be added to the Content-Disposition header as well (but only when ``attachment`` is True). If <span class="highlight">not already included in ``response.headers``, the follo</span>wi<span class="highlight">ng response headers will be set automaticall</span>y<span class="highlight">:</span> Content-Type, C<span class="highlight">ontent-Length, C</span>ache-Control, Pragma<span class="highlight"></span>, and Last-Modified<span class="highlight"> (the latter three are set to allow browser caching of the file). To override an</span>y <span class="highlight">of these automatic header settings, simpl</span>y<span class="highlight"> set them in ``response.headers`` before callin</span>g<span class="highlight"> ``response.stream``.</span></div></div></div>
    <div class="span6"><div class="diff"><div class="delete">``response.stream(file, chunk_size, request=request, attachment=False, filename=None, headers=None)``: when a controller returns it, web2py streams the file content back to the client in blocks of size ``chunk_size``. The ``request`` parameter is required to use the chunk start in the HTTP header. ``file`` should be a file path (for backward compatibility, it can also be an open file object, but this is not recommended). As noted above, ``response.download`` should be used to retrieve files stored via an upload field. ``response.stream`` can be used in other cases, such as returning a temporary file or StringIO object created by the controller. If ``attachment`` is True, the Content-Disposition header will be set to &quot;attachment&quot;, and if ``filename`` is also provided, it will be added to the Content-Disposition header as well (but only when ``attachment`` is True). If <span class="highlight">``headers`` is ``None``, ``response.headers`` </span>wi<span class="highlight">ll be used to set the response headers. This means </span>y<span class="highlight">ou must explicitly set the appropriate response headers for the file (e.g.,</span> Content-Type, C<span class="highlight"></span>ache-Control, Pragma<span class="highlight">). Alternatively, ``headers`` can be a dictionary of headers, in which case, ``response.headers`` will be ignored. The following headers will be set automatically if they are missing from ``headers`` (or if ``headers`` is ``None`` and they are missing from ``response.headers``): Content-Type, Content-Length, Cache-Control, Pragma</span>, and Last-Modified<span class="highlight">. Note, ``headers`` can be an empt</span>y <span class="highlight">dictionar</span>y<span class="highlight">, in which case ``response.headers`` will be i</span>g<span class="highlight">nored and just the automatic headers will be set.</span></div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/e9b5433942573152d517f4f0f70639e0dfcf5afe">e9b5433</a><ul><li>Date : 2012-09-10</li><li>updated response.stream documentation in ch. 4</li></ul></li></ul>
<div class="row-fluid" id="com_e9b5433942573152d517f4f0f70639e0dfcf5afe">
    <div class="span6"><div class="diff"><div class="insert">``response.stream(file, chunk_size, request=request<span class="highlight">, attachment=False, filename=None, headers=None</span>)``: when a controller returns it, web2py streams the file content back to the client in blocks of size ``chunk_size``. The ``request`` parameter is required to use the chunk start in the HTTP header. <span class="highlight">``file`` should be a file path (for backward compatibility, it can also be an open file object, but this is not recommended). </span>As noted above, ``response.download`` should be used to retrieve files stored via an upload field. ``response.stream`` can be used in other cases, such as returning a temporary file or StringIO object created by the controller. <span class="highlight">If ``attachment`` is True,</span> the Content-Disposition header<span class="highlight"> will be set to &quot;attachment&quot;, and if ``filename`` is also provided, it will be added to the Content-Disposition header as well (but onl</span>y<span class="highlight"> when ``attachment`` is True). If ``headers`` is ``None``, ``response.headers`` will be used to set the response headers. This means </span>y<span class="highlight">ou must explicit</span>ly <span class="highlight">set the appropriate response headers for the file </span>(e.g., <span class="highlight"></span>Content-Type<span class="highlight">, Cache-Control, Pragma). Alternatively, ``headers`` can be a dictionary of headers, in which case, ``response.headers`` will be ignored. The following headers will be set automatically if they are missing from ``headers``</span> (<span class="highlight">or if ``headers`` is ``None`` and they are missing from ``response.headers``</span>)<span class="highlight">: Content-Type, Content-Length, Cache-Control, Pragma, and Last-Modified. Note, ``headers`` can be an empty dictionary, in which case ``response.headers`` will be ignored and just the automatic headers will be set.</span></div></div></div>
    <div class="span6"><div class="diff"><div class="delete">``response.stream(file, chunk_size, request=request<span class="highlight"></span>)``: when a controller returns it, web2py streams the file content back to the client in blocks of size ``chunk_size``. The ``request`` parameter is required to use the chunk start in the HTTP header. <span class="highlight"></span>As noted above, ``response.download`` should be used to retrieve files stored via an upload field. ``response.stream`` can be used in other cases, such as returning a temporary file or StringIO object created by the controller. <span class="highlight">Unlike ``response.download``, ``response.stream`` does not automatically set</span> the Content-Disposition header<span class="highlight">, so </span>y<span class="highlight">ou ma</span>y<span class="highlight"> need to do that manual</span>ly <span class="highlight"></span>(e.g., <span class="highlight">to specify download as an attachment, and to provide a filename). However, it does automatically set the ``</span>Content-Type<span class="highlight">`` header</span> (<span class="highlight">based on the filename extension</span>)<span class="highlight">.</span></div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/31b67861f63a89ddbca5db525b9ea745b956670e">31b6786</a><ul><li>Date : 2012-09-06</li><li>Fix typos</li></ul></li></ul>
<div class="row-fluid" id="com_31b67861f63a89ddbca5db525b9ea745b956670e">
    <div class="span6"><div class="diff"><div class=""> Options:</div><div class="">   --version             show program&#x27;s version number and exit</div><div class="">   -h, --help            show this help message and exit</div><div class="">   -i IP, --ip=IP        ip address of the server (127.0.0.1)</div><div class="">   -p PORT, --port=PORT  port of server (8000)</div><div class="">   -a PASSWORD, --password=PASSWORD</div><div class="">                         password to be used for administration (use -a</div><div class="">                         &quot;&lt;recycle&gt;&quot; to reuse the last password))</div><div class="">   -c SSL_CERTIFICATE, --ssl_certificate=SSL_CERTIFICATE</div><div class="insert">                        file that contains <span class="highlight">SSL</span> certificate</div><div class="">   -k SSL_PRIVATE_KEY, --ssl_private_key=SSL_PRIVATE_KEY</div><div class="insert">                        file that contains <span class="highlight">SSL</span> private key</div><div class="">   --ca-cert=SSL_CA_CERTIFICATE</div><div class="">                         Use this file containing the CA certificate to</div><div class="">                         validate X509 certificates from clients</div><div class="">   -d PID_FILENAME, --pid_filename=PID_FILENAME</div><div class="">                         file to store the pid of the server</div><div class="">   -l LOG_FILENAME, --log_filename=LOG_FILENAME</div><div class="">                         file to log connections</div><div class="">   -n NUMTHREADS, --numthreads=NUMTHREADS</div><div class="">                         number of threads (deprecated)</div><div class="">   --minthreads=MINTHREADS</div><div class="">                         minimum number of server threads</div><div class="">   --maxthreads=MAXTHREADS</div><div class="">                         maximum number of server threads</div><div class="">   -s SERVER_NAME, --server_name=SERVER_NAME</div><div class="">                         server name for the web server</div><div class="">   -q REQUEST_QUEUE_SIZE, --request_queue_size=REQUEST_QUEUE_SIZE</div><div class="">                         max number of queued requests when server unavailable</div><div class="">   -o TIMEOUT, --timeout=TIMEOUT</div><div class="">                         timeout for individual request (10 seconds)</div><div class="">   -z SHUTDOWN_TIMEOUT, --shutdown_timeout=SHUTDOWN_TIMEOUT</div><div class=""> from gluon import *</div><div class=""> ``</div><div class=""> </div><div class=""> In fact, any Python module, even if not imported by a web2py application, can import the web2py API as long as web2py is in the ``sys.path``.</div><div class=""> </div><div class=""> There is one caveat, though. Web2py defines some global objects (request, response, session, cache, T) that can only exist when an HTTP request is present (or is faked). Therefore, modules can access them only if they are called from an application. For this reasons they are placed into a container caller ``current``, which is a thread local object. Here is an example.</div><div class=""> </div><div class=""> Create a module &quot;/myapp/modules/test.py&quot; that contains:</div><div class=""> ``</div><div class=""> from gluon import *</div><div class=""> def ip(): return current.request.client</div><div class=""> ``</div><div class=""> Now from a controller in &quot;myapp&quot; you can do</div><div class=""> ``</div><div class=""> import test</div><div class=""> def index():</div><div class="">     return &quot;Your ip is &quot; + test.ip()</div><div class=""> ``</div><div class=""> </div><div class=""> Notice a few things:</div><div class=""> </div><div class="insert">- ``import test`` looks for the module first in the current app&#x27;s modules folder, then in the folders listed in ``sys.path``. Therefore, app-level modules always take prece<span class="highlight"></span>dence over Python modules. This allows different apps to ship with different versions of their modules, without conflicts.</div><div class=""> </div><div class=""> - Different users can call the same action ``index`` concurrently, which calls the function in the module, and yet there is no conflict because ``current.request`` is a different object in different threads. Just be careful not to access ``current.request`` outside of functions or classes (i.e., at the top level) in the module.</div><div class=""> </div><div class=""> - ``import test`` is a shortcut for ``from applications.appname.modules import test``. Using the longer syntax, it is possible to import modules from other applications.</div><div class=""> </div><div class=""> For uniformity with normal Python behavior, by default web2py does not reload modules when changes are made. Yet this can be changed. To turn on the auto-reload feature for modules, use the ``track_changes`` function as follows (typically in a model file, before any imports):</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.custom_import import track_changes; track_changes(True)</div><div class=""> ``:code</div><div class=""> </div><div class=""> From now on, every time a module is imported, the importer will check if the Python source file (.py) has changed. If it has changed, the module will be reloaded. This applies to all Python modules, even Python modules outside web2py. The mode is global and applies to all applications. Changes made to models, controllers, and views are always reloaded regardless of the mode used. To turn the mode off, use the same function with ``False`` as the argument. To know the actual tracking state, use the ``is_tracking_changes()`` function, also from ``gluon.custom_import``.</div><div class=""> </div><div class=""> Modules that import ``current`` can access:</div><div class=""> - ``current.request``</div><div class=""> - ``current.response``</div><div class=""> - ``current.session``</div><div class=""> - ``current.cache``</div><div class=""> - ``current.T``</div><div class=""> and any other variable your application chooses to store in current. For example a model could do</div><div class=""> Also notice the ``request.env.wsgi_*`` variables. They are specific to the wsgi</div><div class=""> ``response.session_file``: file stream containing the session.</div><div class=""> </div><div class=""> ``response.session_file_name``: name of the file where the session will be saved.</div><div class=""> </div><div class=""> ``response.session_id``: the id of the current session. It is determined automatically. NEVER CHANGE THIS VARIABLE.</div><div class=""> </div><div class=""> ``response.session_id_name``: the name of the session cookie for this application. NEVER CHANGE THIS VARIABLE.</div><div class=""> </div><div class=""> ``response.status``: the HTTP status code integer to be passed to the response. Default is 200 (OK).</div><div class=""> </div><div class=""> ``response.stream(file, chunk_size, request=request)``: when a controller returns it, web2py streams the file content back to the client in blocks of size ``chunk_size``. The ``request`` parameter is required to use the chunk start in the HTTP header. As noted above, ``response.download`` should be used to retrieve files stored via an upload field. ``response.stream`` can be used in other cases, such as returning a temporary file or StringIO object created by the controller. Unlike ``response.download``, ``response.stream`` does not automatically set the Content-Disposition header, so you may need to do that manually (e.g., to specify download as an attachment, and to provide a filename). However, it does automatically set the ``Content-Type`` header (based on the filename extension).</div><div class=""> </div><div class=""> ``response.subtitle``: optional parameter that may be included in the views. It should contain the subtitle of the page.</div><div class=""> </div><div class=""> ``response.title``: optional parameter that may be included in the views. It should contain the title of the page and should be rendered by the HTML title TAG in the header.</div><div class=""> </div><div class=""> ``response.toolbar``: a function that allows you embed a toolbar into page form debugging purposes ``{{=response.toolbar()}}``. The toolbar displays request, response, session variables and database access time for each query.</div><div class=""> </div><div class=""> ``response._vars``: this variable is accessible only in a view, not in the action. It contains the value returned by the action to the view.</div><div class=""> </div><div class="insert">``response.optimize_css``: if can be set to &quot;concat,minify,inline&quot; to concatenate, mini<span class="highlight">f</span>y and inline the CSS files included by web2py.</div><div class=""> </div><div class="insert">``response.optimize_js``: if can be set to &quot;concat,minify,inline&quot; to concatenate, mini<span class="highlight">f</span>y and inline the <span class="highlight">Java</span>S<span class="highlight">cript</span> files included by web2py.</div><div class=""> </div><div class=""> ``response.view``: the name of the view template that must render the page. This is set by default to:</div><div class=""> ``</div><div class=""> &quot;%s/%s.%s&quot; % (request.controller, request.function, request.extension)</div><div class=""> ``:code</div><div class=""> </div><div class=""> or, if the above file cannot be located, to</div><div class=""> ``</div><div class=""> &quot;generic.%s&quot; % (request.extension)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Change the value of this variable to modify the view file associated with a particular action.</div><div class=""> </div><div class=""> ``response.delimiters`` defaults to ``(&#x27;{{&#x27;,&#x27;}}&#x27;)``. It allows you to change the delimiter of code embedded in views.</div><div class=""> </div><div class=""> ``response.xmlrpc(request, methods)``: when a controller returns it, this function exposes the methods via XML-RPC``xmlrpc``:cite . This function is deprecated since a better mechanism is available and described in Chapter 10.</div><div class=""> </div><div class=""> ``response.write(text)``: a method to write text into the output page body.</div><div class=""> </div><div class="insert">``response.js`` can contain Javascript <span class="highlight">c</span>ode. This code will be executed if and only if the response is received by a web2py component as discussed in Chapter 12.</div><div class=""> </div><div class=""> Since ``response`` is a ``gluon.storage.Storage`` object, it can be used to store other attributes that you may want to pass to the view. While there is no technical restriction, our recommendation is to store only variables that are to be rendered by all pages in the overall layout (&quot;layout.html&quot;).</div><div class=""> </div><div class=""> Anyway, we strongly suggest to stick to the variables listed here:</div><div class=""> ``</div><div class=""> response.title</div><div class=""> response.subtitle</div><div class=""> response.flash</div><div class=""> response.menu</div><div class=""> response.meta.author</div><div class=""> response.meta.description</div><div class=""> response.meta.keywords</div><div class=""> response.meta.*</div><div class=""> ``:code</div><div class=""> </div><div class=""> because this will make it easier for you to replace the standard &quot;layout.html&quot; file that comes with web2py with another layout file, one that uses the same set of variables.</div><div class=""> </div><div class=""> Old versions of web2py user ``response.author`` instead of ``response.meta.author`` and similar for the other meta attributes.</div><div class=""> </div><div class=""> ### ``session``</div><div class=""> Because ``time_expire`` is set to 20 seconds in the second call and only 10 seco</div><div class=""> </div><div class=""> Setting ``time_expire=0`` (or a negative value) forces the cached item to be refreshed (because the elapsed time since the last save will always be &gt; 0), and setting ``time_expire=None`` forces retrieval of the cached value, regardless of the time elapsed since it was saved (if ``time_expire`` is always ``None``, the cached item will effectively never expire).</div><div class=""> </div><div class=""> You can clear one or more cache variables with</div><div class=""> ``cache clear``:inxx</div><div class=""> </div><div class=""> ``</div><div class=""> cache.ram.clear(regex=&#x27;...&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> where ``regex`` is a regular expression matching all the keys you want removed from the cache. You can also clear an single item with:</div><div class=""> ``</div><div class=""> cache.ram(key, None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> where ``key`` is the key of the cached item.</div><div class=""> </div><div class=""> It is also possible to define other caching mechanisms such as memcache. Memcache is available via ``gluon.contrib.memcache`` and is discussed in more details in Chapter 14.</div><div class=""> </div><div class=""> ------</div><div class="insert">Be careful when caching that caching is usually at the app-level not at the user level. If you need, for e<span class="highlight">x</span>a<span class="highlight"></span>mple, to cache user specific content, choose a key that includes the user id.</div><div class=""> ------</div><div class=""> </div><div class=""> </div><div class=""> ### ``URL``</div><div class=""> ``URL``:inxx</div><div class=""> The ``URL`` function is one of the most important functions in web2py. It generates internal URL paths for the actions and the static files.</div><div class=""> </div><div class=""> Here is an example:</div><div class=""> </div><div class=""> ``</div><div class=""> URL(&#x27;f&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> is mapped into</div><div class=""> </div><div class=""> ``</div><div class=""> /[application]/[controller]/f</div><div class=""> ``:code</div><div class=""> </div><div class=""> Notice that the output of the ``URL`` function depends on the name of the current application, the calling controller, and other parameters. web2py supports URL mapping and reverse URL mapping. URL mapping allows you to redefine the format of external URLs. If you use the ``URL`` function to generate all the internal URLs, then additions or changes to URL mappings will prevent broken links within the web2py application.</div><div class=""> This means that only ``HTTP`` can be used for cross-page control flow. Other exc</div><div class=""> The command:</div><div class=""> ``</div><div class=""> redirect(&#x27;http://www.web2py.com&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> is simply a shortcut for:</div><div class=""> ``</div><div class=""> raise HTTP(303,</div><div class="">            &#x27;You are being redirected &lt;a href=&quot;%s&quot;&gt;here&lt;/a&gt;&#x27; % location,</div><div class="">            Location=&#x27;http://www.web2py.com&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The named arguments of the ``HTTP`` initializer method are translated into HTTP header directives, in this case, the redirection target location. ``redirect`` takes an optional second argument, which is the HTTP status code for the redirection (303 by default). Change this number to 307 for a temporary redirect or to 301 for a permanent redirect.</div><div class=""> </div><div class=""> The most common way to use redirect is to redirect to other pages in the same app and (optionally) pass parameters:</div><div class=""> </div><div class=""> ``</div><div class=""> redirect(URL(&#x27;index&#x27;, args=(1,2,3), vars=dict(a=&#x27;b&#x27;)))</div><div class=""> ``:code</div><div class=""> </div><div class="insert">In chapter 12 we discuss web2py components. They make Ajax requ<span class="highlight">ests</span> to web2py actions. If the called action performs a redirect, you may want the Ajax request to follow the redirect or you may want the entire page perfo<span class="highlight">r</span>ming the Ajax request redirecting. In this latter case you can set:</div><div class=""> </div><div class=""> ``</div><div class=""> redirect(...,type=&#x27;auto&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> ### ``T`` and Internationalization</div><div class=""> ``T``:inxx ``internationalization``:inxx</div><div class=""> </div><div class=""> The object ``T`` is the language translator. It constitutes a single global instance of the web2py class ``gluon.language.translator``. All string constants (and only string constants) should be marked by ``T``, for example:</div><div class=""> ``</div><div class=""> a = T(&quot;hello world&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Strings that are marked with ``T`` are identified by web2py as needing language translation and they will be translated when the code (in the model, controller, or view) is executed. If the string to be translated is not a constant but a variable, it will be added to the translation file at runtime (except on GAE) to be translated later.</div><div class=""> </div><div class=""> The ``T`` object can also contain interpolated variables and support multiple equivalent syntax:</div><div class=""> ``</div><div class=""> a = T(&quot;hello %s&quot;, (&#x27;Tim&#x27;,))</div><div class=""> a = T(&quot;hello %(name)s&quot;, dict(name=&#x27;Tim&#x27;))</div><div class=""> In chapter 8, we will provide an example of how to use the above method to send</div><div class=""> </div><div class=""> #### Scheduler (experimental)</div><div class=""> </div><div class=""> The web2py scheduler works very much like the task queue described in the previous sub-section with some differences:</div><div class=""> - It provides a standard mechanism for creating and scheduling tasks.</div><div class=""> - There is not a single background process but a set of workers processes.</div><div class=""> - The job of worker nodes can be monitored because their state, as well as the state of the tasks, is stored in the database.</div><div class=""> - It works without web2py but that is not documented here.</div><div class=""> </div><div class=""> The scheduler does not use cron, although one can use cron @reboot to start the worker nodes.</div><div class=""> </div><div class=""> In the scheduler, a task is simply a function defined in a model (or in a module and imported by a model). For example:</div><div class=""> </div><div class=""> ``</div><div class=""> def task_add(a,b):</div><div class="">     return a+b</div><div class=""> ``:code</div><div class=""> </div><div class=""> Tasks will always be called in the same environment seen by controllers and therefore they see all the global variables defined in models, including database connections (``db``). Tasks differ from a controller action because they are not associated with an HTTP request and therefore there is no ``request.env``.</div><div class=""> </div><div class="insert">To enable the scheduler you should put into a model it<span class="highlight"></span>s instantiation.</div><div class=""> The recommended way to enable the scheduler to your app is to create a model file named ``scheduler.py`` and define your function there. After the functions, you can put the following code into the model:</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.scheduler import Scheduler</div><div class=""> myscheduler = Scheduler(db)</div><div class=""> ``</div><div class=""> NB: If your tasks are defined in a module (as opposed to a model) you may have to restart the workers.</div><div class=""> </div><div class=""> </div><div class=""> ##### Parameters</div><div class=""> The first argument of the ``Scheduler`` class must be the database to be used by the scheduler to communicate with the workers. This can be the ``db`` of the app or another dedicated ``db``, perhaps one shared by multiple apps. If you use SQLite it&#x27;s recommended to use a separate db from the one used by your app in order to keep the app responsive.</div><div class=""> Once the tasks are defined and the ``Scheduler`` is instantiated, all that is needed to do is to start the workers. You can do that in several ways:</div><div class=""> </div><div class=""> ``</div><div class=""> python web2py.py -K myapp</div><div class=""> ``</div><div class=""> starts a worker for the app ``myapp``. If you want start multiple workers for the same app, you can do so just passing ``myapp,myapp``. You can pass also the ``group_names`` (overriding the one set in your model) with</div><div class=""> </div><div class=""> ``</div><div class=""> python web2py.py -K myapp:group1:group2,myotherapp:group1</div><div class=""> Scheduler(</div><div class="">     utc_time=False</div><div class=""> )</div><div class=""> ``:code</div><div class=""> </div><div class=""> Let&#x27;s see them in order:</div><div class=""> </div><div class=""> - ``db`` is the database DAL instance were you want the scheduler tables be placed.</div><div class=""> - ``tasks`` can be a dict. Must be defined if you want to call a function not by his name, i.e. ``tasks=dict(mynameddemo1=demo1)`` will let you execute function demo1 with ``st.insert(task_name=&#x27;mytask&#x27;, function_name=&#x27;mynameddemo1&#x27;)`` or ``st.insert(task_name=&#x27;mytask&#x27;, function_name=&#x27;demo1&#x27;)``. If you don&#x27;t pass this parameter, function will be searched in the app environment.</div><div class=""> - ``worker_name`` is None by default. As soon as the worker is started, a worker name is generated as hostname-uuid. If you want to specify that, be sure that it&#x27;s unique.</div><div class=""> - ``group_names`` is by default set to **[main]**. All tasks have a ``group_name`` parameter, set to **main** by default. Workers can only pick up tasks of their assigned group.</div><div class=""> NB: This is useful if you have different workers instances (e.g. on different machines) and you want to assign tasks to a specific worker.</div><div class=""> NB2: It&#x27;s possible to assign a worker more groups, and they can be also all the same, as</div><div class=""> ``[&#x27;mygroup&#x27;,&#x27;mygroup&#x27;]``. Tasks will be distributed taking into consideration that</div><div class=""> a worker with group_names ``[&#x27;mygroup&#x27;,&#x27;mygroup&#x27;]`` is able to process the double of the tasks</div><div class=""> a worker with group_names ``[&#x27;mygroup&#x27;]`` is.</div><div class=""> - ``heartbeat`` is by default set to 3 seconds. This parameter is the one controlling how often a scheduler will check its status on the ``scheduler_worker`` table and see if there are any **ASSIGNED** tasks to itself to process.</div><div class=""> - ``max_empty_runs`` is 0 by default, that means that the worker will continue to process tasks as soon as they are **ASSIGNED**. If you set this to a value of, let&#x27;s say, 10, a worker will die automatically if it&#x27;s **ACTIVE** and no tasks are **ASSIGNED** to it for 10 loops. A loop is when a worker searches for tasks, every 3 seconds (or the set ``heartbeat``)</div><div class=""> - ``discard_results`` is False by default. If set to True, no scheduler_run records will be created.</div><div class=""> NB: scheduler_run records will be created as before for **FAILED**, **TIMEOUT** and</div><div class=""> **STOPPED** tasks&#x27;s statuses.</div><div class="insert">- ``utc_time`` is False by default. If you need to coordinate with workers living in different timezones, or don&#x27;t have problems with solar/DST times, supplying datetimes from different countries, etc, you can set this to True. The scheduler will hono<span class="highlight"></span>r the UTC time and work leaving the local time aside. Caveat: you need to schedule tasks with UTC times (for start_time, stop_time, and so on.)</div><div class=""> </div><div class=""> Now we have the infrastructure in place: defined the tasks, told the scheduler about them, started the worker(s). What remains is to actually schedule the tasks</div><div class=""> </div><div class=""> </div><div class=""> ##### Tasks</div><div class=""> Tasks can be scheduled programmatically or via appadmin. In fact, a task is scheduled simply by adding an entry in the table &quot;scheduler_task&quot;, which you can access via appadmin:</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/myapp/appadmin/insert/db/scheduler_task</div><div class=""> ``</div><div class=""> </div><div class=""> The meaning of the fields in this table is obvious. The &quot;args&quot; and &quot;vars&quot;&quot; fields are the values to be passed to the task in JSON format. In the case of the &quot;task_add&quot; above, an example of &quot;args&quot; and &quot;vars&quot; could be:</div><div class=""> </div><div class=""> ``</div><div class=""> args = [3, 4]</div><div class=""> vars = {}</div><div class=""> ``</div><div class=""> </div><div class=""> or</div><div class=""> </div><div class=""> NB: the time is not calculated between the END of the first round and the START</div><div class=""> </div><div class=""> Another nice addition, you can set how many times the function can raise an exception (i.e. requesting data from a sloooow webservice) and be queued again instead of stopping in **FAILED**  status with the parameter ``retry_failed`` (default = 0, -1 = unlimited).</div><div class=""> </div><div class=""> [[task repeats http://yuml.me/7d8b85e4.jpg center]]</div><div class=""> </div><div class=""> Summary: you have</div><div class=""> - ``period`` and ``repeats`` to get an automatically rescheduled function</div><div class=""> - ``timeout`` to be sure that a function doesn&#x27;t exceed a certain amount of time</div><div class=""> - ``retry_failed`` to control how many times the task can &quot;fail&quot;</div><div class=""> - ``start_time`` and ``stop_time`` to schedule a function in a restricted timeframe</div><div class=""> </div><div class=""> </div><div class=""> ##### Reporting percentages</div><div class=""> </div><div class=""> A special &quot;word&quot; encountered in the print statements of your functions clear all</div><div class=""> the previous output. That word is ``!clear!``.</div><div class=""> This, coupled with the ``sync_output`` parameter, allows to report percentages</div><div class=""> a breeze. Let&#x27;s see how that works:</div><div class=""> </div><div class=""> ``</div><div class="insert">def repo<span class="highlight">r</span>ting_percentages():</div><div class="">     time.sleep(5)</div><div class="">     print &#x27;50%&#x27;</div><div class="">     time.sleep(5)</div><div class="">     print &#x27;!clear!100%&#x27;</div><div class="">     return 1</div><div class=""> ``</div><div class=""> </div><div class=""> The function ``demo6`` sleeps for 5 seconds, outputs ``50%``.</div><div class=""> Then, it sleeps other 5 seconds and outputs ``100%``. Note that the output in the scheduler_run table is synced every 2 seconds and that the second print statement that contains ``!clear!100%`` gets the ``50%`` output cleared and replaced by ``100%`` only.</div><div class=""> </div><div class=""> ``</div><div class=""> st.validate_and_insert(task_name=&#x27;percentages&#x27;, function_name=&#x27;demo6&#x27;, sync_output=2)</div><div class=""> ``</div><div class=""> </div><div class=""> ##### Results and output</div><div class=""> The table &quot;scheduler_run&quot; stores the status of all running tasks. Each record references a task that has been picked up by a worker.  One task can have multiple runs. For example, a task scheduled to repeat 10 times an hour will probably have 10 runs (unless one fails or they take longer than 1 hour). Beware that if the task has no return values, it is removed from the scheduler_run table as soon as it is finished.</div><div class=""> </div><div class=""> Possible run statuses are:</div><div class=""> </div><div class=""> ``</div><div class=""> RUNNING, COMPLETED, FAILED, TIMEOUT</div><div class=""> ``</div><div class=""> </div><div class=""> If the run is completed, no exceptions are thrown, and there is no task timeout, the run is marked as ``COMPLETED`` and the task is marked as ``QUEUED`` or ``COMPLETED`` depending on whether it is supposed to run again at a later time. The output of the task is serialized in JSON and stored in the run record.</div><div class=""> </div><div class=""> When a ``RUNNING`` task throws an exception, the run is mark as ``FAILED`` and the task is marked as ``FAILED``. The traceback is stored in the run record.</div><div class=""> </div><div class=""> Similarly, when a run exceeds the timeout, it is stopped and marked as ``TIMEOUT``, and the task is marked as ``TIMEOUT``.</div><div class=""> </div><div class=""> In any case, the stdout is captured and also logged into the run record.</div><div class=""> </div><div class=""> Using appadmin, one can check all ``RUNNING`` tasks, the output of ``COMPLETED`` tasks, the error of ``FAILED`` tasks, etc.</div><div class=""> </div><div class=""> The scheduler also creates one more table called &quot;scheduler_worker&quot;, which stores the workers&#x27; heartbeat and their status. Possible worker statuses are:</div><div class=""> </div><div class=""> ##### Managing processes</div><div class=""> Worker fine management is hard. This module tries not to leave behind any platform (Mac, Win, Linux) .</div><div class=""> </div><div class=""> When you start a worker, you may want later to:</div><div class="insert">+- kill it &quot;no matter what it&#x27;s doing&quot;</div><div class="insert">+- kill it only if it&#x27;s not processing tasks</div><div class=""> - put it to sleep</div><div class=""> Maybe you have yet some tasks queued, and you want to save some resources.</div><div class=""> You know you want them processed every hour, so, you&#x27;ll want to:</div><div class=""> - process all queued tasks and die automatically</div><div class=""> All of these things are possible managing ``Scheduler`` parameters or the ``scheduler_worker`` table.</div><div class=""> To be more precise, for started workers you will change the ``status`` value of any worker to influence</div><div class="insert">its behavio<span class="highlight"></span>r.</div><div class=""> As tasks, workers can be in some fixed statuses : ACTIVE, DISABLED, TERMINATE or KILLED.</div></div></div>
    <div class="span6"><div class="diff"><div class=""> Options:</div><div class="">   --version             show program&#x27;s version number and exit</div><div class="">   -h, --help            show this help message and exit</div><div class="">   -i IP, --ip=IP        ip address of the server (127.0.0.1)</div><div class="">   -p PORT, --port=PORT  port of server (8000)</div><div class="">   -a PASSWORD, --password=PASSWORD</div><div class="">                         password to be used for administration (use -a</div><div class="">                         &quot;&lt;recycle&gt;&quot; to reuse the last password))</div><div class="">   -c SSL_CERTIFICATE, --ssl_certificate=SSL_CERTIFICATE</div><div class="delete">                        file that contains <span class="highlight">ssl</span> certificate</div><div class="">   -k SSL_PRIVATE_KEY, --ssl_private_key=SSL_PRIVATE_KEY</div><div class="delete">                        file that contains <span class="highlight">ssl</span> private key</div><div class="">   --ca-cert=SSL_CA_CERTIFICATE</div><div class="">                         Use this file containing the CA certificate to</div><div class="">                         validate X509 certificates from clients</div><div class="">   -d PID_FILENAME, --pid_filename=PID_FILENAME</div><div class="">                         file to store the pid of the server</div><div class="">   -l LOG_FILENAME, --log_filename=LOG_FILENAME</div><div class="">                         file to log connections</div><div class="">   -n NUMTHREADS, --numthreads=NUMTHREADS</div><div class="">                         number of threads (deprecated)</div><div class="">   --minthreads=MINTHREADS</div><div class="">                         minimum number of server threads</div><div class="">   --maxthreads=MAXTHREADS</div><div class="">                         maximum number of server threads</div><div class="">   -s SERVER_NAME, --server_name=SERVER_NAME</div><div class="">                         server name for the web server</div><div class="">   -q REQUEST_QUEUE_SIZE, --request_queue_size=REQUEST_QUEUE_SIZE</div><div class="">                         max number of queued requests when server unavailable</div><div class="">   -o TIMEOUT, --timeout=TIMEOUT</div><div class="">                         timeout for individual request (10 seconds)</div><div class="">   -z SHUTDOWN_TIMEOUT, --shutdown_timeout=SHUTDOWN_TIMEOUT</div><div class=""> from gluon import *</div><div class=""> ``</div><div class=""> </div><div class=""> In fact, any Python module, even if not imported by a web2py application, can import the web2py API as long as web2py is in the ``sys.path``.</div><div class=""> </div><div class=""> There is one caveat, though. Web2py defines some global objects (request, response, session, cache, T) that can only exist when an HTTP request is present (or is faked). Therefore, modules can access them only if they are called from an application. For this reasons they are placed into a container caller ``current``, which is a thread local object. Here is an example.</div><div class=""> </div><div class=""> Create a module &quot;/myapp/modules/test.py&quot; that contains:</div><div class=""> ``</div><div class=""> from gluon import *</div><div class=""> def ip(): return current.request.client</div><div class=""> ``</div><div class=""> Now from a controller in &quot;myapp&quot; you can do</div><div class=""> ``</div><div class=""> import test</div><div class=""> def index():</div><div class="">     return &quot;Your ip is &quot; + test.ip()</div><div class=""> ``</div><div class=""> </div><div class=""> Notice a few things:</div><div class=""> </div><div class="delete">- ``import test`` looks for the module first in the current app&#x27;s modules folder, then in the folders listed in ``sys.path``. Therefore, app-level modules always take prece<span class="highlight">n</span>dence over Python modules. This allows different apps to ship with different versions of their modules, without conflicts.</div><div class=""> </div><div class=""> - Different users can call the same action ``index`` concurrently, which calls the function in the module, and yet there is no conflict because ``current.request`` is a different object in different threads. Just be careful not to access ``current.request`` outside of functions or classes (i.e., at the top level) in the module.</div><div class=""> </div><div class=""> - ``import test`` is a shortcut for ``from applications.appname.modules import test``. Using the longer syntax, it is possible to import modules from other applications.</div><div class=""> </div><div class=""> For uniformity with normal Python behavior, by default web2py does not reload modules when changes are made. Yet this can be changed. To turn on the auto-reload feature for modules, use the ``track_changes`` function as follows (typically in a model file, before any imports):</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.custom_import import track_changes; track_changes(True)</div><div class=""> ``:code</div><div class=""> </div><div class=""> From now on, every time a module is imported, the importer will check if the Python source file (.py) has changed. If it has changed, the module will be reloaded. This applies to all Python modules, even Python modules outside web2py. The mode is global and applies to all applications. Changes made to models, controllers, and views are always reloaded regardless of the mode used. To turn the mode off, use the same function with ``False`` as the argument. To know the actual tracking state, use the ``is_tracking_changes()`` function, also from ``gluon.custom_import``.</div><div class=""> </div><div class=""> Modules that import ``current`` can access:</div><div class=""> - ``current.request``</div><div class=""> - ``current.response``</div><div class=""> - ``current.session``</div><div class=""> - ``current.cache``</div><div class=""> - ``current.T``</div><div class=""> and any other variable your application chooses to store in current. For example a model could do</div><div class=""> Also notice the ``request.env.wsgi_*`` variables. They are specific to the wsgi</div><div class=""> ``response.session_file``: file stream containing the session.</div><div class=""> </div><div class=""> ``response.session_file_name``: name of the file where the session will be saved.</div><div class=""> </div><div class=""> ``response.session_id``: the id of the current session. It is determined automatically. NEVER CHANGE THIS VARIABLE.</div><div class=""> </div><div class=""> ``response.session_id_name``: the name of the session cookie for this application. NEVER CHANGE THIS VARIABLE.</div><div class=""> </div><div class=""> ``response.status``: the HTTP status code integer to be passed to the response. Default is 200 (OK).</div><div class=""> </div><div class=""> ``response.stream(file, chunk_size, request=request)``: when a controller returns it, web2py streams the file content back to the client in blocks of size ``chunk_size``. The ``request`` parameter is required to use the chunk start in the HTTP header. As noted above, ``response.download`` should be used to retrieve files stored via an upload field. ``response.stream`` can be used in other cases, such as returning a temporary file or StringIO object created by the controller. Unlike ``response.download``, ``response.stream`` does not automatically set the Content-Disposition header, so you may need to do that manually (e.g., to specify download as an attachment, and to provide a filename). However, it does automatically set the ``Content-Type`` header (based on the filename extension).</div><div class=""> </div><div class=""> ``response.subtitle``: optional parameter that may be included in the views. It should contain the subtitle of the page.</div><div class=""> </div><div class=""> ``response.title``: optional parameter that may be included in the views. It should contain the title of the page and should be rendered by the HTML title TAG in the header.</div><div class=""> </div><div class=""> ``response.toolbar``: a function that allows you embed a toolbar into page form debugging purposes ``{{=response.toolbar()}}``. The toolbar displays request, response, session variables and database access time for each query.</div><div class=""> </div><div class=""> ``response._vars``: this variable is accessible only in a view, not in the action. It contains the value returned by the action to the view.</div><div class=""> </div><div class="delete">``response.optimize_css``: if can be set to &quot;concat,minify,inline&quot; to concatenate, mini<span class="highlight">t</span>y and inline the CSS files included by web2py.</div><div class=""> </div><div class="delete">``response.optimize_js``: if can be set to &quot;concat,minify,inline&quot; to concatenate, mini<span class="highlight">t</span>y and inline the <span class="highlight">C</span>S<span class="highlight">S</span> files included by web2py.</div><div class=""> </div><div class=""> ``response.view``: the name of the view template that must render the page. This is set by default to:</div><div class=""> ``</div><div class=""> &quot;%s/%s.%s&quot; % (request.controller, request.function, request.extension)</div><div class=""> ``:code</div><div class=""> </div><div class=""> or, if the above file cannot be located, to</div><div class=""> ``</div><div class=""> &quot;generic.%s&quot; % (request.extension)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Change the value of this variable to modify the view file associated with a particular action.</div><div class=""> </div><div class=""> ``response.delimiters`` defaults to ``(&#x27;{{&#x27;,&#x27;}}&#x27;)``. It allows you to change the delimiter of code embedded in views.</div><div class=""> </div><div class=""> ``response.xmlrpc(request, methods)``: when a controller returns it, this function exposes the methods via XML-RPC``xmlrpc``:cite . This function is deprecated since a better mechanism is available and described in Chapter 10.</div><div class=""> </div><div class=""> ``response.write(text)``: a method to write text into the output page body.</div><div class=""> </div><div class="delete">``response.js`` can contain Javascript <span class="highlight">C</span>ode. This code will be executed if and only if the response is received by a web2py component as discussed in Chapter 12.</div><div class=""> </div><div class=""> Since ``response`` is a ``gluon.storage.Storage`` object, it can be used to store other attributes that you may want to pass to the view. While there is no technical restriction, our recommendation is to store only variables that are to be rendered by all pages in the overall layout (&quot;layout.html&quot;).</div><div class=""> </div><div class=""> Anyway, we strongly suggest to stick to the variables listed here:</div><div class=""> ``</div><div class=""> response.title</div><div class=""> response.subtitle</div><div class=""> response.flash</div><div class=""> response.menu</div><div class=""> response.meta.author</div><div class=""> response.meta.description</div><div class=""> response.meta.keywords</div><div class=""> response.meta.*</div><div class=""> ``:code</div><div class=""> </div><div class=""> because this will make it easier for you to replace the standard &quot;layout.html&quot; file that comes with web2py with another layout file, one that uses the same set of variables.</div><div class=""> </div><div class=""> Old versions of web2py user ``response.author`` instead of ``response.meta.author`` and similar for the other meta attributes.</div><div class=""> </div><div class=""> ### ``session``</div><div class=""> Because ``time_expire`` is set to 20 seconds in the second call and only 10 seco</div><div class=""> </div><div class=""> Setting ``time_expire=0`` (or a negative value) forces the cached item to be refreshed (because the elapsed time since the last save will always be &gt; 0), and setting ``time_expire=None`` forces retrieval of the cached value, regardless of the time elapsed since it was saved (if ``time_expire`` is always ``None``, the cached item will effectively never expire).</div><div class=""> </div><div class=""> You can clear one or more cache variables with</div><div class=""> ``cache clear``:inxx</div><div class=""> </div><div class=""> ``</div><div class=""> cache.ram.clear(regex=&#x27;...&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> where ``regex`` is a regular expression matching all the keys you want removed from the cache. You can also clear an single item with:</div><div class=""> ``</div><div class=""> cache.ram(key, None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> where ``key`` is the key of the cached item.</div><div class=""> </div><div class=""> It is also possible to define other caching mechanisms such as memcache. Memcache is available via ``gluon.contrib.memcache`` and is discussed in more details in Chapter 14.</div><div class=""> </div><div class=""> ------</div><div class="delete">Be careful when caching that caching is usually at the app-level not at the user level. If you need, for e<span class="highlight"></span>a<span class="highlight">x</span>mple, to cache user specific content, choose a key that includes the user id.</div><div class=""> ------</div><div class=""> </div><div class=""> </div><div class=""> ### ``URL``</div><div class=""> ``URL``:inxx</div><div class=""> The ``URL`` function is one of the most important functions in web2py. It generates internal URL paths for the actions and the static files.</div><div class=""> </div><div class=""> Here is an example:</div><div class=""> </div><div class=""> ``</div><div class=""> URL(&#x27;f&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> is mapped into</div><div class=""> </div><div class=""> ``</div><div class=""> /[application]/[controller]/f</div><div class=""> ``:code</div><div class=""> </div><div class=""> Notice that the output of the ``URL`` function depends on the name of the current application, the calling controller, and other parameters. web2py supports URL mapping and reverse URL mapping. URL mapping allows you to redefine the format of external URLs. If you use the ``URL`` function to generate all the internal URLs, then additions or changes to URL mappings will prevent broken links within the web2py application.</div><div class=""> This means that only ``HTTP`` can be used for cross-page control flow. Other exc</div><div class=""> The command:</div><div class=""> ``</div><div class=""> redirect(&#x27;http://www.web2py.com&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> is simply a shortcut for:</div><div class=""> ``</div><div class=""> raise HTTP(303,</div><div class="">            &#x27;You are being redirected &lt;a href=&quot;%s&quot;&gt;here&lt;/a&gt;&#x27; % location,</div><div class="">            Location=&#x27;http://www.web2py.com&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The named arguments of the ``HTTP`` initializer method are translated into HTTP header directives, in this case, the redirection target location. ``redirect`` takes an optional second argument, which is the HTTP status code for the redirection (303 by default). Change this number to 307 for a temporary redirect or to 301 for a permanent redirect.</div><div class=""> </div><div class=""> The most common way to use redirect is to redirect to other pages in the same app and (optionally) pass parameters:</div><div class=""> </div><div class=""> ``</div><div class=""> redirect(URL(&#x27;index&#x27;, args=(1,2,3), vars=dict(a=&#x27;b&#x27;)))</div><div class=""> ``:code</div><div class=""> </div><div class="delete">In chapter 12 we discuss web2py components. They make Ajax requ<span class="highlight">irest</span> to web2py actions. If the called action performs a redirect, you may want the Ajax request to follow the redirect or you may want the entire page perfo<span class="highlight"></span>ming the Ajax request redirecting. In this latter case you can set:</div><div class=""> </div><div class=""> ``</div><div class=""> redirect(...,type=&#x27;auto&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> ### ``T`` and Internationalization</div><div class=""> ``T``:inxx ``internationalization``:inxx</div><div class=""> </div><div class=""> The object ``T`` is the language translator. It constitutes a single global instance of the web2py class ``gluon.language.translator``. All string constants (and only string constants) should be marked by ``T``, for example:</div><div class=""> ``</div><div class=""> a = T(&quot;hello world&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Strings that are marked with ``T`` are identified by web2py as needing language translation and they will be translated when the code (in the model, controller, or view) is executed. If the string to be translated is not a constant but a variable, it will be added to the translation file at runtime (except on GAE) to be translated later.</div><div class=""> </div><div class=""> The ``T`` object can also contain interpolated variables and support multiple equivalent syntax:</div><div class=""> ``</div><div class=""> a = T(&quot;hello %s&quot;, (&#x27;Tim&#x27;,))</div><div class=""> a = T(&quot;hello %(name)s&quot;, dict(name=&#x27;Tim&#x27;))</div><div class=""> In chapter 8, we will provide an example of how to use the above method to send</div><div class=""> </div><div class=""> #### Scheduler (experimental)</div><div class=""> </div><div class=""> The web2py scheduler works very much like the task queue described in the previous sub-section with some differences:</div><div class=""> - It provides a standard mechanism for creating and scheduling tasks.</div><div class=""> - There is not a single background process but a set of workers processes.</div><div class=""> - The job of worker nodes can be monitored because their state, as well as the state of the tasks, is stored in the database.</div><div class=""> - It works without web2py but that is not documented here.</div><div class=""> </div><div class=""> The scheduler does not use cron, although one can use cron @reboot to start the worker nodes.</div><div class=""> </div><div class=""> In the scheduler, a task is simply a function defined in a model (or in a module and imported by a model). For example:</div><div class=""> </div><div class=""> ``</div><div class=""> def task_add(a,b):</div><div class="">     return a+b</div><div class=""> ``:code</div><div class=""> </div><div class=""> Tasks will always be called in the same environment seen by controllers and therefore they see all the global variables defined in models, including database connections (``db``). Tasks differ from a controller action because they are not associated with an HTTP request and therefore there is no ``request.env``.</div><div class=""> </div><div class="delete">To enable the scheduler you should put into a model it<span class="highlight">&#x27;</span>s instantiation.</div><div class=""> The recommended way to enable the scheduler to your app is to create a model file named ``scheduler.py`` and define your function there. After the functions, you can put the following code into the model:</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.scheduler import Scheduler</div><div class=""> myscheduler = Scheduler(db)</div><div class=""> ``</div><div class=""> NB: If your tasks are defined in a module (as opposed to a model) you may have to restart the workers.</div><div class=""> </div><div class=""> </div><div class=""> ##### Parameters</div><div class=""> The first argument of the ``Scheduler`` class must be the database to be used by the scheduler to communicate with the workers. This can be the ``db`` of the app or another dedicated ``db``, perhaps one shared by multiple apps. If you use SQLite it&#x27;s recommended to use a separate db from the one used by your app in order to keep the app responsive.</div><div class=""> Once the tasks are defined and the ``Scheduler`` is instantiated, all that is needed to do is to start the workers. You can do that in several ways:</div><div class=""> </div><div class=""> ``</div><div class=""> python web2py.py -K myapp</div><div class=""> ``</div><div class=""> starts a worker for the app ``myapp``. If you want start multiple workers for the same app, you can do so just passing ``myapp,myapp``. You can pass also the ``group_names`` (overriding the one set in your model) with</div><div class=""> </div><div class=""> ``</div><div class=""> python web2py.py -K myapp:group1:group2,myotherapp:group1</div><div class=""> Scheduler(</div><div class="">     utc_time=False</div><div class=""> )</div><div class=""> ``:code</div><div class=""> </div><div class=""> Let&#x27;s see them in order:</div><div class=""> </div><div class=""> - ``db`` is the database DAL instance were you want the scheduler tables be placed.</div><div class=""> - ``tasks`` can be a dict. Must be defined if you want to call a function not by his name, i.e. ``tasks=dict(mynameddemo1=demo1)`` will let you execute function demo1 with ``st.insert(task_name=&#x27;mytask&#x27;, function_name=&#x27;mynameddemo1&#x27;)`` or ``st.insert(task_name=&#x27;mytask&#x27;, function_name=&#x27;demo1&#x27;)``. If you don&#x27;t pass this parameter, function will be searched in the app environment.</div><div class=""> - ``worker_name`` is None by default. As soon as the worker is started, a worker name is generated as hostname-uuid. If you want to specify that, be sure that it&#x27;s unique.</div><div class=""> - ``group_names`` is by default set to **[main]**. All tasks have a ``group_name`` parameter, set to **main** by default. Workers can only pick up tasks of their assigned group.</div><div class=""> NB: This is useful if you have different workers instances (e.g. on different machines) and you want to assign tasks to a specific worker.</div><div class=""> NB2: It&#x27;s possible to assign a worker more groups, and they can be also all the same, as</div><div class=""> ``[&#x27;mygroup&#x27;,&#x27;mygroup&#x27;]``. Tasks will be distributed taking into consideration that</div><div class=""> a worker with group_names ``[&#x27;mygroup&#x27;,&#x27;mygroup&#x27;]`` is able to process the double of the tasks</div><div class=""> a worker with group_names ``[&#x27;mygroup&#x27;]`` is.</div><div class=""> - ``heartbeat`` is by default set to 3 seconds. This parameter is the one controlling how often a scheduler will check its status on the ``scheduler_worker`` table and see if there are any **ASSIGNED** tasks to itself to process.</div><div class=""> - ``max_empty_runs`` is 0 by default, that means that the worker will continue to process tasks as soon as they are **ASSIGNED**. If you set this to a value of, let&#x27;s say, 10, a worker will die automatically if it&#x27;s **ACTIVE** and no tasks are **ASSIGNED** to it for 10 loops. A loop is when a worker searches for tasks, every 3 seconds (or the set ``heartbeat``)</div><div class=""> - ``discard_results`` is False by default. If set to True, no scheduler_run records will be created.</div><div class=""> NB: scheduler_run records will be created as before for **FAILED**, **TIMEOUT** and</div><div class=""> **STOPPED** tasks&#x27;s statuses.</div><div class="delete">- ``utc_time`` is False by default. If you need to coordinate with workers living in different timezones, or don&#x27;t have problems with solar/DST times, supplying datetimes from different countries, etc, you can set this to True. The scheduler will hono<span class="highlight">u</span>r the UTC time and work leaving the local time aside. Caveat: you need to schedule tasks with UTC times (for start_time, stop_time, and so on.)</div><div class=""> </div><div class=""> Now we have the infrastructure in place: defined the tasks, told the scheduler about them, started the worker(s). What remains is to actually schedule the tasks</div><div class=""> </div><div class=""> </div><div class=""> ##### Tasks</div><div class=""> Tasks can be scheduled programmatically or via appadmin. In fact, a task is scheduled simply by adding an entry in the table &quot;scheduler_task&quot;, which you can access via appadmin:</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/myapp/appadmin/insert/db/scheduler_task</div><div class=""> ``</div><div class=""> </div><div class=""> The meaning of the fields in this table is obvious. The &quot;args&quot; and &quot;vars&quot;&quot; fields are the values to be passed to the task in JSON format. In the case of the &quot;task_add&quot; above, an example of &quot;args&quot; and &quot;vars&quot; could be:</div><div class=""> </div><div class=""> ``</div><div class=""> args = [3, 4]</div><div class=""> vars = {}</div><div class=""> ``</div><div class=""> </div><div class=""> or</div><div class=""> </div><div class=""> NB: the time is not calculated between the END of the first round and the START</div><div class=""> </div><div class=""> Another nice addition, you can set how many times the function can raise an exception (i.e. requesting data from a sloooow webservice) and be queued again instead of stopping in **FAILED**  status with the parameter ``retry_failed`` (default = 0, -1 = unlimited).</div><div class=""> </div><div class=""> [[task repeats http://yuml.me/7d8b85e4.jpg center]]</div><div class=""> </div><div class=""> Summary: you have</div><div class=""> - ``period`` and ``repeats`` to get an automatically rescheduled function</div><div class=""> - ``timeout`` to be sure that a function doesn&#x27;t exceed a certain amount of time</div><div class=""> - ``retry_failed`` to control how many times the task can &quot;fail&quot;</div><div class=""> - ``start_time`` and ``stop_time`` to schedule a function in a restricted timeframe</div><div class=""> </div><div class=""> </div><div class=""> ##### Reporting percentages</div><div class=""> </div><div class=""> A special &quot;word&quot; encountered in the print statements of your functions clear all</div><div class=""> the previous output. That word is ``!clear!``.</div><div class=""> This, coupled with the ``sync_output`` parameter, allows to report percentages</div><div class=""> a breeze. Let&#x27;s see how that works:</div><div class=""> </div><div class=""> ``</div><div class="delete">def repo<span class="highlight"></span>ting_percentages():</div><div class="">     time.sleep(5)</div><div class="">     print &#x27;50%&#x27;</div><div class="">     time.sleep(5)</div><div class="">     print &#x27;!clear!100%&#x27;</div><div class="">     return 1</div><div class=""> ``</div><div class=""> </div><div class=""> The function ``demo6`` sleeps for 5 seconds, outputs ``50%``.</div><div class=""> Then, it sleeps other 5 seconds and outputs ``100%``. Note that the output in the scheduler_run table is synced every 2 seconds and that the second print statement that contains ``!clear!100%`` gets the ``50%`` output cleared and replaced by ``100%`` only.</div><div class=""> </div><div class=""> ``</div><div class=""> st.validate_and_insert(task_name=&#x27;percentages&#x27;, function_name=&#x27;demo6&#x27;, sync_output=2)</div><div class=""> ``</div><div class=""> </div><div class=""> ##### Results and output</div><div class=""> The table &quot;scheduler_run&quot; stores the status of all running tasks. Each record references a task that has been picked up by a worker.  One task can have multiple runs. For example, a task scheduled to repeat 10 times an hour will probably have 10 runs (unless one fails or they take longer than 1 hour). Beware that if the task has no return values, it is removed from the scheduler_run table as soon as it is finished.</div><div class=""> </div><div class=""> Possible run statuses are:</div><div class=""> </div><div class=""> ``</div><div class=""> RUNNING, COMPLETED, FAILED, TIMEOUT</div><div class=""> ``</div><div class=""> </div><div class=""> If the run is completed, no exceptions are thrown, and there is no task timeout, the run is marked as ``COMPLETED`` and the task is marked as ``QUEUED`` or ``COMPLETED`` depending on whether it is supposed to run again at a later time. The output of the task is serialized in JSON and stored in the run record.</div><div class=""> </div><div class=""> When a ``RUNNING`` task throws an exception, the run is mark as ``FAILED`` and the task is marked as ``FAILED``. The traceback is stored in the run record.</div><div class=""> </div><div class=""> Similarly, when a run exceeds the timeout, it is stopped and marked as ``TIMEOUT``, and the task is marked as ``TIMEOUT``.</div><div class=""> </div><div class=""> In any case, the stdout is captured and also logged into the run record.</div><div class=""> </div><div class=""> Using appadmin, one can check all ``RUNNING`` tasks, the output of ``COMPLETED`` tasks, the error of ``FAILED`` tasks, etc.</div><div class=""> </div><div class=""> The scheduler also creates one more table called &quot;scheduler_worker&quot;, which stores the workers&#x27; heartbeat and their status. Possible worker statuses are:</div><div class=""> </div><div class=""> ##### Managing processes</div><div class=""> Worker fine management is hard. This module tries not to leave behind any platform (Mac, Win, Linux) .</div><div class=""> </div><div class=""> When you start a worker, you may want later to:</div><div class="delete">-- kill it &quot;no matter what its doing&quot;</div><div class="delete">-- kill it only if its not processing tasks</div><div class=""> - put it to sleep</div><div class=""> Maybe you have yet some tasks queued, and you want to save some resources.</div><div class=""> You know you want them processed every hour, so, you&#x27;ll want to:</div><div class=""> - process all queued tasks and die automatically</div><div class=""> All of these things are possible managing ``Scheduler`` parameters or the ``scheduler_worker`` table.</div><div class=""> To be more precise, for started workers you will change the ``status`` value of any worker to influence</div><div class="delete">its behavio<span class="highlight">u</span>r.</div><div class=""> As tasks, workers can be in some fixed statuses : ACTIVE, DISABLED, TERMINATE or KILLED.</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/189c12f17f3e21b5a8782723a2e75a89c8342098">189c12f</a><ul><li>Date : 2012-09-04</li><li>fixed bugs and added scheduler info, thanks Niphlod</li></ul></li></ul>
<div class="row-fluid" id="com_189c12f17f3e21b5a8782723a2e75a89c8342098">
    <div class="span6"><div class="diff"><div class=""> Options:</div><div class="">   --version             show program&#x27;s version number and exit</div><div class="">   -h, --help            show this help message and exit</div><div class="">   -i IP, --ip=IP        ip address of the server (127.0.0.1)</div><div class="">   -p PORT, --port=PORT  port of server (8000)</div><div class="">   -a PASSWORD, --password=PASSWORD</div><div class="">                         password to be used for administration (use -a</div><div class="">                         &quot;&lt;recycle&gt;&quot; to reuse the last password))</div><div class="">   -c SSL_CERTIFICATE, --ssl_certificate=SSL_CERTIFICATE</div><div class="">                         file that contains ssl certificate</div><div class="">   -k SSL_PRIVATE_KEY, --ssl_private_key=SSL_PRIVATE_KEY</div><div class="">                         file that contains ssl private key</div><div class="insert">+  --ca-cert=SSL_CA_CERTIFICATE</div><div class="insert">+                        Use this file containing the CA certificate to</div><div class="insert">+                        validate X509 certificates from clients</div><div class="">   -d PID_FILENAME, --pid_filename=PID_FILENAME</div><div class="">                         file to store the pid of the server</div><div class="">   -l LOG_FILENAME, --log_filename=LOG_FILENAME</div><div class="">                         file to log connections</div><div class="">   -n NUMTHREADS, --numthreads=NUMTHREADS</div><div class="">                         number of threads (deprecated)</div><div class="">   --minthreads=MINTHREADS</div><div class="">                         minimum number of server threads</div><div class="">   --maxthreads=MAXTHREADS</div><div class="">                         maximum number of server threads</div><div class="">   -s SERVER_NAME, --server_name=SERVER_NAME</div><div class="">                         server name for the web server</div><div class="">   -q REQUEST_QUEUE_SIZE, --request_queue_size=REQUEST_QUEUE_SIZE</div><div class="">                         max number of queued requests when server unavailable</div><div class="">   -o TIMEOUT, --timeout=TIMEOUT</div><div class="">                         timeout for individual request (10 seconds)</div><div class="">   -z SHUTDOWN_TIMEOUT, --shutdown_timeout=SHUTDOWN_TIMEOUT</div><div class="">                         timeout on shutdown of server (5 seconds)</div><div class="insert">+  --socket-timeout=SOCKET_TIMEOUT</div><div class="insert">+                        timeout for socket (5 second)</div><div class="">   -f FOLDER, --folder=FOLDER</div><div class="">                         folder from which to run web2py</div><div class="">   -v, --verbose         increase --test verbosity</div><div class="">   -Q, --quiet           disable all output</div><div class="">   -D DEBUGLEVEL, --debug=DEBUGLEVEL</div><div class="">                         set debug output level (0-100, 0 means all, 100 means</div><div class="">                         none; default is 30)</div><div class="">   -S APPNAME, --shell=APPNAME</div><div class="">                         run web2py in interactive shell or IPython (if</div><div class="">                         installed) with specified appname (if app does not</div><div class="">                         exist it will be created). APPNAME like a/c/f (c,f</div><div class="">                         optional)</div><div class="">   -B, --bpython         run web2py in interactive shell or bpython (if</div><div class="">                         installed) with specified appname (if app does not</div><div class="">                         exist it will be created).  Use combined with --shell</div><div class="">   -P, --plain           only use plain python shell; should be used with</div><div class="">                         --shell option</div><div class="">   -M, --import_models   auto import model files; default is False; should be</div><div class="">                         used with --shell option</div><div class="">   -R PYTHON_FILE, --run=PYTHON_FILE</div><div class="">                         run PYTHON_FILE in web2py environment; should be used</div><div class="">                         with --shell option</div><div class="">   -K SCHEDULER, --scheduler=SCHEDULER</div><div class="insert">+                        run scheduled tasks for the specified apps: expects a</div><div class="insert">+                        list of app names as -K app1,app2,app3 or a list of</div><div class="insert">+                        app:groups as -K app1:group1:group2,app2:group1 to</div><div class="insert">+                        override specific group_names. (only strings, no</div><div class="insert">+                        spaces allowed. Requires a scheduler defined in the</div><div class="insert">+                        models</div><div class="insert">+  -X, --with-scheduler  run schedulers alongside webserver</div><div class="">   -T TEST_PATH, --test=TEST_PATH</div><div class="">                         run doctests in web2py environment; TEST_PATH like</div><div class="">                         a/c/f (c,f optional)</div><div class="">   -W WINSERVICE, --winservice=WINSERVICE</div><div class="">                         -W install|start|stop as Windows service</div><div class="">   -C, --cron            trigger a cron run manually; usually invoked from a</div><div class="">                         system crontab</div><div class="">   --softcron            triggers the use of softcron</div><div class="">   -N, --no-cron         do not start cron automatically</div><div class="">   -J, --cronjob         identify cron-initiated command</div><div class="">   -L CONFIG, --config=CONFIG</div><div class="">                         config file</div><div class="">   -F PROFILER_FILENAME, --profiler=PROFILER_FILENAME</div><div class="">                         profiler filename</div><div class="">   -t, --taskbar         use web2py gui and run in taskbar (system tray)</div><div class="">   --nogui               text-only, no GUI</div><div class="">   -A ARGS, --args=ARGS  should be followed by a list of arguments to be passed</div><div class="">                         to script, to be used with -S, -A must be the last</div><div class="">                         option</div><div class="">   --no-banner           Do not print header banner</div><div class="">   --interfaces=INTERFACES</div><div class="insert">+                        listen on multiple addresses: &quot;ip:port:cert:key:ca_cer</div><div class="insert">+                        t;ip2:port2:cert2:key2:ca_cert2;...&quot; (:cert:key</div><div class="">                         optional; no spaces)</div><div class="insert">+  --run_system_tests    runs web2py tests</div><div class="insert">+</div><div class=""> ``:code</div><div class=""> </div><div class=""> Lower-case options are used to configure the web server. The ``-L`` option tells web2py to read configuration options from a file, ``-W`` installs web2py as a windows service, while ``-S``, ``-P`` and ``-M`` options start an interactive Python shell. The ``-T`` option finds and runs controller doctests in a web2py execution environment. For example, the following example runs doctests from all controllers in the &quot;welcome&quot; application:</div><div class=""> ``</div><div class=""> python web2py.py -vT welcome</div><div class=""> ``:code</div><div class=""> </div><div class=""> if you run web2py as Windows Service, ``-W``,  it is not convenient to pass the configuration using command line arguments. For this reason, in the web2py folder there is a sample &quot;options_std.py&quot; configuration file for the internal web server:</div><div class=""> </div><div class=""> ``</div><div class=""> import socket</div><div class=""> import os</div><div class=""> </div><div class=""> ip = &#x27;0.0.0.0&#x27;</div><div class=""> port = 80</div><div class=""> interfaces=[(&#x27;0.0.0.0&#x27;,80)]</div><div class=""> #interfaces.append((&#x27;0.0.0.0&#x27;,443,&#x27;ssl_private_key.pem&#x27;,&#x27;ssl_certificate.pem&#x27;))</div><div class=""> password = &#x27;&lt;recycle&gt;&#x27;  # ## &lt;recycle&gt; means use the previous password</div><div class=""> pid_filename = &#x27;httpserver.pid&#x27;</div><div class=""> log_filename = &#x27;httpserver.log&#x27;</div><div class=""> gluon/contrib/__init__.py</div><div class=""> gluon/contrib/feedparser.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> **markdown2**``markdown2``:cite  by Trent Mick for wiki markup:</div><div class=""> ``</div><div class=""> gluon/contrib/markdown/__init__.py</div><div class=""> gluon/contrib/markdown/markdown2.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> **markmin** markup:</div><div class=""> ``</div><div class=""> gluon/contrib/markmin.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> **fpdf** created my Mariano Reingart for generating PDF documents:</div><div class=""> ``</div><div class=""> gluon/contrib/fpdf</div><div class=""> ``</div><div class=""> This is not documented in this book but it is hosted and documented here:</div><div class=""> ``</div><div class="insert">http://code.google.com/p/<span class="highlight"></span>fpdf/</div><div class=""> ``</div><div class=""> </div><div class=""> **pysimplesoap** is a lightweight SOAP server implementation created by Mariano Reingart:</div><div class=""> </div><div class=""> ``</div><div class=""> gluon/contrib/pysimplesoap/</div><div class=""> ``:code</div><div class=""> </div><div class=""> **simplejsonrpc** is a lightweight JSON-RPC client also created by Mariano Reingart: ``jsonrpc``:inxx</div><div class=""> </div><div class=""> ``</div><div class=""> gluon/contrib/simplejsonrpc.py</div><div class=""> ``</div><div class=""> </div><div class=""> **memcache**``memcache``:cite  Python API by Evan Martin:</div><div class=""> ``</div><div class=""> gluon/contrib/memcache/__init__.py</div><div class=""> gluon/contrib/memcache/memcache.py</div><div class=""> ``</div><div class=""> </div><div class=""> Example of line to add to the system crontab, (usually /etc/crontab):</div><div class=""> </div><div class=""> If you are running external cron, make sure you add the -N command line parameter to your web2py startup script or config so there is no collision of multiple types of cron.  Also, with external ``cron``, make sure to add either ``-J`` (or ``--cronjob``, which is the same) as indicated above so that web2py knows that task is executed by cron. Web2py sets this internally with soft and hard ``cron``.</div><div class=""> </div><div class=""> In cases where you do not need any cron functionality within a particular process, you can use the -N command line parameter to disable it. Note that this might disable some maintenance tasks (like the automatic cleaning of session folders). The most common use of this function is when you:</div><div class=""> - have already set up external cron triggered from the system (most common with WSGI setup).</div><div class=""> - want to debug your application without cron interfering either with actions or with output.</div><div class=""> </div><div class=""> #### Homemade task queues</div><div class=""> </div><div class=""> While cron is useful to run tasks at regular time intervals, it is not always the best solution to run a background task. For this purpose web2py provides the ability to run any python script as if it were inside a controller:</div><div class=""> ``</div><div class=""> python web2py.py -S app -M -N -R applications/app/private/myscript.py -A a b c</div><div class=""> ``:code</div><div class=""> </div><div class=""> where ``-S app`` tells web2py to run &quot;myscript.py&quot; as &quot;app&quot;, ``-M`` tells web2py to execute models, ``-N`` tells web2py not to run cron, and ``-A a b c`` passes optional command line arguments ``sys.args=[&#x27;a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;]`` to &quot;myscript.py&quot;.</div><div class=""> </div><div class=""> This type of background process should not be executed via cron (except perhaps for cron @reboot) because you need to be sure that no more than one instance is running at the same time. With cron it is possible that a process starts at cron iteration 1 and is not completed by cron iteration 2, so cron starts it again, and again, and again - thus jamming the mail server.</div><div class=""> </div><div class=""> In chapter 8, we will provide an example of how to use the above method to send emails.</div><div class=""> </div><div class="insert">+</div><div class=""> #### Scheduler (experimental)</div><div class=""> </div><div class=""> The web2py scheduler works very much like the task queue described in the previous sub-section with some differences:</div><div class=""> - It provides a standard mechanism for creating and scheduling tasks.</div><div class=""> - There is not a single background process but a set of workers processes.</div><div class=""> - The job of worker nodes can be monitored because their state, as well as the state of the tasks, is stored in the database.</div><div class=""> - It works without web2py but that is not documented here.</div><div class=""> </div><div class=""> The scheduler does not use cron, although one can use cron @reboot to start the worker nodes.</div><div class=""> </div><div class=""> In the scheduler, a task is simply a function defined in a model (or in a module and imported by a model). For example:</div><div class=""> </div><div class=""> ``</div><div class=""> def task_add(a,b):</div><div class="">     return a+b</div><div class=""> ``:code</div><div class=""> </div><div class=""> Tasks will always be called in the same environment seen by controllers and therefore they see all the global variables defined in models, including database connections (``db``). Tasks differ from a controller action because they are not associated with an HTTP request and therefore there is no ``request.env``.</div><div class=""> </div><div class="insert">+To enable the scheduler you should put into a model it&#x27;s instantiation.</div><div class="insert">+The recommended way to enable the scheduler to your app is to create a model file named ``scheduler.py`` and define your function there. After the functions, you can put the following code into the model:</div><div class=""> </div><div class=""> ``</div><div class="insert">+from gluon.scheduler import Scheduler</div><div class="insert">+myscheduler = Scheduler(db)</div><div class=""> ``</div><div class="insert">+NB: If your tasks are defined in a module (as opposed to a model) you may have to restart the workers.</div><div class=""> </div><div class=""> </div><div class="insert">+##### Parameters</div><div class="insert">+The first argument of the ``Scheduler`` class must be the database to be used by the scheduler to communicate with the workers. This can be the ``db`` of the app or another dedicated ``db``, perhaps one shared by multiple apps. If you use SQLite it&#x27;s recommended to use a separate db from the one used by your app in order to keep the app responsive.</div><div class="insert">+Once the tasks are defined and the ``Scheduler`` is instantiated, all that is needed to do is to start the workers. You can do that in several ways:</div><div class=""> </div><div class=""> ``</div><div class=""> python web2py.py -K myapp</div><div class=""> ``</div><div class="insert">+starts a worker for the app ``myapp``. If you want start multiple workers for the same app, you can do so just passing ``myapp,myapp``. You can pass also the ``group_names`` (overriding the one set in your model) with</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+python web2py.py -K myapp:group1:group2,myotherapp:group1</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+If you have a model called ``scheduler.py`` you can start/stop the workers from web2py&#x27;s default window (the one you use to set the ip address and the port).</div><div class="insert">+</div><div class="insert">+One last nice addition: if you use the embedded webserver, you can start the webserver and the scheduler with just one line of code (this assumes you don&#x27;t want the web2py window popping up, or you can use the &quot;Schedulers&quot; menu instead)</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+python web2py.py -a yourpass -K myapp -X</div><div class="insert">+``</div><div class="insert">+You can pass the usual parameters (-i, -p, here -a prevents the window from showing up), pass whatever app in the -K parameter and append a -X. The scheduler will run alongside the webserver!</div><div class="insert">+</div><div class="insert">+Scheduler&#x27;s complete signature is:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+Scheduler(</div><div class="insert">+    db,</div><div class="insert">+    tasks=None,</div><div class="insert">+    migrate=True,</div><div class="insert">+    worker_name=None,</div><div class="insert">+    group_names=None,</div><div class="insert">+    heartbeat=HEARTBEAT,</div><div class="insert">+    max_empty_runs=0,</div><div class="insert">+    discard_results=False,</div><div class="insert">+    utc_time=False</div><div class="insert">+)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Let&#x27;s see them in order:</div><div class="insert">+</div><div class="insert">+- ``db`` is the database DAL instance were you want the scheduler tables be placed.</div><div class="insert">+- ``tasks`` can be a dict. Must be defined if you want to call a function not by his name, i.e. ``tasks=dict(mynameddemo1=demo1)`` will let you execute function demo1 with ``st.insert(task_name=&#x27;mytask&#x27;, function_name=&#x27;mynameddemo1&#x27;)`` or ``st.insert(task_name=&#x27;mytask&#x27;, function_name=&#x27;demo1&#x27;)``. If you don&#x27;t pass this parameter, function will be searched in the app environment.</div><div class="insert">+- ``worker_name`` is None by default. As soon as the worker is started, a worker name is generated as hostname-uuid. If you want to specify that, be sure that it&#x27;s unique.</div><div class="insert">+- ``group_names`` is by default set to **[main]**. All tasks have a ``group_name`` parameter, set to **main** by default. Workers can only pick up tasks of their assigned group.</div><div class="insert">+NB: This is useful if you have different workers instances (e.g. on different machines) and you want to assign tasks to a specific worker.</div><div class="insert">+NB2: It&#x27;s possible to assign a worker more groups, and they can be also all the same, as</div><div class="insert">+``[&#x27;mygroup&#x27;,&#x27;mygroup&#x27;]``. Tasks will be distributed taking into consideration that</div><div class="insert">+a worker with group_names ``[&#x27;mygroup&#x27;,&#x27;mygroup&#x27;]`` is able to process the double of the tasks</div><div class="insert">+a worker with group_names ``[&#x27;mygroup&#x27;]`` is.</div><div class="insert">+- ``heartbeat`` is by default set to 3 seconds. This parameter is the one controlling how often a scheduler will check its status on the ``scheduler_worker`` table and see if there are any **ASSIGNED** tasks to itself to process.</div><div class="insert">+- ``max_empty_runs`` is 0 by default, that means that the worker will continue to process tasks as soon as they are **ASSIGNED**. If you set this to a value of, let&#x27;s say, 10, a worker will die automatically if it&#x27;s **ACTIVE** and no tasks are **ASSIGNED** to it for 10 loops. A loop is when a worker searches for tasks, every 3 seconds (or the set ``heartbeat``)</div><div class="insert">+- ``discard_results`` is False by default. If set to True, no scheduler_run records will be created.</div><div class="insert">+NB: scheduler_run records will be created as before for **FAILED**, **TIMEOUT** and</div><div class="insert">+**STOPPED** tasks&#x27;s statuses.</div><div class="insert">+- ``utc_time`` is False by default. If you need to coordinate with workers living in different timezones, or don&#x27;t have problems with solar/DST times, supplying datetimes from different countries, etc, you can set this to True. The scheduler will honour the UTC time and work leaving the local time aside. Caveat: you need to schedule tasks with UTC times (for start_time, stop_time, and so on.)</div><div class=""> </div><div class="insert"><span class="highlight">Now we have t</span>he <span class="highlight">infrastructure</span> <span class="highlight">in place: defined the tasks, t</span>o<span class="highlight">ld </span>t<span class="highlight">he scheduler ab</span>o<span class="highlight">ut them,</span> start<span class="highlight">ed</span> <span class="highlight">the</span> worker<span class="highlight">(s)</span>. <span class="highlight">W</span>h<span class="highlight"></span>a<span class="highlight"></span>t <span class="highlight">r</span>e<span class="highlight">ma</span>i<span class="highlight"></span>n<span class="highlight">s</span> is <span class="highlight"></span>t<span class="highlight"></span>o<span class="highlight"></span> a<span class="highlight">ctu</span>a<span class="highlight">lly</span> s<span class="highlight">ch</span>ed<span class="highlight">ul</span>e the <span class="highlight"></span>ta<span class="highlight">s</span>k<span class="highlight"></span>s<span class="highlight"></span></div><div class=""> </div><div class=""> </div><div class="insert">+##### Tasks</div><div class=""> Tasks can be scheduled programmatically or via appadmin. In fact, a task is scheduled simply by adding an entry in the table &quot;scheduler_task&quot;, which you can access via appadmin:</div><div class=""> </div><div class=""> ``</div><div class="insert">http://127.0.0.1:8000/<span class="highlight">myapp</span>/appadmin/insert/db/scheduler_task</div><div class=""> ``</div><div class=""> </div><div class=""> The meaning of the fields in this table is obvious. The &quot;args&quot; and &quot;vars&quot;&quot; fields are the values to be passed to the task in JSON format. In the case of the &quot;task_add&quot; above, an example of &quot;args&quot; and &quot;vars&quot; could be:</div><div class=""> </div><div class=""> ``</div><div class=""> args = [3, 4]</div><div class=""> vars = {}</div><div class=""> ``</div><div class=""> </div><div class=""> or</div><div class=""> </div><div class=""> ``</div><div class=""> args = []</div><div class=""> vars = {&#x27;a&#x27;:3, &#x27;b&#x27;:4}</div><div class=""> ``</div><div class=""> </div><div class="insert">+The ``scheduler_task`` table is the one where tasks are organized.</div><div class="insert">+</div><div class="insert">+All tasks follow a lifecycle</div><div class="insert">+</div><div class="insert">+[[scheduler tasks http://yuml.me/ce8edcc3.jpg center]]</div><div class="insert">+</div><div class="insert">+Let&#x27;s go with order. By default, when you send a task to the scheduler, you&#x27;ll want that to be executed. It&#x27;s in **QUEUED** status.</div><div class="insert">+If you need it to be executed later, use the ``start_time`` parameter (default = now).</div><div class="insert">+If for some reason you need to be sure that the task don&#x27;t get executed after a certain point in time (maybe a request to a webservice</div><div class="insert">+that shuts down at 1AM, a mail that needs to be sent not after the working hours, etc...) you can set a ``stop_time`` (default = None) for it.</div><div class="insert">+If your task is NOT picked up by a worker before stop_time, it will be set as **EXPIRED**.</div><div class="insert">+Tasks with no stop_time set or picked up **BEFORE** stop_time are **ASSIGNED** to a worker. When a workers picks up them, they become **RUNNING**.</div><div class="insert">+**RUNNING** tasks may end up:</div><div class="insert">+- **TIMEOUT** when more than n seconds passed with ``timeout`` parameter (default = 60 seconds)</div><div class="insert">+- **FAILED** when an exception is detected</div><div class="insert">+- **COMPLETED** when all went ok</div><div class="insert">+</div><div class="insert">+Additionally, you can control how many times a task should be repeated (i.e. you need to aggregate some data at specified intervals). To do so, set the ``repeats``</div><div class="insert">+parameter (default = 1 time only, 0 = unlimited). You can influence how many seconds should pass between executions with the ``period`` parameter (default = 60 seconds).</div><div class="insert">+NB: the time is not calculated between the END of the first round and the START of the next, but from the START time of the first round to the START time of the next cycle)</div><div class="insert">+</div><div class="insert">+Another nice addition, you can set how many times the function can raise an exception (i.e. requesting data from a sloooow webservice) and be queued again instead of stopping in **FAILED**  status with the parameter ``retry_failed`` (default = 0, -1 = unlimited).</div><div class="insert">+</div><div class="insert">+[[task repeats http://yuml.me/7d8b85e4.jpg center]]</div><div class="insert">+</div><div class="insert">+Summary: you have</div><div class="insert">+- ``period`` and ``repeats`` to get an automatically rescheduled function</div><div class="insert">+- ``timeout`` to be sure that a function doesn&#x27;t exceed a certain amount of time</div><div class="insert">+- ``retry_failed`` to control how many times the task can &quot;fail&quot;</div><div class="insert">+- ``start_time`` and ``stop_time`` to schedule a function in a restricted timeframe</div><div class="insert">+</div><div class="insert">+</div><div class="insert">+##### Reporting percentages</div><div class="insert">+</div><div class="insert">+A special &quot;word&quot; encountered in the print statements of your functions clear all</div><div class="insert">+the previous output. That word is ``!clear!``.</div><div class="insert">+This, coupled with the ``sync_output`` parameter, allows to report percentages</div><div class="insert">+a breeze. Let&#x27;s see how that works:</div><div class=""> </div><div class=""> ``</div><div class="insert">+def repoting_percentages():</div><div class="insert">+    time.sleep(5)</div><div class="insert">+    print &#x27;50%&#x27;</div><div class="insert">+    time.sleep(5)</div><div class="insert">+    print &#x27;!clear!100%&#x27;</div><div class="insert">+    return 1</div><div class=""> ``</div><div class=""> </div><div class="insert">+The function ``demo6`` sleeps for 5 seconds, outputs ``50%``.</div><div class="insert">+Then, it sleeps other 5 seconds and outputs ``100%``. Note that the output in the scheduler_run table is synced every 2 seconds and that the second print statement that contains ``!clear!100%`` gets the ``50%`` output cleared and replaced by ``100%`` only.</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+st.validate_and_insert(task_name=&#x27;percentages&#x27;, function_name=&#x27;demo6&#x27;, sync_output=2)</div><div class="insert">+``</div><div class=""> </div><div class="insert">+##### Results and output</div><div class="insert">+The table &quot;scheduler_run&quot; stores the status of all running tasks. Each record references a task that has been picked up by a worker.  One task can have multiple runs. For example, a task scheduled to repeat 10 times an hour will probably have 10 runs (unless one fails or they take longer than 1 hour). Beware that if the task has no return values, it is removed from the scheduler_run table as soon as it is finished.</div><div class=""> </div><div class=""> Possible run statuses are:</div><div class=""> </div><div class=""> ``</div><div class=""> RUNNING, COMPLETED, FAILED, TIMEOUT</div><div class=""> ``</div><div class=""> </div><div class=""> If the run is completed, no exceptions are thrown, and there is no task timeout, the run is marked as ``COMPLETED`` and the task is marked as ``QUEUED`` or ``COMPLETED`` depending on whether it is supposed to run again at a later time. The output of the task is serialized in JSON and stored in the run record.</div><div class=""> </div><div class=""> When a ``RUNNING`` task throws an exception, the run is mark as ``FAILED`` and the task is marked as ``FAILED``. The traceback is stored in the run record.</div><div class=""> </div><div class=""> Similarly, when a run exceeds the timeout, it is stopped and marked as ``TIMEOUT``, and the task is marked as ``TIMEOUT``.</div><div class=""> </div><div class=""> In any case, the stdout is captured and also logged into the run record.</div><div class=""> </div><div class=""> Using appadmin, one can check all ``RUNNING`` tasks, the output of ``COMPLETED`` tasks, the error of ``FAILED`` tasks, etc.</div><div class=""> </div><div class=""> The scheduler also creates one more table called &quot;scheduler_worker&quot;, which stores the workers&#x27; heartbeat and their status. Possible worker statuses are:</div><div class=""> </div><div class="insert">+##### Managing processes</div><div class="insert">+Worker fine management is hard. This module tries not to leave behind any platform (Mac, Win, Linux) .</div><div class="insert">+</div><div class="insert">+When you start a worker, you may want later to:</div><div class="insert">+- kill it &quot;no matter what its doing&quot;</div><div class="insert">+- kill it only if its not processing tasks</div><div class="insert">+- put it to sleep</div><div class="insert">+Maybe you have yet some tasks queued, and you want to save some resources.</div><div class="insert">+You know you want them processed every hour, so, you&#x27;ll want to:</div><div class="insert">+- process all queued tasks and die automatically</div><div class="insert">+All of these things are possible managing ``Scheduler`` parameters or the ``scheduler_worker`` table.</div><div class="insert">+To be more precise, for started workers you will change the ``status`` value of any worker to influence</div><div class="insert">+its behaviour.</div><div class="insert">+As tasks, workers can be in some fixed statuses : ACTIVE, DISABLED, TERMINATE or KILLED.</div><div class="insert">+</div><div class="insert">+**ACTIVE** and **DISABLED** are &quot;persistent&quot;, while **TERMINATE** or **KILL**, as statuses</div><div class="insert">+name suggest, are more &quot;commands&quot; than real statuses.</div><div class="insert">+Hitting ctrl+c is equal to set a worker to **KILL**</div><div class=""> </div><div class="insert"><span class="highlight">[[</span>worker<span class="highlight"></span>s status<span class="highlight">es</span> <span class="highlight">http://y</span>u<span class="highlight">ml.me/bd891eed.jp</span>g <span class="highlight">ce</span>n<span class="highlight">ter]]</span></div><div class=""> </div><div class=""> Everything that one can do via appadmin one can do programmatically by inserting and updating records in these tables.</div><div class=""> </div><div class="insert">Anyway, one should not update records relative to ``RUNNING`` tasks as this may create an un-expected behavior. The best practice is to queue tasks using &quot;<span class="highlight">validate_and_</span>insert&quot;. For example:</div><div class=""> </div><div class=""> ``</div><div class="insert"><span class="highlight">db.scheduler_</span>task<span class="highlight">.</span>_<span class="highlight">validate_a</span>n<span class="highlight">d_ins</span>e<span class="highlight"></span>r<span class="highlight"></span>t<span class="highlight">(</span></div><div class="">     function_name=&#x27;task_add&#x27;,</div><div class="">     args=&#x27;[]&#x27;,</div><div class="">     vars=&quot;{&#x27;a&#x27;:3,&#x27;b&#x27;:4}&quot;,</div><div class="">     repeats = 10, # run 10 times</div><div class="">     period = 3600, # every 1h</div><div class="insert">    timeout = <span class="highlight">12</span>0, # should take less than <span class="highlight">12</span>0 seconds</div><div class="">     )</div><div class=""> ``:code</div><div class=""> </div><div class=""> Notice that fields &quot;times_run&quot;, &quot;last_run_time&quot; and &quot;assigned_worker_name&quot; are not provided at schedule time but are filled automatically by the workers.</div><div class=""> </div><div class=""> You can also retrieve the output of completed tasks:</div><div class=""> </div><div class=""> ``</div><div class=""> completed_runs = db(db.scheduler_run.status=&#x27;COMPLETED&#x27;).select()</div><div class=""> ``:code</div><div class=""> </div><div class=""> ------</div><div class=""> The scheduler is experimental because it needs more extensive testing and because the table structure may change as more features are added.</div><div class=""> ------</div><div class=""> </div></div></div>
    <div class="span6"><div class="diff"><div class=""> Options:</div><div class="">   --version             show program&#x27;s version number and exit</div><div class="">   -h, --help            show this help message and exit</div><div class="">   -i IP, --ip=IP        ip address of the server (127.0.0.1)</div><div class="">   -p PORT, --port=PORT  port of server (8000)</div><div class="">   -a PASSWORD, --password=PASSWORD</div><div class="">                         password to be used for administration (use -a</div><div class="">                         &quot;&lt;recycle&gt;&quot; to reuse the last password))</div><div class="">   -c SSL_CERTIFICATE, --ssl_certificate=SSL_CERTIFICATE</div><div class="">                         file that contains ssl certificate</div><div class="">   -k SSL_PRIVATE_KEY, --ssl_private_key=SSL_PRIVATE_KEY</div><div class="">                         file that contains ssl private key</div><div class="">   -d PID_FILENAME, --pid_filename=PID_FILENAME</div><div class="">                         file to store the pid of the server</div><div class="">   -l LOG_FILENAME, --log_filename=LOG_FILENAME</div><div class="">                         file to log connections</div><div class="">   -n NUMTHREADS, --numthreads=NUMTHREADS</div><div class="">                         number of threads (deprecated)</div><div class="">   --minthreads=MINTHREADS</div><div class="">                         minimum number of server threads</div><div class="">   --maxthreads=MAXTHREADS</div><div class="">                         maximum number of server threads</div><div class="">   -s SERVER_NAME, --server_name=SERVER_NAME</div><div class="">                         server name for the web server</div><div class="">   -q REQUEST_QUEUE_SIZE, --request_queue_size=REQUEST_QUEUE_SIZE</div><div class="">                         max number of queued requests when server unavailable</div><div class="">   -o TIMEOUT, --timeout=TIMEOUT</div><div class="">                         timeout for individual request (10 seconds)</div><div class="">   -z SHUTDOWN_TIMEOUT, --shutdown_timeout=SHUTDOWN_TIMEOUT</div><div class="">                         timeout on shutdown of server (5 seconds)</div><div class="">   -f FOLDER, --folder=FOLDER</div><div class="">                         folder from which to run web2py</div><div class="">   -v, --verbose         increase --test verbosity</div><div class="">   -Q, --quiet           disable all output</div><div class="">   -D DEBUGLEVEL, --debug=DEBUGLEVEL</div><div class="">                         set debug output level (0-100, 0 means all, 100 means</div><div class="">                         none; default is 30)</div><div class="">   -S APPNAME, --shell=APPNAME</div><div class="">                         run web2py in interactive shell or IPython (if</div><div class="">                         installed) with specified appname (if app does not</div><div class="">                         exist it will be created). APPNAME like a/c/f (c,f</div><div class="">                         optional)</div><div class="">   -B, --bpython         run web2py in interactive shell or bpython (if</div><div class="">                         installed) with specified appname (if app does not</div><div class="">                         exist it will be created).  Use combined with --shell</div><div class="">   -P, --plain           only use plain python shell; should be used with</div><div class="">                         --shell option</div><div class="">   -M, --import_models   auto import model files; default is False; should be</div><div class="">                         used with --shell option</div><div class="">   -R PYTHON_FILE, --run=PYTHON_FILE</div><div class="">                         run PYTHON_FILE in web2py environment; should be used</div><div class="">                         with --shell option</div><div class="">   -K SCHEDULER, --scheduler=SCHEDULER</div><div class="delete">-                        run scheduled tasks for the specified apps</div><div class="delete">-                        -K app1, app2, app3 requires a scheduler defined in the</div><div class="delete">-                        models of the respective apps</div><div class="">   -T TEST_PATH, --test=TEST_PATH</div><div class="">                         run doctests in web2py environment; TEST_PATH like</div><div class="">                         a/c/f (c,f optional)</div><div class="">   -W WINSERVICE, --winservice=WINSERVICE</div><div class="">                         -W install|start|stop as Windows service</div><div class="">   -C, --cron            trigger a cron run manually; usually invoked from a</div><div class="">                         system crontab</div><div class="">   --softcron            triggers the use of softcron</div><div class="">   -N, --no-cron         do not start cron automatically</div><div class="">   -J, --cronjob         identify cron-initiated command</div><div class="">   -L CONFIG, --config=CONFIG</div><div class="">                         config file</div><div class="">   -F PROFILER_FILENAME, --profiler=PROFILER_FILENAME</div><div class="">                         profiler filename</div><div class="">   -t, --taskbar         use web2py gui and run in taskbar (system tray)</div><div class="">   --nogui               text-only, no GUI</div><div class="">   -A ARGS, --args=ARGS  should be followed by a list of arguments to be passed</div><div class="">                         to script, to be used with -S, -A must be the last</div><div class="">                         option</div><div class="">   --no-banner           Do not print header banner</div><div class="">   --interfaces=INTERFACES</div><div class="delete">-                        listen on multiple addresses:</div><div class="delete">-                        &quot;ip:port:cert:key;ip2:port2:cert2:key2;...&quot; (:cert:key</div><div class="">                         optional; no spaces)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Lower-case options are used to configure the web server. The ``-L`` option tells web2py to read configuration options from a file, ``-W`` installs web2py as a windows service, while ``-S``, ``-P`` and ``-M`` options start an interactive Python shell. The ``-T`` option finds and runs controller doctests in a web2py execution environment. For example, the following example runs doctests from all controllers in the &quot;welcome&quot; application:</div><div class=""> ``</div><div class=""> python web2py.py -vT welcome</div><div class=""> ``:code</div><div class=""> </div><div class=""> if you run web2py as Windows Service, ``-W``,  it is not convenient to pass the configuration using command line arguments. For this reason, in the web2py folder there is a sample &quot;options_std.py&quot; configuration file for the internal web server:</div><div class=""> </div><div class=""> ``</div><div class=""> import socket</div><div class=""> import os</div><div class=""> </div><div class=""> ip = &#x27;0.0.0.0&#x27;</div><div class=""> port = 80</div><div class=""> interfaces=[(&#x27;0.0.0.0&#x27;,80)]</div><div class=""> #interfaces.append((&#x27;0.0.0.0&#x27;,443,&#x27;ssl_private_key.pem&#x27;,&#x27;ssl_certificate.pem&#x27;))</div><div class=""> password = &#x27;&lt;recycle&gt;&#x27;  # ## &lt;recycle&gt; means use the previous password</div><div class=""> pid_filename = &#x27;httpserver.pid&#x27;</div><div class=""> log_filename = &#x27;httpserver.log&#x27;</div><div class=""> gluon/contrib/__init__.py</div><div class=""> gluon/contrib/feedparser.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> **markdown2**``markdown2``:cite  by Trent Mick for wiki markup:</div><div class=""> ``</div><div class=""> gluon/contrib/markdown/__init__.py</div><div class=""> gluon/contrib/markdown/markdown2.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> **markmin** markup:</div><div class=""> ``</div><div class=""> gluon/contrib/markmin.py</div><div class=""> ``:code</div><div class=""> </div><div class=""> **fpdf** created my Mariano Reingart for generating PDF documents:</div><div class=""> ``</div><div class=""> gluon/contrib/fpdf</div><div class=""> ``</div><div class=""> This is not documented in this book but it is hosted and documented here:</div><div class=""> ``</div><div class="delete">http://code.google.com/p/<span class="highlight">py</span>fpdf/</div><div class=""> ``</div><div class=""> </div><div class=""> **pysimplesoap** is a lightweight SOAP server implementation created by Mariano Reingart:</div><div class=""> </div><div class=""> ``</div><div class=""> gluon/contrib/pysimplesoap/</div><div class=""> ``:code</div><div class=""> </div><div class=""> **simplejsonrpc** is a lightweight JSON-RPC client also created by Mariano Reingart: ``jsonrpc``:inxx</div><div class=""> </div><div class=""> ``</div><div class=""> gluon/contrib/simplejsonrpc.py</div><div class=""> ``</div><div class=""> </div><div class=""> **memcache**``memcache``:cite  Python API by Evan Martin:</div><div class=""> ``</div><div class=""> gluon/contrib/memcache/__init__.py</div><div class=""> gluon/contrib/memcache/memcache.py</div><div class=""> ``</div><div class=""> </div><div class=""> Example of line to add to the system crontab, (usually /etc/crontab):</div><div class=""> </div><div class=""> If you are running external cron, make sure you add the -N command line parameter to your web2py startup script or config so there is no collision of multiple types of cron.  Also, with external ``cron``, make sure to add either ``-J`` (or ``--cronjob``, which is the same) as indicated above so that web2py knows that task is executed by cron. Web2py sets this internally with soft and hard ``cron``.</div><div class=""> </div><div class=""> In cases where you do not need any cron functionality within a particular process, you can use the -N command line parameter to disable it. Note that this might disable some maintenance tasks (like the automatic cleaning of session folders). The most common use of this function is when you:</div><div class=""> - have already set up external cron triggered from the system (most common with WSGI setup).</div><div class=""> - want to debug your application without cron interfering either with actions or with output.</div><div class=""> </div><div class=""> #### Homemade task queues</div><div class=""> </div><div class=""> While cron is useful to run tasks at regular time intervals, it is not always the best solution to run a background task. For this purpose web2py provides the ability to run any python script as if it were inside a controller:</div><div class=""> ``</div><div class=""> python web2py.py -S app -M -N -R applications/app/private/myscript.py -A a b c</div><div class=""> ``:code</div><div class=""> </div><div class=""> where ``-S app`` tells web2py to run &quot;myscript.py&quot; as &quot;app&quot;, ``-M`` tells web2py to execute models, ``-N`` tells web2py not to run cron, and ``-A a b c`` passes optional command line arguments ``sys.args=[&#x27;a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;]`` to &quot;myscript.py&quot;.</div><div class=""> </div><div class=""> This type of background process should not be executed via cron (except perhaps for cron @reboot) because you need to be sure that no more than one instance is running at the same time. With cron it is possible that a process starts at cron iteration 1 and is not completed by cron iteration 2, so cron starts it again, and again, and again - thus jamming the mail server.</div><div class=""> </div><div class=""> In chapter 8, we will provide an example of how to use the above method to send emails.</div><div class=""> </div><div class=""> #### Scheduler (experimental)</div><div class=""> </div><div class=""> The web2py scheduler works very much like the task queue described in the previous sub-section with some differences:</div><div class=""> - It provides a standard mechanism for creating and scheduling tasks.</div><div class=""> - There is not a single background process but a set of workers processes.</div><div class=""> - The job of worker nodes can be monitored because their state, as well as the state of the tasks, is stored in the database.</div><div class=""> - It works without web2py but that is not documented here.</div><div class=""> </div><div class=""> The scheduler does not use cron, although one can use cron @reboot to start the worker nodes.</div><div class=""> </div><div class=""> In the scheduler, a task is simply a function defined in a model (or in a module and imported by a model). For example:</div><div class=""> </div><div class=""> ``</div><div class=""> def task_add(a,b):</div><div class="">     return a+b</div><div class=""> ``:code</div><div class=""> </div><div class=""> Tasks will always be called in the same environment seen by controllers and therefore they see all the global variables defined in models, including database connections (``db``). Tasks differ from a controller action because they are not associated with an HTTP request and therefore there is no ``request.env``.</div><div class=""> </div><div class="delete">-Once the tasks are defined, you need to enable the scheduler by adding the following code to your model:</div><div class=""> </div><div class=""> ``</div><div class="delete">-myscheduler = Scheduler(db, dict(task_add=task_add))</div><div class=""> ``</div><div class=""> </div><div class="delete">-The first argument of the ``Scheduler`` class must be the database to be used by the scheduler to communicate with the workers. This can be the ``db`` of the app or another dedicated ``db``, perhaps one shared by multiple apps. The Scheduler creates the tables it needs. The second argument is a Python dictionary of ``key:value`` pairs where ``key`` is the name you want to use to expose a task, and ``value`` is the actual name of the function that defines the task.</div><div class=""> </div><div class="delete">-Once the tasks are defined and the ``Scheduler`` is instantiated, all that is needed to do is to start the workers:</div><div class=""> </div><div class=""> ``</div><div class=""> python web2py.py -K myapp</div><div class=""> ``</div><div class=""> </div><div class="delete"><span class="highlight">T</span>he <span class="highlight">``-K``</span> <span class="highlight"></span>o<span class="highlight">p</span>t<span class="highlight">i</span>o<span class="highlight">n</span> start<span class="highlight">s</span> <span class="highlight">a</span> worker<span class="highlight"></span>. <span class="highlight">T</span>h<span class="highlight">e </span>a<span class="highlight">rgumen</span>t <span class="highlight">of th</span>e<span class="highlight"> ``-K`` opt</span>i<span class="highlight">o</span>n<span class="highlight"></span> is <span class="highlight">a lis</span>t<span class="highlight"> </span>o<span class="highlight">f</span> a<span class="highlight">pp n</span>a<span class="highlight">mes,</span> s<span class="highlight">eparat</span>ed<span class="highlight"> by commas. These ar</span>e the <span class="highlight">apps that will be served by this worker. One can s</span>ta<span class="highlight">rt many wor</span>k<span class="highlight">er</span>s<span class="highlight">.</span></div><div class=""> </div><div class="delete">-Now we have the infrastructure in place: defined the tasks, told the scheduler about them, started the worker(s). What remains is to actually schedule the tasks:</div><div class=""> </div><div class=""> Tasks can be scheduled programmatically or via appadmin. In fact, a task is scheduled simply by adding an entry in the table &quot;scheduler_task&quot;, which you can access via appadmin:</div><div class=""> </div><div class=""> ``</div><div class="delete">http://127.0.0.1:8000/<span class="highlight">scheduler</span>/appadmin/insert/db/scheduler_task</div><div class=""> ``</div><div class=""> </div><div class=""> The meaning of the fields in this table is obvious. The &quot;args&quot; and &quot;vars&quot;&quot; fields are the values to be passed to the task in JSON format. In the case of the &quot;task_add&quot; above, an example of &quot;args&quot; and &quot;vars&quot; could be:</div><div class=""> </div><div class=""> ``</div><div class=""> args = [3, 4]</div><div class=""> vars = {}</div><div class=""> ``</div><div class=""> </div><div class=""> or</div><div class=""> </div><div class=""> ``</div><div class=""> args = []</div><div class=""> vars = {&#x27;a&#x27;:3, &#x27;b&#x27;:4}</div><div class=""> ``</div><div class=""> </div><div class="delete">-A task can be in one of the following states:</div><div class=""> </div><div class=""> ``</div><div class="delete">-QUEUED, RUNNING, COMPLETED, FAILED, TIMEOUT</div><div class=""> ``</div><div class=""> </div><div class="delete">-Once a task exists (there is a record in the &quot;scheduler_task&quot; table), is ``QUEUED``, and is ready (meets all the conditions specified in the record), it can be picked up by a worker. As soon as a worker is available, it picks the first ready task scheduled to run. The worker creates an entry in a another table, &quot;scheduler_run&quot; (also created by the scheduler).</div><div class=""> </div><div class="delete">-The table &quot;scheduler_run&quot; stores the status of all running tasks. Each record references a task that has been picked up by a worker.  One task can have multiple runs. For example, a task scheduled to repeat 10 times an hour will probably have 10 runs (unless one fails or they take longer than 1 hour).</div><div class=""> </div><div class=""> Possible run statuses are:</div><div class=""> </div><div class=""> ``</div><div class=""> RUNNING, COMPLETED, FAILED, TIMEOUT</div><div class=""> ``</div><div class=""> </div><div class="delete">-When a ``QUEUED`` task is picked up, it becomes a ``RUNNING`` task and its run status is also ``RUNNING``.</div><div class=""> If the run is completed, no exceptions are thrown, and there is no task timeout, the run is marked as ``COMPLETED`` and the task is marked as ``QUEUED`` or ``COMPLETED`` depending on whether it is supposed to run again at a later time. The output of the task is serialized in JSON and stored in the run record.</div><div class=""> </div><div class=""> When a ``RUNNING`` task throws an exception, the run is mark as ``FAILED`` and the task is marked as ``FAILED``. The traceback is stored in the run record.</div><div class=""> </div><div class=""> Similarly, when a run exceeds the timeout, it is stopped and marked as ``TIMEOUT``, and the task is marked as ``TIMEOUT``.</div><div class=""> </div><div class=""> In any case, the stdout is captured and also logged into the run record.</div><div class=""> </div><div class=""> Using appadmin, one can check all ``RUNNING`` tasks, the output of ``COMPLETED`` tasks, the error of ``FAILED`` tasks, etc.</div><div class=""> </div><div class=""> The scheduler also creates one more table called &quot;scheduler_worker&quot;, which stores the workers&#x27; heartbeat and their status. Possible worker statuses are:</div><div class=""> </div><div class="delete">-``</div><div class="delete">-ACTIVE, INACTIVE, DISABLED</div><div class="delete">-``</div><div class=""> </div><div class="delete"><span class="highlight">You can disable a </span>worker<span class="highlight"> by changing it</span>s status<span class="highlight"></span> <span class="highlight"></span>u<span class="highlight">sin</span>g <span class="highlight">appadmi</span>n<span class="highlight">.</span></div><div class=""> </div><div class=""> Everything that one can do via appadmin one can do programmatically by inserting and updating records in these tables.</div><div class=""> </div><div class="delete">Anyway, one should not update records relative to ``RUNNING`` tasks as this may create an un-expected behavior. The best practice is to queue tasks using &quot;<span class="highlight"></span>insert&quot;. For example:</div><div class=""> </div><div class=""> ``</div><div class="delete">-db.scheduler_task.insert(</div><div class="delete">-    status=&#x27;QUEUED&#x27;,</div><div class="delete">-    application_name=&#x27;myapp&#x27;,</div><div class="delete"><span class="highlight">    </span>task<span class="highlight"></span>_<span class="highlight"></span>n<span class="highlight">am</span>e<span class="highlight">=&#x27;my fi</span>r<span class="highlight">s</span>t<span class="highlight"> task&#x27;,</span></div><div class="">     function_name=&#x27;task_add&#x27;,</div><div class="">     args=&#x27;[]&#x27;,</div><div class="">     vars=&quot;{&#x27;a&#x27;:3,&#x27;b&#x27;:4}&quot;,</div><div class="delete">-    enabled=True,</div><div class="delete">-    start_time = request.now,</div><div class="delete">-    stop_time = request.now+datetime.timedelta(days=1),</div><div class="">     repeats = 10, # run 10 times</div><div class="">     period = 3600, # every 1h</div><div class="delete">    timeout = <span class="highlight">6</span>0, # should take less than <span class="highlight">6</span>0 seconds</div><div class="">     )</div><div class=""> ``:code</div><div class=""> </div><div class=""> Notice that fields &quot;times_run&quot;, &quot;last_run_time&quot; and &quot;assigned_worker_name&quot; are not provided at schedule time but are filled automatically by the workers.</div><div class=""> </div><div class=""> You can also retrieve the output of completed tasks:</div><div class=""> </div><div class=""> ``</div><div class=""> completed_runs = db(db.scheduler_run.status=&#x27;COMPLETED&#x27;).select()</div><div class=""> ``:code</div><div class=""> </div><div class=""> ------</div><div class=""> The scheduler is experimental because it needs more extensive testing and because the table structure may change as more features are added.</div><div class=""> ------</div><div class=""> </div><div class="delete">-- We recommend having a separate model file for definindg the tasks and instantiate ``Scheduler`` (after te tasks are defined).</div><div class="delete">-- We recommend that use at least one worker per application so that you have more control, although that is not strictly necessary.</div><div class="delete">-- If your tasks are defined in a module (as opposed to a model) you may have to restart the workers.</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/a1af38f67ad075e98bd13ffcfb36a0a6dcb3aa32">a1af38f</a><ul><li>Date : 2012-09-03</li><li>added description of WebClient</li></ul></li></ul>
<div class="row-fluid" id="com_a1af38f67ad075e98bd13ffcfb36a0a6dcb3aa32">
    <div class="span6"><div class="diff"><div class="insert">**<span class="highlight"></span>fpdf** created my Mariano Reingart for generating PDF documents:</div><div class=""> ``</div><div class="insert">gluon/contrib/<span class="highlight"></span>fpdf</div><div class=""> ``</div><div class=""> This is not documented in this book but it is hosted and documented here:</div><div class=""> ``</div><div class=""> http://code.google.com/p/pyfpdf/</div><div class=""> ``</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">**<span class="highlight">py</span>fpdf** created my Mariano Reingart for generating PDF documents:</div><div class=""> ``</div><div class="delete">gluon/contrib/<span class="highlight">py</span>fpdf</div><div class=""> ``</div><div class=""> This is not documented in this book but it is hosted and documented here:</div><div class=""> ``</div><div class=""> http://code.google.com/p/pyfpdf/</div><div class=""> ``</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/9e10b63ca42973fcccba175ef95076d74f292d1b">9e10b63</a><ul><li>Date : 2012-09-01</li><li>router patch, thanks Jonathan</li></ul></li></ul>
<div class="row-fluid" id="com_9e10b63ca42973fcccba175ef95076d74f292d1b">
    <div class="span6"><div class="diff"><div class="insert">+If the first section of the pattern (all but ``[path]``) is missing, web2py provides a default:</div><div class="insert">+``</div><div class="insert">+&#x27;.*?:https?://[^:/]+:[a-z]+&#x27;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+The entire expression is matched as a regular expression, so &quot;.&quot; must be escaped and any matching subexpression can be captured using ``(?P&lt;...&gt;...)`` using Python regex syntax. The request method (typically GET or POST) must be lower case. The URL being matched has had any ``%xx`` escapes unquoted.</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">-The entire expression is matched as a regular expression, so &quot;.&quot; must be escaped and any matching subexpression can be captured using ``(?P&lt;...&gt;...)`` using Python regex syntax. The request method (typically GET or POST) must be lower case.</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/ac4003f4349f9ee22c67309ceeb48de5539b0308">ac4003f</a><ul><li>Date : 2012-09-01</li><li>added lots of new features to book</li></ul></li></ul>
<div class="row-fluid" id="com_ac4003f4349f9ee22c67309ceeb48de5539b0308">
    <div class="span6"><div class="diff"><div class=""> ### ``response``</div><div class=""> ``response``:inxx</div><div class=""> ``response.body``:inxx</div><div class=""> ``response.cookies``:inxx</div><div class=""> ``response.download``:inxx</div><div class=""> ``response.files``:inxx</div><div class=""> ``response.flash``:inxx</div><div class=""> ``response.headers``:inxx</div><div class=""> ``response.meta``:inxx</div><div class=""> ``response.menu``:inxx</div><div class=""> ``response.postprocessing``:inxx</div><div class=""> ``response.render``:inxx</div><div class=""> ``response.status``:inxx</div><div class=""> ``response.stream``:inxx</div><div class=""> ``response.subtitle``:inxx</div><div class=""> ``response.title``:inxx</div><div class=""> ``response.toolbar``:inxx</div><div class=""> ``response.view``:inxx</div><div class="insert">+``response.delimiters``:inxx</div><div class=""> ``response.js``:inxx</div><div class=""> ``response.write``:inxx</div><div class=""> ``response.include_files``:inxx</div><div class=""> ``response.include_meta``:inxx</div><div class=""> ``response.optimize_css``:inxx</div><div class=""> ``response.optimize_js``:inxx</div><div class=""> </div><div class=""> ``response`` is another instance of the ``Storage`` class. It contains the following:</div><div class=""> </div><div class=""> ``response.body``: a ``StringIO`` object into which web2py writes the output page body. NEVER CHANGE THIS VARIABLE.</div><div class=""> </div><div class=""> ``response.cookies``: similar to ``request.cookies``, but while the latter contains the cookies sent from the client to the server, the former contains cookies sent by the server to the client. The session cookie is handled automatically.</div><div class=""> </div><div class=""> ``response.download(request, db)``: a method used to implement the controller function that allows downloading of uploaded files. ``request.download`` expects the last ``arg`` in ``request.args`` to be the encoded filename (i.e., the filename generated at upload time and stored in the upload field). It extracts the upload field name and table name as well as the original filename from the encoded filename. ``response.download`` takes two optional arguments: ``chunk_size`` sets the size in bytes for chunked streaming (defaults to 64K), and ``attachments`` determines whether the downloaded file should be treated as an attachment or not (default to ``True``). Note, ``response.download`` is specifically for downloading files associated with ``db`` upload fields. Use ``response.stream`` (see below) for other types of file downloads and streaming. Also, note that it is not necessary to use ``response.download`` to access files uploaded to the /static folder -- static files can (and generally should) be accessed directly via URL (e.g., /app/static/files/myfile.pdf).</div><div class=""> </div><div class="insert">``response.files``: a list of <span class="highlight">.css, .js, coffee, and .less</span> files required by the page. They will automatically be linked in the head of the standard &quot;layout.html&quot; via the included &quot;web2py_ajax.html&quot;. To include a new CSS<span class="highlight">,</span> JS<span class="highlight">, COFFEE, or LESS</span> file, just append it to this list. It will handle duplicates. The order is significant.</div><div class=""> </div><div class=""> ``response.include_files()`` generates html head tags to includes all ``response.files`` (used in &quot;views/web2py_ajax.html&quot;).</div><div class=""> </div><div class=""> ``response.flash``: optional parameter that may be included in the views. Normally used to notify the user about something that happened.</div><div class=""> </div><div class=""> ``response.headers``: a ``dict`` for HTTP response headers. Web2py sets some headers by default, including &quot;Content-Length&quot;, &quot;Content-Type&quot;, and &quot;X-Powered-By&quot; (set equal to web2py). Web2py also sets the &quot;Cache-Control&quot;, &quot;Expires&quot;, and &quot;Pragma&quot; headers to prevent client-side caching, except for static file requests, for which client-side caching is enabled. The headers that web2py sets can be overwritten or removed, and new headers can be added (e.g., ``response.headers[&#x27;Cache-Control&#x27;] = &#x27;private&#x27;``).</div><div class=""> </div><div class=""> ``response.menu``: optional parameter that may be included in the views, normally used to pass a navigation menu tree to the view. It can be rendered by the MENU helper.</div><div class=""> </div><div class="insert">+</div><div class=""> ``response.meta``: a storage object (like a dict) that contains optional meta information like ``response.meta.author``, ``.description``, and/or ``.keywords``. The content of each meta variable is automatically placed in the proper ``META`` tag by the code in &quot;views/web2py_ajax.html&quot;, which is included by default in &quot;views/layout.html&quot;.</div><div class=""> </div><div class=""> ``response.include_meta()`` generates a string that includes all ``response.meta`` headers serialized (used in &quot;views/web2py_ajax.html&quot;).</div><div class=""> </div><div class=""> ``response.postprocessing``: this is a list of functions, empty by default. These functions are used to filter the response object at the output of an action, before the output is rendered by the view. It can be used to implement support for other template languages.</div><div class=""> </div><div class=""> ``response.render(view, vars)``: a method used to call the view explicitly inside the controller. ``view`` is an optional parameter which is the name of the view file, ``vars`` is a dictionary of named values passed to the view.</div><div class=""> </div><div class=""> ``response.session_file``: file stream containing the session.</div><div class=""> </div><div class=""> ``response.session_file_name``: name of the file where the session will be saved.</div><div class=""> </div><div class=""> ``response.session_id``: the id of the current session. It is determined automatically. NEVER CHANGE THIS VARIABLE.</div><div class=""> </div><div class=""> ``response.session_id_name``: the name of the session cookie for this application. NEVER CHANGE THIS VARIABLE.</div><div class=""> </div><div class=""> ``response.status``: the HTTP status code integer to be passed to the response. Default is 200 (OK).</div><div class=""> </div><div class=""> ``response.stream(file, chunk_size, request=request)``: when a controller returns it, web2py streams the file content back to the client in blocks of size ``chunk_size``. The ``request`` parameter is required to use the chunk start in the HTTP header. As noted above, ``response.download`` should be used to retrieve files stored via an upload field. ``response.stream`` can be used in other cases, such as returning a temporary file or StringIO object created by the controller. Unlike ``response.download``, ``response.stream`` does not automatically set the Content-Disposition header, so you may need to do that manually (e.g., to specify download as an attachment, and to provide a filename). However, it does automatically set the ``Content-Type`` header (based on the filename extension).</div><div class=""> </div><div class=""> Also notice the ``request.env.wsgi_*`` variables. They are specific to the wsgi</div><div class=""> ``response.toolbar``: a function that allows you embed a toolbar into page form debugging purposes ``{{=response.toolbar()}}``. The toolbar displays request, response, session variables and database access time for each query.</div><div class=""> </div><div class=""> ``response._vars``: this variable is accessible only in a view, not in the action. It contains the value returned by the action to the view.</div><div class=""> </div><div class=""> ``response.optimize_css``: if can be set to &quot;concat,minify,inline&quot; to concatenate, minity and inline the CSS files included by web2py.</div><div class=""> </div><div class=""> ``response.optimize_js``: if can be set to &quot;concat,minify,inline&quot; to concatenate, minity and inline the CSS files included by web2py.</div><div class=""> </div><div class=""> ``response.view``: the name of the view template that must render the page. This is set by default to:</div><div class=""> ``</div><div class=""> &quot;%s/%s.%s&quot; % (request.controller, request.function, request.extension)</div><div class=""> ``:code</div><div class=""> </div><div class=""> or, if the above file cannot be located, to</div><div class=""> ``</div><div class=""> &quot;generic.%s&quot; % (request.extension)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Change the value of this variable to modify the view file associated with a particular action.</div><div class=""> </div><div class="insert">+``response.delimiters`` defaults to ``(&#x27;{{&#x27;,&#x27;}}&#x27;)``. It allows you to change the delimiter of code embedded in views.</div><div class="insert">+</div><div class=""> ``response.xmlrpc(request, methods)``: when a controller returns it, this function exposes the methods via XML-RPC``xmlrpc``:cite . This function is deprecated since a better mechanism is available and described in Chapter 10.</div><div class=""> </div><div class=""> ``response.write(text)``: a method to write text into the output page body.</div><div class=""> </div><div class=""> ``response.js`` can contain Javascript Code. This code will be executed if and only if the response is received by a web2py component as discussed in Chapter 12.</div><div class=""> </div><div class=""> Since ``response`` is a ``gluon.storage.Storage`` object, it can be used to store other attributes that you may want to pass to the view. While there is no technical restriction, our recommendation is to store only variables that are to be rendered by all pages in the overall layout (&quot;layout.html&quot;).</div><div class=""> </div><div class=""> Anyway, we strongly suggest to stick to the variables listed here:</div><div class=""> ``</div><div class=""> response.title</div><div class=""> response.subtitle</div><div class=""> response.flash</div><div class=""> response.menu</div><div class=""> response.meta.author</div><div class=""> response.meta.description</div><div class=""> response.meta.keywords</div><div class=""> response.meta.*</div><div class=""> ``:code</div><div class=""> </div><div class=""> This means that only ``HTTP`` can be used for cross-page control flow. Other exc</div><div class=""> The command:</div><div class=""> ``</div><div class=""> redirect(&#x27;http://www.web2py.com&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> is simply a shortcut for:</div><div class=""> ``</div><div class=""> raise HTTP(303,</div><div class="">            &#x27;You are being redirected &lt;a href=&quot;%s&quot;&gt;here&lt;/a&gt;&#x27; % location,</div><div class="">            Location=&#x27;http://www.web2py.com&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The named arguments of the ``HTTP`` initializer method are translated into HTTP header directives, in this case, the redirection target location. ``redirect`` takes an optional second argument, which is the HTTP status code for the redirection (303 by default). Change this number to 307 for a temporary redirect or to 301 for a permanent redirect.</div><div class=""> </div><div class=""> The most common way to use redirect is to redirect to other pages in the same app and (optionally) pass parameters:</div><div class=""> </div><div class=""> ``</div><div class=""> redirect(URL(&#x27;index&#x27;, args=(1,2,3), vars=dict(a=&#x27;b&#x27;)))</div><div class=""> ``:code</div><div class=""> </div><div class="insert">+In chapter 12 we discuss web2py components. They make Ajax requirest to web2py actions. If the called action performs a redirect, you may want the Ajax request to follow the redirect or you may want the entire page perfoming the Ajax request redirecting. In this latter case you can set:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+redirect(...,type=&#x27;auto&#x27;)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+</div><div class=""> ### ``T`` and Internationalization</div><div class=""> ``T``:inxx ``internationalization``:inxx</div><div class=""> </div><div class=""> The object ``T`` is the language translator. It constitutes a single global instance of the web2py class ``gluon.language.translator``. All string constants (and only string constants) should be marked by ``T``, for example:</div><div class=""> ``</div><div class=""> a = T(&quot;hello world&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Strings that are marked with ``T`` are identified by web2py as needing language translation and they will be translated when the code (in the model, controller, or view) is executed. If the string to be translated is not a constant but a variable, it will be added to the translation file at runtime (except on GAE) to be translated later.</div><div class=""> </div><div class=""> The ``T`` object can also contain interpolated variables and support multiple equivalent syntax:</div><div class=""> ``</div><div class=""> a = T(&quot;hello %s&quot;, (&#x27;Tim&#x27;,))</div><div class=""> a = T(&quot;hello %(name)s&quot;, dict(name=&#x27;Tim&#x27;))</div><div class=""> a = T(&quot;hello %s&quot;) % (&#x27;Tim&#x27;,)</div><div class=""> a = T(&quot;hello %(name)s&quot;) % dict(name=&#x27;Tim&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The latter syntax is recommended because it makes translation easier.</div><div class=""> The first string is translated according to the requested language file and the ``name`` variable is replaced independently of the language.</div><div class=""> routes_out = (</div><div class=""> With these routes, the URL:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/testme</div><div class=""> ``:code</div><div class=""> </div><div class=""> is mapped into:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/examples/default/index</div><div class=""> ``:code</div><div class=""> </div><div class=""> To the visitor, all links to</div><div class=""> the page URL looks like ``/testme``.</div><div class=""> </div><div class=""> The patterns have the same syntax as Python regular expressions. For example:</div><div class=""> ``</div><div class="">   (&#x27;.*\.php&#x27;, &#x27;/init/default/index&#x27;),</div><div class=""> ``:code</div><div class=""> </div><div class=""> maps all URLs ending in &quot;.php&quot; to the index page.</div><div class=""> </div><div class="insert">+The second term of a rule can also be a redirection to another page:</div><div class="insert">+``</div><div class="insert">+  (&#x27;.*\.php&#x27;, &#x27;303-&gt;http://example.com/newpage&#x27;),</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Here 303 is the HTTP code for the redirect response.</div><div class="insert">+</div><div class=""> Sometimes you want to get rid of the application prefix from the URLs because you plan to expose only one application. This can be achieved with:</div><div class=""> ``</div><div class=""> routes_in = (</div><div class="">   (&#x27;/(?P&lt;any&gt;.*)&#x27;, &#x27;/init/\g&lt;any&gt;&#x27;),</div><div class=""> )</div><div class=""> routes_out = (</div><div class="">   (&#x27;/init/(?P&lt;any&gt;.*)&#x27;, &#x27;/\g&lt;any&gt;&#x27;),</div><div class=""> )</div><div class=""> ``:code</div></div></div>
    <div class="span6"><div class="diff"><div class=""> ### ``response``</div><div class=""> ``response``:inxx</div><div class=""> ``response.body``:inxx</div><div class=""> ``response.cookies``:inxx</div><div class=""> ``response.download``:inxx</div><div class=""> ``response.files``:inxx</div><div class=""> ``response.flash``:inxx</div><div class=""> ``response.headers``:inxx</div><div class=""> ``response.meta``:inxx</div><div class=""> ``response.menu``:inxx</div><div class=""> ``response.postprocessing``:inxx</div><div class=""> ``response.render``:inxx</div><div class=""> ``response.status``:inxx</div><div class=""> ``response.stream``:inxx</div><div class=""> ``response.subtitle``:inxx</div><div class=""> ``response.title``:inxx</div><div class=""> ``response.toolbar``:inxx</div><div class=""> ``response.view``:inxx</div><div class=""> ``response.js``:inxx</div><div class=""> ``response.write``:inxx</div><div class=""> ``response.include_files``:inxx</div><div class=""> ``response.include_meta``:inxx</div><div class=""> ``response.optimize_css``:inxx</div><div class=""> ``response.optimize_js``:inxx</div><div class=""> </div><div class=""> ``response`` is another instance of the ``Storage`` class. It contains the following:</div><div class=""> </div><div class=""> ``response.body``: a ``StringIO`` object into which web2py writes the output page body. NEVER CHANGE THIS VARIABLE.</div><div class=""> </div><div class=""> ``response.cookies``: similar to ``request.cookies``, but while the latter contains the cookies sent from the client to the server, the former contains cookies sent by the server to the client. The session cookie is handled automatically.</div><div class=""> </div><div class=""> ``response.download(request, db)``: a method used to implement the controller function that allows downloading of uploaded files. ``request.download`` expects the last ``arg`` in ``request.args`` to be the encoded filename (i.e., the filename generated at upload time and stored in the upload field). It extracts the upload field name and table name as well as the original filename from the encoded filename. ``response.download`` takes two optional arguments: ``chunk_size`` sets the size in bytes for chunked streaming (defaults to 64K), and ``attachments`` determines whether the downloaded file should be treated as an attachment or not (default to ``True``). Note, ``response.download`` is specifically for downloading files associated with ``db`` upload fields. Use ``response.stream`` (see below) for other types of file downloads and streaming. Also, note that it is not necessary to use ``response.download`` to access files uploaded to the /static folder -- static files can (and generally should) be accessed directly via URL (e.g., /app/static/files/myfile.pdf).</div><div class=""> </div><div class="delete">``response.files``: a list of <span class="highlight">CSS and JS</span> files required by the page. They will automatically be linked in the head of the standard &quot;layout.html&quot; via the included &quot;web2py_ajax.html&quot;. To include a new CSS<span class="highlight"> or</span> JS<span class="highlight"></span> file, just append it to this list. It will handle duplicates. The order is significant.</div><div class=""> </div><div class=""> ``response.include_files()`` generates html head tags to includes all ``response.files`` (used in &quot;views/web2py_ajax.html&quot;).</div><div class=""> </div><div class=""> ``response.flash``: optional parameter that may be included in the views. Normally used to notify the user about something that happened.</div><div class=""> </div><div class=""> ``response.headers``: a ``dict`` for HTTP response headers. Web2py sets some headers by default, including &quot;Content-Length&quot;, &quot;Content-Type&quot;, and &quot;X-Powered-By&quot; (set equal to web2py). Web2py also sets the &quot;Cache-Control&quot;, &quot;Expires&quot;, and &quot;Pragma&quot; headers to prevent client-side caching, except for static file requests, for which client-side caching is enabled. The headers that web2py sets can be overwritten or removed, and new headers can be added (e.g., ``response.headers[&#x27;Cache-Control&#x27;] = &#x27;private&#x27;``).</div><div class=""> </div><div class=""> ``response.menu``: optional parameter that may be included in the views, normally used to pass a navigation menu tree to the view. It can be rendered by the MENU helper.</div><div class=""> </div><div class=""> ``response.meta``: a storage object (like a dict) that contains optional meta information like ``response.meta.author``, ``.description``, and/or ``.keywords``. The content of each meta variable is automatically placed in the proper ``META`` tag by the code in &quot;views/web2py_ajax.html&quot;, which is included by default in &quot;views/layout.html&quot;.</div><div class=""> </div><div class=""> ``response.include_meta()`` generates a string that includes all ``response.meta`` headers serialized (used in &quot;views/web2py_ajax.html&quot;).</div><div class=""> </div><div class=""> ``response.postprocessing``: this is a list of functions, empty by default. These functions are used to filter the response object at the output of an action, before the output is rendered by the view. It can be used to implement support for other template languages.</div><div class=""> </div><div class=""> ``response.render(view, vars)``: a method used to call the view explicitly inside the controller. ``view`` is an optional parameter which is the name of the view file, ``vars`` is a dictionary of named values passed to the view.</div><div class=""> </div><div class=""> ``response.session_file``: file stream containing the session.</div><div class=""> </div><div class=""> ``response.session_file_name``: name of the file where the session will be saved.</div><div class=""> </div><div class=""> ``response.session_id``: the id of the current session. It is determined automatically. NEVER CHANGE THIS VARIABLE.</div><div class=""> </div><div class=""> ``response.session_id_name``: the name of the session cookie for this application. NEVER CHANGE THIS VARIABLE.</div><div class=""> </div><div class=""> ``response.status``: the HTTP status code integer to be passed to the response. Default is 200 (OK).</div><div class=""> </div><div class=""> ``response.stream(file, chunk_size, request=request)``: when a controller returns it, web2py streams the file content back to the client in blocks of size ``chunk_size``. The ``request`` parameter is required to use the chunk start in the HTTP header. As noted above, ``response.download`` should be used to retrieve files stored via an upload field. ``response.stream`` can be used in other cases, such as returning a temporary file or StringIO object created by the controller. Unlike ``response.download``, ``response.stream`` does not automatically set the Content-Disposition header, so you may need to do that manually (e.g., to specify download as an attachment, and to provide a filename). However, it does automatically set the ``Content-Type`` header (based on the filename extension).</div><div class=""> </div><div class=""> Also notice the ``request.env.wsgi_*`` variables. They are specific to the wsgi</div><div class=""> ``response.toolbar``: a function that allows you embed a toolbar into page form debugging purposes ``{{=response.toolbar()}}``. The toolbar displays request, response, session variables and database access time for each query.</div><div class=""> </div><div class=""> ``response._vars``: this variable is accessible only in a view, not in the action. It contains the value returned by the action to the view.</div><div class=""> </div><div class=""> ``response.optimize_css``: if can be set to &quot;concat,minify,inline&quot; to concatenate, minity and inline the CSS files included by web2py.</div><div class=""> </div><div class=""> ``response.optimize_js``: if can be set to &quot;concat,minify,inline&quot; to concatenate, minity and inline the CSS files included by web2py.</div><div class=""> </div><div class=""> ``response.view``: the name of the view template that must render the page. This is set by default to:</div><div class=""> ``</div><div class=""> &quot;%s/%s.%s&quot; % (request.controller, request.function, request.extension)</div><div class=""> ``:code</div><div class=""> </div><div class=""> or, if the above file cannot be located, to</div><div class=""> ``</div><div class=""> &quot;generic.%s&quot; % (request.extension)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Change the value of this variable to modify the view file associated with a particular action.</div><div class=""> </div><div class=""> ``response.xmlrpc(request, methods)``: when a controller returns it, this function exposes the methods via XML-RPC``xmlrpc``:cite . This function is deprecated since a better mechanism is available and described in Chapter 10.</div><div class=""> </div><div class=""> ``response.write(text)``: a method to write text into the output page body.</div><div class=""> </div><div class=""> ``response.js`` can contain Javascript Code. This code will be executed if and only if the response is received by a web2py component as discussed in Chapter 12.</div><div class=""> </div><div class=""> Since ``response`` is a ``gluon.storage.Storage`` object, it can be used to store other attributes that you may want to pass to the view. While there is no technical restriction, our recommendation is to store only variables that are to be rendered by all pages in the overall layout (&quot;layout.html&quot;).</div><div class=""> </div><div class=""> Anyway, we strongly suggest to stick to the variables listed here:</div><div class=""> ``</div><div class=""> response.title</div><div class=""> response.subtitle</div><div class=""> response.flash</div><div class=""> response.menu</div><div class=""> response.meta.author</div><div class=""> response.meta.description</div><div class=""> response.meta.keywords</div><div class=""> response.meta.*</div><div class=""> ``:code</div><div class=""> </div><div class=""> This means that only ``HTTP`` can be used for cross-page control flow. Other exc</div><div class=""> The command:</div><div class=""> ``</div><div class=""> redirect(&#x27;http://www.web2py.com&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> is simply a shortcut for:</div><div class=""> ``</div><div class=""> raise HTTP(303,</div><div class="">            &#x27;You are being redirected &lt;a href=&quot;%s&quot;&gt;here&lt;/a&gt;&#x27; % location,</div><div class="">            Location=&#x27;http://www.web2py.com&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The named arguments of the ``HTTP`` initializer method are translated into HTTP header directives, in this case, the redirection target location. ``redirect`` takes an optional second argument, which is the HTTP status code for the redirection (303 by default). Change this number to 307 for a temporary redirect or to 301 for a permanent redirect.</div><div class=""> </div><div class=""> The most common way to use redirect is to redirect to other pages in the same app and (optionally) pass parameters:</div><div class=""> </div><div class=""> ``</div><div class=""> redirect(URL(&#x27;index&#x27;, args=(1,2,3), vars=dict(a=&#x27;b&#x27;)))</div><div class=""> ``:code</div><div class=""> </div><div class=""> ### ``T`` and Internationalization</div><div class=""> ``T``:inxx ``internationalization``:inxx</div><div class=""> </div><div class=""> The object ``T`` is the language translator. It constitutes a single global instance of the web2py class ``gluon.language.translator``. All string constants (and only string constants) should be marked by ``T``, for example:</div><div class=""> ``</div><div class=""> a = T(&quot;hello world&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Strings that are marked with ``T`` are identified by web2py as needing language translation and they will be translated when the code (in the model, controller, or view) is executed. If the string to be translated is not a constant but a variable, it will be added to the translation file at runtime (except on GAE) to be translated later.</div><div class=""> </div><div class=""> The ``T`` object can also contain interpolated variables and support multiple equivalent syntax:</div><div class=""> ``</div><div class=""> a = T(&quot;hello %s&quot;, (&#x27;Tim&#x27;,))</div><div class=""> a = T(&quot;hello %(name)s&quot;, dict(name=&#x27;Tim&#x27;))</div><div class=""> a = T(&quot;hello %s&quot;) % (&#x27;Tim&#x27;,)</div><div class=""> a = T(&quot;hello %(name)s&quot;) % dict(name=&#x27;Tim&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The latter syntax is recommended because it makes translation easier.</div><div class=""> The first string is translated according to the requested language file and the ``name`` variable is replaced independently of the language.</div><div class=""> routes_out = (</div><div class=""> With these routes, the URL:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/testme</div><div class=""> ``:code</div><div class=""> </div><div class=""> is mapped into:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/examples/default/index</div><div class=""> ``:code</div><div class=""> </div><div class=""> To the visitor, all links to</div><div class=""> the page URL looks like ``/testme``.</div><div class=""> </div><div class=""> The patterns have the same syntax as Python regular expressions. For example:</div><div class=""> ``</div><div class="">   (&#x27;.*\.php&#x27;, &#x27;/init/default/index&#x27;),</div><div class=""> ``:code</div><div class=""> </div><div class=""> maps all URLs ending in &quot;.php&quot; to the index page.</div><div class=""> </div><div class=""> Sometimes you want to get rid of the application prefix from the URLs because you plan to expose only one application. This can be achieved with:</div><div class=""> ``</div><div class=""> routes_in = (</div><div class="">   (&#x27;/(?P&lt;any&gt;.*)&#x27;, &#x27;/init/\g&lt;any&gt;&#x27;),</div><div class=""> )</div><div class=""> routes_out = (</div><div class="">   (&#x27;/init/(?P&lt;any&gt;.*)&#x27;, &#x27;/\g&lt;any&gt;&#x27;),</div><div class=""> )</div><div class=""> ``:code</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/9845f00d9881250c0f454844915b3e6dbee6dccf">9845f00</a><ul><li>Date : 2012-09-01</li><li>Jonathan's first book patch</li></ul></li></ul>
<div class="row-fluid" id="com_9845f00d9881250c0f454844915b3e6dbee6dccf">
    <div class="span6"><div class="diff"><div class=""> The general syntax for routes is more complex than the simple examples we have seen so far. Here is a more general and representative example:</div><div class=""> ``</div><div class=""> routes_in = (</div><div class="insert"> (&#x27;140\.191\.\d+\.\d+:https<span class="highlight">?</span>://www.web2py.com:<span class="highlight">post</span> /(?P&lt;any&gt;.*)\.php&#x27;,</div><div class="">   &#x27;/test/default/index?vars=\g&lt;any&gt;&#x27;),</div><div class=""> )</div><div class=""> ``:code</div><div class=""> </div><div class="insert">It maps<span class="highlight"> ``http`` or</span> ``https`` ``POST`` requests<span class="highlight"> (note lower case &quot;post&quot;)</span> to host ``www.web2py.com`` from a remote IP matching the regular expression</div><div class=""> ``</div><div class=""> &#x27;140\.191\.\d+\.\d+&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class=""> requesting a page matching the regular expression</div><div class=""> ``</div><div class=""> &#x27;/(?P&lt;any&gt;.*)\.php&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class=""> into</div><div class=""> ``</div><div class=""> &#x27;/test/default/index?vars=\g&lt;any&gt;&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class=""> where ``\g&lt;any&gt;`` is replaced by the matching regular expression.</div><div class=""> </div><div class=""> The general syntax is</div><div class=""> ``</div><div class=""> &#x27;[remote address]:[protocol]://[host]:[method] [path]&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class="insert">The entire expression is matched as a regular expression, so &quot;.&quot; <span class="highlight">must</span> be escaped and any matching subexpression can be captured using ``(?P&lt;...&gt;...)`` <span class="highlight">using</span> Python regex syntax.<span class="highlight"> The request method (typically GET or POST) must be lower case.</span></div></div></div>
    <div class="span6"><div class="diff"><div class=""> The general syntax for routes is more complex than the simple examples we have seen so far. Here is a more general and representative example:</div><div class=""> ``</div><div class=""> routes_in = (</div><div class="delete"> (&#x27;140\.191\.\d+\.\d+:https<span class="highlight"></span>://www.web2py.com:<span class="highlight">POST</span> /(?P&lt;any&gt;.*)\.php&#x27;,</div><div class="">   &#x27;/test/default/index?vars=\g&lt;any&gt;&#x27;),</div><div class=""> )</div><div class=""> ``:code</div><div class=""> </div><div class="delete">It maps<span class="highlight"></span> ``https`` ``POST`` requests<span class="highlight"></span> to host ``www.web2py.com`` from a remote IP matching the regular expression</div><div class=""> ``</div><div class=""> &#x27;140\.191\.\d+\.\d+&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class=""> requesting a page matching the regular expression</div><div class=""> ``</div><div class=""> &#x27;/(?P&lt;any&gt;.*)\.php&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class=""> into</div><div class=""> ``</div><div class=""> &#x27;/test/default/index?vars=\g&lt;any&gt;&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class=""> where ``\g&lt;any&gt;`` is replaced by the matching regular expression.</div><div class=""> </div><div class=""> The general syntax is</div><div class=""> ``</div><div class=""> &#x27;[remote address]:[protocol]://[host]:[method] [path]&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class="delete">The entire expression is matched as a regular expression, so &quot;.&quot; <span class="highlight">should always</span> be escaped and any matching subexpression can be captured using ``(?P&lt;...&gt;...)`` <span class="highlight">according to</span> Python regex syntax.<span class="highlight"></span></div></div></div>
</div>
<hr />





        
      </div>

      <div id="push"></div>
    </div>

    <div id="footer">
      <div class="container-fluid">
          <div class="copyright pull-left">Copyright &#169; 2014</div>
          <div id="poweredBy" class="pull-right">
              Powered by
              <a href="http://www.web2py.com/">web2py</a>
          </div>
      </div>
    </div>
<script src="static/js/bootstrap.min.js"></script>
<script src="static/js/web2py_bootstrap.js"></script>
</body>
</html>
