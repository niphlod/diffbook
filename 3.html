<!DOCTYPE html>
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7]><html class="ie ie6 ie-lte9 ie-lte8 ie-lte7 no-js" lang="en-us"> <![endif]-->
<!--[if IE 7]><html class="ie ie7 ie-lte9 ie-lte8 ie-lte7 no-js" lang="en-us"> <![endif]-->
<!--[if IE 8]><html class="ie ie8 ie-lte9 ie-lte8 no-js" lang="en-us"> <![endif]-->
<!--[if IE 9]><html class="ie9 ie-lte9 no-js" lang="en-us"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html class="no-js" lang="en-us"> <!--<![endif]-->
<head>
  <meta charset="utf-8" />
  <!-- www.phpied.com/conditional-comments-block-downloads/ -->
  <!-- Always force latest IE rendering engine
       (even in intranet) & Chrome Frame
       Remove this if you use the .htaccess -->
  <!--[if IE]>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <![endif]-->

  <title>Diffbook</title>

  <!-- http://dev.w3.org/html5/markup/meta.name.html -->
  <meta name="application-name" content="diffbook" />

  <!-- Speaking of Google, don't forget to set your site up:
       http://google.com/webmasters -->
  <meta name="google-site-verification" content="" />

  <!--  Mobile Viewport Fix
        j.mp/mobileviewport & davidbcalhoun.com/2010/viewport-metatag
        device-width: Occupy full width of the screen in its current orientation
        initial-scale = 1.0 retains dimensions instead of zooming out if page height > device height
        user-scalable = yes allows the user to zoom in -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="shortcut icon" href="static/images/favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" href="static/images/favicon.png">

  <!-- All JavaScript at the bottom, except for Modernizr which enables
       HTML5 elements & feature detects -->
  <script src="static/js/modernizr.custom.js"></script>

  <!-- include stylesheets -->
  

  <script type="text/javascript"><!--
    // These variables are used by the web2py_ajax_init function in web2py_ajax.js (which is loaded below).
    var w2p_ajax_confirm_message = "Are you sure you want to delete this object?";
    var w2p_ajax_date_format = "%Y-%m-%d";
    var w2p_ajax_datetime_format = "%Y-%m-%d %H:%M:%S";
    //--></script>
<meta name="keywords" content="web2py, python, framework" />

<meta name="description" content="a cool new app" />

<meta name="generator" content="Web2py Web Framework" />

<meta name="author" content="Your Name &lt;you@example.com&gt;" />
<script src="static/js/jquery.js" type="text/javascript"></script><link href="static/css/calendar.css" rel="stylesheet" type="text/css" /><script src="static/js/calendar.js" type="text/javascript"></script><script src="static/js/web2py.js" type="text/javascript"></script><link href="static/css/web2py.css" rel="stylesheet" type="text/css" /><link href="static/css/bootstrap.min.css" rel="stylesheet" type="text/css" /><link href="static/css/bootstrap-responsive.min.css" rel="stylesheet" type="text/css" /><link href="static/css/web2py_bootstrap.css" rel="stylesheet" type="text/css" />


  

  <!-- uncomment here to load jquery-ui
       <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/themes/base/jquery-ui.css" type="text/css" media="all" />
       <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js" type="text/javascript"></script>
       uncomment to load jquery-ui //-->
  <noscript><link href="static/css/web2py_bootstrap_nojs.css" rel="stylesheet" type="text/css" /></noscript>
  
  <style type="text/css">

      /* Sticky footer styles
      -------------------------------------------------- */

      html,
      body {
        height: 100%;
        /* The html and body elements cannot have any padding or margin. */
      }

      /* Wrapper for page content to push down footer */
      #wrap {
        min-height: 100%;
        height: auto !important;
        height: 100%;
        /* Negative indent footer by it's height */
        margin: 0 auto -60px;
      }

      /* Set the fixed height of the footer here */
      #push,
      #footer {
        height: 60px;
      }
      #footer {
        background-color: #f5f5f5;
      }

      /* Lastly, apply responsive CSS fixes as necessary */
      @media (max-width: 767px) {
        #footer {
          margin-left: -20px;
          margin-right: -20px;
          padding-left: 20px;
          padding-right: 20px;
        }
      }



      /* Custom page CSS
      -------------------------------------------------- */
      /* Not required for template or sticky footer method. */

      .container {
        width: auto;
        max-width: 680px;
      }
      .container .credit {
        margin: 20px 0;
      }

    </style>
</head>

<body>
  
  <body>


    <!-- Part 1: Wrap all page content here -->
    <div id="wrap">

      <!-- Begin page content -->
      <div class="container-fluid">
        <div class="page-header">
          	<h1>
              Diffbook
              <small>easy? diffbook</small>
            </h1>
        </div>
        
        


<div class="pagination">
  <ul>

      <li><a href="/diffbook/0.html">Chapter 0</a></li>

      <li><a href="/diffbook/1.html">Chapter 1</a></li>

      <li><a href="/diffbook/2.html">Chapter 2</a></li>

      <li><a href="/diffbook/3.html">Chapter 3</a></li>

      <li><a href="/diffbook/4.html">Chapter 4</a></li>

      <li><a href="/diffbook/5.html">Chapter 5</a></li>

      <li><a href="/diffbook/6.html">Chapter 6</a></li>

      <li><a href="/diffbook/7.html">Chapter 7</a></li>

      <li><a href="/diffbook/8.html">Chapter 8</a></li>

      <li><a href="/diffbook/9.html">Chapter 9</a></li>

      <li><a href="/diffbook/10.html">Chapter 10</a></li>

      <li><a href="/diffbook/11.html">Chapter 11</a></li>

      <li><a href="/diffbook/12.html">Chapter 12</a></li>

  </ul>
</div>

<div class="pagination">
  <ul>

      <li><a href="#com_2643ce1730a2ea5c9b9c05414daeb8e25bdfd959">2643ce1</a></li>

      <li><a href="#com_699460492e242a8364f9044de148a6f9b211145f">6994604</a></li>

      <li><a href="#com_c4e4f430a3fe8433d95790170768d74eaf109a49">c4e4f43</a></li>

      <li><a href="#com_d5ff4176cd084e736faa5c1c7b989d4c3302c01e">d5ff417</a></li>

      <li><a href="#com_d864cef3b68d807ffe8dbc10c26845734fefb97b">d864cef</a></li>

      <li><a href="#com_c26286af0510d09ac5f9287336fc3a099d6813ef">c26286a</a></li>

      <li><a href="#com_82dc64e7baa231edd3896ca7a0d41393e426f123">82dc64e</a></li>

      <li><a href="#com_9f8f7358720ecddc06a79b90a68cc94ae5b28603">9f8f735</a></li>

      <li><a href="#com_28816a98948c4a6577f73bdeb2b7424dc55d2582">28816a9</a></li>

      <li><a href="#com_60ecdf04f0802a47a3fb83116d1449f8c3e6f141">60ecdf0</a></li>

      <li><a href="#com_cef1d9c5a8aa25ac1038a851f23e057780f2851d">cef1d9c</a></li>

      <li><a href="#com_31b67861f63a89ddbca5db525b9ea745b956670e">31b6786</a></li>

      <li><a href="#com_e8fd4a9f6c469c6a15492805add99a8a2a1cbf92">e8fd4a9</a></li>

      <li><a href="#com_95763bdcd5e83fb4b924ac8f71b00c67b2661dc7">95763bd</a></li>

      <li><a href="#com_702b8daf9017e009b956b391dee62b2183fb7e02">702b8da</a></li>

      <li><a href="#com_93539678ed5ee942c5bd09736516134b7abd95fd">9353967</a></li>

      <li><a href="#com_097d699dc16179206ccb7e4aee863d6523cd471c">097d699</a></li>

      <li><a href="#com_ac4003f4349f9ee22c67309ceeb48de5539b0308">ac4003f</a></li>

      <li><a href="#com_83521b165c2d34b0f5904766b5cf9d6f9cf3660a">83521b1</a></li>

      <li><a href="#com_4bd17bc2562076b27a8ea4f179e9752e3dd36086">4bd17bc</a></li>

      <li><a href="#com_7bce1473ce90f4e60f49d72bf1b61d32f430cb54">7bce147</a></li>

      <li><a href="#com_13346ee2edacdf0949376d16611c0c74748f4e41">13346ee</a></li>

      <li><a href="#com_26f5cf563dc22ad8fe7c18e13ab0b772051279b6">26f5cf5</a></li>

      <li><a href="#com_042a31d45d81ff3bc7ce198a6007d2750e27c39e">042a31d</a></li>

      <li><a href="#com_6e285db3ac654e46aae2fe589b7505f177354fce">6e285db</a></li>

      <li><a href="#com_49f38ab7ef56de1eb4ef48f68427ebf8a46b505d">49f38ab</a></li>

      <li><a href="#com_e059d270da4678676e9c42dc3c0c2d130342c905">e059d27</a></li>

      <li><a href="#com_f2fd41dd2a0d4bf68f5cd4f0989fb32bdc35eac5">f2fd41d</a></li>

      <li><a href="#com_e234f6edf67361b3ba718ea10184ba8e7c2f773d">e234f6e</a></li>

      <li><a href="#com_eaaa0e14bf17cdc4d0edd2ea9daa9af5f3484c09">eaaa0e1</a></li>

      <li><a href="#com_d23ab29383f8cf32f606974aad31c5f519e2c166">d23ab29</a></li>

      <li><a href="#com_76c0363755694c36971ffc9db176312fe5c14276">76c0363</a></li>

      <li><a href="#com_f2d73d8caa8283f9cbd978713b92c3f2b041db77">f2d73d8</a></li>

  </ul>
</div>



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/2643ce1730a2ea5c9b9c05414daeb8e25bdfd959">2643ce1</a><ul><li>Date : 2012-12-28</li><li>fixed typos in images</li></ul></li></ul>
<div class="row-fluid" id="com_2643ce1730a2ea5c9b9c05414daeb8e25bdfd959">
    <div class="span6"><div class="diff"><div class="insert">[[image @///image/debugger.png center 480px]<span class="highlight">]</span></div></div></div>
    <div class="span6"><div class="diff"><div class="delete">[[image @///image/debugger.png center 480px]<span class="highlight"></span></div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/699460492e242a8364f9044de148a6f9b211145f">6994604</a><ul><li>Date : 2013-01-16</li><li>Some clarifications</li></ul></li></ul>
<div class="row-fluid" id="com_699460492e242a8364f9044de148a6f9b211145f">
    <div class="span6"><div class="diff"><div class=""> The first of them shows the web2py version and proposes to upgrade it if new versions are available. Of course, before upgrading be sure to have a full working backup!</div><div class="insert">Then there are two <span class="highlight">other </span>forms that allow<span class="highlight"> the</span> creati<span class="highlight">o</span>n<span class="highlight"> of</span> a new application (simple or by using an online wizard) by specifying its name.</div><div class=""> </div><div class=""> ``Instant Press``:inxx ``Movuca``:inxx</div><div class=""> The following form allows uploading an existing application from either a local file or a remote URL. When you upload an application, you need to specify a name for it (using different names</div><div class=""> allows you to install multiple copies of the same application). You can try, for example, to upload the Movuca Social Networking application app created by Bruno Rocha:</div><div class=""> </div><div class=""> ``</div><div class=""> http://code.google.com/p/instant-press/</div><div class=""> ``</div><div class=""> </div><div class=""> or Instant Press CMS created by Martin Mulone:</div><div class=""> </div><div class=""> ``</div><div class=""> http://code.google.com/p/instant-press/</div><div class=""> ``</div><div class=""> </div><div class=""> or one of the many example applications available at:</div><div class=""> </div><div class=""> ``</div><div class=""> http://web2py.com/appliances</div><div class=""> ``</div><div class=""> </div><div class=""> ------</div><div class=""> Web2py files are packages as ``.w2p`` files. These ones are tar gzipped files. Web2py uses the ``.w2p`` extension instead of the ``.tgz`` extension to prevent the browser from unzipping on download. They can be uncompressed manually with ``tar zxvf [filename]`` although this is never necessary.</div><div class=""> ------</div><div class=""> </div><div class=""> [[image @///image/en4100.png center 444px]]</div><div class=""> </div><div class=""> Upon successful upload, web2py displays the MD5 checksum of the uploaded file. You can use it to verify that the file was not corrupted during upload. The InstantPress name will appear in the list of installed applications.</div><div class=""> </div><div class=""> If you run web2py from source and you have ``gitpython`` installed (if necessary, set it up with &#x27;easy_install gitpython&#x27;), you can install applications directly from git repositories</div><div class=""> You have used the &#x27;&#x27;edit&#x27;&#x27; page already in this chapter. Here we want to point o</div><div class=""> The image below shows the output of the test page for the welcome application.</div><div class=""> </div><div class=""> [[image @///image/en4400.png center 480px]]</div><div class=""> </div><div class=""> The image below show the languages tab for the welcome application.</div><div class=""> </div><div class=""> [[image @///image/en4500.png center 480px]]</div><div class=""> </div><div class=""> The image below shows how to edit a language file, in this case the &quot;it&quot; (Italian) language for the welcome application.</div><div class=""> </div><div class=""> [[image @///image/en4600.png center 480px]]</div><div class=""> </div><div class=""> ##### Integrated debugger</div><div class=""> </div><div class=""> &#x27;&#x27;(requires Python 2.6 or later)&#x27;&#x27;</div><div class=""> </div><div class=""> The web2py admin includes a web based debugger. Using the provided web-based editor you can add breakpoints to the Python code and, from the associated debugger console, you can inspect the system variables at those breakpoints and resume execution. This is illustrated in the following screenshot:</div><div class=""> </div><div class=""> [[image @///image/debugger.png center 480px]]</div><div class=""> </div><div class=""> This functionality is based on the Qdb debugger created by Mariano Reingart.</div><div class=""> It uses multiprocessing.connection to communicate between the backend</div><div class=""> and frontend, with a JSON-RPC-like stream protocol. ``qdb``:cite</div><div class=""> </div><div class=""> ##### Shell</div><div class=""> </div><div class=""> If you click on the &quot;shell&quot; link under the controllers tab in &#x27;&#x27;edit&#x27;&#x27;, web2py will open a web based Python shell and will execute the models for the current application. This allows you to interactively talk to your application.</div><div class=""> </div><div class=""> [[image @///image/en4700.png center 480px]]</div><div class=""> </div><div class="insert">+-------</div><div class="insert">+Be careful using the web based shell - because different shell requests will be executed in different threads. This easily gives errors, especially if you play with databases</div><div class="insert">+creation and connections. For activities like these (i.e. if you need persistence) it&#x27;s much better to use the python command line.</div><div class="insert">+-------</div><div class=""> ##### Crontab</div></div></div>
    <div class="span6"><div class="diff"><div class=""> The first of them shows the web2py version and proposes to upgrade it if new versions are available. Of course, before upgrading be sure to have a full working backup!</div><div class="delete">Then there are two <span class="highlight"></span>forms that allow<span class="highlight">s</span> creati<span class="highlight"></span>n<span class="highlight">g</span> a new application (simple or by using an online wizard) by specifying its name.</div><div class=""> </div><div class=""> ``Instant Press``:inxx ``Movuca``:inxx</div><div class=""> The following form allows uploading an existing application from either a local file or a remote URL. When you upload an application, you need to specify a name for it (using different names</div><div class=""> allows you to install multiple copies of the same application). You can try, for example, to upload the Movuca Social Networking application app created by Bruno Rocha:</div><div class=""> </div><div class=""> ``</div><div class=""> http://code.google.com/p/instant-press/</div><div class=""> ``</div><div class=""> </div><div class=""> or Instant Press CMS created by Martin Mulone:</div><div class=""> </div><div class=""> ``</div><div class=""> http://code.google.com/p/instant-press/</div><div class=""> ``</div><div class=""> </div><div class=""> or one of the many example applications available at:</div><div class=""> </div><div class=""> ``</div><div class=""> http://web2py.com/appliances</div><div class=""> ``</div><div class=""> </div><div class=""> ------</div><div class=""> Web2py files are packages as ``.w2p`` files. These ones are tar gzipped files. Web2py uses the ``.w2p`` extension instead of the ``.tgz`` extension to prevent the browser from unzipping on download. They can be uncompressed manually with ``tar zxvf [filename]`` although this is never necessary.</div><div class=""> ------</div><div class=""> </div><div class=""> [[image @///image/en4100.png center 444px]]</div><div class=""> </div><div class=""> Upon successful upload, web2py displays the MD5 checksum of the uploaded file. You can use it to verify that the file was not corrupted during upload. The InstantPress name will appear in the list of installed applications.</div><div class=""> </div><div class=""> If you run web2py from source and you have ``gitpython`` installed (if necessary, set it up with &#x27;easy_install gitpython&#x27;), you can install applications directly from git repositories</div><div class=""> You have used the &#x27;&#x27;edit&#x27;&#x27; page already in this chapter. Here we want to point o</div><div class=""> The image below shows the output of the test page for the welcome application.</div><div class=""> </div><div class=""> [[image @///image/en4400.png center 480px]]</div><div class=""> </div><div class=""> The image below show the languages tab for the welcome application.</div><div class=""> </div><div class=""> [[image @///image/en4500.png center 480px]]</div><div class=""> </div><div class=""> The image below shows how to edit a language file, in this case the &quot;it&quot; (Italian) language for the welcome application.</div><div class=""> </div><div class=""> [[image @///image/en4600.png center 480px]]</div><div class=""> </div><div class=""> ##### Integrated debugger</div><div class=""> </div><div class=""> &#x27;&#x27;(requires Python 2.6 or later)&#x27;&#x27;</div><div class=""> </div><div class=""> The web2py admin includes a web based debugger. Using the provided web-based editor you can add breakpoints to the Python code and, from the associated debugger console, you can inspect the system variables at those breakpoints and resume execution. This is illustrated in the following screenshot:</div><div class=""> </div><div class=""> [[image @///image/debugger.png center 480px]]</div><div class=""> </div><div class=""> This functionality is based on the Qdb debugger created by Mariano Reingart.</div><div class=""> It uses multiprocessing.connection to communicate between the backend</div><div class=""> and frontend, with a JSON-RPC-like stream protocol. ``qdb``:cite</div><div class=""> </div><div class=""> ##### Shell</div><div class=""> </div><div class=""> If you click on the &quot;shell&quot; link under the controllers tab in &#x27;&#x27;edit&#x27;&#x27;, web2py will open a web based Python shell and will execute the models for the current application. This allows you to interactively talk to your application.</div><div class=""> </div><div class=""> [[image @///image/en4700.png center 480px]]</div><div class=""> </div><div class=""> ##### Crontab</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/c4e4f430a3fe8433d95790170768d74eaf109a49">c4e4f43</a><ul><li>Date : 2012-12-22</li><li>fixed subsection level</li></ul></li></ul>
<div class="row-fluid" id="com_c4e4f430a3fe8433d95790170768d74eaf109a49">
    <div class="span6"><div class="diff"><div class="insert">+### Simple examples</div><div class="insert">+</div><div class="insert">+#### Say hello</div><div class=""> ``index``:inxx</div><div class=""> </div><div class=""> Here, as an example, we create a simple web app that displays the message &quot;Hello from MyApp&quot; to the user. We will call this application &quot;myapp&quot;. We will also add a counter that counts how many times the same user visits the page.</div><div class=""> </div><div class=""> You can create a new application simply by typing its name in the form on the top right of the **site** page in **admin**.</div><div class=""> </div><div class=""> [[image @///image/en800.png center 447px]]</div><div class=""> </div><div class=""> After you press [create], the application is created as a copy of the built-in welcome application.</div><div class=""> </div><div class=""> [[image @///image/en900.png center 480px]]</div><div class=""> </div><div class=""> To run the new application, visit:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/myapp</div><div class=""> ``:code</div><div class=""> </div><div class=""> Now you have a copy of the welcome application.</div><div class=""> </div><div class=""> To edit an application, click on the &#x27;&#x27;edit&#x27;&#x27; button for the newly created application.</div><div class=""> </div><div class=""> The **edit** page tells you what is inside the application.</div><div class=""> Every web2py application consists of certain files, most of which fall into one of six categories:</div><div class=""> - **models**: describe the data representation.</div><div class=""> - **controllers**: describe the application logic and workflow.</div><div class=""> - **views**: describe the data presentation.</div><div class=""> - **languages**: describe how to translate the application presentation to other languages.</div><div class=""> - **modules**: Python modules that belong to the application.</div><div class=""> - **static files**: static images, CSS  files``css:w,css:o,css:school``:cite , JavaScript files``js:w,js:b``:cite , etc.</div><div class=""> - **plugins**: groups of files designed to work together.</div><div class=""> Now the action returns a dictionary defining a ``message``. When an action retur</div><div class=""> </div><div class=""> If web2py does not find the requested view, it uses the &quot;generic.html&quot; view that comes with every application.</div><div class=""> </div><div class=""> -------</div><div class=""> ``Mac Mail``:inxx ``Google Maps``:inxx ``jsonp``:inxx</div><div class=""> If an extension other than &quot;html&quot; is specified (&quot;json&quot; for example), and the view file &quot;[controller]/[function].json&quot; is not found, web2py looks for the view &quot;generic.json&quot;. web2py comes with generic.html, generic.json, generic.jsonp, generic.xml, generic.rss, generic.ics (for Mac Mail Calendar), generic.map (for embedding Google Maps), and generic.pdf (based on fpdf). These generic views can be modified for each application individually, and additional views can be added easily.</div><div class=""> -------</div><div class=""> </div><div class=""> -------</div><div class=""> Generic views are a development tool. In production every action should have its own view. In fact, by default, generic views are only enabled from localhost.</div><div class=""> -------</div><div class=""> </div><div class=""> -------</div><div class=""> You can also specify a view with ``response.view = &#x27;default/something.html&#x27;``</div><div class=""> -------</div><div class=""> </div><div class=""> Read more on this topic in Chapter 10.</div><div class=""> </div><div class=""> If you go back to &quot;EDIT&quot; and click on index, you will now see the following HTML page:</div><div class=""> </div><div class=""> [[image @///image/en1200.png center 480px]]</div><div class=""> </div><div class=""> For debugging purposes you can always append</div><div class=""> </div><div class=""> ``</div><div class=""> {{=response.toolbar()}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> to the code in a view and it will show you some useful information, including the request, response and session objects, and list all db queries with their timing.</div><div class=""> </div><div class="insert"><span class="highlight">#</span>### Let&#x27;s count</div><div class=""> ``session``:inxx</div><div class=""> Let&#x27;s now add a counter to this page that will count how many times the same visitor displays the page.</div><div class=""> </div><div class=""> web2py automatically and transparently tracks visitors using sessions and cookies. For each new visitor, it creates a session and assigns a unique &quot;session_id&quot;. The session is a container for variables that are stored server-side. The unique id is sent to the browser via a cookie. When the visitor requests another page from the same application, the browser sends the cookie back, it is retrieved by web2py, and the corresponding session is restored.</div><div class=""> </div><div class=""> To use the session, modify the default controller:</div><div class=""> ``</div><div class=""> def index():</div><div class="">     if not session.counter:</div><div class="">         session.counter = 1</div><div class="">     else:</div><div class="">         session.counter += 1</div><div class="">     return dict(message=&quot;Hello from MyApp&quot;, counter=session.counter)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Notice that ``counter`` is not a web2py keyword but ``session`` is. We are asking web2py to check whether there is a counter variable in the session and, if not, to create one and set it to 1. If the counter is there, we ask web2py to increase the counter by 1. Finally we pass the value of the counter to the view.</div><div class=""> </div><div class=""> A more compact way to code the same function is this:</div><div class=""> ``</div><div class=""> def index():</div><div class="">     session.counter = (session.counter or 0) + 1</div><div class="">     return dict(message=&quot;Hello from MyApp&quot;, counter=session.counter)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Now modify the view to add a line that displays the value of the counter:</div><div class=""> ``</div><div class=""> &lt;html&gt;</div><div class="">    &lt;head&gt;&lt;/head&gt;</div><div class="">    &lt;body&gt;</div><div class="">       &lt;h1&gt;{{=message}}&lt;/h1&gt;</div><div class="">       &lt;h2&gt;Number of visits: {{=counter}}&lt;/h2&gt;</div><div class="">    &lt;/body&gt;</div><div class=""> &lt;/html&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> When you visit the index page again (and again) you should get the following HTML page:</div><div class=""> </div><div class=""> [[image @///image/en1300.png center 480px]]</div><div class=""> </div><div class=""> The counter is associated with each visitor, and is incremented each time the visitor reloads the page. Different visitors see different counters.</div><div class=""> </div><div class="insert"><span class="highlight">#</span>### Say my name</div><div class=""> ``form``:inxx ``request.vars``:inxx</div><div class=""> </div><div class=""> Now create two pages (first and second), where the first page creates a form, asks the visitor&#x27;s name, and redirects to the second page, which greets the visitor by name.</div><div class=""> </div><div class=""> [[yUML diagram @///image/en1400.png center 293px]]</div><div class=""> </div><div class=""> Write the corresponding actions in the default controller:</div><div class=""> ``</div><div class=""> def first():</div><div class="">     return dict()</div><div class=""> </div><div class=""> def second():</div><div class="">     return dict()</div><div class=""> ``:code</div><div class=""> </div><div class=""> Then create a view &quot;default/first.html&quot; for the first action,</div><div class=""> and enter:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> What is your name?</div><div class=""> &lt;form action=&quot;second&quot;&gt;</div><div class="">   &lt;input name=&quot;visitor_name&quot; /&gt;</div><div class="">   &lt;input type=&quot;submit&quot; /&gt;</div><div class=""> &lt;/form&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> Finally, create a view &quot;default/second.html&quot; for the second action:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Hello {{=request.vars.visitor_name}}&lt;/h1&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> ``layout``:inxx</div><div class=""> In both views we have extended the basic &quot;layout.html&quot; view that comes with web2py. The layout view keeps the look and feel of the two pages coherent. The layout file can be edited and replaced easily, since it mainly contains HTML code.</div><div class=""> </div><div class=""> If you now visit the first page, type your name:</div><div class=""> </div><div class=""> [[image @///image/en1500.png center 480px]]</div><div class=""> </div><div class=""> and submit the form, you will receive a greeting:</div><div class=""> </div><div class=""> [[image @///image/en1600.png center 480px]]</div><div class=""> </div><div class="insert"><span class="highlight">#</span>### Postbacks</div><div class=""> ``redirect``:inxx ``URL``:inxx ``postback``:inxx</div><div class=""> </div><div class=""> The mechanism for form submission that we used before is very common, but it is not good programming practice. All input should be validated and, in the above example, the burden of validation would fall on the second action. Thus the action that performs the validation is different from the action that generated the form. This tends to cause redundancy in the code.</div><div class=""> </div><div class=""> A better pattern for form submission is to submit forms to the same action that generated them, in our example the &quot;first&quot;. The &quot;first&quot; action should receive the variables, process them, store them server-side, and redirect the visitor to the &quot;second&quot; page, which retrieves the variables. This mechanism is called a &#x27;&#x27;postback&#x27;&#x27;.</div><div class=""> </div><div class=""> [[yUML diagram @///image/en1700.png center 293px]]</div><div class=""> </div><div class=""> Modify the default controller to implement self-submission:</div><div class=""> ``</div><div class=""> def first():</div><div class="">     if request.vars.visitor_name:</div><div class="">         session.visitor_name = request.vars.visitor_name</div><div class="">         redirect(URL(&#x27;second&#x27;))</div><div class="">     return dict()</div><div class=""> </div><div class=""> def second():</div><div class="">     return dict()</div><div class=""> ``:code</div><div class=""> </div><div class=""> Then modify the &quot;default/first.html&quot; view:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> What is your name?</div><div class=""> &lt;form&gt;</div><div class="">   &lt;input name=&quot;visitor_name&quot; /&gt;</div><div class="">   &lt;input type=&quot;submit&quot; /&gt;</div><div class=""> &lt;/form&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> The &quot;download&quot; action does not return a dictionary, so it does not need a view.</div><div class=""> </div><div class=""> Edit this new file and replace its content with the following:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Image: {{=image.title}}&lt;/h1&gt;</div><div class=""> &lt;center&gt;</div><div class=""> &lt;img width=&quot;200px&quot;</div><div class="">      src=&quot;{{=URL(&#x27;download&#x27;, args=image.file)}}&quot; /&gt;</div><div class=""> &lt;/center&gt;</div><div class=""> {{if len(comments):}}</div><div class="">   &lt;h2&gt;Comments&lt;/h2&gt;&lt;br /&gt;&lt;p&gt;</div><div class="">   {{for comment in comments:}}</div><div class="">     &lt;p&gt;{{=comment.author}} says &lt;i&gt;{{=comment.body}}&lt;/i&gt;&lt;/p&gt;</div><div class="">   {{pass}}&lt;/p&gt;</div><div class=""> {{else:}}</div><div class="">   &lt;h2&gt;No comments posted yet&lt;/h2&gt;</div><div class=""> {{pass}}</div><div class=""> &lt;h2&gt;Post a comment&lt;/h2&gt;</div><div class=""> {{=form}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> This view displays the **image.file** by calling the &quot;download&quot; action inside an ``&lt;img ... /&gt;`` tag.</div><div class=""> If there are comments, it loops over them and displays each one.</div><div class=""> </div><div class=""> Here is how everything will appear to a visitor.</div><div class=""> </div><div class=""> [[image @///image/en2900.png center 480px]]</div><div class=""> </div><div class=""> When a visitor submits a comment via this page, the comment is stored in the database and appended at the bottom of the page.</div><div class=""> </div><div class="insert"><span class="highlight">#</span>### Adding Authentication</div><div class=""> </div><div class=""> The web2py API for Role-Based Access Control is quite sophisticated, but for now we will limit ourselves to restricting access to the show action to authenticated users, deferring a more detailed discussion to Chapter 9.</div><div class=""> </div><div class=""> To limit access to authenticated users, we need to complete three steps. In a model, for example &quot;db.py&quot;, we need to add:</div><div class=""> ``</div><div class=""> from gluon.tools import Auth</div><div class=""> auth = Auth(db)</div><div class=""> auth.define_tables(username=True)</div><div class=""> ``:code</div><div class=""> </div><div class=""> In our controller, we need to add one action:</div><div class=""> ``</div><div class=""> def user():</div><div class="">     return dict(form=auth())</div><div class=""> ``:code</div><div class=""> </div><div class=""> This is sufficient to enable login, register, logout, etc. pages. The default layout will also show options to the corresponding pages in the top right corner.</div><div class=""> </div><div class=""> [[image @///image/en3000.png center 300px]]</div><div class=""> </div><div class=""> We can now decorate the functions that we want to restrict, for example:</div><div class=""> ``</div><div class=""> @auth.requires_login()</div><div class=""> def show():</div><div class="">     ...</div><div class=""> ``:code</div><div class=""> </div><div class=""> Any attempt to access</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/show/[image_id]</div><div class=""> We can improve this further using the ``SQLFORM.grid`` and ``SQLFORM.smartgrid``</div><div class=""> </div><div class=""> ``</div><div class=""> @auth.requires_membership(&#x27;manager&#x27;)</div><div class=""> def manage():</div><div class="">     grid = SQLFORM.smartgrid(db.image,linked_tables=[&#x27;comment&#x27;])</div><div class="">     return dict(grid=grid)</div><div class=""> ``:code</div><div class=""> </div><div class=""> with associated &quot;views/default/manage.html&quot;</div><div class=""> </div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h2&gt;Management Interface&lt;/h2&gt;</div><div class=""> {{=grid}}</div><div class=""> ``</div><div class=""> </div><div class=""> Using appadmin create a group &quot;manager&quot; and make some users members of the group. They will not be able to access</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/manage</div><div class=""> ``</div><div class=""> </div><div class=""> and browse, search:</div><div class=""> </div><div class=""> [[image @///image/en3200.png center 480px]]</div><div class=""> </div><div class=""> create, update and delete images and their comments:</div><div class=""> </div><div class=""> [[image @///image/en3300.png center 480px]]</div><div class=""> </div><div class="insert"><span class="highlight">#</span>### Configuring the layout</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">-### Say hello</div><div class=""> ``index``:inxx</div><div class=""> </div><div class=""> Here, as an example, we create a simple web app that displays the message &quot;Hello from MyApp&quot; to the user. We will call this application &quot;myapp&quot;. We will also add a counter that counts how many times the same user visits the page.</div><div class=""> </div><div class=""> You can create a new application simply by typing its name in the form on the top right of the **site** page in **admin**.</div><div class=""> </div><div class=""> [[image @///image/en800.png center 447px]]</div><div class=""> </div><div class=""> After you press [create], the application is created as a copy of the built-in welcome application.</div><div class=""> </div><div class=""> [[image @///image/en900.png center 480px]]</div><div class=""> </div><div class=""> To run the new application, visit:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/myapp</div><div class=""> ``:code</div><div class=""> </div><div class=""> Now you have a copy of the welcome application.</div><div class=""> </div><div class=""> To edit an application, click on the &#x27;&#x27;edit&#x27;&#x27; button for the newly created application.</div><div class=""> </div><div class=""> The **edit** page tells you what is inside the application.</div><div class=""> Every web2py application consists of certain files, most of which fall into one of six categories:</div><div class=""> - **models**: describe the data representation.</div><div class=""> - **controllers**: describe the application logic and workflow.</div><div class=""> - **views**: describe the data presentation.</div><div class=""> - **languages**: describe how to translate the application presentation to other languages.</div><div class=""> - **modules**: Python modules that belong to the application.</div><div class=""> - **static files**: static images, CSS  files``css:w,css:o,css:school``:cite , JavaScript files``js:w,js:b``:cite , etc.</div><div class=""> - **plugins**: groups of files designed to work together.</div><div class=""> Now the action returns a dictionary defining a ``message``. When an action retur</div><div class=""> </div><div class=""> If web2py does not find the requested view, it uses the &quot;generic.html&quot; view that comes with every application.</div><div class=""> </div><div class=""> -------</div><div class=""> ``Mac Mail``:inxx ``Google Maps``:inxx ``jsonp``:inxx</div><div class=""> If an extension other than &quot;html&quot; is specified (&quot;json&quot; for example), and the view file &quot;[controller]/[function].json&quot; is not found, web2py looks for the view &quot;generic.json&quot;. web2py comes with generic.html, generic.json, generic.jsonp, generic.xml, generic.rss, generic.ics (for Mac Mail Calendar), generic.map (for embedding Google Maps), and generic.pdf (based on fpdf). These generic views can be modified for each application individually, and additional views can be added easily.</div><div class=""> -------</div><div class=""> </div><div class=""> -------</div><div class=""> Generic views are a development tool. In production every action should have its own view. In fact, by default, generic views are only enabled from localhost.</div><div class=""> -------</div><div class=""> </div><div class=""> -------</div><div class=""> You can also specify a view with ``response.view = &#x27;default/something.html&#x27;``</div><div class=""> -------</div><div class=""> </div><div class=""> Read more on this topic in Chapter 10.</div><div class=""> </div><div class=""> If you go back to &quot;EDIT&quot; and click on index, you will now see the following HTML page:</div><div class=""> </div><div class=""> [[image @///image/en1200.png center 480px]]</div><div class=""> </div><div class=""> For debugging purposes you can always append</div><div class=""> </div><div class=""> ``</div><div class=""> {{=response.toolbar()}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> to the code in a view and it will show you some useful information, including the request, response and session objects, and list all db queries with their timing.</div><div class=""> </div><div class="delete"><span class="highlight"></span>### Let&#x27;s count</div><div class=""> ``session``:inxx</div><div class=""> Let&#x27;s now add a counter to this page that will count how many times the same visitor displays the page.</div><div class=""> </div><div class=""> web2py automatically and transparently tracks visitors using sessions and cookies. For each new visitor, it creates a session and assigns a unique &quot;session_id&quot;. The session is a container for variables that are stored server-side. The unique id is sent to the browser via a cookie. When the visitor requests another page from the same application, the browser sends the cookie back, it is retrieved by web2py, and the corresponding session is restored.</div><div class=""> </div><div class=""> To use the session, modify the default controller:</div><div class=""> ``</div><div class=""> def index():</div><div class="">     if not session.counter:</div><div class="">         session.counter = 1</div><div class="">     else:</div><div class="">         session.counter += 1</div><div class="">     return dict(message=&quot;Hello from MyApp&quot;, counter=session.counter)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Notice that ``counter`` is not a web2py keyword but ``session`` is. We are asking web2py to check whether there is a counter variable in the session and, if not, to create one and set it to 1. If the counter is there, we ask web2py to increase the counter by 1. Finally we pass the value of the counter to the view.</div><div class=""> </div><div class=""> A more compact way to code the same function is this:</div><div class=""> ``</div><div class=""> def index():</div><div class="">     session.counter = (session.counter or 0) + 1</div><div class="">     return dict(message=&quot;Hello from MyApp&quot;, counter=session.counter)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Now modify the view to add a line that displays the value of the counter:</div><div class=""> ``</div><div class=""> &lt;html&gt;</div><div class="">    &lt;head&gt;&lt;/head&gt;</div><div class="">    &lt;body&gt;</div><div class="">       &lt;h1&gt;{{=message}}&lt;/h1&gt;</div><div class="">       &lt;h2&gt;Number of visits: {{=counter}}&lt;/h2&gt;</div><div class="">    &lt;/body&gt;</div><div class=""> &lt;/html&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> When you visit the index page again (and again) you should get the following HTML page:</div><div class=""> </div><div class=""> [[image @///image/en1300.png center 480px]]</div><div class=""> </div><div class=""> The counter is associated with each visitor, and is incremented each time the visitor reloads the page. Different visitors see different counters.</div><div class=""> </div><div class="delete"><span class="highlight"></span>### Say my name</div><div class=""> ``form``:inxx ``request.vars``:inxx</div><div class=""> </div><div class=""> Now create two pages (first and second), where the first page creates a form, asks the visitor&#x27;s name, and redirects to the second page, which greets the visitor by name.</div><div class=""> </div><div class=""> [[yUML diagram @///image/en1400.png center 293px]]</div><div class=""> </div><div class=""> Write the corresponding actions in the default controller:</div><div class=""> ``</div><div class=""> def first():</div><div class="">     return dict()</div><div class=""> </div><div class=""> def second():</div><div class="">     return dict()</div><div class=""> ``:code</div><div class=""> </div><div class=""> Then create a view &quot;default/first.html&quot; for the first action,</div><div class=""> and enter:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> What is your name?</div><div class=""> &lt;form action=&quot;second&quot;&gt;</div><div class="">   &lt;input name=&quot;visitor_name&quot; /&gt;</div><div class="">   &lt;input type=&quot;submit&quot; /&gt;</div><div class=""> &lt;/form&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> Finally, create a view &quot;default/second.html&quot; for the second action:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Hello {{=request.vars.visitor_name}}&lt;/h1&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> ``layout``:inxx</div><div class=""> In both views we have extended the basic &quot;layout.html&quot; view that comes with web2py. The layout view keeps the look and feel of the two pages coherent. The layout file can be edited and replaced easily, since it mainly contains HTML code.</div><div class=""> </div><div class=""> If you now visit the first page, type your name:</div><div class=""> </div><div class=""> [[image @///image/en1500.png center 480px]]</div><div class=""> </div><div class=""> and submit the form, you will receive a greeting:</div><div class=""> </div><div class=""> [[image @///image/en1600.png center 480px]]</div><div class=""> </div><div class="delete"><span class="highlight"></span>### Postbacks</div><div class=""> ``redirect``:inxx ``URL``:inxx ``postback``:inxx</div><div class=""> </div><div class=""> The mechanism for form submission that we used before is very common, but it is not good programming practice. All input should be validated and, in the above example, the burden of validation would fall on the second action. Thus the action that performs the validation is different from the action that generated the form. This tends to cause redundancy in the code.</div><div class=""> </div><div class=""> A better pattern for form submission is to submit forms to the same action that generated them, in our example the &quot;first&quot;. The &quot;first&quot; action should receive the variables, process them, store them server-side, and redirect the visitor to the &quot;second&quot; page, which retrieves the variables. This mechanism is called a &#x27;&#x27;postback&#x27;&#x27;.</div><div class=""> </div><div class=""> [[yUML diagram @///image/en1700.png center 293px]]</div><div class=""> </div><div class=""> Modify the default controller to implement self-submission:</div><div class=""> ``</div><div class=""> def first():</div><div class="">     if request.vars.visitor_name:</div><div class="">         session.visitor_name = request.vars.visitor_name</div><div class="">         redirect(URL(&#x27;second&#x27;))</div><div class="">     return dict()</div><div class=""> </div><div class=""> def second():</div><div class="">     return dict()</div><div class=""> ``:code</div><div class=""> </div><div class=""> Then modify the &quot;default/first.html&quot; view:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> What is your name?</div><div class=""> &lt;form&gt;</div><div class="">   &lt;input name=&quot;visitor_name&quot; /&gt;</div><div class="">   &lt;input type=&quot;submit&quot; /&gt;</div><div class=""> &lt;/form&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> The &quot;download&quot; action does not return a dictionary, so it does not need a view.</div><div class=""> </div><div class=""> Edit this new file and replace its content with the following:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Image: {{=image.title}}&lt;/h1&gt;</div><div class=""> &lt;center&gt;</div><div class=""> &lt;img width=&quot;200px&quot;</div><div class="">      src=&quot;{{=URL(&#x27;download&#x27;, args=image.file)}}&quot; /&gt;</div><div class=""> &lt;/center&gt;</div><div class=""> {{if len(comments):}}</div><div class="">   &lt;h2&gt;Comments&lt;/h2&gt;&lt;br /&gt;&lt;p&gt;</div><div class="">   {{for comment in comments:}}</div><div class="">     &lt;p&gt;{{=comment.author}} says &lt;i&gt;{{=comment.body}}&lt;/i&gt;&lt;/p&gt;</div><div class="">   {{pass}}&lt;/p&gt;</div><div class=""> {{else:}}</div><div class="">   &lt;h2&gt;No comments posted yet&lt;/h2&gt;</div><div class=""> {{pass}}</div><div class=""> &lt;h2&gt;Post a comment&lt;/h2&gt;</div><div class=""> {{=form}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> This view displays the **image.file** by calling the &quot;download&quot; action inside an ``&lt;img ... /&gt;`` tag.</div><div class=""> If there are comments, it loops over them and displays each one.</div><div class=""> </div><div class=""> Here is how everything will appear to a visitor.</div><div class=""> </div><div class=""> [[image @///image/en2900.png center 480px]]</div><div class=""> </div><div class=""> When a visitor submits a comment via this page, the comment is stored in the database and appended at the bottom of the page.</div><div class=""> </div><div class="delete"><span class="highlight"></span>### Adding Authentication</div><div class=""> </div><div class=""> The web2py API for Role-Based Access Control is quite sophisticated, but for now we will limit ourselves to restricting access to the show action to authenticated users, deferring a more detailed discussion to Chapter 9.</div><div class=""> </div><div class=""> To limit access to authenticated users, we need to complete three steps. In a model, for example &quot;db.py&quot;, we need to add:</div><div class=""> ``</div><div class=""> from gluon.tools import Auth</div><div class=""> auth = Auth(db)</div><div class=""> auth.define_tables(username=True)</div><div class=""> ``:code</div><div class=""> </div><div class=""> In our controller, we need to add one action:</div><div class=""> ``</div><div class=""> def user():</div><div class="">     return dict(form=auth())</div><div class=""> ``:code</div><div class=""> </div><div class=""> This is sufficient to enable login, register, logout, etc. pages. The default layout will also show options to the corresponding pages in the top right corner.</div><div class=""> </div><div class=""> [[image @///image/en3000.png center 300px]]</div><div class=""> </div><div class=""> We can now decorate the functions that we want to restrict, for example:</div><div class=""> ``</div><div class=""> @auth.requires_login()</div><div class=""> def show():</div><div class="">     ...</div><div class=""> ``:code</div><div class=""> </div><div class=""> Any attempt to access</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/show/[image_id]</div><div class=""> We can improve this further using the ``SQLFORM.grid`` and ``SQLFORM.smartgrid``</div><div class=""> </div><div class=""> ``</div><div class=""> @auth.requires_membership(&#x27;manager&#x27;)</div><div class=""> def manage():</div><div class="">     grid = SQLFORM.smartgrid(db.image,linked_tables=[&#x27;comment&#x27;])</div><div class="">     return dict(grid=grid)</div><div class=""> ``:code</div><div class=""> </div><div class=""> with associated &quot;views/default/manage.html&quot;</div><div class=""> </div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h2&gt;Management Interface&lt;/h2&gt;</div><div class=""> {{=grid}}</div><div class=""> ``</div><div class=""> </div><div class=""> Using appadmin create a group &quot;manager&quot; and make some users members of the group. They will not be able to access</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/manage</div><div class=""> ``</div><div class=""> </div><div class=""> and browse, search:</div><div class=""> </div><div class=""> [[image @///image/en3200.png center 480px]]</div><div class=""> </div><div class=""> create, update and delete images and their comments:</div><div class=""> </div><div class=""> [[image @///image/en3300.png center 480px]]</div><div class=""> </div><div class="delete"><span class="highlight"></span>### Configuring the layout</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/d5ff4176cd084e736faa5c1c7b989d4c3302c01e">d5ff417</a><ul><li>Date : 2012-12-28</li><li>Chapter 3: it's 'wiki-enabled app'</li></ul></li></ul>
<div class="row-fluid" id="com_d5ff4176cd084e736faa5c1c7b989d4c3302c01e">
    <div class="span6"><div class="diff"><div class="insert">When your wiki-enabled<span class="highlight"> app</span> gets more complicated, perhaps you might need to customize the wiki db records managed by the Auth interface or expose customized forms for wiki CRUD tasks. For example, you might want to customize a wiki table record representation or add a new field validator. This is not allowed by default, since the wiki model is defined only after the wiki interface is requested with the auth.wiki() method. To allow access to the wiki specific db setup within the model of your app you must add the following sentence to your model file (i.e. db.py)</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">When your wiki-enabled<span class="highlight"></span> gets more complicated, perhaps you might need to customize the wiki db records managed by the Auth interface or expose customized forms for wiki CRUD tasks. For example, you might want to customize a wiki table record representation or add a new field validator. This is not allowed by default, since the wiki model is defined only after the wiki interface is requested with the auth.wiki() method. To allow access to the wiki specific db setup within the model of your app you must add the following sentence to your model file (i.e. db.py)</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/d864cef3b68d807ffe8dbc10c26845734fefb97b">d864cef</a><ul><li>Date : 2013-02-04</li><li>fixed all but chap 6</li></ul></li></ul>
<div class="row-fluid" id="com_d864cef3b68d807ffe8dbc10c26845734fefb97b">
    <div class="span6"><div class="diff"><div class=""> -----</div><div class="insert">When you create a new application using **admin**, it starts as a clone of the &quot;welcome&quot; scaffolding app with a &quot;models/db.py&quot; that creates a SQLite database, connects to it, instantiates Auth, Crud, and Service, <span class="highlight">and </span>configures them. It also provides a &quot;controller/default.py&quot; which exposes actions &quot;index&quot;, &quot;download&quot;, &quot;user&quot; for user management, and &quot;call&quot; for services. In the following, we assume that these files have been removed; we will be creating apps from scratch.</div><div class=""> -----</div><div class=""> </div><div class=""> web2py also comes with a **wizard**, described later in this chapter, that can write an alternate scaffolding code for you based on layouts and plugins available on the web and based on high level description of the models.</div><div class=""> </div><div class=""> ### Simple examples</div><div class=""> </div><div class=""> #### Say hello</div><div class=""> ``index``:inxx</div><div class=""> </div><div class=""> Here, as an example, we create a simple web app that displays the message &quot;Hello from MyApp&quot; to the user. We will call this application &quot;myapp&quot;. We will also add a counter that counts how many times the same user visits the page.</div><div class=""> </div><div class=""> You can create a new application simply by typing its name in the form on the top right of the **site** page in **admin**.</div><div class=""> </div><div class=""> [[image @///image/en800.png center 447px]]</div><div class=""> </div><div class=""> After you press [create], the application is created as a copy of the built-in welcome application.</div><div class=""> </div><div class=""> [[image @///image/en900.png center 480px]]</div><div class=""> </div><div class=""> To run the new application, visit:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/myapp</div><div class=""> ``:code</div><div class=""> </div><div class=""> Now you have a copy of the welcome application.</div><div class=""> </div><div class=""> To edit an application, click on the &#x27;&#x27;edit&#x27;&#x27; button for the newly created application.</div><div class=""> </div><div class=""> The **edit** page tells you what is inside the application.</div><div class=""> Every web2py application consists of certain files, most of which fall into one of six categories:</div><div class=""> - **models**: describe the data representation.</div><div class=""> - **controllers**: describe the application logic and workflow.</div><div class=""> - **views**: describe the data presentation.</div><div class=""> - **languages**: describe how to translate the application presentation to other languages.</div><div class=""> - **modules**: Python modules that belong to the application.</div><div class=""> - **static files**: static images, CSS  files``css-w,css-o,css-school``:cite , JavaScript files``js-w,js-b``:cite , etc.</div><div class=""> - **plugins**: groups of files designed to work together.</div><div class=""> </div><div class=""> Everything is neatly organized following the Model-View-Controller design pattern. Each section in the &#x27;&#x27;edit&#x27;&#x27; page corresponds to a subfolder in the application folder.</div><div class=""> </div><div class="insert">Notice that<span class="highlight"> clicking on</span> section headings will toggle their content. Folder names under static files are also collapsible.</div><div class=""> </div><div class=""> -------</div><div class=""> Each file listed in the section corresponds to a file physically located in the subfolder. Any operation performed on a file via the **admin** interface (create, edit, delete) can be performed directly from the shell using your favorite editor.</div><div class=""> -------</div><div class=""> </div><div class=""> The application contains other types of files (database, session files, error files, etc.), but they are not listed on the &#x27;&#x27;edit&#x27;&#x27; page because they are not created or modified by the administrator; they are created and modified by the application itself.</div><div class=""> </div><div class=""> The controllers contain the logic and workflow of the application. Every URL gets mapped into a call to one of the functions in the controllers (actions). There are two default controllers: &quot;appadmin.py&quot; and &quot;default.py&quot;. **appadmin** provides the database administrative interface; we do not need it now. &quot;default.py&quot; is the controller that you need to edit, the one that is called by default when no controller is specified in the URL. Edit the &quot;index&quot; function as follows:</div><div class=""> ``</div><div class=""> def index():</div><div class="">     return &quot;Hello from MyApp&quot;</div><div class=""> ``:code</div><div class=""> </div><div class=""> Here is what the online editor looks like:</div><div class=""> </div><div class=""> [[image @///image/en1000.png center 480px]]</div><div class=""> </div><div class=""> Save it and go back to the &#x27;&#x27;edit&#x27;&#x27; page. Click on the index link to visit the newly created page.</div><div class=""> </div><div class=""> When you visit the URL</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/myapp/default/index</div><div class=""> ``:code</div><div class=""> </div><div class=""> the index action in the default controller of the myapp application is called. It returns a string that the browser displays for us. It should look like this:</div><div class=""> </div><div class=""> [[image @///image/en1100.png center 480px]]</div><div class=""> </div><div class=""> Now, edit the &quot;index&quot; function as follows:</div><div class=""> ``</div><div class=""> def first():</div><div class=""> </div><div class=""> The ``form`` object can be easily serialized in HTML by embedding it in the &quot;default/first.html&quot; view.</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> {{=form}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> The ``form.process()`` method applies the validators and returns the form itself. The ``form.accepted`` variable is set to True if the form was processed and passed validation. If the self-submitted form passes validation, it stores the variables in the session and redirects as before. If the form does not pass validation, error messages are inserted into the form and shown to the user, as below:</div><div class=""> </div><div class=""> [[image @///image/en1800.png center 480px]]</div><div class=""> </div><div class=""> In the next section we will show how forms can be generated automatically from a model.</div><div class=""> </div><div class=""> In all or examples we have used the session to pass the user name from the first action to the second. We could have used a different mechanism and pass data as part of a redirect URL:</div><div class=""> </div><div class=""> ``</div><div class=""> def first():</div><div class="">     form = SQLFORM.factory(Field(&#x27;visitor_name&#x27;, requires=IS_NOT_EMPTY()))</div><div class="">     if form.process().accepted:</div><div class="">         name = form.vars.visitor_name</div><div class="">         redirect(URL(&#x27;second&#x27;,vars=dict(name=name)))</div><div class="">     return dict(form=form)</div><div class=""> </div><div class=""> def second():</div><div class="">     name = request.vars.visitor_name or redirect(URL(&#x27;first&#x27;))</div><div class="">     return dict(name=name)</div><div class=""> ``:code</div><div class=""> </div><div class=""> #### Internationalization</div><div class=""> </div><div class="insert">You<span class="highlight">r</span> code is likely to include hardcoded strings such as &quot;What is your name?&quot;. You should be able to customize strings without editing the code and in particular insert translations for these strings in different languages. In this way if a visitor has the language preference of the browser set to &quot;Italian&quot;, web2py will use the Italian translation for the strings, if available. This feature of web2py is called &quot;internationalization&quot; and it is described in more detail in the next chapter.</div><div class=""> </div><div class="insert">Here we just observe that in order to use this feature you should markup strings that needs translation. This is done by wrapping a <span class="highlight"></span>quoted string in code such as</div><div class=""> </div><div class=""> ``</div><div class=""> &quot;What is your name?&quot;</div><div class=""> ``:code</div><div class=""> </div><div class=""> with the ``T`` operator:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;What is your name?&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class="insert">You can also mark fo<span class="highlight">r</span> translations strings hardcoded in views. For example</div><div class=""> </div><div class=""> ``</div><div class=""> &lt;h1&gt;What is your name?&lt;/h1&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> becomes</div><div class=""> </div><div class=""> ``</div><div class=""> &lt;h1&gt;{{=T(&quot;What is your name?&quot;)}}&lt;/h1&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> It is good practice to do this for every string in the code (field labels, flash messages, etc.) except for tables and field names.</div><div class=""> </div><div class=""> Once the strings are identified and marked up, web2py takes care of almost everything else. The admin interface also provides a page where you can translate each string in the languages you desire to support.</div><div class=""> </div><div class=""> ### An image blog</div><div class=""> ``upload``:inxx</div><div class=""> </div><div class=""> Here, as another example, we wish to create a web application that allows the administrator to post images and give them a name, and allows the visitors of the web site to view the named images and submit comments (posts).</div><div class=""> </div><div class=""> As before, from the **site** page in **admin**, create a new application called ``images``, and navigate to the &#x27;&#x27;edit&#x27;&#x27; page:</div><div class=""> </div><div class=""> [[image @///image/en1900.png center 480px]]</div><div class=""> </div><div class=""> We start by creating a model, a representation of the persistent data in the application (the images to upload, their names, and the comments). First, you need to create/edit a model file which, for lack of imagination, we call &quot;db.py&quot;. We assume the code below will replace any existing code in &quot;db.py&quot;. Models and controllers must have a ``.py`` extension since they are Python code. If the extension is not provided, it is appended by web2py. Views instead have a ``.html`` extension since they mainly contain HTML code.</div><div class=""> </div><div class=""> Edit the &quot;db.py&quot; file by clicking the corresponding &quot;edit&quot; button:</div><div class=""> </div><div class=""> [[image @///image/en2000.png center 480px]]</div><div class=""> </div><div class=""> and enter the following:</div><div class=""> </div><div class=""> ``IS_EMAIL``:inxx ``IS_NOT_EMPTY``:inxx ``IS_IN_DB``:inxx</div><div class=""> ``</div><div class=""> db = DAL(&quot;sqlite://storage.sqlite&quot;)</div><div class=""> </div><div class=""> db.define_table(&#x27;image&#x27;,</div><div class="">    Field(&#x27;title&#x27;, unique=True),</div><div class="">    Field(&#x27;file&#x27;, &#x27;upload&#x27;),</div><div class="">    format = &#x27;%(title)s&#x27;)</div><div class=""> </div><div class=""> db.define_table(&#x27;post&#x27;,</div><div class="">    Field(&#x27;image_id&#x27;, &#x27;reference image&#x27;),</div><div class="">    Field(&#x27;author&#x27;),</div><div class="">    Field(&#x27;email&#x27;),</div><div class="">    Field(&#x27;body&#x27;, &#x27;text&#x27;))</div><div class=""> </div><div class=""> db.image.title.requires = IS_NOT_IN_DB(db, db.image.title)</div><div class=""> db.post.image_id.requires = IS_IN_DB(db, db.image.id, &#x27;%(title)s&#x27;)</div><div class=""> db.post.author.requires = IS_NOT_EMPTY()</div><div class=""> db.post.email.requires = IS_EMAIL()</div><div class=""> db.post.body.requires = IS_NOT_EMPTY()</div><div class=""> </div><div class=""> db.post.image_id.writable = db.post.image_id.readable = False</div><div class=""> ``:code</div><div class=""> </div><div class=""> Let&#x27;s analyze this line by line.</div><div class=""> </div><div class="insert">Line 1 defines a global variable called ``db`` that represents the database connection. In this case it is a connection to a SQLite database stored in the file  &quot;applications/images/databases/storage.sqlite&quot;. <span class="highlight">When using</span> SQLite<span class="highlight"></span>, if the database <span class="highlight">file </span>does not exist, it is created. You can change the name of the file, as well as the name of the global variable ``db``, but it is convenient to give them the same name, to make it easy to remember.</div><div class=""> </div><div class=""> Lines 3-5 define a table &quot;image&quot;. ``define_table`` is a method of the ``db`` object. The first argument, &quot;image&quot;, is the name of the table we are defining. The other arguments are the fields belonging to that table. This table has a field called &quot;title&quot;, a field called &quot;file&quot;, and a field called &quot;id&quot; that serves as the table primary key (&quot;id&quot; is not explicitly declared because all tables have an id field by default). The field &quot;title&quot; is a string, and the field &quot;file&quot; is of type &quot;upload&quot;. &quot;upload&quot; is a special type of field used by the web2py Data Abstraction Layer (DAL) to store the names of uploaded files. web2py knows how to upload files (via streaming if they are large), rename them safely, and store them.</div><div class=""> </div><div class=""> When a table is defined, web2py takes one of several possible actions:</div><div class=""> - if the table does not exist, the table is created;</div><div class=""> - if the table exists and does not correspond to the definition, the table is altered accordingly, and if a field has a different type, web2py tries to convert its contents;</div><div class=""> - if the table exists and corresponds to the definition, web2py does nothing.</div><div class=""> </div><div class=""> This behavior is called &quot;migration&quot;. In web2py migrations are automatic, but can be disabled for each table by passing ``migrate=False`` as the last argument of ``define_table``.</div><div class=""> </div><div class=""> Line 6 defines a format string for the table. It determines how a record should be represented as a string. Notice that the ``format`` argument can also be a function that takes a record and returns a string. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> format=lambda row: row.title</div><div class=""> ``:code</div><div class=""> </div><div class=""> Lines 8-12 define another table called &quot;post&quot;.</div><div class=""> A post has an &quot;author&quot;, an &quot;email&quot; (we intend to store the email address of the author of the post), a &quot;body&quot; of type &quot;text&quot; (we intend to use it to store the actual comment posted by the author), and an &quot;image_id&quot; field of type reference that points to ``db.image`` via the &quot;id&quot; field.</div><div class=""> </div><div class=""> In line 14, ``db.image.title`` represents the field &quot;title&quot; of table &quot;image&quot;. The attribute ``requires`` allows you to set requirements/constraints that will be enforced by web2py forms. Here we require that the &quot;title&quot; is unique:</div><div class=""> </div><div class=""> ``IS_NOT_IN_DB(db, db.image.title)``:code</div><div class=""> </div><div class=""> &#x27;&#x27;Notice this is optional because it is set automatically given that ``Field(&#x27;title&#x27;, unique=True)``&#x27;&#x27;.</div><div class=""> </div><div class=""> The objects representing these constraints are called validators. Multiple validators can be grouped in a list. Validators are executed in the order they appear.</div><div class=""> ``IS_NOT_IN_DB(a, b)`` is a special validator that checks that the value of a field ``b`` for a new record is not already in ``a``.</div><div class=""> </div><div class=""> Line 15 requires that the field &quot;image_id&quot; of table &quot;post&quot; is in ``db.image.id``. As far as the database is concerned, we had already declared this  when we defined the table &quot;post&quot;.</div><div class=""> Now we are explicitly telling the model that this condition should be enforced by web2py, too, at the form processing level when a new comment is posted, so that invalid values do not propagate from input forms to the database. We also require that the &quot;image_id&quot; be represented by the &quot;title&quot;, ``&#x27;%(title)s&#x27;``, of the corresponding record.</div><div class=""> </div><div class="insert">Line 20 indicates that the field &quot;image_id&quot; of table &quot;post&quot; should not be shown in forms, ``writable=False`` and not even in read<span class="highlight">-</span>only forms, ``readable=False``.</div><div class=""> </div><div class=""> The meaning of the validators in lines 15-17 should be obvious.</div><div class=""> </div><div class=""> ``format``:inxx</div><div class=""> Notice that the validator</div><div class=""> ``</div><div class=""> db.post.image_id.requires = IS_IN_DB(db, db.image.id, &#x27;%(title)s&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> can be omitted (and would be automatic) if we specify a format for referenced table:</div><div class=""> ``</div><div class=""> db.define_table(&#x27;image&#x27;, ..., format=&#x27;%(title)s&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> where the format can be a string or a function that takes a record and returns a string.</div><div class=""> </div><div class=""> ``appadmin``:inxx</div><div class=""> Once a model is defined, if there are no errors, web2py creates an application administration interface to manage the database. You access it via the &quot;database administration&quot; link in the &#x27;&#x27;edit&#x27;&#x27; page or directly:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/appadmin</div><div class=""> ``:code</div><div class=""> </div><div class=""> Here is a screenshot of the **appadmin** interface:</div><div class=""> </div><div class=""> [[image @///image/en2100.png center 480px]]</div><div class=""> </div><div class=""> This interface is coded in the controller called &quot;appadmin.py&quot; and the corresponding view &quot;appadmin.html&quot;. From now on, we will refer to this interface simply as **appadmin**. It allows the administrator to insert new database records, edit and delete existing records, browse tables, and perform database joins.</div><div class=""> </div><div class=""> The first time **appadmin** is accessed, the model is executed and the tables are created. The web2py DAL translates Python code into SQL statements that are specific to the selected database back-end (SQLite in this example). You can see the generated SQL from the &#x27;&#x27;edit&#x27;&#x27; page by clicking on the &quot;sql.log&quot; link under &quot;models&quot;. Notice that the link is not present until the tables have been created.</div><div class=""> </div><div class=""> [[image @///image/en2200.png center 480px]]</div><div class=""> </div><div class=""> If you were to edit the model and access **appadmin** again, web2py would generate SQL to alter the existing tables. The generated SQL is logged into &quot;sql.log&quot;.</div><div class=""> </div><div class=""> Now go back to **appadmin** and try to insert a new image record:</div><div class=""> </div><div class=""> [[image @///image/en2300.png center 480px]]</div><div class=""> </div><div class=""> web2py has translated the ``db.image.file`` &quot;upload&quot; field into an upload form for the file. When the form is submitted and an image file is uploaded, the file is renamed in a secure way that preserves the extension, it is saved with the new name under the application &quot;uploads&quot; folder, and the new name is stored in the ``db.image.file`` field. This process is designed to prevent directory traversal attacks.</div><div class=""> </div><div class=""> Notice that each field type is rendered by a &#x27;&#x27;widget&#x27;&#x27;. Default widgets can be overridden.</div><div class=""> </div><div class=""> When you click on a table name in **appadmin**, web2py performs a select of all records on the current table, identified by the DAL query</div><div class=""> ``</div><div class=""> db.image.id &gt; 0</div><div class=""> ``:code</div><div class=""> </div><div class=""> and renders the result.</div><div class=""> </div><div class=""> [[image @///image/en2400.png center 480px]]</div><div class=""> </div><div class="insert">You can select a different set of records by editing the <span class="highlight">DA</span>L query and pressing [Submit].</div><div class=""> </div><div class=""> To edit or delete a single record, click on the record id number.</div><div class=""> </div><div class=""> Because of the ``IS_IN_DB`` validator, the reference field &quot;image_id&quot; is rendered by a drop-down menu. The items in the drop-down are stored as keys (``db.image.id``), but are represented by their ``db.image.title``, as specified by the validator.</div><div class=""> </div><div class=""> Validators are powerful objects that know how to represent fields, filter field values, generate errors, and format values extracted from the field.</div><div class=""> </div><div class=""> The following figure shows what happens when you submit a form that does not pass validation:</div><div class=""> </div><div class=""> [[image @///image/en2500.png center 480px]]</div><div class=""> </div><div class=""> The same forms that are automatically generated by **appadmin** can also be generated programmatically via the ``SQLFORM`` helper and embedded in user applications. These forms are CSS-friendly, and can be customized.</div><div class=""> </div><div class=""> Every application has its own **appadmin**; therefore, **appadmin** itself can be modified without affecting other applications.</div><div class=""> </div><div class=""> So far, the application knows how to store data, and we have seen how to access the database via **appadmin**. Access to **appadmin** is restricted to the administrator, and it is not intended as a production web interface for the application; hence the next part of this walk-through. Specifically we want to create:</div><div class=""> - An &quot;index&quot; page that lists all available images sorted by title and links to detail pages for the images.</div><div class=""> - A &quot;show/[id]&quot; page that shows the visitor the requested image and allows the visitor to view and post comments.</div><div class=""> - A &quot;download/[name]&quot; action to download uploaded images.</div><div class=""> </div><div class=""> This is represented schematically here:</div><div class=""> </div><div class=""> [[yUML diagram @///image/en2600.png center 480px]]</div><div class=""> </div><div class=""> Go back to the &#x27;&#x27;edit&#x27;&#x27; page and edit the &quot;default.py&quot; controller, replacing its contents with the following:</div><div class=""> </div><div class=""> ``select``:inxx</div><div class=""> ``</div><div class=""> def index():</div><div class="">     images = db().select(db.image.ALL, orderby=db.image.title)</div><div class=""> Let&#x27;s edit the &quot;default.py&quot; controller and replace its content with:</div><div class=""> ``</div><div class=""> def index():</div><div class="">     images = db().select(db.image.ALL, orderby=db.image.title)</div><div class="">     return dict(images=images)</div><div class=""> </div><div class=""> def show():</div><div class="">     image = db.image(request.args(0,cast=int)) or redirect(URL(&#x27;index&#x27;))</div><div class="">     db.post.image_id.default = image.id</div><div class="">     form = SQLFORM(db.post)</div><div class="">     if form.process().accepted:</div><div class="">         response.flash = &#x27;your comment is posted&#x27;</div><div class="">     comments = db(db.post.image_id==image.id).select()</div><div class="">     return dict(image=image, comments=comments, form=form)</div><div class=""> </div><div class=""> def download():</div><div class="">     return response.download(request, db)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The controller contains two actions: &quot;show&quot; and &quot;download&quot;.</div><div class=""> The &quot;show&quot; action selects the image with the ``id`` parsed from the request args and all comments related to the image. &quot;show&quot; then passes everything to the view &quot;default/show.html&quot;.</div><div class=""> </div><div class=""> The image id referenced by:</div><div class=""> ``</div><div class=""> URL(&#x27;show&#x27;, args=image.id)</div><div class=""> ``:code</div><div class=""> </div><div class=""> in &quot;default/index.html&quot;, can be accessed as:</div><div class=""> </div><div class=""> ``request.args(0,cast=int)``</div><div class=""> </div><div class="insert">from the &quot;show&quot; action. The ``cast=int`` argument is optional but very important. It attempts to cast the string value passed in the PATH_INFO into an int. On failure it raise<span class="highlight">s</span> a proper exception instead of causing a ticket. One can also specify a redirect in case of failure to cast:</div><div class=""> </div><div class=""> ``request.args(0,cast=int,otherwise=URL(&#x27;error&#x27;))``</div><div class=""> </div><div class=""> Moreover ``db.image(...)`` is a shortcut for</div><div class=""> </div><div class=""> ``</div><div class=""> db(db.image.id==...).select().first()</div><div class=""> ``:code</div><div class=""> </div><div class=""> The &quot;download&quot; action expects a filename in ``request.args(0)``, builds a path to the location where that file is supposed to be, and sends it back to the client. If the file is too large, it streams the file without incurring any memory overhead.</div><div class=""> </div><div class=""> Notice the following statements:</div><div class=""> - Line 7 creates an insert form SQLFORM for the ``db.post`` table using only the specified fields.</div><div class=""> - Line 8 sets the value for the reference field, which is not part of the input form because it is not in the list of fields specified above.</div><div class=""> - Line 9 processes the submitted form (the submitted form variables are in ``request.vars``) within the current session (the session is used to prevent double submissions, and to enforce navigation). If the submitted form variables are validated, the new comment is inserted in the ``db.post`` table; otherwise the form is modified to include error messages (for example, if the author&#x27;s email address is invalid). This is all done in line 9!.</div><div class=""> - Line 10 is only executed if the form is accepted, after the record is inserted into the database table. ``response.flash`` is a web2py variable that is displayed in the views and used to notify the visitor that something happened.</div><div class=""> - Line 11 selects all comments that reference the current image.</div><div class=""> </div><div class=""> -------</div><div class=""> The &quot;download&quot; action is already defined in the &quot;default.py&quot; controller of the scaffolding application.</div><div class=""> -------</div><div class=""> </div><div class=""> The &quot;download&quot; action does not return a dictionary, so it does not need a view. The &quot;show&quot; action, though, should have a view, so return to **admin** and create a new view called &quot;default/show.html&quot;.</div><div class=""> </div><div class=""> Edit this new file and replace its content with the following:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Image: {{=image.title}}&lt;/h1&gt;</div><div class=""> &lt;center&gt;</div><div class=""> &lt;img width=&quot;200px&quot;</div><div class=""> db.define_table(&#x27;post&#x27;,</div><div class="">     Field(&#x27;body&#x27;, &#x27;text&#x27;),</div><div class="">     Field(&#x27;created_on&#x27;, &#x27;datetime&#x27;, default=request.now),</div><div class="">     Field(&#x27;created_by&#x27;, &#x27;reference auth_user&#x27;, default=auth.user_id))</div><div class=""> </div><div class=""> db.define_table(&#x27;document&#x27;,</div><div class="">     Field(&#x27;page_id&#x27;, &#x27;reference page&#x27;),</div><div class="">     Field(&#x27;name&#x27;),</div><div class="">     Field(&#x27;file&#x27;, &#x27;upload&#x27;),</div><div class="">     Field(&#x27;created_on&#x27;, &#x27;datetime&#x27;, default=request.now),</div><div class="">     Field(&#x27;created_by&#x27;, &#x27;reference auth_user&#x27;, default=auth.user_id),</div><div class="">     format=&#x27;%(name)s&#x27;)</div><div class=""> </div><div class=""> db.page.title.requires = IS_NOT_IN_DB(db, &#x27;page.title&#x27;)</div><div class=""> db.page.body.requires = IS_NOT_EMPTY()</div><div class=""> db.page.created_by.readable = db.page.created_by.writable = False</div><div class=""> db.page.created_on.readable = db.page.created_on.writable = False</div><div class=""> </div><div class=""> db.post.body.requires = IS_NOT_EMPTY()</div><div class=""> db.post.page_id.readable = db.post.page_id.writable = False</div><div class=""> db.post.created_by.readable = db.post.created_by.writable = False</div><div class=""> db.post.created_on.readable = db.post.created_on.writable = False</div><div class=""> </div><div class=""> db.document.name.requires = IS_NOT_IN_DB(db, &#x27;document.name&#x27;)</div><div class=""> db.document.page_id.readable = db.document.page_id.writable = False</div><div class=""> db.document.created_by.readable = db.document.created_by.writable = False</div><div class=""> db.document.created_on.readable = db.document.created_on.writable = False</div><div class=""> ``:code</div><div class=""> </div><div class=""> Edit the controller &quot;default.py&quot; and create the following actions:</div><div class=""> - index: list all wiki pages</div><div class="insert">+- create: add a new wiki page</div><div class="insert">+- show: show a wiki page and its comments, and add new comments</div><div class=""> - edit: edit an existing page</div><div class=""> - documents: manage the documents attached to a page</div><div class=""> - download: download a document (as in the images example)</div><div class=""> - search: display a search box and, via an Ajax callback, return all matching titles as the visitor types</div><div class=""> - callback: the Ajax callback function. It returns the HTML that gets embedded in the search page while the visitor types.</div><div class=""> </div><div class=""> Here is the &quot;default.py&quot; controller:</div><div class=""> ``</div><div class=""> def index():</div><div class="">      &quot;&quot;&quot; this controller returns a dictionary rendered by the view</div><div class="">          it lists all wiki pages</div><div class="">      &gt;&gt;&gt; index().has_key(&#x27;pages&#x27;)</div><div class="">      True</div><div class="">      &quot;&quot;&quot;</div><div class="">      pages = db().select(db.page.id,db.page.title,orderby=db.page.title)</div><div class="">      return dict(pages=pages)</div><div class=""> </div><div class=""> @auth.requires_login()</div><div class=""> def create():</div><div class="insert">     <span class="highlight">&quot;&quot;</span>&quot;creates a new empty wiki page&quot;<span class="highlight">&quot;&quot;</span></div><div class="">      form = SQLFORM(db.page).process(next=URL(&#x27;index&#x27;))</div><div class="">      return dict(form=form)</div><div class=""> </div><div class=""> def show():</div><div class="insert">     <span class="highlight">&quot;&quot;</span>&quot;shows a wiki page&quot;<span class="highlight">&quot;&quot;</span></div><div class="">      this_page = db.page(request.args(0,cast=int)) or redirect(URL(&#x27;index&#x27;))</div><div class="">      db.post.page_id.default = this_page.id</div><div class="">      form = SQLFORM(db.post).process() if auth.user else None</div><div class="">      pagecomments = db(db.post.page_id==this_page.id).select()</div><div class="">      return dict(page=this_page, comments=pagecomments, form=form)</div><div class=""> </div><div class=""> @auth.requires_login()</div><div class=""> def edit():</div><div class="insert">     <span class="highlight">&quot;&quot;</span>&quot;edit an existing wiki page&quot;<span class="highlight">&quot;&quot;</span></div><div class="">      this_page = db.page(request.args(0,cast=int)) or redirect(URL(&#x27;index&#x27;))</div><div class="">      form = SQLFORM(db.page, this_page).process(</div><div class="">          next = URL(&#x27;show&#x27;,args=request.args))</div><div class="">      return dict(form=form)</div><div class=""> </div><div class=""> @auth.requires_login()</div><div class=""> def documents():</div><div class="insert">     <span class="highlight">&quot;&quot;</span>&quot;browser, edit all documents attached to a certain page&quot;<span class="highlight">&quot;&quot;</span></div><div class="">      page = db.page(request.args(0,cast=int)) or redirect(URL(&#x27;index&#x27;))</div><div class="">      db.document.page_id.default = page.id</div><div class="">      db.document.page_id.writable = False</div><div class="">      grid = SQLFORM.grid(db.document.page_id==page.id,args=[page.id])</div><div class="">      return dict(page=page, grid=grid)</div><div class=""> </div><div class=""> def user():</div><div class="">      return dict(form=auth())</div><div class=""> </div><div class=""> def download():</div><div class="insert">     <span class="highlight">&quot;&quot;</span>&quot;allows downloading of documents&quot;<span class="highlight">&quot;&quot;</span></div><div class="">      return response.download(request, db)</div><div class=""> </div><div class=""> def search():</div><div class="insert">     <span class="highlight">&quot;&quot;</span>&quot;an ajax wiki search page&quot;<span class="highlight">&quot;&quot;</span></div><div class="">      return dict(form=FORM(INPUT(_id=&#x27;keyword&#x27;,_name=&#x27;keyword&#x27;,</div><div class="">               _onkeyup=&quot;ajax(&#x27;callback&#x27;, [&#x27;keyword&#x27;], &#x27;target&#x27;);&quot;)),</div><div class="">               target_div=DIV(_id=&#x27;target&#x27;))</div><div class=""> </div><div class=""> def callback():</div><div class="insert">     <span class="highlight">&quot;&quot;</span>&quot;an ajax callback that returns a &lt;ul&gt; of links to wiki pages&quot;<span class="highlight">&quot;&quot;</span></div><div class="">      query = db.page.title.contains(request.vars.keyword)</div><div class="">      pages = db(query).select(orderby=db.page.title)</div><div class="">      links = [A(p.title, _href=URL(&#x27;show&#x27;,args=p.id)) for p in pages]</div><div class="">      return UL(*links)</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> Lines 2-6 provide a comment for the index action. Lines 4-5 inside the comment are interpreted by python as test code (doctest). Tests can be run via the admin interface. In this case the tests verify that the index action runs without errors.</div><div class=""> </div><div class=""> Lines 18, 27, and 35 try to fetch a ``page`` record with the id in</div><div class=""> ``request.args(0)``.</div><div class=""> </div><div class="insert">Lines 13, 20 define and process create forms for a new page and a new comment and<span class="highlight"></span></div><div class=""> </div><div class=""> Line 28 defines and processes an update form for a wiki page.</div><div class=""> </div><div class="insert">Line 38 creates a ``grid`` object that allows to <span class="highlight">vie</span>w<span class="highlight"></span>, add and update the comments linked to a page.</div><div class=""> </div><div class=""> Some magic happens in line 51. The ``onkeyup`` attribute of the INPUT tag &quot;keyword&quot; is set. Every time the visitor releases a key, the JavaScript code inside the ``onkeyup`` attribute is executed, client-side. Here is the JavaScript code:</div><div class=""> ``</div><div class=""> ajax(&#x27;callback&#x27;, [&#x27;keyword&#x27;], &#x27;target&#x27;);</div><div class=""> ``:code</div><div class=""> ``ajax`` is a JavaScript function defined in the file &quot;web2py.js&quot; which is included by the default &quot;layout.html&quot;. It takes three parameters: the URL of the action that performs the synchronous callback, a list of the IDs of variables to be sent to the callback ([&quot;keyword&quot;]), and the ID where the response has to be inserted (&quot;target&quot;).</div><div class=""> </div><div class=""> As soon as you type something in the search box and release a key, the client calls the server and sends the content of the &#x27;keyword&#x27; field, and, when the sever responds, the response is embedded in the page itself as the innerHTML of the &#x27;target&#x27; tag.</div><div class=""> </div><div class=""> The &#x27;target&#x27; tag is a DIV defined in line 52. It could have been defined in the view as well.</div><div class=""> </div><div class=""> Here is the code for the view &quot;default/create.html&quot;:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Create new wiki page&lt;/h1&gt;</div><div class=""> {{=form}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> Assuming you are registered and logged in, if you visit the **create** page, you see the following:</div><div class=""> </div><div class=""> [[image @///image/en3500.png center 480px]]</div><div class=""> </div><div class=""> Here is the code for the view &quot;default/index.html&quot;:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Available wiki pages&lt;/h1&gt;</div><div class=""> [ {{=A(&#x27;search&#x27;, _href=URL(&#x27;search&#x27;))}} ]&lt;br /&gt;</div><div class=""> &lt;ul&gt;{{for page in pages:}}</div><div class="">      {{=LI(A(page.title, _href=URL(&#x27;show&#x27;, args=page.id)))}}</div><div class=""> {{pass}}&lt;/ul&gt;</div><div class=""> Here is the code for the view &quot;default/show.html&quot;:</div><div class=""> [ {{=A(&#x27;edit&#x27;, _href=URL(&#x27;edit&#x27;, args=request.args))}}</div><div class=""> | {{=A(&#x27;documents&#x27;, _href=URL(&#x27;documents&#x27;, args=request.args))}} ]&lt;br /&gt;</div><div class=""> {{=MARKMIN(page.body)}}</div><div class=""> &lt;h2&gt;Comments&lt;/h2&gt;</div><div class=""> {{for post in comments:}}</div><div class="">   &lt;p&gt;{{=db.auth_user[post.created_by].first_name}} on {{=post.created_on}}</div><div class="">      says &lt;i&gt;{{=post.body}}&lt;/i&gt;&lt;/p&gt;</div><div class=""> {{pass}}</div><div class=""> &lt;h2&gt;Post a comment&lt;/h2&gt;</div><div class=""> {{=form}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> If you wish to use markdown syntax instead of markmin syntax:</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.contrib.markdown import WIKI</div><div class=""> ``:code</div><div class=""> </div><div class=""> and use ``WIKI`` instead of the ``MARKMIN`` helper.</div><div class=""> Alternatively, you can choose to accept raw HTML instead of markmin syntax. In this case you would replace:</div><div class=""> ``</div><div class=""> {{=MARKMIN(page.body)}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> with:</div><div class=""> ``</div><div class=""> {{=XML(page.body)}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> ``sanitize``:inxx</div><div class="insert">(so that the XML does not get escaped, <span class="highlight">which web2py norm</span>a<span class="highlight">lly doe</span>s by default <span class="highlight">for s</span>e<span class="highlight">curit</span>y <span class="highlight">r</span>e<span class="highlight"></span>a<span class="highlight">s</span>o<span class="highlight">ns</span>).</div><div class=""> </div><div class=""> This can be done better with:</div><div class=""> ``</div><div class=""> {{=XML(page.body, sanitize=True)}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> By setting ``sanitize=True``, you tell web2py to escape unsafe XML tags such as &quot;&lt;script&gt;&quot;, and thus prevent XSS vulnerabilities.</div><div class=""> </div><div class=""> Now if, from the index page, you click on a page title, you can see the page that you have created:</div><div class=""> </div><div class=""> [[image @///image/en3700.png center 480px]]</div><div class=""> </div><div class=""> Here is the code for the view &quot;default/edit.html&quot;:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Edit wiki page&lt;/h1&gt;</div><div class=""> [ {{=A(&#x27;show&#x27;, _href=URL(&#x27;show&#x27;, args=request.args))}} ]&lt;br /&gt;</div><div class=""> {{=form}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> It generates a page that looks almost identical to the create page.</div><div class=""> </div><div class=""> Here is the code for the view &quot;default/documents.html&quot;:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Documents for page: {{=page.title}}&lt;/h1&gt;</div><div class=""> [ {{=A(&#x27;show&#x27;, _href=URL(&#x27;show&#x27;, args=request.args))}} ]&lt;br /&gt;</div><div class=""> &lt;h2&gt;Documents&lt;/h2&gt;</div><div class=""> {{=grid}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> If, from the &quot;show&quot; page, you click on documents, you can now manage the documents attached to the page.</div><div class=""> </div><div class=""> [[image @///image/en3800.png center 480px]]</div><div class=""> </div><div class=""> Finally here is the code for the view &quot;default/search.html&quot;:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Search wiki pages&lt;/h1&gt;</div><div class=""> [ {{=A(&#x27;listall&#x27;, _href=URL(&#x27;index&#x27;))}}]&lt;br /&gt;</div><div class=""> {{=form}}&lt;br /&gt;{{=target_div}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> which generates the following Ajax search form:</div><div class=""> </div><div class=""> [[image @///image/en3900.png center 480px]]</div><div class=""> </div><div class=""> You can also try to call the callback action directly by visiting, for example, the following URL:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/mywiki/default/callback?keyword=wiki</div><div class=""> ``:code</div><div class=""> </div><div class=""> If you look at the page source you see the HTML returned by the callback:</div><div class=""> ``</div><div class=""> &lt;ul&gt;&lt;li&gt;&lt;a href=&quot;/mywiki/default/show/4&quot;&gt;I made a Wiki&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> ``rss``:inxx</div><div class="insert">Generating an RSS feed <span class="highlight">o</span>f<span class="highlight"> you</span>r<span class="highlight"></span> <span class="highlight">wiki</span> pages using web2py is easy because web2py includes ``gluon.contrib.rss2``. Just append the following action to the default controller:</div><div class=""> ``</div><div class=""> def news():</div><div class="insert">    <span class="highlight">&quot;&quot;</span>&quot;generates rss feed form the wiki pages&quot;<span class="highlight">&quot;&quot;</span></div><div class="">     response.generic_patterns = [&#x27;.rss&#x27;]</div><div class="">     pages = db().select(db.page.ALL, orderby=db.page.title)</div><div class="">     return dict(</div><div class="">        title = &#x27;mywiki rss feed&#x27;,</div><div class="">        link = &#x27;http://127.0.0.1:8000/mywiki/default/index&#x27;,</div><div class="">        description = &#x27;mywiki news&#x27;,</div><div class="">        created_on = request.now,</div><div class="">        items = [</div><div class="">           dict(title = row.title,</div><div class="">                link = URL(&#x27;show&#x27;, args=row.id),</div><div class="">                description = MARKMIN(row.body).xml(),</div><div class="">                created_on = row.created_on</div><div class="">                ) for row in pages])</div><div class=""> ``:code</div><div class=""> </div><div class=""> and when you visit the page</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/mywiki/default/news.rss</div><div class=""> ``:code</div><div class=""> </div><div class=""> you see the feed (the exact output depends on the feed reader). Notice that the dict is automatically converted to RSS, thanks to the .rss extension in the URL.</div><div class=""> </div><div class=""> [[image @///image/en4000.png center 480px]]</div><div class=""> </div><div class=""> web2py also includes feedparser to read third-party feeds.</div><div class=""> </div><div class=""> ``XMLRPC``:inxx</div><div class=""> Finally, let&#x27;s add an XML-RPC handler that allows searching the wiki programmatically:</div><div class=""> ``</div><div class=""> service = Service()</div><div class=""> </div><div class=""> @service.xmlrpc</div><div class=""> def find_by(keyword):</div><div class="insert">     <span class="highlight">&quot;&quot;</span>&quot;finds pages that contain keyword for XML-RPC&quot;<span class="highlight">&quot;&quot;</span></div><div class="">      return db(db.page.title.contains(keyword)).select().as_list()</div><div class=""> </div><div class=""> def call():</div><div class="insert">    <span class="highlight">&quot;&quot;</span>&quot;exposes all registered services, including XML-RPC&quot;<span class="highlight">&quot;&quot;</span></div><div class="">     return service()</div><div class=""> ``:code</div><div class=""> </div><div class=""> Here, the handler action simply publishes (via XML-RPC), the functions specified in the list. In this case, ``find_by``. ``find_by`` is not an action (because it takes an argument). It queries the database with ``.select()`` and then extracts the records as a list with ``.response`` and returns the list.</div><div class=""> </div><div class=""> Here is an example of how to access the XML-RPC handler from an external</div><div class=""> Python program.</div><div class=""> ``</div><div class=""> &gt;&gt;&gt; import xmlrpclib</div><div class=""> &gt;&gt;&gt; server = xmlrpclib.ServerProxy(</div><div class="">     &#x27;http://127.0.0.1:8000/mywiki/default/call/xmlrpc&#x27;)</div><div class=""> &gt;&gt;&gt; for item in server.find_by(&#x27;wiki&#x27;):</div><div class="">         print item[&#x27;created_on&#x27;], item[&#x27;title&#x27;]</div><div class=""> ``:code</div><div class=""> </div><div class=""> The handler can be accessed from many other programming languages that understand XML-RPC, including C, C++, C# and Java.</div><div class=""> </div><div class=""> #### On ``date``, ``datetime`` and ``time`` format</div><div class=""> </div><div class="insert">There are three different representation<span class="highlight">s</span> for each of the field types ``date``, ``datetime`` and ``time``:</div><div class=""> - the database representation</div><div class="insert">- the internal web2py <span class="highlight"></span>representation</div><div class=""> - the string representation in forms and tables</div><div class=""> </div><div class=""> The database representation is an internal issue and does not affect the code. Internally, at the web2py level, they are stored as ``datetime.date``, ``datetime.datetime`` and ``datetime.time`` object respectively and they can be manipulated as such:</div><div class=""> </div><div class=""> ``</div><div class=""> for page in db(db.page).select():</div><div class="">     print page.title, page.day, page.month, page.year</div><div class=""> ``</div><div class=""> </div><div class=""> When dates are converted to strings in forms they are converted using the ISO representation</div><div class=""> ``</div><div class=""> %Y-%m-%d %H:%M:%S</div><div class=""> ``</div><div class=""> </div><div class="insert">yet this representation i<span class="highlight">s</span> internationalized and you can use the admin <span class="highlight"></span>translation page to change the format to an alternate one. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> %m/%b/%Y %H:%M:%S</div><div class=""> ``</div><div class=""> </div><div class="insert">Mind that by default English is not translated because web2py assumes the applications is already written in English. If you want internationalization to work for English you need to create the translation file (using admin) and you need <span class="highlight">to declare that the application&#x27;s</span> current language is something other than english, for example:</div><div class=""> ``</div><div class=""> T.current_languages = [&#x27;null&#x27;]</div><div class=""> ``</div><div class=""> </div><div class=""> ### The built-in web2py wiki</div><div class=""> </div><div class="insert">Now you can forget the code we have built-in the previous section (not what you have learned about web2py APIs, just the code of the specific example) as we are going to provide an<span class="highlight"></span> example of the built-in web2py wiki.</div><div class=""> </div><div class=""> In fact, web2py comes with wiki capabilities including media attachments, tags, tag cloud, page permissions, and support for oembed ``oembed``:cite and components (chapter 14). This wiki can be used with any web2py application.</div><div class=""> </div><div class=""> ------</div><div class="insert">Notice the API of the built-in wiki <span class="highlight">is</span> still considered experimental and small changes are still possible.</div><div class=""> ------</div><div class=""> </div><div class=""> Here we assume we are starting from scratch from a simple clone of the &quot;welcome&quot; application called &quot;wikidemo&quot;. Edit the controller and replace the &quot;index&quot; action with</div><div class=""> </div><div class=""> ``</div><div class=""> def index(): return auth.wiki()</div><div class=""> ``:code</div><div class=""> </div><div class="insert">Done! You have a fully working wiki. At this point no page has been created and in order to create pages you must be logged-in and you must be member of a group called &quot;wiki-editor&quot; or &quot;wiki-author&quot;. If you are logged<span class="highlight">-in</span> as administrator the &quot;wiki-editor&quot; group is created automatically and you are made a member. The difference between editors and authors is that the editors can create pages, edit and delete any page, while the authors can create pages (with some optional restrictions) and can only edit/delete the pages they have created.</div><div class=""> </div><div class="insert">The ``auth.wiki()`` function returns in a dictionary with a key ``content`` which is understood by the scaffolding &quot;views/default/index.html&quot;. You <span class="highlight">c</span>an make your own view for this action:</div><div class=""> </div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> {{=content}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> and add extra HTML or code as needed. There is no need to call the action &quot;index&quot;.</div><div class=""> </div><div class=""> To try the wiki, simply login into admin, visit the page</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index</div><div class=""> ``</div><div class=""> </div><div class="insert">Then choose a slug (in the publishing business, a slug is a short name given to an article that is in production) and you will be redirected to an empty page where you can edit the content using MARKMIN wiki syntax. A new menu item called &quot;[wiki]&quot; will allow you <span class="highlight">to </span>create, search, and edit pages. Wiki pages have <span class="highlight">U</span>R<span class="highlight"></span>L<span class="highlight">s</span> like:</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/[slug]</div><div class=""> ``</div><div class=""> </div><div class=""> Service pages have names which start by underscore:</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_create</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_search</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_could</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_recent</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_edit/...</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_editmedia/...</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_preview/...</div><div class=""> ``</div><div class=""> </div><div class="insert">+Try creating more pages such as &quot;index&quot;, &quot;aboutus&quot;, and &quot;contactus&quot;.</div><div class="insert">+Try editing them.</div><div class=""> </div><div class=""> </div><div class=""> The ``wiki`` method has the following signature:</div><div class=""> </div><div class=""> ``</div><div class=""> def wiki(self, slug=None, env=None, render=&#x27;markmin&#x27;,</div><div class="">          manage_permissions=False, force_prefix=&#x27;&#x27;,</div><div class="">          restrict_search=False, resolve=True,</div><div class="">          extra=None, menugroups=None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> It takes the following arguments:</div><div class=""> </div><div class="insert">+- ``render`` which defaults to ``&#x27;markmin&#x27;`` but can be set equal to ``&#x27;html&#x27;``. It determines the syntax of the wiki. We will discuss the markmin wiki markup later. If you change it to HTML you may want to use a wysiwyg javascript editor such as TinyMCE or NicEdit.</div><div class="insert">+- ``manage_permissions``. This is set to ``False`` by default and only recognizes permissions for &quot;wiki-editor&quot; and &quot;wiki-author&quot;. If you change it to ``True`` the create/edit page will give the option to specify by names the group(s) whose members have permission to read and edit the page. In this case is a group &quot;everybody&quot; to give read permission to everybody.</div><div class="insert">+- ``force_prefix``. If set to something like ``&#x27;%(id)s-&#x27;`` it will restrict authors (not editors) to creating pages with a prefix like &quot;[user id]-[page name]&quot;. The prefix can contain the id (&quot;%(id)s&quot;) or the username (&quot;%(username)s&quot;) or any other field from the auth_user table, as long as the corresponding column contains valid string that would pass URL validation.</div><div class="insert">+- ``restrict_search``. This defaults to ``False`` and any logged-in user can search all wiki pages (but not necessary read or edit them). If set to ``True``, authors can search only their own pages, editors can search everything, other users cannot search anything.</div><div class="insert">+- ``menugroups``. This defaults to ``None`` and it indicates that wiki management menu (search, create, edit, etc.) is always displayed. You can set it to a list of group names whose members only can see this menu, for example ``[&#x27;wiki-editor&#x27;,&#x27;wiki-author&#x27;]``. Notice that even if the menu is exposed to everybody that does not mean everybody is allowed to perform actions listed in the menu since they are regulated by the access control system.</div><div class=""> </div><div class=""> The ``wiki`` method has some additional parameters which will be explained later: ``slug``, ``env``, and ``extra``.</div><div class=""> </div><div class=""> </div><div class=""> </div><div class=""> #### MARKMIN basics</div><div class=""> </div><div class="insert">The MARKMIN syntax allows you to markup **bold** text using ``**bold**``, &#x27;&#x27;italic&#x27;&#x27; text with ``&#x27;&#x27;italic&#x27;&#x27;``, ``code`` text with ``\`\`code\`\```. Titles must be prefixed by a #, sections by ##, and sub-sections by ###. Use a minus(-) to prefix an un-ordered item and plus(+) to prefix an ordered item. URLs are automatically <span class="highlight">converted </span>into links. For example:</div><div class=""> </div><div class=""> ``</div><div class="insert"># This is <span class="highlight">a </span>title</div><div class=""> ## this is a section title</div><div class=""> ### this is a subsection title</div><div class=""> </div><div class=""> Text can be **bold**, &#x27;&#x27;italic&#x27;&#x27;, !`!!`!code!`!!`! etc.</div><div class=""> Learn more at:</div><div class=""> </div><div class=""> http://web2py.com</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> You can use the ``extra`` parameter of ``auth.wiki`` to pass extra rendering rules to the MARKMIN helper.</div><div class=""> </div><div class=""> You can find more information about the MARKMIN syntax in chapter 5.</div><div class=""> </div><div class=""> ``auth.wiki`` is more powerful than the barebones MARKMIN helpers, supporting oembed and components.</div><div class=""> </div><div class="insert">You can use the<span class="highlight"></span> ``env`` parameter of ``auth.wiki`` to expose functions to your wiki.</div><div class=""> For example:</div><div class=""> </div><div class=""> ``</div><div class=""> auth.wiki(env=dict(join=lambda a,b,c:&quot;%s-%s-%s&quot; % (a,b,c)))</div><div class=""> ``</div><div class=""> </div><div class=""> allows you to use the markup syntax:</div><div class=""> </div><div class=""> ``</div><div class=""> @(join:1,2,3)</div><div class=""> ``</div><div class=""> </div><div class=""> </div><div class="insert">This call<span class="highlight">s</span> the join function passed as extra with parameters ``a,b,c=1,2,3`` and will be rendered as ``1-2-3``.</div><div class=""> </div><div class=""> #### Oembed protocol</div><div class=""> </div><div class="insert">You can type in (or cut-and-paste) any URL into a wiki page <span class="highlight">and </span>it<span class="highlight"></span> is rendered as a link to the URL. There are exceptions:</div><div class=""> </div><div class=""> - If the URL has an image extension, the link is embedded as an image, ``&lt;img/&gt;``.</div><div class=""> - If the URL has an audio extension, the link is embedded as HTML5 audio ``&lt;audio/&gt;``.</div><div class=""> - If the URL has a video extension, the link is embedded as HTML5 video ``&lt;video/&gt;``.</div><div class=""> - If the URL has a MS Office or PDF extension, Google Doc Viewer is embedded, showing the content of the document (only works for public documents).</div><div class="insert">- If the URL points to a You<span class="highlight">T</span>ube page, a Vimeo page, or a Flickr page, web2py contacts the corresponding web service and queries it about the proper way to embed the content. This is done using the ``oembed`` protocol.</div><div class=""> </div><div class=""> Here is a complete list of supported formats:</div><div class=""> ``</div><div class=""> Image (.PNG, .GIF, .JPG, .JPEG)</div><div class=""> Audio (.WAV, .OGG, .MP3)</div><div class=""> Video (.MOV, .MPE, .MP4, .MPG, .MPG2, .MPEG, .MPEG4, .MOVIE)</div><div class=""> ``</div><div class=""> </div><div class=""> Supported via Google Doc Viewer:</div><div class=""> </div><div class=""> ``</div><div class=""> Microsoft Excel (.XLS and .XLSX)</div><div class=""> Microsoft PowerPoint 2007 / 2010 (.PPTX)</div><div class=""> Apple Pages (.PAGES)</div><div class=""> Adobe PDF (.PDF)</div><div class=""> Adobe Illustrator (.AI)</div><div class=""> Adobe Photoshop (.PSD)</div><div class=""> Autodesk AutoCad (.DXF)</div><div class=""> Scalable Vector Graphics (.SVG)</div><div class=""> PostScript (.EPS, .PS)</div><div class=""> TrueType (.TTF)</div><div class=""> xml Paper Specification (.XPS)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Supported by oembed:</div><div class=""> </div><div class=""> ``</div><div class=""> flickr.com</div><div class=""> youtube.com</div><div class=""> hulu.com</div><div class=""> Here ``\@////`` stands for</div><div class=""> ``:code</div><div class=""> </div><div class=""> but &quot;app&quot;, &quot;controller&quot;, and &quot;function&quot; are omitted thus assuming default.</div><div class=""> </div><div class=""> Similarly you can use the wiki menu to upload a media file (for example an image) linked to the page. The &quot;manage media&quot; page will show all files you have uploaded and will show the proper expression to link the media file. If, for example you upload a file &quot;test.jpg&quot; with title &quot;beach&quot;, the link expression will something like:</div><div class=""> </div><div class=""> ``</div><div class=""> \@////15/beach.jpg</div><div class=""> ``:code</div><div class=""> </div><div class=""> ``\@////`` is the same prefix described before. ``15`` is the id of the record storing the media file. ``beach`` is the title. ``.jpg`` is the extension of the original file.</div><div class=""> </div><div class=""> If you cut and paste ``\@////15/beach.jpg`` into wiki pages you embed the image.</div><div class=""> </div><div class=""> Mind that media files are linked to pages and inherit access permission from the pages.</div><div class=""> </div><div class=""> #### Wiki menus</div><div class=""> </div><div class=""> If you create a page with slug &quot;wiki-menu&quot; page it will be interpreted as a description of the menu. Here is an example:</div><div class=""> </div><div class=""> ``</div><div class=""> - Home &gt; \@////index</div><div class=""> - Info &gt; \@////info</div><div class=""> - web2py &gt; http://google.com</div><div class=""> - - About us &gt; \@////aboutus</div><div class=""> - - Contact us &gt; \@////contactus</div><div class=""> ``</div><div class=""> </div><div class=""> Each line a menu item. We used double dash for nested menu items. The ``&gt;`` symbols separates the menu item title from the menu item link.</div><div class=""> </div><div class="insert">Mind that the menu is appended to ``response.menu``. It does not replace it. The ``[wiki]`` menu <span class="highlight">i</span>tem with service functions is added automatically.</div><div class=""> </div><div class=""> #### Service functions</div><div class=""> </div><div class=""> If, for example, you want to use the wiki to create an editable sidebar you could create a page with ``slug=&quot;sidebar&quot;`` and then embed it in your layout.html with</div><div class=""> </div><div class=""> ``</div><div class=""> {{=auth.wiki(slug=&#x27;sidebar&#x27;)}}</div><div class=""> ``:code</div><div class=""> </div><div class="insert">Notice that there is nothing special with the word &quot;sidebar&quot;. Any wiki page can be retrieved and embedded <span class="highlight">at</span> any point in your code. This allows you mix and match wiki functionalities with regular web2py functionalities.</div><div class=""> </div><div class=""> ------</div><div class=""> Also note that ``auth.wiki(&#x27;sidebar&#x27;)``:code is the same as ``auth.wiki(slug=&#x27;sidebar&#x27;)``:code, since the slug kwarg is the first in the method signature. The former gives a slightly simpler syntax.</div><div class=""> ------</div><div class=""> </div><div class=""> </div><div class="insert">You can also embed special wiki functions <span class="highlight">such </span>as the search by tags:</div><div class=""> </div><div class=""> ``</div><div class=""> {{=auth.wiki(&#x27;_search&#x27;)}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> or the tag cloud:</div><div class=""> </div><div class=""> ``</div><div class=""> {{=auth.wiki(&#x27;_cloud&#x27;)}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> #### Extending the auth.wiki feature</div><div class=""> </div><div class=""> When your wiki-enabled app gets more complicated, perhaps you might need to customize the wiki db records managed by the Auth interface or expose customized forms for wiki CRUD tasks. For example, you might want to customize a wiki table record representation or add a new field validator. This is not allowed by default, since the wiki model is defined only after the wiki interface is requested with the auth.wiki() method. To allow access to the wiki specific db setup within the model of your app you must add the following sentence to your model file (i.e. db.py)</div><div class=""> </div><div class=""> ``</div><div class=""> # Make sure this is called after the auth instance is created</div><div class=""> # and before any change to the wiki tables</div><div class=""> auth.wiki(resolve=False)</div><div class=""> ``:code</div><div class=""> </div><div class=""> By using the line above in your model, the wiki tables will be accessible (i.e. ``wiki_page``) for custom CRUD or other db tasks.</div><div class=""> </div><div class=""> ------</div><div class=""> Note that you still have to call auth.wiki() in the controller or view in order to expose the wiki interface, since the ``resolve=False`` parameter instructs the auth object to just build the wiki model without any other interface setup.</div><div class=""> ------</div><div class=""> </div><div class=""> </div><div class="insert">Also, by setting resolve to ``False`` in the method call, the wiki tables will be now acces<span class="highlight">s</span>ible t<span class="highlight">h</span>rough the app&#x27;s default db interface at ``&lt;app&gt;/appadmin`` for managing wiki records.</div><div class=""> </div><div class=""> </div><div class=""> Another customization possible is adding extra fields to the standard wiki tables (in the same way as with the ``auth_user`` table, as described in Chapter 9). Here is how:</div><div class=""> </div><div class=""> ``</div><div class=""> # Place this after auth object initialization</div><div class=""> auth.settings.extra_fields[&quot;wiki_page&quot;] = [Field(&quot;ablob&quot;, &quot;blob&quot;),]</div><div class=""> ``:code</div><div class=""> </div><div class=""> The line above adds a ``blob`` field to the ``wiki_page`` table. There is no need to call ``auth.wiki(resolve=False)``:code for this option, unless you need access to the wiki model for other customizations.</div><div class=""> </div><div class=""> </div><div class=""> #### Components</div><div class=""> </div><div class="insert">One of the most powerful function<span class="highlight">s</span> of the new web2py consists in the ability of embedding an action inside another action. We call this a component.</div><div class=""> </div><div class=""> Consider the following model:</div><div class=""> </div><div class=""> ``</div><div class=""> db.define_table(&#x27;thing&#x27;,Field(&#x27;name&#x27;,requires=IS_NOT_EMPTY()))</div><div class=""> ``:code</div><div class=""> </div><div class=""> and the following action:</div><div class=""> </div><div class=""> ``</div><div class=""> @auth.requires_login()</div><div class=""> def manage_things():</div><div class="">     return SQLFORM.grid(db.thing)</div><div class=""> ``:code</div><div class=""> </div><div class=""> This action is special because it returns a widget/helper not a dict of objects. Now we can embed this ``manage_things`` action into any view, with</div><div class=""> </div><div class=""> ``</div><div class=""> {{=LOAD(&#x27;default&#x27;,&#x27;manage_things&#x27;,ajax=True)}}</div><div class=""> ``:code</div><div class=""> </div><div class="insert">This allows the visitor interact with the component via Ajax without reloading the host page that embeds the widget. Basically the action is called via Ajax, inherits the st<span class="highlight">y</span>le of the host page, and capture<span class="highlight">s all form</span> submissions and flash messages so that they are handled within the current page. On top of this the ``SQLFORM.grid`` widget uses digitally signed URLs to restrict access. More information about components can be found in chapter 13.</div><div class=""> </div><div class=""> Components like the one above can be embedded into wiki pages using the MARKMIN syntax:</div><div class=""> </div><div class=""> ``</div><div class=""> @{component:default/manage_things}</div><div class=""> ``</div><div class=""> </div><div class="insert">This simply tells web2py that we want to inc<span class="highlight">l</span>ude the &quot;manage_things&quot; action defined in the &quot;default&quot; controller as an Ajax &quot;component&quot;.</div><div class=""> </div><div class=""> ---------</div><div class=""> Most users will be able to build relatively complex applications simply by using ``auth.wiki`` to create pages and menus and embedded custom components into wiki pages. Wikis can be thought of as a mechanism to allow members of the group to create pages, but they can also be thought of as a way to develop applications in a modular way.</div><div class=""> ---------</div><div class=""> </div><div class=""> ### More on **admin**</div><div class=""> ``admin``:inxx</div><div class=""> </div><div class=""> The administrative interface provides additional functionality that we briefly review here.</div><div class=""> </div><div class=""> #### Site</div><div class=""> ``site``:inxx</div><div class=""> </div><div class=""> This page is the main administrative interface of web2py. It lists all installed applications on the left, while on the right side there are some special action forms.</div><div class=""> </div><div class=""> The first of them shows the web2py version and proposes to upgrade it if new versions are available. Of course, before upgrading be sure to have a full working backup!</div><div class=""> Then there are two other forms that allow the creation of a new application (simple or by using an online wizard) by specifying its name.</div><div class=""> </div><div class=""> ``Instant Press``:inxx ``Movuca``:inxx</div><div class=""> The following form allows uploading an existing application from either a local file or a remote URL. When you upload an application, you need to specify a name for it (using different names</div><div class=""> allows you to install multiple copies of the same application). You can try, for example, to upload the Movuca Social Networking application app created by Bruno Rocha:</div><div class=""> </div><div class=""> ``</div><div class=""> http://code.google.com/p/instant-press/</div><div class=""> ``</div><div class=""> </div><div class=""> or Instant Press CMS created by Martin Mulone:</div><div class=""> </div><div class=""> ``</div><div class=""> http://code.google.com/p/instant-press/</div><div class=""> ``</div><div class=""> </div><div class=""> or one of the many example applications available at:</div><div class=""> </div><div class=""> ``</div><div class=""> http://web2py.com/appliances</div><div class=""> ``</div><div class=""> </div><div class=""> ------</div><div class="insert">Web2py files are packages as ``.w2p`` files. These<span class="highlight"></span> are tar gzipped files. Web2py uses the ``.w2p`` extension instead of the ``.tgz`` extension to prevent the browser from unzipping on download. They can be uncompressed manually with ``tar zxvf [filename]`` although this is never necessary.</div><div class=""> ------</div><div class=""> </div><div class=""> [[image @///image/en4100.png center 444px]]</div><div class=""> </div><div class=""> Upon successful upload, web2py displays the MD5 checksum of the uploaded file. You can use it to verify that the file was not corrupted during upload. The InstantPress name will appear in the list of installed applications.</div><div class=""> </div><div class=""> If you run web2py from source and you have ``gitpython`` installed (if necessary, set it up with &#x27;easy_install gitpython&#x27;), you can install applications directly from git repositories</div><div class=""> using the ``.git`` URL in the upload form. In this case you will also be enabled to use the admin interface to push changes back into the repository, but this is an experimental feature.</div><div class=""> </div><div class=""> For example, you can locally install the application that shows this book on the web2py site with the URL:</div><div class=""> </div><div class=""> ``</div><div class=""> https://github.com/mdipierro/web2py-book.git</div><div class=""> ``</div><div class=""> </div><div class=""> ------</div><div class=""> That repository hosts the current, updated version of this book (which could be different from the stable version you can see on the web site). You are warmly invited to use it for submitting</div><div class=""> improvements, fixes and corrections in the form of pull requests.</div><div class=""> ------</div><div class="">   </div><div class=""> For each application installed you can use the &#x27;&#x27;site&#x27;&#x27; page to:</div><div class=""> - Go directly to the application by clicking on its name.</div><div class=""> - Uninstall the application.</div><div class=""> - Jump to the &#x27;&#x27;about&#x27;&#x27; page (read below).</div><div class=""> - Jump to the &#x27;&#x27;edit&#x27;&#x27; page (read below).</div><div class=""> - Jump to the &#x27;&#x27;errors&#x27;&#x27; page (read below).</div><div class=""> - Clean up temporary files (sessions, errors, and cache.disk files).</div><div class=""> - Pack all. This returns a tar file containing a complete copy of the application. We suggest that you clean up temporary files before packing an application.</div><div class="insert">+- Compile the application. If there are no errors, this option will bytecode-compiles all models, controllers and views. Because views can extend and include other views in a tree, before bytecode compilation, the view tree for every controller is collapsed into a single file. The net effect is that a bytecode-compiled application is faster, because there is no more parsing of templates or string substitutions occurring at runtime.</div><div class="insert">+- Pack compiled. This option is only present for bytecode-compiled applications. It allows packing the application without source code for distribution as closed source. Note that Python (as any other programming language) can technically be decompiled; therefore compilation does not provide complete protection of the source code. Nevertheless, de-compilation can be difficult and can be illegal.</div><div class=""> - Remove compiled. It simply removes the byte-code compiled models, views and controllers from the application. If the application was packaged with source code or edited locally, there is no harm in removing the bytecode-compiled files, and the application will continue to work. If the application was installed form a packed compiled file, then this is not safe, because there is no source code to revert to, and the application will no longer work.</div><div class=""> </div><div class=""> ``admin.py``:inxx</div><div class=""> </div><div class=""> -------</div><div class=""> All the functionality available from the web2py admin site page is also accessible programmatically via the API defined in the module ``gluon/admin.py``. Simply open a python shell and import this module.</div><div class=""> -------</div><div class=""> </div><div class=""> If the Google App Engine SDK is installer the admin &#x27;&#x27;site&#x27;&#x27; page shows a button to push your applications to GAE. If ``python-git`` is installed, there is also a button to push your application to Open Shift. To install applications on ``Heroku`` or other hosting system you should look into the &quot;scripts&quot; folder for the appropriate script.</div><div class=""> </div><div class=""> #### About</div><div class=""> ``about``:inxx ``license``:inxx</div><div class=""> </div><div class=""> The &#x27;&#x27;about&#x27;&#x27; tab allows editing the description of the application and its license. These are written respectively in the ABOUT and LICENSE files in the application folder.</div><div class=""> </div><div class=""> [[image @///image/en4300.png center 480px]]</div><div class=""> </div><div class=""> You can use ``MARKMIN``, or ``gluon.contrib.markdown.WIKI`` syntax for these files as described in ref.``markdown2``:cite .</div><div class=""> </div><div class=""> #### Design</div><div class=""> ``EDIT``:inxx</div><div class=""> You have used the &#x27;&#x27;edit&#x27;&#x27; page already in this chapter. Here we want to point out a few more functionalities of the &#x27;&#x27;edit&#x27;&#x27; page.</div><div class=""> - If you click on any file name, you can see the contents of the file with syntax highlighting.</div><div class=""> - If you click on edit, you can edit the file via a web interface.</div><div class=""> - If you click on delete, you can delete the file (permanently).</div><div class=""> - If you click on test, web2py will run tests. Tests are written by the developer using Python doctests, and each function should have its own tests.</div><div class=""> - You can add language files, scan the app to discover all strings, and edit string translations via the web interface.</div><div class=""> - If the static files are organized in folders and subfolders, the folder hierarchy can be toggled by clicking on a folder name.</div><div class=""> </div><div class=""> The image below shows the output of the test page for the welcome application.</div><div class=""> The image below show the languages tab for the welcome application.</div><div class=""> [[image @///image/en4500.png center 480px]]</div><div class=""> </div><div class=""> The image below shows how to edit a language file, in this case the &quot;it&quot; (Italian) language for the welcome application.</div><div class=""> </div><div class=""> [[image @///image/en4600.png center 480px]]</div><div class=""> </div><div class=""> ##### Integrated debugger</div><div class=""> </div><div class=""> &#x27;&#x27;(requires Python 2.6 or later)&#x27;&#x27;</div><div class=""> </div><div class=""> The web2py admin includes a web based debugger. Using the provided web-based editor you can add breakpoints to the Python code and, from the associated debugger console, you can inspect the system variables at those breakpoints and resume execution. This is illustrated in the following screenshot:</div><div class=""> </div><div class=""> [[image @///image/debugger.png center 480px]]</div><div class=""> </div><div class=""> This functionality is based on the Qdb debugger created by Mariano Reingart.</div><div class=""> It uses multiprocessing.connection to communicate between the backend</div><div class=""> and frontend, with a JSON-RPC-like stream protocol. ``qdb``:cite</div><div class=""> </div><div class=""> ##### Shell</div><div class=""> </div><div class=""> If you click on the &quot;shell&quot; link under the controllers tab in &#x27;&#x27;edit&#x27;&#x27;, web2py will open a web based Python shell and will execute the models for the current application. This allows you to interactively talk to your application.</div><div class=""> </div><div class=""> [[image @///image/en4700.png center 480px]]</div><div class=""> </div><div class=""> -------</div><div class=""> Be careful using the web based shell - because different shell requests will be executed in different threads. This easily gives errors, especially if you play with databases</div><div class=""> creation and connections. For activities like these (i.e. if you need persistence) it&#x27;s much better to use the python command line.</div><div class=""> -------</div><div class=""> ##### Crontab</div><div class=""> </div><div class="insert">Also under the controllers tab in &#x27;&#x27;edit&#x27;&#x27; there is a &quot;crontab&quot; link. By clicking on this link you will be able to edit the web2py crontab file. This follows the same syntax as the <span class="highlight">U</span>nix crontab but does not rely on <span class="highlight">U</span>nix. In fact, it only requires web2py, and it works on Windows. It allows you to register actions that need to be executed in background at scheduled times.</div><div class=""> For more information about this, see the next chapter.</div><div class=""> </div><div class=""> #### Errors</div><div class=""> ``errors``:inxx</div><div class=""> </div><div class=""> When programming web2py, you will inevitably make mistakes and introduce bugs. web2py helps in two ways: 1) it allows you to create tests for every function that can be run in the browser from the &#x27;&#x27;edit&#x27;&#x27; page; and 2) when an error manifests itself, a ticket is issued to the visitor and the error is logged.</div><div class=""> </div><div class=""> Intentionally introduce an error in the images application as shown below:</div><div class=""> ``</div><div class=""> def index():</div><div class="">     images = db().select(db.image.ALL,orderby=db.image.title)</div><div class="">     1/0</div><div class="">     return dict(images=images)</div><div class=""> ``:code</div><div class=""> </div><div class=""> When you access the index action, you get the following ticket:</div><div class=""> </div><div class=""> [[image @///image/en4800.png center 480px]]</div><div class=""> </div><div class=""> Only the administrator can access the ticket:</div><div class=""> </div><div class=""> [[image @///image/en4900.png center 480px]]</div><div class=""> </div><div class=""> The ticket shows the traceback, and the content of the file that caused the problem, and the complete state of system (variables, request, session, etc.) If the error occurs in a view, web2py shows the view converted from HTML into Python code. This allows to easily identify the logical structure of the file.</div><div class=""> </div><div class="insert">By default tickets are stored on filesystem and <span class="highlight">displayed grouped</span> by traceback. The administrative interface provides an aggregate views (type of traceback and number of occurrence) and a detailed view (all tickets are listed by ticket id). The administrator can switch between the two views.</div><div class=""> </div><div class=""> Notice that everywhere **admin** shows syntax-highlighted code (for example, in error reports, web2py keywords are shown in orange). If you click on a web2py keyword, you are redirected to a documentation page about the keyword.</div><div class=""> </div><div class=""> If you fix the divide-by-zero bug in the index action and introduce one in the index view:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> </div><div class=""> &lt;h1&gt;Current Images&lt;/h1&gt;</div><div class=""> &lt;ul&gt;</div><div class=""> {{for image in images:}}</div><div class=""> {{1/0}}</div><div class=""> {{=LI(A(image.title, _href=URL(&quot;show&quot;, args=image.id)))}}</div><div class=""> {{pass}}</div><div class=""> &lt;/ul&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> you get the following ticket:</div><div class=""> </div><div class=""> [[image @///image/en5000.png center 480px]]</div><div class=""> </div><div class=""> Note that web2py has converted the view from HTML into a Python file, and the error described in the ticket refers to the generated Python code and NOT to the original view file:</div><div class=""> </div><div class=""> [[image @///image/en5100.png center 480px]]</div><div class=""> </div><div class=""> This may seem confusing at first, but in practice it makes debugging easier, because the Python indentation highlights the logical structure of the code that you embedded in the views.</div><div class=""> </div><div class=""> The code is shown at the bottom of the same page.</div><div class=""> </div><div class=""> All tickets are listed under admin in the &#x27;&#x27;errors&#x27;&#x27; page for each application:</div><div class=""> </div><div class=""> You can access the wizard from the &quot;sites&quot; page as shown in the image below.</div><div class=""> The wizard will guide you through a series of steps involved in creating a new application:</div><div class=""> </div><div class=""> - Chose a name for the application</div><div class=""> - Configure the application and choose required plugins</div><div class=""> - Build required models (it will create CRUD pages for each model)</div><div class=""> - Allow you to edit the views of those pages using MARKMIN syntax</div><div class=""> </div><div class=""> The image below shows the second step of the process.</div><div class=""> </div><div class=""> [[image @///image/en5500.png center 480px]]</div><div class=""> </div><div class=""> You can see a dropdown to select a layout plugin (from ``web2py.com/layouts``), a multiple choice dropdown to check other plugins (from ``web2py.com/plugins``) and a &quot;login config&quot; field where to put the Janrain &quot;domain:key&quot;.</div><div class=""> </div><div class=""> The other steps are pretty much self-explanatory.</div><div class=""> </div><div class=""> The Wizard works well for what it does but it is considered an &#x27;&#x27;experimental feature&#x27;&#x27; for two reasons:</div><div class=""> </div><div class=""> - Applications created with the wizard and edited manually, cannot later be modified by the wizard.</div><div class=""> - The interface of the wizard will change over time to include support for more features and easier visual development.</div><div class=""> </div><div class=""> In any case the wizard is a handy tool for fast prototyping and it can be used to bootstrap a new application with an alternate layout and optional plugins.</div><div class=""> </div><div class=""> #### Configuring **admin**</div><div class=""> </div><div class=""> Normally there is no need to perform any configuration of admin but a few customizations are possible. After you login into admin you can edit the admin configuration file via the URL:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/admin/default/edit/admin/models/0.py</div><div class=""> ``</div><div class=""> Notice that **admin** can be used to edit itself. In fact **admin** is an app as any other one.</div><div class=""> </div><div class="insert">The file &quot;0.py&quot; is very much self documented and if you are opening probably you already know what you are looking for. Anyway <span class="highlight">a </span>few customizations exist that are more important than others:</div><div class=""> </div><div class=""> ``</div><div class=""> GAE_APPCFG = os.path.abspath(os.path.join(&#x27;/usr/local/bin/appcfg.py&#x27;))</div><div class=""> ``</div><div class="insert">This should point to the location of the &quot;appcfg.py&quot; file that comes with the Google App Engine SDK. If you have the SDK you may want to change th<span class="highlight">ese</span> config parameters to the correct value. It will allow you to deploy to GAE from the admin interface.</div><div class=""> </div><div class=""> ``DEMO_MODE``:inxx</div><div class=""> </div><div class=""> You can also set web2py admin in demo mode:</div><div class=""> ``</div><div class=""> DEMO_MODE = True</div><div class=""> FILTER_APPS = [&#x27;welcome&#x27;]</div><div class=""> ``</div><div class=""> And only the apps listed in filter apps will be accessible and they will be only accessible in read-only mode.</div><div class=""> </div><div class=""> ``MULTI_USER_MODE``:inxx</div><div class=""> ``virtual laboratory``:inxx</div><div class=""> </div><div class=""> If you are a teacher and want to expose the administrative interface to students so that students can share one administrative interface for their projects (think of a virtual lab), can do it by setting:</div><div class=""> ``</div><div class=""> MULTI_USER_MODE = True</div><div class=""> ``</div><div class=""> In this way students will be required to login and will only be able to access their own apps via admin. You, as first user/teacher, will be able to access them all.</div><div class=""> </div><div class="insert">In multi user mode, you can register students using the &quot;bulk register&quot; link in admin and manage them using the &quot;manage students&quot; link. The system also keep<span class="highlight">s</span> track of when students login and how many lines of code<span class="highlight"> they</span> add/remove to/from their code. This data is presented to the administrator as charts under the application &quot;about&quot; page.</div><div class=""> </div><div class=""> Mind that this mechanism still assumes all users are trusted. All the apps created under admin run under the same credentials on the same filesystem. It is possible for an app created by a student to access the data and the source of an app created by another student. It is also possible for a student to create an app that locks the server.</div><div class=""> </div><div class=""> #### Mobile **admin**</div><div class=""> </div><div class="insert">Notice that the admin application includes &quot;plugin_jqmo<span class="highlight">b</span>ile&quot; which packages jQuery Mobile. When admin is accessed from a mobile device; this is detected by web2py and the interface is displayed using a mobile-friendly layout.</div><div class=""> </div><div class=""> ### More on **appadmin**</div><div class=""> </div><div class=""> ``appadmin``:inxx</div><div class=""> </div><div class=""> **appadmin** is not intended to be exposed to the public. It is designed to help you by providing an easy access to the database. It consists of only two files: a controller &quot;appadmin.py&quot; and a view &quot;appadmin.html&quot; which are used by all actions in the controller.</div><div class=""> </div><div class=""> The **appadmin** controller is relatively small and readable; it provides an example of designing a database interface.</div><div class=""> </div><div class=""> **appadmin** shows which databases are available and which tables exist in each database. You can insert records and list all records for each table individually. **appadmin** paginates output 100 records at a time.</div><div class=""> </div><div class=""> Once a set of records is selected, the header of the pages changes, allowing you to update or delete the selected records.</div><div class=""> </div><div class=""> To update the records, enter an SQL assignment in the Query string field:</div><div class=""> ``</div><div class=""> title = &#x27;test&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class=""> where string values must be enclosed in single quotes. Multiple fields can be separated by commas.</div><div class=""> </div><div class=""> To delete a record, click the corresponding checkbox to confirm that you are sure.</div><div class=""> </div><div class=""> **appadmin** can also perform joins if the SQL FILTER contains a SQL condition that involves two or more tables. For example, try:</div><div class=""> ``</div><div class=""> db.image.id == db.post.image_id</div><div class=""> ``:code</div><div class=""> </div><div class=""> web2py passes this along to the DAL, and it understands that the query links two tables; hence, both tables are selected with an INNER JOIN. Here is the output:</div><div class=""> </div><div class=""> [[image @///image/en5600.png center 480px]]</div><div class=""> </div><div class=""> If you click on the number of an id field, you get an edit page for the record with the corresponding id.</div><div class=""> </div><div class=""> If you click on the number of a reference field, you get an edit page for the referenced record.</div><div class=""> </div><div class=""> You cannot update or delete rows selected by a join, because they involve records from multiple tables and this would be ambiguous.</div><div class=""> </div><div class="insert">In addition to its database administration capabilities, **appadmin** also enables you to view details about the contents of the application&#x27;s ``cache`` (at ``/yourapp/appadmin/c<span class="highlight"></span>ache``) as well as the contents of the current ``request``, ``response``, and ``session`` objects (at ``/yourapp/appadmin/state``).</div></div></div>
    <div class="span6"><div class="diff"><div class=""> -----</div><div class="delete">When you create a new application using **admin**, it starts as a clone of the &quot;welcome&quot; scaffolding app with a &quot;models/db.py&quot; that creates a SQLite database, connects to it, instantiates Auth, Crud, and Service, <span class="highlight"></span>configures them. It also provides a &quot;controller/default.py&quot; which exposes actions &quot;index&quot;, &quot;download&quot;, &quot;user&quot; for user management, and &quot;call&quot; for services. In the following, we assume that these files have been removed; we will be creating apps from scratch.</div><div class=""> -----</div><div class=""> </div><div class=""> web2py also comes with a **wizard**, described later in this chapter, that can write an alternate scaffolding code for you based on layouts and plugins available on the web and based on high level description of the models.</div><div class=""> </div><div class=""> ### Simple examples</div><div class=""> </div><div class=""> #### Say hello</div><div class=""> ``index``:inxx</div><div class=""> </div><div class=""> Here, as an example, we create a simple web app that displays the message &quot;Hello from MyApp&quot; to the user. We will call this application &quot;myapp&quot;. We will also add a counter that counts how many times the same user visits the page.</div><div class=""> </div><div class=""> You can create a new application simply by typing its name in the form on the top right of the **site** page in **admin**.</div><div class=""> </div><div class=""> [[image @///image/en800.png center 447px]]</div><div class=""> </div><div class=""> After you press [create], the application is created as a copy of the built-in welcome application.</div><div class=""> </div><div class=""> [[image @///image/en900.png center 480px]]</div><div class=""> </div><div class=""> To run the new application, visit:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/myapp</div><div class=""> ``:code</div><div class=""> </div><div class=""> Now you have a copy of the welcome application.</div><div class=""> </div><div class=""> To edit an application, click on the &#x27;&#x27;edit&#x27;&#x27; button for the newly created application.</div><div class=""> </div><div class=""> The **edit** page tells you what is inside the application.</div><div class=""> Every web2py application consists of certain files, most of which fall into one of six categories:</div><div class=""> - **models**: describe the data representation.</div><div class=""> - **controllers**: describe the application logic and workflow.</div><div class=""> - **views**: describe the data presentation.</div><div class=""> - **languages**: describe how to translate the application presentation to other languages.</div><div class=""> - **modules**: Python modules that belong to the application.</div><div class=""> - **static files**: static images, CSS  files``css-w,css-o,css-school``:cite , JavaScript files``js-w,js-b``:cite , etc.</div><div class=""> - **plugins**: groups of files designed to work together.</div><div class=""> </div><div class=""> Everything is neatly organized following the Model-View-Controller design pattern. Each section in the &#x27;&#x27;edit&#x27;&#x27; page corresponds to a subfolder in the application folder.</div><div class=""> </div><div class="delete">Notice that<span class="highlight"></span> section headings will toggle their content. Folder names under static files are also collapsible.</div><div class=""> </div><div class=""> -------</div><div class=""> Each file listed in the section corresponds to a file physically located in the subfolder. Any operation performed on a file via the **admin** interface (create, edit, delete) can be performed directly from the shell using your favorite editor.</div><div class=""> -------</div><div class=""> </div><div class=""> The application contains other types of files (database, session files, error files, etc.), but they are not listed on the &#x27;&#x27;edit&#x27;&#x27; page because they are not created or modified by the administrator; they are created and modified by the application itself.</div><div class=""> </div><div class=""> The controllers contain the logic and workflow of the application. Every URL gets mapped into a call to one of the functions in the controllers (actions). There are two default controllers: &quot;appadmin.py&quot; and &quot;default.py&quot;. **appadmin** provides the database administrative interface; we do not need it now. &quot;default.py&quot; is the controller that you need to edit, the one that is called by default when no controller is specified in the URL. Edit the &quot;index&quot; function as follows:</div><div class=""> ``</div><div class=""> def index():</div><div class="">     return &quot;Hello from MyApp&quot;</div><div class=""> ``:code</div><div class=""> </div><div class=""> Here is what the online editor looks like:</div><div class=""> </div><div class=""> [[image @///image/en1000.png center 480px]]</div><div class=""> </div><div class=""> Save it and go back to the &#x27;&#x27;edit&#x27;&#x27; page. Click on the index link to visit the newly created page.</div><div class=""> </div><div class=""> When you visit the URL</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/myapp/default/index</div><div class=""> ``:code</div><div class=""> </div><div class=""> the index action in the default controller of the myapp application is called. It returns a string that the browser displays for us. It should look like this:</div><div class=""> </div><div class=""> [[image @///image/en1100.png center 480px]]</div><div class=""> </div><div class=""> Now, edit the &quot;index&quot; function as follows:</div><div class=""> ``</div><div class=""> def first():</div><div class=""> </div><div class=""> The ``form`` object can be easily serialized in HTML by embedding it in the &quot;default/first.html&quot; view.</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> {{=form}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> The ``form.process()`` method applies the validators and returns the form itself. The ``form.accepted`` variable is set to True if the form was processed and passed validation. If the self-submitted form passes validation, it stores the variables in the session and redirects as before. If the form does not pass validation, error messages are inserted into the form and shown to the user, as below:</div><div class=""> </div><div class=""> [[image @///image/en1800.png center 480px]]</div><div class=""> </div><div class=""> In the next section we will show how forms can be generated automatically from a model.</div><div class=""> </div><div class=""> In all or examples we have used the session to pass the user name from the first action to the second. We could have used a different mechanism and pass data as part of a redirect URL:</div><div class=""> </div><div class=""> ``</div><div class=""> def first():</div><div class="">     form = SQLFORM.factory(Field(&#x27;visitor_name&#x27;, requires=IS_NOT_EMPTY()))</div><div class="">     if form.process().accepted:</div><div class="">         name = form.vars.visitor_name</div><div class="">         redirect(URL(&#x27;second&#x27;,vars=dict(name=name)))</div><div class="">     return dict(form=form)</div><div class=""> </div><div class=""> def second():</div><div class="">     name = request.vars.visitor_name or redirect(URL(&#x27;first&#x27;))</div><div class="">     return dict(name=name)</div><div class=""> ``:code</div><div class=""> </div><div class=""> #### Internationalization</div><div class=""> </div><div class="delete">You<span class="highlight"></span> code is likely to include hardcoded strings such as &quot;What is your name?&quot;. You should be able to customize strings without editing the code and in particular insert translations for these strings in different languages. In this way if a visitor has the language preference of the browser set to &quot;Italian&quot;, web2py will use the Italian translation for the strings, if available. This feature of web2py is called &quot;internationalization&quot; and it is described in more detail in the next chapter.</div><div class=""> </div><div class="delete">Here we just observe that in order to use this feature you should markup strings that needs translation. This is done by wrapping a <span class="highlight">a </span>quoted string in code such as</div><div class=""> </div><div class=""> ``</div><div class=""> &quot;What is your name?&quot;</div><div class=""> ``:code</div><div class=""> </div><div class=""> with the ``T`` operator:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;What is your name?&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class="delete">You can also mark fo<span class="highlight"></span> translations strings hardcoded in views. For example</div><div class=""> </div><div class=""> ``</div><div class=""> &lt;h1&gt;What is your name?&lt;/h1&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> becomes</div><div class=""> </div><div class=""> ``</div><div class=""> &lt;h1&gt;{{=T(&quot;What is your name?&quot;)}}&lt;/h1&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> It is good practice to do this for every string in the code (field labels, flash messages, etc.) except for tables and field names.</div><div class=""> </div><div class=""> Once the strings are identified and marked up, web2py takes care of almost everything else. The admin interface also provides a page where you can translate each string in the languages you desire to support.</div><div class=""> </div><div class=""> ### An image blog</div><div class=""> ``upload``:inxx</div><div class=""> </div><div class=""> Here, as another example, we wish to create a web application that allows the administrator to post images and give them a name, and allows the visitors of the web site to view the named images and submit comments (posts).</div><div class=""> </div><div class=""> As before, from the **site** page in **admin**, create a new application called ``images``, and navigate to the &#x27;&#x27;edit&#x27;&#x27; page:</div><div class=""> </div><div class=""> [[image @///image/en1900.png center 480px]]</div><div class=""> </div><div class=""> We start by creating a model, a representation of the persistent data in the application (the images to upload, their names, and the comments). First, you need to create/edit a model file which, for lack of imagination, we call &quot;db.py&quot;. We assume the code below will replace any existing code in &quot;db.py&quot;. Models and controllers must have a ``.py`` extension since they are Python code. If the extension is not provided, it is appended by web2py. Views instead have a ``.html`` extension since they mainly contain HTML code.</div><div class=""> </div><div class=""> Edit the &quot;db.py&quot; file by clicking the corresponding &quot;edit&quot; button:</div><div class=""> </div><div class=""> [[image @///image/en2000.png center 480px]]</div><div class=""> </div><div class=""> and enter the following:</div><div class=""> </div><div class=""> ``IS_EMAIL``:inxx ``IS_NOT_EMPTY``:inxx ``IS_IN_DB``:inxx</div><div class=""> ``</div><div class=""> db = DAL(&quot;sqlite://storage.sqlite&quot;)</div><div class=""> </div><div class=""> db.define_table(&#x27;image&#x27;,</div><div class="">    Field(&#x27;title&#x27;, unique=True),</div><div class="">    Field(&#x27;file&#x27;, &#x27;upload&#x27;),</div><div class="">    format = &#x27;%(title)s&#x27;)</div><div class=""> </div><div class=""> db.define_table(&#x27;post&#x27;,</div><div class="">    Field(&#x27;image_id&#x27;, &#x27;reference image&#x27;),</div><div class="">    Field(&#x27;author&#x27;),</div><div class="">    Field(&#x27;email&#x27;),</div><div class="">    Field(&#x27;body&#x27;, &#x27;text&#x27;))</div><div class=""> </div><div class=""> db.image.title.requires = IS_NOT_IN_DB(db, db.image.title)</div><div class=""> db.post.image_id.requires = IS_IN_DB(db, db.image.id, &#x27;%(title)s&#x27;)</div><div class=""> db.post.author.requires = IS_NOT_EMPTY()</div><div class=""> db.post.email.requires = IS_EMAIL()</div><div class=""> db.post.body.requires = IS_NOT_EMPTY()</div><div class=""> </div><div class=""> db.post.image_id.writable = db.post.image_id.readable = False</div><div class=""> ``:code</div><div class=""> </div><div class=""> Let&#x27;s analyze this line by line.</div><div class=""> </div><div class="delete">Line 1 defines a global variable called ``db`` that represents the database connection. In this case it is a connection to a SQLite database stored in the file  &quot;applications/images/databases/storage.sqlite&quot;. <span class="highlight">In the</span> SQLite<span class="highlight"> case</span>, if the database <span class="highlight"></span>does not exist, it is created. You can change the name of the file, as well as the name of the global variable ``db``, but it is convenient to give them the same name, to make it easy to remember.</div><div class=""> </div><div class=""> Lines 3-5 define a table &quot;image&quot;. ``define_table`` is a method of the ``db`` object. The first argument, &quot;image&quot;, is the name of the table we are defining. The other arguments are the fields belonging to that table. This table has a field called &quot;title&quot;, a field called &quot;file&quot;, and a field called &quot;id&quot; that serves as the table primary key (&quot;id&quot; is not explicitly declared because all tables have an id field by default). The field &quot;title&quot; is a string, and the field &quot;file&quot; is of type &quot;upload&quot;. &quot;upload&quot; is a special type of field used by the web2py Data Abstraction Layer (DAL) to store the names of uploaded files. web2py knows how to upload files (via streaming if they are large), rename them safely, and store them.</div><div class=""> </div><div class=""> When a table is defined, web2py takes one of several possible actions:</div><div class=""> - if the table does not exist, the table is created;</div><div class=""> - if the table exists and does not correspond to the definition, the table is altered accordingly, and if a field has a different type, web2py tries to convert its contents;</div><div class=""> - if the table exists and corresponds to the definition, web2py does nothing.</div><div class=""> </div><div class=""> This behavior is called &quot;migration&quot;. In web2py migrations are automatic, but can be disabled for each table by passing ``migrate=False`` as the last argument of ``define_table``.</div><div class=""> </div><div class=""> Line 6 defines a format string for the table. It determines how a record should be represented as a string. Notice that the ``format`` argument can also be a function that takes a record and returns a string. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> format=lambda row: row.title</div><div class=""> ``:code</div><div class=""> </div><div class=""> Lines 8-12 define another table called &quot;post&quot;.</div><div class=""> A post has an &quot;author&quot;, an &quot;email&quot; (we intend to store the email address of the author of the post), a &quot;body&quot; of type &quot;text&quot; (we intend to use it to store the actual comment posted by the author), and an &quot;image_id&quot; field of type reference that points to ``db.image`` via the &quot;id&quot; field.</div><div class=""> </div><div class=""> In line 14, ``db.image.title`` represents the field &quot;title&quot; of table &quot;image&quot;. The attribute ``requires`` allows you to set requirements/constraints that will be enforced by web2py forms. Here we require that the &quot;title&quot; is unique:</div><div class=""> </div><div class=""> ``IS_NOT_IN_DB(db, db.image.title)``:code</div><div class=""> </div><div class=""> &#x27;&#x27;Notice this is optional because it is set automatically given that ``Field(&#x27;title&#x27;, unique=True)``&#x27;&#x27;.</div><div class=""> </div><div class=""> The objects representing these constraints are called validators. Multiple validators can be grouped in a list. Validators are executed in the order they appear.</div><div class=""> ``IS_NOT_IN_DB(a, b)`` is a special validator that checks that the value of a field ``b`` for a new record is not already in ``a``.</div><div class=""> </div><div class=""> Line 15 requires that the field &quot;image_id&quot; of table &quot;post&quot; is in ``db.image.id``. As far as the database is concerned, we had already declared this  when we defined the table &quot;post&quot;.</div><div class=""> Now we are explicitly telling the model that this condition should be enforced by web2py, too, at the form processing level when a new comment is posted, so that invalid values do not propagate from input forms to the database. We also require that the &quot;image_id&quot; be represented by the &quot;title&quot;, ``&#x27;%(title)s&#x27;``, of the corresponding record.</div><div class=""> </div><div class="delete">Line 20 indicates that the field &quot;image_id&quot; of table &quot;post&quot; should not be shown in forms, ``writable=False`` and not even in read<span class="highlight"></span>only forms, ``readable=False``.</div><div class=""> </div><div class=""> The meaning of the validators in lines 15-17 should be obvious.</div><div class=""> </div><div class=""> ``format``:inxx</div><div class=""> Notice that the validator</div><div class=""> ``</div><div class=""> db.post.image_id.requires = IS_IN_DB(db, db.image.id, &#x27;%(title)s&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> can be omitted (and would be automatic) if we specify a format for referenced table:</div><div class=""> ``</div><div class=""> db.define_table(&#x27;image&#x27;, ..., format=&#x27;%(title)s&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> where the format can be a string or a function that takes a record and returns a string.</div><div class=""> </div><div class=""> ``appadmin``:inxx</div><div class=""> Once a model is defined, if there are no errors, web2py creates an application administration interface to manage the database. You access it via the &quot;database administration&quot; link in the &#x27;&#x27;edit&#x27;&#x27; page or directly:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/appadmin</div><div class=""> ``:code</div><div class=""> </div><div class=""> Here is a screenshot of the **appadmin** interface:</div><div class=""> </div><div class=""> [[image @///image/en2100.png center 480px]]</div><div class=""> </div><div class=""> This interface is coded in the controller called &quot;appadmin.py&quot; and the corresponding view &quot;appadmin.html&quot;. From now on, we will refer to this interface simply as **appadmin**. It allows the administrator to insert new database records, edit and delete existing records, browse tables, and perform database joins.</div><div class=""> </div><div class=""> The first time **appadmin** is accessed, the model is executed and the tables are created. The web2py DAL translates Python code into SQL statements that are specific to the selected database back-end (SQLite in this example). You can see the generated SQL from the &#x27;&#x27;edit&#x27;&#x27; page by clicking on the &quot;sql.log&quot; link under &quot;models&quot;. Notice that the link is not present until the tables have been created.</div><div class=""> </div><div class=""> [[image @///image/en2200.png center 480px]]</div><div class=""> </div><div class=""> If you were to edit the model and access **appadmin** again, web2py would generate SQL to alter the existing tables. The generated SQL is logged into &quot;sql.log&quot;.</div><div class=""> </div><div class=""> Now go back to **appadmin** and try to insert a new image record:</div><div class=""> </div><div class=""> [[image @///image/en2300.png center 480px]]</div><div class=""> </div><div class=""> web2py has translated the ``db.image.file`` &quot;upload&quot; field into an upload form for the file. When the form is submitted and an image file is uploaded, the file is renamed in a secure way that preserves the extension, it is saved with the new name under the application &quot;uploads&quot; folder, and the new name is stored in the ``db.image.file`` field. This process is designed to prevent directory traversal attacks.</div><div class=""> </div><div class=""> Notice that each field type is rendered by a &#x27;&#x27;widget&#x27;&#x27;. Default widgets can be overridden.</div><div class=""> </div><div class=""> When you click on a table name in **appadmin**, web2py performs a select of all records on the current table, identified by the DAL query</div><div class=""> ``</div><div class=""> db.image.id &gt; 0</div><div class=""> ``:code</div><div class=""> </div><div class=""> and renders the result.</div><div class=""> </div><div class=""> [[image @///image/en2400.png center 480px]]</div><div class=""> </div><div class="delete">You can select a different set of records by editing the <span class="highlight">SQ</span>L query and pressing [Submit].</div><div class=""> </div><div class=""> To edit or delete a single record, click on the record id number.</div><div class=""> </div><div class=""> Because of the ``IS_IN_DB`` validator, the reference field &quot;image_id&quot; is rendered by a drop-down menu. The items in the drop-down are stored as keys (``db.image.id``), but are represented by their ``db.image.title``, as specified by the validator.</div><div class=""> </div><div class=""> Validators are powerful objects that know how to represent fields, filter field values, generate errors, and format values extracted from the field.</div><div class=""> </div><div class=""> The following figure shows what happens when you submit a form that does not pass validation:</div><div class=""> </div><div class=""> [[image @///image/en2500.png center 480px]]</div><div class=""> </div><div class=""> The same forms that are automatically generated by **appadmin** can also be generated programmatically via the ``SQLFORM`` helper and embedded in user applications. These forms are CSS-friendly, and can be customized.</div><div class=""> </div><div class=""> Every application has its own **appadmin**; therefore, **appadmin** itself can be modified without affecting other applications.</div><div class=""> </div><div class=""> So far, the application knows how to store data, and we have seen how to access the database via **appadmin**. Access to **appadmin** is restricted to the administrator, and it is not intended as a production web interface for the application; hence the next part of this walk-through. Specifically we want to create:</div><div class=""> - An &quot;index&quot; page that lists all available images sorted by title and links to detail pages for the images.</div><div class=""> - A &quot;show/[id]&quot; page that shows the visitor the requested image and allows the visitor to view and post comments.</div><div class=""> - A &quot;download/[name]&quot; action to download uploaded images.</div><div class=""> </div><div class=""> This is represented schematically here:</div><div class=""> </div><div class=""> [[yUML diagram @///image/en2600.png center 480px]]</div><div class=""> </div><div class=""> Go back to the &#x27;&#x27;edit&#x27;&#x27; page and edit the &quot;default.py&quot; controller, replacing its contents with the following:</div><div class=""> </div><div class=""> ``select``:inxx</div><div class=""> ``</div><div class=""> def index():</div><div class="">     images = db().select(db.image.ALL, orderby=db.image.title)</div><div class=""> Let&#x27;s edit the &quot;default.py&quot; controller and replace its content with:</div><div class=""> ``</div><div class=""> def index():</div><div class="">     images = db().select(db.image.ALL, orderby=db.image.title)</div><div class="">     return dict(images=images)</div><div class=""> </div><div class=""> def show():</div><div class="">     image = db.image(request.args(0,cast=int)) or redirect(URL(&#x27;index&#x27;))</div><div class="">     db.post.image_id.default = image.id</div><div class="">     form = SQLFORM(db.post)</div><div class="">     if form.process().accepted:</div><div class="">         response.flash = &#x27;your comment is posted&#x27;</div><div class="">     comments = db(db.post.image_id==image.id).select()</div><div class="">     return dict(image=image, comments=comments, form=form)</div><div class=""> </div><div class=""> def download():</div><div class="">     return response.download(request, db)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The controller contains two actions: &quot;show&quot; and &quot;download&quot;.</div><div class=""> The &quot;show&quot; action selects the image with the ``id`` parsed from the request args and all comments related to the image. &quot;show&quot; then passes everything to the view &quot;default/show.html&quot;.</div><div class=""> </div><div class=""> The image id referenced by:</div><div class=""> ``</div><div class=""> URL(&#x27;show&#x27;, args=image.id)</div><div class=""> ``:code</div><div class=""> </div><div class=""> in &quot;default/index.html&quot;, can be accessed as:</div><div class=""> </div><div class=""> ``request.args(0,cast=int)``</div><div class=""> </div><div class="delete">from the &quot;show&quot; action. The ``cast=int`` argument is optional but very important. It attempts to cast the string value passed in the PATH_INFO into an int. On failure it raise<span class="highlight"></span> a proper exception instead of causing a ticket. One can also specify a redirect in case of failure to cast:</div><div class=""> </div><div class=""> ``request.args(0,cast=int,otherwise=URL(&#x27;error&#x27;))``</div><div class=""> </div><div class=""> Moreover ``db.image(...)`` is a shortcut for</div><div class=""> </div><div class=""> ``</div><div class=""> db(db.image.id==...).select().first()</div><div class=""> ``:code</div><div class=""> </div><div class=""> The &quot;download&quot; action expects a filename in ``request.args(0)``, builds a path to the location where that file is supposed to be, and sends it back to the client. If the file is too large, it streams the file without incurring any memory overhead.</div><div class=""> </div><div class=""> Notice the following statements:</div><div class=""> - Line 7 creates an insert form SQLFORM for the ``db.post`` table using only the specified fields.</div><div class=""> - Line 8 sets the value for the reference field, which is not part of the input form because it is not in the list of fields specified above.</div><div class=""> - Line 9 processes the submitted form (the submitted form variables are in ``request.vars``) within the current session (the session is used to prevent double submissions, and to enforce navigation). If the submitted form variables are validated, the new comment is inserted in the ``db.post`` table; otherwise the form is modified to include error messages (for example, if the author&#x27;s email address is invalid). This is all done in line 9!.</div><div class=""> - Line 10 is only executed if the form is accepted, after the record is inserted into the database table. ``response.flash`` is a web2py variable that is displayed in the views and used to notify the visitor that something happened.</div><div class=""> - Line 11 selects all comments that reference the current image.</div><div class=""> </div><div class=""> -------</div><div class=""> The &quot;download&quot; action is already defined in the &quot;default.py&quot; controller of the scaffolding application.</div><div class=""> -------</div><div class=""> </div><div class=""> The &quot;download&quot; action does not return a dictionary, so it does not need a view. The &quot;show&quot; action, though, should have a view, so return to **admin** and create a new view called &quot;default/show.html&quot;.</div><div class=""> </div><div class=""> Edit this new file and replace its content with the following:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Image: {{=image.title}}&lt;/h1&gt;</div><div class=""> &lt;center&gt;</div><div class=""> &lt;img width=&quot;200px&quot;</div><div class=""> db.define_table(&#x27;post&#x27;,</div><div class="">     Field(&#x27;body&#x27;, &#x27;text&#x27;),</div><div class="">     Field(&#x27;created_on&#x27;, &#x27;datetime&#x27;, default=request.now),</div><div class="">     Field(&#x27;created_by&#x27;, &#x27;reference auth_user&#x27;, default=auth.user_id))</div><div class=""> </div><div class=""> db.define_table(&#x27;document&#x27;,</div><div class="">     Field(&#x27;page_id&#x27;, &#x27;reference page&#x27;),</div><div class="">     Field(&#x27;name&#x27;),</div><div class="">     Field(&#x27;file&#x27;, &#x27;upload&#x27;),</div><div class="">     Field(&#x27;created_on&#x27;, &#x27;datetime&#x27;, default=request.now),</div><div class="">     Field(&#x27;created_by&#x27;, &#x27;reference auth_user&#x27;, default=auth.user_id),</div><div class="">     format=&#x27;%(name)s&#x27;)</div><div class=""> </div><div class=""> db.page.title.requires = IS_NOT_IN_DB(db, &#x27;page.title&#x27;)</div><div class=""> db.page.body.requires = IS_NOT_EMPTY()</div><div class=""> db.page.created_by.readable = db.page.created_by.writable = False</div><div class=""> db.page.created_on.readable = db.page.created_on.writable = False</div><div class=""> </div><div class=""> db.post.body.requires = IS_NOT_EMPTY()</div><div class=""> db.post.page_id.readable = db.post.page_id.writable = False</div><div class=""> db.post.created_by.readable = db.post.created_by.writable = False</div><div class=""> db.post.created_on.readable = db.post.created_on.writable = False</div><div class=""> </div><div class=""> db.document.name.requires = IS_NOT_IN_DB(db, &#x27;document.name&#x27;)</div><div class=""> db.document.page_id.readable = db.document.page_id.writable = False</div><div class=""> db.document.created_by.readable = db.document.created_by.writable = False</div><div class=""> db.document.created_on.readable = db.document.created_on.writable = False</div><div class=""> ``:code</div><div class=""> </div><div class=""> Edit the controller &quot;default.py&quot; and create the following actions:</div><div class=""> - index: list all wiki pages</div><div class="delete">-- create: post another wiki page</div><div class="delete">-- show: show a wiki page and its comments, and append comments</div><div class=""> - edit: edit an existing page</div><div class=""> - documents: manage the documents attached to a page</div><div class=""> - download: download a document (as in the images example)</div><div class=""> - search: display a search box and, via an Ajax callback, return all matching titles as the visitor types</div><div class=""> - callback: the Ajax callback function. It returns the HTML that gets embedded in the search page while the visitor types.</div><div class=""> </div><div class=""> Here is the &quot;default.py&quot; controller:</div><div class=""> ``</div><div class=""> def index():</div><div class="">      &quot;&quot;&quot; this controller returns a dictionary rendered by the view</div><div class="">          it lists all wiki pages</div><div class="">      &gt;&gt;&gt; index().has_key(&#x27;pages&#x27;)</div><div class="">      True</div><div class="">      &quot;&quot;&quot;</div><div class="">      pages = db().select(db.page.id,db.page.title,orderby=db.page.title)</div><div class="">      return dict(pages=pages)</div><div class=""> </div><div class=""> @auth.requires_login()</div><div class=""> def create():</div><div class="delete">     <span class="highlight"></span>&quot;creates a new empty wiki page&quot;<span class="highlight"></span></div><div class="">      form = SQLFORM(db.page).process(next=URL(&#x27;index&#x27;))</div><div class="">      return dict(form=form)</div><div class=""> </div><div class=""> def show():</div><div class="delete">     <span class="highlight"></span>&quot;shows a wiki page&quot;<span class="highlight"></span></div><div class="">      this_page = db.page(request.args(0,cast=int)) or redirect(URL(&#x27;index&#x27;))</div><div class="">      db.post.page_id.default = this_page.id</div><div class="">      form = SQLFORM(db.post).process() if auth.user else None</div><div class="">      pagecomments = db(db.post.page_id==this_page.id).select()</div><div class="">      return dict(page=this_page, comments=pagecomments, form=form)</div><div class=""> </div><div class=""> @auth.requires_login()</div><div class=""> def edit():</div><div class="delete">     <span class="highlight"></span>&quot;edit an existing wiki page&quot;<span class="highlight"></span></div><div class="">      this_page = db.page(request.args(0,cast=int)) or redirect(URL(&#x27;index&#x27;))</div><div class="">      form = SQLFORM(db.page, this_page).process(</div><div class="">          next = URL(&#x27;show&#x27;,args=request.args))</div><div class="">      return dict(form=form)</div><div class=""> </div><div class=""> @auth.requires_login()</div><div class=""> def documents():</div><div class="delete">     <span class="highlight"></span>&quot;browser, edit all documents attached to a certain page&quot;<span class="highlight"></span></div><div class="">      page = db.page(request.args(0,cast=int)) or redirect(URL(&#x27;index&#x27;))</div><div class="">      db.document.page_id.default = page.id</div><div class="">      db.document.page_id.writable = False</div><div class="">      grid = SQLFORM.grid(db.document.page_id==page.id,args=[page.id])</div><div class="">      return dict(page=page, grid=grid)</div><div class=""> </div><div class=""> def user():</div><div class="">      return dict(form=auth())</div><div class=""> </div><div class=""> def download():</div><div class="delete">     <span class="highlight"></span>&quot;allows downloading of documents&quot;<span class="highlight"></span></div><div class="">      return response.download(request, db)</div><div class=""> </div><div class=""> def search():</div><div class="delete">     <span class="highlight"></span>&quot;an ajax wiki search page&quot;<span class="highlight"></span></div><div class="">      return dict(form=FORM(INPUT(_id=&#x27;keyword&#x27;,_name=&#x27;keyword&#x27;,</div><div class="">               _onkeyup=&quot;ajax(&#x27;callback&#x27;, [&#x27;keyword&#x27;], &#x27;target&#x27;);&quot;)),</div><div class="">               target_div=DIV(_id=&#x27;target&#x27;))</div><div class=""> </div><div class=""> def callback():</div><div class="delete">     <span class="highlight"></span>&quot;an ajax callback that returns a &lt;ul&gt; of links to wiki pages&quot;<span class="highlight"></span></div><div class="">      query = db.page.title.contains(request.vars.keyword)</div><div class="">      pages = db(query).select(orderby=db.page.title)</div><div class="">      links = [A(p.title, _href=URL(&#x27;show&#x27;,args=p.id)) for p in pages]</div><div class="">      return UL(*links)</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> Lines 2-6 provide a comment for the index action. Lines 4-5 inside the comment are interpreted by python as test code (doctest). Tests can be run via the admin interface. In this case the tests verify that the index action runs without errors.</div><div class=""> </div><div class=""> Lines 18, 27, and 35 try to fetch a ``page`` record with the id in</div><div class=""> ``request.args(0)``.</div><div class=""> </div><div class="delete">Lines 13, 20 define and process create forms for a new page and a new comment and<span class="highlight">.</span></div><div class=""> </div><div class=""> Line 28 defines and processes an update form for a wiki page.</div><div class=""> </div><div class="delete">Line 38 creates a ``grid`` object that allows to <span class="highlight">bro</span>w<span class="highlight">ser</span>, add and update the comments linked to a page.</div><div class=""> </div><div class=""> Some magic happens in line 51. The ``onkeyup`` attribute of the INPUT tag &quot;keyword&quot; is set. Every time the visitor releases a key, the JavaScript code inside the ``onkeyup`` attribute is executed, client-side. Here is the JavaScript code:</div><div class=""> ``</div><div class=""> ajax(&#x27;callback&#x27;, [&#x27;keyword&#x27;], &#x27;target&#x27;);</div><div class=""> ``:code</div><div class=""> ``ajax`` is a JavaScript function defined in the file &quot;web2py.js&quot; which is included by the default &quot;layout.html&quot;. It takes three parameters: the URL of the action that performs the synchronous callback, a list of the IDs of variables to be sent to the callback ([&quot;keyword&quot;]), and the ID where the response has to be inserted (&quot;target&quot;).</div><div class=""> </div><div class=""> As soon as you type something in the search box and release a key, the client calls the server and sends the content of the &#x27;keyword&#x27; field, and, when the sever responds, the response is embedded in the page itself as the innerHTML of the &#x27;target&#x27; tag.</div><div class=""> </div><div class=""> The &#x27;target&#x27; tag is a DIV defined in line 52. It could have been defined in the view as well.</div><div class=""> </div><div class=""> Here is the code for the view &quot;default/create.html&quot;:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Create new wiki page&lt;/h1&gt;</div><div class=""> {{=form}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> Assuming you are registered and logged in, if you visit the **create** page, you see the following:</div><div class=""> </div><div class=""> [[image @///image/en3500.png center 480px]]</div><div class=""> </div><div class=""> Here is the code for the view &quot;default/index.html&quot;:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Available wiki pages&lt;/h1&gt;</div><div class=""> [ {{=A(&#x27;search&#x27;, _href=URL(&#x27;search&#x27;))}} ]&lt;br /&gt;</div><div class=""> &lt;ul&gt;{{for page in pages:}}</div><div class="">      {{=LI(A(page.title, _href=URL(&#x27;show&#x27;, args=page.id)))}}</div><div class=""> {{pass}}&lt;/ul&gt;</div><div class=""> Here is the code for the view &quot;default/show.html&quot;:</div><div class=""> [ {{=A(&#x27;edit&#x27;, _href=URL(&#x27;edit&#x27;, args=request.args))}}</div><div class=""> | {{=A(&#x27;documents&#x27;, _href=URL(&#x27;documents&#x27;, args=request.args))}} ]&lt;br /&gt;</div><div class=""> {{=MARKMIN(page.body)}}</div><div class=""> &lt;h2&gt;Comments&lt;/h2&gt;</div><div class=""> {{for post in comments:}}</div><div class="">   &lt;p&gt;{{=db.auth_user[post.created_by].first_name}} on {{=post.created_on}}</div><div class="">      says &lt;i&gt;{{=post.body}}&lt;/i&gt;&lt;/p&gt;</div><div class=""> {{pass}}</div><div class=""> &lt;h2&gt;Post a comment&lt;/h2&gt;</div><div class=""> {{=form}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> If you wish to use markdown syntax instead of markmin syntax:</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.contrib.markdown import WIKI</div><div class=""> ``:code</div><div class=""> </div><div class=""> and use ``WIKI`` instead of the ``MARKMIN`` helper.</div><div class=""> Alternatively, you can choose to accept raw HTML instead of markmin syntax. In this case you would replace:</div><div class=""> ``</div><div class=""> {{=MARKMIN(page.body)}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> with:</div><div class=""> ``</div><div class=""> {{=XML(page.body)}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> ``sanitize``:inxx</div><div class="delete">(so that the XML does not get escaped, <span class="highlight"></span>a<span class="highlight"></span>s by default <span class="highlight">w</span>e<span class="highlight">b2p</span>y <span class="highlight">b</span>e<span class="highlight">h</span>a<span class="highlight">vi</span>o<span class="highlight">r</span>).</div><div class=""> </div><div class=""> This can be done better with:</div><div class=""> ``</div><div class=""> {{=XML(page.body, sanitize=True)}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> By setting ``sanitize=True``, you tell web2py to escape unsafe XML tags such as &quot;&lt;script&gt;&quot;, and thus prevent XSS vulnerabilities.</div><div class=""> </div><div class=""> Now if, from the index page, you click on a page title, you can see the page that you have created:</div><div class=""> </div><div class=""> [[image @///image/en3700.png center 480px]]</div><div class=""> </div><div class=""> Here is the code for the view &quot;default/edit.html&quot;:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Edit wiki page&lt;/h1&gt;</div><div class=""> [ {{=A(&#x27;show&#x27;, _href=URL(&#x27;show&#x27;, args=request.args))}} ]&lt;br /&gt;</div><div class=""> {{=form}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> It generates a page that looks almost identical to the create page.</div><div class=""> </div><div class=""> Here is the code for the view &quot;default/documents.html&quot;:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Documents for page: {{=page.title}}&lt;/h1&gt;</div><div class=""> [ {{=A(&#x27;show&#x27;, _href=URL(&#x27;show&#x27;, args=request.args))}} ]&lt;br /&gt;</div><div class=""> &lt;h2&gt;Documents&lt;/h2&gt;</div><div class=""> {{=grid}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> If, from the &quot;show&quot; page, you click on documents, you can now manage the documents attached to the page.</div><div class=""> </div><div class=""> [[image @///image/en3800.png center 480px]]</div><div class=""> </div><div class=""> Finally here is the code for the view &quot;default/search.html&quot;:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Search wiki pages&lt;/h1&gt;</div><div class=""> [ {{=A(&#x27;listall&#x27;, _href=URL(&#x27;index&#x27;))}}]&lt;br /&gt;</div><div class=""> {{=form}}&lt;br /&gt;{{=target_div}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> which generates the following Ajax search form:</div><div class=""> </div><div class=""> [[image @///image/en3900.png center 480px]]</div><div class=""> </div><div class=""> You can also try to call the callback action directly by visiting, for example, the following URL:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/mywiki/default/callback?keyword=wiki</div><div class=""> ``:code</div><div class=""> </div><div class=""> If you look at the page source you see the HTML returned by the callback:</div><div class=""> ``</div><div class=""> &lt;ul&gt;&lt;li&gt;&lt;a href=&quot;/mywiki/default/show/4&quot;&gt;I made a Wiki&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> ``rss``:inxx</div><div class="delete">Generating an RSS feed <span class="highlight"></span>f<span class="highlight"></span>r<span class="highlight">om</span> <span class="highlight">the stored</span> pages using web2py is easy because web2py includes ``gluon.contrib.rss2``. Just append the following action to the default controller:</div><div class=""> ``</div><div class=""> def news():</div><div class="delete">    <span class="highlight"></span>&quot;generates rss feed form the wiki pages&quot;<span class="highlight"></span></div><div class="">     response.generic_patterns = [&#x27;.rss&#x27;]</div><div class="">     pages = db().select(db.page.ALL, orderby=db.page.title)</div><div class="">     return dict(</div><div class="">        title = &#x27;mywiki rss feed&#x27;,</div><div class="">        link = &#x27;http://127.0.0.1:8000/mywiki/default/index&#x27;,</div><div class="">        description = &#x27;mywiki news&#x27;,</div><div class="">        created_on = request.now,</div><div class="">        items = [</div><div class="">           dict(title = row.title,</div><div class="">                link = URL(&#x27;show&#x27;, args=row.id),</div><div class="">                description = MARKMIN(row.body).xml(),</div><div class="">                created_on = row.created_on</div><div class="">                ) for row in pages])</div><div class=""> ``:code</div><div class=""> </div><div class=""> and when you visit the page</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/mywiki/default/news.rss</div><div class=""> ``:code</div><div class=""> </div><div class=""> you see the feed (the exact output depends on the feed reader). Notice that the dict is automatically converted to RSS, thanks to the .rss extension in the URL.</div><div class=""> </div><div class=""> [[image @///image/en4000.png center 480px]]</div><div class=""> </div><div class=""> web2py also includes feedparser to read third-party feeds.</div><div class=""> </div><div class=""> ``XMLRPC``:inxx</div><div class=""> Finally, let&#x27;s add an XML-RPC handler that allows searching the wiki programmatically:</div><div class=""> ``</div><div class=""> service = Service()</div><div class=""> </div><div class=""> @service.xmlrpc</div><div class=""> def find_by(keyword):</div><div class="delete">     <span class="highlight"></span>&quot;finds pages that contain keyword for XML-RPC&quot;<span class="highlight"></span></div><div class="">      return db(db.page.title.contains(keyword)).select().as_list()</div><div class=""> </div><div class=""> def call():</div><div class="delete">    <span class="highlight"></span>&quot;exposes all registered services, including XML-RPC&quot;<span class="highlight"></span></div><div class="">     return service()</div><div class=""> ``:code</div><div class=""> </div><div class=""> Here, the handler action simply publishes (via XML-RPC), the functions specified in the list. In this case, ``find_by``. ``find_by`` is not an action (because it takes an argument). It queries the database with ``.select()`` and then extracts the records as a list with ``.response`` and returns the list.</div><div class=""> </div><div class=""> Here is an example of how to access the XML-RPC handler from an external</div><div class=""> Python program.</div><div class=""> ``</div><div class=""> &gt;&gt;&gt; import xmlrpclib</div><div class=""> &gt;&gt;&gt; server = xmlrpclib.ServerProxy(</div><div class="">     &#x27;http://127.0.0.1:8000/mywiki/default/call/xmlrpc&#x27;)</div><div class=""> &gt;&gt;&gt; for item in server.find_by(&#x27;wiki&#x27;):</div><div class="">         print item[&#x27;created_on&#x27;], item[&#x27;title&#x27;]</div><div class=""> ``:code</div><div class=""> </div><div class=""> The handler can be accessed from many other programming languages that understand XML-RPC, including C, C++, C# and Java.</div><div class=""> </div><div class=""> #### On ``date``, ``datetime`` and ``time`` format</div><div class=""> </div><div class="delete">There are three different representation<span class="highlight"></span> for each of the field types ``date``, ``datetime`` and ``time``:</div><div class=""> - the database representation</div><div class="delete">- the internal web2py <span class="highlight">p</span>representation</div><div class=""> - the string representation in forms and tables</div><div class=""> </div><div class=""> The database representation is an internal issue and does not affect the code. Internally, at the web2py level, they are stored as ``datetime.date``, ``datetime.datetime`` and ``datetime.time`` object respectively and they can be manipulated as such:</div><div class=""> </div><div class=""> ``</div><div class=""> for page in db(db.page).select():</div><div class="">     print page.title, page.day, page.month, page.year</div><div class=""> ``</div><div class=""> </div><div class=""> When dates are converted to strings in forms they are converted using the ISO representation</div><div class=""> ``</div><div class=""> %Y-%m-%d %H:%M:%S</div><div class=""> ``</div><div class=""> </div><div class="delete">yet this representation i<span class="highlight">n</span> internationalized and you can use the admin <span class="highlight">s</span>translation page to change the format to an alternate one. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> %m/%b/%Y %H:%M:%S</div><div class=""> ``</div><div class=""> </div><div class="delete">Mind that by default English is not translated because web2py assumes the applications is already written in English. If you want internationalization to work for English you need to create the translation file (using admin) and you need <span class="highlight">declare that the application</span> current language is something other than english, for example:</div><div class=""> ``</div><div class=""> T.current_languages = [&#x27;null&#x27;]</div><div class=""> ``</div><div class=""> </div><div class=""> ### The built-in web2py wiki</div><div class=""> </div><div class="delete">Now you can forget the code we have built-in the previous section (not what you have learned about web2py APIs, just the code of the specific example) as we are going to provide an<span class="highlight">d</span> example of the built-in web2py wiki.</div><div class=""> </div><div class=""> In fact, web2py comes with wiki capabilities including media attachments, tags, tag cloud, page permissions, and support for oembed ``oembed``:cite and components (chapter 14). This wiki can be used with any web2py application.</div><div class=""> </div><div class=""> ------</div><div class="delete">Notice the API of the built-in wiki <span class="highlight">are</span> still considered experimental and small changes are still possible.</div><div class=""> ------</div><div class=""> </div><div class=""> Here we assume we are starting from scratch from a simple clone of the &quot;welcome&quot; application called &quot;wikidemo&quot;. Edit the controller and replace the &quot;index&quot; action with</div><div class=""> </div><div class=""> ``</div><div class=""> def index(): return auth.wiki()</div><div class=""> ``:code</div><div class=""> </div><div class="delete">Done! You have a fully working wiki. At this point no page has been created and in order to create pages you must be logged-in and you must be member of a group called &quot;wiki-editor&quot; or &quot;wiki-author&quot;. If you are logged<span class="highlight"></span> as administrator the &quot;wiki-editor&quot; group is created automatically and you are made a member. The difference between editors and authors is that the editors can create pages, edit and delete any page, while the authors can create pages (with some optional restrictions) and can only edit/delete the pages they have created.</div><div class=""> </div><div class="delete">The ``auth.wiki()`` function returns in a dictionary with a key ``content`` which is understood by the scaffolding &quot;views/default/index.html&quot;. You <span class="highlight">m</span>an make your own view for this action:</div><div class=""> </div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> {{=content}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> and add extra HTML or code as needed. There is no need to call the action &quot;index&quot;.</div><div class=""> </div><div class=""> To try the wiki, simply login into admin, visit the page</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index</div><div class=""> ``</div><div class=""> </div><div class="delete">Then choose a slug (in the publishing business, a slug is a short name given to an article that is in production) and you will be redirected to an empty page where you can edit the content using MARKMIN wiki syntax. A new menu item called &quot;[wiki]&quot; will allow you <span class="highlight"></span>create, search, and edit pages. Wiki pages have <span class="highlight"></span>R<span class="highlight">U</span>L<span class="highlight">S</span> like:</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/[slug]</div><div class=""> ``</div><div class=""> </div><div class=""> Service pages have names which start by underscore:</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_create</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_search</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_could</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_recent</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_edit/...</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_editmedia/...</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_preview/...</div><div class=""> ``</div><div class=""> </div><div class="delete">-Try create more pages such as &quot;index&quot;, &quot;aboutus&quot;, and &quot;contactus&quot;.</div><div class="delete">-Try edit them.</div><div class=""> </div><div class=""> </div><div class=""> The ``wiki`` method has the following signature:</div><div class=""> </div><div class=""> ``</div><div class=""> def wiki(self, slug=None, env=None, render=&#x27;markmin&#x27;,</div><div class="">          manage_permissions=False, force_prefix=&#x27;&#x27;,</div><div class="">          restrict_search=False, resolve=True,</div><div class="">          extra=None, menugroups=None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> It takes the following arguments:</div><div class=""> </div><div class="delete">-- ``render`` which defaults to ``&#x27;markmin&#x27;`` but can be set equal to ``&#x27;html&#x27;``. It termines the syntax of the wiki. We will discuss the markmin wiki markup later. If you change it to HTML you may want to use a wysiwyg javascript editor such as TinyMCE of NicEdit.</div><div class="delete">-- ``manage_permissions``. This is set to ``False`` by default and only recognizes permissions for &quot;wiki-editor&quot; and &quot;wiki-author&quot;. If you change it to ``True`` the create/edit page will give the option to specify by names the groups whose members have permission to read and edit the page. In this case is a group &quot;everybody&quot; to give read permission to everybody.</div><div class="delete">-- ``force_prefix``. If set to something like ``&#x27;%(id)s-&#x27;`` it will restrict authors (not editors) to create page with a prefix like &quot;[user id]-[page name]&quot;. The prefix can contain the id (&quot;%(id)s&quot;) or the username (&quot;%(username)s&quot;) or any other field from the auth_user table, as long as the corresponding column contains valid string that would pass URL validation.</div><div class="delete">-- ``restrict_search``. This default to ``False`` and any logged-in user can search all wiki pages (but not necessary read or edit them). If set to ``True``, authors can search only their own pages, editors can search everything, other users cannot search anything.</div><div class="delete">-- ``menugroups``. This defaults to ``None`` and it indicates that wiki management menu (search, create, edit, etc.) is always displayed. You can set it to a list of group names whose members only can see this menu, for example ``[&#x27;wiki-editor&#x27;,&#x27;wiki-author&#x27;]``. Notice that even if the menu is exposed to everybody does not mean everybody is allowed to perform actions listed in the menu since they are regulated by the access control system.</div><div class=""> </div><div class=""> The ``wiki`` method has some additional parameters which will be explained later: ``slug``, ``env``, and ``extra``.</div><div class=""> </div><div class=""> </div><div class=""> </div><div class=""> #### MARKMIN basics</div><div class=""> </div><div class="delete">The MARKMIN syntax allows you to markup **bold** text using ``**bold**``, &#x27;&#x27;italic&#x27;&#x27; text with ``&#x27;&#x27;italic&#x27;&#x27;``, ``code`` text with ``\`\`code\`\```. Titles must be prefixed by a #, sections by ##, and sub-sections by ###. Use a minus(-) to prefix an un-ordered item and plus(+) to prefix an ordered item. URLs are automatically <span class="highlight"></span>into links. For example:</div><div class=""> </div><div class=""> ``</div><div class="delete"># This is <span class="highlight"></span>title</div><div class=""> ## this is a section title</div><div class=""> ### this is a subsection title</div><div class=""> </div><div class=""> Text can be **bold**, &#x27;&#x27;italic&#x27;&#x27;, !`!!`!code!`!!`! etc.</div><div class=""> Learn more at:</div><div class=""> </div><div class=""> http://web2py.com</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> You can use the ``extra`` parameter of ``auth.wiki`` to pass extra rendering rules to the MARKMIN helper.</div><div class=""> </div><div class=""> You can find more information about the MARKMIN syntax in chapter 5.</div><div class=""> </div><div class=""> ``auth.wiki`` is more powerful than the barebones MARKMIN helpers, supporting oembed and components.</div><div class=""> </div><div class="delete">You can use the<span class="highlight">S</span> ``env`` parameter of ``auth.wiki`` to expose functions to your wiki.</div><div class=""> For example:</div><div class=""> </div><div class=""> ``</div><div class=""> auth.wiki(env=dict(join=lambda a,b,c:&quot;%s-%s-%s&quot; % (a,b,c)))</div><div class=""> ``</div><div class=""> </div><div class=""> allows you to use the markup syntax:</div><div class=""> </div><div class=""> ``</div><div class=""> @(join:1,2,3)</div><div class=""> ``</div><div class=""> </div><div class=""> </div><div class="delete">This call<span class="highlight"></span> the join function passed as extra with parameters ``a,b,c=1,2,3`` and will be rendered as ``1-2-3``.</div><div class=""> </div><div class=""> #### Oembed protocol</div><div class=""> </div><div class="delete">You can type in (or cut-and-paste) any URL into a wiki page <span class="highlight"></span>it<span class="highlight"> normally</span> is rendered as a link to the URL. There are exceptions:</div><div class=""> </div><div class=""> - If the URL has an image extension, the link is embedded as an image, ``&lt;img/&gt;``.</div><div class=""> - If the URL has an audio extension, the link is embedded as HTML5 audio ``&lt;audio/&gt;``.</div><div class=""> - If the URL has a video extension, the link is embedded as HTML5 video ``&lt;video/&gt;``.</div><div class=""> - If the URL has a MS Office or PDF extension, Google Doc Viewer is embedded, showing the content of the document (only works for public documents).</div><div class="delete">- If the URL points to a You<span class="highlight">t</span>ube page, a Vimeo page, or a Flickr page, web2py contacts the corresponding web service and queries it about the proper way to embed the content. This is done using the ``oembed`` protocol.</div><div class=""> </div><div class=""> Here is a complete list of supported formats:</div><div class=""> ``</div><div class=""> Image (.PNG, .GIF, .JPG, .JPEG)</div><div class=""> Audio (.WAV, .OGG, .MP3)</div><div class=""> Video (.MOV, .MPE, .MP4, .MPG, .MPG2, .MPEG, .MPEG4, .MOVIE)</div><div class=""> ``</div><div class=""> </div><div class=""> Supported via Google Doc Viewer:</div><div class=""> </div><div class=""> ``</div><div class=""> Microsoft Excel (.XLS and .XLSX)</div><div class=""> Microsoft PowerPoint 2007 / 2010 (.PPTX)</div><div class=""> Apple Pages (.PAGES)</div><div class=""> Adobe PDF (.PDF)</div><div class=""> Adobe Illustrator (.AI)</div><div class=""> Adobe Photoshop (.PSD)</div><div class=""> Autodesk AutoCad (.DXF)</div><div class=""> Scalable Vector Graphics (.SVG)</div><div class=""> PostScript (.EPS, .PS)</div><div class=""> TrueType (.TTF)</div><div class=""> xml Paper Specification (.XPS)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Supported by oembed:</div><div class=""> </div><div class=""> ``</div><div class=""> flickr.com</div><div class=""> youtube.com</div><div class=""> hulu.com</div><div class=""> Here ``\@////`` stands for</div><div class=""> ``:code</div><div class=""> </div><div class=""> but &quot;app&quot;, &quot;controller&quot;, and &quot;function&quot; are omitted thus assuming default.</div><div class=""> </div><div class=""> Similarly you can use the wiki menu to upload a media file (for example an image) linked to the page. The &quot;manage media&quot; page will show all files you have uploaded and will show the proper expression to link the media file. If, for example you upload a file &quot;test.jpg&quot; with title &quot;beach&quot;, the link expression will something like:</div><div class=""> </div><div class=""> ``</div><div class=""> \@////15/beach.jpg</div><div class=""> ``:code</div><div class=""> </div><div class=""> ``\@////`` is the same prefix described before. ``15`` is the id of the record storing the media file. ``beach`` is the title. ``.jpg`` is the extension of the original file.</div><div class=""> </div><div class=""> If you cut and paste ``\@////15/beach.jpg`` into wiki pages you embed the image.</div><div class=""> </div><div class=""> Mind that media files are linked to pages and inherit access permission from the pages.</div><div class=""> </div><div class=""> #### Wiki menus</div><div class=""> </div><div class=""> If you create a page with slug &quot;wiki-menu&quot; page it will be interpreted as a description of the menu. Here is an example:</div><div class=""> </div><div class=""> ``</div><div class=""> - Home &gt; \@////index</div><div class=""> - Info &gt; \@////info</div><div class=""> - web2py &gt; http://google.com</div><div class=""> - - About us &gt; \@////aboutus</div><div class=""> - - Contact us &gt; \@////contactus</div><div class=""> ``</div><div class=""> </div><div class=""> Each line a menu item. We used double dash for nested menu items. The ``&gt;`` symbols separates the menu item title from the menu item link.</div><div class=""> </div><div class="delete">Mind that the menu is appended to ``response.menu``. It does not replace it. The ``[wiki]`` menu <span class="highlight"></span>tem with service functions is added automatically.</div><div class=""> </div><div class=""> #### Service functions</div><div class=""> </div><div class=""> If, for example, you want to use the wiki to create an editable sidebar you could create a page with ``slug=&quot;sidebar&quot;`` and then embed it in your layout.html with</div><div class=""> </div><div class=""> ``</div><div class=""> {{=auth.wiki(slug=&#x27;sidebar&#x27;)}}</div><div class=""> ``:code</div><div class=""> </div><div class="delete">Notice that there is nothing special with the word &quot;sidebar&quot;. Any wiki page can be retrieved and embedded <span class="highlight">in</span> any point in your code. This allows you mix and match wiki functionalities with regular web2py functionalities.</div><div class=""> </div><div class=""> ------</div><div class=""> Also note that ``auth.wiki(&#x27;sidebar&#x27;)``:code is the same as ``auth.wiki(slug=&#x27;sidebar&#x27;)``:code, since the slug kwarg is the first in the method signature. The former gives a slightly simpler syntax.</div><div class=""> ------</div><div class=""> </div><div class=""> </div><div class="delete">You can also embed special wiki functions <span class="highlight"></span>as the search by tags:</div><div class=""> </div><div class=""> ``</div><div class=""> {{=auth.wiki(&#x27;_search&#x27;)}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> or the tag cloud:</div><div class=""> </div><div class=""> ``</div><div class=""> {{=auth.wiki(&#x27;_cloud&#x27;)}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> #### Extending the auth.wiki feature</div><div class=""> </div><div class=""> When your wiki-enabled app gets more complicated, perhaps you might need to customize the wiki db records managed by the Auth interface or expose customized forms for wiki CRUD tasks. For example, you might want to customize a wiki table record representation or add a new field validator. This is not allowed by default, since the wiki model is defined only after the wiki interface is requested with the auth.wiki() method. To allow access to the wiki specific db setup within the model of your app you must add the following sentence to your model file (i.e. db.py)</div><div class=""> </div><div class=""> ``</div><div class=""> # Make sure this is called after the auth instance is created</div><div class=""> # and before any change to the wiki tables</div><div class=""> auth.wiki(resolve=False)</div><div class=""> ``:code</div><div class=""> </div><div class=""> By using the line above in your model, the wiki tables will be accessible (i.e. ``wiki_page``) for custom CRUD or other db tasks.</div><div class=""> </div><div class=""> ------</div><div class=""> Note that you still have to call auth.wiki() in the controller or view in order to expose the wiki interface, since the ``resolve=False`` parameter instructs the auth object to just build the wiki model without any other interface setup.</div><div class=""> ------</div><div class=""> </div><div class=""> </div><div class="delete">Also, by setting resolve to ``False`` in the method call, the wiki tables will be now acces<span class="highlight"></span>ible t<span class="highlight"></span>rough the app&#x27;s default db interface at ``&lt;app&gt;/appadmin`` for managing wiki records.</div><div class=""> </div><div class=""> </div><div class=""> Another customization possible is adding extra fields to the standard wiki tables (in the same way as with the ``auth_user`` table, as described in Chapter 9). Here is how:</div><div class=""> </div><div class=""> ``</div><div class=""> # Place this after auth object initialization</div><div class=""> auth.settings.extra_fields[&quot;wiki_page&quot;] = [Field(&quot;ablob&quot;, &quot;blob&quot;),]</div><div class=""> ``:code</div><div class=""> </div><div class=""> The line above adds a ``blob`` field to the ``wiki_page`` table. There is no need to call ``auth.wiki(resolve=False)``:code for this option, unless you need access to the wiki model for other customizations.</div><div class=""> </div><div class=""> </div><div class=""> #### Components</div><div class=""> </div><div class="delete">One of the most powerful function<span class="highlight"></span> of the new web2py consists in the ability of embedding an action inside another action. We call this a component.</div><div class=""> </div><div class=""> Consider the following model:</div><div class=""> </div><div class=""> ``</div><div class=""> db.define_table(&#x27;thing&#x27;,Field(&#x27;name&#x27;,requires=IS_NOT_EMPTY()))</div><div class=""> ``:code</div><div class=""> </div><div class=""> and the following action:</div><div class=""> </div><div class=""> ``</div><div class=""> @auth.requires_login()</div><div class=""> def manage_things():</div><div class="">     return SQLFORM.grid(db.thing)</div><div class=""> ``:code</div><div class=""> </div><div class=""> This action is special because it returns a widget/helper not a dict of objects. Now we can embed this ``manage_things`` action into any view, with</div><div class=""> </div><div class=""> ``</div><div class=""> {{=LOAD(&#x27;default&#x27;,&#x27;manage_things&#x27;,ajax=True)}}</div><div class=""> ``:code</div><div class=""> </div><div class="delete">This allows the visitor interact with the component via Ajax without reloading the host page that embeds the widget. Basically the action is called via Ajax, inherits the st<span class="highlight">i</span>le of the host page, and capture<span class="highlight"> all forms</span> submissions and flash messages so that they are handled within the current page. On top of this the ``SQLFORM.grid`` widget uses digitally signed URLs to restrict access. More information about components can be found in chapter 13.</div><div class=""> </div><div class=""> Components like the one above can be embedded into wiki pages using the MARKMIN syntax:</div><div class=""> </div><div class=""> ``</div><div class=""> @{component:default/manage_things}</div><div class=""> ``</div><div class=""> </div><div class="delete">This simply tells web2py that we want to inc<span class="highlight"></span>ude the &quot;manage_things&quot; action defined in the &quot;default&quot; controller as an Ajax &quot;component&quot;.</div><div class=""> </div><div class=""> ---------</div><div class=""> Most users will be able to build relatively complex applications simply by using ``auth.wiki`` to create pages and menus and embedded custom components into wiki pages. Wikis can be thought of as a mechanism to allow members of the group to create pages, but they can also be thought of as a way to develop applications in a modular way.</div><div class=""> ---------</div><div class=""> </div><div class=""> ### More on **admin**</div><div class=""> ``admin``:inxx</div><div class=""> </div><div class=""> The administrative interface provides additional functionality that we briefly review here.</div><div class=""> </div><div class=""> #### Site</div><div class=""> ``site``:inxx</div><div class=""> </div><div class=""> This page is the main administrative interface of web2py. It lists all installed applications on the left, while on the right side there are some special action forms.</div><div class=""> </div><div class=""> The first of them shows the web2py version and proposes to upgrade it if new versions are available. Of course, before upgrading be sure to have a full working backup!</div><div class=""> Then there are two other forms that allow the creation of a new application (simple or by using an online wizard) by specifying its name.</div><div class=""> </div><div class=""> ``Instant Press``:inxx ``Movuca``:inxx</div><div class=""> The following form allows uploading an existing application from either a local file or a remote URL. When you upload an application, you need to specify a name for it (using different names</div><div class=""> allows you to install multiple copies of the same application). You can try, for example, to upload the Movuca Social Networking application app created by Bruno Rocha:</div><div class=""> </div><div class=""> ``</div><div class=""> http://code.google.com/p/instant-press/</div><div class=""> ``</div><div class=""> </div><div class=""> or Instant Press CMS created by Martin Mulone:</div><div class=""> </div><div class=""> ``</div><div class=""> http://code.google.com/p/instant-press/</div><div class=""> ``</div><div class=""> </div><div class=""> or one of the many example applications available at:</div><div class=""> </div><div class=""> ``</div><div class=""> http://web2py.com/appliances</div><div class=""> ``</div><div class=""> </div><div class=""> ------</div><div class="delete">Web2py files are packages as ``.w2p`` files. These<span class="highlight"> ones</span> are tar gzipped files. Web2py uses the ``.w2p`` extension instead of the ``.tgz`` extension to prevent the browser from unzipping on download. They can be uncompressed manually with ``tar zxvf [filename]`` although this is never necessary.</div><div class=""> ------</div><div class=""> </div><div class=""> [[image @///image/en4100.png center 444px]]</div><div class=""> </div><div class=""> Upon successful upload, web2py displays the MD5 checksum of the uploaded file. You can use it to verify that the file was not corrupted during upload. The InstantPress name will appear in the list of installed applications.</div><div class=""> </div><div class=""> If you run web2py from source and you have ``gitpython`` installed (if necessary, set it up with &#x27;easy_install gitpython&#x27;), you can install applications directly from git repositories</div><div class=""> using the ``.git`` URL in the upload form. In this case you will also be enabled to use the admin interface to push changes back into the repository, but this is an experimental feature.</div><div class=""> </div><div class=""> For example, you can locally install the application that shows this book on the web2py site with the URL:</div><div class=""> </div><div class=""> ``</div><div class=""> https://github.com/mdipierro/web2py-book.git</div><div class=""> ``</div><div class=""> </div><div class=""> ------</div><div class=""> That repository hosts the current, updated version of this book (which could be different from the stable version you can see on the web site). You are warmly invited to use it for submitting</div><div class=""> improvements, fixes and corrections in the form of pull requests.</div><div class=""> ------</div><div class="">   </div><div class=""> For each application installed you can use the &#x27;&#x27;site&#x27;&#x27; page to:</div><div class=""> - Go directly to the application by clicking on its name.</div><div class=""> - Uninstall the application.</div><div class=""> - Jump to the &#x27;&#x27;about&#x27;&#x27; page (read below).</div><div class=""> - Jump to the &#x27;&#x27;edit&#x27;&#x27; page (read below).</div><div class=""> - Jump to the &#x27;&#x27;errors&#x27;&#x27; page (read below).</div><div class=""> - Clean up temporary files (sessions, errors, and cache.disk files).</div><div class=""> - Pack all. This returns a tar file containing a complete copy of the application. We suggest that you clean up temporary files before packing an application.</div><div class="delete">-- Compile the application. If there are no errors, this option will bytecode-compile all models, controllers and views. Because views can extend and include other views in a tree, before bytecode compilation, the view tree for every controller is collapsed into a single file. The net effect is that a bytecode-compiled application is faster, because there is no more parsing of templates or string substitutions occurring at runtime.</div><div class="delete">-- Pack compiled. This option is only present for bytecode-compiled applications. It allows packing the application without source code for distribution as closed source. Note that Python (as any other programming language) can technically be decompiled; therefore compilation does not provide complete protection of the source code. Nevertheless, decompilation can be difficult and can be illegal.</div><div class=""> - Remove compiled. It simply removes the byte-code compiled models, views and controllers from the application. If the application was packaged with source code or edited locally, there is no harm in removing the bytecode-compiled files, and the application will continue to work. If the application was installed form a packed compiled file, then this is not safe, because there is no source code to revert to, and the application will no longer work.</div><div class=""> </div><div class=""> ``admin.py``:inxx</div><div class=""> </div><div class=""> -------</div><div class=""> All the functionality available from the web2py admin site page is also accessible programmatically via the API defined in the module ``gluon/admin.py``. Simply open a python shell and import this module.</div><div class=""> -------</div><div class=""> </div><div class=""> If the Google App Engine SDK is installer the admin &#x27;&#x27;site&#x27;&#x27; page shows a button to push your applications to GAE. If ``python-git`` is installed, there is also a button to push your application to Open Shift. To install applications on ``Heroku`` or other hosting system you should look into the &quot;scripts&quot; folder for the appropriate script.</div><div class=""> </div><div class=""> #### About</div><div class=""> ``about``:inxx ``license``:inxx</div><div class=""> </div><div class=""> The &#x27;&#x27;about&#x27;&#x27; tab allows editing the description of the application and its license. These are written respectively in the ABOUT and LICENSE files in the application folder.</div><div class=""> </div><div class=""> [[image @///image/en4300.png center 480px]]</div><div class=""> </div><div class=""> You can use ``MARKMIN``, or ``gluon.contrib.markdown.WIKI`` syntax for these files as described in ref.``markdown2``:cite .</div><div class=""> </div><div class=""> #### Design</div><div class=""> ``EDIT``:inxx</div><div class=""> You have used the &#x27;&#x27;edit&#x27;&#x27; page already in this chapter. Here we want to point out a few more functionalities of the &#x27;&#x27;edit&#x27;&#x27; page.</div><div class=""> - If you click on any file name, you can see the contents of the file with syntax highlighting.</div><div class=""> - If you click on edit, you can edit the file via a web interface.</div><div class=""> - If you click on delete, you can delete the file (permanently).</div><div class=""> - If you click on test, web2py will run tests. Tests are written by the developer using Python doctests, and each function should have its own tests.</div><div class=""> - You can add language files, scan the app to discover all strings, and edit string translations via the web interface.</div><div class=""> - If the static files are organized in folders and subfolders, the folder hierarchy can be toggled by clicking on a folder name.</div><div class=""> </div><div class=""> The image below shows the output of the test page for the welcome application.</div><div class=""> The image below show the languages tab for the welcome application.</div><div class=""> [[image @///image/en4500.png center 480px]]</div><div class=""> </div><div class=""> The image below shows how to edit a language file, in this case the &quot;it&quot; (Italian) language for the welcome application.</div><div class=""> </div><div class=""> [[image @///image/en4600.png center 480px]]</div><div class=""> </div><div class=""> ##### Integrated debugger</div><div class=""> </div><div class=""> &#x27;&#x27;(requires Python 2.6 or later)&#x27;&#x27;</div><div class=""> </div><div class=""> The web2py admin includes a web based debugger. Using the provided web-based editor you can add breakpoints to the Python code and, from the associated debugger console, you can inspect the system variables at those breakpoints and resume execution. This is illustrated in the following screenshot:</div><div class=""> </div><div class=""> [[image @///image/debugger.png center 480px]]</div><div class=""> </div><div class=""> This functionality is based on the Qdb debugger created by Mariano Reingart.</div><div class=""> It uses multiprocessing.connection to communicate between the backend</div><div class=""> and frontend, with a JSON-RPC-like stream protocol. ``qdb``:cite</div><div class=""> </div><div class=""> ##### Shell</div><div class=""> </div><div class=""> If you click on the &quot;shell&quot; link under the controllers tab in &#x27;&#x27;edit&#x27;&#x27;, web2py will open a web based Python shell and will execute the models for the current application. This allows you to interactively talk to your application.</div><div class=""> </div><div class=""> [[image @///image/en4700.png center 480px]]</div><div class=""> </div><div class=""> -------</div><div class=""> Be careful using the web based shell - because different shell requests will be executed in different threads. This easily gives errors, especially if you play with databases</div><div class=""> creation and connections. For activities like these (i.e. if you need persistence) it&#x27;s much better to use the python command line.</div><div class=""> -------</div><div class=""> ##### Crontab</div><div class=""> </div><div class="delete">Also under the controllers tab in &#x27;&#x27;edit&#x27;&#x27; there is a &quot;crontab&quot; link. By clicking on this link you will be able to edit the web2py crontab file. This follows the same syntax as the <span class="highlight">u</span>nix crontab but does not rely on <span class="highlight">u</span>nix. In fact, it only requires web2py, and it works on Windows. It allows you to register actions that need to be executed in background at scheduled times.</div><div class=""> For more information about this, see the next chapter.</div><div class=""> </div><div class=""> #### Errors</div><div class=""> ``errors``:inxx</div><div class=""> </div><div class=""> When programming web2py, you will inevitably make mistakes and introduce bugs. web2py helps in two ways: 1) it allows you to create tests for every function that can be run in the browser from the &#x27;&#x27;edit&#x27;&#x27; page; and 2) when an error manifests itself, a ticket is issued to the visitor and the error is logged.</div><div class=""> </div><div class=""> Intentionally introduce an error in the images application as shown below:</div><div class=""> ``</div><div class=""> def index():</div><div class="">     images = db().select(db.image.ALL,orderby=db.image.title)</div><div class="">     1/0</div><div class="">     return dict(images=images)</div><div class=""> ``:code</div><div class=""> </div><div class=""> When you access the index action, you get the following ticket:</div><div class=""> </div><div class=""> [[image @///image/en4800.png center 480px]]</div><div class=""> </div><div class=""> Only the administrator can access the ticket:</div><div class=""> </div><div class=""> [[image @///image/en4900.png center 480px]]</div><div class=""> </div><div class=""> The ticket shows the traceback, and the content of the file that caused the problem, and the complete state of system (variables, request, session, etc.) If the error occurs in a view, web2py shows the view converted from HTML into Python code. This allows to easily identify the logical structure of the file.</div><div class=""> </div><div class="delete">By default tickets are stored on filesystem and <span class="highlight">group</span> by traceback. The administrative interface provides an aggregate views (type of traceback and number of occurrence) and a detailed view (all tickets are listed by ticket id). The administrator can switch between the two views.</div><div class=""> </div><div class=""> Notice that everywhere **admin** shows syntax-highlighted code (for example, in error reports, web2py keywords are shown in orange). If you click on a web2py keyword, you are redirected to a documentation page about the keyword.</div><div class=""> </div><div class=""> If you fix the divide-by-zero bug in the index action and introduce one in the index view:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> </div><div class=""> &lt;h1&gt;Current Images&lt;/h1&gt;</div><div class=""> &lt;ul&gt;</div><div class=""> {{for image in images:}}</div><div class=""> {{1/0}}</div><div class=""> {{=LI(A(image.title, _href=URL(&quot;show&quot;, args=image.id)))}}</div><div class=""> {{pass}}</div><div class=""> &lt;/ul&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> you get the following ticket:</div><div class=""> </div><div class=""> [[image @///image/en5000.png center 480px]]</div><div class=""> </div><div class=""> Note that web2py has converted the view from HTML into a Python file, and the error described in the ticket refers to the generated Python code and NOT to the original view file:</div><div class=""> </div><div class=""> [[image @///image/en5100.png center 480px]]</div><div class=""> </div><div class=""> This may seem confusing at first, but in practice it makes debugging easier, because the Python indentation highlights the logical structure of the code that you embedded in the views.</div><div class=""> </div><div class=""> The code is shown at the bottom of the same page.</div><div class=""> </div><div class=""> All tickets are listed under admin in the &#x27;&#x27;errors&#x27;&#x27; page for each application:</div><div class=""> </div><div class=""> You can access the wizard from the &quot;sites&quot; page as shown in the image below.</div><div class=""> The wizard will guide you through a series of steps involved in creating a new application:</div><div class=""> </div><div class=""> - Chose a name for the application</div><div class=""> - Configure the application and choose required plugins</div><div class=""> - Build required models (it will create CRUD pages for each model)</div><div class=""> - Allow you to edit the views of those pages using MARKMIN syntax</div><div class=""> </div><div class=""> The image below shows the second step of the process.</div><div class=""> </div><div class=""> [[image @///image/en5500.png center 480px]]</div><div class=""> </div><div class=""> You can see a dropdown to select a layout plugin (from ``web2py.com/layouts``), a multiple choice dropdown to check other plugins (from ``web2py.com/plugins``) and a &quot;login config&quot; field where to put the Janrain &quot;domain:key&quot;.</div><div class=""> </div><div class=""> The other steps are pretty much self-explanatory.</div><div class=""> </div><div class=""> The Wizard works well for what it does but it is considered an &#x27;&#x27;experimental feature&#x27;&#x27; for two reasons:</div><div class=""> </div><div class=""> - Applications created with the wizard and edited manually, cannot later be modified by the wizard.</div><div class=""> - The interface of the wizard will change over time to include support for more features and easier visual development.</div><div class=""> </div><div class=""> In any case the wizard is a handy tool for fast prototyping and it can be used to bootstrap a new application with an alternate layout and optional plugins.</div><div class=""> </div><div class=""> #### Configuring **admin**</div><div class=""> </div><div class=""> Normally there is no need to perform any configuration of admin but a few customizations are possible. After you login into admin you can edit the admin configuration file via the URL:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/admin/default/edit/admin/models/0.py</div><div class=""> ``</div><div class=""> Notice that **admin** can be used to edit itself. In fact **admin** is an app as any other one.</div><div class=""> </div><div class="delete">The file &quot;0.py&quot; is very much self documented and if you are opening probably you already know what you are looking for. Anyway <span class="highlight"></span>few customizations exist that are more important than others:</div><div class=""> </div><div class=""> ``</div><div class=""> GAE_APPCFG = os.path.abspath(os.path.join(&#x27;/usr/local/bin/appcfg.py&#x27;))</div><div class=""> ``</div><div class="delete">This should point to the location of the &quot;appcfg.py&quot; file that comes with the Google App Engine SDK. If you have the SDK you may want to change th<span class="highlight">is</span> config parameters to the correct value. It will allow you to deploy to GAE from the admin interface.</div><div class=""> </div><div class=""> ``DEMO_MODE``:inxx</div><div class=""> </div><div class=""> You can also set web2py admin in demo mode:</div><div class=""> ``</div><div class=""> DEMO_MODE = True</div><div class=""> FILTER_APPS = [&#x27;welcome&#x27;]</div><div class=""> ``</div><div class=""> And only the apps listed in filter apps will be accessible and they will be only accessible in read-only mode.</div><div class=""> </div><div class=""> ``MULTI_USER_MODE``:inxx</div><div class=""> ``virtual laboratory``:inxx</div><div class=""> </div><div class=""> If you are a teacher and want to expose the administrative interface to students so that students can share one administrative interface for their projects (think of a virtual lab), can do it by setting:</div><div class=""> ``</div><div class=""> MULTI_USER_MODE = True</div><div class=""> ``</div><div class=""> In this way students will be required to login and will only be able to access their own apps via admin. You, as first user/teacher, will be able to access them all.</div><div class=""> </div><div class="delete">In multi user mode, you can register students using the &quot;bulk register&quot; link in admin and manage them using the &quot;manage students&quot; link. The system also keep<span class="highlight"></span> track of when students login and how many lines of code<span class="highlight"></span> add/remove to/from their code. This data is presented to the administrator as charts under the application &quot;about&quot; page.</div><div class=""> </div><div class=""> Mind that this mechanism still assumes all users are trusted. All the apps created under admin run under the same credentials on the same filesystem. It is possible for an app created by a student to access the data and the source of an app created by another student. It is also possible for a student to create an app that locks the server.</div><div class=""> </div><div class=""> #### Mobile **admin**</div><div class=""> </div><div class="delete">Notice that the admin application includes &quot;plugin_jqmo<span class="highlight">d</span>ile&quot; which packages jQuery Mobile. When admin is accessed from a mobile device; this is detected by web2py and the interface is displayed using a mobile-friendly layout.</div><div class=""> </div><div class=""> ### More on **appadmin**</div><div class=""> </div><div class=""> ``appadmin``:inxx</div><div class=""> </div><div class=""> **appadmin** is not intended to be exposed to the public. It is designed to help you by providing an easy access to the database. It consists of only two files: a controller &quot;appadmin.py&quot; and a view &quot;appadmin.html&quot; which are used by all actions in the controller.</div><div class=""> </div><div class=""> The **appadmin** controller is relatively small and readable; it provides an example of designing a database interface.</div><div class=""> </div><div class=""> **appadmin** shows which databases are available and which tables exist in each database. You can insert records and list all records for each table individually. **appadmin** paginates output 100 records at a time.</div><div class=""> </div><div class=""> Once a set of records is selected, the header of the pages changes, allowing you to update or delete the selected records.</div><div class=""> </div><div class=""> To update the records, enter an SQL assignment in the Query string field:</div><div class=""> ``</div><div class=""> title = &#x27;test&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class=""> where string values must be enclosed in single quotes. Multiple fields can be separated by commas.</div><div class=""> </div><div class=""> To delete a record, click the corresponding checkbox to confirm that you are sure.</div><div class=""> </div><div class=""> **appadmin** can also perform joins if the SQL FILTER contains a SQL condition that involves two or more tables. For example, try:</div><div class=""> ``</div><div class=""> db.image.id == db.post.image_id</div><div class=""> ``:code</div><div class=""> </div><div class=""> web2py passes this along to the DAL, and it understands that the query links two tables; hence, both tables are selected with an INNER JOIN. Here is the output:</div><div class=""> </div><div class=""> [[image @///image/en5600.png center 480px]]</div><div class=""> </div><div class=""> If you click on the number of an id field, you get an edit page for the record with the corresponding id.</div><div class=""> </div><div class=""> If you click on the number of a reference field, you get an edit page for the referenced record.</div><div class=""> </div><div class=""> You cannot update or delete rows selected by a join, because they involve records from multiple tables and this would be ambiguous.</div><div class=""> </div><div class="delete">In addition to its database administration capabilities, **appadmin** also enables you to view details about the contents of the application&#x27;s ``cache`` (at ``/yourapp/appadmin/c<span class="highlight">c</span>ache``) as well as the contents of the current ``request``, ``response``, and ``session`` objects (at ``/yourapp/appadmin/state``).</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/c26286af0510d09ac5f9287336fc3a099d6813ef">c26286a</a><ul><li>Date : 2012-12-28</li><li>Chapter 3: auth.wiki custom model section</li></ul></li></ul>
<div class="row-fluid" id="com_c26286af0510d09ac5f9287336fc3a099d6813ef">
    <div class="span6"><div class="diff"><div class="insert">+------</div><div class="insert">+Also note that ``auth.wiki(&#x27;sidebar&#x27;)``:code is the same as ``auth.wiki(slug=&#x27;sidebar&#x27;)``:code, since the slug kwarg is the first in the method signature. The former gives a slightly simpler syntax.</div><div class="insert">+------</div><div class="insert">+</div><div class="insert">+</div><div class=""> You can also embed special wiki functions as the search by tags:</div><div class=""> </div><div class=""> ``</div><div class=""> {{=auth.wiki(&#x27;_search&#x27;)}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> or the tag cloud:</div><div class=""> </div><div class=""> ``</div><div class=""> {{=auth.wiki(&#x27;_cloud&#x27;)}}</div><div class=""> ``:code</div><div class=""> </div><div class="insert">+</div><div class="insert">+#### Extending the auth.wiki feature</div><div class="insert">+</div><div class="insert">+When your wiki-enabled gets more complicated, perhaps you might need to customize the wiki db records managed by the Auth interface or expose customized forms for wiki CRUD tasks. For example, you might want to customize a wiki table record representation or add a new field validator. This is not allowed by default, since the wiki model is defined only after the wiki interface is requested with the auth.wiki() method. To allow access to the wiki specific db setup within the model of your app you must add the following sentence to your model file (i.e. db.py)</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+# Make sure this is called after the auth instance is created</div><div class="insert">+# and before any change to the wiki tables</div><div class="insert">+auth.wiki(resolve=False)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+By using the line above in your model, the wiki tables will be accessible (i.e. ``wiki_page``) for custom CRUD or other db tasks.</div><div class="insert">+</div><div class="insert">+------</div><div class="insert">+Note that you still have to call auth.wiki() in the controller or view in order to expose the wiki interface, since the ``resolve=False`` parameter instructs the auth object to just build the wiki model without any other interface setup.</div><div class="insert">+------</div><div class="insert">+</div><div class="insert">+</div><div class="insert">+Also, by setting resolve to ``True`` in the method call, the wiki tables will be now accesible trough the app&#x27;s default db interface at ``&lt;app&gt;/appadmin`` for managing wiki records.</div><div class="insert">+</div><div class="insert">+</div><div class="insert">+Another customization possible is adding extra fields to the standard wiki tables (in the same way as with the ``auth_user`` table, as described in Chapter 9). Here is how:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+# Place this after auth object initialization</div><div class="insert">+auth.settings.extra_fields[&quot;wiki_page&quot;] = [Field(&quot;ablob&quot;, &quot;blob&quot;),]</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+The line above adds a blob field to the wiki_page table. There is no need to call ``auth.wiki(resolve=False)``:code for this option, unless you need access to the wiki model for other customizations.</div><div class="insert">+</div><div class="insert">+</div><div class=""> #### Components</div></div></div>
    <div class="span6"><div class="diff"><div class=""> You can also embed special wiki functions as the search by tags:</div><div class=""> </div><div class=""> ``</div><div class=""> {{=auth.wiki(&#x27;_search&#x27;)}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> or the tag cloud:</div><div class=""> </div><div class=""> ``</div><div class=""> {{=auth.wiki(&#x27;_cloud&#x27;)}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> #### Components</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/82dc64e7baa231edd3896ca7a0d41393e426f123">82dc64e</a><ul><li>Date : 2012-12-19</li><li>lots of small additions</li></ul></li></ul>
<div class="row-fluid" id="com_82dc64e7baa231edd3896ca7a0d41393e426f123">
    <div class="span6"><div class="diff"><div class="insert">To run web2py on Windows from source install first <span class="highlight"></span>Mark Hammond&#x27;s <span class="highlight">[[</span>Python for Windows extensions http://sourceforge.net/projects/pywin32/]], then run:</div><div class=""> ``</div><div class=""> python2.5 web2py.py</div><div class=""> ``:code</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">To run web2py on Windows from source install first <span class="highlight"> [[</span>Mark Hammond&#x27;s <span class="highlight">&quot;</span>Python for Windows extensions http://sourceforge.net/projects/pywin32/]], then run:</div><div class=""> ``</div><div class=""> python2.5 web2py.py</div><div class=""> ``:code</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/9f8f7358720ecddc06a79b90a68cc94ae5b28603">9f8f735</a><ul><li>Date : 2013-02-25</li><li>some edits</li></ul></li></ul>
<div class="row-fluid" id="com_9f8f7358720ecddc06a79b90a68cc94ae5b28603">
    <div class="span6"><div class="diff"><div class=""> ------</div><div class="insert">Attention, to run web2py on Windows from source you must install first Mark Hammond&#x27;s <span class="highlight">w</span>in<span class="highlight">32</span> extensions <span class="highlight">from ``</span>http://sourceforge.net/projects/pywin32/<span class="highlight">``.</span></div><div class=""> ------</div><div class=""> </div><div class=""> The web2py program accepts various command line options which are discussed later.</div><div class=""> </div><div class=""> By default, at startup, web2py displays a startup window and then displays a GUI widget that asks you to choose a one-time administrator password, the IP address of the network interface to be used for the web server, and a port number from which to serve requests. By default, web2py runs its web server on 127.0.0.1:8000 (port 8000 on localhost), but you can run it on any available IP address and port. You can query the IP address of your network interface by opening a command line and typing ``ipconfig`` on Windows or ``ifconfig`` on OS X and Linux. From now on we assume web2py is running on localhost (127.0.0.1:8000). Use 0.0.0.0:80 to run web2py publicly on any of your network interfaces.</div><div class=""> </div><div class=""> [[image @///image/en400.png center 306px]]</div><div class=""> </div><div class=""> If you do not provide an administrator password, the administration interface is disabled. This is a security measure to prevent publicly exposing the admin interface.</div><div class=""> </div><div class=""> The administrative interface, **admin**, is only accessible from localhost unless you run web2py behind Apache with mod_proxy. If **admin** detects a proxy, the session cookie is set to secure and **admin** login does not work unless the communication between the client and the proxy goes over HTTPS; this is a security measure. All communications between the client and **admin** must always be local or encrypted; otherwise an attacker would be able to perform a man-in-the middle attack or a replay attack and execute arbitrary code on the server.</div><div class=""> </div><div class=""> After the administration password has been set, web2py starts up the web browser at the page:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/</div><div class=""> ``:code</div><div class=""> </div><div class=""> If the computer does not have a default browser, open a web browser and enter the URL.</div><div class=""> </div><div class=""> [[image @///image/en500.png center 480px]]</div><div class=""> </div><div class=""> Clicking on &quot;administrative interface&quot; takes you to the login page for the administration interface.</div><div class=""> </div><div class=""> [[image @///image/en600.png center 480px]]</div><div class=""> </div><div class=""> The administrator password is the password you chose at startup.</div><div class=""> Notice that there is only one administrator, and therefore only one administrator password. For security reasons, the developer is asked to choose a new password every time web2py starts unless the &lt;recycle&gt; option is specified. This is distinct from the authentication mechanism in web2py applications.</div><div class=""> </div><div class=""> After the administrator logs into web2py, the browser is redirected to the &quot;site&quot; page.</div><div class=""> </div><div class=""> [[image @///image/en700.png center 480px]]</div><div class=""> </div><div class=""> This page lists all installed web2py applications and allows the administrator to manage them.</div><div class=""> web2py comes with three applications:</div><div class=""> ``admin``:inxx ``examples``:inxx ``welcome``:inxx ``scaffolding``:inxx</div><div class=""> - An **admin** application, the one you are using right now.</div><div class=""> - An **examples** application, with the online interactive documentation and a replica of the web2py official website.</div><div class="insert">- A **welcome** application. This is the basic template for any other web2py application. It is referred to as the <span class="highlight">&#x27;&#x27;</span>scaffolding application<span class="highlight">&#x27;&#x27;</span>. This is also the application that welcomes a user at startup.</div><div class=""> </div><div class=""> ``appliances``:inxx</div><div class=""> Ready-to-use web2py applications are referred to as web2py &#x27;&#x27;appliances&#x27;&#x27;.  You can download many freely available appliances from ``appliances``:cite . web2py users are encouraged to submit new appliances, either in open-source or closed-source (compiled and packed) form.</div><div class=""> </div><div class=""> From the **admin** application&#x27;s &#x27;&#x27;site&#x27;&#x27; page, you can perform the following operations:</div><div class=""> - **install** an application by completing the form on the bottom right of the page. Give a name to the application, select the file containing a packaged application or the URL where the application is located, and click &quot;submit&quot;.</div><div class=""> - **uninstall** an application by clicking the corresponding button. There is a confirmation page.</div><div class=""> - **create** a new application by choosing a name and clicking &quot;create&quot;.</div><div class=""> - **package** an application for distribution by clicking on the corresponding button. A downloaded application is a tar file containing everything, including the database. You should not untar this file; it is automatically unpackaged by web2py when installed with **admin**.</div><div class=""> - **clean up** an application&#x27;s temporary files, such as sessions, errors and cache files.</div><div class="insert">+- **enable/disable** each application. When an application is disabled it cannot be called remotely but it is not disabled form localhost. This means disabled applications can still be accessed behind a proxy. An application is disabled by creating a file called &quot;DISABLED&quot; in the application folder. Users who try to access a disabled application will receive a 503 HTTP error. You can use routes_onerror to customize the error page.</div><div class=""> - **EDIT** an application.</div><div class=""> </div><div class=""> -----</div><div class=""> When you create a new application using **admin**, it starts as a clone of the &quot;welcome&quot; scaffolding app with a &quot;models/db.py&quot; that creates a SQLite database, connects to it, instantiates Auth, Crud, and Service, and configures them. It also provides a &quot;controller/default.py&quot; which exposes actions &quot;index&quot;, &quot;download&quot;, &quot;user&quot; for user management, and &quot;call&quot; for services. In the following, we assume that these files have been removed; we will be creating apps from scratch.</div><div class=""> -----</div><div class=""> </div><div class=""> web2py also comes with a **wizard**, described later in this chapter, that can write an alternate scaffolding code for you based on layouts and plugins available on the web and based on high level description of the models.</div><div class=""> </div><div class=""> ### Simple examples</div><div class=""> </div><div class=""> #### Say hello</div><div class=""> ``index``:inxx</div><div class=""> </div><div class=""> Here, as an example, we create a simple web app that displays the message &quot;Hello from MyApp&quot; to the user. We will call this application &quot;myapp&quot;. We will also add a counter that counts how many times the same user visits the page.</div><div class=""> </div><div class=""> You can create a new application simply by typing its name in the form on the top right of the **site** page in **admin**.</div><div class=""> </div><div class=""> [[image @///image/en800.png center 447px]]</div><div class=""> </div><div class=""> After you press [create], the application is created as a copy of the built-in welcome application.</div><div class=""> </div><div class=""> [[image @///image/en900.png center 480px]]</div><div class=""> </div><div class=""> To run the new application, visit:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/myapp</div><div class=""> ``:code</div><div class=""> </div><div class=""> Now you have a copy of the welcome application.</div><div class=""> </div><div class=""> Here is what the online editor looks like:</div><div class=""> </div><div class=""> Save it and go back to the &#x27;&#x27;edit&#x27;&#x27; page. Click on the index link to visit the newly created page.</div><div class=""> </div><div class=""> When you visit the URL</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/myapp/default/index</div><div class=""> ``:code</div><div class=""> </div><div class=""> the index action in the default controller of the myapp application is called. It returns a string that the browser displays for us. It should look like this:</div><div class=""> </div><div class=""> [[image @///image/en1100.png center 480px]]</div><div class=""> </div><div class=""> Now, edit the &quot;index&quot; function as follows:</div><div class=""> ``</div><div class=""> def index():</div><div class="">     return dict(message=&quot;Hello from MyApp&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Also from the &#x27;&#x27;edit&#x27;&#x27; page, edit the view &quot;default/index.html&quot; (the view file associated with the action) and completely replace the existing contents of that file with the following:</div><div class=""> ``</div><div class=""> &lt;html&gt;</div><div class="">    &lt;head&gt;&lt;/head&gt;</div><div class="">    &lt;body&gt;</div><div class="">       &lt;h1&gt;{{=message}}&lt;/h1&gt;</div><div class="">    &lt;/body&gt;</div><div class=""> &lt;/html&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> Now the action returns a dictionary defining a ``message``. When an action returns a dictionary, web2py looks for a view with the name</div><div class=""> </div><div class="insert">+``</div><div class="insert">+[controller]/[function].[extension]</div><div class="insert">+``:code</div><div class=""> </div><div class="insert"><span class="highlight"></span>and executes it. Here <span class="highlight">``</span>[extension]<span class="highlight">``</span> is the requested extension. If no extension is specified, it defaults to &quot;html&quot;, and that is what we will assume here. Under this assumption, the view is an HTML file that embeds Python code using special {{ }} tags. In particular, in the example, the ``{{=message}}`` instructs web2py to replace the tagged code with the value of the ``message`` returned by the action. Notice that ``message`` here is not a web2py keyword but is defined in the action. So far we have not used any web2py keywords.</div><div class=""> </div><div class=""> If web2py does not find the requested view, it uses the &quot;generic.html&quot; view that comes with every application.</div><div class=""> </div><div class=""> -------</div><div class=""> ``Mac Mail``:inxx ``Google Maps``:inxx ``jsonp``:inxx</div><div class=""> If an extension other than &quot;html&quot; is specified (&quot;json&quot; for example), and the view file &quot;[controller]/[function].json&quot; is not found, web2py looks for the view &quot;generic.json&quot;. web2py comes with generic.html, generic.json, generic.jsonp, generic.xml, generic.rss, generic.ics (for Mac Mail Calendar), generic.map (for embedding Google Maps), and generic.pdf (based on fpdf). These generic views can be modified for each application individually, and additional views can be added easily.</div><div class=""> -------</div><div class=""> </div><div class=""> -------</div><div class=""> Generic views are a development tool. In production every action should have its own view. In fact, by default, generic views are only enabled from localhost.</div><div class=""> -------</div><div class=""> </div><div class=""> -------</div><div class=""> You can also specify a view with ``response.view = &#x27;default/something.html&#x27;``</div><div class=""> -------</div><div class=""> </div><div class=""> Read more on this topic in Chapter 10.</div><div class=""> </div><div class=""> If you go back to &quot;EDIT&quot; and click on index, you will now see the following HTML page:</div><div class=""> </div><div class=""> [[image @///image/en1200.png center 480px]]</div><div class=""> </div><div class="insert">+#### Debugging toolbar</div><div class="insert">+``toolbar``:inxx</div><div class="insert">+</div><div class="insert">+For debugging purposes you can insert</div><div class=""> </div><div class=""> ``</div><div class=""> {{=response.toolbar()}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> to the code in a view and it will show you some useful information, including the request, response and session objects, and list all db queries with their timing.</div><div class=""> </div><div class=""> #### Let&#x27;s count</div><div class=""> ``session``:inxx</div><div class=""> Let&#x27;s now add a counter to this page that will count how many times the same visitor displays the page.</div><div class=""> </div><div class=""> web2py automatically and transparently tracks visitors using sessions and cookies. For each new visitor, it creates a session and assigns a unique &quot;session_id&quot;. The session is a container for variables that are stored server-side. The unique id is sent to the browser via a cookie. When the visitor requests another page from the same application, the browser sends the cookie back, it is retrieved by web2py, and the corresponding session is restored.</div><div class=""> </div><div class=""> To use the session, modify the default controller:</div><div class=""> ``</div><div class=""> def index():</div><div class="">     if not session.counter:</div><div class="">         session.counter = 1</div><div class="">     else:</div><div class="">         session.counter += 1</div><div class="">     return dict(message=&quot;Hello from MyApp&quot;, counter=session.counter)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Notice that ``counter`` is not a web2py keyword but ``session`` is. We are asking web2py to check whether there is a counter variable in the session and, if not, to create one and set it to 1. If the counter is there, we ask web2py to increase the counter by 1. Finally we pass the value of the counter to the view.</div><div class=""> </div><div class=""> A more compact way to code the same function is this:</div><div class=""> ``</div><div class=""> def index():</div><div class="">     session.counter = (session.counter or 0) + 1</div><div class="">     return dict(message=&quot;Hello from MyApp&quot;, counter=session.counter)</div><div class=""> A better pattern for form submission is to submit forms to the same action that</div><div class=""> Modify the default controller to implement self-submission:</div><div class=""> ``</div><div class=""> def first():</div><div class="">     if request.vars.visitor_name:</div><div class="">         session.visitor_name = request.vars.visitor_name</div><div class="">         redirect(URL(&#x27;second&#x27;))</div><div class="">     return dict()</div><div class=""> </div><div class=""> def second():</div><div class="">     return dict()</div><div class=""> ``:code</div><div class=""> </div><div class=""> Then modify the &quot;default/first.html&quot; view:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> What is your name?</div><div class=""> &lt;form&gt;</div><div class="">   &lt;input name=&quot;visitor_name&quot; /&gt;</div><div class="">   &lt;input type=&quot;submit&quot; /&gt;</div><div class=""> &lt;/form&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> and the &quot;default/second.html&quot; view needs to retrieve the data from the ``session`` instead of from the ``request.vars``:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Hello {{=session.visitor_name or &quot;anonymous&quot;}}&lt;/h1&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> From the point of view of the visitor, the self-submission behaves exactly the same as the previous implementation. We have not added validation yet, but it is now clear that validation should be performed by the first action.</div><div class=""> </div><div class="insert">This approach is better also because the name of the visitor stays in the session, and can be accessed by all actions and views in the application<span class="highlight"></span> without having to be passed around explicitly.</div><div class=""> </div><div class=""> Note that if the &quot;second&quot; action is ever called before a visitor name is set, it will display &quot;Hello anonymous&quot; because  ``session.visitor_name`` returns ``None``. Alternatively we could have added the following code in the controller (inside the ``second`` function):</div><div class=""> </div><div class=""> ``</div><div class=""> if not request.function==&#x27;first&#x27; and not session.visitor_name:</div><div class="">     redirect(URL(&#x27;first&#x27;))</div><div class=""> ``:code</div><div class=""> </div><div class="insert">This is a<span class="highlight">n</span> <span class="highlight">&#x27;&#x27;</span>a<span class="highlight">d hoc&#x27;&#x27; </span> mechanism that you can use to enforce authorization on controllers, though see Chapter 9 for a more powerful method.</div><div class=""> </div><div class=""> ``FORM``:inxx ``INPUT``:inxx ``requires``:inxx ``IS_NOT_EMPTY``:inxx ``accepts``:inxx</div><div class=""> </div><div class=""> With web2py we can move one step further and ask web2py to generate the form for us, including validation. web2py provides helpers (FORM, INPUT, TEXTAREA, and SELECT/OPTION) with the same names as the equivalent HTML tags. They can be used to build forms either in the controller or in the view.</div><div class=""> </div><div class=""> For example, here is one possible way to rewrite the first action:</div><div class=""> ``</div><div class=""> def first():</div><div class="">     form = FORM(INPUT(_name=&#x27;visitor_name&#x27;, requires=IS_NOT_EMPTY()),</div><div class="">               INPUT(_type=&#x27;submit&#x27;))</div><div class="">     if form.process().accepted:</div><div class="">         session.visitor_name = form.vars.visitor_name</div><div class="">         redirect(URL(&#x27;second&#x27;))</div><div class="">     return dict(form=form)</div><div class=""> ``:code</div><div class=""> </div><div class=""> where we are saying that the FORM tag contains two INPUT tags. The attributes of the input tags are specified by the named arguments starting with underscore. The ``requires`` argument is not a tag attribute (because it does not start by underscore) but it sets a validator for the value of visitor_name.</div><div class=""> </div><div class=""> Here is yet another better way to create the same form:</div><div class=""> </div><div class=""> ``</div><div class=""> def first():</div><div class="">     form = SQLFORM.factory(Field(&#x27;visitor_name&#x27;,</div><div class="">                                  label=&#x27;what is your name?&#x27;,</div><div class="">                                  requires=IS_NOT_EMPTY()))</div><div class="">     if form.process().accepted:</div><div class="">         session.visitor_name = form.vars.visitor_name</div><div class="">         redirect(URL(&#x27;second&#x27;))</div><div class="">     return dict(form=form)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The ``form`` object can be easily serialized in HTML by embedding it in the &quot;default/first.html&quot; view.</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> {{=form}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> The ``form.process()`` method applies the validators and returns the form itself. The ``form.accepted`` variable is set to True if the form was processed and passed validation. If the self-submitted form passes validation, it stores the variables in the session and redirects as before. If the form does not pass validation, error messages are inserted into the form and shown to the user, as below:</div><div class=""> </div><div class=""> [[image @///image/en1800.png center 480px]]</div><div class=""> </div><div class=""> In the next section we will show how forms can be generated automatically from a model.</div><div class=""> </div><div class=""> In all our examples we have used the session to pass the user name from the first action to the second. We could have used a different mechanism and passed data as part of a redirect URL:</div><div class=""> </div><div class=""> ``</div><div class=""> def first():</div><div class="">     form = SQLFORM.factory(Field(&#x27;visitor_name&#x27;, requires=IS_NOT_EMPTY()))</div><div class="">     if form.process().accepted:</div><div class="">         name = form.vars.visitor_name</div><div class="">         redirect(URL(&#x27;second&#x27;,vars=dict(name=name)))</div><div class="">     return dict(form=form)</div><div class=""> </div><div class=""> def second():</div><div class="">     name = request.vars.visitor_name or redirect(URL(&#x27;first&#x27;))</div><div class="">     return dict(name=name)</div><div class=""> ``:code</div><div class=""> </div><div class="insert">+Mind that in general it is not a good idea to pass data from one action to another using the URL. It makes it harder to secure the application. It is safer to store the data in a session.</div><div class="insert">+</div><div class=""> #### Internationalization</div><div class=""> </div><div class=""> Your code is likely to include hardcoded strings such as &quot;What is your name?&quot;. You should be able to customize strings without editing the code and in particular insert translations for these strings in different languages. In this way if a visitor has the language preference of the browser set to &quot;Italian&quot;, web2py will use the Italian translation for the strings, if available. This feature of web2py is called &quot;internationalization&quot; and it is described in more detail in the next chapter.</div><div class=""> </div><div class=""> Here we just observe that in order to use this feature you should markup strings that needs translation. This is done by wrapping a quoted string in code such as</div><div class=""> </div><div class=""> ``</div><div class=""> &quot;What is your name?&quot;</div><div class=""> ``:code</div><div class=""> </div><div class=""> with the ``T`` operator:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;What is your name?&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> You can also mark for translations strings hardcoded in views. For example</div><div class=""> </div><div class=""> ``</div><div class=""> &lt;h1&gt;What is your name?&lt;/h1&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> becomes</div><div class=""> </div><div class=""> ``</div><div class=""> &lt;h1&gt;{{=T(&quot;What is your name?&quot;)}}&lt;/h1&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> It is good practice to do this for every string in the code (field labels, flash messages, etc.) except for tables and field names.</div><div class=""> </div><div class=""> Once the strings are identified and marked up, web2py takes care of almost everything else. The admin interface also provides a page where you can translate each string in the languages you desire to support.</div><div class=""> </div><div class="insert">+-----------</div><div class="insert">+web2py includes a powerful pluralization engine which is described in the next chapter. It is integrated with both the internationalization engine and the markmin renderer.</div><div class="insert">+-----------</div><div class="insert">+</div><div class=""> ### An image blog</div><div class=""> ``upload``:inxx</div><div class=""> </div><div class=""> Here, as another example, we wish to create a web application that allows the administrator to post images and give them a name, and allows the visitors of the web site to view the named images and submit comments (posts).</div><div class=""> </div><div class=""> As before, from the **site** page in **admin**, create a new application called ``images``, and navigate to the &#x27;&#x27;edit&#x27;&#x27; page:</div><div class=""> </div><div class=""> [[image @///image/en1900.png center 480px]]</div><div class=""> </div><div class=""> We start by creating a model, a representation of the persistent data in the application (the images to upload, their names, and the comments). First, you need to create/edit a model file which, for lack of imagination, we call &quot;db.py&quot;. We assume the code below will replace any existing code in &quot;db.py&quot;. Models and controllers must have a ``.py`` extension since they are Python code. If the extension is not provided, it is appended by web2py. Views instead have a ``.html`` extension since they mainly contain HTML code.</div><div class=""> </div><div class=""> Edit the &quot;db.py&quot; file by clicking the corresponding &quot;edit&quot; button:</div><div class=""> </div><div class=""> [[image @///image/en2000.png center 480px]]</div><div class=""> </div><div class=""> and enter the following:</div><div class=""> </div><div class=""> ``IS_EMAIL``:inxx ``IS_NOT_EMPTY``:inxx ``IS_IN_DB``:inxx</div><div class=""> ``</div><div class=""> db = DAL(&quot;sqlite://storage.sqlite&quot;)</div><div class=""> </div><div class=""> db.define_table(&#x27;image&#x27;,</div><div class="">    Field(&#x27;title&#x27;, unique=True),</div><div class="">    Field(&#x27;file&#x27;, &#x27;upload&#x27;),</div><div class="">    format = &#x27;%(title)s&#x27;)</div><div class=""> </div><div class=""> db.define_table(&#x27;post&#x27;,</div><div class="">    Field(&#x27;image_id&#x27;, &#x27;reference image&#x27;),</div><div class="">    Field(&#x27;author&#x27;),</div><div class="">    Field(&#x27;email&#x27;),</div><div class="">    Field(&#x27;body&#x27;, &#x27;text&#x27;))</div><div class=""> </div><div class=""> db.image.title.requires = IS_NOT_IN_DB(db, db.image.title)</div><div class=""> db.post.image_id.requires = IS_IN_DB(db, db.image.id, &#x27;%(title)s&#x27;)</div><div class=""> db.post.author.requires = IS_NOT_EMPTY()</div><div class=""> db.post.email.requires = IS_EMAIL()</div><div class=""> db.post.body.requires = IS_NOT_EMPTY()</div><div class=""> </div><div class=""> db.post.image_id.writable = db.post.image_id.readable = False</div><div class=""> ``:code</div><div class=""> </div><div class=""> Let&#x27;s analyze this line by line.</div><div class=""> </div><div class=""> Line 1 defines a global variable called ``db`` that represents the database connection. In this case it is a connection to a SQLite database stored in the file  &quot;applications/images/databases/storage.sqlite&quot;. When using SQLite, if the database file does not exist, it is created. You can change the name of the file, as well as the name of the global variable ``db``, but it is convenient to give them the same name, to make it easy to remember.</div><div class=""> </div><div class="insert">Lines 3-<span class="highlight">6</span> define a table &quot;image&quot;. ``define_table`` is a method of the ``db`` object. The first argument, &quot;image&quot;, is the name of the table we are defining. The other arguments are the fields belonging to that table. This table has a field called &quot;title&quot;, a field called &quot;file&quot;, and a field called &quot;id&quot; that serves as the table primary key (&quot;id&quot; is not explicitly declared because all tables have an id field by default). The field &quot;title&quot; is a string, and the field &quot;file&quot; is of type &quot;upload&quot;. &quot;upload&quot; is a special type of field used by the web2py Data Abstraction Layer (DAL) to store the names of uploaded files. web2py knows how to upload files (via streaming if they are large), rename them safely, and store them.</div><div class=""> </div><div class=""> When a table is defined, web2py takes one of several possible actions:</div><div class=""> - if the table does not exist, the table is created;</div><div class=""> - if the table exists and does not correspond to the definition, the table is altered accordingly, and if a field has a different type, web2py tries to convert its contents;</div><div class=""> - if the table exists and corresponds to the definition, web2py does nothing.</div><div class=""> </div><div class=""> This behavior is called &quot;migration&quot;. In web2py migrations are automatic, but can be disabled for each table by passing ``migrate=False`` as the last argument of ``define_table``.</div><div class=""> </div><div class=""> Line 6 defines a format string for the table. It determines how a record should be represented as a string. Notice that the ``format`` argument can also be a function that takes a record and returns a string. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> format=lambda row: row.title</div><div class=""> ``:code</div><div class=""> </div><div class=""> Lines 8-12 define another table called &quot;post&quot;.</div><div class=""> A post has an &quot;author&quot;, an &quot;email&quot; (we intend to store the email address of the author of the post), a &quot;body&quot; of type &quot;text&quot; (we intend to use it to store the actual comment posted by the author), and an &quot;image_id&quot; field of type reference that points to ``db.image`` via the &quot;id&quot; field.</div><div class=""> </div><div class=""> In line 14, ``db.image.title`` represents the field &quot;title&quot; of table &quot;image&quot;. The attribute ``requires`` allows you to set requirements/constraints that will be enforced by web2py forms. Here we require that the &quot;title&quot; is unique:</div><div class=""> </div><div class=""> ``IS_NOT_IN_DB(db, db.image.title)``:code</div><div class=""> </div><div class=""> &#x27;&#x27;Notice this is optional because it is set automatically given that ``Field(&#x27;title&#x27;, unique=True)``&#x27;&#x27;.</div><div class=""> </div><div class=""> The objects representing these constraints are called validators. Multiple validators can be grouped in a list. Validators are executed in the order they appear.</div><div class=""> ``IS_NOT_IN_DB(a, b)`` is a special validator that checks that the value of a field ``b`` for a new record is not already in ``a``.</div><div class=""> </div><div class=""> Line 15 requires that the field &quot;image_id&quot; of table &quot;post&quot; is in ``db.image.id``. As far as the database is concerned, we had already declared this  when we defined the table &quot;post&quot;.</div><div class=""> Now we are explicitly telling the model that this condition should be enforced by web2py, too, at the form processing level when a new comment is posted, so that invalid values do not propagate from input forms to the database. We also require that the &quot;image_id&quot; be represented by the &quot;title&quot;, ``&#x27;%(title)s&#x27;``, of the corresponding record.</div><div class=""> </div><div class=""> Line 20 indicates that the field &quot;image_id&quot; of table &quot;post&quot; should not be shown in forms, ``writable=False`` and not even in read-only forms, ``readable=False``.</div><div class=""> </div><div class="insert">The meaning of the validators in lines 1<span class="highlight">7</span>-1<span class="highlight">8</span> should be obvious.</div><div class=""> </div><div class=""> ``format``:inxx</div><div class=""> Notice that the validator</div><div class=""> ``</div><div class=""> db.post.image_id.requires = IS_IN_DB(db, db.image.id, &#x27;%(title)s&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> can be omitted (and would be automatic) if we specify a format for referenced table:</div><div class=""> ``</div><div class=""> db.define_table(&#x27;image&#x27;, ..., format=&#x27;%(title)s&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> where the format can be a string or a function that takes a record and returns a string.</div><div class=""> </div><div class=""> ``appadmin``:inxx</div><div class=""> Once a model is defined, if there are no errors, web2py creates an application administration interface to manage the database. You access it via the &quot;database administration&quot; link in the &#x27;&#x27;edit&#x27;&#x27; page or directly:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/appadmin</div><div class=""> ``:code</div><div class=""> </div><div class=""> Here is a screenshot of the **appadmin** interface:</div><div class=""> </div><div class=""> [[image @///image/en2100.png center 480px]]</div><div class=""> </div><div class=""> This interface is coded in the controller called &quot;appadmin.py&quot; and the corresponding view &quot;appadmin.html&quot;. From now on, we will refer to this interface simply as **appadmin**. It allows the administrator to insert new database records, edit and delete existing records, browse tables, and perform database joins.</div><div class=""> </div><div class=""> The first time **appadmin** is accessed, the model is executed and the tables are created. The web2py DAL translates Python code into SQL statements that are specific to the selected database back-end (SQLite in this example). You can see the generated SQL from the &#x27;&#x27;edit&#x27;&#x27; page by clicking on the &quot;sql.log&quot; link under &quot;models&quot;. Notice that the link is not present until the tables have been created.</div><div class=""> </div><div class=""> [[image @///image/en2200.png center 480px]]</div><div class=""> </div><div class=""> def edit():</div><div class=""> def documents():</div><div class="">      &quot;&quot;&quot;browser, edit all documents attached to a certain page&quot;&quot;&quot;</div><div class="">      page = db.page(request.args(0,cast=int)) or redirect(URL(&#x27;index&#x27;))</div><div class="">      db.document.page_id.default = page.id</div><div class="">      db.document.page_id.writable = False</div><div class="">      grid = SQLFORM.grid(db.document.page_id==page.id,args=[page.id])</div><div class="">      return dict(page=page, grid=grid)</div><div class=""> </div><div class=""> def user():</div><div class="">      return dict(form=auth())</div><div class=""> </div><div class=""> def download():</div><div class="">      &quot;&quot;&quot;allows downloading of documents&quot;&quot;&quot;</div><div class="">      return response.download(request, db)</div><div class=""> </div><div class=""> def search():</div><div class="">      &quot;&quot;&quot;an ajax wiki search page&quot;&quot;&quot;</div><div class="">      return dict(form=FORM(INPUT(_id=&#x27;keyword&#x27;,_name=&#x27;keyword&#x27;,</div><div class="">               _onkeyup=&quot;ajax(&#x27;callback&#x27;, [&#x27;keyword&#x27;], &#x27;target&#x27;);&quot;)),</div><div class="">               target_div=DIV(_id=&#x27;target&#x27;))</div><div class=""> </div><div class=""> def callback():</div><div class="">      &quot;&quot;&quot;an ajax callback that returns a &lt;ul&gt; of links to wiki pages&quot;&quot;&quot;</div><div class="">      query = db.page.title.contains(request.vars.keyword)</div><div class="">      pages = db(query).select(orderby=db.page.title)</div><div class="">      links = [A(p.title, _href=URL(&#x27;show&#x27;,args=p.id)) for p in pages]</div><div class="">      return UL(*links)</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class="insert">Lines 2-6 <span class="highlight">constitut</span>e a comment for the index action. Lines 4-5 inside the comment are interpreted by python as test code (doctest). Tests can be run via the admin interface. In this case the tests verify that the index action runs without errors.</div><div class=""> </div><div class=""> Lines 18, 27, and 35 try to fetch a ``page`` record with the id in</div><div class=""> ``request.args(0)``.</div><div class=""> </div><div class=""> Lines 13, 20 define and process create forms for a new page and a new comment and</div><div class=""> </div><div class=""> Line 28 defines and processes an update form for a wiki page.</div><div class=""> </div><div class=""> Line 38 creates a ``grid`` object that allows to view, add and update the comments linked to a page.</div><div class=""> </div><div class=""> Some magic happens in line 51. The ``onkeyup`` attribute of the INPUT tag &quot;keyword&quot; is set. Every time the visitor releases a key, the JavaScript code inside the ``onkeyup`` attribute is executed, client-side. Here is the JavaScript code:</div><div class=""> ``</div><div class=""> ajax(&#x27;callback&#x27;, [&#x27;keyword&#x27;], &#x27;target&#x27;);</div><div class=""> ``:code</div><div class=""> ``ajax`` is a JavaScript function defined in the file &quot;web2py.js&quot; which is included by the default &quot;layout.html&quot;. It takes three parameters: the URL of the action that performs the synchronous callback, a list of the IDs of variables to be sent to the callback ([&quot;keyword&quot;]), and the ID where the response has to be inserted (&quot;target&quot;).</div><div class=""> </div><div class=""> As soon as you type something in the search box and release a key, the client calls the server and sends the content of the &#x27;keyword&#x27; field, and, when the sever responds, the response is embedded in the page itself as the innerHTML of the &#x27;target&#x27; tag.</div><div class=""> </div><div class=""> The &#x27;target&#x27; tag is a DIV defined in line 52. It could have been defined in the view as well.</div><div class=""> </div><div class=""> Here is the code for the view &quot;default/create.html&quot;:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Create new wiki page&lt;/h1&gt;</div><div class=""> {{=form}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> Assuming you are registered and logged in, if you visit the **create** page, you see the following:</div><div class=""> </div><div class=""> [[image @///image/en3500.png center 480px]]</div><div class=""> Here is the code for the view &quot;default/index.html&quot;:</div><div class="">      {{=LI(A(page.title, _href=URL(&#x27;show&#x27;, args=page.id)))}}</div><div class=""> {{pass}}&lt;/ul&gt;</div><div class=""> [ {{=A(&#x27;create page&#x27;, _href=URL(&#x27;create&#x27;))}} ]</div><div class=""> ``:code</div><div class=""> </div><div class=""> It generates the following page:</div><div class=""> </div><div class=""> [[image @///image/en3600.png center 480px]]</div><div class=""> </div><div class=""> Here is the code for the view &quot;default/show.html&quot;:</div><div class=""> </div><div class=""> ``markdown``:inxx ``MARKMIN``:inxx</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;{{=page.title}}&lt;/h1&gt;</div><div class=""> [ {{=A(&#x27;edit&#x27;, _href=URL(&#x27;edit&#x27;, args=request.args))}}</div><div class=""> | {{=A(&#x27;documents&#x27;, _href=URL(&#x27;documents&#x27;, args=request.args))}} ]&lt;br /&gt;</div><div class=""> {{=MARKMIN(page.body)}}</div><div class=""> &lt;h2&gt;Comments&lt;/h2&gt;</div><div class=""> {{for post in comments:}}</div><div class="">   &lt;p&gt;{{=db.auth_user[post.created_by].first_name}} on {{=post.created_on}}</div><div class="">      says &lt;i&gt;{{=post.body}}&lt;/i&gt;&lt;/p&gt;</div><div class=""> {{pass}}</div><div class=""> &lt;h2&gt;Post a comment&lt;/h2&gt;</div><div class=""> {{=form}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> If you wish to use markdown syntax instead of markmin syntax:</div><div class=""> </div><div class=""> ``</div><div class="insert">from gluon.contrib.markdown import WIKI<span class="highlight"> as MARKDOWN</span></div><div class=""> ``:code</div><div class=""> </div><div class="insert">and use ``<span class="highlight">MARKDO</span>W<span class="highlight">N</span>`` instead of the ``MARKMIN`` helper.</div><div class=""> Alternatively, you can choose to accept raw HTML instead of markmin syntax. In this case you would replace:</div><div class=""> ``</div><div class=""> {{=MARKMIN(page.body)}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> with:</div><div class=""> ``</div><div class=""> {{=XML(page.body)}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> ``sanitize``:inxx</div><div class=""> (so that the XML does not get escaped, which web2py normally does by default for security reasons).</div><div class=""> </div><div class=""> This can be done better with:</div><div class=""> ``</div><div class=""> {{=XML(page.body, sanitize=True)}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> By setting ``sanitize=True``, you tell web2py to escape unsafe XML tags such as &quot;&lt;script&gt;&quot;, and thus prevent XSS vulnerabilities.</div><div class=""> </div><div class=""> Now if, from the index page, you click on a page title, you can see the page that you have created:</div><div class=""> </div><div class=""> [[image @///image/en3700.png center 480px]]</div><div class=""> </div><div class=""> Here is the code for the view &quot;default/edit.html&quot;:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Edit wiki page&lt;/h1&gt;</div><div class=""> [ {{=A(&#x27;show&#x27;, _href=URL(&#x27;show&#x27;, args=request.args))}} ]&lt;br /&gt;</div><div class=""> {{=form}}</div><div class=""> If you look at the page source you see the HTML returned by the callback:</div><div class=""> Generating an RSS feed of your wiki pages using web2py is easy because web2py includes ``gluon.contrib.rss2``. Just append the following action to the default controller:</div><div class=""> ``</div><div class=""> def news():</div><div class="">     &quot;&quot;&quot;generates rss feed form the wiki pages&quot;&quot;&quot;</div><div class="">     response.generic_patterns = [&#x27;.rss&#x27;]</div><div class="">     pages = db().select(db.page.ALL, orderby=db.page.title)</div><div class="">     return dict(</div><div class="">        title = &#x27;mywiki rss feed&#x27;,</div><div class="">        link = &#x27;http://127.0.0.1:8000/mywiki/default/index&#x27;,</div><div class="">        description = &#x27;mywiki news&#x27;,</div><div class="">        created_on = request.now,</div><div class="">        items = [</div><div class="">           dict(title = row.title,</div><div class="">                link = URL(&#x27;show&#x27;, args=row.id),</div><div class="">                description = MARKMIN(row.body).xml(),</div><div class="">                created_on = row.created_on</div><div class="">                ) for row in pages])</div><div class=""> ``:code</div><div class=""> </div><div class=""> and when you visit the page</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/mywiki/default/news.rss</div><div class=""> ``:code</div><div class=""> </div><div class=""> you see the feed (the exact output depends on the feed reader). Notice that the dict is automatically converted to RSS, thanks to the .rss extension in the URL.</div><div class=""> </div><div class=""> [[image @///image/en4000.png center 480px]]</div><div class=""> </div><div class=""> web2py also includes feedparser to read third-party feeds.</div><div class=""> </div><div class="insert">+Notice that the line:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+response.generic_patterns = [&#x27;.rss&#x27;]</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+instructs web2py to use generic views (in our case &quot;views/generic.rss&quot;) when the URL ends in the glob pattern &quot;.rss&quot;. By default generic views are only allowed from localhost for development purposes.</div><div class="insert">+</div><div class=""> ``XMLRPC``:inxx</div><div class=""> Finally, let&#x27;s add an XML-RPC handler that allows searching the wiki programmatically:</div><div class=""> ``</div><div class=""> service = Service()</div><div class=""> </div><div class=""> @service.xmlrpc</div><div class=""> def find_by(keyword):</div><div class="">      &quot;&quot;&quot;finds pages that contain keyword for XML-RPC&quot;&quot;&quot;</div><div class="">      return db(db.page.title.contains(keyword)).select().as_list()</div><div class=""> </div><div class=""> def call():</div><div class="">     &quot;&quot;&quot;exposes all registered services, including XML-RPC&quot;&quot;&quot;</div><div class="">     return service()</div><div class=""> ``:code</div><div class=""> </div><div class=""> Here, the handler action simply publishes (via XML-RPC), the functions specified in the list. In this case, ``find_by``. ``find_by`` is not an action (because it takes an argument). It queries the database with ``.select()`` and then extracts the records as a list with ``.response`` and returns the list.</div><div class=""> </div><div class=""> Here is an example of how to access the XML-RPC handler from an external</div><div class=""> Python program.</div><div class=""> ``</div><div class=""> &gt;&gt;&gt; import xmlrpclib</div><div class=""> &gt;&gt;&gt; server = xmlrpclib.ServerProxy(</div><div class="">     &#x27;http://127.0.0.1:8000/mywiki/default/call/xmlrpc&#x27;)</div><div class=""> &gt;&gt;&gt; for item in server.find_by(&#x27;wiki&#x27;):</div><div class="">         print item[&#x27;created_on&#x27;], item[&#x27;title&#x27;]</div><div class=""> ``:code</div><div class=""> </div><div class=""> The handler can be accessed from many other programming languages that understand XML-RPC, including C, C++, C# and Java.</div><div class=""> </div><div class=""> #### On ``date``, ``datetime`` and ``time`` format</div><div class=""> yet this representation is internationalized and you can use the admin translati</div><div class=""> Mind that by default English is not translated because web2py assumes the applications are written in English. If you want internationalization to work for English you need to create the translation file (using admin) and you need to declare that the application&#x27;s current language is something other than english, for example:</div><div class=""> ``</div><div class=""> T.current_languages = [&#x27;null&#x27;]</div><div class=""> ``</div><div class=""> </div><div class=""> ### The built-in web2py wiki</div><div class=""> </div><div class=""> Now you can forget the code we have built-in the previous section (not what you have learned about web2py APIs, just the code of the specific example) as we are going to provide an example of the built-in web2py wiki.</div><div class=""> </div><div class=""> In fact, web2py comes with wiki capabilities including media attachments, tags, tag cloud, page permissions, and support for oembed ``oembed``:cite and components (chapter 14). This wiki can be used with any web2py application.</div><div class=""> </div><div class=""> ------</div><div class=""> Notice the API of the built-in wiki is still considered experimental and small changes are still possible.</div><div class=""> ------</div><div class=""> </div><div class=""> Here we assume we are starting from scratch from a simple clone of the &quot;welcome&quot; application called &quot;wikidemo&quot;. Edit the controller and replace the &quot;index&quot; action with</div><div class=""> </div><div class=""> ``</div><div class=""> def index(): return auth.wiki()</div><div class=""> ``:code</div><div class=""> </div><div class=""> Done! You have a fully working wiki. At this point no page has been created and in order to create pages you must be logged-in and you must be member of a group called &quot;wiki-editor&quot; or &quot;wiki-author&quot;. If you are logged-in as administrator the &quot;wiki-editor&quot; group is created automatically and you are made a member. The difference between editors and authors is that the editors can create pages, edit and delete any page, while the authors can create pages (with some optional restrictions) and can only edit/delete the pages they have created.</div><div class=""> </div><div class=""> The ``auth.wiki()`` function returns in a dictionary with a key ``content`` which is understood by the scaffolding &quot;views/default/index.html&quot;. You can make your own view for this action:</div><div class=""> </div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> {{=content}}</div><div class=""> ``:code</div><div class=""> </div><div class="insert">and add extra HTML or code as needed. <span class="highlight">You</span> <span class="highlight">do</span> no<span class="highlight">t</span> <span class="highlight">hav</span>e<span class="highlight"></span> to <span class="highlight">use</span> the<span class="highlight"> &quot;index&quot;</span> action <span class="highlight">to </span>ex<span class="highlight">pose the wiki</span>.<span class="highlight"> You can use an action with a different name.</span></div><div class=""> </div><div class=""> To try the wiki, simply login into admin, visit the page</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index</div><div class=""> ``</div><div class=""> </div><div class=""> Then choose a slug (in the publishing business, a slug is a short name given to an article that is in production) and you will be redirected to an empty page where you can edit the content using MARKMIN wiki syntax. A new menu item called &quot;[wiki]&quot; will allow you to create, search, and edit pages. Wiki pages have URLs like:</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/[slug]</div><div class=""> ``</div><div class=""> </div><div class=""> Service pages have names which start by underscore:</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_create</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_search</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_could</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_recent</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_edit/...</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_editmedia/...</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_preview/...</div><div class=""> ``</div><div class=""> </div><div class=""> Try to create more pages such as &quot;index&quot;, &quot;aboutus&quot;, and &quot;contactus&quot;.</div><div class=""> Try to edit them.</div><div class=""> </div><div class=""> </div><div class=""> The ``wiki`` method has the following signature:</div><div class=""> </div><div class=""> ``</div><div class=""> def wiki(self, slug=None, env=None, render=&#x27;markmin&#x27;,</div><div class="">          manage_permissions=False, force_prefix=&#x27;&#x27;,</div><div class="">          restrict_search=False, resolve=True,</div><div class="">          extra=None, menugroups=None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> It takes the following arguments:</div><div class=""> </div><div class="insert">+- ``render`` which defaults to ``&#x27;markmin&#x27;`` but can be set equal to ``&#x27;html&#x27;``. It determines the syntax of the wiki. We will discuss the markmin wiki markup later. If you change it to HTML you can use a wysiwyg javascript editor such as TinyMCE or NicEdit.</div><div class="insert">+- ``manage_permissions``. This is set to ``False`` by default and only recognizes permissions for &quot;wiki-editor&quot; and &quot;wiki-author&quot;. If you change it to ``True`` the create/edit page will give the option to specify by name the group(s) whose members have permission to read and edit the page. There is a group &quot;everybody&quot; which includes all users.</div><div class=""> </div><div class="insert">- ``force_prefix``. If set to something like ``&#x27;%(id)s-&#x27;`` it will restrict authors (not editors) to creating pages with a prefix like &quot;[user id]-[page name]&quot;. The prefix can contain the id (&quot;%(id)s&quot;) or the username (&quot;%(username)s&quot;) or any other field from the auth_user table, as long as the corresponding column contains <span class="highlight">a </span>valid string that would pass URL validation.</div><div class=""> - ``restrict_search``. This defaults to ``False`` and any logged-in user can search all wiki pages (but not necessary read or edit them). If set to ``True``, authors can search only their own pages, editors can search everything, other users cannot search anything.</div><div class="insert">- ``menu<span class="highlight">_</span>groups``. This defaults to ``None`` and it indicates that wiki management menu (search, create, edit, etc.) is always displayed. You can set it to a list of group names whose members only can see this menu, for example ``[&#x27;wiki-editor&#x27;,&#x27;wiki-author&#x27;]``. Notice that even if the menu is exposed to everybody that does not mean everybody is allowed to perform actions listed in the menu since they are regulated by the access control system.</div><div class=""> </div><div class=""> The ``wiki`` method has some additional parameters which will be explained later: ``slug``, ``env``, and ``extra``.</div><div class=""> </div><div class=""> </div><div class=""> </div><div class=""> #### MARKMIN basics</div><div class=""> </div><div class="insert">The MARKMIN syntax allows you to markup **bold** text using ``**bold**``, &#x27;&#x27;italic&#x27;&#x27; text with ``&#x27;&#x27;italic&#x27;&#x27;``, <span class="highlight">and ``code`` text s</span>h<span class="highlight">ould be delimited by double inverted quotes</span>. Titles must be prefixed by a #, sections by ##, and sub-sections by ###. Use a minus(-) to prefix an un-ordered item and plus(+) to prefix an ordered item. URLs are automatically converted into links. <span class="highlight">Here is an example of markmin text</span>:</div><div class=""> </div><div class=""> ``</div><div class=""> # This is a title</div><div class=""> ## this is a section title</div><div class=""> ### this is a subsection title</div><div class=""> </div><div class=""> Text can be **bold**, &#x27;&#x27;italic&#x27;&#x27;, !`!!`!code!`!!`! etc.</div><div class=""> Learn more at:</div><div class=""> </div><div class=""> http://web2py.com</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> You can use the ``extra`` parameter of ``auth.wiki`` to pass extra rendering rules to the MARKMIN helper.</div><div class=""> </div><div class=""> You can find more information about the MARKMIN syntax in chapter 5.</div><div class=""> </div><div class=""> ``auth.wiki`` is more powerful than the barebones MARKMIN helpers, supporting oembed and components.</div><div class=""> </div><div class=""> You can use the ``env`` parameter of ``auth.wiki`` to expose functions to your wiki.</div><div class=""> For example:</div><div class=""> </div><div class=""> ``</div><div class=""> auth.wiki(env=dict(join=lambda a,b,c:&quot;%s-%s-%s&quot; % (a,b,c)))</div><div class=""> ``</div><div class=""> </div><div class=""> allows you to use the markup syntax:</div><div class=""> </div><div class=""> ``</div><div class=""> @(join:1,2,3)</div><div class=""> Supported by oembed:</div><div class=""> </div><div class=""> ``</div><div class=""> flickr.com</div><div class=""> youtube.com</div><div class=""> hulu.com</div><div class=""> vimeo.com</div><div class=""> slideshare.net</div><div class=""> qik.com</div><div class=""> polleverywhere.com</div><div class=""> wordpress.com</div><div class=""> revision3.com</div><div class=""> viddler.com</div><div class=""> ``:code</div><div class=""> </div><div class=""> This is implemented in the web2py file ``gluon.contrib.autolinks`` and specifically in the function ``expand_one``. You can extend oembed support by registering more services. This is done by appending an entry to the ``EMBED_MAPS`` list:</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.contrib.autolinks import EMBED_MAPS</div><div class=""> EMBED_MAPS.append((re.compile(&#x27;http://vimeo.com/\S*&#x27;),</div><div class="">                    &#x27;http://vimeo.com/api/oembed.json&#x27;))</div><div class=""> ``:code</div><div class=""> </div><div class=""> #### Referencing wiki content</div><div class=""> </div><div class=""> If you create a wiki page with slug &quot;contactus&quot; you can refer to this page as</div><div class=""> </div><div class=""> ``</div><div class=""> \@////contactus</div><div class=""> ``:code</div><div class=""> </div><div class="insert">Here <span class="highlight">@</span>``<span class="highlight">``</span>////<span class="highlight"></span> stands for</div><div class=""> </div><div class=""> ``</div><div class=""> \@/app/controller/function/</div><div class=""> ``:code</div><div class=""> </div><div class=""> but &quot;app&quot;, &quot;controller&quot;, and &quot;function&quot; are omitted thus assuming default.</div><div class=""> </div><div class=""> Similarly you can use the wiki menu to upload a media file (for example an image) linked to the page. The &quot;manage media&quot; page will show all files you have uploaded and will show the proper expression to link the media file. If, for example you upload a file &quot;test.jpg&quot; with title &quot;beach&quot;, the link expression will something like:</div><div class=""> </div><div class=""> ``</div><div class=""> \@////15/beach.jpg</div><div class=""> ``:code</div><div class=""> </div><div class=""> ``\@////`` is the same prefix described before. ``15`` is the id of the record storing the media file. ``beach`` is the title. ``.jpg`` is the extension of the original file.</div><div class=""> </div><div class=""> If you cut and paste ``\@////15/beach.jpg`` into wiki pages you embed the image.</div><div class=""> </div><div class=""> Mind that media files are linked to pages and inherit access permission from the pages.</div><div class=""> </div><div class=""> #### Wiki menus</div><div class=""> </div><div class=""> If you create a page with slug &quot;wiki-menu&quot; page it will be interpreted as a description of the menu. Here is an example:</div><div class=""> </div><div class=""> ``</div><div class=""> - Home &gt; \@////index</div><div class=""> - Info &gt; \@////info</div><div class=""> - web2py &gt; http://google.com</div><div class=""> - - About us &gt; \@////aboutus</div><div class=""> - - Contact us &gt; \@////contactus</div><div class=""> ``</div><div class=""> Another customization possible is adding extra fields to the standard wiki table</div><div class=""> auth.settings.extra_fields[&quot;wiki_page&quot;] = [Field(&quot;ablob&quot;, &quot;blob&quot;),]</div><div class=""> ``:code</div><div class=""> </div><div class=""> The line above adds a ``blob`` field to the ``wiki_page`` table. There is no need to call ``auth.wiki(resolve=False)``:code for this option, unless you need access to the wiki model for other customizations.</div><div class=""> </div><div class=""> </div><div class=""> #### Components</div><div class=""> </div><div class=""> One of the most powerful functions of the new web2py consists in the ability of embedding an action inside another action. We call this a component.</div><div class=""> </div><div class=""> Consider the following model:</div><div class=""> </div><div class=""> ``</div><div class=""> db.define_table(&#x27;thing&#x27;,Field(&#x27;name&#x27;,requires=IS_NOT_EMPTY()))</div><div class=""> ``:code</div><div class=""> </div><div class=""> and the following action:</div><div class=""> </div><div class=""> ``</div><div class=""> @auth.requires_login()</div><div class=""> def manage_things():</div><div class="">     return SQLFORM.grid(db.thing)</div><div class=""> ``:code</div><div class=""> </div><div class=""> This action is special because it returns a widget/helper not a dict of objects. Now we can embed this ``manage_things`` action into any view, with</div><div class=""> </div><div class=""> ``</div><div class=""> {{=LOAD(&#x27;default&#x27;,&#x27;manage_things&#x27;,ajax=True)}}</div><div class=""> ``:code</div><div class=""> </div><div class="insert">This allows the visitor interact with the component via Ajax without reloading the host page that embeds the widget. <span class="highlight">T</span>he action is called via Ajax, inherits the style of the host page, and captures all form submissions and flash messages so that they are handled within the current page. On top of this the ``SQLFORM.grid`` widget uses digitally signed URLs to restrict access. More information about components can be found in chapter 13.</div><div class=""> </div><div class=""> Components like the one above can be embedded into wiki pages using the MARKMIN syntax:</div><div class=""> </div><div class=""> ``</div><div class=""> @{component:default/manage_things}</div><div class=""> ``</div><div class=""> </div><div class=""> This simply tells web2py that we want to include the &quot;manage_things&quot; action defined in the &quot;default&quot; controller as an Ajax &quot;component&quot;.</div><div class=""> </div><div class=""> ---------</div><div class=""> Most users will be able to build relatively complex applications simply by using ``auth.wiki`` to create pages and menus and embedded custom components into wiki pages. Wikis can be thought of as a mechanism to allow members of the group to create pages, but they can also be thought of as a way to develop applications in a modular way.</div><div class=""> ---------</div><div class=""> </div><div class=""> ### More on **admin**</div><div class=""> ``admin``:inxx</div><div class=""> </div><div class=""> The administrative interface provides additional functionality that we briefly review here.</div><div class=""> </div><div class=""> #### Site</div><div class=""> ``site``:inxx</div><div class=""> </div><div class=""> This page is the main administrative interface of web2py. It lists all installed applications on the left, while on the right side there are some special action forms.</div><div class=""> </div><div class=""> The first of them shows the web2py version and proposes to upgrade it if new versions are available. Of course, before upgrading be sure to have a full working backup!</div><div class=""> Then there are two other forms that allow the creation of a new application (simple or by using an online wizard) by specifying its name.</div><div class=""> </div><div class=""> ``Instant Press``:inxx ``Movuca``:inxx</div><div class=""> The following form allows uploading an existing application from either a local file or a remote URL. When you upload an application, you need to specify a name for it (using different names</div><div class=""> allows you to install multiple copies of the same application). You can try, for example, to upload the Movuca Social Networking application app created by Bruno Rocha:</div><div class=""> </div><div class=""> http://mercurial.selenic.com/</div><div class=""> </div><div class=""> The **admin** interface includes a Wizard that can help you create a new applications.</div><div class=""> You can access the wizard from the &quot;sites&quot; page as shown in the image below.</div><div class=""> </div><div class=""> [[image @///image/en5400.png center 480px]]</div><div class=""> </div><div class=""> The wizard will guide you through a series of steps involved in creating a new application:</div><div class=""> </div><div class=""> - Chose a name for the application</div><div class=""> - Configure the application and choose required plugins</div><div class=""> - Build required models (it will create CRUD pages for each model)</div><div class=""> - Allow you to edit the views of those pages using MARKMIN syntax</div><div class=""> </div><div class=""> The image below shows the second step of the process.</div><div class=""> </div><div class=""> [[image @///image/en5500.png center 480px]]</div><div class=""> </div><div class=""> You can see a dropdown to select a layout plugin (from ``web2py.com/layouts``), a multiple choice dropdown to check other plugins (from ``web2py.com/plugins``) and a &quot;login config&quot; field where to put the Janrain &quot;domain:key&quot;.</div><div class=""> </div><div class=""> The other steps are pretty much self-explanatory.</div><div class=""> </div><div class=""> The Wizard works well for what it does but it is considered an &#x27;&#x27;experimental feature&#x27;&#x27; for two reasons:</div><div class=""> </div><div class=""> - Applications created with the wizard and edited manually, cannot later be modified by the wizard.</div><div class=""> - The interface of the wizard will change over time to include support for more features and easier visual development.</div><div class=""> </div><div class=""> In any case the wizard is a handy tool for fast prototyping and it can be used to bootstrap a new application with an alternate layout and optional plugins.</div><div class=""> </div><div class=""> #### Configuring **admin**</div><div class=""> </div><div class="insert">Normally there is no need to perform any configuration of <span class="highlight">**</span>admin<span class="highlight">**</span> but a few customizations are possible. After you login into admin you can edit the admin configuration file via the URL:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/admin/default/edit/admin/models/0.py</div><div class=""> ``</div><div class=""> Notice that **admin** can be used to edit itself. In fact **admin** is an app as any other one.</div><div class=""> </div><div class="insert">The file &quot;0.py&quot; is <span class="highlight">mor</span>e<span class="highlight"> o</span>r<span class="highlight"></span> <span class="highlight">less</span> self documented<span class="highlight">,</span> an<span class="highlight">yway,</span> <span class="highlight">here</span> are <span class="highlight">s</span>o<span class="highlight">me of the most im</span>p<span class="highlight">orta</span>n<span class="highlight">t</span> p<span class="highlight"></span>o<span class="highlight">ssi</span>bl<span class="highlight"></span>e<span class="highlight"></span> customizations<span class="highlight"></span>:</div><div class=""> </div><div class=""> ``</div><div class=""> GAE_APPCFG = os.path.abspath(os.path.join(&#x27;/usr/local/bin/appcfg.py&#x27;))</div><div class=""> ``</div><div class=""> This should point to the location of the &quot;appcfg.py&quot; file that comes with the Google App Engine SDK. If you have the SDK you may want to change these config parameters to the correct value. It will allow you to deploy to GAE from the admin interface.</div><div class=""> </div><div class=""> ``DEMO_MODE``:inxx</div><div class=""> </div><div class=""> You can also set web2py admin in demo mode:</div><div class=""> ``</div><div class=""> DEMO_MODE = True</div><div class=""> FILTER_APPS = [&#x27;welcome&#x27;]</div><div class=""> ``</div><div class="insert">And only the apps listed in <span class="highlight">FILTER_APPS</span> will be accessible and they will be only accessible in read-only mode.</div><div class=""> </div><div class=""> ``MULTI_USER_MODE``:inxx</div><div class=""> ``virtual laboratory``:inxx</div><div class=""> </div><div class=""> If you are a teacher and want to expose the administrative interface to students so that students can share one administrative interface for their projects (think of a virtual lab), can do it by setting:</div><div class=""> ``</div><div class=""> MULTI_USER_MODE = True</div><div class=""> ``</div><div class=""> In this way students will be required to login and will only be able to access their own apps via admin. You, as first user/teacher, will be able to access them all.</div><div class=""> </div><div class=""> In multi user mode, you can register students using the &quot;bulk register&quot; link in admin and manage them using the &quot;manage students&quot; link. The system also keeps track of when students login and how many lines of code they add/remove to/from their code. This data is presented to the administrator as charts under the application &quot;about&quot; page.</div><div class=""> </div><div class=""> Mind that this mechanism still assumes all users are trusted. All the apps created under admin run under the same credentials on the same filesystem. It is possible for an app created by a student to access the data and the source of an app created by another student. It is also possible for a student to create an app that locks the server.</div><div class=""> </div><div class=""> #### Mobile **admin**</div><div class=""> </div><div class="insert">+Notice that the admin application includes &quot;plugin_jqmobile&quot; which packages jQuery Mobile. When admin is accessed from a mobile device; this is detected by web2py and the interface is displayed using a mobile-friendly layout:</div><div class="insert">+</div><div class="insert">+[[image @///image/mobile.png center 306px]]</div></div></div>
    <div class="span6"><div class="diff"><div class=""> ------</div><div class="delete">Attention, to run web2py on Windows from source you must install first Mark Hammond&#x27;s <span class="highlight">[[Python for W</span>in<span class="highlight">dows</span> extensions <span class="highlight"></span>http://sourceforge.net/projects/pywin32/<span class="highlight">]]</span></div><div class=""> ------</div><div class=""> </div><div class=""> The web2py program accepts various command line options which are discussed later.</div><div class=""> </div><div class=""> By default, at startup, web2py displays a startup window and then displays a GUI widget that asks you to choose a one-time administrator password, the IP address of the network interface to be used for the web server, and a port number from which to serve requests. By default, web2py runs its web server on 127.0.0.1:8000 (port 8000 on localhost), but you can run it on any available IP address and port. You can query the IP address of your network interface by opening a command line and typing ``ipconfig`` on Windows or ``ifconfig`` on OS X and Linux. From now on we assume web2py is running on localhost (127.0.0.1:8000). Use 0.0.0.0:80 to run web2py publicly on any of your network interfaces.</div><div class=""> </div><div class=""> [[image @///image/en400.png center 306px]]</div><div class=""> </div><div class=""> If you do not provide an administrator password, the administration interface is disabled. This is a security measure to prevent publicly exposing the admin interface.</div><div class=""> </div><div class=""> The administrative interface, **admin**, is only accessible from localhost unless you run web2py behind Apache with mod_proxy. If **admin** detects a proxy, the session cookie is set to secure and **admin** login does not work unless the communication between the client and the proxy goes over HTTPS; this is a security measure. All communications between the client and **admin** must always be local or encrypted; otherwise an attacker would be able to perform a man-in-the middle attack or a replay attack and execute arbitrary code on the server.</div><div class=""> </div><div class=""> After the administration password has been set, web2py starts up the web browser at the page:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/</div><div class=""> ``:code</div><div class=""> </div><div class=""> If the computer does not have a default browser, open a web browser and enter the URL.</div><div class=""> </div><div class=""> [[image @///image/en500.png center 480px]]</div><div class=""> </div><div class=""> Clicking on &quot;administrative interface&quot; takes you to the login page for the administration interface.</div><div class=""> </div><div class=""> [[image @///image/en600.png center 480px]]</div><div class=""> </div><div class=""> The administrator password is the password you chose at startup.</div><div class=""> Notice that there is only one administrator, and therefore only one administrator password. For security reasons, the developer is asked to choose a new password every time web2py starts unless the &lt;recycle&gt; option is specified. This is distinct from the authentication mechanism in web2py applications.</div><div class=""> </div><div class=""> After the administrator logs into web2py, the browser is redirected to the &quot;site&quot; page.</div><div class=""> </div><div class=""> [[image @///image/en700.png center 480px]]</div><div class=""> </div><div class=""> This page lists all installed web2py applications and allows the administrator to manage them.</div><div class=""> web2py comes with three applications:</div><div class=""> ``admin``:inxx ``examples``:inxx ``welcome``:inxx ``scaffolding``:inxx</div><div class=""> - An **admin** application, the one you are using right now.</div><div class=""> - An **examples** application, with the online interactive documentation and a replica of the web2py official website.</div><div class="delete">- A **welcome** application. This is the basic template for any other web2py application. It is referred to as the <span class="highlight"></span>scaffolding application<span class="highlight"></span>. This is also the application that welcomes a user at startup.</div><div class=""> </div><div class=""> ``appliances``:inxx</div><div class=""> Ready-to-use web2py applications are referred to as web2py &#x27;&#x27;appliances&#x27;&#x27;.  You can download many freely available appliances from ``appliances``:cite . web2py users are encouraged to submit new appliances, either in open-source or closed-source (compiled and packed) form.</div><div class=""> </div><div class=""> From the **admin** application&#x27;s &#x27;&#x27;site&#x27;&#x27; page, you can perform the following operations:</div><div class=""> - **install** an application by completing the form on the bottom right of the page. Give a name to the application, select the file containing a packaged application or the URL where the application is located, and click &quot;submit&quot;.</div><div class=""> - **uninstall** an application by clicking the corresponding button. There is a confirmation page.</div><div class=""> - **create** a new application by choosing a name and clicking &quot;create&quot;.</div><div class=""> - **package** an application for distribution by clicking on the corresponding button. A downloaded application is a tar file containing everything, including the database. You should not untar this file; it is automatically unpackaged by web2py when installed with **admin**.</div><div class=""> - **clean up** an application&#x27;s temporary files, such as sessions, errors and cache files.</div><div class=""> - **EDIT** an application.</div><div class=""> </div><div class=""> -----</div><div class=""> When you create a new application using **admin**, it starts as a clone of the &quot;welcome&quot; scaffolding app with a &quot;models/db.py&quot; that creates a SQLite database, connects to it, instantiates Auth, Crud, and Service, and configures them. It also provides a &quot;controller/default.py&quot; which exposes actions &quot;index&quot;, &quot;download&quot;, &quot;user&quot; for user management, and &quot;call&quot; for services. In the following, we assume that these files have been removed; we will be creating apps from scratch.</div><div class=""> -----</div><div class=""> </div><div class=""> web2py also comes with a **wizard**, described later in this chapter, that can write an alternate scaffolding code for you based on layouts and plugins available on the web and based on high level description of the models.</div><div class=""> </div><div class=""> ### Simple examples</div><div class=""> </div><div class=""> #### Say hello</div><div class=""> ``index``:inxx</div><div class=""> </div><div class=""> Here, as an example, we create a simple web app that displays the message &quot;Hello from MyApp&quot; to the user. We will call this application &quot;myapp&quot;. We will also add a counter that counts how many times the same user visits the page.</div><div class=""> </div><div class=""> You can create a new application simply by typing its name in the form on the top right of the **site** page in **admin**.</div><div class=""> </div><div class=""> [[image @///image/en800.png center 447px]]</div><div class=""> </div><div class=""> After you press [create], the application is created as a copy of the built-in welcome application.</div><div class=""> </div><div class=""> [[image @///image/en900.png center 480px]]</div><div class=""> </div><div class=""> To run the new application, visit:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/myapp</div><div class=""> ``:code</div><div class=""> </div><div class=""> Now you have a copy of the welcome application.</div><div class=""> </div><div class=""> Here is what the online editor looks like:</div><div class=""> </div><div class=""> Save it and go back to the &#x27;&#x27;edit&#x27;&#x27; page. Click on the index link to visit the newly created page.</div><div class=""> </div><div class=""> When you visit the URL</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/myapp/default/index</div><div class=""> ``:code</div><div class=""> </div><div class=""> the index action in the default controller of the myapp application is called. It returns a string that the browser displays for us. It should look like this:</div><div class=""> </div><div class=""> [[image @///image/en1100.png center 480px]]</div><div class=""> </div><div class=""> Now, edit the &quot;index&quot; function as follows:</div><div class=""> ``</div><div class=""> def index():</div><div class="">     return dict(message=&quot;Hello from MyApp&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Also from the &#x27;&#x27;edit&#x27;&#x27; page, edit the view &quot;default/index.html&quot; (the view file associated with the action) and completely replace the existing contents of that file with the following:</div><div class=""> ``</div><div class=""> &lt;html&gt;</div><div class="">    &lt;head&gt;&lt;/head&gt;</div><div class="">    &lt;body&gt;</div><div class="">       &lt;h1&gt;{{=message}}&lt;/h1&gt;</div><div class="">    &lt;/body&gt;</div><div class=""> &lt;/html&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> Now the action returns a dictionary defining a ``message``. When an action returns a dictionary, web2py looks for a view with the name</div><div class=""> </div><div class="delete">-``[controller]/[function].[extension]``:code</div><div class=""> </div><div class="delete"><span class="highlight"> </span>and executes it. Here <span class="highlight"></span>[extension]<span class="highlight"></span> is the requested extension. If no extension is specified, it defaults to &quot;html&quot;, and that is what we will assume here. Under this assumption, the view is an HTML file that embeds Python code using special {{ }} tags. In particular, in the example, the ``{{=message}}`` instructs web2py to replace the tagged code with the value of the ``message`` returned by the action. Notice that ``message`` here is not a web2py keyword but is defined in the action. So far we have not used any web2py keywords.</div><div class=""> </div><div class=""> If web2py does not find the requested view, it uses the &quot;generic.html&quot; view that comes with every application.</div><div class=""> </div><div class=""> -------</div><div class=""> ``Mac Mail``:inxx ``Google Maps``:inxx ``jsonp``:inxx</div><div class=""> If an extension other than &quot;html&quot; is specified (&quot;json&quot; for example), and the view file &quot;[controller]/[function].json&quot; is not found, web2py looks for the view &quot;generic.json&quot;. web2py comes with generic.html, generic.json, generic.jsonp, generic.xml, generic.rss, generic.ics (for Mac Mail Calendar), generic.map (for embedding Google Maps), and generic.pdf (based on fpdf). These generic views can be modified for each application individually, and additional views can be added easily.</div><div class=""> -------</div><div class=""> </div><div class=""> -------</div><div class=""> Generic views are a development tool. In production every action should have its own view. In fact, by default, generic views are only enabled from localhost.</div><div class=""> -------</div><div class=""> </div><div class=""> -------</div><div class=""> You can also specify a view with ``response.view = &#x27;default/something.html&#x27;``</div><div class=""> -------</div><div class=""> </div><div class=""> Read more on this topic in Chapter 10.</div><div class=""> </div><div class=""> If you go back to &quot;EDIT&quot; and click on index, you will now see the following HTML page:</div><div class=""> </div><div class=""> [[image @///image/en1200.png center 480px]]</div><div class=""> </div><div class="delete">-For debugging purposes you can always append</div><div class=""> </div><div class=""> ``</div><div class=""> {{=response.toolbar()}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> to the code in a view and it will show you some useful information, including the request, response and session objects, and list all db queries with their timing.</div><div class=""> </div><div class=""> #### Let&#x27;s count</div><div class=""> ``session``:inxx</div><div class=""> Let&#x27;s now add a counter to this page that will count how many times the same visitor displays the page.</div><div class=""> </div><div class=""> web2py automatically and transparently tracks visitors using sessions and cookies. For each new visitor, it creates a session and assigns a unique &quot;session_id&quot;. The session is a container for variables that are stored server-side. The unique id is sent to the browser via a cookie. When the visitor requests another page from the same application, the browser sends the cookie back, it is retrieved by web2py, and the corresponding session is restored.</div><div class=""> </div><div class=""> To use the session, modify the default controller:</div><div class=""> ``</div><div class=""> def index():</div><div class="">     if not session.counter:</div><div class="">         session.counter = 1</div><div class="">     else:</div><div class="">         session.counter += 1</div><div class="">     return dict(message=&quot;Hello from MyApp&quot;, counter=session.counter)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Notice that ``counter`` is not a web2py keyword but ``session`` is. We are asking web2py to check whether there is a counter variable in the session and, if not, to create one and set it to 1. If the counter is there, we ask web2py to increase the counter by 1. Finally we pass the value of the counter to the view.</div><div class=""> </div><div class=""> A more compact way to code the same function is this:</div><div class=""> ``</div><div class=""> def index():</div><div class="">     session.counter = (session.counter or 0) + 1</div><div class="">     return dict(message=&quot;Hello from MyApp&quot;, counter=session.counter)</div><div class=""> A better pattern for form submission is to submit forms to the same action that</div><div class=""> Modify the default controller to implement self-submission:</div><div class=""> ``</div><div class=""> def first():</div><div class="">     if request.vars.visitor_name:</div><div class="">         session.visitor_name = request.vars.visitor_name</div><div class="">         redirect(URL(&#x27;second&#x27;))</div><div class="">     return dict()</div><div class=""> </div><div class=""> def second():</div><div class="">     return dict()</div><div class=""> ``:code</div><div class=""> </div><div class=""> Then modify the &quot;default/first.html&quot; view:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> What is your name?</div><div class=""> &lt;form&gt;</div><div class="">   &lt;input name=&quot;visitor_name&quot; /&gt;</div><div class="">   &lt;input type=&quot;submit&quot; /&gt;</div><div class=""> &lt;/form&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> and the &quot;default/second.html&quot; view needs to retrieve the data from the ``session`` instead of from the ``request.vars``:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Hello {{=session.visitor_name or &quot;anonymous&quot;}}&lt;/h1&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> From the point of view of the visitor, the self-submission behaves exactly the same as the previous implementation. We have not added validation yet, but it is now clear that validation should be performed by the first action.</div><div class=""> </div><div class="delete">This approach is better also because the name of the visitor stays in the session, and can be accessed by all actions and views in the application<span class="highlight">s</span> without having to be passed around explicitly.</div><div class=""> </div><div class=""> Note that if the &quot;second&quot; action is ever called before a visitor name is set, it will display &quot;Hello anonymous&quot; because  ``session.visitor_name`` returns ``None``. Alternatively we could have added the following code in the controller (inside the ``second`` function):</div><div class=""> </div><div class=""> ``</div><div class=""> if not request.function==&#x27;first&#x27; and not session.visitor_name:</div><div class="">     redirect(URL(&#x27;first&#x27;))</div><div class=""> ``:code</div><div class=""> </div><div class="delete">This is a<span class="highlight"></span> <span class="highlight">gener</span>a<span class="highlight">l</span> mechanism that you can use to enforce authorization on controllers, though see Chapter 9 for a more powerful method.</div><div class=""> </div><div class=""> ``FORM``:inxx ``INPUT``:inxx ``requires``:inxx ``IS_NOT_EMPTY``:inxx ``accepts``:inxx</div><div class=""> </div><div class=""> With web2py we can move one step further and ask web2py to generate the form for us, including validation. web2py provides helpers (FORM, INPUT, TEXTAREA, and SELECT/OPTION) with the same names as the equivalent HTML tags. They can be used to build forms either in the controller or in the view.</div><div class=""> </div><div class=""> For example, here is one possible way to rewrite the first action:</div><div class=""> ``</div><div class=""> def first():</div><div class="">     form = FORM(INPUT(_name=&#x27;visitor_name&#x27;, requires=IS_NOT_EMPTY()),</div><div class="">               INPUT(_type=&#x27;submit&#x27;))</div><div class="">     if form.process().accepted:</div><div class="">         session.visitor_name = form.vars.visitor_name</div><div class="">         redirect(URL(&#x27;second&#x27;))</div><div class="">     return dict(form=form)</div><div class=""> ``:code</div><div class=""> </div><div class=""> where we are saying that the FORM tag contains two INPUT tags. The attributes of the input tags are specified by the named arguments starting with underscore. The ``requires`` argument is not a tag attribute (because it does not start by underscore) but it sets a validator for the value of visitor_name.</div><div class=""> </div><div class=""> Here is yet another better way to create the same form:</div><div class=""> </div><div class=""> ``</div><div class=""> def first():</div><div class="">     form = SQLFORM.factory(Field(&#x27;visitor_name&#x27;,</div><div class="">                                  label=&#x27;what is your name?&#x27;,</div><div class="">                                  requires=IS_NOT_EMPTY()))</div><div class="">     if form.process().accepted:</div><div class="">         session.visitor_name = form.vars.visitor_name</div><div class="">         redirect(URL(&#x27;second&#x27;))</div><div class="">     return dict(form=form)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The ``form`` object can be easily serialized in HTML by embedding it in the &quot;default/first.html&quot; view.</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> {{=form}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> The ``form.process()`` method applies the validators and returns the form itself. The ``form.accepted`` variable is set to True if the form was processed and passed validation. If the self-submitted form passes validation, it stores the variables in the session and redirects as before. If the form does not pass validation, error messages are inserted into the form and shown to the user, as below:</div><div class=""> </div><div class=""> [[image @///image/en1800.png center 480px]]</div><div class=""> </div><div class=""> In the next section we will show how forms can be generated automatically from a model.</div><div class=""> </div><div class=""> In all our examples we have used the session to pass the user name from the first action to the second. We could have used a different mechanism and passed data as part of a redirect URL:</div><div class=""> </div><div class=""> ``</div><div class=""> def first():</div><div class="">     form = SQLFORM.factory(Field(&#x27;visitor_name&#x27;, requires=IS_NOT_EMPTY()))</div><div class="">     if form.process().accepted:</div><div class="">         name = form.vars.visitor_name</div><div class="">         redirect(URL(&#x27;second&#x27;,vars=dict(name=name)))</div><div class="">     return dict(form=form)</div><div class=""> </div><div class=""> def second():</div><div class="">     name = request.vars.visitor_name or redirect(URL(&#x27;first&#x27;))</div><div class="">     return dict(name=name)</div><div class=""> ``:code</div><div class=""> </div><div class=""> #### Internationalization</div><div class=""> </div><div class=""> Your code is likely to include hardcoded strings such as &quot;What is your name?&quot;. You should be able to customize strings without editing the code and in particular insert translations for these strings in different languages. In this way if a visitor has the language preference of the browser set to &quot;Italian&quot;, web2py will use the Italian translation for the strings, if available. This feature of web2py is called &quot;internationalization&quot; and it is described in more detail in the next chapter.</div><div class=""> </div><div class=""> Here we just observe that in order to use this feature you should markup strings that needs translation. This is done by wrapping a quoted string in code such as</div><div class=""> </div><div class=""> ``</div><div class=""> &quot;What is your name?&quot;</div><div class=""> ``:code</div><div class=""> </div><div class=""> with the ``T`` operator:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;What is your name?&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> You can also mark for translations strings hardcoded in views. For example</div><div class=""> </div><div class=""> ``</div><div class=""> &lt;h1&gt;What is your name?&lt;/h1&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> becomes</div><div class=""> </div><div class=""> ``</div><div class=""> &lt;h1&gt;{{=T(&quot;What is your name?&quot;)}}&lt;/h1&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> It is good practice to do this for every string in the code (field labels, flash messages, etc.) except for tables and field names.</div><div class=""> </div><div class=""> Once the strings are identified and marked up, web2py takes care of almost everything else. The admin interface also provides a page where you can translate each string in the languages you desire to support.</div><div class=""> </div><div class=""> ### An image blog</div><div class=""> ``upload``:inxx</div><div class=""> </div><div class=""> Here, as another example, we wish to create a web application that allows the administrator to post images and give them a name, and allows the visitors of the web site to view the named images and submit comments (posts).</div><div class=""> </div><div class=""> As before, from the **site** page in **admin**, create a new application called ``images``, and navigate to the &#x27;&#x27;edit&#x27;&#x27; page:</div><div class=""> </div><div class=""> [[image @///image/en1900.png center 480px]]</div><div class=""> </div><div class=""> We start by creating a model, a representation of the persistent data in the application (the images to upload, their names, and the comments). First, you need to create/edit a model file which, for lack of imagination, we call &quot;db.py&quot;. We assume the code below will replace any existing code in &quot;db.py&quot;. Models and controllers must have a ``.py`` extension since they are Python code. If the extension is not provided, it is appended by web2py. Views instead have a ``.html`` extension since they mainly contain HTML code.</div><div class=""> </div><div class=""> Edit the &quot;db.py&quot; file by clicking the corresponding &quot;edit&quot; button:</div><div class=""> </div><div class=""> [[image @///image/en2000.png center 480px]]</div><div class=""> </div><div class=""> and enter the following:</div><div class=""> </div><div class=""> ``IS_EMAIL``:inxx ``IS_NOT_EMPTY``:inxx ``IS_IN_DB``:inxx</div><div class=""> ``</div><div class=""> db = DAL(&quot;sqlite://storage.sqlite&quot;)</div><div class=""> </div><div class=""> db.define_table(&#x27;image&#x27;,</div><div class="">    Field(&#x27;title&#x27;, unique=True),</div><div class="">    Field(&#x27;file&#x27;, &#x27;upload&#x27;),</div><div class="">    format = &#x27;%(title)s&#x27;)</div><div class=""> </div><div class=""> db.define_table(&#x27;post&#x27;,</div><div class="">    Field(&#x27;image_id&#x27;, &#x27;reference image&#x27;),</div><div class="">    Field(&#x27;author&#x27;),</div><div class="">    Field(&#x27;email&#x27;),</div><div class="">    Field(&#x27;body&#x27;, &#x27;text&#x27;))</div><div class=""> </div><div class=""> db.image.title.requires = IS_NOT_IN_DB(db, db.image.title)</div><div class=""> db.post.image_id.requires = IS_IN_DB(db, db.image.id, &#x27;%(title)s&#x27;)</div><div class=""> db.post.author.requires = IS_NOT_EMPTY()</div><div class=""> db.post.email.requires = IS_EMAIL()</div><div class=""> db.post.body.requires = IS_NOT_EMPTY()</div><div class=""> </div><div class=""> db.post.image_id.writable = db.post.image_id.readable = False</div><div class=""> ``:code</div><div class=""> </div><div class=""> Let&#x27;s analyze this line by line.</div><div class=""> </div><div class=""> Line 1 defines a global variable called ``db`` that represents the database connection. In this case it is a connection to a SQLite database stored in the file  &quot;applications/images/databases/storage.sqlite&quot;. When using SQLite, if the database file does not exist, it is created. You can change the name of the file, as well as the name of the global variable ``db``, but it is convenient to give them the same name, to make it easy to remember.</div><div class=""> </div><div class="delete">Lines 3-<span class="highlight">5</span> define a table &quot;image&quot;. ``define_table`` is a method of the ``db`` object. The first argument, &quot;image&quot;, is the name of the table we are defining. The other arguments are the fields belonging to that table. This table has a field called &quot;title&quot;, a field called &quot;file&quot;, and a field called &quot;id&quot; that serves as the table primary key (&quot;id&quot; is not explicitly declared because all tables have an id field by default). The field &quot;title&quot; is a string, and the field &quot;file&quot; is of type &quot;upload&quot;. &quot;upload&quot; is a special type of field used by the web2py Data Abstraction Layer (DAL) to store the names of uploaded files. web2py knows how to upload files (via streaming if they are large), rename them safely, and store them.</div><div class=""> </div><div class=""> When a table is defined, web2py takes one of several possible actions:</div><div class=""> - if the table does not exist, the table is created;</div><div class=""> - if the table exists and does not correspond to the definition, the table is altered accordingly, and if a field has a different type, web2py tries to convert its contents;</div><div class=""> - if the table exists and corresponds to the definition, web2py does nothing.</div><div class=""> </div><div class=""> This behavior is called &quot;migration&quot;. In web2py migrations are automatic, but can be disabled for each table by passing ``migrate=False`` as the last argument of ``define_table``.</div><div class=""> </div><div class=""> Line 6 defines a format string for the table. It determines how a record should be represented as a string. Notice that the ``format`` argument can also be a function that takes a record and returns a string. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> format=lambda row: row.title</div><div class=""> ``:code</div><div class=""> </div><div class=""> Lines 8-12 define another table called &quot;post&quot;.</div><div class=""> A post has an &quot;author&quot;, an &quot;email&quot; (we intend to store the email address of the author of the post), a &quot;body&quot; of type &quot;text&quot; (we intend to use it to store the actual comment posted by the author), and an &quot;image_id&quot; field of type reference that points to ``db.image`` via the &quot;id&quot; field.</div><div class=""> </div><div class=""> In line 14, ``db.image.title`` represents the field &quot;title&quot; of table &quot;image&quot;. The attribute ``requires`` allows you to set requirements/constraints that will be enforced by web2py forms. Here we require that the &quot;title&quot; is unique:</div><div class=""> </div><div class=""> ``IS_NOT_IN_DB(db, db.image.title)``:code</div><div class=""> </div><div class=""> &#x27;&#x27;Notice this is optional because it is set automatically given that ``Field(&#x27;title&#x27;, unique=True)``&#x27;&#x27;.</div><div class=""> </div><div class=""> The objects representing these constraints are called validators. Multiple validators can be grouped in a list. Validators are executed in the order they appear.</div><div class=""> ``IS_NOT_IN_DB(a, b)`` is a special validator that checks that the value of a field ``b`` for a new record is not already in ``a``.</div><div class=""> </div><div class=""> Line 15 requires that the field &quot;image_id&quot; of table &quot;post&quot; is in ``db.image.id``. As far as the database is concerned, we had already declared this  when we defined the table &quot;post&quot;.</div><div class=""> Now we are explicitly telling the model that this condition should be enforced by web2py, too, at the form processing level when a new comment is posted, so that invalid values do not propagate from input forms to the database. We also require that the &quot;image_id&quot; be represented by the &quot;title&quot;, ``&#x27;%(title)s&#x27;``, of the corresponding record.</div><div class=""> </div><div class=""> Line 20 indicates that the field &quot;image_id&quot; of table &quot;post&quot; should not be shown in forms, ``writable=False`` and not even in read-only forms, ``readable=False``.</div><div class=""> </div><div class="delete">The meaning of the validators in lines 1<span class="highlight">5</span>-1<span class="highlight">7</span> should be obvious.</div><div class=""> </div><div class=""> ``format``:inxx</div><div class=""> Notice that the validator</div><div class=""> ``</div><div class=""> db.post.image_id.requires = IS_IN_DB(db, db.image.id, &#x27;%(title)s&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> can be omitted (and would be automatic) if we specify a format for referenced table:</div><div class=""> ``</div><div class=""> db.define_table(&#x27;image&#x27;, ..., format=&#x27;%(title)s&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> where the format can be a string or a function that takes a record and returns a string.</div><div class=""> </div><div class=""> ``appadmin``:inxx</div><div class=""> Once a model is defined, if there are no errors, web2py creates an application administration interface to manage the database. You access it via the &quot;database administration&quot; link in the &#x27;&#x27;edit&#x27;&#x27; page or directly:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/appadmin</div><div class=""> ``:code</div><div class=""> </div><div class=""> Here is a screenshot of the **appadmin** interface:</div><div class=""> </div><div class=""> [[image @///image/en2100.png center 480px]]</div><div class=""> </div><div class=""> This interface is coded in the controller called &quot;appadmin.py&quot; and the corresponding view &quot;appadmin.html&quot;. From now on, we will refer to this interface simply as **appadmin**. It allows the administrator to insert new database records, edit and delete existing records, browse tables, and perform database joins.</div><div class=""> </div><div class=""> The first time **appadmin** is accessed, the model is executed and the tables are created. The web2py DAL translates Python code into SQL statements that are specific to the selected database back-end (SQLite in this example). You can see the generated SQL from the &#x27;&#x27;edit&#x27;&#x27; page by clicking on the &quot;sql.log&quot; link under &quot;models&quot;. Notice that the link is not present until the tables have been created.</div><div class=""> </div><div class=""> [[image @///image/en2200.png center 480px]]</div><div class=""> </div><div class=""> def edit():</div><div class=""> def documents():</div><div class="">      &quot;&quot;&quot;browser, edit all documents attached to a certain page&quot;&quot;&quot;</div><div class="">      page = db.page(request.args(0,cast=int)) or redirect(URL(&#x27;index&#x27;))</div><div class="">      db.document.page_id.default = page.id</div><div class="">      db.document.page_id.writable = False</div><div class="">      grid = SQLFORM.grid(db.document.page_id==page.id,args=[page.id])</div><div class="">      return dict(page=page, grid=grid)</div><div class=""> </div><div class=""> def user():</div><div class="">      return dict(form=auth())</div><div class=""> </div><div class=""> def download():</div><div class="">      &quot;&quot;&quot;allows downloading of documents&quot;&quot;&quot;</div><div class="">      return response.download(request, db)</div><div class=""> </div><div class=""> def search():</div><div class="">      &quot;&quot;&quot;an ajax wiki search page&quot;&quot;&quot;</div><div class="">      return dict(form=FORM(INPUT(_id=&#x27;keyword&#x27;,_name=&#x27;keyword&#x27;,</div><div class="">               _onkeyup=&quot;ajax(&#x27;callback&#x27;, [&#x27;keyword&#x27;], &#x27;target&#x27;);&quot;)),</div><div class="">               target_div=DIV(_id=&#x27;target&#x27;))</div><div class=""> </div><div class=""> def callback():</div><div class="">      &quot;&quot;&quot;an ajax callback that returns a &lt;ul&gt; of links to wiki pages&quot;&quot;&quot;</div><div class="">      query = db.page.title.contains(request.vars.keyword)</div><div class="">      pages = db(query).select(orderby=db.page.title)</div><div class="">      links = [A(p.title, _href=URL(&#x27;show&#x27;,args=p.id)) for p in pages]</div><div class="">      return UL(*links)</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class="delete">Lines 2-6 <span class="highlight">provid</span>e a comment for the index action. Lines 4-5 inside the comment are interpreted by python as test code (doctest). Tests can be run via the admin interface. In this case the tests verify that the index action runs without errors.</div><div class=""> </div><div class=""> Lines 18, 27, and 35 try to fetch a ``page`` record with the id in</div><div class=""> ``request.args(0)``.</div><div class=""> </div><div class=""> Lines 13, 20 define and process create forms for a new page and a new comment and</div><div class=""> </div><div class=""> Line 28 defines and processes an update form for a wiki page.</div><div class=""> </div><div class=""> Line 38 creates a ``grid`` object that allows to view, add and update the comments linked to a page.</div><div class=""> </div><div class=""> Some magic happens in line 51. The ``onkeyup`` attribute of the INPUT tag &quot;keyword&quot; is set. Every time the visitor releases a key, the JavaScript code inside the ``onkeyup`` attribute is executed, client-side. Here is the JavaScript code:</div><div class=""> ``</div><div class=""> ajax(&#x27;callback&#x27;, [&#x27;keyword&#x27;], &#x27;target&#x27;);</div><div class=""> ``:code</div><div class=""> ``ajax`` is a JavaScript function defined in the file &quot;web2py.js&quot; which is included by the default &quot;layout.html&quot;. It takes three parameters: the URL of the action that performs the synchronous callback, a list of the IDs of variables to be sent to the callback ([&quot;keyword&quot;]), and the ID where the response has to be inserted (&quot;target&quot;).</div><div class=""> </div><div class=""> As soon as you type something in the search box and release a key, the client calls the server and sends the content of the &#x27;keyword&#x27; field, and, when the sever responds, the response is embedded in the page itself as the innerHTML of the &#x27;target&#x27; tag.</div><div class=""> </div><div class=""> The &#x27;target&#x27; tag is a DIV defined in line 52. It could have been defined in the view as well.</div><div class=""> </div><div class=""> Here is the code for the view &quot;default/create.html&quot;:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Create new wiki page&lt;/h1&gt;</div><div class=""> {{=form}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> Assuming you are registered and logged in, if you visit the **create** page, you see the following:</div><div class=""> </div><div class=""> [[image @///image/en3500.png center 480px]]</div><div class=""> Here is the code for the view &quot;default/index.html&quot;:</div><div class="">      {{=LI(A(page.title, _href=URL(&#x27;show&#x27;, args=page.id)))}}</div><div class=""> {{pass}}&lt;/ul&gt;</div><div class=""> [ {{=A(&#x27;create page&#x27;, _href=URL(&#x27;create&#x27;))}} ]</div><div class=""> ``:code</div><div class=""> </div><div class=""> It generates the following page:</div><div class=""> </div><div class=""> [[image @///image/en3600.png center 480px]]</div><div class=""> </div><div class=""> Here is the code for the view &quot;default/show.html&quot;:</div><div class=""> </div><div class=""> ``markdown``:inxx ``MARKMIN``:inxx</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;{{=page.title}}&lt;/h1&gt;</div><div class=""> [ {{=A(&#x27;edit&#x27;, _href=URL(&#x27;edit&#x27;, args=request.args))}}</div><div class=""> | {{=A(&#x27;documents&#x27;, _href=URL(&#x27;documents&#x27;, args=request.args))}} ]&lt;br /&gt;</div><div class=""> {{=MARKMIN(page.body)}}</div><div class=""> &lt;h2&gt;Comments&lt;/h2&gt;</div><div class=""> {{for post in comments:}}</div><div class="">   &lt;p&gt;{{=db.auth_user[post.created_by].first_name}} on {{=post.created_on}}</div><div class="">      says &lt;i&gt;{{=post.body}}&lt;/i&gt;&lt;/p&gt;</div><div class=""> {{pass}}</div><div class=""> &lt;h2&gt;Post a comment&lt;/h2&gt;</div><div class=""> {{=form}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> If you wish to use markdown syntax instead of markmin syntax:</div><div class=""> </div><div class=""> ``</div><div class="delete">from gluon.contrib.markdown import WIKI<span class="highlight"></span></div><div class=""> ``:code</div><div class=""> </div><div class="delete">and use ``<span class="highlight"></span>W<span class="highlight">IKI</span>`` instead of the ``MARKMIN`` helper.</div><div class=""> Alternatively, you can choose to accept raw HTML instead of markmin syntax. In this case you would replace:</div><div class=""> ``</div><div class=""> {{=MARKMIN(page.body)}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> with:</div><div class=""> ``</div><div class=""> {{=XML(page.body)}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> ``sanitize``:inxx</div><div class=""> (so that the XML does not get escaped, which web2py normally does by default for security reasons).</div><div class=""> </div><div class=""> This can be done better with:</div><div class=""> ``</div><div class=""> {{=XML(page.body, sanitize=True)}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> By setting ``sanitize=True``, you tell web2py to escape unsafe XML tags such as &quot;&lt;script&gt;&quot;, and thus prevent XSS vulnerabilities.</div><div class=""> </div><div class=""> Now if, from the index page, you click on a page title, you can see the page that you have created:</div><div class=""> </div><div class=""> [[image @///image/en3700.png center 480px]]</div><div class=""> </div><div class=""> Here is the code for the view &quot;default/edit.html&quot;:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Edit wiki page&lt;/h1&gt;</div><div class=""> [ {{=A(&#x27;show&#x27;, _href=URL(&#x27;show&#x27;, args=request.args))}} ]&lt;br /&gt;</div><div class=""> {{=form}}</div><div class=""> If you look at the page source you see the HTML returned by the callback:</div><div class=""> Generating an RSS feed of your wiki pages using web2py is easy because web2py includes ``gluon.contrib.rss2``. Just append the following action to the default controller:</div><div class=""> ``</div><div class=""> def news():</div><div class="">     &quot;&quot;&quot;generates rss feed form the wiki pages&quot;&quot;&quot;</div><div class="">     response.generic_patterns = [&#x27;.rss&#x27;]</div><div class="">     pages = db().select(db.page.ALL, orderby=db.page.title)</div><div class="">     return dict(</div><div class="">        title = &#x27;mywiki rss feed&#x27;,</div><div class="">        link = &#x27;http://127.0.0.1:8000/mywiki/default/index&#x27;,</div><div class="">        description = &#x27;mywiki news&#x27;,</div><div class="">        created_on = request.now,</div><div class="">        items = [</div><div class="">           dict(title = row.title,</div><div class="">                link = URL(&#x27;show&#x27;, args=row.id),</div><div class="">                description = MARKMIN(row.body).xml(),</div><div class="">                created_on = row.created_on</div><div class="">                ) for row in pages])</div><div class=""> ``:code</div><div class=""> </div><div class=""> and when you visit the page</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/mywiki/default/news.rss</div><div class=""> ``:code</div><div class=""> </div><div class=""> you see the feed (the exact output depends on the feed reader). Notice that the dict is automatically converted to RSS, thanks to the .rss extension in the URL.</div><div class=""> </div><div class=""> [[image @///image/en4000.png center 480px]]</div><div class=""> </div><div class=""> web2py also includes feedparser to read third-party feeds.</div><div class=""> </div><div class=""> ``XMLRPC``:inxx</div><div class=""> Finally, let&#x27;s add an XML-RPC handler that allows searching the wiki programmatically:</div><div class=""> ``</div><div class=""> service = Service()</div><div class=""> </div><div class=""> @service.xmlrpc</div><div class=""> def find_by(keyword):</div><div class="">      &quot;&quot;&quot;finds pages that contain keyword for XML-RPC&quot;&quot;&quot;</div><div class="">      return db(db.page.title.contains(keyword)).select().as_list()</div><div class=""> </div><div class=""> def call():</div><div class="">     &quot;&quot;&quot;exposes all registered services, including XML-RPC&quot;&quot;&quot;</div><div class="">     return service()</div><div class=""> ``:code</div><div class=""> </div><div class=""> Here, the handler action simply publishes (via XML-RPC), the functions specified in the list. In this case, ``find_by``. ``find_by`` is not an action (because it takes an argument). It queries the database with ``.select()`` and then extracts the records as a list with ``.response`` and returns the list.</div><div class=""> </div><div class=""> Here is an example of how to access the XML-RPC handler from an external</div><div class=""> Python program.</div><div class=""> ``</div><div class=""> &gt;&gt;&gt; import xmlrpclib</div><div class=""> &gt;&gt;&gt; server = xmlrpclib.ServerProxy(</div><div class="">     &#x27;http://127.0.0.1:8000/mywiki/default/call/xmlrpc&#x27;)</div><div class=""> &gt;&gt;&gt; for item in server.find_by(&#x27;wiki&#x27;):</div><div class="">         print item[&#x27;created_on&#x27;], item[&#x27;title&#x27;]</div><div class=""> ``:code</div><div class=""> </div><div class=""> The handler can be accessed from many other programming languages that understand XML-RPC, including C, C++, C# and Java.</div><div class=""> </div><div class=""> #### On ``date``, ``datetime`` and ``time`` format</div><div class=""> yet this representation is internationalized and you can use the admin translati</div><div class=""> Mind that by default English is not translated because web2py assumes the applications are written in English. If you want internationalization to work for English you need to create the translation file (using admin) and you need to declare that the application&#x27;s current language is something other than english, for example:</div><div class=""> ``</div><div class=""> T.current_languages = [&#x27;null&#x27;]</div><div class=""> ``</div><div class=""> </div><div class=""> ### The built-in web2py wiki</div><div class=""> </div><div class=""> Now you can forget the code we have built-in the previous section (not what you have learned about web2py APIs, just the code of the specific example) as we are going to provide an example of the built-in web2py wiki.</div><div class=""> </div><div class=""> In fact, web2py comes with wiki capabilities including media attachments, tags, tag cloud, page permissions, and support for oembed ``oembed``:cite and components (chapter 14). This wiki can be used with any web2py application.</div><div class=""> </div><div class=""> ------</div><div class=""> Notice the API of the built-in wiki is still considered experimental and small changes are still possible.</div><div class=""> ------</div><div class=""> </div><div class=""> Here we assume we are starting from scratch from a simple clone of the &quot;welcome&quot; application called &quot;wikidemo&quot;. Edit the controller and replace the &quot;index&quot; action with</div><div class=""> </div><div class=""> ``</div><div class=""> def index(): return auth.wiki()</div><div class=""> ``:code</div><div class=""> </div><div class=""> Done! You have a fully working wiki. At this point no page has been created and in order to create pages you must be logged-in and you must be member of a group called &quot;wiki-editor&quot; or &quot;wiki-author&quot;. If you are logged-in as administrator the &quot;wiki-editor&quot; group is created automatically and you are made a member. The difference between editors and authors is that the editors can create pages, edit and delete any page, while the authors can create pages (with some optional restrictions) and can only edit/delete the pages they have created.</div><div class=""> </div><div class=""> The ``auth.wiki()`` function returns in a dictionary with a key ``content`` which is understood by the scaffolding &quot;views/default/index.html&quot;. You can make your own view for this action:</div><div class=""> </div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> {{=content}}</div><div class=""> ``:code</div><div class=""> </div><div class="delete">and add extra HTML or code as needed. <span class="highlight">There</span> <span class="highlight">is</span> no<span class="highlight"></span> <span class="highlight">n</span>e<span class="highlight">ed</span> to <span class="highlight">call</span> the<span class="highlight"></span> action <span class="highlight">&quot;ind</span>ex<span class="highlight">&quot;</span>.<span class="highlight"></span></div><div class=""> </div><div class=""> To try the wiki, simply login into admin, visit the page</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index</div><div class=""> ``</div><div class=""> </div><div class=""> Then choose a slug (in the publishing business, a slug is a short name given to an article that is in production) and you will be redirected to an empty page where you can edit the content using MARKMIN wiki syntax. A new menu item called &quot;[wiki]&quot; will allow you to create, search, and edit pages. Wiki pages have URLs like:</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/[slug]</div><div class=""> ``</div><div class=""> </div><div class=""> Service pages have names which start by underscore:</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_create</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_search</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_could</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_recent</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_edit/...</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_editmedia/...</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_preview/...</div><div class=""> ``</div><div class=""> </div><div class=""> Try to create more pages such as &quot;index&quot;, &quot;aboutus&quot;, and &quot;contactus&quot;.</div><div class=""> Try to edit them.</div><div class=""> </div><div class=""> </div><div class=""> The ``wiki`` method has the following signature:</div><div class=""> </div><div class=""> ``</div><div class=""> def wiki(self, slug=None, env=None, render=&#x27;markmin&#x27;,</div><div class="">          manage_permissions=False, force_prefix=&#x27;&#x27;,</div><div class="">          restrict_search=False, resolve=True,</div><div class="">          extra=None, menugroups=None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> It takes the following arguments:</div><div class=""> </div><div class="delete">-- ``render`` which defaults to ``&#x27;markmin&#x27;`` but can be set equal to ``&#x27;html&#x27;``. It determines the syntax of the wiki. We will discuss the markmin wiki markup later. If you change it to HTML you may want to use a wysiwyg javascript editor such as TinyMCE or NicEdit.</div><div class="delete">-- ``manage_permissions``. This is set to ``False`` by default and only recognizes permissions for &quot;wiki-editor&quot; and &quot;wiki-author&quot;. If you change it to ``True`` the create/edit page will give the option to specify by names the group(s) whose members have permission to read and edit the page. There is a group &quot;everybody&quot; which includes all users.</div><div class=""> </div><div class="delete">- ``force_prefix``. If set to something like ``&#x27;%(id)s-&#x27;`` it will restrict authors (not editors) to creating pages with a prefix like &quot;[user id]-[page name]&quot;. The prefix can contain the id (&quot;%(id)s&quot;) or the username (&quot;%(username)s&quot;) or any other field from the auth_user table, as long as the corresponding column contains <span class="highlight"></span>valid string that would pass URL validation.</div><div class=""> - ``restrict_search``. This defaults to ``False`` and any logged-in user can search all wiki pages (but not necessary read or edit them). If set to ``True``, authors can search only their own pages, editors can search everything, other users cannot search anything.</div><div class="delete">- ``menu<span class="highlight"></span>groups``. This defaults to ``None`` and it indicates that wiki management menu (search, create, edit, etc.) is always displayed. You can set it to a list of group names whose members only can see this menu, for example ``[&#x27;wiki-editor&#x27;,&#x27;wiki-author&#x27;]``. Notice that even if the menu is exposed to everybody that does not mean everybody is allowed to perform actions listed in the menu since they are regulated by the access control system.</div><div class=""> </div><div class=""> The ``wiki`` method has some additional parameters which will be explained later: ``slug``, ``env``, and ``extra``.</div><div class=""> </div><div class=""> </div><div class=""> </div><div class=""> #### MARKMIN basics</div><div class=""> </div><div class="delete">The MARKMIN syntax allows you to markup **bold** text using ``**bold**``, &#x27;&#x27;italic&#x27;&#x27; text with ``&#x27;&#x27;italic&#x27;&#x27;``, <span class="highlight">``code`` text wit</span>h<span class="highlight"> ``\`\`code\`\```</span>. Titles must be prefixed by a #, sections by ##, and sub-sections by ###. Use a minus(-) to prefix an un-ordered item and plus(+) to prefix an ordered item. URLs are automatically converted into links. <span class="highlight">For example</span>:</div><div class=""> </div><div class=""> ``</div><div class=""> # This is a title</div><div class=""> ## this is a section title</div><div class=""> ### this is a subsection title</div><div class=""> </div><div class=""> Text can be **bold**, &#x27;&#x27;italic&#x27;&#x27;, !`!!`!code!`!!`! etc.</div><div class=""> Learn more at:</div><div class=""> </div><div class=""> http://web2py.com</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> You can use the ``extra`` parameter of ``auth.wiki`` to pass extra rendering rules to the MARKMIN helper.</div><div class=""> </div><div class=""> You can find more information about the MARKMIN syntax in chapter 5.</div><div class=""> </div><div class=""> ``auth.wiki`` is more powerful than the barebones MARKMIN helpers, supporting oembed and components.</div><div class=""> </div><div class=""> You can use the ``env`` parameter of ``auth.wiki`` to expose functions to your wiki.</div><div class=""> For example:</div><div class=""> </div><div class=""> ``</div><div class=""> auth.wiki(env=dict(join=lambda a,b,c:&quot;%s-%s-%s&quot; % (a,b,c)))</div><div class=""> ``</div><div class=""> </div><div class=""> allows you to use the markup syntax:</div><div class=""> </div><div class=""> ``</div><div class=""> @(join:1,2,3)</div><div class=""> Supported by oembed:</div><div class=""> </div><div class=""> ``</div><div class=""> flickr.com</div><div class=""> youtube.com</div><div class=""> hulu.com</div><div class=""> vimeo.com</div><div class=""> slideshare.net</div><div class=""> qik.com</div><div class=""> polleverywhere.com</div><div class=""> wordpress.com</div><div class=""> revision3.com</div><div class=""> viddler.com</div><div class=""> ``:code</div><div class=""> </div><div class=""> This is implemented in the web2py file ``gluon.contrib.autolinks`` and specifically in the function ``expand_one``. You can extend oembed support by registering more services. This is done by appending an entry to the ``EMBED_MAPS`` list:</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.contrib.autolinks import EMBED_MAPS</div><div class=""> EMBED_MAPS.append((re.compile(&#x27;http://vimeo.com/\S*&#x27;),</div><div class="">                    &#x27;http://vimeo.com/api/oembed.json&#x27;))</div><div class=""> ``:code</div><div class=""> </div><div class=""> #### Referencing wiki content</div><div class=""> </div><div class=""> If you create a wiki page with slug &quot;contactus&quot; you can refer to this page as</div><div class=""> </div><div class=""> ``</div><div class=""> \@////contactus</div><div class=""> ``:code</div><div class=""> </div><div class="delete">Here <span class="highlight"></span>``<span class="highlight">\@</span>////<span class="highlight">``</span> stands for</div><div class=""> </div><div class=""> ``</div><div class=""> \@/app/controller/function/</div><div class=""> ``:code</div><div class=""> </div><div class=""> but &quot;app&quot;, &quot;controller&quot;, and &quot;function&quot; are omitted thus assuming default.</div><div class=""> </div><div class=""> Similarly you can use the wiki menu to upload a media file (for example an image) linked to the page. The &quot;manage media&quot; page will show all files you have uploaded and will show the proper expression to link the media file. If, for example you upload a file &quot;test.jpg&quot; with title &quot;beach&quot;, the link expression will something like:</div><div class=""> </div><div class=""> ``</div><div class=""> \@////15/beach.jpg</div><div class=""> ``:code</div><div class=""> </div><div class=""> ``\@////`` is the same prefix described before. ``15`` is the id of the record storing the media file. ``beach`` is the title. ``.jpg`` is the extension of the original file.</div><div class=""> </div><div class=""> If you cut and paste ``\@////15/beach.jpg`` into wiki pages you embed the image.</div><div class=""> </div><div class=""> Mind that media files are linked to pages and inherit access permission from the pages.</div><div class=""> </div><div class=""> #### Wiki menus</div><div class=""> </div><div class=""> If you create a page with slug &quot;wiki-menu&quot; page it will be interpreted as a description of the menu. Here is an example:</div><div class=""> </div><div class=""> ``</div><div class=""> - Home &gt; \@////index</div><div class=""> - Info &gt; \@////info</div><div class=""> - web2py &gt; http://google.com</div><div class=""> - - About us &gt; \@////aboutus</div><div class=""> - - Contact us &gt; \@////contactus</div><div class=""> ``</div><div class=""> Another customization possible is adding extra fields to the standard wiki table</div><div class=""> auth.settings.extra_fields[&quot;wiki_page&quot;] = [Field(&quot;ablob&quot;, &quot;blob&quot;),]</div><div class=""> ``:code</div><div class=""> </div><div class=""> The line above adds a ``blob`` field to the ``wiki_page`` table. There is no need to call ``auth.wiki(resolve=False)``:code for this option, unless you need access to the wiki model for other customizations.</div><div class=""> </div><div class=""> </div><div class=""> #### Components</div><div class=""> </div><div class=""> One of the most powerful functions of the new web2py consists in the ability of embedding an action inside another action. We call this a component.</div><div class=""> </div><div class=""> Consider the following model:</div><div class=""> </div><div class=""> ``</div><div class=""> db.define_table(&#x27;thing&#x27;,Field(&#x27;name&#x27;,requires=IS_NOT_EMPTY()))</div><div class=""> ``:code</div><div class=""> </div><div class=""> and the following action:</div><div class=""> </div><div class=""> ``</div><div class=""> @auth.requires_login()</div><div class=""> def manage_things():</div><div class="">     return SQLFORM.grid(db.thing)</div><div class=""> ``:code</div><div class=""> </div><div class=""> This action is special because it returns a widget/helper not a dict of objects. Now we can embed this ``manage_things`` action into any view, with</div><div class=""> </div><div class=""> ``</div><div class=""> {{=LOAD(&#x27;default&#x27;,&#x27;manage_things&#x27;,ajax=True)}}</div><div class=""> ``:code</div><div class=""> </div><div class="delete">This allows the visitor interact with the component via Ajax without reloading the host page that embeds the widget. <span class="highlight">Basically t</span>he action is called via Ajax, inherits the style of the host page, and captures all form submissions and flash messages so that they are handled within the current page. On top of this the ``SQLFORM.grid`` widget uses digitally signed URLs to restrict access. More information about components can be found in chapter 13.</div><div class=""> </div><div class=""> Components like the one above can be embedded into wiki pages using the MARKMIN syntax:</div><div class=""> </div><div class=""> ``</div><div class=""> @{component:default/manage_things}</div><div class=""> ``</div><div class=""> </div><div class=""> This simply tells web2py that we want to include the &quot;manage_things&quot; action defined in the &quot;default&quot; controller as an Ajax &quot;component&quot;.</div><div class=""> </div><div class=""> ---------</div><div class=""> Most users will be able to build relatively complex applications simply by using ``auth.wiki`` to create pages and menus and embedded custom components into wiki pages. Wikis can be thought of as a mechanism to allow members of the group to create pages, but they can also be thought of as a way to develop applications in a modular way.</div><div class=""> ---------</div><div class=""> </div><div class=""> ### More on **admin**</div><div class=""> ``admin``:inxx</div><div class=""> </div><div class=""> The administrative interface provides additional functionality that we briefly review here.</div><div class=""> </div><div class=""> #### Site</div><div class=""> ``site``:inxx</div><div class=""> </div><div class=""> This page is the main administrative interface of web2py. It lists all installed applications on the left, while on the right side there are some special action forms.</div><div class=""> </div><div class=""> The first of them shows the web2py version and proposes to upgrade it if new versions are available. Of course, before upgrading be sure to have a full working backup!</div><div class=""> Then there are two other forms that allow the creation of a new application (simple or by using an online wizard) by specifying its name.</div><div class=""> </div><div class=""> ``Instant Press``:inxx ``Movuca``:inxx</div><div class=""> The following form allows uploading an existing application from either a local file or a remote URL. When you upload an application, you need to specify a name for it (using different names</div><div class=""> allows you to install multiple copies of the same application). You can try, for example, to upload the Movuca Social Networking application app created by Bruno Rocha:</div><div class=""> </div><div class=""> http://mercurial.selenic.com/</div><div class=""> </div><div class=""> The **admin** interface includes a Wizard that can help you create a new applications.</div><div class=""> You can access the wizard from the &quot;sites&quot; page as shown in the image below.</div><div class=""> </div><div class=""> [[image @///image/en5400.png center 480px]]</div><div class=""> </div><div class=""> The wizard will guide you through a series of steps involved in creating a new application:</div><div class=""> </div><div class=""> - Chose a name for the application</div><div class=""> - Configure the application and choose required plugins</div><div class=""> - Build required models (it will create CRUD pages for each model)</div><div class=""> - Allow you to edit the views of those pages using MARKMIN syntax</div><div class=""> </div><div class=""> The image below shows the second step of the process.</div><div class=""> </div><div class=""> [[image @///image/en5500.png center 480px]]</div><div class=""> </div><div class=""> You can see a dropdown to select a layout plugin (from ``web2py.com/layouts``), a multiple choice dropdown to check other plugins (from ``web2py.com/plugins``) and a &quot;login config&quot; field where to put the Janrain &quot;domain:key&quot;.</div><div class=""> </div><div class=""> The other steps are pretty much self-explanatory.</div><div class=""> </div><div class=""> The Wizard works well for what it does but it is considered an &#x27;&#x27;experimental feature&#x27;&#x27; for two reasons:</div><div class=""> </div><div class=""> - Applications created with the wizard and edited manually, cannot later be modified by the wizard.</div><div class=""> - The interface of the wizard will change over time to include support for more features and easier visual development.</div><div class=""> </div><div class=""> In any case the wizard is a handy tool for fast prototyping and it can be used to bootstrap a new application with an alternate layout and optional plugins.</div><div class=""> </div><div class=""> #### Configuring **admin**</div><div class=""> </div><div class="delete">Normally there is no need to perform any configuration of <span class="highlight"></span>admin<span class="highlight"></span> but a few customizations are possible. After you login into admin you can edit the admin configuration file via the URL:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/admin/default/edit/admin/models/0.py</div><div class=""> ``</div><div class=""> Notice that **admin** can be used to edit itself. In fact **admin** is an app as any other one.</div><div class=""> </div><div class="delete">The file &quot;0.py&quot; is <span class="highlight">v</span>e<span class="highlight"></span>r<span class="highlight">y</span> <span class="highlight">much</span> self documented<span class="highlight"></span> an<span class="highlight">d</span> <span class="highlight">if you</span> are <span class="highlight"></span>o<span class="highlight"></span>p<span class="highlight">e</span>n<span class="highlight">ing</span> p<span class="highlight">r</span>o<span class="highlight">ba</span>bl<span class="highlight">y you alr</span>e<span class="highlight">ady know what you are looking for. Anyway a few</span> customizations<span class="highlight"> exist that are more important than others</span>:</div><div class=""> </div><div class=""> ``</div><div class=""> GAE_APPCFG = os.path.abspath(os.path.join(&#x27;/usr/local/bin/appcfg.py&#x27;))</div><div class=""> ``</div><div class=""> This should point to the location of the &quot;appcfg.py&quot; file that comes with the Google App Engine SDK. If you have the SDK you may want to change these config parameters to the correct value. It will allow you to deploy to GAE from the admin interface.</div><div class=""> </div><div class=""> ``DEMO_MODE``:inxx</div><div class=""> </div><div class=""> You can also set web2py admin in demo mode:</div><div class=""> ``</div><div class=""> DEMO_MODE = True</div><div class=""> FILTER_APPS = [&#x27;welcome&#x27;]</div><div class=""> ``</div><div class="delete">And only the apps listed in <span class="highlight">filter apps</span> will be accessible and they will be only accessible in read-only mode.</div><div class=""> </div><div class=""> ``MULTI_USER_MODE``:inxx</div><div class=""> ``virtual laboratory``:inxx</div><div class=""> </div><div class=""> If you are a teacher and want to expose the administrative interface to students so that students can share one administrative interface for their projects (think of a virtual lab), can do it by setting:</div><div class=""> ``</div><div class=""> MULTI_USER_MODE = True</div><div class=""> ``</div><div class=""> In this way students will be required to login and will only be able to access their own apps via admin. You, as first user/teacher, will be able to access them all.</div><div class=""> </div><div class=""> In multi user mode, you can register students using the &quot;bulk register&quot; link in admin and manage them using the &quot;manage students&quot; link. The system also keeps track of when students login and how many lines of code they add/remove to/from their code. This data is presented to the administrator as charts under the application &quot;about&quot; page.</div><div class=""> </div><div class=""> Mind that this mechanism still assumes all users are trusted. All the apps created under admin run under the same credentials on the same filesystem. It is possible for an app created by a student to access the data and the source of an app created by another student. It is also possible for a student to create an app that locks the server.</div><div class=""> </div><div class=""> #### Mobile **admin**</div><div class=""> </div><div class="delete">-Notice that the admin application includes &quot;plugin_jqmobile&quot; which packages jQuery Mobile. When admin is accessed from a mobile device; this is detected by web2py and the interface is displayed using a mobile-friendly layout.</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/28816a98948c4a6577f73bdeb2b7424dc55d2582">28816a9</a><ul><li>Date : 2012-12-23</li><li>code building book</li></ul></li></ul>
<div class="row-fluid" id="com_28816a98948c4a6577f73bdeb2b7424dc55d2582">
    <div class="span6"><div class="diff"><div class=""> The **edit** page tells you what is inside the application.</div><div class=""> Every web2py application consists of certain files, most of which fall into one of six categories:</div><div class=""> - **models**: describe the data representation.</div><div class=""> - **controllers**: describe the application logic and workflow.</div><div class=""> - **views**: describe the data presentation.</div><div class=""> - **languages**: describe how to translate the application presentation to other languages.</div><div class=""> - **modules**: Python modules that belong to the application.</div><div class="insert">- **static files**: static images, CSS  files``css<span class="highlight">-</span>w,css<span class="highlight">-</span>o,css<span class="highlight">-</span>school``:cite , JavaScript files``js<span class="highlight">-</span>w,js<span class="highlight">-</span>b``:cite , etc.</div><div class=""> - **plugins**: groups of files designed to work together.</div><div class="">  </div><div class=""> Everything is neatly organized following the Model-View-Controller design pattern. Each section in the &#x27;&#x27;edit&#x27;&#x27; page corresponds to a subfolder in the application folder.</div></div></div>
    <div class="span6"><div class="diff"><div class=""> The **edit** page tells you what is inside the application.</div><div class=""> Every web2py application consists of certain files, most of which fall into one of six categories:</div><div class=""> - **models**: describe the data representation.</div><div class=""> - **controllers**: describe the application logic and workflow.</div><div class=""> - **views**: describe the data presentation.</div><div class=""> - **languages**: describe how to translate the application presentation to other languages.</div><div class=""> - **modules**: Python modules that belong to the application.</div><div class="delete">- **static files**: static images, CSS  files``css<span class="highlight">:</span>w,css<span class="highlight">:</span>o,css<span class="highlight">:</span>school``:cite , JavaScript files``js<span class="highlight">:</span>w,js<span class="highlight">:</span>b``:cite , etc.</div><div class=""> - **plugins**: groups of files designed to work together.</div><div class="">  </div><div class=""> Everything is neatly organized following the Model-View-Controller design pattern. Each section in the &#x27;&#x27;edit&#x27;&#x27; page corresponds to a subfolder in the application folder.</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/60ecdf04f0802a47a3fb83116d1449f8c3e6f141">60ecdf0</a><ul><li>Date : 2012-12-26</li><li>added wiki info</li></ul></li></ul>
<div class="row-fluid" id="com_60ecdf04f0802a47a3fb83116d1449f8c3e6f141">
    <div class="span6"><div class="diff"><div class="insert">### A <span class="highlight">simple </span>wiki</div><div class=""> ``wiki``:inxx ``RSS``:inxx ``Ajax``:inxx ``XMLRPC``:inxx</div><div class=""> </div><div class="insert">In this section, we build a<span class="highlight"> simple</span> wiki from scratch using only low level APIs<span class="highlight"> (as opposed to using the built-in wiki capabilities of web2py demonstrated in the next section)</span>. The visitor will be able to create pages, search them (by title), and edit them. The visitor will also be able to post comments (exactly as in the previous applications), and also post documents (as attachments to the pages) and link them from the pages. As a convention, we adopt the Markmin syntax for our wiki syntax. We will also implement a search page with Ajax, an RSS feed for the pages, and a handler to search the pages via XML-RPC``xmlrpc``:cite .</div><div class=""> </div><div class=""> The following diagram lists the actions that we need to implement and the links we intend to build among them.</div><div class=""> </div><div class=""> [[yUML diagram @///image/en3400.png center 250px]]</div><div class=""> </div><div class=""> Start by creating a new scaffolding app, naming it &quot;mywiki&quot;.</div><div class=""> </div><div class=""> The model must contain three tables: page, comment, and document. Both comment and document reference page because they belong to page. A document contains a file field of type upload as in the previous images application.</div><div class=""> </div><div class=""> Here is the complete model:</div><div class=""> ``</div><div class=""> db = DAL(&#x27;sqlite://storage.sqlite&#x27;)</div><div class=""> </div><div class=""> from gluon.tools import *</div><div class=""> auth = Auth(db)</div><div class=""> auth.define_tables()</div><div class=""> crud = Crud(db)</div><div class=""> </div><div class=""> db.define_table(&#x27;page&#x27;,</div><div class="">     Field(&#x27;title&#x27;),</div><div class="">     Field(&#x27;body&#x27;, &#x27;text&#x27;),</div><div class="">     Field(&#x27;created_on&#x27;, &#x27;datetime&#x27;, default=request.now),</div><div class="">     Field(&#x27;created_by&#x27;, &#x27;reference auth_user&#x27;, default=auth.user_id),</div><div class="">     format=&#x27;%(title)s&#x27;)</div><div class=""> </div><div class=""> db.define_table(&#x27;comment&#x27;,</div><div class="">     Field(&#x27;page_id&#x27;, &#x27;reference page&#x27;),</div><div class="">     Field(&#x27;body&#x27;, &#x27;text&#x27;),</div><div class="">     Field(&#x27;created_on&#x27;, &#x27;datetime&#x27;, default=request.now),</div><div class="">     Field(&#x27;created_by&#x27;, &#x27;reference auth_user&#x27;, default=auth.user_id))</div><div class=""> The handler can be accessed from many other programming languages that understan</div><div class=""> There are three different representation for each of the field types ``date``, ``datetime`` and ``time``:</div><div class=""> - the database representation</div><div class=""> - the internal web2py prepresentation</div><div class=""> - the string representation in forms and tables</div><div class=""> </div><div class=""> The database representation is an internal issue and does not affect the code. Internally, at the web2py level, they are stored as ``datetime.date``, ``datetime.datetime`` and ``datetime.time`` object respectively and they can be manipulated as such:</div><div class=""> </div><div class=""> ``</div><div class=""> for page in db(db.page).select():</div><div class="">     print page.title, page.day, page.month, page.year</div><div class=""> ``</div><div class=""> </div><div class=""> When dates are converted to strings in forms they are converted using the ISO representation </div><div class=""> ``</div><div class=""> %Y-%m-%d %H:%M:%S</div><div class=""> ``</div><div class=""> </div><div class=""> yet this representation in internationalized and you can use the admin stranslation page to change the format to an alternate one. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> %m/%b/%Y %H:%M:%S</div><div class=""> ``</div><div class=""> </div><div class=""> ------</div><div class=""> Mind that by default English is not translated because web2py assumes the applications is already written in English. If you want internationalization to work for English you need to create the translation file (using admin) and you need declare that the application current language is something other than english, for example:</div><div class=""> ``</div><div class=""> T.current_languages = [&#x27;null&#x27;]</div><div class=""> ``</div><div class=""> ------</div><div class=""> </div><div class="insert">+### The built-in web2py wiki</div><div class="insert">+</div><div class="insert">+Now you can forget the code we have built-in the previous section (not what you have learned about web2py APIs, just the code of the specific example) as we are going to provide and example of the built-in web2py wiki.</div><div class="insert">+</div><div class="insert">+In fact, web2py comes with wiki capabilities including media attachments, tags, tag cloud, page permissions, and support for oembed ``oembed``:cite and components (chapter 14). This wiki can be used with any web2py application.</div><div class="insert">+</div><div class="insert">+Here we assume we are starting from cratch from a simple clone of the &quot;welcome&quot; application called &quot;wikidemo&quot;. Edit the controller and replace the &quot;index&quot; action with</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+def index(): return auth.wiki()</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Done! You have a fully working wiki. At this point no page has been created and in order to create pages you must be logged-in and you must be member of a group called &quot;wiki-editor&quot; or &quot;wiki-author&quot;. If you are logged as administrator the &quot;wiki-editor&quot; group is created automatically and you are made a member. The difference between editors and authors is that the editors can create pages, edit and delete any page, while the authors can create pages (with some optional restrictions) and can only edit/delete the pages they have created.</div><div class="insert">+</div><div class="insert">+The ``auth.wiki()`` function returns in a dictionary with a key ``content`` which is undesrtood by the scaffolding &quot;views/default/index.html&quot;. You man make your own view for the this action:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+{{extend &#x27;layout.html&#x27;}}</div><div class="insert">+{{=content}}</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+and add extra HTML or code as needed. There is no need to call the action &quot;index&quot;.</div><div class="insert">+</div><div class="insert">+To try the wiki, simply login into admin, visit the page</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+http://127.0.0.1:8000/wikidemo/default/index</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+Then choose a slug (in the publishing business, a slug is a short name given to an article that is in production) and you will be redirected to an empty page where you can edit the content using MARKMIN wiki syntax. A new menu item called &quot;[wiki]&quot; will allow you create, search, and edit pages. Wiki pages have RULS like:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+http://127.0.0.1:8000/wikidemo/default/index/[slug]</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+Service pages have names which start by underscore:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+http://127.0.0.1:8000/wikidemo/default/index/_create</div><div class="insert">+http://127.0.0.1:8000/wikidemo/default/index/_search</div><div class="insert">+http://127.0.0.1:8000/wikidemo/default/index/_could</div><div class="insert">+http://127.0.0.1:8000/wikidemo/default/index/_recent</div><div class="insert">+http://127.0.0.1:8000/wikidemo/default/index/_edit/...</div><div class="insert">+http://127.0.0.1:8000/wikidemo/default/index/_editmedia/...</div><div class="insert">+http://127.0.0.1:8000/wikidemo/default/index/_preview/...</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+Try create more pages such as &quot;index&quot;, &quot;aboutus&quot;, and &quot;contactus&quot;.</div><div class="insert">+Try edit them. </div><div class="insert">+</div><div class="insert">+</div><div class="insert">+The ``wiki`` method takes some optional arguments:</div><div class="insert">+</div><div class="insert">+- ``render`` which defaults to ``&#x27;markmin&#x27;`` but can be set equal to ``&#x27;html&#x27;``. It termines the syntax of the wiki. We will discuss the makrmin wiki markup later. If you change it to HTML you may want to use a wysiwyg javascript editor such as TinyMCE of NicEdit.</div><div class="insert">+- ``manage_permissions``. This is set to ``False`` by default and only recognizes permissions for &quot;wiki-editor&quot; and &quot;wiki-author&quot;. If you change it to ``True`` the create/edit page will give the option to specify by names the groups whose members have permssion to read and edit the page. In this case is a group &quot;everybody&quot; to give read permission to everybody.</div><div class="insert">+- ``force_prefix``. If set to something like ``&#x27;%(id)s-&#x27;`` it will restict authors (not editors) to create page with a prefix like &quot;[user id]-[page name]&quot;. The prefix can contain the id (&quot;%(id)s&quot;) or the username (&quot;%(username)s&quot;) or any other field from the auth_user table, as long as the corresponding column contains valid string that would pass URL validation.</div><div class="insert">+- ``restrict_search``. This default to ``False`` and any logged-in user can search all wiki pages (but not necessary read or edit them). If set to ``True``, authors can search only their own pages, editors can search everything, other users cannot search anything.</div><div class="insert">+- ``menugroups``. This defaults to ``None`` and it indictates that wiki management menu (search, create, edit, etc.) is always displayed. You can set it to a list of group names whose members only can see this menu, for exmaple ``[&#x27;wiki-editor&#x27;,&#x27;wiki-author&#x27;]``. Notice that even if the menu is exposed to everybody does not mean everybody is allowed to perform actions listed in the menu since they are regulated by the access control system.</div><div class="insert">+</div><div class="insert">+The ``wiki`` method has some additional parameters which will be explained later: ``slug``, ``env``, and ``extra``.</div><div class="insert">+</div><div class="insert">+</div><div class="insert">+</div><div class="insert">+#### MARKMIN basics</div><div class="insert">+</div><div class="insert">+The MARKMIN syntax allows you to markup **bold** text using ``**bold**``, &#x27;&#x27;italic&#x27;&#x27; text with ``&#x27;&#x27;italic&#x27;&#x27;``, ``code`` text with ``\`\`code\`\```. Titles must be prefixed by a #, sections by ##, and sub-sections by ###. Use a minus(-) to prefix an un-ordered item and plus(+) to prefix an ordered item. URLs are automatically into links. For example:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+# This is title</div><div class="insert">+## this is a section title</div><div class="insert">+### this is a subsection title</div><div class="insert">+</div><div class="insert">+Text can be **bold**, &#x27;&#x27;italic&#x27;&#x27;, !`!!`!code!`!!`! etc.</div><div class="insert">+Learn more at:</div><div class="insert">+</div><div class="insert">+http://web2py.com</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+</div><div class="insert">+You can use the ``extra`` parameter of ``auth.wiki`` to pass extra rendering rules to the MARKMIN helper. For example:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.wiki(extra=dict(verbatim=lambda text: verbatim))</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+In the varbatim function will preprocess all the input marked as varbatim</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+!`!!`!</div><div class="insert">+hello world</div><div class="insert">+!`!!`!:verbatim</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+You can find more information about the MARKMIN syntax in chapter 5.</div><div class="insert">+``auth.wiki`` is more powerful than the barebone MARKMIN helpers. In fact it supports oembed and components.</div><div class="insert">+</div><div class="insert">+You can use theS ``env`` parameter of ``auth.wiki`` to expose functions to your wiki.</div><div class="insert">+For example:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.wiki(env=dict(join=lambda a,b,c:&quot;%s-%s-%s&quot; % (a,b,c)))</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+allows you to use the markup syntax:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+@(join:1,2,3)</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+</div><div class="insert">+This call the join function passed as extra with parameters ``a,b,c=1,2,3`` and will be redered as ``1-2-3``.</div><div class="insert">+</div><div class="insert">+#### Oembed protocol</div><div class="insert">+</div><div class="insert">+You can type in (or cut-and-paste) any URL into a wiki page it normally is rendered as a link to the URL. There are exceptions:</div><div class="insert">+</div><div class="insert">+- If the URL has an image extension, the link is embedded as an image, ``&lt;img/&gt;``.</div><div class="insert">+- If the URL has an audio extension, the link is embedded as HTML5 audio ``&lt;audio/&gt;``.</div><div class="insert">+- If the URL has a video extension, the link is embedded as HTML5 video ``&lt;video/&gt;``.</div><div class="insert">+- If the URL has a MS Office or PDF extension, Google Doc Viewer is embedded, showing the content of the document (only works for public documents).</div><div class="insert">+- If the URL points to a Youtube page, a Viemo page, or a Flickr page, web2py contacts the corrsponding web service and queries it about the propor way to embed the contect. This is done using the ``oembed`` protocol.</div><div class="insert">+</div><div class="insert">+Here is a complete list of supported formats:</div><div class="insert">+``</div><div class="insert">+Image (.PNG, .GIF, .JPG, .JPEG)</div><div class="insert">+Audio (.WAV, .OGG, .MP3)</div><div class="insert">+Video (.MOV, .MPE, .MP4, .MPG, .MPG2, .MPEG, .MPEG4, .MOVIE)</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+Supported via Google Doc Viewer:</div><div class="insert">+``</div><div class="insert">+Microsoft Excel (.XLS and .XLSX)                                                </div><div class="insert">+Microsoft PowerPoint 2007 / 2010 (.PPTX)                                        </div><div class="insert">+Apple Pages (.PAGES)                                                            </div><div class="insert">+Adobe PDF (.PDF)                                                                </div><div class="insert">+Adobe Illustrator (.AI)                                                         </div><div class="insert">+Adobe Photoshop (.PSD)                                                          </div><div class="insert">+Autodesk AutoCad (.DXF)                                                         </div><div class="insert">+Scalable Vector Graphics (.SVG)                                                 </div><div class="insert">+PostScript (.EPS, .PS)                                                          </div><div class="insert">+TrueType (.TTF)                                                                 </div><div class="insert">+XML Paper Specification (.XPS)                                                  </div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+Supported by oembed:</div><div class="insert">+``                                                                                </div><div class="insert">+flickr.com                                                                      </div><div class="insert">+youtube.com                                                                     </div><div class="insert">+hulu.com                                                                        </div><div class="insert">+vimeo.com                                                                       </div><div class="insert">+slideshare.net                                                                  </div><div class="insert">+qik.com                                                                         </div><div class="insert">+polleverywhere.com                                                              </div><div class="insert">+wordpress.com                                                                   </div><div class="insert">+revision3.com                                                                   </div><div class="insert">+viddler.com </div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+This is implemeneted in the web2py file ``gluon.contrib.autolinks`` and specifically in the function ``expand_one``. You can extend oembed support by registering more services. This is done by appending an entry to the ``EMBED_MAPS`` list:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+from gluon.contrib.autlinks import EMBED_MAPS</div><div class="insert">+EMBED_MAPS.append((re.compile(&#x27;http://vimeo.com/\S*&#x27;),</div><div class="insert">+                   &#x27;http://vimeo.com/api/oembed.json&#x27;))</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+#### Referencing wiki content</div><div class="insert">+</div><div class="insert">+If you create a wiki page with slug &quot;contactus&quot; you can refer to this page as</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+@////contactus</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Here ``@////`` stands for</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+@/app/controller/function/</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+but &quot;app&quot;, &quot;controller&quot;, and &quot;function&quot; are omitted thus assuming default.</div><div class="insert">+</div><div class="insert">+Similarly you can use the wiki menu to upload a media file (for example an image) linked to the page. The &quot;manage media&quot; page will show all files you have uploaded and will show the proper expression to link the media file. If, for example you upload a file &quot;test.jpg&quot; with title &quot;beach&quot;, the link expression will somthing like:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+@////15/beach.jpg</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+``@////`` is the same prefix described before. ``15`` is the id of the record storing the media file. ``beach`` is the title. ``.jpg`` is the extension of the original file.</div><div class="insert">+</div><div class="insert">+If you cut and paste ``@////15/beach.jpg`` into wiki pages you embed the image.</div><div class="insert">+</div><div class="insert">+Mind that media files are linked to pages and inherit access permission from the pages.</div><div class="insert">+</div><div class="insert">+#### Wiki menus</div><div class="insert">+</div><div class="insert">+If you create a page with slug &quot;wiki-menu&quot; page it will be interpreted as a description of the menu. Here is an example:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+- Home &gt; @////index</div><div class="insert">+- Info &gt; @////info</div><div class="insert">+- web2py &gt; http://google.com</div><div class="insert">+- - About us &gt; @////aboutus</div><div class="insert">+- - Countact us &gt; @////contactus</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+Each line a menu item. We used double dash for nested menu ites. The ``&gt;`` symbols separates the menu item title from the menu item link.</div><div class="insert">+</div><div class="insert">+Mind that the menu is appended to ``response.menu``. It does not replace it. The ``[wiki]`` menu tem with service functions is added automatically.</div><div class="insert">+</div><div class="insert">+#### Service functions</div><div class="insert">+</div><div class="insert">+If, for example, you want to use the wiki to create an editable sidebar you could create a page with ``slug=&quot;sidebar&quot;`` and then embed it in your layout.html with</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+{{=auth.wiki(slug=&#x27;sidebar&#x27;)}}</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Notice that there is nothing special with the word &quot;sidebar&quot;. Any wiki page can be retrieved and emebdded in any point in your code. This allows you mix and match wiki functionalities with regular web2py functionalities.</div><div class="insert">+</div><div class="insert">+You can also embed special wiki functions as the search by tags:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+{{=auth.wiki(&#x27;_search&#x27;)}}</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+or the tag cloud:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+{{=auth.wiki(&#x27;_cloud&#x27;)}}</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+#### Components</div><div class="insert">+</div><div class="insert">+One of the most powerful function of the new web2py consists in the ability of embedding an action inside another action. We call this a component.</div><div class="insert">+</div><div class="insert">+Consider the following model:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+db.define_table(&#x27;thing&#x27;,Field(&#x27;name&#x27;,requires=IS_NOT_EMPTY()))</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+and the following action:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+@auth.requires_login()</div><div class="insert">+def manage_things():</div><div class="insert">+    return SQLFORM.grid(db.thing)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+This action is special because it returns a widget/helper not a dict of objects. Now we can embed this ``manage_things`` action into any view, with</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+{{=LOAD(&#x27;default&#x27;,&#x27;manage_things&#x27;,ajax=True)}}</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+This allows the visitor interact with the component via Ajax without reloadin the host page that embeds the widget. Basically the action is called via Ajax, inherits the stile of the host page, and capture all forms submissions and flash messages so that thye are handled within the current page. On top of this the ``SQLFORM.grid`` widget uses digitally signed URLs to restrict access. More informaiton about components can be found in chapter 13.</div><div class="insert">+</div><div class="insert">+Components like the one above can be embedded into wiki pages using the MARKMIN syntax:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+@{component:default/manage_things}</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+This simply tells web2py that we want to incude the &quot;manage_things&quot; action defined in the &quot;default&quot; controller as an Ajax &quot;component&quot;.</div><div class="insert">+</div><div class="insert">+---------</div><div class="insert">+Most users will be able to build relatively complex applications simply by using ``auth.wiki`` to create pages and menus, and embedded custom components into wiki pages. Wiki can be tough as a mechanism to allow members of the group to create pages but they calso be though as a way to develop applications in a modular way.</div><div class="insert">+---------</div><div class="insert">+</div><div class=""> ### More on **admin**</div><div class=""> ``admin``:inxx</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">### A <span class="highlight"></span>wiki</div><div class=""> ``wiki``:inxx ``RSS``:inxx ``Ajax``:inxx ``XMLRPC``:inxx</div><div class=""> </div><div class="delete">-In web2py you can create a complete Wiki with tags, tag could, search, media files, and oembed support using only one line of code:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-def index(): return auth.wiki()</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-This function is documented later in this book and can be used to add a wiki to any existing application.</div><div class="delete">-</div><div class="delete">In this section, we build a<span class="highlight"></span> wiki from scratch using only low level APIs<span class="highlight"></span>. The visitor will be able to create pages, search them (by title), and edit them. The visitor will also be able to post comments (exactly as in the previous applications), and also post documents (as attachments to the pages) and link them from the pages. As a convention, we adopt the Markmin syntax for our wiki syntax. We will also implement a search page with Ajax, an RSS feed for the pages, and a handler to search the pages via XML-RPC``xmlrpc``:cite .</div><div class=""> </div><div class=""> The following diagram lists the actions that we need to implement and the links we intend to build among them.</div><div class=""> </div><div class=""> [[yUML diagram @///image/en3400.png center 250px]]</div><div class=""> </div><div class=""> Start by creating a new scaffolding app, naming it &quot;mywiki&quot;.</div><div class=""> </div><div class=""> The model must contain three tables: page, comment, and document. Both comment and document reference page because they belong to page. A document contains a file field of type upload as in the previous images application.</div><div class=""> </div><div class=""> Here is the complete model:</div><div class=""> ``</div><div class=""> db = DAL(&#x27;sqlite://storage.sqlite&#x27;)</div><div class=""> </div><div class=""> from gluon.tools import *</div><div class=""> auth = Auth(db)</div><div class=""> auth.define_tables()</div><div class=""> crud = Crud(db)</div><div class=""> </div><div class=""> db.define_table(&#x27;page&#x27;,</div><div class="">     Field(&#x27;title&#x27;),</div><div class="">     Field(&#x27;body&#x27;, &#x27;text&#x27;),</div><div class="">     Field(&#x27;created_on&#x27;, &#x27;datetime&#x27;, default=request.now),</div><div class="">     Field(&#x27;created_by&#x27;, &#x27;reference auth_user&#x27;, default=auth.user_id),</div><div class="">     format=&#x27;%(title)s&#x27;)</div><div class=""> </div><div class=""> db.define_table(&#x27;comment&#x27;,</div><div class="">     Field(&#x27;page_id&#x27;, &#x27;reference page&#x27;),</div><div class="">     Field(&#x27;body&#x27;, &#x27;text&#x27;),</div><div class="">     Field(&#x27;created_on&#x27;, &#x27;datetime&#x27;, default=request.now),</div><div class="">     Field(&#x27;created_by&#x27;, &#x27;reference auth_user&#x27;, default=auth.user_id))</div><div class=""> The handler can be accessed from many other programming languages that understan</div><div class=""> There are three different representation for each of the field types ``date``, ``datetime`` and ``time``:</div><div class=""> - the database representation</div><div class=""> - the internal web2py prepresentation</div><div class=""> - the string representation in forms and tables</div><div class=""> </div><div class=""> The database representation is an internal issue and does not affect the code. Internally, at the web2py level, they are stored as ``datetime.date``, ``datetime.datetime`` and ``datetime.time`` object respectively and they can be manipulated as such:</div><div class=""> </div><div class=""> ``</div><div class=""> for page in db(db.page).select():</div><div class="">     print page.title, page.day, page.month, page.year</div><div class=""> ``</div><div class=""> </div><div class=""> When dates are converted to strings in forms they are converted using the ISO representation </div><div class=""> ``</div><div class=""> %Y-%m-%d %H:%M:%S</div><div class=""> ``</div><div class=""> </div><div class=""> yet this representation in internationalized and you can use the admin stranslation page to change the format to an alternate one. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> %m/%b/%Y %H:%M:%S</div><div class=""> ``</div><div class=""> </div><div class=""> ------</div><div class=""> Mind that by default English is not translated because web2py assumes the applications is already written in English. If you want internationalization to work for English you need to create the translation file (using admin) and you need declare that the application current language is something other than english, for example:</div><div class=""> ``</div><div class=""> T.current_languages = [&#x27;null&#x27;]</div><div class=""> ``</div><div class=""> ------</div><div class=""> </div><div class=""> ### More on **admin**</div><div class=""> ``admin``:inxx</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/cef1d9c5a8aa25ac1038a851f23e057780f2851d">cef1d9c</a><ul><li>Date : 2012-12-28</li><li>fixed more issues, thank you Erwin Olario</li></ul></li></ul>
<div class="row-fluid" id="com_cef1d9c5a8aa25ac1038a851f23e057780f2851d">
    <div class="span6"><div class="diff"><div class="insert"><span class="highlight">Assuming you are registered and logged in, i</span>f you visit the **create** page, you see the following:</div><div class=""> </div><div class=""> [[image @///image/en3500.png center 480px]]</div><div class=""> </div><div class=""> Here is the code for the view &quot;default/index.html&quot;:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Available wiki pages&lt;/h1&gt;</div><div class=""> [ {{=A(&#x27;search&#x27;, _href=URL(&#x27;search&#x27;))}} ]&lt;br /&gt;</div><div class=""> &lt;ul&gt;{{for page in pages:}}</div><div class="">      {{=LI(A(page.title, _href=URL(&#x27;show&#x27;, args=page.id)))}}</div><div class=""> {{pass}}&lt;/ul&gt;</div><div class=""> [ {{=A(&#x27;create page&#x27;, _href=URL(&#x27;create&#x27;))}} ]</div><div class=""> ``:code</div><div class=""> </div><div class=""> It generates the following page:</div><div class=""> </div><div class=""> [[image @///image/en3600.png center 480px]]</div><div class=""> </div><div class=""> Here is the code for the view &quot;default/show.html&quot;:</div><div class=""> </div><div class=""> ``markdown``:inxx ``MARKMIN``:inxx</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;{{=page.title}}&lt;/h1&gt;</div><div class=""> [ {{=A(&#x27;edit&#x27;, _href=URL(&#x27;edit&#x27;, args=request.args))}}</div><div class=""> | {{=A(&#x27;documents&#x27;, _href=URL(&#x27;documents&#x27;, args=request.args))}} ]&lt;br /&gt;</div><div class=""> {{=MARKMIN(page.body)}}</div><div class=""> &lt;h2&gt;Comments&lt;/h2&gt;</div><div class=""> {{for post in comments:}}</div><div class="">   &lt;p&gt;{{=db.auth_user[post.created_by].first_name}} on {{=post.created_on}}</div><div class=""> If, from the &quot;show&quot; page, you click on documents, you can now manage the documen</div><div class=""> </div><div class=""> [[image @///image/en3800.png center 480px]]</div><div class=""> </div><div class=""> Finally here is the code for the view &quot;default/search.html&quot;:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Search wiki pages&lt;/h1&gt;</div><div class=""> [ {{=A(&#x27;listall&#x27;, _href=URL(&#x27;index&#x27;))}}]&lt;br /&gt;</div><div class=""> {{=form}}&lt;br /&gt;{{=target_div}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> which generates the following Ajax search form:</div><div class=""> </div><div class=""> [[image @///image/en3900.png center 480px]]</div><div class=""> </div><div class=""> You can also try to call the callback action directly by visiting, for example, the following URL:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/mywiki/default/callback?keyword=wiki</div><div class=""> ``:code</div><div class=""> </div><div class=""> If you look at the page source you see the HTML returned by the callback:</div><div class=""> ``</div><div class=""> &lt;ul&gt;&lt;li&gt;&lt;a href=&quot;/mywiki/default/show/4&quot;&gt;I made a Wiki&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> ``rss``:inxx</div><div class=""> Generating an RSS feed from the stored pages using web2py is easy because web2py includes ``gluon.contrib.rss2``. Just append the following action to the default controller:</div><div class=""> ``</div><div class=""> def news():</div><div class="">     &quot;generates rss feed form the wiki pages&quot;</div><div class="insert">    re<span class="highlight">s</span>ponse.generic_patterns = [&#x27;.rss&#x27;]</div><div class="">     pages = db().select(db.page.ALL, orderby=db.page.title)</div><div class="">     return dict(</div><div class="">        title = &#x27;mywiki rss feed&#x27;,</div><div class="">        link = &#x27;http://127.0.0.1:8000/mywiki/default/index&#x27;,</div><div class="">        description = &#x27;mywiki news&#x27;,</div><div class="">        created_on = request.now,</div><div class="">        items = [</div><div class="">           dict(title = row.title,</div><div class="">                link = URL(&#x27;show&#x27;, args=row.id),</div><div class="">                description = MARKMIN(row.body).xml(),</div><div class="">                created_on = row.created_on</div><div class="">                ) for row in pages])</div><div class=""> ``:code</div></div></div>
    <div class="span6"><div class="diff"><div class="delete"><span class="highlight">I</span>f you visit the **create** page, you see the following:</div><div class=""> </div><div class=""> [[image @///image/en3500.png center 480px]]</div><div class=""> </div><div class=""> Here is the code for the view &quot;default/index.html&quot;:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Available wiki pages&lt;/h1&gt;</div><div class=""> [ {{=A(&#x27;search&#x27;, _href=URL(&#x27;search&#x27;))}} ]&lt;br /&gt;</div><div class=""> &lt;ul&gt;{{for page in pages:}}</div><div class="">      {{=LI(A(page.title, _href=URL(&#x27;show&#x27;, args=page.id)))}}</div><div class=""> {{pass}}&lt;/ul&gt;</div><div class=""> [ {{=A(&#x27;create page&#x27;, _href=URL(&#x27;create&#x27;))}} ]</div><div class=""> ``:code</div><div class=""> </div><div class=""> It generates the following page:</div><div class=""> </div><div class=""> [[image @///image/en3600.png center 480px]]</div><div class=""> </div><div class=""> Here is the code for the view &quot;default/show.html&quot;:</div><div class=""> </div><div class=""> ``markdown``:inxx ``MARKMIN``:inxx</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;{{=page.title}}&lt;/h1&gt;</div><div class=""> [ {{=A(&#x27;edit&#x27;, _href=URL(&#x27;edit&#x27;, args=request.args))}}</div><div class=""> | {{=A(&#x27;documents&#x27;, _href=URL(&#x27;documents&#x27;, args=request.args))}} ]&lt;br /&gt;</div><div class=""> {{=MARKMIN(page.body)}}</div><div class=""> &lt;h2&gt;Comments&lt;/h2&gt;</div><div class=""> {{for post in comments:}}</div><div class="">   &lt;p&gt;{{=db.auth_user[post.created_by].first_name}} on {{=post.created_on}}</div><div class=""> If, from the &quot;show&quot; page, you click on documents, you can now manage the documen</div><div class=""> </div><div class=""> [[image @///image/en3800.png center 480px]]</div><div class=""> </div><div class=""> Finally here is the code for the view &quot;default/search.html&quot;:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Search wiki pages&lt;/h1&gt;</div><div class=""> [ {{=A(&#x27;listall&#x27;, _href=URL(&#x27;index&#x27;))}}]&lt;br /&gt;</div><div class=""> {{=form}}&lt;br /&gt;{{=target_div}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> which generates the following Ajax search form:</div><div class=""> </div><div class=""> [[image @///image/en3900.png center 480px]]</div><div class=""> </div><div class=""> You can also try to call the callback action directly by visiting, for example, the following URL:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/mywiki/default/callback?keyword=wiki</div><div class=""> ``:code</div><div class=""> </div><div class=""> If you look at the page source you see the HTML returned by the callback:</div><div class=""> ``</div><div class=""> &lt;ul&gt;&lt;li&gt;&lt;a href=&quot;/mywiki/default/show/4&quot;&gt;I made a Wiki&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> ``rss``:inxx</div><div class=""> Generating an RSS feed from the stored pages using web2py is easy because web2py includes ``gluon.contrib.rss2``. Just append the following action to the default controller:</div><div class=""> ``</div><div class=""> def news():</div><div class="">     &quot;generates rss feed form the wiki pages&quot;</div><div class="delete">    re<span class="highlight"></span>ponse.generic_patterns = [&#x27;.rss&#x27;]</div><div class="">     pages = db().select(db.page.ALL, orderby=db.page.title)</div><div class="">     return dict(</div><div class="">        title = &#x27;mywiki rss feed&#x27;,</div><div class="">        link = &#x27;http://127.0.0.1:8000/mywiki/default/index&#x27;,</div><div class="">        description = &#x27;mywiki news&#x27;,</div><div class="">        created_on = request.now,</div><div class="">        items = [</div><div class="">           dict(title = row.title,</div><div class="">                link = URL(&#x27;show&#x27;, args=row.id),</div><div class="">                description = MARKMIN(row.body).xml(),</div><div class="">                created_on = row.created_on</div><div class="">                ) for row in pages])</div><div class=""> ``:code</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/31b67861f63a89ddbca5db525b9ea745b956670e">31b6786</a><ul><li>Date : 2012-09-06</li><li>Fix typos</li></ul></li></ul>
<div class="row-fluid" id="com_31b67861f63a89ddbca5db525b9ea745b956670e">
    <div class="span6"><div class="diff"><div class=""> The **edit** page tells you what is inside the application.</div><div class="insert">Every web2py application consists of certain files, most of which fall into one of <span class="highlight">s</span>i<span class="highlight"></span>x categories:</div><div class=""> - **models**: describe the data representation.</div><div class=""> - **controllers**: describe the application logic and workflow.</div><div class=""> - **views**: describe the data presentation.</div><div class=""> - **languages**: describe how to translate the application presentation to other languages.</div><div class=""> - **modules**: Python modules that belong to the application.</div><div class=""> - **static files**: static images, CSS  files``css:w,css:o,css:school``:cite , JavaScript files``js:w,js:b``:cite , etc.</div><div class=""> - **plugins**: groups of files designed to work together.</div><div class="">  </div><div class=""> Everything is neatly organized following the Model-View-Controller design pattern. Each section in the &#x27;&#x27;edit&#x27;&#x27; page corresponds to a subfolder in the application folder.</div><div class=""> </div><div class=""> Notice that section headings will toggle their content. Folder names under static files are also collapsible.</div><div class=""> </div><div class=""> -------</div><div class=""> Each file listed in the section corresponds to a file physically located in the subfolder. Any operation performed on a file via the **admin** interface (create, edit, delete) can be performed directly from the shell using your favorite editor.</div><div class=""> -------</div><div class=""> </div><div class=""> The application contains other types of files (database, session files, error files, etc.), but they are not listed on the &#x27;&#x27;edit&#x27;&#x27; page because they are not created or modified by the administrator; they are created and modified by the application itself.</div><div class=""> </div><div class=""> The controllers contain the logic and workflow of the application. Every URL gets mapped into a call to one of the functions in the controllers (actions). There are two default controllers: &quot;appadmin.py&quot; and &quot;default.py&quot;. **appadmin** provides the database administrative interface; we do not need it now. &quot;default.py&quot; is the controller that you need to edit, the one that is called by default when no controller is specified in the URL. Edit the &quot;index&quot; function as follows:</div><div class=""> ``</div><div class=""> def index():</div><div class="">     return &quot;Hello from MyApp&quot;</div><div class=""> ``:code</div><div class=""> </div><div class=""> Here is what the online editor looks like:</div><div class=""> </div><div class=""> [[image @///image/en1000.png center 480px]]</div><div class=""> </div><div class=""> Save it and go back to the &#x27;&#x27;edit&#x27;&#x27; page. Click on the index link to visit the newly created page.</div><div class=""> </div><div class=""> http://127.0.0.1:8000/myapp/default/index</div><div class=""> the index action in the default controller of the myapp application is called. It returns a string that the browser displays for us. It should look like this:</div><div class=""> </div><div class=""> [[image @///image/en1100.png center 480px]]</div><div class=""> </div><div class=""> Now, edit the &quot;index&quot; function as follows:</div><div class=""> ``</div><div class=""> def index():</div><div class="">     return dict(message=&quot;Hello from MyApp&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Also from the &#x27;&#x27;edit&#x27;&#x27; page, edit the view &quot;default/index.html&quot; (the view file associated with the action) and completely replace the existing contents of that file with the following:</div><div class=""> ``</div><div class=""> &lt;html&gt;</div><div class="">    &lt;head&gt;&lt;/head&gt;</div><div class="">    &lt;body&gt;</div><div class="">       &lt;h1&gt;{{=message}}&lt;/h1&gt;</div><div class="">    &lt;/body&gt;</div><div class=""> &lt;/html&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> Now the action returns a dictionary defining a ``message``. When an action returns a dictionary, web2py looks for a view with the name</div><div class=""> </div><div class=""> ``[controller]/[function].[extension]``:code</div><div class=""> </div><div class="">  and executes it. Here [extension] is the requested extension. If no extension is specified, it defaults to &quot;html&quot;, and that is what we will assume here. Under this assumption, the view is an HTML file that embeds Python code using special {{ }} tags. In particular, in the example, the ``{{=message}}`` instructs web2py to replace the tagged code with the value of the ``message`` returned by the action. Notice that ``message`` here is not a web2py keyword but is defined in the action. So far we have not used any web2py keywords.</div><div class=""> </div><div class=""> If web2py does not find the requested view, it uses the &quot;generic.html&quot; view that comes with every application.</div><div class=""> </div><div class=""> -------</div><div class=""> ``Mac Mail``:inxx ``Google Maps``:inxx ``jsonp``:inxx</div><div class="insert">If an extension other than &quot;html&quot; is specified (&quot;json&quot; for example), and the view file &quot;[controller]/[function].json&quot; is not found, web2py looks for the view &quot;generic.json&quot;. web2py comes with generic.html, generic.json, generic.jsonp, generic.xml, generic.rss, generic.ics (for Mac Mail Calendar), generic.map (for embedding Google M<span class="highlight">ap</span>s), and generic.pdf (based on fpdf). These generic views can be modified for each application individually, and additional views can be added easily.</div><div class=""> -------</div></div></div>
    <div class="span6"><div class="diff"><div class=""> The **edit** page tells you what is inside the application.</div><div class="delete">Every web2py application consists of certain files, most of which fall into one of <span class="highlight"></span>i<span class="highlight">s</span>x categories:</div><div class=""> - **models**: describe the data representation.</div><div class=""> - **controllers**: describe the application logic and workflow.</div><div class=""> - **views**: describe the data presentation.</div><div class=""> - **languages**: describe how to translate the application presentation to other languages.</div><div class=""> - **modules**: Python modules that belong to the application.</div><div class=""> - **static files**: static images, CSS  files``css:w,css:o,css:school``:cite , JavaScript files``js:w,js:b``:cite , etc.</div><div class=""> - **plugins**: groups of files designed to work together.</div><div class="">  </div><div class=""> Everything is neatly organized following the Model-View-Controller design pattern. Each section in the &#x27;&#x27;edit&#x27;&#x27; page corresponds to a subfolder in the application folder.</div><div class=""> </div><div class=""> Notice that section headings will toggle their content. Folder names under static files are also collapsible.</div><div class=""> </div><div class=""> -------</div><div class=""> Each file listed in the section corresponds to a file physically located in the subfolder. Any operation performed on a file via the **admin** interface (create, edit, delete) can be performed directly from the shell using your favorite editor.</div><div class=""> -------</div><div class=""> </div><div class=""> The application contains other types of files (database, session files, error files, etc.), but they are not listed on the &#x27;&#x27;edit&#x27;&#x27; page because they are not created or modified by the administrator; they are created and modified by the application itself.</div><div class=""> </div><div class=""> The controllers contain the logic and workflow of the application. Every URL gets mapped into a call to one of the functions in the controllers (actions). There are two default controllers: &quot;appadmin.py&quot; and &quot;default.py&quot;. **appadmin** provides the database administrative interface; we do not need it now. &quot;default.py&quot; is the controller that you need to edit, the one that is called by default when no controller is specified in the URL. Edit the &quot;index&quot; function as follows:</div><div class=""> ``</div><div class=""> def index():</div><div class="">     return &quot;Hello from MyApp&quot;</div><div class=""> ``:code</div><div class=""> </div><div class=""> Here is what the online editor looks like:</div><div class=""> </div><div class=""> [[image @///image/en1000.png center 480px]]</div><div class=""> </div><div class=""> Save it and go back to the &#x27;&#x27;edit&#x27;&#x27; page. Click on the index link to visit the newly created page.</div><div class=""> </div><div class=""> http://127.0.0.1:8000/myapp/default/index</div><div class=""> the index action in the default controller of the myapp application is called. It returns a string that the browser displays for us. It should look like this:</div><div class=""> </div><div class=""> [[image @///image/en1100.png center 480px]]</div><div class=""> </div><div class=""> Now, edit the &quot;index&quot; function as follows:</div><div class=""> ``</div><div class=""> def index():</div><div class="">     return dict(message=&quot;Hello from MyApp&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Also from the &#x27;&#x27;edit&#x27;&#x27; page, edit the view &quot;default/index.html&quot; (the view file associated with the action) and completely replace the existing contents of that file with the following:</div><div class=""> ``</div><div class=""> &lt;html&gt;</div><div class="">    &lt;head&gt;&lt;/head&gt;</div><div class="">    &lt;body&gt;</div><div class="">       &lt;h1&gt;{{=message}}&lt;/h1&gt;</div><div class="">    &lt;/body&gt;</div><div class=""> &lt;/html&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> Now the action returns a dictionary defining a ``message``. When an action returns a dictionary, web2py looks for a view with the name</div><div class=""> </div><div class=""> ``[controller]/[function].[extension]``:code</div><div class=""> </div><div class="">  and executes it. Here [extension] is the requested extension. If no extension is specified, it defaults to &quot;html&quot;, and that is what we will assume here. Under this assumption, the view is an HTML file that embeds Python code using special {{ }} tags. In particular, in the example, the ``{{=message}}`` instructs web2py to replace the tagged code with the value of the ``message`` returned by the action. Notice that ``message`` here is not a web2py keyword but is defined in the action. So far we have not used any web2py keywords.</div><div class=""> </div><div class=""> If web2py does not find the requested view, it uses the &quot;generic.html&quot; view that comes with every application.</div><div class=""> </div><div class=""> -------</div><div class=""> ``Mac Mail``:inxx ``Google Maps``:inxx ``jsonp``:inxx</div><div class="delete">If an extension other than &quot;html&quot; is specified (&quot;json&quot; for example), and the view file &quot;[controller]/[function].json&quot; is not found, web2py looks for the view &quot;generic.json&quot;. web2py comes with generic.html, generic.json, generic.jsonp, generic.xml, generic.rss, generic.ics (for Mac Mail Calendar), generic.map (for embedding Google M<span class="highlight">pa</span>s), and generic.pdf (based on fpdf). These generic views can be modified for each application individually, and additional views can be added easily.</div><div class=""> -------</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/e8fd4a9f6c469c6a15492805add99a8a2a1cbf92">e8fd4a9</a><ul><li>Date : 2013-01-16</li><li>Various ...</li></ul></li></ul>
<div class="row-fluid" id="com_e8fd4a9f6c469c6a15492805add99a8a2a1cbf92">
    <div class="span6"><div class="diff"><div class="insert">This page<span class="highlight"> is the main administrative interface of web2py. It</span> lists all installed applications<span class="highlight"></span> <span class="highlight">on the left, while on the right side t</span>here are <span class="highlight">some special ac</span>t<span class="highlight">i</span>o<span class="highlight">n</span> forms<span class="highlight"></span>.</div><div class=""> </div><div class="insert">+The first of them shows the web2py version and proposes to upgrade it if new versions are available. Of course, before upgrading be sure to have a full working backup!</div><div class="insert">+Then there are two forms that allows creating a new application (simple or by using an online wizard) by specifying its name.</div><div class=""> </div><div class=""> ``Instant Press``:inxx ``Movuca``:inxx</div><div class="insert">+The following form allows uploading an existing application from either a local file or a remote URL. When you upload an application, you need to specify a name for it (using different names</div><div class="insert">+allows you to install multiple copies of the same application). You can try, for example, to upload the Movuca Social Networking application app created by Bruno Rocha:</div><div class=""> </div><div class=""> ``</div><div class=""> http://code.google.com/p/instant-press/</div><div class=""> ``</div><div class=""> </div><div class=""> or Instant Press CMS created by Martin Mulone:</div><div class=""> </div><div class=""> ``</div><div class=""> http://code.google.com/p/instant-press/</div><div class=""> ``</div><div class=""> </div><div class=""> or one of the many example applications available at:</div><div class=""> </div><div class=""> ``</div><div class=""> http://web2py.com/appliances</div><div class=""> ``</div><div class=""> </div><div class=""> ------</div><div class=""> Web2py files are packages as ``.w2p`` files. These ones are tar gzipped files. Web2py uses the ``.w2p`` extension instead of the ``.tgz`` extension to prevent the browser from unzipping on download. They can be uncompressed manually with ``tar zxvf [filename]`` although this is never necessary.</div><div class=""> ------</div><div class=""> </div><div class=""> [[image @///image/en4100.png center 444px]]</div><div class=""> </div><div class=""> Upon successful upload, web2py displays the MD5 checksum of the uploaded file. You can use it to verify that the file was not corrupted during upload. The InstantPress name will appear in the list of installed applications.</div><div class=""> </div><div class="insert">+If you run web2py from source and you have ``gitpython`` installed (if necessary, set it up with &#x27;easy_install gitpython&#x27;), you can install applications directly from git repositories</div><div class="insert">+using the ``.git`` URL in the upload form. In this case you will also be enabled to use the admin interface to push changes back into the repository, but this is an experimental feature.</div><div class=""> </div><div class="insert"><span class="highlight">For</span> <span class="highlight"></span>e<span class="highlight">xam</span>p<span class="highlight"></span>le<span class="highlight"></span>, you can <span class="highlight">locally </span>install<span class="highlight"> the</span> application<span class="highlight"></span> th<span class="highlight">at</span> <span class="highlight">shows th</span>i<span class="highlight">s</span> <span class="highlight">book</span> <span class="highlight">o</span>n the <span class="highlight">web2</span>p<span class="highlight">y</span> <span class="highlight">si</span>t<span class="highlight"></span>e<span class="highlight"></span> wi<span class="highlight"></span>t<span class="highlight">h</span> the <span class="highlight">URL:</span></div><div class=""> </div><div class="insert">+``</div><div class="insert">+https://github.com/mdipierro/web2py-book.git</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+------</div><div class="insert">+That repository hosts the current, updated version of this book (which could be different from the stable version you can see on the web site). You are warmly invited to use it for submitting</div><div class="insert">+improvements, fixes and corrections in the form of pull requests.</div><div class="insert">+------</div><div class="insert">+  </div><div class="insert">+For each application installed you can use the &#x27;&#x27;site&#x27;&#x27; page to:</div><div class="insert">+- Go directly to the application by clicking on its name.</div><div class=""> - Uninstall the application.</div><div class=""> - Jump to the &#x27;&#x27;about&#x27;&#x27; page (read below).</div><div class=""> - Jump to the &#x27;&#x27;edit&#x27;&#x27; page (read below).</div><div class=""> - Jump to the &#x27;&#x27;errors&#x27;&#x27; page (read below).</div><div class=""> - Clean up temporary files (sessions, errors, and cache.disk files).</div><div class=""> - Pack all. This returns a tar file containing a complete copy of the application. We suggest that you clean up temporary files before packing an application.</div><div class=""> - Compile the application. If there are no errors, this option will bytecode-compile all models, controllers and views. Because views can extend and include other views in a tree, before bytecode compilation, the view tree for every controller is collapsed into a single file. The net effect is that a bytecode-compiled application is faster, because there is no more parsing of templates or string substitutions occurring at runtime.</div><div class=""> - Pack compiled. This option is only present for bytecode-compiled applications. It allows packing the application without source code for distribution as closed source. Note that Python (as any other programming language) can technically be decompiled; therefore compilation does not provide complete protection of the source code. Nevertheless, decompilation can be difficult and can be illegal.</div><div class=""> - Remove compiled. It simply removes the byte-code compiled models, views and controllers from the application. If the application was packaged with source code or edited locally, there is no harm in removing the bytecode-compiled files, and the application will continue to work. If the application was installed form a packed compiled file, then this is not safe, because there is no source code to revert to, and the application will no longer work.</div><div class=""> </div><div class=""> ``admin.py``:inxx</div><div class=""> </div><div class=""> -------</div><div class=""> All the functionality available from the web2py admin site page is also accessible programmatically via the API defined in the module ``gluon/admin.py``. Simply open a python shell and import this module.</div><div class=""> -------</div><div class=""> </div><div class=""> If the Google App Engine SDK is installer the admin &#x27;&#x27;site&#x27;&#x27; page shows a button to push your applications to GAE. If ``python-git`` is installed, there is also a button to push your application to Open Shift. To install applications on ``Heroku`` or other hosting system you should look into the &quot;scripts&quot; folder for the appropriate script.</div><div class=""> </div><div class=""> #### About</div><div class=""> ``about``:inxx ``license``:inxx</div><div class=""> </div><div class=""> The &#x27;&#x27;about&#x27;&#x27; tab allows editing the description of the application and its license. These are written respectively in the ABOUT and LICENSE files in the application folder.</div><div class=""> </div><div class=""> [[image @///image/en4300.png center 480px]]</div><div class=""> </div><div class=""> You can use ``MARKMIN``, or ``gluon.contrib.markdown.WIKI`` syntax for these files as described in ref.``markdown2``:cite .</div><div class=""> </div><div class=""> #### Design</div><div class=""> ``EDIT``:inxx</div><div class=""> You have used the &#x27;&#x27;edit&#x27;&#x27; page already in this chapter. Here we want to point out a few more functionalities of the &#x27;&#x27;edit&#x27;&#x27; page.</div><div class=""> If you fix the divide-by-zero bug in the index action and introduce one in the i</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> </div><div class=""> &lt;h1&gt;Current Images&lt;/h1&gt;</div><div class=""> &lt;ul&gt;</div><div class=""> {{for image in images:}}</div><div class=""> {{1/0}}</div><div class=""> {{=LI(A(image.title, _href=URL(&quot;show&quot;, args=image.id)))}}</div><div class=""> {{pass}}</div><div class=""> &lt;/ul&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> you get the following ticket:</div><div class=""> </div><div class=""> [[image @///image/en5000.png center 480px]]</div><div class=""> </div><div class=""> Note that web2py has converted the view from HTML into a Python file, and the error described in the ticket refers to the generated Python code and NOT to the original view file:</div><div class=""> </div><div class=""> [[image @///image/en5100.png center 480px]]</div><div class=""> </div><div class=""> This may seem confusing at first, but in practice it makes debugging easier, because the Python indentation highlights the logical structure of the code that you embedded in the views.</div><div class=""> </div><div class=""> The code is shown at the bottom of the same page.</div><div class=""> </div><div class=""> All tickets are listed under admin in the &#x27;&#x27;errors&#x27;&#x27; page for each application:</div><div class=""> </div><div class=""> [[image @///image/en5200.png center 480px]]</div><div class=""> </div><div class=""> #### Mercurial</div><div class=""> ``Mercurial``:inxx</div><div class=""> </div><div class="insert">+If you are running from source, the administrative interface shows one more menu item called &quot;Versioning&quot;. </div><div class="insert">+</div><div class="insert">+[[images @///image/en5300.png center 480px]]</div><div class="insert">+</div><div class="insert">+Entering a comment and pressing the &quot;commit&quot; button in the resulting page will commit the current application. With the first commit, a local Mercurial repository for the specific </div><div class="insert">+application will be created. </div><div class="insert">+Under the hood, Mercurial stores information about changes you make in your code into a hidden folder &quot;.hg&quot; in your app subfolder. Every app has its own &quot;.hg&quot; folder and its own &quot;.hgignore&quot; file (tells Mercurial which files to ignore).</div><div class="insert">+In order to use this feature, you must have the Mercurial version control libraries installed (at least version 1.9):</div><div class="insert">+</div><div class="insert">+</div><div class=""> ``</div><div class=""> easy_install mercurial</div><div class=""> ``:code</div><div class=""> </div><div class=""> The Mercurial web interface does allow you to browse previous commit and diff files but we do recommend you use Mercurial directly from the shell or one of the many GUI-based Mercurial clients since they are more powerful. For example they will allow you sync your app with a remote source repository:</div><div class=""> </div></div></div>
    <div class="span6"><div class="diff"><div class="delete">This page<span class="highlight"></span> lists all installed applications<span class="highlight">.</span> <span class="highlight">T</span>here are <span class="highlight"></span>t<span class="highlight">w</span>o<span class="highlight"></span> forms<span class="highlight"> at the bottom</span>.</div><div class=""> </div><div class="delete">-The first of them allows creating a new application by specifying its name.</div><div class=""> </div><div class=""> ``Instant Press``:inxx ``Movuca``:inxx</div><div class="delete">-The second form allows uploading an existing application from either a local file or a remote URL. When you upload an application, you need to specify a name for it. This can be its original name, but does not need to be. This allows installing multiple copies of the same application. You can try, for example, to upload the Movuca Social Networking application app created by Bruno Rocha:</div><div class=""> </div><div class=""> ``</div><div class=""> http://code.google.com/p/instant-press/</div><div class=""> ``</div><div class=""> </div><div class=""> or Instant Press CMS created by Martin Mulone:</div><div class=""> </div><div class=""> ``</div><div class=""> http://code.google.com/p/instant-press/</div><div class=""> ``</div><div class=""> </div><div class=""> or one of the many example applications available at:</div><div class=""> </div><div class=""> ``</div><div class=""> http://web2py.com/appliances</div><div class=""> ``</div><div class=""> </div><div class=""> ------</div><div class=""> Web2py files are packages as ``.w2p`` files. These ones are tar gzipped files. Web2py uses the ``.w2p`` extension instead of the ``.tgz`` extension to prevent the browser from unzipping on download. They can be uncompressed manually with ``tar zxvf [filename]`` although this is never necessary.</div><div class=""> ------</div><div class=""> </div><div class=""> [[image @///image/en4100.png center 444px]]</div><div class=""> </div><div class=""> Upon successful upload, web2py displays the MD5 checksum of the uploaded file. You can use it to verify that the file was not corrupted during upload. The InstantPress name will appear in the list of installed applications.</div><div class=""> </div><div class="delete">-Click on the application name on admin to get it up and running.</div><div class=""> </div><div class="delete"><span class="highlight">If</span> <span class="highlight">you run w</span>e<span class="highlight">b2</span>p<span class="highlight">y from source and you have ``python-git`` instal</span>le<span class="highlight">d</span>, you can <span class="highlight"></span>install<span class="highlight"></span> application<span class="highlight">s directly from git repository using</span> th<span class="highlight">e</span> <span class="highlight">``.g</span>i<span class="highlight">t``</span> <span class="highlight">URL</span> <span class="highlight">i</span>n the <span class="highlight">u</span>p<span class="highlight">load</span> <span class="highlight">form. In </span>t<span class="highlight">his cas</span>e<span class="highlight"> you</span> wi<span class="highlight">ll also be used </span>t<span class="highlight">o user</span> the <span class="highlight">admin interface to push changes back into the repository.</span></div><div class=""> </div><div class="delete">-For each application the &#x27;&#x27;site&#x27;&#x27; page allows you to:</div><div class=""> - Uninstall the application.</div><div class=""> - Jump to the &#x27;&#x27;about&#x27;&#x27; page (read below).</div><div class=""> - Jump to the &#x27;&#x27;edit&#x27;&#x27; page (read below).</div><div class=""> - Jump to the &#x27;&#x27;errors&#x27;&#x27; page (read below).</div><div class=""> - Clean up temporary files (sessions, errors, and cache.disk files).</div><div class=""> - Pack all. This returns a tar file containing a complete copy of the application. We suggest that you clean up temporary files before packing an application.</div><div class=""> - Compile the application. If there are no errors, this option will bytecode-compile all models, controllers and views. Because views can extend and include other views in a tree, before bytecode compilation, the view tree for every controller is collapsed into a single file. The net effect is that a bytecode-compiled application is faster, because there is no more parsing of templates or string substitutions occurring at runtime.</div><div class=""> - Pack compiled. This option is only present for bytecode-compiled applications. It allows packing the application without source code for distribution as closed source. Note that Python (as any other programming language) can technically be decompiled; therefore compilation does not provide complete protection of the source code. Nevertheless, decompilation can be difficult and can be illegal.</div><div class=""> - Remove compiled. It simply removes the byte-code compiled models, views and controllers from the application. If the application was packaged with source code or edited locally, there is no harm in removing the bytecode-compiled files, and the application will continue to work. If the application was installed form a packed compiled file, then this is not safe, because there is no source code to revert to, and the application will no longer work.</div><div class=""> </div><div class=""> ``admin.py``:inxx</div><div class=""> </div><div class=""> -------</div><div class=""> All the functionality available from the web2py admin site page is also accessible programmatically via the API defined in the module ``gluon/admin.py``. Simply open a python shell and import this module.</div><div class=""> -------</div><div class=""> </div><div class=""> If the Google App Engine SDK is installer the admin &#x27;&#x27;site&#x27;&#x27; page shows a button to push your applications to GAE. If ``python-git`` is installed, there is also a button to push your application to Open Shift. To install applications on ``Heroku`` or other hosting system you should look into the &quot;scripts&quot; folder for the appropriate script.</div><div class=""> </div><div class=""> #### About</div><div class=""> ``about``:inxx ``license``:inxx</div><div class=""> </div><div class=""> The &#x27;&#x27;about&#x27;&#x27; tab allows editing the description of the application and its license. These are written respectively in the ABOUT and LICENSE files in the application folder.</div><div class=""> </div><div class=""> [[image @///image/en4300.png center 480px]]</div><div class=""> </div><div class=""> You can use ``MARKMIN``, or ``gluon.contrib.markdown.WIKI`` syntax for these files as described in ref.``markdown2``:cite .</div><div class=""> </div><div class=""> #### Design</div><div class=""> ``EDIT``:inxx</div><div class=""> You have used the &#x27;&#x27;edit&#x27;&#x27; page already in this chapter. Here we want to point out a few more functionalities of the &#x27;&#x27;edit&#x27;&#x27; page.</div><div class=""> If you fix the divide-by-zero bug in the index action and introduce one in the i</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> </div><div class=""> &lt;h1&gt;Current Images&lt;/h1&gt;</div><div class=""> &lt;ul&gt;</div><div class=""> {{for image in images:}}</div><div class=""> {{1/0}}</div><div class=""> {{=LI(A(image.title, _href=URL(&quot;show&quot;, args=image.id)))}}</div><div class=""> {{pass}}</div><div class=""> &lt;/ul&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> you get the following ticket:</div><div class=""> </div><div class=""> [[image @///image/en5000.png center 480px]]</div><div class=""> </div><div class=""> Note that web2py has converted the view from HTML into a Python file, and the error described in the ticket refers to the generated Python code and NOT to the original view file:</div><div class=""> </div><div class=""> [[image @///image/en5100.png center 480px]]</div><div class=""> </div><div class=""> This may seem confusing at first, but in practice it makes debugging easier, because the Python indentation highlights the logical structure of the code that you embedded in the views.</div><div class=""> </div><div class=""> The code is shown at the bottom of the same page.</div><div class=""> </div><div class=""> All tickets are listed under admin in the &#x27;&#x27;errors&#x27;&#x27; page for each application:</div><div class=""> </div><div class=""> [[image @///image/en5200.png center 480px]]</div><div class=""> </div><div class=""> #### Mercurial</div><div class=""> ``Mercurial``:inxx</div><div class=""> </div><div class="delete">-If you are running from source and you have the Mercurial version control libraries installed:</div><div class=""> ``</div><div class=""> easy_install mercurial</div><div class=""> ``:code</div><div class=""> </div><div class="delete">-then the administrative interface shows one more menu item called &quot;Versioning&quot;. It automatically creates a local Mercurial repository for the application. Pressing the &quot;comment&quot; button in the page will commit the current application. Mercurial creates and stores information about changes you make in your code into a hidden folder &quot;.hg&quot; in your app subfolder. Every app has its own &quot;.hg&quot; folder and its own &quot;.hgignore&quot; file (tells Mercurial which files to ignore).</div><div class="delete">-</div><div class=""> The Mercurial web interface does allow you to browse previous commit and diff files but we do recommend you use Mercurial directly from the shell or one of the many GUI-based Mercurial clients since they are more powerful. For example they will allow you sync your app with a remote source repository:</div><div class=""> </div><div class="delete">-[[images @///image/en5300.png center 480px]]</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/95763bdcd5e83fb4b924ac8f71b00c67b2661dc7">95763bd</a><ul><li>Date : 2012-12-28</li><li>added some images</li></ul></li></ul>
<div class="row-fluid" id="com_95763bdcd5e83fb4b924ac8f71b00c67b2661dc7">
    <div class="span6"><div class="diff"><div class="insert">+[[image @///image/debugger.png center 480px]</div><div class="insert">+</div><div class=""> ##### Shell</div></div></div>
    <div class="span6"><div class="diff"><div class=""> ##### Shell</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/702b8daf9017e009b956b391dee62b2183fb7e02">702b8da</a><ul><li>Date : 2012-12-27</li><li>fixed @/ in pdf</li></ul></li></ul>
<div class="row-fluid" id="com_702b8daf9017e009b956b391dee62b2183fb7e02">
    <div class="span6"><div class="diff"><div class="insert">+``</div><div class="insert">+\@////contactus</div><div class="insert">+``:code</div><div class=""> </div><div class=""> Here ``\@////`` stands for</div><div class=""> </div><div class="insert">+``</div><div class="insert">+\@/app/controller/function/</div><div class="insert">+``:code</div><div class=""> </div><div class=""> but &quot;app&quot;, &quot;controller&quot;, and &quot;function&quot; are omitted thus assuming default.</div><div class=""> </div><div class=""> Similarly you can use the wiki menu to upload a media file (for example an image) linked to the page. The &quot;manage media&quot; page will show all files you have uploaded and will show the proper expression to link the media file. If, for example you upload a file &quot;test.jpg&quot; with title &quot;beach&quot;, the link expression will somthing like:</div><div class=""> </div><div class="insert">+``</div><div class="insert">+\@////15/beach.jpg</div><div class="insert">+``:code</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">-``\@////contactus``:code</div><div class=""> </div><div class=""> Here ``\@////`` stands for</div><div class=""> </div><div class="delete">-``\@/app/controller/function/``:code</div><div class=""> </div><div class=""> but &quot;app&quot;, &quot;controller&quot;, and &quot;function&quot; are omitted thus assuming default.</div><div class=""> </div><div class=""> Similarly you can use the wiki menu to upload a media file (for example an image) linked to the page. The &quot;manage media&quot; page will show all files you have uploaded and will show the proper expression to link the media file. If, for example you upload a file &quot;test.jpg&quot; with title &quot;beach&quot;, the link expression will somthing like:</div><div class=""> </div><div class="delete">-``\@////15/beach.jpg``:code</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/93539678ed5ee942c5bd09736516134b7abd95fd">9353967</a><ul><li>Date : 2012-09-01</li><li>new style references</li></ul></li></ul>
<div class="row-fluid" id="com_93539678ed5ee942c5bd09736516134b7abd95fd">
    <div class="span6"><div class="diff"><div class=""> db.define_table(&#x27;comment&#x27;,</div><div class="insert">   Field(&#x27;image_id&#x27;, <span class="highlight">&#x27;reference </span>image<span class="highlight">&#x27;</span>),</div><div class="">    Field(&#x27;author&#x27;),</div><div class="">    Field(&#x27;email&#x27;),</div><div class="">    Field(&#x27;body&#x27;, &#x27;text&#x27;))</div><div class=""> </div><div class=""> db.image.title.requires = IS_NOT_IN_DB(db, db.image.title)</div><div class=""> db.comment.image_id.requires = IS_IN_DB(db, db.image.id, &#x27;%(title)s&#x27;)</div><div class=""> db.comment.author.requires = IS_NOT_EMPTY()</div><div class=""> db.comment.email.requires = IS_EMAIL()</div><div class=""> db.comment.body.requires = IS_NOT_EMPTY()</div><div class=""> </div><div class=""> db.comment.image_id.writable = db.comment.image_id.readable = False</div><div class=""> ``:code</div><div class=""> </div><div class=""> Let&#x27;s analyze this line by line.</div><div class=""> </div><div class=""> Line 1 defines a global variable called ``db`` that represents the database connection. In this case it is a connection to a SQLite database stored in the file  &quot;applications/images/databases/storage.sqlite&quot;. In the SQLite case, if the database does not exist, it is created. You can change the name of the file, as well as the name of the global variable ``db``, but it is convenient to give them the same name, to make it easy to remember.</div><div class=""> </div><div class=""> Lines 3-5 define a table &quot;image&quot;. ``define_table`` is a method of the ``db`` object. The first argument, &quot;image&quot;, is the name of the table we are defining. The other arguments are the fields belonging to that table. This table has a field called &quot;title&quot;, a field called &quot;file&quot;, and a field called &quot;id&quot; that serves as the table primary key (&quot;id&quot; is not explicitly declared because all tables have an id field by default). The field &quot;title&quot; is a string, and the field &quot;file&quot; is of type &quot;upload&quot;. &quot;upload&quot; is a special type of field used by the web2py Data Abstraction Layer (DAL) to store the names of uploaded files. web2py knows how to upload files (via streaming if they are large), rename them safely, and store them.</div><div class=""> </div><div class=""> When a table is defined, web2py takes one of several possible actions:</div><div class=""> - if the table does not exist, the table is created;</div><div class=""> - if the table exists and does not correspond to the definition, the table is altered accordingly, and if a field has a different type, web2py tries to convert its contents;</div><div class=""> - if the table exists and corresponds to the definition, web2py does nothing.</div><div class=""> </div><div class=""> This behavior is called &quot;migration&quot;. In web2py migrations are automatic, but can be disabled for each table by passing ``migrate=False`` as the last argument of ``define_table``.</div><div class=""> </div><div class=""> Line 6 defines a format string for the table. It determines how a record should be represented as a string. Notice that the ``format`` argument can also be a function that takes a record and returns a string. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> format=lambda row: row.title</div><div class=""> response.meta.author = &#x27;you&#x27;</div><div class=""> response.meta.description = &#x27;describe your app&#x27;</div><div class=""> response.meta.keywords = &#x27;bla bla bla&#x27;</div><div class=""> response.menu = [ [ &#x27;Index&#x27;, False, URL(&#x27;index&#x27;) ] ]</div><div class=""> ``:code</div><div class=""> </div><div class=""> ### A wiki</div><div class=""> ``wiki``:inxx ``RSS``:inxx ``Ajax``:inxx ``XMLRPC``:inxx</div><div class=""> In this section, we build a wiki, from scratch and without using the extended functionality provided by plugin_wiki which is described in chapter 12. The visitor will be able to create pages, search them (by title), and edit them. The visitor will also be able to post comments (exactly as in the previous applications), and also post documents (as attachments to the pages) and link them from the pages. As a convention, we adopt the Markmin syntax for our wiki syntax. We will also implement a search page with Ajax, an RSS feed for the pages, and a handler to search the pages via XML-RPC``xmlrpc``:cite .</div><div class=""> </div><div class=""> The following diagram lists the actions that we need to implement and the links we intend to build among them.</div><div class=""> </div><div class=""> [[yUML diagram @///image/en3400.png center 250px]]</div><div class=""> </div><div class=""> Start by creating a new scaffolding app, naming it &quot;mywiki&quot;.</div><div class=""> </div><div class=""> The model must contain three tables: page, comment, and document. Both comment and document reference page because they belong to page. A document contains a file field of type upload as in the previous images application.</div><div class=""> </div><div class=""> Here is the complete model:</div><div class=""> ``</div><div class=""> db = DAL(&#x27;sqlite://storage.sqlite&#x27;)</div><div class=""> </div><div class=""> from gluon.tools import *</div><div class=""> auth = Auth(db)</div><div class=""> auth.define_tables()</div><div class=""> crud = Crud(db)</div><div class=""> </div><div class=""> db.define_table(&#x27;page&#x27;,</div><div class="">     Field(&#x27;title&#x27;),</div><div class="">     Field(&#x27;body&#x27;, &#x27;text&#x27;),</div><div class="">     Field(&#x27;created_on&#x27;, &#x27;datetime&#x27;, default=request.now),</div><div class="insert">    Field(&#x27;created_by&#x27;, <span class="highlight">&#x27;reference </span>auth_user<span class="highlight">&#x27;</span>, default=auth.user_id),</div><div class="">     format=&#x27;%(title)s&#x27;)</div><div class=""> </div><div class=""> db.define_table(&#x27;comment&#x27;,</div><div class="insert">    Field(&#x27;page_id&#x27;, <span class="highlight">&#x27;reference </span>page<span class="highlight">&#x27;</span>),</div><div class="">     Field(&#x27;body&#x27;, &#x27;text&#x27;),</div><div class="">     Field(&#x27;created_on&#x27;, &#x27;datetime&#x27;, default=request.now),</div><div class="insert">    Field(&#x27;created_by&#x27;, <span class="highlight">&#x27;reference </span>auth_user<span class="highlight">&#x27;</span>, default=auth.user_id))</div><div class=""> </div><div class=""> db.define_table(&#x27;document&#x27;,</div><div class="insert">    Field(&#x27;page_id&#x27;, <span class="highlight">&#x27;reference </span>page<span class="highlight">&#x27;</span>),</div><div class="">     Field(&#x27;name&#x27;),</div><div class="">     Field(&#x27;file&#x27;, &#x27;upload&#x27;),</div><div class="">     Field(&#x27;created_on&#x27;, &#x27;datetime&#x27;, default=request.now),</div><div class="insert">    Field(&#x27;created_by&#x27;, <span class="highlight">&#x27;reference </span>auth_user<span class="highlight">&#x27;</span>, default=auth.user_id),</div><div class="">     format=&#x27;%(name)s&#x27;)</div></div></div>
    <div class="span6"><div class="diff"><div class=""> db.define_table(&#x27;comment&#x27;,</div><div class="delete">   Field(&#x27;image_id&#x27;, <span class="highlight">db.</span>image<span class="highlight"></span>),</div><div class="">    Field(&#x27;author&#x27;),</div><div class="">    Field(&#x27;email&#x27;),</div><div class="">    Field(&#x27;body&#x27;, &#x27;text&#x27;))</div><div class=""> </div><div class=""> db.image.title.requires = IS_NOT_IN_DB(db, db.image.title)</div><div class=""> db.comment.image_id.requires = IS_IN_DB(db, db.image.id, &#x27;%(title)s&#x27;)</div><div class=""> db.comment.author.requires = IS_NOT_EMPTY()</div><div class=""> db.comment.email.requires = IS_EMAIL()</div><div class=""> db.comment.body.requires = IS_NOT_EMPTY()</div><div class=""> </div><div class=""> db.comment.image_id.writable = db.comment.image_id.readable = False</div><div class=""> ``:code</div><div class=""> </div><div class=""> Let&#x27;s analyze this line by line.</div><div class=""> </div><div class=""> Line 1 defines a global variable called ``db`` that represents the database connection. In this case it is a connection to a SQLite database stored in the file  &quot;applications/images/databases/storage.sqlite&quot;. In the SQLite case, if the database does not exist, it is created. You can change the name of the file, as well as the name of the global variable ``db``, but it is convenient to give them the same name, to make it easy to remember.</div><div class=""> </div><div class=""> Lines 3-5 define a table &quot;image&quot;. ``define_table`` is a method of the ``db`` object. The first argument, &quot;image&quot;, is the name of the table we are defining. The other arguments are the fields belonging to that table. This table has a field called &quot;title&quot;, a field called &quot;file&quot;, and a field called &quot;id&quot; that serves as the table primary key (&quot;id&quot; is not explicitly declared because all tables have an id field by default). The field &quot;title&quot; is a string, and the field &quot;file&quot; is of type &quot;upload&quot;. &quot;upload&quot; is a special type of field used by the web2py Data Abstraction Layer (DAL) to store the names of uploaded files. web2py knows how to upload files (via streaming if they are large), rename them safely, and store them.</div><div class=""> </div><div class=""> When a table is defined, web2py takes one of several possible actions:</div><div class=""> - if the table does not exist, the table is created;</div><div class=""> - if the table exists and does not correspond to the definition, the table is altered accordingly, and if a field has a different type, web2py tries to convert its contents;</div><div class=""> - if the table exists and corresponds to the definition, web2py does nothing.</div><div class=""> </div><div class=""> This behavior is called &quot;migration&quot;. In web2py migrations are automatic, but can be disabled for each table by passing ``migrate=False`` as the last argument of ``define_table``.</div><div class=""> </div><div class=""> Line 6 defines a format string for the table. It determines how a record should be represented as a string. Notice that the ``format`` argument can also be a function that takes a record and returns a string. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> format=lambda row: row.title</div><div class=""> response.meta.author = &#x27;you&#x27;</div><div class=""> response.meta.description = &#x27;describe your app&#x27;</div><div class=""> response.meta.keywords = &#x27;bla bla bla&#x27;</div><div class=""> response.menu = [ [ &#x27;Index&#x27;, False, URL(&#x27;index&#x27;) ] ]</div><div class=""> ``:code</div><div class=""> </div><div class=""> ### A wiki</div><div class=""> ``wiki``:inxx ``RSS``:inxx ``Ajax``:inxx ``XMLRPC``:inxx</div><div class=""> In this section, we build a wiki, from scratch and without using the extended functionality provided by plugin_wiki which is described in chapter 12. The visitor will be able to create pages, search them (by title), and edit them. The visitor will also be able to post comments (exactly as in the previous applications), and also post documents (as attachments to the pages) and link them from the pages. As a convention, we adopt the Markmin syntax for our wiki syntax. We will also implement a search page with Ajax, an RSS feed for the pages, and a handler to search the pages via XML-RPC``xmlrpc``:cite .</div><div class=""> </div><div class=""> The following diagram lists the actions that we need to implement and the links we intend to build among them.</div><div class=""> </div><div class=""> [[yUML diagram @///image/en3400.png center 250px]]</div><div class=""> </div><div class=""> Start by creating a new scaffolding app, naming it &quot;mywiki&quot;.</div><div class=""> </div><div class=""> The model must contain three tables: page, comment, and document. Both comment and document reference page because they belong to page. A document contains a file field of type upload as in the previous images application.</div><div class=""> </div><div class=""> Here is the complete model:</div><div class=""> ``</div><div class=""> db = DAL(&#x27;sqlite://storage.sqlite&#x27;)</div><div class=""> </div><div class=""> from gluon.tools import *</div><div class=""> auth = Auth(db)</div><div class=""> auth.define_tables()</div><div class=""> crud = Crud(db)</div><div class=""> </div><div class=""> db.define_table(&#x27;page&#x27;,</div><div class="">     Field(&#x27;title&#x27;),</div><div class="">     Field(&#x27;body&#x27;, &#x27;text&#x27;),</div><div class="">     Field(&#x27;created_on&#x27;, &#x27;datetime&#x27;, default=request.now),</div><div class="delete">    Field(&#x27;created_by&#x27;, <span class="highlight">db.</span>auth_user<span class="highlight"></span>, default=auth.user_id),</div><div class="">     format=&#x27;%(title)s&#x27;)</div><div class=""> </div><div class=""> db.define_table(&#x27;comment&#x27;,</div><div class="delete">    Field(&#x27;page_id&#x27;, <span class="highlight">db.</span>page<span class="highlight"></span>),</div><div class="">     Field(&#x27;body&#x27;, &#x27;text&#x27;),</div><div class="">     Field(&#x27;created_on&#x27;, &#x27;datetime&#x27;, default=request.now),</div><div class="delete">    Field(&#x27;created_by&#x27;, <span class="highlight">db.</span>auth_user<span class="highlight"></span>, default=auth.user_id))</div><div class=""> </div><div class=""> db.define_table(&#x27;document&#x27;,</div><div class="delete">    Field(&#x27;page_id&#x27;, <span class="highlight">db.</span>page<span class="highlight"></span>),</div><div class="">     Field(&#x27;name&#x27;),</div><div class="">     Field(&#x27;file&#x27;, &#x27;upload&#x27;),</div><div class="">     Field(&#x27;created_on&#x27;, &#x27;datetime&#x27;, default=request.now),</div><div class="delete">    Field(&#x27;created_by&#x27;, <span class="highlight">db.</span>auth_user<span class="highlight"></span>, default=auth.user_id),</div><div class="">     format=&#x27;%(name)s&#x27;)</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/097d699dc16179206ccb7e4aee863d6523cd471c">097d699</a><ul><li>Date : 2012-12-27</li><li>fixed typo, thanks Andrew</li></ul></li></ul>
<div class="row-fluid" id="com_097d699dc16179206ccb7e4aee863d6523cd471c">
    <div class="span6"><div class="diff"><div class="insert">+## Overview</div><div class="insert">+</div><div class="insert">+### Startup</div><div class="insert">+</div><div class="insert">+``Linux``:inxx ``Mac``:inxx ``Windows``:inxx</div><div class="insert">+</div><div class="insert">+web2py comes in binary packages for Windows and Mac OS X. They include the Python interpreter so you do not need to have it pre-installed. There is also a source code version that runs on Windows, Mac, Linux, and other Unix systems. The Windows and OS X binary versions include the necessary Python interpreter. The source code package assumes that Python is already installed on the computer.</div><div class="insert">+</div><div class="insert">+web2py requires no installation. To get started, unzip the downloaded zip file for your specific operating system and execute the corresponding ``web2py`` file.</div><div class="insert">+</div><div class="insert">+On Unix and Linux (source distribution), run:</div><div class="insert">+``</div><div class="insert">+python web2py.py</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+On OS X (binary distribution), run:</div><div class="insert">+``</div><div class="insert">+open web2py.app</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+On Windows (binary web2py distribution), run:</div><div class="insert">+``</div><div class="insert">+web2py.exe</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+On Windows (source web2py distribution), run:</div><div class="insert">+``</div><div class="insert">+c:/Python27/python.exe web2py.exe</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+------</div><div class="insert">+Attention, to run web2py on Windows from source you must install first Mark Hammond&#x27;s [[Python for Windows extensions http://sourceforge.net/projects/pywin32/]]</div><div class="insert">+------</div><div class="insert">+</div><div class="insert">+The web2py program accepts various command line options which are discussed later.</div><div class="insert">+</div><div class="insert">+By default, at startup, web2py displays a startup window and then displays a GUI widget that asks you to choose a one-time administrator password, the IP address of the network interface to be used for the web server, and a port number from which to serve requests. By default, web2py runs its web server on 127.0.0.1:8000 (port 8000 on localhost), but you can run it on any available IP address and port. You can query the IP address of your network interface by opening a command line and typing ``ipconfig`` on Windows or ``ifconfig`` on OS X and Linux. From now on we assume web2py is running on localhost (127.0.0.1:8000). Use 0.0.0.0:80 to run web2py publicly on any of your network interfaces.</div><div class="insert">+</div><div class="insert">+[[image @///image/en400.png center 306px]]</div><div class="insert">+</div><div class="insert">+If you do not provide an administrator password, the administration interface is disabled. This is a security measure to prevent publicly exposing the admin interface.</div><div class="insert">+</div><div class="insert">+The administrative interface, **admin**, is only accessible from localhost unless you run web2py behind Apache with mod_proxy. If **admin** detects a proxy, the session cookie is set to secure and **admin** login does not work unless the communication between the client and the proxy goes over HTTPS; this is a security measure. All communications between the client and **admin** must always be local or encrypted; otherwise an attacker would be able to perform a man-in-the middle attack or a replay attack and execute arbitrary code on the server.</div><div class="insert">+</div><div class="insert">+After the administration password has been set, web2py starts up the web browser at the page:</div><div class="insert">+``</div><div class="insert">+http://127.0.0.1:8000/</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+If the computer does not have a default browser, open a web browser and enter the URL.</div><div class="insert">+</div><div class="insert">+[[image @///image/en500.png center 480px]]</div><div class="insert">+</div><div class="insert">+Clicking on &quot;administrative interface&quot; takes you to the login page for the administration interface.</div><div class="insert">+</div><div class="insert">+[[image @///image/en600.png center 480px]]</div><div class="insert">+</div><div class="insert">+The administrator password is the password you chose at startup.</div><div class="insert">+Notice that there is only one administrator, and therefore only one administrator password. For security reasons, the developer is asked to choose a new password every time web2py starts unless the &lt;recycle&gt; option is specified. This is distinct from the authentication mechanism in web2py applications.</div><div class="insert">+</div><div class="insert">+After the administrator logs into web2py, the browser is redirected to the &quot;site&quot; page.</div><div class="insert">+</div><div class="insert">+[[image @///image/en700.png center 480px]]</div><div class="insert">+</div><div class="insert">+This page lists all installed web2py applications and allows the administrator to manage them.</div><div class="insert">+web2py comes with three applications:</div><div class="insert">+``admin``:inxx ``examples``:inxx ``welcome``:inxx ``scaffolding``:inxx</div><div class="insert">+- An **admin** application, the one you are using right now.</div><div class="insert">+- An **examples** application, with the online interactive documentation and a replica of the web2py official website.</div><div class="insert">+- A **welcome** application. This is the basic template for any other web2py application. It is referred to as the scaffolding application. This is also the application that welcomes a user at startup.</div><div class="insert">+</div><div class="insert">+``appliances``:inxx</div><div class="insert">+Ready-to-use web2py applications are referred to as web2py &#x27;&#x27;appliances&#x27;&#x27;.  You can download many freely available appliances from ``appliances``:cite . web2py users are encouraged to submit new appliances, either in open-source or closed-source (compiled and packed) form.</div><div class="insert">+</div><div class="insert">+From the **admin** application&#x27;s &#x27;&#x27;site&#x27;&#x27; page, you can perform the following operations:</div><div class="insert">+- **install** an application by completing the form on the bottom right of the page. Give a name to the application, select the file containing a packaged application or the URL where the application is located, and click &quot;submit&quot;.</div><div class="insert">+- **uninstall** an application by clicking the corresponding button. There is a confirmation page.</div><div class="insert">+- **create** a new application by choosing a name and clicking &quot;create&quot;.</div><div class="insert">+- **package** an application for distribution by clicking on the corresponding button. A downloaded application is a tar file containing everything, including the database. You should not untar this file; it is automatically unpackaged by web2py when installed with **admin**.</div><div class="insert">+- **clean up** an application&#x27;s temporary files, such as sessions, errors and cache files.</div><div class="insert">+- **EDIT** an application.</div><div class="insert">+</div><div class="insert">+-----</div><div class="insert">+When you create a new application using **admin**, it starts as a clone of the &quot;welcome&quot; scaffolding app with a &quot;models/db.py&quot; that creates a SQLite database, connects to it, instantiates Auth, Crud, and Service, configures them. It also provides a &quot;controller/default.py&quot; which exposes actions &quot;index&quot;, &quot;download&quot;, &quot;user&quot; for user management, and &quot;call&quot; for services. In the following, we assume that these files have been removed; we will be creating apps from scratch.</div><div class="insert">+-----</div><div class="insert">+</div><div class="insert">+web2py also comes with a **wizard**, described later in this chapter, that can write an alternate scaffolding code for you based on layouts and plugins available on the web and based on high level description of the models.</div><div class="insert">+</div><div class="insert">+### Simple examples</div><div class="insert">+</div><div class="insert">+#### Say hello</div><div class="insert">+``index``:inxx</div><div class="insert">+</div><div class="insert">+Here, as an example, we create a simple web app that displays the message &quot;Hello from MyApp&quot; to the user. We will call this application &quot;myapp&quot;. We will also add a counter that counts how many times the same user visits the page.</div><div class="insert">+</div><div class="insert">+You can create a new application simply by typing its name in the form on the top right of the **site** page in **admin**.</div><div class="insert">+</div><div class="insert">+[[image @///image/en800.png center 447px]]</div><div class="insert">+</div><div class="insert">+After you press [create], the application is created as a copy of the built-in welcome application.</div><div class="insert">+</div><div class="insert">+[[image @///image/en900.png center 480px]]</div><div class="insert">+</div><div class="insert">+To run the new application, visit:</div><div class="insert">+``</div><div class="insert">+http://127.0.0.1:8000/myapp</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Now you have a copy of the welcome application.</div><div class="insert">+</div><div class="insert">+To edit an application, click on the &#x27;&#x27;edit&#x27;&#x27; button for the newly created application.</div><div class="insert">+</div><div class="insert">+The **edit** page tells you what is inside the application.</div><div class="insert">+Every web2py application consists of certain files, most of which fall into one of six categories:</div><div class="insert">+- **models**: describe the data representation.</div><div class="insert">+- **controllers**: describe the application logic and workflow.</div><div class="insert">+- **views**: describe the data presentation.</div><div class="insert">+- **languages**: describe how to translate the application presentation to other languages.</div><div class="insert">+- **modules**: Python modules that belong to the application.</div><div class="insert">+- **static files**: static images, CSS  files``css-w,css-o,css-school``:cite , JavaScript files``js-w,js-b``:cite , etc.</div><div class="insert">+- **plugins**: groups of files designed to work together.</div><div class="insert">+</div><div class="insert">+Everything is neatly organized following the Model-View-Controller design pattern. Each section in the &#x27;&#x27;edit&#x27;&#x27; page corresponds to a subfolder in the application folder.</div><div class="insert">+</div><div class="insert">+Notice that section headings will toggle their content. Folder names under static files are also collapsible.</div><div class="insert">+</div><div class="insert">+-------</div><div class="insert">+Each file listed in the section corresponds to a file physically located in the subfolder. Any operation performed on a file via the **admin** interface (create, edit, delete) can be performed directly from the shell using your favorite editor.</div><div class="insert">+-------</div><div class="insert">+</div><div class="insert">+The application contains other types of files (database, session files, error files, etc.), but they are not listed on the &#x27;&#x27;edit&#x27;&#x27; page because they are not created or modified by the administrator; they are created and modified by the application itself.</div><div class="insert">+</div><div class="insert">+The controllers contain the logic and workflow of the application. Every URL gets mapped into a call to one of the functions in the controllers (actions). There are two default controllers: &quot;appadmin.py&quot; and &quot;default.py&quot;. **appadmin** provides the database administrative interface; we do not need it now. &quot;default.py&quot; is the controller that you need to edit, the one that is called by default when no controller is specified in the URL. Edit the &quot;index&quot; function as follows:</div><div class="insert">+``</div><div class="insert">+def index():</div><div class="insert">+    return &quot;Hello from MyApp&quot;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Here is what the online editor looks like:</div><div class="insert">+</div><div class="insert">+[[image @///image/en1000.png center 480px]]</div><div class="insert">+</div><div class="insert">+Save it and go back to the &#x27;&#x27;edit&#x27;&#x27; page. Click on the index link to visit the newly created page.</div><div class="insert">+</div><div class="insert">+When you visit the URL</div><div class="insert">+``</div><div class="insert">+http://127.0.0.1:8000/myapp/default/index</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+the index action in the default controller of the myapp application is called. It returns a string that the browser displays for us. It should look like this:</div><div class="insert">+</div><div class="insert">+[[image @///image/en1100.png center 480px]]</div><div class="insert">+</div><div class="insert">+Now, edit the &quot;index&quot; function as follows:</div><div class="insert">+``</div><div class="insert">+def index():</div><div class="insert">+    return dict(message=&quot;Hello from MyApp&quot;)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Also from the &#x27;&#x27;edit&#x27;&#x27; page, edit the view &quot;default/index.html&quot; (the view file associated with the action) and completely replace the existing contents of that file with the following:</div><div class="insert">+``</div><div class="insert">+&lt;html&gt;</div><div class="insert">+   &lt;head&gt;&lt;/head&gt;</div><div class="insert">+   &lt;body&gt;</div><div class="insert">+      &lt;h1&gt;{{=message}}&lt;/h1&gt;</div><div class="insert">+   &lt;/body&gt;</div><div class="insert">+&lt;/html&gt;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Now the action returns a dictionary defining a ``message``. When an action returns a dictionary, web2py looks for a view with the name</div><div class="insert">+</div><div class="insert">+``[controller]/[function].[extension]``:code</div><div class="insert">+</div><div class="insert">+ and executes it. Here [extension] is the requested extension. If no extension is specified, it defaults to &quot;html&quot;, and that is what we will assume here. Under this assumption, the view is an HTML file that embeds Python code using special {{ }} tags. In particular, in the example, the ``{{=message}}`` instructs web2py to replace the tagged code with the value of the ``message`` returned by the action. Notice that ``message`` here is not a web2py keyword but is defined in the action. So far we have not used any web2py keywords.</div><div class="insert">+</div><div class="insert">+If web2py does not find the requested view, it uses the &quot;generic.html&quot; view that comes with every application.</div><div class="insert">+</div><div class="insert">+-------</div><div class="insert">+``Mac Mail``:inxx ``Google Maps``:inxx ``jsonp``:inxx</div><div class="insert">+If an extension other than &quot;html&quot; is specified (&quot;json&quot; for example), and the view file &quot;[controller]/[function].json&quot; is not found, web2py looks for the view &quot;generic.json&quot;. web2py comes with generic.html, generic.json, generic.jsonp, generic.xml, generic.rss, generic.ics (for Mac Mail Calendar), generic.map (for embedding Google Maps), and generic.pdf (based on fpdf). These generic views can be modified for each application individually, and additional views can be added easily.</div><div class="insert">+-------</div><div class="insert">+</div><div class="insert">+-------</div><div class="insert">+Generic views are a development tool. In production every action should have its own view. In fact, by default, generic views are only enabled from localhost.</div><div class="insert">+-------</div><div class="insert">+</div><div class="insert">+-------</div><div class="insert">+You can also specify a view with ``response.view = &#x27;default/something.html&#x27;``</div><div class="insert">+-------</div><div class="insert">+</div><div class="insert">+Read more on this topic in Chapter 10.</div><div class="insert">+</div><div class="insert">+If you go back to &quot;EDIT&quot; and click on index, you will now see the following HTML page:</div><div class="insert">+</div><div class="insert">+[[image @///image/en1200.png center 480px]]</div><div class="insert">+</div><div class="insert">+For debugging purposes you can always append</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+{{=response.toolbar()}}</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+to the code in a view and it will show you some useful information, including the request, response and session objects, and list all db queries with their timing.</div><div class="insert">+</div><div class="insert">+#### Let&#x27;s count</div><div class="insert">+``session``:inxx</div><div class="insert">+Let&#x27;s now add a counter to this page that will count how many times the same visitor displays the page.</div><div class="insert">+</div><div class="insert">+web2py automatically and transparently tracks visitors using sessions and cookies. For each new visitor, it creates a session and assigns a unique &quot;session_id&quot;. The session is a container for variables that are stored server-side. The unique id is sent to the browser via a cookie. When the visitor requests another page from the same application, the browser sends the cookie back, it is retrieved by web2py, and the corresponding session is restored.</div><div class="insert">+</div><div class="insert">+To use the session, modify the default controller:</div><div class="insert">+``</div><div class="insert">+def index():</div><div class="insert">+    if not session.counter:</div><div class="insert">+        session.counter = 1</div><div class="insert">+    else:</div><div class="insert">+        session.counter += 1</div><div class="insert">+    return dict(message=&quot;Hello from MyApp&quot;, counter=session.counter)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Notice that ``counter`` is not a web2py keyword but ``session`` is. We are asking web2py to check whether there is a counter variable in the session and, if not, to create one and set it to 1. If the counter is there, we ask web2py to increase the counter by 1. Finally we pass the value of the counter to the view.</div><div class="insert">+</div><div class="insert">+A more compact way to code the same function is this:</div><div class="insert">+``</div><div class="insert">+def index():</div><div class="insert">+    session.counter = (session.counter or 0) + 1</div><div class="insert">+    return dict(message=&quot;Hello from MyApp&quot;, counter=session.counter)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Now modify the view to add a line that displays the value of the counter:</div><div class="insert">+``</div><div class="insert">+&lt;html&gt;</div><div class="insert">+   &lt;head&gt;&lt;/head&gt;</div><div class="insert">+   &lt;body&gt;</div><div class="insert">+      &lt;h1&gt;{{=message}}&lt;/h1&gt;</div><div class="insert">+      &lt;h2&gt;Number of visits: {{=counter}}&lt;/h2&gt;</div><div class="insert">+   &lt;/body&gt;</div><div class="insert">+&lt;/html&gt;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+When you visit the index page again (and again) you should get the following HTML page:</div><div class="insert">+</div><div class="insert">+[[image @///image/en1300.png center 480px]]</div><div class="insert">+</div><div class="insert">+The counter is associated with each visitor, and is incremented each time the visitor reloads the page. Different visitors see different counters.</div><div class="insert">+</div><div class="insert">+</div><div class="insert">+#### Say my name</div><div class="insert">+``form``:inxx ``request.vars``:inxx</div><div class="insert">+</div><div class="insert">+Now create two pages (first and second), where the first page creates a form, asks the visitor&#x27;s name, and redirects to the second page, which greets the visitor by name.</div><div class="insert">+</div><div class="insert">+[[yUML diagram @///image/en1400.png center 200px]]</div><div class="insert">+</div><div class="insert">+Write the corresponding actions in the default controller:</div><div class="insert">+``</div><div class="insert">+def first():</div><div class="insert">+    return dict()</div><div class="insert">+</div><div class="insert">+def second():</div><div class="insert">+    return dict()</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Then create a view &quot;default/first.html&quot; for the first action,</div><div class="insert">+and enter:</div><div class="insert">+``</div><div class="insert">+{{extend &#x27;layout.html&#x27;}}</div><div class="insert">+&lt;h1&gt;What is your name?&lt;/h1&gt;</div><div class="insert">+&lt;form action=&quot;second&quot;&gt;</div><div class="insert">+  &lt;input name=&quot;visitor_name&quot; /&gt;</div><div class="insert">+  &lt;input type=&quot;submit&quot; /&gt;</div><div class="insert">+&lt;/form&gt;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Finally, create a view &quot;default/second.html&quot; for the second action:</div><div class="insert">+``</div><div class="insert">+{{extend &#x27;layout.html&#x27;}}</div><div class="insert">+&lt;h1&gt;Hello {{=request.vars.visitor_name}}&lt;/h1&gt;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+``layout``:inxx</div><div class="insert">+In both views we have extended the basic &quot;layout.html&quot; view that comes with web2py. The layout view keeps the look and feel of the two pages coherent. The layout file can be edited and replaced easily, since it mainly contains HTML code.</div><div class="insert">+</div><div class="insert">+If you now visit the first page, type your name:</div><div class="insert">+</div><div class="insert">+[[image @///image/en1500.png center 480px]]</div><div class="insert">+</div><div class="insert">+and submit the form, you will receive a greeting:</div><div class="insert">+</div><div class="insert">+[[image @///image/en1600.png center 480px]]</div><div class="insert">+</div><div class="insert">+#### Postbacks</div><div class="insert">+``redirect``:inxx ``URL``:inxx ``postback``:inxx</div><div class="insert">+</div><div class="insert">+The mechanism for form submission that we used before is very common, but it is not good programming practice. All input should be validated and, in the above example, the burden of validation would fall on the second action. Thus the action that performs the validation is different from the action that generated the form. This tends to cause redundancy in the code.</div><div class="insert">+</div><div class="insert">+A better pattern for form submission is to submit forms to the same action that generated them, in our example the &quot;first&quot;. The &quot;first&quot; action should receive the variables, process them, store them server-side, and redirect the visitor to the &quot;second&quot; page, which retrieves the variables. This mechanism is called a &#x27;&#x27;postback&#x27;&#x27;.</div><div class="insert">+</div><div class="insert">+[[yUML diagram @///image/en1700.png center 200px]]</div><div class="insert">+</div><div class="insert">+Modify the default controller to implement self-submission:</div><div class="insert">+``</div><div class="insert">+def first():</div><div class="insert">+    if request.vars.visitor_name:</div><div class="insert">+        session.visitor_name = request.vars.visitor_name</div><div class="insert">+        redirect(URL(&#x27;second&#x27;))</div><div class="insert">+    return dict()</div><div class="insert">+</div><div class="insert">+def second():</div><div class="insert">+    return dict()</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Then modify the &quot;default/first.html&quot; view:</div><div class="insert">+``</div><div class="insert">+{{extend &#x27;layout.html&#x27;}}</div><div class="insert">+What is your name?</div><div class="insert">+&lt;form&gt;</div><div class="insert">+  &lt;input name=&quot;visitor_name&quot; /&gt;</div><div class="insert">+  &lt;input type=&quot;submit&quot; /&gt;</div><div class="insert">+&lt;/form&gt;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+and the &quot;default/second.html&quot; view needs to retrieve the data from the ``session`` instead of from the ``request.vars``:</div><div class="insert">+``</div><div class="insert">+{{extend &#x27;layout.html&#x27;}}</div><div class="insert">+&lt;h1&gt;Hello {{=session.visitor_name or &quot;anonymous&quot;}}&lt;/h1&gt;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+From the point of view of the visitor, the self-submission behaves exactly the same as the previous implementation. We have not added validation yet, but it is now clear that validation should be performed by the first action.</div><div class="insert">+</div><div class="insert">+This approach is better also because the name of the visitor stays in the session, and can be accessed by all actions and views in the applications without having to be passed around explicitly.</div><div class="insert">+</div><div class="insert">+Note that if the &quot;second&quot; action is ever called before a visitor name is set, it will display &quot;Hello anonymous&quot; because  ``session.visitor_name`` returns ``None``. Alternatively we could have added the following code in the controller (inside the ``second`` function):</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+if not request.function==&#x27;first&#x27; and not session.visitor_name:</div><div class="insert">+    redirect(URL(&#x27;first&#x27;))</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+This is a general mechanism that you can use to enforce authorization on controllers, though see Chapter 9 for a more powerful method.</div><div class="insert">+</div><div class="insert">+``FORM``:inxx ``INPUT``:inxx ``requires``:inxx ``IS_NOT_EMPTY``:inxx ``accepts``:inxx</div><div class="insert">+</div><div class="insert">+With web2py we can move one step further and ask web2py to generate the form for us, including validation. web2py provides helpers (FORM, INPUT, TEXTAREA, and SELECT/OPTION) with the same names as the equivalent HTML tags. They can be used to build forms either in the controller or in the view.</div><div class="insert">+</div><div class="insert">+For example, here is one possible way to rewrite the first action:</div><div class="insert">+``</div><div class="insert">+def first():</div><div class="insert">+    form = FORM(INPUT(_name=&#x27;visitor_name&#x27;, requires=IS_NOT_EMPTY()),</div><div class="insert">+              INPUT(_type=&#x27;submit&#x27;))</div><div class="insert">+    if form.process().accepted:</div><div class="insert">+        session.visitor_name = form.vars.visitor_name</div><div class="insert">+        redirect(URL(&#x27;second&#x27;))</div><div class="insert">+    return dict(form=form)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+where we are saying that the FORM tag contains two INPUT tags. The attributes of the input tags are specified by the named arguments starting with underscore. The ``requires`` argument is not a tag attribute (because it does not start by underscore) but it sets a validator for the value of visitor_name.</div><div class="insert">+</div><div class="insert">+Here is yet another better way to create the same form:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+def first():</div><div class="insert">+    form = SQLFORM.factory(Field(&#x27;visitor_name&#x27;,</div><div class="insert">+                                 label=&#x27;what is yout name?&#x27;,</div><div class="insert">+                                 requires=IS_NOT_EMPTY()))</div><div class="insert">+    if form.process().accepted:</div><div class="insert">+        session.visitor_name = form.vars.visitor_name</div><div class="insert">+        redirect(URL(&#x27;second&#x27;))</div><div class="insert">+    return dict(form=form)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+The ``form`` object can be easily serialized in HTML by embedding it in the &quot;default/first.html&quot; view.</div><div class="insert">+``</div><div class="insert">+{{extend &#x27;layout.html&#x27;}}</div><div class="insert">+{{=form}}</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+The ``form.process()`` method applies the validators and returns the form itself. The ``form.accepted`` variable is set to True if the form was processed and passed validation. If the self-submitted form passes validation, it stores the variables in the session and redirects as before. If the form does not pass validation, error messages are inserted into the form and shown to the user, as below:</div><div class="insert">+</div><div class="insert">+[[image @///image/en1800.png center 480px]]</div><div class="insert">+</div><div class="insert">+In the next section we will show how forms can be generated automatically from a model.</div><div class="insert">+</div><div class="insert">+In all or examples we have used the session to pass the user name from the first action to the second. We could have used a different mechanism and pass data as part of a redirect URL:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+def first():</div><div class="insert">+    form = SQLFORM.factory(Field(&#x27;visitor_name&#x27;, requires=IS_NOT_EMPTY()))</div><div class="insert">+    if form.process().accepted:</div><div class="insert">+        name = form.vars.visitor_name</div><div class="insert">+        redirect(URL(&#x27;second&#x27;,vars=dict(name=name)))</div><div class="insert">+    return dict(form=form)</div><div class="insert">+</div><div class="insert">+def second():</div><div class="insert">+    name = request.vars.visitor_name or redirect(URL(&#x27;first&#x27;))</div><div class="insert">+    return dict(name=name)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+#### Internationalization</div><div class="insert">+</div><div class="insert">+You code is likely to include hardcoded strings such as &quot;What is your name?&quot;. You should be able to customize strings without editing the code and in particular insert translations for these strings in different languages. In this wasy if a visitor has the language preference of the browser set to &quot;Italian&quot;, web2py will use the Italian translation for the strings, if available. This feature of web2py is called &quot;internationalization&quot; and it is described in more detail in the next chapter.</div><div class="insert">+</div><div class="insert">+Here we just observe that in order to use this feature you should markup strings that need stranslation. This is done by wrapping a a quoted string in code such as</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+&quot;What is your name?&quot;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+with the ``T`` operator:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+T(&quot;What is your name?&quot;)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+</div><div class="insert">+You can also mark fo translations strings hardcoded in views. For example</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+&lt;h1&gt;What is your name?&lt;/h1&gt;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+becomes</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+&lt;h1&gt;{{=T(&quot;What is your name?&quot;)}}&lt;/h1&gt;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+It is good practice to do this for every string in the code (field labels, flash messages, etc.) except for tables and field names.</div><div class="insert">+</div><div class="insert">+Once the strings are indentified and marked up, web2py takes care of almost evrything else. The admin interface also provides a page where you can translate each string in the languages you desire to support.</div><div class="insert">+</div><div class="insert">+### An image blog</div><div class="insert">+``upload``:inxx</div><div class="insert">+</div><div class="insert">+Here, as another example, we wish to create a web application that allows the administrator to post images and give them a name, and allows the visitors of the web site to view the named images and submit comments.</div><div class="insert">+</div><div class="insert">+As before, from the **site** page in **admin**, create a new application called ``images``, and navigate to the &#x27;&#x27;edit&#x27;&#x27; page:</div><div class="insert">+</div><div class="insert">+[[image @///image/en1900.png center 480px]]</div><div class="insert">+</div><div class="insert">+We start by creating a model, a representation of the persistent data in the application (the images to upload, their names, and the comments). First, you need to create/edit a model file which, for lack of imagination, we call &quot;db.py&quot;. We assume the code below will replace any existing code in &quot;db.py&quot;. Models and controllers must have a ``.py`` extension since they are Python code. If the extension is not provided, it is appended by web2py. Views instead have a ``.html`` extension since they mainly contain HTML code.</div><div class="insert">+</div><div class="insert">+Edit the &quot;db.py&quot; file by clicking the corresponding &quot;edit&quot; button:</div><div class="insert">+</div><div class="insert">+[[image @///image/en2000.png center 480px]]</div><div class="insert">+</div><div class="insert">+and enter the following:</div><div class="insert">+</div><div class="insert">+``IS_EMAIL``:inxx ``IS_NOT_EMPTY``:inxx ``IS_IN_DB``:inxx</div><div class="insert">+``</div><div class="insert">+db = DAL(&quot;sqlite://storage.sqlite&quot;)</div><div class="insert">+</div><div class="insert">+db.define_table(&#x27;image&#x27;,</div><div class="insert">+   Field(&#x27;title&#x27;, unique=True),</div><div class="insert">+   Field(&#x27;file&#x27;, &#x27;upload&#x27;),</div><div class="insert">+   format = &#x27;%(title)s&#x27;)</div><div class="insert">+</div><div class="insert">+db.define_table(&#x27;comment&#x27;,</div><div class="insert">+   Field(&#x27;image_id&#x27;, &#x27;reference image&#x27;),</div><div class="insert">+   Field(&#x27;author&#x27;),</div><div class="insert">+   Field(&#x27;email&#x27;),</div><div class="insert">+   Field(&#x27;body&#x27;, &#x27;text&#x27;))</div><div class="insert">+</div><div class="insert">+db.image.title.requires = IS_NOT_IN_DB(db, db.image.title)</div><div class="insert">+db.comment.image_id.requires = IS_IN_DB(db, db.image.id, &#x27;%(title)s&#x27;)</div><div class="insert">+db.comment.author.requires = IS_NOT_EMPTY()</div><div class="insert">+db.comment.email.requires = IS_EMAIL()</div><div class="insert">+db.comment.body.requires = IS_NOT_EMPTY()</div><div class="insert">+</div><div class="insert">+db.comment.image_id.writable = db.comment.image_id.readable = False</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Let&#x27;s analyze this line by line.</div><div class="insert">+</div><div class="insert">+Line 1 defines a global variable called ``db`` that represents the database connection. In this case it is a connection to a SQLite database stored in the file  &quot;applications/images/databases/storage.sqlite&quot;. In the SQLite case, if the database does not exist, it is created. You can change the name of the file, as well as the name of the global variable ``db``, but it is convenient to give them the same name, to make it easy to remember.</div><div class="insert">+</div><div class="insert">+Lines 3-5 define a table &quot;image&quot;. ``define_table`` is a method of the ``db`` object. The first argument, &quot;image&quot;, is the name of the table we are defining. The other arguments are the fields belonging to that table. This table has a field called &quot;title&quot;, a field called &quot;file&quot;, and a field called &quot;id&quot; that serves as the table primary key (&quot;id&quot; is not explicitly declared because all tables have an id field by default). The field &quot;title&quot; is a string, and the field &quot;file&quot; is of type &quot;upload&quot;. &quot;upload&quot; is a special type of field used by the web2py Data Abstraction Layer (DAL) to store the names of uploaded files. web2py knows how to upload files (via streaming if they are large), rename them safely, and store them.</div><div class="insert">+</div><div class="insert">+When a table is defined, web2py takes one of several possible actions:</div><div class="insert">+- if the table does not exist, the table is created;</div><div class="insert">+- if the table exists and does not correspond to the definition, the table is altered accordingly, and if a field has a different type, web2py tries to convert its contents;</div><div class="insert">+- if the table exists and corresponds to the definition, web2py does nothing.</div><div class="insert">+</div><div class="insert">+This behavior is called &quot;migration&quot;. In web2py migrations are automatic, but can be disabled for each table by passing ``migrate=False`` as the last argument of ``define_table``.</div><div class="insert">+</div><div class="insert">+Line 6 defines a format string for the table. It determines how a record should be represented as a string. Notice that the ``format`` argument can also be a function that takes a record and returns a string. For example:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+format=lambda row: row.title</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Lines 8-12 define another table called &quot;comment&quot;.</div><div class="insert">+A comment has an &quot;author&quot;, an &quot;email&quot; (we intend to store the email address of the author of the comment), a &quot;body&quot; of type &quot;text&quot; (we intend to use it to store the actual comment posted by the author), and an &quot;image_id&quot; field of type reference that points to ``db.image`` via the &quot;id&quot; field.</div><div class="insert">+</div><div class="insert">+In line 14, ``db.image.title`` represents the field &quot;title&quot; of table &quot;image&quot;. The attribute ``requires`` allows you to set requirements/constraints that will be enforced by web2py forms. Here we require that the &quot;title&quot; is unique:</div><div class="insert">+</div><div class="insert">+``IS_NOT_IN_DB(db, db.image.title)``:code</div><div class="insert">+</div><div class="insert">+&#x27;&#x27;Notice this is optional because it is set automatically given that ``Field(&#x27;title&#x27;, unique=True)``&#x27;&#x27;.</div><div class="insert">+</div><div class="insert">+The objects representing these constraints are called validators. Multiple validators can be grouped in a list. Validators are executed in the order they appear.</div><div class="insert">+``IS_NOT_IN_DB(a, b)`` is a special validator that checks that the value of a field ``b`` for a new record is not already in ``a``.</div><div class="insert">+</div><div class="insert">+Line 15 requires that the field &quot;image_id&quot; of table &quot;comment&quot; is in ``db.image.id``. As far as the database is concerned, we had already declared this  when we defined the table &quot;comment&quot;.</div><div class="insert">+Now we are explicitly telling the model that this condition should be enforced by web2py, too, at the form processing level when a new comment is posted, so that invalid values do not propagate from input forms to the database. We also require that the &quot;image_id&quot; be represented by the &quot;title&quot;, ``&#x27;%(title)s&#x27;``, of the corresponding record.</div><div class="insert">+</div><div class="insert">+Line 20 indicates that the field &quot;image_id&quot; of table &quot;comment&quot; should not be shown in forms, ``writable=False`` and not even in readonly forms, ``readable=False``.</div><div class="insert">+</div><div class="insert">+The meaning of the validators in lines 15-17 should be obvious.</div><div class="insert">+</div><div class="insert">+``format``:inxx</div><div class="insert">+Notice that the validator</div><div class="insert">+``</div><div class="insert">+db.comment.image_id.requires = IS_IN_DB(db, db.image.id, &#x27;%(title)s&#x27;)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+can be omitted (and would be automatic) if we specify a format for referenced table:</div><div class="insert">+``</div><div class="insert">+db.define_table(&#x27;image&#x27;, ..., format=&#x27;%(title)s&#x27;)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+where the format can be a string or a function that takes a record and returns a string.</div><div class="insert">+</div><div class="insert">+``appadmin``:inxx</div><div class="insert">+Once a model is defined, if there are no errors, web2py creates an application administration interface to manage the database. You access it via the &quot;database administration&quot; link in the &#x27;&#x27;edit&#x27;&#x27; page or directly:</div><div class="insert">+``</div><div class="insert">+http://127.0.0.1:8000/images/appadmin</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Here is a screenshot of the **appadmin** interface:</div><div class="insert">+</div><div class="insert">+[[image @///image/en2100.png center 480px]]</div><div class="insert">+</div><div class="insert">+This interface is coded in the controller called &quot;appadmin.py&quot; and the corresponding view &quot;appadmin.html&quot;. From now on, we will refer to this interface simply as **appadmin**. It allows the administrator to insert new database records, edit and delete existing records, browse tables, and perform database joins.</div><div class="insert">+</div><div class="insert">+The first time **appadmin** is accessed, the model is executed and the tables are created. The web2py DAL translates Python code into SQL statements that are specific to the selected database back-end (SQLite in this example). You can see the generated SQL from the &#x27;&#x27;edit&#x27;&#x27; page by clicking on the &quot;sql.log&quot; link under &quot;models&quot;. Notice that the link is not present until the tables have been created.</div><div class="insert">+</div><div class="insert">+[[image @///image/en2200.png center 480px]]</div><div class="insert">+</div><div class="insert">+If you were to edit the model and access **appadmin** again, web2py would generate SQL to alter the existing tables. The generated SQL is logged into &quot;sql.log&quot;.</div><div class="insert">+</div><div class="insert">+Now go back to **appadmin** and try to insert a new image record:</div><div class="insert">+</div><div class="insert">+[[image @///image/en2300.png center 480px]]</div><div class="insert">+</div><div class="insert">+web2py has translated the ``db.image.file`` &quot;upload&quot; field into an upload form for the file. When the form is submitted and an image file is uploaded, the file is renamed in a secure way that preserves the extension, it is saved with the new name under the application &quot;uploads&quot; folder, and the new name is stored in the ``db.image.file`` field. This process is designed to prevent directory traversal attacks.</div><div class="insert">+</div><div class="insert">+Notice that each field type is rendered by a &#x27;&#x27;widget&#x27;&#x27;. Default widgets can be overridden.</div><div class="insert">+</div><div class="insert">+When you click on a table name in **appadmin**, web2py performs a select of all records on the current table, identified by the DAL query</div><div class="insert">+``</div><div class="insert">+db.image.id &gt; 0</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+and renders the result.</div><div class="insert">+</div><div class="insert">+[[image @///image/en2400.png center 480px]]</div><div class="insert">+</div><div class="insert">+You can select a different set of records by editing the SQL query and pressing [Submit].</div><div class="insert">+</div><div class="insert">+To edit or delete a single record, click on the record id number.</div><div class="insert">+</div><div class="insert">+Because of the ``IS_IN_DB`` validator, the reference field &quot;image_id&quot; is rendered by a drop-down menu. The items in the drop-down are stored as keys (``db.image.id``), but are represented by their ``db.image.title``, as specified by the validator.</div><div class="insert">+</div><div class="insert">+Validators are powerful objects that know how to represent fields, filter field values, generate errors, and format values extracted from the field.</div><div class="insert">+</div><div class="insert">+The following figure shows what happens when you submit a form that does not pass validation:</div><div class="insert">+</div><div class="insert">+[[image @///image/en2500.png center 480px]]</div><div class="insert">+</div><div class="insert">+The same forms that are automatically generated by **appadmin** can also be generated programmatically via the ``SQLFORM`` helper and embedded in user applications. These forms are CSS-friendly, and can be customized.</div><div class="insert">+</div><div class="insert">+Every application has its own **appadmin**; therefore, **appadmin** itself can be modified without affecting other applications.</div><div class="insert">+</div><div class="insert">+So far, the application knows how to store data, and we have seen how to access the database via **appadmin**. Access to **appadmin** is restricted to the administrator, and it is not intended as a production web interface for the application; hence the next part of this walk-through. Specifically we want to create:</div><div class="insert">+- An &quot;index&quot; page that lists all available images sorted by title and links to detail pages for the images.</div><div class="insert">+- A &quot;show/[id]&quot; page that shows the visitor the requested image and allows the visitor to view and post comments.</div><div class="insert">+- A &quot;download/[name]&quot; action to download uploaded images.</div><div class="insert">+</div><div class="insert">+This is represented schematically here:</div><div class="insert">+</div><div class="insert">+[[yUML diagram @///image/en2600.png center 480px]]</div><div class="insert">+</div><div class="insert">+Go back to the &#x27;&#x27;edit&#x27;&#x27; page and edit the &quot;default.py&quot; controller, replacing its contents with the following:</div><div class="insert">+</div><div class="insert">+``select``:inxx</div><div class="insert">+``</div><div class="insert">+def index():</div><div class="insert">+    images = db().select(db.image.ALL, orderby=db.image.title)</div><div class="insert">+    return dict(images=images)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+This action returns a dictionary. The keys of the items in the dictionary are interpreted as variables passed to the view associated to the action. When developing, if there is no view, the action is rendered by the &quot;generic.html&quot; view that is provided with every web2py application.</div><div class="insert">+</div><div class="insert">+The index action performs a select of all fields (``db.image.ALL``) from table image, ordered by ``db.image.title``. The result of the select is a ``Rows`` object containing the records. Assign it to a local variable called ``images`` returned by the action to the view. ``images`` is iterable and its elements are the selected rows. For each row the columns can be accessed as dictionaries:</div><div class="insert">+``images[0][&#x27;title&#x27;]`` or equivalently as ``images[0].title``.</div><div class="insert">+</div><div class="insert">+If you do not write a view, the dictionary is rendered by &quot;views/generic.html&quot; and a call to the index action would look like this:</div><div class="insert">+</div><div class="insert">+[[image @///image/en2700.png center 480px]]</div><div class="insert">+</div><div class="insert">+You have not created a view for this action yet, so web2py renders the set of records in plain tabular form.</div><div class="insert">+</div><div class="insert">+Proceed to create a view for the index action. Return to admin, edit &quot;default/index.html&quot; and replace its content with the following:</div><div class="insert">+``</div><div class="insert">+{{extend &#x27;layout.html&#x27;}}</div><div class="insert">+&lt;h1&gt;Current Images&lt;/h1&gt;</div><div class="insert">+&lt;ul&gt;</div><div class="insert">+{{for image in images:}}</div><div class="insert">+{{=LI(A(image.title, _href=URL(&quot;show&quot;, args=image.id)))}}</div><div class="insert">+{{pass}}</div><div class="insert">+&lt;/ul&gt;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+The first thing to notice is that a view is pure HTML with special {{...}} tags. The code embedded in {{...}} is pure Python code with one caveat: indentation is irrelevant. Blocks of code start with lines ending in colon (:) and end in lines beginning with the keyword ``pass``. In some cases the end of a block is obvious from context and the use of ``pass`` is not required.</div><div class="insert">+</div><div class="insert">+Lines 5-7 loop over the image rows and for each row image display:</div><div class="insert">+``</div><div class="insert">+LI(A(image.title, _href=URL(&#x27;show&#x27;, args=image.id))</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+This is a ``&lt;li&gt;...&lt;/li&gt;`` tag that contains an ``&lt;a href=&quot;...&quot;&gt;...&lt;/a&gt;`` tag which contains the ``image.title``. The value of the hypertext reference (href attribute) is:</div><div class="insert">+``</div><div class="insert">+URL(&#x27;show&#x27;, args=image.id)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+i.e., the URL within the same application and controller as the current request that calls the function called &quot;show&quot;, passing a single argument to the function, ``args=image.id``.</div><div class="insert">+``LI``, ``A``, etc. are web2py helpers that map to the corresponding HTML tags. Their unnamed arguments are interpreted as objects to be serialized and inserted in the tag&#x27;s innerHTML. Named arguments starting with an underscore (for example ``_href``) are interpreted as tag attributes but without the underscore. For example ``_href`` is the ``href`` attribute, ``_class`` is the ``class`` attribute, etc.</div><div class="insert">+</div><div class="insert">+As an example, the following statement:</div><div class="insert">+``</div><div class="insert">+{{=LI(A(&#x27;something&#x27;, _href=URL(&#x27;show&#x27;, args=123))}}</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+is rendered as:</div><div class="insert">+``</div><div class="insert">+&lt;li&gt;&lt;a href=&quot;/images/default/show/123&quot;&gt;something&lt;/a&gt;&lt;/li&gt;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+A handful of helpers (``INPUT``, ``TEXTAREA``, ``OPTION`` and ``SELECT``) also support some special named attributes not starting with underscore (``value``, and ``requires``). They are important for building custom forms and will be discussed later.</div><div class="insert">+</div><div class="insert">+Go back to the &#x27;&#x27;edit&#x27;&#x27; page. It now indicates that &quot;default.py exposes index&quot;. By clicking on &quot;index&quot;, you can visit the newly created page:</div><div class="insert">+``</div><div class="insert">+http://127.0.0.1:8000/images/default/index</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+which looks like:</div><div class="insert">+</div><div class="insert">+[[image @///image/en2800.png center 480px]]</div><div class="insert">+</div><div class="insert">+If you click on the image name link, you are directed to:</div><div class="insert">+``</div><div class="insert">+http://127.0.0.1:8000/images/default/show/1</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+and this results in an error, since you have not yet created an action called &quot;show&quot; in controller &quot;default.py&quot;.</div><div class="insert">+</div><div class="insert">+Let&#x27;s edit the &quot;default.py&quot; controller and replace its content with:</div><div class="insert">+</div><div class="insert">+``SQLFORM``:inxx ``accepts``:inxx ``response.flash``:inxx ``request.args``:inxx</div><div class="insert">+``response.download``:inxx</div><div class="insert">+``</div><div class="insert">+def index():</div><div class="insert">+    images = db().select(db.image.ALL, orderby=db.image.title)</div><div class="insert">+    return dict(images=images)</div><div class="insert">+</div><div class="insert">+def show():</div><div class="insert">+    image = db.image(request.args(0,cast=int)) or redirect(URL(&#x27;index&#x27;))</div><div class="insert">+    db.comment.image_id.default = image.id</div><div class="insert">+    form = SQLFORM(db.comment)</div><div class="insert">+    if form.process().accepted:</div><div class="insert">+        response.flash = &#x27;your comment is posted&#x27;</div><div class="insert">+    comments = db(db.comment.image_id==image.id).select()</div><div class="insert">+    return dict(image=image, comments=comments, form=form)</div><div class="insert">+</div><div class="insert">+def download():</div><div class="insert">+    return response.download(request, db)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+The controller contains two actions: &quot;show&quot; and &quot;download&quot;.</div><div class="insert">+The &quot;show&quot; action selects the image with the ``id`` parsed from the request args and all comments related to the image. &quot;show&quot; then passes everything to the view &quot;default/show.html&quot;.</div><div class="insert">+</div><div class="insert">+The image id referenced by:</div><div class="insert">+``</div><div class="insert">+URL(&#x27;show&#x27;, args=image.id)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+in &quot;default/index.html&quot;, can be accessed as:</div><div class="insert">+</div><div class="insert">+``request.args(0,cast=int)``</div><div class="insert">+</div><div class="insert">+from the &quot;show&quot; action. The ``cast=int`` argument is optional but very important. It attempts to cast the string value passed in the PATH_INFO into an int. On failure it raise a proper exception instead of causing a ticket. One can also specify a redirect in case of failure to cast:</div><div class="insert">+</div><div class="insert">+``request.args(0,cast=int,otherwise=URL(&#x27;error&#x27;))``</div><div class="insert">+</div><div class="insert">+Moreover ``db.image(...)`` is a shortcut for</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+db(db.image.id==...).select().first()</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+The &quot;download&quot; action expects a filename in ``request.args(0)``, builds a path to the location where that file is supposed to be, and sends it back to the client. If the file is too large, it streams the file without incurring any memory overhead.</div><div class="insert">+</div><div class="insert">+Notice the following statements:</div><div class="insert">+- Line 7 creates an insert form SQLFORM for the ``db.comment`` table using only the specified fields.</div><div class="insert">+- Line 8 sets the value for the reference field, which is not part of the input form because it is not in the list of fields specified above.</div><div class="insert">+- Line 9 processes the submitted form (the submitted form variables are in ``request.vars``) within the current session (the session is used to prevent double submissions, and to enforce navigation). If the submitted form variables are validated, the new comment is inserted in the ``db.comment`` table; otherwise the form is modified to include error messages (for example, if the author&#x27;s email address is invalid). This is all done in line 9!.</div><div class="insert">+- Line 10 is only executed if the form is accepted, after the record is inserted into the database table. ``response.flash`` is a web2py variable that is displayed in the views and used to notify the visitor that something happened.</div><div class="insert">+- Line 11 selects all comments that reference the current image.</div><div class="insert">+</div><div class="insert">+-------</div><div class="insert">+The &quot;download&quot; action is already defined in the &quot;default.py&quot; controller of the scaffolding application.</div><div class="insert">+-------</div><div class="insert">+</div><div class="insert">+The &quot;download&quot; action does not return a dictionary, so it does not need a view. The &quot;show&quot; action, though, should have a view, so return to **admin** and create a new view called &quot;default/show.html&quot;.</div><div class="insert">+</div><div class="insert">+Edit this new file and replace its content with the following:</div><div class="insert">+``</div><div class="insert">+{{extend &#x27;layout.html&#x27;}}</div><div class="insert">+&lt;h1&gt;Image: {{=image.title}}&lt;/h1&gt;</div><div class="insert">+&lt;center&gt;</div><div class="insert">+&lt;img width=&quot;200px&quot;</div><div class="insert">+     src=&quot;{{=URL(&#x27;download&#x27;, args=image.file)}}&quot; /&gt;</div><div class="insert">+&lt;/center&gt;</div><div class="insert">+{{if len(comments):}}</div><div class="insert">+  &lt;h2&gt;Comments&lt;/h2&gt;&lt;br /&gt;&lt;p&gt;</div><div class="insert">+  {{for comment in comments:}}</div><div class="insert">+    &lt;p&gt;{{=comment.author}} says &lt;i&gt;{{=comment.body}}&lt;/i&gt;&lt;/p&gt;</div><div class="insert">+  {{pass}}&lt;/p&gt;</div><div class="insert">+{{else:}}</div><div class="insert">+  &lt;h2&gt;No comments posted yet&lt;/h2&gt;</div><div class="insert">+{{pass}}</div><div class="insert">+&lt;h2&gt;Post a comment&lt;/h2&gt;</div><div class="insert">+{{=form}}</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+This view displays the **image.file** by calling the &quot;download&quot; action inside an ``&lt;img ... /&gt;`` tag.</div><div class="insert">+If there are comments, it loops over them and displays each one.</div><div class="insert">+</div><div class="insert">+Here is how everything will appear to a visitor.</div><div class="insert">+</div><div class="insert">+[[image @///image/en2900.png center 480px]]</div><div class="insert">+</div><div class="insert">+When a visitor submits a comment via this page, the comment is stored in the database and appended at the bottom of the page.</div><div class="insert">+</div><div class="insert">+#### Adding authentication</div><div class="insert">+</div><div class="insert">+The web2py API for Role-Based Access Control is quite sophisticated, but for now we will limit ourselves to restricting access to the show action to authenticated users, deferring a more detailed discussion to Chapter 9.</div><div class="insert">+</div><div class="insert">+To limit access to authenticated users, we need to complete three steps. In a model, for example &quot;db.py&quot;, we need to add:</div><div class="insert">+``</div><div class="insert">+from gluon.tools import Auth</div><div class="insert">+auth = Auth(db)</div><div class="insert">+auth.define_tables(username=True)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+In our controller, we need to add one action:</div><div class="insert">+``</div><div class="insert">+def user():</div><div class="insert">+    return dict(form=auth())</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+This is sufficient to enable login, register, logout, etc. pages. The default layout will also show options to the corresponding pages in the top right corner.</div><div class="insert">+</div><div class="insert">+[[image @///image/en3000.png center 300px]]</div><div class="insert">+</div><div class="insert">+We can now decorate the functions that we want to restrict, for example:</div><div class="insert">+``</div><div class="insert">+@auth.requires_login()</div><div class="insert">+def show():</div><div class="insert">+    ...</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Any attempt to access</div><div class="insert">+``</div><div class="insert">+http://127.0.0.1:8000/images/default/show/[image_id]</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+will require login. If the user is not logged it, the user will be redirected to</div><div class="insert">+``</div><div class="insert">+http://127.0.0.1:8000/images/default/user/login</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+[[image @///image/en3100.png center 480px]]</div><div class="insert">+</div><div class="insert">+The ``user`` function also exposes, among others, the following actions:</div><div class="insert">+``</div><div class="insert">+http://127.0.0.1:8000/images/default/user/logout</div><div class="insert">+http://127.0.0.1:8000/images/default/user/register</div><div class="insert">+http://127.0.0.1:8000/images/default/user/profile</div><div class="insert">+http://127.0.0.1:8000/images/default/user/change_password</div><div class="insert">+http://127.0.0.1:8000/images/default/user/request_reset_password</div><div class="insert">+http://127.0.0.1:8000/images/default/user/retrieve_username</div><div class="insert">+http://127.0.0.1:8000/images/default/user/retrieve_password</div><div class="insert">+http://127.0.0.1:8000/images/default/user/verify_email</div><div class="insert">+http://127.0.0.1:8000/images/default/user/impersonate</div><div class="insert">+http://127.0.0.1:8000/images/default/user/not_authorized</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Now, a first-time user needs to register in order to be able to log in and read or post comments.</div><div class="insert">+</div><div class="insert">+-------</div><div class="insert">+Both the ``auth`` object and the ``user`` function are already defined in the scaffolding application. The ``auth`` object is highly customizable and can deal with email verification, registration approvals, CAPTCHA, and alternate login methods via plugins.</div><div class="insert">+-------</div><div class="insert">+</div><div class="insert">+#### Adding grids</div><div class="insert">+</div><div class="insert">+We can improve this further using the ``SQLFORM.grid`` and ``SQLFORM.smartgrid`` gadgets to create a management interface for our application:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+@auth.requires_membership(&#x27;manager&#x27;)</div><div class="insert">+def manage():</div><div class="insert">+    grid = SQLFORM.smartgrid(db.image,linked_tables=[&#x27;comment&#x27;])</div><div class="insert">+    return dict(grid=grid)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+with associated &quot;views/default/manage.html&quot;</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+{{extend &#x27;layout.html&#x27;}}</div><div class="insert">+&lt;h2&gt;Management Interface&lt;/h2&gt;</div><div class="insert">+{{=grid}}</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+Using appadmin create a group &quot;manager&quot; and make some users members of the group. They will not be able to access</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+http://127.0.0.1:8000/images/default/manage</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+and browse, search:</div><div class="insert">+</div><div class="insert">+[[image @///image/en3200.png center 480px]]</div><div class="insert">+</div><div class="insert">+create, update and delete images and their comments:</div><div class="insert">+</div><div class="insert">+[[image @///image/en3300.png center 480px]]</div><div class="insert">+</div><div class="insert">+#### Configuring the layout</div><div class="insert">+</div><div class="insert">+You can configure the default layout by editing &quot;views/layout.html&quot; but you can also configure it without editing the HTML. In fact, the &quot;static/base.css&quot; stylesheet is well documented and described in Chapter 5. You can change color, columns, size, borders and background without editing the HTML. If you want to edit the menu, the title or the subtitle, you can do so in any model file. The scaffolding app, sets default values of these parameters in the file &quot;models/menu.py&quot;:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+response.title = request.application</div><div class="insert">+response.subtitle = &#x27;customize me!&#x27;</div><div class="insert">+response.meta.author = &#x27;you&#x27;</div><div class="insert">+response.meta.description = &#x27;describe your app&#x27;</div><div class="insert">+response.meta.keywords = &#x27;bla bla bla&#x27;</div><div class="insert">+response.menu = [ [ &#x27;Index&#x27;, False, URL(&#x27;index&#x27;) ] ]</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+### A simple wiki</div><div class="insert">+``wiki``:inxx ``RSS``:inxx ``Ajax``:inxx ``XMLRPC``:inxx</div><div class="insert">+</div><div class="insert">+In this section, we build a simple wiki from scratch using only low level APIs (as opposed to using the built-in wiki capabilities of web2py demonstrated in the next section). The visitor will be able to create pages, search them (by title), and edit them. The visitor will also be able to post comments (exactly as in the previous applications), and also post documents (as attachments to the pages) and link them from the pages. As a convention, we adopt the Markmin syntax for our wiki syntax. We will also implement a search page with Ajax, an RSS feed for the pages, and a handler to search the pages via XML-RPC``xmlrpc``:cite . The following diagram lists the actions that we need to implement and the links we intend to build among them.</div><div class="insert">+</div><div class="insert">+[[yUML diagram @///image/en3400.png center 200px]]</div><div class="insert">+</div><div class="insert">+Start by creating a new scaffolding app, naming it &quot;mywiki&quot;.</div><div class="insert">+</div><div class="insert">+The model must contain three tables: page, comment, and document. Both comment and document reference page because they belong to page. A document contains a file field of type upload as in the previous images application.</div><div class="insert">+</div><div class="insert">+Here is the complete model:</div><div class="insert">+``</div><div class="insert">+db = DAL(&#x27;sqlite://storage.sqlite&#x27;)</div><div class="insert">+</div><div class="insert">+from gluon.tools import *</div><div class="insert">+auth = Auth(db)</div><div class="insert">+auth.define_tables()</div><div class="insert">+crud = Crud(db)</div><div class="insert">+</div><div class="insert">+db.define_table(&#x27;page&#x27;,</div><div class="insert">+    Field(&#x27;title&#x27;),</div><div class="insert">+    Field(&#x27;body&#x27;, &#x27;text&#x27;),</div><div class="insert">+    Field(&#x27;created_on&#x27;, &#x27;datetime&#x27;, default=request.now),</div><div class="insert">+    Field(&#x27;created_by&#x27;, &#x27;reference auth_user&#x27;, default=auth.user_id),</div><div class="insert">+    format=&#x27;%(title)s&#x27;)</div><div class="insert">+</div><div class="insert">+db.define_table(&#x27;comment&#x27;,</div><div class="insert">+    Field(&#x27;page_id&#x27;, &#x27;reference page&#x27;),</div><div class="insert">+    Field(&#x27;body&#x27;, &#x27;text&#x27;),</div><div class="insert">+    Field(&#x27;created_on&#x27;, &#x27;datetime&#x27;, default=request.now),</div><div class="insert">+    Field(&#x27;created_by&#x27;, &#x27;reference auth_user&#x27;, default=auth.user_id))</div><div class="insert">+</div><div class="insert">+db.define_table(&#x27;document&#x27;,</div><div class="insert">+    Field(&#x27;page_id&#x27;, &#x27;reference page&#x27;),</div><div class="insert">+    Field(&#x27;name&#x27;),</div><div class="insert">+    Field(&#x27;file&#x27;, &#x27;upload&#x27;),</div><div class="insert">+    Field(&#x27;created_on&#x27;, &#x27;datetime&#x27;, default=request.now),</div><div class="insert">+    Field(&#x27;created_by&#x27;, &#x27;reference auth_user&#x27;, default=auth.user_id),</div><div class="insert">+    format=&#x27;%(name)s&#x27;)</div><div class="insert">+</div><div class="insert">+db.page.title.requires = IS_NOT_IN_DB(db, &#x27;page.title&#x27;)</div><div class="insert">+db.page.body.requires = IS_NOT_EMPTY()</div><div class="insert">+db.page.created_by.readable = db.page.created_by.writable = False</div><div class="insert">+db.page.created_on.readable = db.page.created_on.writable = False</div><div class="insert">+</div><div class="insert">+db.comment.body.requires = IS_NOT_EMPTY()</div><div class="insert">+db.comment.page_id.readable = db.comment.page_id.writable = False</div><div class="insert">+db.comment.created_by.readable = db.comment.created_by.writable = False</div><div class="insert">+db.comment.created_on.readable = db.comment.created_on.writable = False</div><div class="insert">+</div><div class="insert">+db.document.name.requires = IS_NOT_IN_DB(db, &#x27;document.name&#x27;)</div><div class="insert">+db.document.page_id.readable = db.document.page_id.writable = False</div><div class="insert">+db.document.created_by.readable = db.document.created_by.writable = False</div><div class="insert">+db.document.created_on.readable = db.document.created_on.writable = False</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Edit the controller &quot;default.py&quot; and create the following actions:</div><div class="insert">+- index: list all wiki pages</div><div class="insert">+- create: post another wiki page</div><div class="insert">+- show: show a wiki page and its comments, and append comments</div><div class="insert">+- edit: edit an existing page</div><div class="insert">+- documents: manage the documents attached to a page</div><div class="insert">+- download: download a document (as in the images example)</div><div class="insert">+- search: display a search box and, via an Ajax callback, return all matching titles as the visitor types</div><div class="insert">+- callback: the Ajax callback function. It returns the HTML that gets embedded in the search page while the visitor types.</div><div class="insert">+</div><div class="insert">+Here is the &quot;default.py&quot; controller:</div><div class="insert">+``</div><div class="insert">+def index():</div><div class="insert">+     &quot;&quot;&quot; this controller returns a dictionary rendered by the view</div><div class="insert">+         it lists all wiki pages</div><div class="insert">+     &gt;&gt;&gt; index().has_key(&#x27;pages&#x27;)</div><div class="insert">+     True</div><div class="insert">+     &quot;&quot;&quot;</div><div class="insert">+     pages = db().select(db.page.id,db.page.title,orderby=db.page.title)</div><div class="insert">+     return dict(pages=pages)</div><div class="insert">+</div><div class="insert">+@auth.requires_login()</div><div class="insert">+def create():</div><div class="insert">+     &quot;creates a new empty wiki page&quot;</div><div class="insert">+     form = SQLFORM(db.page).process(next=URL(&#x27;index&#x27;))</div><div class="insert">+     return dict(form=form)</div><div class="insert">+</div><div class="insert">+def show():</div><div class="insert">+     &quot;shows a wiki page&quot;</div><div class="insert">+     this_page = db.page(request.args(0,cast=int)) or redirect(URL(&#x27;index&#x27;))</div><div class="insert">+     db.comment.page_id.default = this_page.id</div><div class="insert">+     form = SQLFORM(db.comment).process() if auth.user else None</div><div class="insert">+     pagecomments = db(db.comment.page_id==this_page.id).select()</div><div class="insert">+     return dict(page=this_page, comments=pagecomments, form=form)</div><div class="insert">+</div><div class="insert">+@auth.requires_login()</div><div class="insert">+def edit():</div><div class="insert">+     &quot;edit an existing wiki page&quot;</div><div class="insert">+     this_page = db.page(request.args(0,cast=int)) or redirect(URL(&#x27;index&#x27;))</div><div class="insert">+     form = SQLFORM(db.page, this_page).process(</div><div class="insert">+         next = URL(&#x27;show&#x27;,args=request.args))</div><div class="insert">+     return dict(form=form)</div><div class="insert">+</div><div class="insert">+@auth.requires_login()</div><div class="insert">+def documents():</div><div class="insert">+     &quot;browser, edit all documents attached to a certain page&quot;</div><div class="insert">+     page = db.page(request.args(0,cast=int)) or redirect(URL(&#x27;index&#x27;))</div><div class="insert">+     db.document.page_id.default = page.id</div><div class="insert">+     db.document.page_id.writable = False</div><div class="insert">+     grid = SQLFORM.grid(db.document.page_id==page.id,args=[page.id])</div><div class="insert">+     return dict(page=page, grid=grid)</div><div class="insert">+</div><div class="insert">+def user():</div><div class="insert">+     return dict(form=auth())</div><div class="insert">+</div><div class="insert">+def download():</div><div class="insert">+     &quot;allows downloading of documents&quot;</div><div class="insert">+     return response.download(request, db)</div><div class="insert">+</div><div class="insert">+def search():</div><div class="insert">+     &quot;an ajax wiki search page&quot;</div><div class="insert">+     return dict(form=FORM(INPUT(_id=&#x27;keyword&#x27;,_name=&#x27;keyword&#x27;,</div><div class="insert">+              _onkeyup=&quot;ajax(&#x27;callback&#x27;, [&#x27;keyword&#x27;], &#x27;target&#x27;);&quot;)),</div><div class="insert">+              target_div=DIV(_id=&#x27;target&#x27;))</div><div class="insert">+</div><div class="insert">+def callback():</div><div class="insert">+     &quot;an ajax callback that returns a &lt;ul&gt; of links to wiki pages&quot;</div><div class="insert">+     query = db.page.title.contains(request.vars.keyword)</div><div class="insert">+     pages = db(query).select(orderby=db.page.title)</div><div class="insert">+     links = [A(p.title, _href=URL(&#x27;show&#x27;,args=p.id)) for p in pages]</div><div class="insert">+     return UL(*links)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+</div><div class="insert">+Lines 2-6 provide a comment for the index action. Lines 4-5 inside the comment are interpreted by python as test code (doctest). Tests can be run via the admin interface. In this case the tests verify that the index action runs without errors.</div><div class="insert">+</div><div class="insert">+Lines 18, 27, and 35 try to fetch a ``page`` record with the id in</div><div class="insert">+``request.args(0)``.</div><div class="insert">+</div><div class="insert">+Lines 13, 20 define and process create forms for a new page and a new comment and.</div><div class="insert">+</div><div class="insert">+Line 28 defines and processes an update form for a wiki page.</div><div class="insert">+</div><div class="insert">+Line 38 creates a ``grid`` object that allows to browser, add and update the comments linked to a page.</div><div class="insert">+</div><div class="insert">+Some magic happens in line 51. The ``onkeyup`` attribute of the INPUT tag &quot;keyword&quot; is set. Every time the visitor releases a key, the JavaScript code inside the ``onkeyup`` attribute is executed, client-side. Here is the JavaScript code:</div><div class="insert">+``</div><div class="insert">+ajax(&#x27;callback&#x27;, [&#x27;keyword&#x27;], &#x27;target&#x27;);</div><div class="insert">+``:code</div><div class="insert">+``ajax`` is a JavaScript function defined in the file &quot;web2py.js&quot; which is included by the default &quot;layout.html&quot;. It takes three parameters: the URL of the action that performs the synchronous callback, a list of the IDs of variables to be sent to the callback ([&quot;keyword&quot;]), and the ID where the response has to be inserted (&quot;target&quot;).</div><div class="insert">+</div><div class="insert">+As soon as you type something in the search box and release a key, the client calls the server and sends the content of the &#x27;keyword&#x27; field, and, when the sever responds, the response is embedded in the page itself as the innerHTML of the &#x27;target&#x27; tag.</div><div class="insert">+</div><div class="insert">+The &#x27;target&#x27; tag is a DIV defined in line 52. It could have been defined in the view as well.</div><div class="insert">+</div><div class="insert">+Here is the code for the view &quot;default/create.html&quot;:</div><div class="insert">+``</div><div class="insert">+{{extend &#x27;layout.html&#x27;}}</div><div class="insert">+&lt;h1&gt;Create new wiki page&lt;/h1&gt;</div><div class="insert">+{{=form}}</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+If you visit the **create** page, you see the following:</div><div class="insert">+</div><div class="insert">+[[image @///image/en3500.png center 480px]]</div><div class="insert">+</div><div class="insert">+Here is the code for the view &quot;default/index.html&quot;:</div><div class="insert">+``</div><div class="insert">+{{extend &#x27;layout.html&#x27;}}</div><div class="insert">+&lt;h1&gt;Available wiki pages&lt;/h1&gt;</div><div class="insert">+[ {{=A(&#x27;search&#x27;, _href=URL(&#x27;search&#x27;))}} ]&lt;br /&gt;</div><div class="insert">+&lt;ul&gt;{{for page in pages:}}</div><div class="insert">+     {{=LI(A(page.title, _href=URL(&#x27;show&#x27;, args=page.id)))}}</div><div class="insert">+{{pass}}&lt;/ul&gt;</div><div class="insert">+[ {{=A(&#x27;create page&#x27;, _href=URL(&#x27;create&#x27;))}} ]</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+It generates the following page:</div><div class="insert">+</div><div class="insert">+[[image @///image/en3600.png center 480px]]</div><div class="insert">+</div><div class="insert">+Here is the code for the view &quot;default/show.html&quot;:</div><div class="insert">+</div><div class="insert">+``markdown``:inxx ``MARKMIN``:inxx</div><div class="insert">+``</div><div class="insert">+{{extend &#x27;layout.html&#x27;}}</div><div class="insert">+&lt;h1&gt;{{=page.title}}&lt;/h1&gt;</div><div class="insert">+[ {{=A(&#x27;edit&#x27;, _href=URL(&#x27;edit&#x27;, args=request.args))}}</div><div class="insert">+| {{=A(&#x27;documents&#x27;, _href=URL(&#x27;documents&#x27;, args=request.args))}} ]&lt;br /&gt;</div><div class="insert">+{{=MARKMIN(page.body)}}</div><div class="insert">+&lt;h2&gt;Comments&lt;/h2&gt;</div><div class="insert">+{{for comment in comments:}}</div><div class="insert">+  &lt;p&gt;{{=db.auth_user[comment.created_by].first_name}} on {{=comment.created_on}}</div><div class="insert">+          says &lt;I&gt;{{=comment.body}}&lt;/i&gt;&lt;/p&gt;</div><div class="insert">+{{pass}}</div><div class="insert">+&lt;h2&gt;Post a comment&lt;/h2&gt;</div><div class="insert">+{{=form}}</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+If you wish to use markdown syntax instead of markmin syntax:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+from gluon.contrib.markdown import WIKI</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+and use ``WIKI`` instead of the ``MARKMIN`` helper.</div><div class="insert">+Alternatively, you can choose to accept raw HTML instead of markmin syntax. In this case you would replace:</div><div class="insert">+``</div><div class="insert">+{{=MARKMIN(page.body)}}</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+with:</div><div class="insert">+``</div><div class="insert">+{{=XML(page.body)}}</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+``sanitize``:inxx</div><div class="insert">+(so that the XML does not get escaped, as by default web2py behavior).</div><div class="insert">+</div><div class="insert">+This can be done better with:</div><div class="insert">+``</div><div class="insert">+{{=XML(page.body, sanitize=True)}}</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+By setting ``sanitize=True``, you tell web2py to escape unsafe XML tags such as &quot;&lt;script&gt;&quot;, and thus prevent XSS vulnerabilities.</div><div class="insert">+</div><div class="insert">+Now if, from the index page, you click on a page title, you can see the page that you have created:</div><div class="insert">+</div><div class="insert">+[[image @///image/en3700.png center 480px]]</div><div class="insert">+</div><div class="insert">+Here is the code for the view &quot;default/edit.html&quot;:</div><div class="insert">+``</div><div class="insert">+{{extend &#x27;layout.html&#x27;}}</div><div class="insert">+&lt;h1&gt;Edit wiki page&lt;/h1&gt;</div><div class="insert">+[ {{=A(&#x27;show&#x27;, _href=URL(&#x27;show&#x27;, args=request.args))}} ]&lt;br /&gt;</div><div class="insert">+{{=form}}</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+It generates a page that looks almost identical to the create page.</div><div class="insert">+</div><div class="insert">+Here is the code for the view &quot;default/documents.html&quot;:</div><div class="insert">+``</div><div class="insert">+{{extend &#x27;layout.html&#x27;}}</div><div class="insert">+&lt;h1&gt;Documents for page: {{=page.title}}&lt;/h1&gt;</div><div class="insert">+[ {{=A(&#x27;show&#x27;, _href=URL(&#x27;show&#x27;, args=request.args))}} ]&lt;br /&gt;</div><div class="insert">+&lt;h2&gt;Documents&lt;/h2&gt;</div><div class="insert">+{{=grid}}</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+If, from the &quot;show&quot; page, you click on documents, you can now manage the documents attached to the page.</div><div class="insert">+</div><div class="insert">+[[image @///image/en3800.png center 480px]]</div><div class="insert">+</div><div class="insert">+Finally here is the code for the view &quot;default/search.html&quot;:</div><div class="insert">+``</div><div class="insert">+{{extend &#x27;layout.html&#x27;}}</div><div class="insert">+&lt;h1&gt;Search wiki pages&lt;/h1&gt;</div><div class="insert">+[ {{=A(&#x27;listall&#x27;, _href=URL(&#x27;index&#x27;))}}]&lt;br /&gt;</div><div class="insert">+{{=form}}&lt;br /&gt;{{=target_div}}</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+which generates the following Ajax search form:</div><div class="insert">+</div><div class="insert">+[[image @///image/en3900.png center 480px]]</div><div class="insert">+</div><div class="insert">+You can also try to call the callback action directly by visiting, for example, the following URL:</div><div class="insert">+``</div><div class="insert">+http://127.0.0.1:8000/mywiki/default/callback?keyword=wiki</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+If you look at the page source you see the HTML returned by the callback:</div><div class="insert">+``</div><div class="insert">+&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;/mywiki/default/show/4&quot;&gt;I made a Wiki&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+``rss``:inxx</div><div class="insert">+Generating an RSS feed from the stored pages using web2py is easy because web2py includes ``gluon.contrib.rss2``. Just append the following action to the default controller:</div><div class="insert">+``</div><div class="insert">+def news():</div><div class="insert">+    &quot;generates rss feed form the wiki pages&quot;</div><div class="insert">+    reponse.generic_patterns = [&#x27;.rss&#x27;]</div><div class="insert">+    pages = db().select(db.page.ALL, orderby=db.page.title)</div><div class="insert">+    return dict(</div><div class="insert">+       title = &#x27;mywiki rss feed&#x27;,</div><div class="insert">+       link = &#x27;http://127.0.0.1:8000/mywiki/default/index&#x27;,</div><div class="insert">+       description = &#x27;mywiki news&#x27;,</div><div class="insert">+       created_on = request.now,</div><div class="insert">+       items = [</div><div class="insert">+          dict(title = row.title,</div><div class="insert">+               link = URL(&#x27;show&#x27;, args=row.id),</div><div class="insert">+               description = MARKMIN(row.body).xml(),</div><div class="insert">+               created_on = row.created_on</div><div class="insert">+               ) for row in pages])</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+and when you visit the page</div><div class="insert">+``</div><div class="insert">+http://127.0.0.1:8000/mywiki/default/news.rss</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+you see the feed (the exact output depends on the feed reader). Notice that the dict is automatically converted to RSS, thanks to the .rss extension in the URL.</div><div class="insert">+</div><div class="insert">+[[image @///image/en4000.png center 480px]]</div><div class="insert">+</div><div class="insert">+web2py also includes feedparser to read third-party feeds.</div><div class="insert">+</div><div class="insert">+``XMLRPC``:inxx</div><div class="insert">+Finally, let&#x27;s add an XML-RPC handler that allows searching the wiki programmatically:</div><div class="insert">+``</div><div class="insert">+service = Service()</div><div class="insert">+</div><div class="insert">+@service.xmlrpc</div><div class="insert">+def find_by(keyword):</div><div class="insert">+     &quot;finds pages that contain keyword for XML-RPC&quot;</div><div class="insert">+     return db(db.page.title.contains(keyword)).select().as_list()</div><div class="insert">+</div><div class="insert">+def call():</div><div class="insert">+    &quot;exposes all registered services, including XML-RPC&quot;</div><div class="insert">+    return service()</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Here, the handler action simply publishes (via XML-RPC), the functions specified in the list. In this case, ``find_by``. ``find_by`` is not an action (because it takes an argument). It queries the database with ``.select()`` and then extracts the records as a list with ``.response`` and returns the list.</div><div class="insert">+</div><div class="insert">+Here is an example of how to access the XML-RPC handler from an external</div><div class="insert">+Python program.</div><div class="insert">+``</div><div class="insert">+&gt;&gt;&gt; import xmlrpclib</div><div class="insert">+&gt;&gt;&gt; server = xmlrpclib.ServerProxy(</div><div class="insert">+    &#x27;http://127.0.0.1:8000/mywiki/default/call/xmlrpc&#x27;)</div><div class="insert">+&gt;&gt;&gt; for item in server.find_by(&#x27;wiki&#x27;):</div><div class="insert">+        print item[&#x27;created_on&#x27;], item[&#x27;title&#x27;]</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+The handler can be accessed from many other programming languages that understand XML-RPC, including C, C++, C# and Java.</div><div class="insert">+</div><div class="insert">+#### On ``date``, ``datetime`` and ``time`` format</div><div class="insert">+</div><div class="insert">+There are three different representation for each of the field types ``date``, ``datetime`` and ``time``:</div><div class="insert">+- the database representation</div><div class="insert">+- the internal web2py prepresentation</div><div class="insert">+- the string representation in forms and tables</div><div class="insert">+</div><div class="insert">+The database representation is an internal issue and does not affect the code. Internally, at the web2py level, they are stored as ``datetime.date``, ``datetime.datetime`` and ``datetime.time`` object respectively and they can be manipulated as such:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+for page in db(db.page).select():</div><div class="insert">+    print page.title, page.day, page.month, page.year</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+When dates are converted to strings in forms they are converted using the ISO representation</div><div class="insert">+``</div><div class="insert">+%Y-%m-%d %H:%M:%S</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+yet this representation in internationalized and you can use the admin stranslation page to change the format to an alternate one. For example:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+%m/%b/%Y %H:%M:%S</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+Mind that by default English is not translated because web2py assumes the applications is already written in English. If you want internationalization to work for English you need to create the translation file (using admin) and you need declare that the application current language is something other than english, for example:</div><div class="insert">+``</div><div class="insert">+T.current_languages = [&#x27;null&#x27;]</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+### The built-in web2py wiki</div><div class="insert">+</div><div class="insert">+Now you can forget the code we have built-in the previous section (not what you have learned about web2py APIs, just the code of the specific example) as we are going to provide and example of the built-in web2py wiki.</div><div class="insert">+</div><div class="insert">+In fact, web2py comes with wiki capabilities including media attachments, tags, tag cloud, page permissions, and support for oembed ``oembed``:cite and components (chapter 14). This wiki can be used with any web2py application.</div><div class="insert">+</div><div class="insert">+------</div><div class="insert">+Notice the API of the built-in wiki are still considered experimental and small changes are still possible.</div><div class="insert">+------</div><div class="insert">+</div><div class="insert">+Here we assume we are starting from cratch from a simple clone of the &quot;welcome&quot; application called &quot;wikidemo&quot;. Edit the controller and replace the &quot;index&quot; action with</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+def index(): return auth.wiki()</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Done! You have a fully working wiki. At this point no page has been created and in order to create pages you must be logged-in and you must be member of a group called &quot;wiki-editor&quot; or &quot;wiki-author&quot;. If you are logged as administrator the &quot;wiki-editor&quot; group is created automatically and you are made a member. The difference between editors and authors is that the editors can create pages, edit and delete any page, while the authors can create pages (with some optional restrictions) and can only edit/delete the pages they have created.</div><div class="insert">+</div><div class="insert">+The ``auth.wiki()`` function returns in a dictionary with a key ``content`` which is understood by the scaffolding &quot;views/default/index.html&quot;. You man make your own view for this action:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+{{extend &#x27;layout.html&#x27;}}</div><div class="insert">+{{=content}}</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+and add extra HTML or code as needed. There is no need to call the action &quot;index&quot;.</div><div class="insert">+</div><div class="insert">+To try the wiki, simply login into admin, visit the page</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+http://127.0.0.1:8000/wikidemo/default/index</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+Then choose a slug (in the publishing business, a slug is a short name given to an article that is in production) and you will be redirected to an empty page where you can edit the content using MARKMIN wiki syntax. A new menu item called &quot;[wiki]&quot; will allow you create, search, and edit pages. Wiki pages have RULS like:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+http://127.0.0.1:8000/wikidemo/default/index/[slug]</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+Service pages have names which start by underscore:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+http://127.0.0.1:8000/wikidemo/default/index/_create</div><div class="insert">+http://127.0.0.1:8000/wikidemo/default/index/_search</div><div class="insert">+http://127.0.0.1:8000/wikidemo/default/index/_could</div><div class="insert">+http://127.0.0.1:8000/wikidemo/default/index/_recent</div><div class="insert">+http://127.0.0.1:8000/wikidemo/default/index/_edit/...</div><div class="insert">+http://127.0.0.1:8000/wikidemo/default/index/_editmedia/...</div><div class="insert">+http://127.0.0.1:8000/wikidemo/default/index/_preview/...</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+Try create more pages such as &quot;index&quot;, &quot;aboutus&quot;, and &quot;contactus&quot;.</div><div class="insert">+Try edit them.</div><div class="insert">+</div><div class="insert">+</div><div class="insert">+The ``wiki`` method has the following signature:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+def wiki(self, slug=None, env=None, render=&#x27;markmin&#x27;,</div><div class="insert">+         manage_permissions=False, force_prefix=&#x27;&#x27;,</div><div class="insert">+         restrict_search=False, resolve=True,</div><div class="insert">+         extra=None, menugroups=None)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+It takes the following arguments:</div><div class="insert">+</div><div class="insert">+- ``render`` which defaults to ``&#x27;markmin&#x27;`` but can be set equal to ``&#x27;html&#x27;``. It termines the syntax of the wiki. We will discuss the makrmin wiki markup later. If you change it to HTML you may want to use a wysiwyg javascript editor such as TinyMCE of NicEdit.</div><div class="insert">+- ``manage_permissions``. This is set to ``False`` by default and only recognizes permissions for &quot;wiki-editor&quot; and &quot;wiki-author&quot;. If you change it to ``True`` the create/edit page will give the option to specify by names the groups whose members have permssion to read and edit the page. In this case is a group &quot;everybody&quot; to give read permission to everybody.</div><div class="insert">+- ``force_prefix``. If set to something like ``&#x27;%(id)s-&#x27;`` it will restict authors (not editors) to create page with a prefix like &quot;[user id]-[page name]&quot;. The prefix can contain the id (&quot;%(id)s&quot;) or the username (&quot;%(username)s&quot;) or any other field from the auth_user table, as long as the corresponding column contains valid string that would pass URL validation.</div><div class="insert">+- ``restrict_search``. This default to ``False`` and any logged-in user can search all wiki pages (but not necessary read or edit them). If set to ``True``, authors can search only their own pages, editors can search everything, other users cannot search anything.</div><div class="insert">+- ``menugroups``. This defaults to ``None`` and it indictates that wiki management menu (search, create, edit, etc.) is always displayed. You can set it to a list of group names whose members only can see this menu, for exmaple ``[&#x27;wiki-editor&#x27;,&#x27;wiki-author&#x27;]``. Notice that even if the menu is exposed to everybody does not mean everybody is allowed to perform actions listed in the menu since they are regulated by the access control system.</div><div class="insert">+</div><div class="insert">+The ``wiki`` method has some additional parameters which will be explained later: ``slug``, ``env``, and ``extra``.</div><div class="insert">+</div><div class="insert">+</div><div class="insert">+</div><div class="insert">+#### MARKMIN basics</div><div class="insert">+</div><div class="insert">+The MARKMIN syntax allows you to markup **bold** text using ``**bold**``, &#x27;&#x27;italic&#x27;&#x27; text with ``&#x27;&#x27;italic&#x27;&#x27;``, ``code`` text with ``\`\`code\`\```. Titles must be prefixed by a #, sections by ##, and sub-sections by ###. Use a minus(-) to prefix an un-ordered item and plus(+) to prefix an ordered item. URLs are automatically into links. For example:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+# This is title</div><div class="insert">+## this is a section title</div><div class="insert">+### this is a subsection title</div><div class="insert">+</div><div class="insert">+Text can be **bold**, &#x27;&#x27;italic&#x27;&#x27;, !`!!`!code!`!!`! etc.</div><div class="insert">+Learn more at:</div><div class="insert">+</div><div class="insert">+http://web2py.com</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+</div><div class="insert">+You can use the ``extra`` parameter of ``auth.wiki`` to pass extra rendering rules to the MARKMIN helper.</div><div class="insert">+</div><div class="insert">+You can find more information about the MARKMIN syntax in chapter 5.</div><div class="insert">+</div><div class="insert">+``auth.wiki`` is more powerful than the barebone MARKMIN helpers. In fact it supports oembed and components.</div><div class="insert">+</div><div class="insert">+You can use theS ``env`` parameter of ``auth.wiki`` to expose functions to your wiki.</div><div class="insert">+For example:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.wiki(env=dict(join=lambda a,b,c:&quot;%s-%s-%s&quot; % (a,b,c)))</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+allows you to use the markup syntax:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+@(join:1,2,3)</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+</div><div class="insert">+This call the join function passed as extra with parameters ``a,b,c=1,2,3`` and will be redered as ``1-2-3``.</div><div class="insert">+</div><div class="insert">+#### Oembed protocol</div><div class="insert">+</div><div class="insert">+You can type in (or cut-and-paste) any URL into a wiki page it normally is rendered as a link to the URL. There are exceptions:</div><div class="insert">+</div><div class="insert">+- If the URL has an image extension, the link is embedded as an image, ``&lt;img/&gt;``.</div><div class="insert">+- If the URL has an audio extension, the link is embedded as HTML5 audio ``&lt;audio/&gt;``.</div><div class="insert">+- If the URL has a video extension, the link is embedded as HTML5 video ``&lt;video/&gt;``.</div><div class="insert">+- If the URL has a MS Office or PDF extension, Google Doc Viewer is embedded, showing the content of the document (only works for public documents).</div><div class="insert">+- If the URL points to a Youtube page, a Viemo page, or a Flickr page, web2py contacts the corrsponding web service and queries it about the propor way to embed the contect. This is done using the ``oembed`` protocol.</div><div class="insert">+</div><div class="insert">+Here is a complete list of supported formats:</div><div class="insert">+``</div><div class="insert">+Image (.PNG, .GIF, .JPG, .JPEG)</div><div class="insert">+Audio (.WAV, .OGG, .MP3)</div><div class="insert">+Video (.MOV, .MPE, .MP4, .MPG, .MPG2, .MPEG, .MPEG4, .MOVIE)</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+Supported via Google Doc Viewer:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+Microsoft Excel (.XLS and .XLSX)</div><div class="insert">+Microsoft PowerPoint 2007 / 2010 (.PPTX)</div><div class="insert">+Apple Pages (.PAGES)</div><div class="insert">+Adobe PDF (.PDF)</div><div class="insert">+Adobe Illustrator (.AI)</div><div class="insert">+Adobe Photoshop (.PSD)</div><div class="insert">+Autodesk AutoCad (.DXF)</div><div class="insert">+Scalable Vector Graphics (.SVG)</div><div class="insert">+PostScript (.EPS, .PS)</div><div class="insert">+TrueType (.TTF)</div><div class="insert">+xml Paper Specification (.XPS)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Supported by oembed:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+flickr.com</div><div class="insert">+youtube.com</div><div class="insert">+hulu.com</div><div class="insert">+vimeo.com</div><div class="insert">+slideshare.net</div><div class="insert">+qik.com</div><div class="insert">+polleverywhere.com</div><div class="insert">+wordpress.com</div><div class="insert">+revision3.com</div><div class="insert">+viddler.com</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+This is implemeneted in the web2py file ``gluon.contrib.autolinks`` and specifically in the function ``expand_one``. You can extend oembed support by registering more services. This is done by appending an entry to the ``EMBED_MAPS`` list:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+from gluon.contrib.autlinks import EMBED_MAPS</div><div class="insert">+EMBED_MAPS.append((re.compile(&#x27;http://vimeo.com/\S*&#x27;),</div><div class="insert">+                   &#x27;http://vimeo.com/api/oembed.json&#x27;))</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+#### Referencing wiki content</div><div class="insert">+</div><div class="insert">+If you create a wiki page with slug &quot;contactus&quot; you can refer to this page as</div><div class="insert">+</div><div class="insert">+``\@////contactus``:code</div><div class="insert">+</div><div class="insert">+Here ``\@////`` stands for</div><div class="insert">+</div><div class="insert">+``\@/app/controller/function/``:code</div><div class="insert">+</div><div class="insert">+but &quot;app&quot;, &quot;controller&quot;, and &quot;function&quot; are omitted thus assuming default.</div><div class="insert">+</div><div class="insert">+Similarly you can use the wiki menu to upload a media file (for example an image) linked to the page. The &quot;manage media&quot; page will show all files you have uploaded and will show the proper expression to link the media file. If, for example you upload a file &quot;test.jpg&quot; with title &quot;beach&quot;, the link expression will somthing like:</div><div class="insert">+</div><div class="insert">+``\@////15/beach.jpg``:code</div><div class="insert">+</div><div class="insert">+``\@////`` is the same prefix described before. ``15`` is the id of the record storing the media file. ``beach`` is the title. ``.jpg`` is the extension of the original file.</div><div class="insert">+</div><div class="insert">+If you cut and paste ``\@////15/beach.jpg`` into wiki pages you embed the image.</div><div class="insert">+</div><div class="insert">+Mind that media files are linked to pages and inherit access permission from the pages.</div><div class="insert">+</div><div class="insert">+#### Wiki menus</div><div class="insert">+</div><div class="insert">+If you create a page with slug &quot;wiki-menu&quot; page it will be interpreted as a description of the menu. Here is an example:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+- Home &gt; \@////index</div><div class="insert">+- Info &gt; \@////info</div><div class="insert">+- web2py &gt; http://google.com</div><div class="insert">+- - About us &gt; \@////aboutus</div><div class="insert">+- - Countact us &gt; \@////contactus</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+Each line a menu item. We used double dash for nested menu ites. The ``&gt;`` symbols separates the menu item title from the menu item link.</div><div class="insert">+</div><div class="insert">+Mind that the menu is appended to ``response.menu``. It does not replace it. The ``[wiki]`` menu tem with service functions is added automatically.</div><div class="insert">+</div><div class="insert">+#### Service functions</div><div class="insert">+</div><div class="insert">+If, for example, you want to use the wiki to create an editable sidebar you could create a page with ``slug=&quot;sidebar&quot;`` and then embed it in your layout.html with</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+{{=auth.wiki(slug=&#x27;sidebar&#x27;)}}</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Notice that there is nothing special with the word &quot;sidebar&quot;. Any wiki page can be retrieved and emebdded in any point in your code. This allows you mix and match wiki functionalities with regular web2py functionalities.</div><div class="insert">+</div><div class="insert">+You can also embed special wiki functions as the search by tags:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+{{=auth.wiki(&#x27;_search&#x27;)}}</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+or the tag cloud:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+{{=auth.wiki(&#x27;_cloud&#x27;)}}</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+#### Components</div><div class="insert">+</div><div class="insert">+One of the most powerful function of the new web2py consists in the ability of embedding an action inside another action. We call this a component.</div><div class="insert">+</div><div class="insert">+Consider the following model:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+db.define_table(&#x27;thing&#x27;,Field(&#x27;name&#x27;,requires=IS_NOT_EMPTY()))</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+and the following action:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+@auth.requires_login()</div><div class="insert">+def manage_things():</div><div class="insert">+    return SQLFORM.grid(db.thing)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+This action is special because it returns a widget/helper not a dict of objects. Now we can embed this ``manage_things`` action into any view, with</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+{{=LOAD(&#x27;default&#x27;,&#x27;manage_things&#x27;,ajax=True)}}</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+This allows the visitor interact with the component via Ajax without reloadin the host page that embeds the widget. Basically the action is called via Ajax, inherits the stile of the host page, and capture all forms submissions and flash messages so that thye are handled within the current page. On top of this the ``SQLFORM.grid`` widget uses digitally signed URLs to restrict access. More informaiton about components can be found in chapter 13.</div><div class="insert">+</div><div class="insert">+Components like the one above can be embedded into wiki pages using the MARKMIN syntax:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+@{component:default/manage_things}</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+This simply tells web2py that we want to incude the &quot;manage_things&quot; action defined in the &quot;default&quot; controller as an Ajax &quot;component&quot;.</div><div class="insert">+</div><div class="insert">+---------</div><div class="insert">+Most users will be able to build relatively complex applications simply by using ``auth.wiki`` to create pages and menus, and embedded custom components into wiki pages. Wiki can be tough as a mechanism to allow members of the group to create pages but they calso be though as a way to develop applications in a modular way.</div><div class="insert">+---------</div><div class="insert">+</div><div class="insert">+### More on **admin**</div><div class="insert">+``admin``:inxx</div><div class="insert">+</div><div class="insert">+The administrative interface provides additional functionality that we briefly review here.</div><div class="insert">+</div><div class="insert">+#### Site</div><div class="insert">+``site``:inxx</div><div class="insert">+</div><div class="insert">+This page lists all installed applications. There are two forms at the bottom.</div><div class="insert">+</div><div class="insert">+The first of them allows creating a new application by specifying its name.</div><div class="insert">+</div><div class="insert">+``Instant Press``:inxx ``Movuca``:inxx</div><div class="insert">+The second form allows uploading an existing application from either a local file or a remote URL. When you upload an application, you need to specify a name for it. This can be its original name, but does not need to be. This allows installing multiple copies of the same application. You can try, for example, to upload the Movuca Social Networking application app created by Bruno Rocha:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+http://code.google.com/p/instant-press/</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+or Instant Press CMS created by Martin Mulone:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+http://code.google.com/p/instant-press/</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+or one of the many example applications available at:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+http://web2py.com/appliances</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+------</div><div class="insert">+Web2py files are packages as ``.w2p`` files. These ones are tar gzipped files. Web2py uses the ``.w2p`` extension instead of the ``.tgz`` extension to prevent the browser from unzipping on download. They can be uncompressed manually with ``tar zxvf [filename]`` although this is never necessary.</div><div class="insert">+------</div><div class="insert">+</div><div class="insert">+[[image @///image/en4100.png center 444px]]</div><div class="insert">+</div><div class="insert">+Upon successful upload, web2py displays the MD5 checksum of the uploaded file. You can use it to verify that the file was not corrupted during upload. The InstantPress name will appear in the list of installed applications.</div><div class="insert">+</div><div class="insert">+Click on the application name on admin to get it up and running.</div><div class="insert">+</div><div class="insert">+If you run web2py from source and you have ``pyhton-git`` installed, you can install applications directly from git reporsitory using the ``.git`` URL in the upload form. In this case you will also be used to user the admin interface to push changes back into the repository.</div><div class="insert">+</div><div class="insert">+For each application the &#x27;&#x27;site&#x27;&#x27; page allows you to:</div><div class="insert">+- Uninstall the application.</div><div class="insert">+- Jump to the &#x27;&#x27;about&#x27;&#x27; page (read below).</div><div class="insert">+- Jump to the &#x27;&#x27;edit&#x27;&#x27; page (read below).</div><div class="insert">+- Jump to the &#x27;&#x27;errors&#x27;&#x27; page (read below).</div><div class="insert">+- Clean up temporary files (sessions, errors, and cache.disk files).</div><div class="insert">+- Pack all. This returns a tar file containing a complete copy of the application. We suggest that you clean up temporary files before packing an application.</div><div class="insert">+- Compile the application. If there are no errors, this option will bytecode-compile all models, controllers and views. Because views can extend and include other views in a tree, before bytecode compilation, the view tree for every controller is collapsed into a single file. The net effect is that a bytecode-compiled application is faster, because there is no more parsing of templates or string substitutions occurring at runtime.</div><div class="insert">+- Pack compiled. This option is only present for bytecode-compiled applications. It allows packing the application without source code for distribution as closed source. Note that Python (as any other programming language) can technically be decompiled; therefore compilation does not provide complete protection of the source code. Nevertheless, decompilation can be difficult and can be illegal.</div><div class="insert">+- Remove compiled. It simply removes the byte-code compiled models, views and controllers from the application. If the application was packaged with source code or edited locally, there is no harm in removing the bytecode-compiled files, and the application will continue to work. If the application was installed form a packed compiled file, then this is not safe, because there is no source code to revert to, and the application will no longer work.</div><div class="insert">+</div><div class="insert">+``admin.py``:inxx</div><div class="insert">+</div><div class="insert">+-------</div><div class="insert">+All the functionality available from the web2py admin site page is also accessible programmatically via the API defined in the module ``gluon/admin.py``. Simply open a python shell and import this module.</div><div class="insert">+-------</div><div class="insert">+</div><div class="insert">+If the Google App Engine SDK is installer the admin &#x27;&#x27;site&#x27;&#x27; page shows a button to push your applications to GAE. If ``python-git`` is installed, there is also a button to push your application to Open Shift. To install applications on ``heroku`` or other hosting system you should look into the &quot;scripts&quot; folder for the appropriate script.</div><div class="insert">+</div><div class="insert">+#### About</div><div class="insert">+``about``:inxx ``license``:inxx</div><div class="insert">+</div><div class="insert">+The &#x27;&#x27;about&#x27;&#x27; tab allows editing the description of the application and its license. These are written respectively in the ABOUT and LICENSE files in the application folder.</div><div class="insert">+</div><div class="insert">+[[image @///image/en4300.png center 480px]]</div><div class="insert">+</div><div class="insert">+You can use ``MARKMIN``, or ``gluon.contrib.markdown.WIKI`` syntax for these files as described in ref.``markdown2``:cite .</div><div class="insert">+</div><div class="insert">+#### Design</div><div class="insert">+``EDIT``:inxx</div><div class="insert">+You have used the &#x27;&#x27;edit&#x27;&#x27; page already in this chapter. Here we want to point out a few more functionalities of the &#x27;&#x27;edit&#x27;&#x27; page.</div><div class="insert">+- If you click on any file name, you can see the contents of the file with syntax highlighting.</div><div class="insert">+- If you click on edit, you can edit the file via a web interface.</div><div class="insert">+- If you click on delete, you can delete the file (permanently).</div><div class="insert">+- If you click on test, web2py will run tests. Tests are written by the developer using Python doctests, and each function should have its own tests.</div><div class="insert">+- You can add language files, scan the app to discover all strings, and edit string translations via the web interface.</div><div class="insert">+- If the static files are organized in folders and subfolders, the folder hierarchy can be toggled by clicking on a folder name.</div><div class="insert">+</div><div class="insert">+The image below shows the output of the test page for the welcome application.</div><div class="insert">+</div><div class="insert">+[[image @///image/en4400.png center 480px]]</div><div class="insert">+</div><div class="insert">+The image below show the languages tab for the welcome application.</div><div class="insert">+</div><div class="insert">+[[image @///image/en4500.png center 480px]]</div><div class="insert">+</div><div class="insert">+The image below shows how to edit a language file, in this case the &quot;it&quot; (Italian) language for the welcome application.</div><div class="insert">+</div><div class="insert">+[[image @///image/en4600.png center 480px]]</div><div class="insert">+</div><div class="insert">+##### Intergated debugger</div><div class="insert">+</div><div class="insert">+##### Shell</div><div class="insert">+</div><div class="insert">+If you click on the &quot;shell&quot; link under the controllers tab in &#x27;&#x27;edit&#x27;&#x27;, web2py will open a web based Python shell and will execute the models for the current application. This allows you to interactively talk to your application.</div><div class="insert">+</div><div class="insert">+[[image @///image/en4700.png center 480px]]</div><div class="insert">+</div><div class="insert">+##### Crontab</div><div class="insert">+</div><div class="insert">+Also under the controllers tab in &#x27;&#x27;edit&#x27;&#x27; there is a &quot;crontab&quot; link. By clicking on this link you will be able to edit the web2py crontab file. This follows the same syntax as the unix crontab but does not rely on unix. In fact, it only requires web2py, and it works on Windows. It allows you to register actions that need to be executed in background at scheduled times.</div><div class="insert">+For more information about this, see the next chapter.</div><div class="insert">+</div><div class="insert">+#### Errors</div><div class="insert">+``errors``:inxx</div><div class="insert">+</div><div class="insert">+When programming web2py, you will inevitably make mistakes and introduce bugs. web2py helps in two ways: 1) it allows you to create tests for every function that can be run in the browser from the &#x27;&#x27;edit&#x27;&#x27; page; and 2) when an error manifests itself, a ticket is issued to the visitor and the error is logged.</div><div class="insert">+</div><div class="insert">+Intentionally introduce an error in the images application as shown below:</div><div class="insert">+``</div><div class="insert">+def index():</div><div class="insert">+    images = db().select(db.image.ALL,orderby=db.image.title)</div><div class="insert">+    1/0</div><div class="insert">+    return dict(images=images)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+When you access the index action, you get the following ticket:</div><div class="insert">+</div><div class="insert">+[[image @///image/en4800.png center 480px]]</div><div class="insert">+</div><div class="insert">+Only the administrator can access the ticket:</div><div class="insert">+</div><div class="insert">+[[image @///image/en4900.png center 480px]]</div><div class="insert">+</div><div class="insert">+The ticket shows the traceback, and the content of the file that caused the problem, and the complete state of system (variables, request, session, etc.) If the error occurs in a view, web2py shows the view converted from HTML into Python code. This allows to easily identify the logical structure of the file.</div><div class="insert">+</div><div class="insert">+By default tickets are stored on filesystem and group by traceback. The administrative interface provides an aggregate views (type of traceback and number of occurrence) and a detailed view (all tickets are listed by ticket id). The administrator can switch between the two views.</div><div class="insert">+</div><div class="insert">+Notice that everywhere **admin** shows syntax-highlighted code (for example, in error reports, web2py keywords are shown in orange). If you click on a web2py keyword, you are redirected to a documentation page about the keyword.</div><div class="insert">+</div><div class="insert">+If you fix the divide-by-zero bug in the index action and introduce one in the index view:</div><div class="insert">+``</div><div class="insert">+{{extend &#x27;layout.html&#x27;}}</div><div class="insert">+</div><div class="insert">+&lt;h1&gt;Current Images&lt;/h1&gt;</div><div class="insert">+&lt;ul&gt;</div><div class="insert">+{{for image in images:}}</div><div class="insert">+{{1/0}}</div><div class="insert">+{{=LI(A(image.title, _href=URL(&quot;show&quot;, args=image.id)))}}</div><div class="insert">+{{pass}}</div><div class="insert">+&lt;/ul&gt;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+you get the following ticket:</div><div class="insert">+</div><div class="insert">+[[image @///image/en5000.png center 480px]]</div><div class="insert">+</div><div class="insert">+Note that web2py has converted the view from HTML into a Python file, and the error described in the ticket refers to the generated Python code and NOT to the original view file:</div><div class="insert">+</div><div class="insert">+[[image @///image/en5100.png center 480px]]</div><div class="insert">+</div><div class="insert">+This may seem confusing at first, but in practice it makes debugging easier, because the Python indentation highlights the logical structure of the code that you embedded in the views.</div><div class="insert">+</div><div class="insert">+The code is shown at the bottom of the same page.</div><div class="insert">+</div><div class="insert">+All tickets are listed under admin in the &#x27;&#x27;errors&#x27;&#x27; page for each application:</div><div class="insert">+</div><div class="insert">+[[image @///image/en5200.png center 480px]]</div><div class="insert">+</div><div class="insert">+#### Mercurial</div><div class="insert">+``Mercurial``:inxx</div><div class="insert">+</div><div class="insert">+If you are running from source and you have the Mercurial version control libraries installed:</div><div class="insert">+``</div><div class="insert">+easy_install mercurial</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+then the administrative interface shows one more menu item called &quot;Versioning&quot;. It automatically creates a local Mercurial repository for the application. Pressing the &quot;commit&quot; button in the page will commit the current application. Mercurial creates and stores information about changes you make in your code into a hidden folder &quot;.hg&quot; in your app subfolder. Every app has its own &quot;.hg&quot; folder and its own &quot;.hgignore&quot; file (tells Mercurial which files to ignore).</div><div class="insert">+</div><div class="insert">+The Mercurial web interface does allow you to browse previous commit and diff files but we do recommend you use Mercurial directly from the shell or one of the many GUI-based Mercurial clients since they are more powerful. For example they will allow you sync your app with a remote source repository:</div><div class="insert">+</div><div class="insert">+[[images @///image/en5300.png center 480px]]</div><div class="insert">+</div><div class="insert">+</div><div class="insert">+You can read more about Mercurial here:</div><div class="insert">+``</div><div class="insert">+http://mercurial.selenic.com/</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+#### Application Wizard (experimental)</div><div class="insert">+</div><div class="insert">+The **admin** interface includes a Wizard that can help you create a new applications.</div><div class="insert">+You can access the wizard from the &quot;sites&quot; page as shown in the image below.</div><div class="insert">+</div><div class="insert">+[[image @///image/en5400.png center 480px]]</div><div class="insert">+</div><div class="insert">+The wizard will guide you through a series of steps involved in creating a new application:</div><div class="insert">+</div><div class="insert">+- Chose a name for the application</div><div class="insert">+- Configure the application and choose required plugins</div><div class="insert">+- Build required models (it will create CRUD pages for each model)</div><div class="insert">+- Allow you to edit the views of those pages using MARKMIN syntax</div><div class="insert">+</div><div class="insert">+The image below shows the second step of the process.</div><div class="insert">+</div><div class="insert">+[[image @///image/en5500.png center 480px]]</div><div class="insert">+</div><div class="insert">+You can see a dropdown to select a layout plugin (from ``web2py.com/layouts``), a multiple choice dropdown to check other plugins (from ``web2py.com/plugins``) and a &quot;login config&quot; field where to put the Janrain &quot;domain:key&quot;.</div><div class="insert">+</div><div class="insert">+The other steps are pretty much self-explanatory.</div><div class="insert">+</div><div class="insert">+The Wizard works well for what it does but it is considered an &#x27;&#x27;experimental feature&#x27;&#x27; for two reasons:</div><div class="insert">+</div><div class="insert">+- Applications created with the wizard and edited manually, cannot later be modified by the wizard.</div><div class="insert">+- The interface of the wizard will change over time to include support for more features and easier visual development.</div><div class="insert">+</div><div class="insert">+In any case the wizard is a handy tool for fast prototyping and it can be used to bootstrap a new application with an alternate layout and optional plugins.</div><div class="insert">+</div><div class="insert">+#### Configuring **admin**</div><div class="insert">+</div><div class="insert">+Normally there is no need to perform any configuration of admin but a few customizations are possible. After you login into admin you can edit the admin configuration file via the URL:</div><div class="insert">+``</div><div class="insert">+http://127.0.0.1:8000/admin/default/edit/admin/models/0.py</div><div class="insert">+``</div><div class="insert">+Notice that **admin** can be used to edit itself. In fact **admin** is an app as any other one.</div><div class="insert">+</div><div class="insert">+The file &quot;0.py&quot; is very much self documented and if you are opening probably you already know what you are looking for. Anyway few customizations exist that are more important than others:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+GAE_APPCFG = os.path.abspath(os.path.join(&#x27;/usr/local/bin/appcfg.py&#x27;))</div><div class="insert">+``</div><div class="insert">+This should point to the location of the &quot;appcfg.py&quot; file that comes with the Google App Engine SDK. If you have the SDK you may want to change this config parameters to the correct value. It will allow you to deploy to GAE from the admin interface.</div><div class="insert">+</div><div class="insert">+``DEMO_MODE``:inxx</div><div class="insert">+</div><div class="insert">+You can also set web2py admin in demo mode:</div><div class="insert">+``</div><div class="insert">+DEMO_MODE = True</div><div class="insert">+FILTER_APPS = [&#x27;welcome&#x27;]</div><div class="insert">+``</div><div class="insert">+And only the apps listed in filter apps will be accessible and they will be only accessible in read-only mode.</div><div class="insert">+</div><div class="insert">+``MULTI_USER_MODE``:inxx</div><div class="insert">+``virtual laboratory``:inxx</div><div class="insert">+</div><div class="insert">+If you are a teacher and want to expose the administrative interface to students so that students can share one administrative interface for their projects (think of a virtual lab), can do it by setting:</div><div class="insert">+``</div><div class="insert">+MULTI_USER_MODE = True</div><div class="insert">+``</div><div class="insert">+In this way students will be required to login and will only be able to access their own apps via admin. You, as first user/teacher, will be able to access them all.</div><div class="insert">+</div><div class="insert">+In multi user mode, you can register students using the &quot;bulk register&quot; link in admin and manage them using the &quot;manage students&quot; link. The system also keep track of when students login and how many lines of code add/remove to/from their code. This data is presented to the administrator as charts under the application &quot;about&quot; page.</div><div class="insert">+</div><div class="insert">+Mind that this mechanism still assumes all users are trusted. All the apps created under admin run under the same credentials on the same filesystem. It is possible for an app created by a student to access the data and the source of an app created by another student. It is also possible for a student to create an app that locks the server.</div><div class="insert">+</div><div class="insert">+#### Mobile **admin**</div><div class="insert">+</div><div class="insert">+Notice that the admin application includes &quot;plugin_jqmodile&quot; which packages jQuery Mobile. When admin is accessed from a mobile devide, this is detected by web2py and the interface is displayed using a mobile friendly layout.</div><div class="insert">+</div><div class="insert">+### More on **appadmin**</div><div class="insert">+</div><div class="insert">+``appadmin``:inxx</div><div class="insert">+</div><div class="insert">+**appadmin** is not intended to be exposed to the public. It is designed to help you by providing an easy access to the database. It consists of only two files: a controller &quot;appadmin.py&quot; and a view &quot;appadmin.html&quot; which are used by all actions in the controller.</div><div class="insert">+</div><div class="insert">+The **appadmin** controller is relatively small and readable; it provides an example of designing a database interface.</div><div class="insert">+</div><div class="insert">+**appadmin** shows which databases are available and which tables exist in each database. You can insert records and list all records for each table individually. **appadmin** paginates output 100 records at a time.</div><div class="insert">+</div><div class="insert">+Once a set of records is selected, the header of the pages changes, allowing you to update or delete the selected records.</div><div class="insert">+</div><div class="insert">+To update the records, enter an SQL assignment in the Query string field:</div><div class="insert">+``</div><div class="insert">+title = &#x27;test&#x27;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+where string values must be enclosed in single quotes. Multiple fields can be separated by commas.</div><div class="insert">+</div><div class="insert">+To delete a record, click the corresponding checkbox to confirm that you are sure.</div><div class="insert">+</div><div class="insert">+**appadmin** can also perform joins if the SQL FILTER contains a SQL condition that involves two or more tables. For example, try:</div><div class="insert">+``</div><div class="insert">+db.image.id == db.comment.image_id</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+web2py passes this along to the DAL, and it understands that the query links two tables; hence, both tables are selected with an INNER JOIN. Here is the output:</div><div class="insert">+</div><div class="insert">+[[image @///image/en5600.png center 480px]]</div><div class="insert">+</div><div class="insert">+If you click on the number of an id field, you get an edit page for the record with the corresponding id.</div><div class="insert">+</div><div class="insert">+If you click on the number of a reference field, you get an edit page for the referenced record.</div><div class="insert">+</div><div class="insert">+You cannot update or delete rows selected by a join, because they involve records from multiple tables and this would be ambiguous.</div><div class="insert">+</div><div class="insert">+In addition to its database administration capabilities, **appadmin** also enables you to view details about the contents of the application&#x27;s ``cache`` (at ``/yourapp/appadmin/ccache``) as well as the contents of the current ``request``, ``response``, and ``session`` objects (at ``/yourapp/appadmin/state``).</div><div class="insert">+</div><div class="insert">+------</div><div class="insert">+**appadmin** replaces ``response.menu`` with its own menu, which provides links to the application&#x27;s **edit** page in **admin**, the **db** (database administration) page, the **state** page, and the **cache** page. If your application&#x27;s layout does not generate a menu using ``response.menu``, then you will not see the **appadmin** menu. In that case, you can modify the appadmin.html file and add ``{{=MENU(response.menu)}}`` to display the menu.</div><div class="insert">+------</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">-## Overview</div><div class="delete">-</div><div class="delete">-### Startup</div><div class="delete">-</div><div class="delete">-``Linux``:inxx ``Mac``:inxx ``Windows``:inxx</div><div class="delete">-</div><div class="delete">-web2py comes in binary packages for Windows and Mac OS X. They include the Python interpreter so you do not need to have it pre-installed. There is also a source code version that runs on Windows, Mac, Linux, and other Unix systems. The Windows and OS X binary versions include the necessary Python interpreter. The source code package assumes that Python is already installed on the computer.</div><div class="delete">-</div><div class="delete">-web2py requires no installation. To get started, unzip the downloaded zip file for your specific operating system and execute the corresponding ``web2py`` file.</div><div class="delete">-</div><div class="delete">-On Unix and Linux (source distribution), run:</div><div class="delete">-``</div><div class="delete">-python web2py.py</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-On OS X (binary distribution), run:</div><div class="delete">-``</div><div class="delete">-open web2py.app</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-On Windows (binary web2py distribution), run:</div><div class="delete">-``</div><div class="delete">-web2py.exe</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-On Windows (source web2py distribution), run:</div><div class="delete">-``</div><div class="delete">-c:/Python27/python.exe web2py.exe</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Attention, to run web2py on Windows from source you must install first Mark Hammond&#x27;s [[Python for Windows extensions http://sourceforge.net/projects/pywin32/]]</div><div class="delete">-</div><div class="delete">-The web2py program accepts various command line options which are discussed later.</div><div class="delete">-</div><div class="delete">-By default, at startup, web2py displays a startup window and then displays a GUI widget that asks you to choose a one-time administrator password, the IP address of the network interface to be used for the web server, and a port number from which to serve requests. By default, web2py runs its web server on 127.0.0.1:8000 (port 8000 on localhost), but you can run it on any available IP address and port. You can query the IP address of your network interface by opening a command line and typing ``ipconfig`` on Windows or ``ifconfig`` on OS X and Linux. From now on we assume web2py is running on localhost (127.0.0.1:8000). Use 0.0.0.0:80 to run web2py publicly on any of your network interfaces.</div><div class="delete">-</div><div class="delete">-[[image @///image/en400.png center 306px]]</div><div class="delete">-</div><div class="delete">-If you do not provide an administrator password, the administration interface is disabled. This is a security measure to prevent publicly exposing the admin interface.</div><div class="delete">-</div><div class="delete">-The administrative interface, **admin**, is only accessible from localhost unless you run web2py behind Apache with mod_proxy. If **admin** detects a proxy, the session cookie is set to secure and **admin** login does not work unless the communication between the client and the proxy goes over HTTPS; this is a security measure. All communications between the client and **admin** must always be local or encrypted; otherwise an attacker would be able to perform a man-in-the middle attack or a replay attack and execute arbitrary code on the server.</div><div class="delete">-</div><div class="delete">-After the administration password has been set, web2py starts up the web browser at the page:</div><div class="delete">-``</div><div class="delete">-http://127.0.0.1:8000/</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-If the computer does not have a default browser, open a web browser and enter the URL.</div><div class="delete">-</div><div class="delete">-[[image @///image/en500.png center 480px]]</div><div class="delete">-</div><div class="delete">-Clicking on &quot;administrative interface&quot; takes you to the login page for the administration interface.</div><div class="delete">-</div><div class="delete">-[[image @///image/en600.png center 480px]]</div><div class="delete">-</div><div class="delete">-The administrator password is the password you chose at startup.</div><div class="delete">-Notice that there is only one administrator, and therefore only one administrator password. For security reasons, the developer is asked to choose a new password every time web2py starts unless the &lt;recycle&gt; option is specified. This is distinct from the authentication mechanism in web2py applications.</div><div class="delete">-</div><div class="delete">-After the administrator logs into web2py, the browser is redirected to the &quot;site&quot; page.</div><div class="delete">-</div><div class="delete">-[[image @///image/en700.png center 480px]]</div><div class="delete">-</div><div class="delete">-This page lists all installed web2py applications and allows the administrator to manage them.</div><div class="delete">-web2py comes with three applications:</div><div class="delete">-``admin``:inxx ``examples``:inxx ``welcome``:inxx ``scaffolding``:inxx</div><div class="delete">-- An **admin** application, the one you are using right now.</div><div class="delete">-- An **examples** application, with the online interactive documentation and a replica of the web2py official website.</div><div class="delete">-- A **welcome** application. This is the basic template for any other web2py application. It is referred to as the scaffolding application. This is also the application that welcomes a user at startup.</div><div class="delete">-</div><div class="delete">-``appliances``:inxx</div><div class="delete">-Ready-to-use web2py applications are referred to as web2py &#x27;&#x27;appliances&#x27;&#x27;.  You can download many freely available appliances from ``appliances``:cite . web2py users are encouraged to submit new appliances, either in open-source or closed-source (compiled and packed) form.</div><div class="delete">-</div><div class="delete">-From the **admin** application&#x27;s &#x27;&#x27;site&#x27;&#x27; page, you can perform the following operations:</div><div class="delete">-- **install** an application by completing the form on the bottom right of the page. Give a name to the application, select the file containing a packaged application or the URL where the application is located, and click &quot;submit&quot;.</div><div class="delete">-- **uninstall** an application by clicking the corresponding button. There is a confirmation page.</div><div class="delete">-- **create** a new application by choosing a name and clicking &quot;create&quot;.</div><div class="delete">-- **package** an application for distribution by clicking on the corresponding button. A downloaded application is a tar file containing everything, including the database. You should not untar this file; it is automatically unpackaged by web2py when installed with **admin**.</div><div class="delete">-- **clean up** an application&#x27;s temporary files, such as sessions, errors and cache files.</div><div class="delete">-- **EDIT** an application.</div><div class="delete">-</div><div class="delete">-When you create a new application using **admin**, it starts as a clone of the &quot;welcome&quot; scaffolding app with a &quot;models/db.py&quot; that creates a SQLite database, connects to it, instantiates Auth, Crud, and Service, configures them. It also provides a &quot;controller/default.py&quot; which exposes actions &quot;index&quot;, &quot;download&quot;, &quot;user&quot; for user management, and &quot;call&quot; for services. In the following, we assume that these files have been removed; we will be creating apps from scratch.</div><div class="delete">-</div><div class="delete">-web2py also comes with a **wizard**, described later in this chapter, that can write an alternate scaffolding code for you based on layouts and plugins available on the web and based on high level description of the models.</div><div class="delete">-</div><div class="delete">-### Simple examples</div><div class="delete">-</div><div class="delete">-#### Say hello</div><div class="delete">-``index``:inxx</div><div class="delete">-</div><div class="delete">-Here, as an example, we create a simple web app that displays the message &quot;Hello from MyApp&quot; to the user. We will call this application &quot;myapp&quot;. We will also add a counter that counts how many times the same user visits the page.</div><div class="delete">-</div><div class="delete">-You can create a new application simply by typing its name in the form on the top right of the **site** page in **admin**.</div><div class="delete">-</div><div class="delete">-[[image @///image/en800.png center 447px]]</div><div class="delete">-</div><div class="delete">-After you press [create], the application is created as a copy of the built-in welcome application.</div><div class="delete">-</div><div class="delete">-[[image @///image/en900.png center 480px]]</div><div class="delete">-</div><div class="delete">-To run the new application, visit:</div><div class="delete">-``</div><div class="delete">-http://127.0.0.1:8000/myapp</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Now you have a copy of the welcome application.</div><div class="delete">-</div><div class="delete">-To edit an application, click on the &#x27;&#x27;edit&#x27;&#x27; button for the newly created application.</div><div class="delete">-</div><div class="delete">-The **edit** page tells you what is inside the application.</div><div class="delete">-Every web2py application consists of certain files, most of which fall into one of six categories:</div><div class="delete">-- **models**: describe the data representation.</div><div class="delete">-- **controllers**: describe the application logic and workflow.</div><div class="delete">-- **views**: describe the data presentation.</div><div class="delete">-- **languages**: describe how to translate the application presentation to other languages.</div><div class="delete">-- **modules**: Python modules that belong to the application.</div><div class="delete">-- **static files**: static images, CSS  files``css-w,css-o,css-school``:cite , JavaScript files``js-w,js-b``:cite , etc.</div><div class="delete">-- **plugins**: groups of files designed to work together.</div><div class="delete">- </div><div class="delete">-Everything is neatly organized following the Model-View-Controller design pattern. Each section in the &#x27;&#x27;edit&#x27;&#x27; page corresponds to a subfolder in the application folder.</div><div class="delete">-</div><div class="delete">-Notice that section headings will toggle their content. Folder names under static files are also collapsible.</div><div class="delete">-</div><div class="delete">-Each file listed in the section corresponds to a file physically located in the subfolder. Any operation performed on a file via the **admin** interface (create, edit, delete) can be performed directly from the shell using your favorite editor.</div><div class="delete">-</div><div class="delete">-The application contains other types of files (database, session files, error files, etc.), but they are not listed on the &#x27;&#x27;edit&#x27;&#x27; page because they are not created or modified by the administrator; they are created and modified by the application itself.</div><div class="delete">-</div><div class="delete">-The controllers contain the logic and workflow of the application. Every URL gets mapped into a call to one of the functions in the controllers (actions). There are two default controllers: &quot;appadmin.py&quot; and &quot;default.py&quot;. **appadmin** provides the database administrative interface; we do not need it now. &quot;default.py&quot; is the controller that you need to edit, the one that is called by default when no controller is specified in the URL. Edit the &quot;index&quot; function as follows:</div><div class="delete">-``</div><div class="delete">-def index():</div><div class="delete">-    return &quot;Hello from MyApp&quot;</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Here is what the online editor looks like:</div><div class="delete">-</div><div class="delete">-[[image @///image/en1000.png center 480px]]</div><div class="delete">-</div><div class="delete">-Save it and go back to the &#x27;&#x27;edit&#x27;&#x27; page. Click on the index link to visit the newly created page.</div><div class="delete">-</div><div class="delete">-When you visit the URL</div><div class="delete">-``</div><div class="delete">-http://127.0.0.1:8000/myapp/default/index</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-the index action in the default controller of the myapp application is called. It returns a string that the browser displays for us. It should look like this:</div><div class="delete">-</div><div class="delete">-[[image @///image/en1100.png center 480px]]</div><div class="delete">-</div><div class="delete">-Now, edit the &quot;index&quot; function as follows:</div><div class="delete">-``</div><div class="delete">-def index():</div><div class="delete">-    return dict(message=&quot;Hello from MyApp&quot;)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Also from the &#x27;&#x27;edit&#x27;&#x27; page, edit the view &quot;default/index.html&quot; (the view file associated with the action) and completely replace the existing contents of that file with the following:</div><div class="delete">-``</div><div class="delete">-&lt;html&gt;</div><div class="delete">-   &lt;head&gt;&lt;/head&gt;</div><div class="delete">-   &lt;body&gt;</div><div class="delete">-      &lt;h1&gt;{{=message}}&lt;/h1&gt;</div><div class="delete">-   &lt;/body&gt;</div><div class="delete">-&lt;/html&gt;</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Now the action returns a dictionary defining a ``message``. When an action returns a dictionary, web2py looks for a view with the name</div><div class="delete">-</div><div class="delete">-``[controller]/[function].[extension]``:code</div><div class="delete">-</div><div class="delete">- and executes it. Here [extension] is the requested extension. If no extension is specified, it defaults to &quot;html&quot;, and that is what we will assume here. Under this assumption, the view is an HTML file that embeds Python code using special {{ }} tags. In particular, in the example, the ``{{=message}}`` instructs web2py to replace the tagged code with the value of the ``message`` returned by the action. Notice that ``message`` here is not a web2py keyword but is defined in the action. So far we have not used any web2py keywords.</div><div class="delete">-</div><div class="delete">-If web2py does not find the requested view, it uses the &quot;generic.html&quot; view that comes with every application.</div><div class="delete">-</div><div class="delete">-``Mac Mail``:inxx ``Google Maps``:inxx ``jsonp``:inxx</div><div class="delete">-If an extension other than &quot;html&quot; is specified (&quot;json&quot; for example), and the view file &quot;[controller]/[function].json&quot; is not found, web2py looks for the view &quot;generic.json&quot;. web2py comes with generic.html, generic.json, generic.jsonp, generic.xml, generic.rss, generic.ics (for Mac Mail Calendar), generic.map (for embedding Google Maps), and generic.pdf (based on fpdf). These generic views can be modified for each application individually, and additional views can be added easily.</div><div class="delete">-</div><div class="delete">-Generic views are a development tool. In production every action should have its own view. In fact, by default, generic views are only enabled from localhost.</div><div class="delete">-</div><div class="delete">-You can also specify a view with ``response.view = &#x27;default/something.html&#x27;``</div><div class="delete">-</div><div class="delete">-Read more on this topic in Chapter 10.</div><div class="delete">-</div><div class="delete">-If you go back to &quot;EDIT&quot; and click on index, you will now see the following HTML page:</div><div class="delete">-</div><div class="delete">-[[image @///image/en1200.png center 480px]]</div><div class="delete">-</div><div class="delete">-For debugging purposes you can always append</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-{{=response.toolbar()}}</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-to the code in a view and it will show you some useful information, including the request, response and session objects, and list all db queries with their timing.</div><div class="delete">-</div><div class="delete">-#### Let&#x27;s count</div><div class="delete">-``session``:inxx</div><div class="delete">-Let&#x27;s now add a counter to this page that will count how many times the same visitor displays the page.</div><div class="delete">-</div><div class="delete">-web2py automatically and transparently tracks visitors using sessions and cookies. For each new visitor, it creates a session and assigns a unique &quot;session_id&quot;. The session is a container for variables that are stored server-side. The unique id is sent to the browser via a cookie. When the visitor requests another page from the same application, the browser sends the cookie back, it is retrieved by web2py, and the corresponding session is restored.</div><div class="delete">-</div><div class="delete">-To use the session, modify the default controller:</div><div class="delete">-``</div><div class="delete">-def index():</div><div class="delete">-    if not session.counter:</div><div class="delete">-        session.counter = 1</div><div class="delete">-    else:</div><div class="delete">-        session.counter += 1</div><div class="delete">-    return dict(message=&quot;Hello from MyApp&quot;, counter=session.counter)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Notice that ``counter`` is not a web2py keyword but ``session`` is. We are asking web2py to check whether there is a counter variable in the session and, if not, to create one and set it to 1. If the counter is there, we ask web2py to increase the counter by 1. Finally we pass the value of the counter to the view.</div><div class="delete">-</div><div class="delete">-A more compact way to code the same function is this:</div><div class="delete">-``</div><div class="delete">-def index():</div><div class="delete">-    session.counter = (session.counter or 0) + 1</div><div class="delete">-    return dict(message=&quot;Hello from MyApp&quot;, counter=session.counter)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Now modify the view to add a line that displays the value of the counter:</div><div class="delete">-``</div><div class="delete">-&lt;html&gt;</div><div class="delete">-   &lt;head&gt;&lt;/head&gt;</div><div class="delete">-   &lt;body&gt;</div><div class="delete">-      &lt;h1&gt;{{=message}}&lt;/h1&gt;</div><div class="delete">-      &lt;h2&gt;Number of visits: {{=counter}}&lt;/h2&gt;</div><div class="delete">-   &lt;/body&gt;</div><div class="delete">-&lt;/html&gt;</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-When you visit the index page again (and again) you should get the following HTML page:</div><div class="delete">-</div><div class="delete">-[[image @///image/en1300.png center 480px]]</div><div class="delete">-</div><div class="delete">-The counter is associated with each visitor, and is incremented each time the visitor reloads the page. Different visitors see different counters.</div><div class="delete">-</div><div class="delete">-</div><div class="delete">-#### Say my name</div><div class="delete">-``form``:inxx ``request.vars``:inxx</div><div class="delete">-</div><div class="delete">-Now create two pages (first and second), where the first page creates a form, asks the visitor&#x27;s name, and redirects to the second page, which greets the visitor by name.</div><div class="delete">-</div><div class="delete">-[[yUML diagram @///image/en1400.png center 200px]]</div><div class="delete">-</div><div class="delete">-Write the corresponding actions in the default controller:</div><div class="delete">-``</div><div class="delete">-def first():</div><div class="delete">-    return dict()</div><div class="delete">-</div><div class="delete">-def second():</div><div class="delete">-    return dict()</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Then create a view &quot;default/first.html&quot; for the first action,</div><div class="delete">-and enter:</div><div class="delete">-``</div><div class="delete">-{{extend &#x27;layout.html&#x27;}}</div><div class="delete">-&lt;h1&gt;What is your name?&lt;/h1&gt;</div><div class="delete">-&lt;form action=&quot;second&quot;&gt;</div><div class="delete">-  &lt;input name=&quot;visitor_name&quot; /&gt;</div><div class="delete">-  &lt;input type=&quot;submit&quot; /&gt;</div><div class="delete">-&lt;/form&gt;</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Finally, create a view &quot;default/second.html&quot; for the second action:</div><div class="delete">-``</div><div class="delete">-{{extend &#x27;layout.html&#x27;}}</div><div class="delete">-&lt;h1&gt;Hello {{=request.vars.visitor_name}}&lt;/h1&gt;</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-``layout``:inxx</div><div class="delete">-In both views we have extended the basic &quot;layout.html&quot; view that comes with web2py. The layout view keeps the look and feel of the two pages coherent. The layout file can be edited and replaced easily, since it mainly contains HTML code.</div><div class="delete">-</div><div class="delete">-If you now visit the first page, type your name:</div><div class="delete">-</div><div class="delete">-[[image @///image/en1500.png center 480px]]</div><div class="delete">-</div><div class="delete">-and submit the form, you will receive a greeting:</div><div class="delete">-</div><div class="delete">-[[image @///image/en1600.png center 480px]]</div><div class="delete">-</div><div class="delete">-#### Postbacks</div><div class="delete">-``redirect``:inxx ``URL``:inxx ``postback``:inxx</div><div class="delete">-</div><div class="delete">-The mechanism for form submission that we used before is very common, but it is not good programming practice. All input should be validated and, in the above example, the burden of validation would fall on the second action. Thus the action that performs the validation is different from the action that generated the form. This tends to cause redundancy in the code.</div><div class="delete">-</div><div class="delete">-A better pattern for form submission is to submit forms to the same action that generated them, in our example the &quot;first&quot;. The &quot;first&quot; action should receive the variables, process them, store them server-side, and redirect the visitor to the &quot;second&quot; page, which retrieves the variables. This mechanism is called a &#x27;&#x27;postback&#x27;&#x27;.</div><div class="delete">-</div><div class="delete">-[[yUML diagram @///image/en1700.png center 200px]]</div><div class="delete">-</div><div class="delete">-Modify the default controller to implement self-submission:</div><div class="delete">-``</div><div class="delete">-def first():</div><div class="delete">-    if request.vars.visitor_name:</div><div class="delete">-        session.visitor_name = request.vars.visitor_name</div><div class="delete">-        redirect(URL(&#x27;second&#x27;))</div><div class="delete">-    return dict()</div><div class="delete">-</div><div class="delete">-def second():</div><div class="delete">-    return dict()</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Then modify the &quot;default/first.html&quot; view:</div><div class="delete">-``</div><div class="delete">-{{extend &#x27;layout.html&#x27;}}</div><div class="delete">-What is your name?</div><div class="delete">-&lt;form&gt;</div><div class="delete">-  &lt;input name=&quot;visitor_name&quot; /&gt;</div><div class="delete">-  &lt;input type=&quot;submit&quot; /&gt;</div><div class="delete">-&lt;/form&gt;</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-and the &quot;default/second.html&quot; view needs to retrieve the data from the ``session`` instead of from the ``request.vars``:</div><div class="delete">-``</div><div class="delete">-{{extend &#x27;layout.html&#x27;}}</div><div class="delete">-&lt;h1&gt;Hello {{=session.visitor_name or &quot;anonymous&quot;}}&lt;/h1&gt;</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-From the point of view of the visitor, the self-submission behaves exactly the same as the previous implementation. We have not added validation yet, but it is now clear that validation should be performed by the first action.</div><div class="delete">-</div><div class="delete">-This approach is better also because the name of the visitor stays in the session, and can be accessed by all actions and views in the applications without having to be passed around explicitly.</div><div class="delete">-</div><div class="delete">-Note that if the &quot;second&quot; action is ever called before a visitor name is set, it will display &quot;Hello anonymous&quot; because  ``session.visitor_name`` returns ``None``. Alternatively we could have added the following code in the controller (inside the ``second`` function):</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-if not request.function==&#x27;first&#x27; and not session.visitor_name:</div><div class="delete">-    redirect(URL(&#x27;first&#x27;))</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-This is a general mechanism that you can use to enforce authorization on controllers, though see Chapter 9 for a more powerful method.</div><div class="delete">-</div><div class="delete">-``FORM``:inxx ``INPUT``:inxx ``requires``:inxx ``IS_NOT_EMPTY``:inxx ``accepts``:inxx</div><div class="delete">-</div><div class="delete">-With web2py we can move one step further and ask web2py to generate the form for us, including validation. web2py provides helpers (FORM, INPUT, TEXTAREA, and SELECT/OPTION) with the same names as the equivalent HTML tags. They can be used to build forms either in the controller or in the view.</div><div class="delete">-</div><div class="delete">-For example, here is one possible way to rewrite the first action:</div><div class="delete">-``</div><div class="delete">-def first():</div><div class="delete">-    form = FORM(INPUT(_name=&#x27;visitor_name&#x27;, requires=IS_NOT_EMPTY()),</div><div class="delete">-              INPUT(_type=&#x27;submit&#x27;))</div><div class="delete">-    if form.process().accepted:</div><div class="delete">-        session.visitor_name = form.vars.visitor_name</div><div class="delete">-        redirect(URL(&#x27;second&#x27;))</div><div class="delete">-    return dict(form=form)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-where we are saying that the FORM tag contains two INPUT tags. The attributes of the input tags are specified by the named arguments starting with underscore. The ``requires`` argument is not a tag attribute (because it does not start by underscore) but it sets a validator for the value of visitor_name.</div><div class="delete">-</div><div class="delete">-Here is yet another better way to create the same form:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-def first():</div><div class="delete">-    form = SQLFORM.factory(Field(&#x27;visitor_name&#x27;, </div><div class="delete">-                                 label=&#x27;what is yout name?&#x27;,</div><div class="delete">-                                 requires=IS_NOT_EMPTY()))</div><div class="delete">-    if form.process().accepted:</div><div class="delete">-        session.visitor_name = form.vars.visitor_name</div><div class="delete">-        redirect(URL(&#x27;second&#x27;))</div><div class="delete">-    return dict(form=form)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-The ``form`` object can be easily serialized in HTML by embedding it in the &quot;default/first.html&quot; view.</div><div class="delete">-``</div><div class="delete">-{{extend &#x27;layout.html&#x27;}}</div><div class="delete">-{{=form}}</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-The ``form.process()`` method applies the validators and returns the form itself. The ``form.accepted`` variable is set to True if the form was processed and passed validation. If the self-submitted form passes validation, it stores the variables in the session and redirects as before. If the form does not pass validation, error messages are inserted into the form and shown to the user, as below:</div><div class="delete">-</div><div class="delete">-[[image @///image/en1800.png center 480px]]</div><div class="delete">-</div><div class="delete">-In the next section we will show how forms can be generated automatically from a model.</div><div class="delete">-</div><div class="delete">-In all or examples we have used the session to pass the user name from the first action to the second. We could have used a different mechanism and pass data as part of a redirect URL:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-def first():</div><div class="delete">-    form = SQLFORM.factory(Field(&#x27;visitor_name&#x27;, requires=IS_NOT_EMPTY()))</div><div class="delete">-    if form.process().accepted:</div><div class="delete">-        name = form.vars.visitor_name</div><div class="delete">-        redirect(URL(&#x27;second&#x27;,vars=dict(name=name)))</div><div class="delete">-    return dict(form=form)</div><div class="delete">-</div><div class="delete">-def second():</div><div class="delete">-    name = request.vars.visitor_name or redirect(URL(&#x27;first&#x27;))</div><div class="delete">-    return dict(name=name)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-#### Internationalization</div><div class="delete">-</div><div class="delete">-You code is likely to include hardcoded strings such as &quot;What is your name?&quot;. You should be able to customize strings without editing the code and in particular insert translations for these strings in different languages. In this wasy if a visitor has the language preference of the browser set to &quot;Italian&quot;, web2py will use the Italian translation for the strings, if available. This feature of web2py is called &quot;internationalization&quot; and it is described in more detail in the next chapter.</div><div class="delete">-</div><div class="delete">-Here we just observe that in order to use this feature you should markup strings that need stranslation. This is done by wrapping a a quoted string in code such as </div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-&quot;What is your name?&quot;</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-with the ``T`` operator:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-T(&quot;What is your name?&quot;)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-</div><div class="delete">-You can also mark fo translations strings hardcoded in views. For example</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-&lt;h1&gt;What is your name?&lt;/h1&gt;</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-becomes</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-&lt;h1&gt;{{=T(&quot;What is your name?&quot;)}}&lt;/h1&gt;</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-It is good practice to do this for every string in the code (field labels, flash messages, etc.) except for tables and field names.</div><div class="delete">-</div><div class="delete">-Once the strings are indentified and marked up, web2py takes care of almost evrything else. The admin interface also provides a page where you can translate each string in the languages you desire to support.</div><div class="delete">-</div><div class="delete">-### An image blog</div><div class="delete">-``upload``:inxx</div><div class="delete">-</div><div class="delete">-Here, as another example, we wish to create a web application that allows the administrator to post images and give them a name, and allows the visitors of the web site to view the named images and submit comments.</div><div class="delete">-</div><div class="delete">-As before, from the **site** page in **admin**, create a new application called ``images``, and navigate to the &#x27;&#x27;edit&#x27;&#x27; page:</div><div class="delete">-</div><div class="delete">-[[image @///image/en1900.png center 480px]]</div><div class="delete">-</div><div class="delete">-We start by creating a model, a representation of the persistent data in the application (the images to upload, their names, and the comments). First, you need to create/edit a model file which, for lack of imagination, we call &quot;db.py&quot;. We assume the code below will replace any existing code in &quot;db.py&quot;. Models and controllers must have a ``.py`` extension since they are Python code. If the extension is not provided, it is appended by web2py. Views instead have a ``.html`` extension since they mainly contain HTML code.</div><div class="delete">-</div><div class="delete">-Edit the &quot;db.py&quot; file by clicking the corresponding &quot;edit&quot; button:</div><div class="delete">-</div><div class="delete">-[[image @///image/en2000.png center 480px]]</div><div class="delete">-</div><div class="delete">-and enter the following:</div><div class="delete">-</div><div class="delete">-``IS_EMAIL``:inxx ``IS_NOT_EMPTY``:inxx ``IS_IN_DB``:inxx</div><div class="delete">-``</div><div class="delete">-db = DAL(&quot;sqlite://storage.sqlite&quot;)</div><div class="delete">-</div><div class="delete">-db.define_table(&#x27;image&#x27;,</div><div class="delete">-   Field(&#x27;title&#x27;, unique=True),</div><div class="delete">-   Field(&#x27;file&#x27;, &#x27;upload&#x27;),</div><div class="delete">-   format = &#x27;%(title)s&#x27;)</div><div class="delete">-</div><div class="delete">-db.define_table(&#x27;comment&#x27;,</div><div class="delete">-   Field(&#x27;image_id&#x27;, &#x27;reference image&#x27;),</div><div class="delete">-   Field(&#x27;author&#x27;),</div><div class="delete">-   Field(&#x27;email&#x27;),</div><div class="delete">-   Field(&#x27;body&#x27;, &#x27;text&#x27;))</div><div class="delete">-</div><div class="delete">-db.image.title.requires = IS_NOT_IN_DB(db, db.image.title)</div><div class="delete">-db.comment.image_id.requires = IS_IN_DB(db, db.image.id, &#x27;%(title)s&#x27;)</div><div class="delete">-db.comment.author.requires = IS_NOT_EMPTY()</div><div class="delete">-db.comment.email.requires = IS_EMAIL()</div><div class="delete">-db.comment.body.requires = IS_NOT_EMPTY()</div><div class="delete">-</div><div class="delete">-db.comment.image_id.writable = db.comment.image_id.readable = False</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Let&#x27;s analyze this line by line.</div><div class="delete">-</div><div class="delete">-Line 1 defines a global variable called ``db`` that represents the database connection. In this case it is a connection to a SQLite database stored in the file  &quot;applications/images/databases/storage.sqlite&quot;. In the SQLite case, if the database does not exist, it is created. You can change the name of the file, as well as the name of the global variable ``db``, but it is convenient to give them the same name, to make it easy to remember.</div><div class="delete">-</div><div class="delete">-Lines 3-5 define a table &quot;image&quot;. ``define_table`` is a method of the ``db`` object. The first argument, &quot;image&quot;, is the name of the table we are defining. The other arguments are the fields belonging to that table. This table has a field called &quot;title&quot;, a field called &quot;file&quot;, and a field called &quot;id&quot; that serves as the table primary key (&quot;id&quot; is not explicitly declared because all tables have an id field by default). The field &quot;title&quot; is a string, and the field &quot;file&quot; is of type &quot;upload&quot;. &quot;upload&quot; is a special type of field used by the web2py Data Abstraction Layer (DAL) to store the names of uploaded files. web2py knows how to upload files (via streaming if they are large), rename them safely, and store them.</div><div class="delete">-</div><div class="delete">-When a table is defined, web2py takes one of several possible actions:</div><div class="delete">-- if the table does not exist, the table is created;</div><div class="delete">-- if the table exists and does not correspond to the definition, the table is altered accordingly, and if a field has a different type, web2py tries to convert its contents;</div><div class="delete">-- if the table exists and corresponds to the definition, web2py does nothing.</div><div class="delete">-</div><div class="delete">-This behavior is called &quot;migration&quot;. In web2py migrations are automatic, but can be disabled for each table by passing ``migrate=False`` as the last argument of ``define_table``.</div><div class="delete">-</div><div class="delete">-Line 6 defines a format string for the table. It determines how a record should be represented as a string. Notice that the ``format`` argument can also be a function that takes a record and returns a string. For example:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-format=lambda row: row.title</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Lines 8-12 define another table called &quot;comment&quot;.</div><div class="delete">-A comment has an &quot;author&quot;, an &quot;email&quot; (we intend to store the email address of the author of the comment), a &quot;body&quot; of type &quot;text&quot; (we intend to use it to store the actual comment posted by the author), and an &quot;image_id&quot; field of type reference that points to ``db.image`` via the &quot;id&quot; field.</div><div class="delete">-</div><div class="delete">-In line 14, ``db.image.title`` represents the field &quot;title&quot; of table &quot;image&quot;. The attribute ``requires`` allows you to set requirements/constraints that will be enforced by web2py forms. Here we require that the &quot;title&quot; is unique:</div><div class="delete">-</div><div class="delete">-``IS_NOT_IN_DB(db, db.image.title)``:code</div><div class="delete">-</div><div class="delete">-&#x27;&#x27;Notice this is optional because it is set automatically given that ``Field(&#x27;title&#x27;, unique=True)``&#x27;&#x27;.</div><div class="delete">-</div><div class="delete">-The objects representing these constraints are called validators. Multiple validators can be grouped in a list. Validators are executed in the order they appear.</div><div class="delete">-``IS_NOT_IN_DB(a, b)`` is a special validator that checks that the value of a field ``b`` for a new record is not already in ``a``.</div><div class="delete">-</div><div class="delete">-Line 15 requires that the field &quot;image_id&quot; of table &quot;comment&quot; is in ``db.image.id``. As far as the database is concerned, we had already declared this  when we defined the table &quot;comment&quot;.</div><div class="delete">-Now we are explicitly telling the model that this condition should be enforced by web2py, too, at the form processing level when a new comment is posted, so that invalid values do not propagate from input forms to the database. We also require that the &quot;image_id&quot; be represented by the &quot;title&quot;, ``&#x27;%(title)s&#x27;``, of the corresponding record.</div><div class="delete">-</div><div class="delete">-Line 20 indicates that the field &quot;image_id&quot; of table &quot;comment&quot; should not be shown in forms, ``writable=False`` and not even in readonly forms, ``readable=False``.</div><div class="delete">-</div><div class="delete">-The meaning of the validators in lines 15-17 should be obvious.</div><div class="delete">-</div><div class="delete">-``format``:inxx</div><div class="delete">-Notice that the validator</div><div class="delete">-``</div><div class="delete">-db.comment.image_id.requires = IS_IN_DB(db, db.image.id, &#x27;%(title)s&#x27;)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-can be omitted (and would be automatic) if we specify a format for referenced table:</div><div class="delete">-``</div><div class="delete">-db.define_table(&#x27;image&#x27;, ..., format=&#x27;%(title)s&#x27;)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-where the format can be a string or a function that takes a record and returns a string.</div><div class="delete">-</div><div class="delete">-``appadmin``:inxx</div><div class="delete">-Once a model is defined, if there are no errors, web2py creates an application administration interface to manage the database. You access it via the &quot;database administration&quot; link in the &#x27;&#x27;edit&#x27;&#x27; page or directly:</div><div class="delete">-``</div><div class="delete">-http://127.0.0.1:8000/images/appadmin</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Here is a screenshot of the **appadmin** interface:</div><div class="delete">-</div><div class="delete">-[[image @///image/en2100.png center 480px]]</div><div class="delete">-</div><div class="delete">-This interface is coded in the controller called &quot;appadmin.py&quot; and the corresponding view &quot;appadmin.html&quot;. From now on, we will refer to this interface simply as **appadmin**. It allows the administrator to insert new database records, edit and delete existing records, browse tables, and perform database joins.</div><div class="delete">-</div><div class="delete">-The first time **appadmin** is accessed, the model is executed and the tables are created. The web2py DAL translates Python code into SQL statements that are specific to the selected database back-end (SQLite in this example). You can see the generated SQL from the &#x27;&#x27;edit&#x27;&#x27; page by clicking on the &quot;sql.log&quot; link under &quot;models&quot;. Notice that the link is not present until the tables have been created.</div><div class="delete">-</div><div class="delete">-[[image @///image/en2200.png center 480px]]</div><div class="delete">-</div><div class="delete">-If you were to edit the model and access **appadmin** again, web2py would generate SQL to alter the existing tables. The generated SQL is logged into &quot;sql.log&quot;.</div><div class="delete">-</div><div class="delete">-Now go back to **appadmin** and try to insert a new image record:</div><div class="delete">-</div><div class="delete">-[[image @///image/en2300.png center 480px]]</div><div class="delete">-</div><div class="delete">-web2py has translated the ``db.image.file`` &quot;upload&quot; field into an upload form for the file. When the form is submitted and an image file is uploaded, the file is renamed in a secure way that preserves the extension, it is saved with the new name under the application &quot;uploads&quot; folder, and the new name is stored in the ``db.image.file`` field. This process is designed to prevent directory traversal attacks.</div><div class="delete">-</div><div class="delete">-Notice that each field type is rendered by a &#x27;&#x27;widget&#x27;&#x27;. Default widgets can be overridden.</div><div class="delete">-</div><div class="delete">-When you click on a table name in **appadmin**, web2py performs a select of all records on the current table, identified by the DAL query</div><div class="delete">-``</div><div class="delete">-db.image.id &gt; 0</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-and renders the result.</div><div class="delete">-</div><div class="delete">-[[image @///image/en2400.png center 480px]]</div><div class="delete">-</div><div class="delete">-You can select a different set of records by editing the SQL query and pressing [Submit].</div><div class="delete">-</div><div class="delete">-To edit or delete a single record, click on the record id number.</div><div class="delete">-</div><div class="delete">-Because of the ``IS_IN_DB`` validator, the reference field &quot;image_id&quot; is rendered by a drop-down menu. The items in the drop-down are stored as keys (``db.image.id``), but are represented by their ``db.image.title``, as specified by the validator.</div><div class="delete">-</div><div class="delete">-Validators are powerful objects that know how to represent fields, filter field values, generate errors, and format values extracted from the field.</div><div class="delete">-</div><div class="delete">-The following figure shows what happens when you submit a form that does not pass validation:</div><div class="delete">-</div><div class="delete">-[[image @///image/en2500.png center 480px]]</div><div class="delete">-</div><div class="delete">-The same forms that are automatically generated by **appadmin** can also be generated programmatically via the ``SQLFORM`` helper and embedded in user applications. These forms are CSS-friendly, and can be customized.</div><div class="delete">-</div><div class="delete">-Every application has its own **appadmin**; therefore, **appadmin** itself can be modified without affecting other applications.</div><div class="delete">-</div><div class="delete">-So far, the application knows how to store data, and we have seen how to access the database via **appadmin**. Access to **appadmin** is restricted to the administrator, and it is not intended as a production web interface for the application; hence the next part of this walk-through. Specifically we want to create:</div><div class="delete">-- An &quot;index&quot; page that lists all available images sorted by title and links to detail pages for the images.</div><div class="delete">-- A &quot;show/[id]&quot; page that shows the visitor the requested image and allows the visitor to view and post comments.</div><div class="delete">-- A &quot;download/[name]&quot; action to download uploaded images.</div><div class="delete">-</div><div class="delete">-This is represented schematically here:</div><div class="delete">-</div><div class="delete">-[[yUML diagram @///image/en2600.png center 480px]]</div><div class="delete">-</div><div class="delete">-Go back to the &#x27;&#x27;edit&#x27;&#x27; page and edit the &quot;default.py&quot; controller, replacing its contents with the following:</div><div class="delete">-</div><div class="delete">-``select``:inxx</div><div class="delete">-``</div><div class="delete">-def index():</div><div class="delete">-    images = db().select(db.image.ALL, orderby=db.image.title)</div><div class="delete">-    return dict(images=images)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-This action returns a dictionary. The keys of the items in the dictionary are interpreted as variables passed to the view associated to the action. When developing, if there is no view, the action is rendered by the &quot;generic.html&quot; view that is provided with every web2py application.</div><div class="delete">-</div><div class="delete">-The index action performs a select of all fields (``db.image.ALL``) from table image, ordered by ``db.image.title``. The result of the select is a ``Rows`` object containing the records. Assign it to a local variable called ``images`` returned by the action to the view. ``images`` is iterable and its elements are the selected rows. For each row the columns can be accessed as dictionaries:</div><div class="delete">-``images[0][&#x27;title&#x27;]`` or equivalently as ``images[0].title``.</div><div class="delete">-</div><div class="delete">-If you do not write a view, the dictionary is rendered by &quot;views/generic.html&quot; and a call to the index action would look like this:</div><div class="delete">-</div><div class="delete">-[[image @///image/en2700.png center 480px]]</div><div class="delete">-</div><div class="delete">-You have not created a view for this action yet, so web2py renders the set of records in plain tabular form.</div><div class="delete">-</div><div class="delete">-Proceed to create a view for the index action. Return to admin, edit &quot;default/index.html&quot; and replace its content with the following:</div><div class="delete">-``</div><div class="delete">-{{extend &#x27;layout.html&#x27;}}</div><div class="delete">-&lt;h1&gt;Current Images&lt;/h1&gt;</div><div class="delete">-&lt;ul&gt;</div><div class="delete">-{{for image in images:}}</div><div class="delete">-{{=LI(A(image.title, _href=URL(&quot;show&quot;, args=image.id)))}}</div><div class="delete">-{{pass}}</div><div class="delete">-&lt;/ul&gt;</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-The first thing to notice is that a view is pure HTML with special {{...}} tags. The code embedded in {{...}} is pure Python code with one caveat: indentation is irrelevant. Blocks of code start with lines ending in colon (:) and end in lines beginning with the keyword ``pass``. In some cases the end of a block is obvious from context and the use of ``pass`` is not required.</div><div class="delete">-</div><div class="delete">-Lines 5-7 loop over the image rows and for each row image display:</div><div class="delete">-``</div><div class="delete">-LI(A(image.title, _href=URL(&#x27;show&#x27;, args=image.id))</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-This is a ``&lt;li&gt;...&lt;/li&gt;`` tag that contains an ``&lt;a href=&quot;...&quot;&gt;...&lt;/a&gt;`` tag which contains the ``image.title``. The value of the hypertext reference (href attribute) is:</div><div class="delete">-``</div><div class="delete">-URL(&#x27;show&#x27;, args=image.id)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-i.e., the URL within the same application and controller as the current request that calls the function called &quot;show&quot;, passing a single argument to the function, ``args=image.id``.</div><div class="delete">-``LI``, ``A``, etc. are web2py helpers that map to the corresponding HTML tags. Their unnamed arguments are interpreted as objects to be serialized and inserted in the tag&#x27;s innerHTML. Named arguments starting with an underscore (for example ``_href``) are interpreted as tag attributes but without the underscore. For example ``_href`` is the ``href`` attribute, ``_class`` is the ``class`` attribute, etc.</div><div class="delete">-</div><div class="delete">-As an example, the following statement:</div><div class="delete">-``</div><div class="delete">-{{=LI(A(&#x27;something&#x27;, _href=URL(&#x27;show&#x27;, args=123))}}</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-is rendered as:</div><div class="delete">-``</div><div class="delete">-&lt;li&gt;&lt;a href=&quot;/images/default/show/123&quot;&gt;something&lt;/a&gt;&lt;/li&gt;</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-A handful of helpers (``INPUT``, ``TEXTAREA``, ``OPTION`` and ``SELECT``) also support some special named attributes not starting with underscore (``value``, and ``requires``). They are important for building custom forms and will be discussed later.</div><div class="delete">-</div><div class="delete">-Go back to the &#x27;&#x27;edit&#x27;&#x27; page. It now indicates that &quot;default.py exposes index&quot;. By clicking on &quot;index&quot;, you can visit the newly created page:</div><div class="delete">-``</div><div class="delete">-http://127.0.0.1:8000/images/default/index</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-which looks like:</div><div class="delete">-</div><div class="delete">-[[image @///image/en2800.png center 480px]]</div><div class="delete">-</div><div class="delete">-If you click on the image name link, you are directed to:</div><div class="delete">-``</div><div class="delete">-http://127.0.0.1:8000/images/default/show/1</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-and this results in an error, since you have not yet created an action called &quot;show&quot; in controller &quot;default.py&quot;.</div><div class="delete">-</div><div class="delete">-Let&#x27;s edit the &quot;default.py&quot; controller and replace its content with:</div><div class="delete">-</div><div class="delete">-``SQLFORM``:inxx ``accepts``:inxx ``response.flash``:inxx ``request.args``:inxx</div><div class="delete">-``response.download``:inxx</div><div class="delete">-``</div><div class="delete">-def index():</div><div class="delete">-    images = db().select(db.image.ALL, orderby=db.image.title)</div><div class="delete">-    return dict(images=images)</div><div class="delete">-</div><div class="delete">-def show():</div><div class="delete">-    image = db.image(request.args(0,cast=int)) or redirect(URL(&#x27;index&#x27;))</div><div class="delete">-    db.comment.image_id.default = image.id</div><div class="delete">-    form = SQLFORM(db.comment)</div><div class="delete">-    if form.process().accepted:</div><div class="delete">-        response.flash = &#x27;your comment is posted&#x27;</div><div class="delete">-    comments = db(db.comment.image_id==image.id).select()</div><div class="delete">-    return dict(image=image, comments=comments, form=form)</div><div class="delete">-</div><div class="delete">-def download():</div><div class="delete">-    return response.download(request, db)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-The controller contains two actions: &quot;show&quot; and &quot;download&quot;.</div><div class="delete">-The &quot;show&quot; action selects the image with the ``id`` parsed from the request args and all comments related to the image. &quot;show&quot; then passes everything to the view &quot;default/show.html&quot;.</div><div class="delete">-</div><div class="delete">-The image id referenced by:</div><div class="delete">-``</div><div class="delete">-URL(&#x27;show&#x27;, args=image.id)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-in &quot;default/index.html&quot;, can be accessed as:</div><div class="delete">-</div><div class="delete">-``request.args(0,cast=int)``</div><div class="delete">-</div><div class="delete">-from the &quot;show&quot; action. The ``cast=int`` argument is optional but very important. It attempts to cast the string value passed in the PATH_INFO into an int. On failure it raise a proper exception instead of causing a ticket. One can also specify a redirect in case of failure to cast:</div><div class="delete">-</div><div class="delete">-``request.args(0,cast=int,otherwise=URL(&#x27;error&#x27;))``</div><div class="delete">-</div><div class="delete">-Moreover ``db.image(...)`` is a shortcut for </div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-db(db.image.id==...).select().first()</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-The &quot;download&quot; action expects a filename in ``request.args(0)``, builds a path to the location where that file is supposed to be, and sends it back to the client. If the file is too large, it streams the file without incurring any memory overhead.</div><div class="delete">-</div><div class="delete">-Notice the following statements:</div><div class="delete">-- Line 7 creates an insert form SQLFORM for the ``db.comment`` table using only the specified fields.</div><div class="delete">-- Line 8 sets the value for the reference field, which is not part of the input form because it is not in the list of fields specified above.</div><div class="delete">-- Line 9 processes the submitted form (the submitted form variables are in ``request.vars``) within the current session (the session is used to prevent double submissions, and to enforce navigation). If the submitted form variables are validated, the new comment is inserted in the ``db.comment`` table; otherwise the form is modified to include error messages (for example, if the author&#x27;s email address is invalid). This is all done in line 9!.</div><div class="delete">-- Line 10 is only executed if the form is accepted, after the record is inserted into the database table. ``response.flash`` is a web2py variable that is displayed in the views and used to notify the visitor that something happened.</div><div class="delete">-- Line 11 selects all comments that reference the current image.</div><div class="delete">-</div><div class="delete">-The &quot;download&quot; action is already defined in the &quot;default.py&quot; controller of the scaffolding application.</div><div class="delete">-</div><div class="delete">-The &quot;download&quot; action does not return a dictionary, so it does not need a view. The &quot;show&quot; action, though, should have a view, so return to **admin** and create a new view called &quot;default/show.html&quot;.</div><div class="delete">-</div><div class="delete">-Edit this new file and replace its content with the following:</div><div class="delete">-``</div><div class="delete">-{{extend &#x27;layout.html&#x27;}}</div><div class="delete">-&lt;h1&gt;Image: {{=image.title}}&lt;/h1&gt;</div><div class="delete">-&lt;center&gt;</div><div class="delete">-&lt;img width=&quot;200px&quot;</div><div class="delete">-     src=&quot;{{=URL(&#x27;download&#x27;, args=image.file)}}&quot; /&gt;</div><div class="delete">-&lt;/center&gt;</div><div class="delete">-{{if len(comments):}}</div><div class="delete">-  &lt;h2&gt;Comments&lt;/h2&gt;&lt;br /&gt;&lt;p&gt;</div><div class="delete">-  {{for comment in comments:}}</div><div class="delete">-    &lt;p&gt;{{=comment.author}} says &lt;i&gt;{{=comment.body}}&lt;/i&gt;&lt;/p&gt;</div><div class="delete">-  {{pass}}&lt;/p&gt;</div><div class="delete">-{{else:}}</div><div class="delete">-  &lt;h2&gt;No comments posted yet&lt;/h2&gt;</div><div class="delete">-{{pass}}</div><div class="delete">-&lt;h2&gt;Post a comment&lt;/h2&gt;</div><div class="delete">-{{=form}}</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-This view displays the **image.file** by calling the &quot;download&quot; action inside an ``&lt;img ... /&gt;`` tag.</div><div class="delete">-If there are comments, it loops over them and displays each one.</div><div class="delete">-</div><div class="delete">-Here is how everything will appear to a visitor.</div><div class="delete">-</div><div class="delete">-[[image @///image/en2900.png center 480px]]</div><div class="delete">-</div><div class="delete">-When a visitor submits a comment via this page, the comment is stored in the database and appended at the bottom of the page.</div><div class="delete">-</div><div class="delete">-#### Adding authentication</div><div class="delete">-</div><div class="delete">-The web2py API for Role-Based Access Control is quite sophisticated, but for now we will limit ourselves to restricting access to the show action to authenticated users, deferring a more detailed discussion to Chapter 9.</div><div class="delete">-</div><div class="delete">-To limit access to authenticated users, we need to complete three steps. In a model, for example &quot;db.py&quot;, we need to add:</div><div class="delete">-``</div><div class="delete">-from gluon.tools import Auth</div><div class="delete">-auth = Auth(db)</div><div class="delete">-auth.define_tables(username=True)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-In our controller, we need to add one action:</div><div class="delete">-``</div><div class="delete">-def user():</div><div class="delete">-    return dict(form=auth())</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-This is sufficient to enable login, register, logout, etc. pages. The default layout will also show options to the corresponding pages in the top right corner.</div><div class="delete">-</div><div class="delete">-[[image @///image/en3000.png center 300px]]</div><div class="delete">-</div><div class="delete">-We can now decorate the functions that we want to restrict, for example:</div><div class="delete">-``</div><div class="delete">-@auth.requires_login()</div><div class="delete">-def show():</div><div class="delete">-    ...</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Any attempt to access</div><div class="delete">-``</div><div class="delete">-http://127.0.0.1:8000/images/default/show/[image_id]</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-will require login. If the user is not logged it, the user will be redirected to</div><div class="delete">-``</div><div class="delete">-http://127.0.0.1:8000/images/default/user/login</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-[[image @///image/en3100.png center 480px]]</div><div class="delete">-</div><div class="delete">-The ``user`` function also exposes, among others, the following actions:</div><div class="delete">-``</div><div class="delete">-http://127.0.0.1:8000/images/default/user/logout</div><div class="delete">-http://127.0.0.1:8000/images/default/user/register</div><div class="delete">-http://127.0.0.1:8000/images/default/user/profile</div><div class="delete">-http://127.0.0.1:8000/images/default/user/change_password</div><div class="delete">-http://127.0.0.1:8000/images/default/user/request_reset_password</div><div class="delete">-http://127.0.0.1:8000/images/default/user/retrieve_username</div><div class="delete">-http://127.0.0.1:8000/images/default/user/retrieve_password</div><div class="delete">-http://127.0.0.1:8000/images/default/user/verify_email</div><div class="delete">-http://127.0.0.1:8000/images/default/user/impersonate</div><div class="delete">-http://127.0.0.1:8000/images/default/user/not_authorized</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Now, a first-time user needs to register in order to be able to log in and read or post comments.</div><div class="delete">-</div><div class="delete">-Both the ``auth`` object and the ``user`` function are already defined in the scaffolding application. The ``auth`` object is highly customizable and can deal with email verification, registration approvals, CAPTCHA, and alternate login methods via plugins.</div><div class="delete">-</div><div class="delete">-#### Adding grids</div><div class="delete">-</div><div class="delete">-We can improve this further using the ``SQLFORM.grid`` and ``SQLFORM.smartgrid`` gadgets to create a management interface for our application:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-@auth.requires_membership(&#x27;manager&#x27;)</div><div class="delete">-def manage():</div><div class="delete">-    grid = SQLFORM.smartgrid(db.image,linked_tables=[&#x27;comment&#x27;])</div><div class="delete">-    return dict(grid=grid)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-with associated &quot;views/default/manage.html&quot;</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-{{extend &#x27;layout.html&#x27;}}</div><div class="delete">-&lt;h2&gt;Management Interface&lt;/h2&gt;</div><div class="delete">-{{=grid}}</div><div class="delete">-``</div><div class="delete">-</div><div class="delete">-Using appadmin create a group &quot;manager&quot; and make some users members of the group. They will not be able to access</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-http://127.0.0.1:8000/images/default/manage</div><div class="delete">-``</div><div class="delete">-</div><div class="delete">-and browse, search:</div><div class="delete">-</div><div class="delete">-[[image @///image/en3200.png center 480px]]</div><div class="delete">-</div><div class="delete">-create, update and delete images and their comments:</div><div class="delete">-</div><div class="delete">-[[image @///image/en3300.png center 480px]]</div><div class="delete">-</div><div class="delete">-#### Configuring the layout</div><div class="delete">-</div><div class="delete">-You can configure the default layout by editing &quot;views/layout.html&quot; but you can also configure it without editing the HTML. In fact, the &quot;static/base.css&quot; stylesheet is well documented and described in Chapter 5. You can change color, columns, size, borders and background without editing the HTML. If you want to edit the menu, the title or the subtitle, you can do so in any model file. The scaffolding app, sets default values of these parameters in the file &quot;models/menu.py&quot;:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-response.title = request.application</div><div class="delete">-response.subtitle = &#x27;customize me!&#x27;</div><div class="delete">-response.meta.author = &#x27;you&#x27;</div><div class="delete">-response.meta.description = &#x27;describe your app&#x27;</div><div class="delete">-response.meta.keywords = &#x27;bla bla bla&#x27;</div><div class="delete">-response.menu = [ [ &#x27;Index&#x27;, False, URL(&#x27;index&#x27;) ] ]</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-### A simple wiki</div><div class="delete">-``wiki``:inxx ``RSS``:inxx ``Ajax``:inxx ``XMLRPC``:inxx</div><div class="delete">-</div><div class="delete">-In this section, we build a simple wiki from scratch using only low level APIs (as opposed to using the built-in wiki capabilities of web2py demonstrated in the next section). The visitor will be able to create pages, search them (by title), and edit them. The visitor will also be able to post comments (exactly as in the previous applications), and also post documents (as attachments to the pages) and link them from the pages. As a convention, we adopt the Markmin syntax for our wiki syntax. We will also implement a search page with Ajax, an RSS feed for the pages, and a handler to search the pages via XML-RPC``xmlrpc``:cite . The following diagram lists the actions that we need to implement and the links we intend to build among them.</div><div class="delete">-</div><div class="delete">-[[yUML diagram @///image/en3400.png center 200px]]</div><div class="delete">-</div><div class="delete">-Start by creating a new scaffolding app, naming it &quot;mywiki&quot;.</div><div class="delete">-</div><div class="delete">-The model must contain three tables: page, comment, and document. Both comment and document reference page because they belong to page. A document contains a file field of type upload as in the previous images application.</div><div class="delete">-</div><div class="delete">-Here is the complete model:</div><div class="delete">-``</div><div class="delete">-db = DAL(&#x27;sqlite://storage.sqlite&#x27;)</div><div class="delete">-</div><div class="delete">-from gluon.tools import *</div><div class="delete">-auth = Auth(db)</div><div class="delete">-auth.define_tables()</div><div class="delete">-crud = Crud(db)</div><div class="delete">-</div><div class="delete">-db.define_table(&#x27;page&#x27;,</div><div class="delete">-    Field(&#x27;title&#x27;),</div><div class="delete">-    Field(&#x27;body&#x27;, &#x27;text&#x27;),</div><div class="delete">-    Field(&#x27;created_on&#x27;, &#x27;datetime&#x27;, default=request.now),</div><div class="delete">-    Field(&#x27;created_by&#x27;, &#x27;reference auth_user&#x27;, default=auth.user_id),</div><div class="delete">-    format=&#x27;%(title)s&#x27;)</div><div class="delete">-</div><div class="delete">-db.define_table(&#x27;comment&#x27;,</div><div class="delete">-    Field(&#x27;page_id&#x27;, &#x27;reference page&#x27;),</div><div class="delete">-    Field(&#x27;body&#x27;, &#x27;text&#x27;),</div><div class="delete">-    Field(&#x27;created_on&#x27;, &#x27;datetime&#x27;, default=request.now),</div><div class="delete">-    Field(&#x27;created_by&#x27;, &#x27;reference auth_user&#x27;, default=auth.user_id))</div><div class="delete">-</div><div class="delete">-db.define_table(&#x27;document&#x27;,</div><div class="delete">-    Field(&#x27;page_id&#x27;, &#x27;reference page&#x27;),</div><div class="delete">-    Field(&#x27;name&#x27;),</div><div class="delete">-    Field(&#x27;file&#x27;, &#x27;upload&#x27;),</div><div class="delete">-    Field(&#x27;created_on&#x27;, &#x27;datetime&#x27;, default=request.now),</div><div class="delete">-    Field(&#x27;created_by&#x27;, &#x27;reference auth_user&#x27;, default=auth.user_id),</div><div class="delete">-    format=&#x27;%(name)s&#x27;)</div><div class="delete">-</div><div class="delete">-db.page.title.requires = IS_NOT_IN_DB(db, &#x27;page.title&#x27;)</div><div class="delete">-db.page.body.requires = IS_NOT_EMPTY()</div><div class="delete">-db.page.created_by.readable = db.page.created_by.writable = False</div><div class="delete">-db.page.created_on.readable = db.page.created_on.writable = False</div><div class="delete">-</div><div class="delete">-db.comment.body.requires = IS_NOT_EMPTY()</div><div class="delete">-db.comment.page_id.readable = db.comment.page_id.writable = False</div><div class="delete">-db.comment.created_by.readable = db.comment.created_by.writable = False</div><div class="delete">-db.comment.created_on.readable = db.comment.created_on.writable = False</div><div class="delete">-</div><div class="delete">-db.document.name.requires = IS_NOT_IN_DB(db, &#x27;document.name&#x27;)</div><div class="delete">-db.document.page_id.readable = db.document.page_id.writable = False</div><div class="delete">-db.document.created_by.readable = db.document.created_by.writable = False</div><div class="delete">-db.document.created_on.readable = db.document.created_on.writable = False</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Edit the controller &quot;default.py&quot; and create the following actions:</div><div class="delete">-- index: list all wiki pages</div><div class="delete">-- create: post another wiki page</div><div class="delete">-- show: show a wiki page and its comments, and append comments</div><div class="delete">-- edit: edit an existing page</div><div class="delete">-- documents: manage the documents attached to a page</div><div class="delete">-- download: download a document (as in the images example)</div><div class="delete">-- search: display a search box and, via an Ajax callback, return all matching titles as the visitor types</div><div class="delete">-- callback: the Ajax callback function. It returns the HTML that gets embedded in the search page while the visitor types.</div><div class="delete">-</div><div class="delete">-Here is the &quot;default.py&quot; controller:</div><div class="delete">-``</div><div class="delete">-def index():</div><div class="delete">-     &quot;&quot;&quot; this controller returns a dictionary rendered by the view</div><div class="delete">-         it lists all wiki pages</div><div class="delete">-     &gt;&gt;&gt; index().has_key(&#x27;pages&#x27;)</div><div class="delete">-     True</div><div class="delete">-     &quot;&quot;&quot;</div><div class="delete">-     pages = db().select(db.page.id,db.page.title,orderby=db.page.title)</div><div class="delete">-     return dict(pages=pages)</div><div class="delete">-</div><div class="delete">-@auth.requires_login()</div><div class="delete">-def create():</div><div class="delete">-     &quot;creates a new empty wiki page&quot;</div><div class="delete">-     form = SQLFORM(db.page).process(next=URL(&#x27;index&#x27;))</div><div class="delete">-     return dict(form=form)</div><div class="delete">-</div><div class="delete">-def show():</div><div class="delete">-     &quot;shows a wiki page&quot;</div><div class="delete">-     this_page = db.page(request.args(0,cast=int)) or redirect(URL(&#x27;index&#x27;))</div><div class="delete">-     db.comment.page_id.default = this_page.id</div><div class="delete">-     form = SQLFORM(db.comment).process() if auth.user else None</div><div class="delete">-     pagecomments = db(db.comment.page_id==this_page.id).select()</div><div class="delete">-     return dict(page=this_page, comments=pagecomments, form=form)</div><div class="delete">-</div><div class="delete">-@auth.requires_login()</div><div class="delete">-def edit():</div><div class="delete">-     &quot;edit an existing wiki page&quot;</div><div class="delete">-     this_page = db.page(request.args(0,cast=int)) or redirect(URL(&#x27;index&#x27;))</div><div class="delete">-     form = SQLFORM(db.page, this_page).process(</div><div class="delete">-         next = URL(&#x27;show&#x27;,args=request.args)) </div><div class="delete">-     return dict(form=form)</div><div class="delete">-</div><div class="delete">-@auth.requires_login()</div><div class="delete">-def documents():</div><div class="delete">-     &quot;browser, edit all documents attached to a certain page&quot;</div><div class="delete">-     page = db.page(request.args(0,cast=int)) or redirect(URL(&#x27;index&#x27;))</div><div class="delete">-     db.document.page_id.default = page.id</div><div class="delete">-     db.document.page_id.writable = False</div><div class="delete">-     grid = SQLFORM.grid(db.document.page_id==page.id,args=[page.id])</div><div class="delete">-     return dict(page=page, grid=grid)</div><div class="delete">-</div><div class="delete">-def user():</div><div class="delete">-     return dict(form=auth())</div><div class="delete">-</div><div class="delete">-def download():</div><div class="delete">-     &quot;allows downloading of documents&quot;</div><div class="delete">-     return response.download(request, db)</div><div class="delete">-</div><div class="delete">-def search():</div><div class="delete">-     &quot;an ajax wiki search page&quot;</div><div class="delete">-     return dict(form=FORM(INPUT(_id=&#x27;keyword&#x27;,_name=&#x27;keyword&#x27;,</div><div class="delete">-              _onkeyup=&quot;ajax(&#x27;callback&#x27;, [&#x27;keyword&#x27;], &#x27;target&#x27;);&quot;)),</div><div class="delete">-              target_div=DIV(_id=&#x27;target&#x27;))</div><div class="delete">-</div><div class="delete">-def callback():</div><div class="delete">-     &quot;an ajax callback that returns a &lt;ul&gt; of links to wiki pages&quot;</div><div class="delete">-     query = db.page.title.contains(request.vars.keyword)</div><div class="delete">-     pages = db(query).select(orderby=db.page.title)</div><div class="delete">-     links = [A(p.title, _href=URL(&#x27;show&#x27;,args=p.id)) for p in pages]</div><div class="delete">-     return UL(*links)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-</div><div class="delete">-Lines 2-6 provide a comment for the index action. Lines 4-5 inside the comment are interpreted by python as test code (doctest). Tests can be run via the admin interface. In this case the tests verify that the index action runs without errors.</div><div class="delete">-</div><div class="delete">-Lines 18, 27, and 35 try to fetch a ``page`` record with the id in </div><div class="delete">-``request.args(0)``.</div><div class="delete">-</div><div class="delete">-Lines 13, 20 define and process create forms for a new page and a new comment and.</div><div class="delete">-</div><div class="delete">-Line 28 defines and processes an update form for a wiki page.</div><div class="delete">-</div><div class="delete">-Line 38 creates a ``grid`` object that allows to browser, add and update the comments linked to a page.</div><div class="delete">-</div><div class="delete">-Some magic happens in line 51. The ``onkeyup`` attribute of the INPUT tag &quot;keyword&quot; is set. Every time the visitor releases a key, the JavaScript code inside the ``onkeyup`` attribute is executed, client-side. Here is the JavaScript code:</div><div class="delete">-``</div><div class="delete">-ajax(&#x27;callback&#x27;, [&#x27;keyword&#x27;], &#x27;target&#x27;);</div><div class="delete">-``:code</div><div class="delete">-``ajax`` is a JavaScript function defined in the file &quot;web2py.js&quot; which is included by the default &quot;layout.html&quot;. It takes three parameters: the URL of the action that performs the synchronous callback, a list of the IDs of variables to be sent to the callback ([&quot;keyword&quot;]), and the ID where the response has to be inserted (&quot;target&quot;).</div><div class="delete">-</div><div class="delete">-As soon as you type something in the search box and release a key, the client calls the server and sends the content of the &#x27;keyword&#x27; field, and, when the sever responds, the response is embedded in the page itself as the innerHTML of the &#x27;target&#x27; tag.</div><div class="delete">-</div><div class="delete">-The &#x27;target&#x27; tag is a DIV defined in line 52. It could have been defined in the view as well.</div><div class="delete">-</div><div class="delete">-Here is the code for the view &quot;default/create.html&quot;:</div><div class="delete">-``</div><div class="delete">-{{extend &#x27;layout.html&#x27;}}</div><div class="delete">-&lt;h1&gt;Create new wiki page&lt;/h1&gt;</div><div class="delete">-{{=form}}</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-If you visit the **create** page, you see the following:</div><div class="delete">-</div><div class="delete">-[[image @///image/en3500.png center 480px]]</div><div class="delete">-</div><div class="delete">-Here is the code for the view &quot;default/index.html&quot;:</div><div class="delete">-``</div><div class="delete">-{{extend &#x27;layout.html&#x27;}}</div><div class="delete">-&lt;h1&gt;Available wiki pages&lt;/h1&gt;</div><div class="delete">-[ {{=A(&#x27;search&#x27;, _href=URL(&#x27;search&#x27;))}} ]&lt;br /&gt;</div><div class="delete">-&lt;ul&gt;{{for page in pages:}}</div><div class="delete">-     {{=LI(A(page.title, _href=URL(&#x27;show&#x27;, args=page.id)))}}</div><div class="delete">-{{pass}}&lt;/ul&gt;</div><div class="delete">-[ {{=A(&#x27;create page&#x27;, _href=URL(&#x27;create&#x27;))}} ]</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-It generates the following page:</div><div class="delete">-</div><div class="delete">-[[image @///image/en3600.png center 480px]]</div><div class="delete">-</div><div class="delete">-Here is the code for the view &quot;default/show.html&quot;:</div><div class="delete">-</div><div class="delete">-``markdown``:inxx ``MARKMIN``:inxx</div><div class="delete">-``</div><div class="delete">-{{extend &#x27;layout.html&#x27;}}</div><div class="delete">-&lt;h1&gt;{{=page.title}}&lt;/h1&gt;</div><div class="delete">-[ {{=A(&#x27;edit&#x27;, _href=URL(&#x27;edit&#x27;, args=request.args))}}</div><div class="delete">-| {{=A(&#x27;documents&#x27;, _href=URL(&#x27;documents&#x27;, args=request.args))}} ]&lt;br /&gt;</div><div class="delete">-{{=MARKMIN(page.body)}}</div><div class="delete">-&lt;h2&gt;Comments&lt;/h2&gt;</div><div class="delete">-{{for comment in comments:}}</div><div class="delete">-  &lt;p&gt;{{=db.auth_user[comment.created_by].first_name}} on {{=comment.created_on}}</div><div class="delete">-          says &lt;I&gt;{{=comment.body}}&lt;/i&gt;&lt;/p&gt;</div><div class="delete">-{{pass}}</div><div class="delete">-&lt;h2&gt;Post a comment&lt;/h2&gt;</div><div class="delete">-{{=form}}</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-If you wish to use markdown syntax instead of markmin syntax:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-from gluon.contrib.markdown import WIKI</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-and use ``WIKI`` instead of the ``MARKMIN`` helper.</div><div class="delete">-Alternatively, you can choose to accept raw HTML instead of markmin syntax. In this case you would replace:</div><div class="delete">-``</div><div class="delete">-{{=MARKMIN(page.body)}}</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-with:</div><div class="delete">-``</div><div class="delete">-{{=XML(page.body)}}</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-``sanitize``:inxx</div><div class="delete">-(so that the XML does not get escaped, as by default web2py behavior).</div><div class="delete">-</div><div class="delete">-This can be done better with:</div><div class="delete">-``</div><div class="delete">-{{=XML(page.body, sanitize=True)}}</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-By setting ``sanitize=True``, you tell web2py to escape unsafe XML tags such as &quot;&lt;script&gt;&quot;, and thus prevent XSS vulnerabilities.</div><div class="delete">-</div><div class="delete">-Now if, from the index page, you click on a page title, you can see the page that you have created:</div><div class="delete">-</div><div class="delete">-[[image @///image/en3700.png center 480px]]</div><div class="delete">-</div><div class="delete">-Here is the code for the view &quot;default/edit.html&quot;:</div><div class="delete">-``</div><div class="delete">-{{extend &#x27;layout.html&#x27;}}</div><div class="delete">-&lt;h1&gt;Edit wiki page&lt;/h1&gt;</div><div class="delete">-[ {{=A(&#x27;show&#x27;, _href=URL(&#x27;show&#x27;, args=request.args))}} ]&lt;br /&gt;</div><div class="delete">-{{=form}}</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-It generates a page that looks almost identical to the create page.</div><div class="delete">-</div><div class="delete">-Here is the code for the view &quot;default/documents.html&quot;:</div><div class="delete">-``</div><div class="delete">-{{extend &#x27;layout.html&#x27;}}</div><div class="delete">-&lt;h1&gt;Documents for page: {{=page.title}}&lt;/h1&gt;</div><div class="delete">-[ {{=A(&#x27;show&#x27;, _href=URL(&#x27;show&#x27;, args=request.args))}} ]&lt;br /&gt;</div><div class="delete">-&lt;h2&gt;Documents&lt;/h2&gt;</div><div class="delete">-{{=grid}}</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-If, from the &quot;show&quot; page, you click on documents, you can now manage the documents attached to the page.</div><div class="delete">-</div><div class="delete">-[[image @///image/en3800.png center 480px]]</div><div class="delete">-</div><div class="delete">-Finally here is the code for the view &quot;default/search.html&quot;:</div><div class="delete">-``</div><div class="delete">-{{extend &#x27;layout.html&#x27;}}</div><div class="delete">-&lt;h1&gt;Search wiki pages&lt;/h1&gt;</div><div class="delete">-[ {{=A(&#x27;listall&#x27;, _href=URL(&#x27;index&#x27;))}}]&lt;br /&gt;</div><div class="delete">-{{=form}}&lt;br /&gt;{{=target_div}}</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-which generates the following Ajax search form:</div><div class="delete">-</div><div class="delete">-[[image @///image/en3900.png center 480px]]</div><div class="delete">-</div><div class="delete">-You can also try to call the callback action directly by visiting, for example, the following URL:</div><div class="delete">-``</div><div class="delete">-http://127.0.0.1:8000/mywiki/default/callback?keyword=wiki</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-If you look at the page source you see the HTML returned by the callback:</div><div class="delete">-``</div><div class="delete">-&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;/mywiki/default/show/4&quot;&gt;I made a Wiki&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-``rss``:inxx</div><div class="delete">-Generating an RSS feed from the stored pages using web2py is easy because web2py includes ``gluon.contrib.rss2``. Just append the following action to the default controller:</div><div class="delete">-``</div><div class="delete">-def news():</div><div class="delete">-    &quot;generates rss feed form the wiki pages&quot;</div><div class="delete">-    reponse.generic_patterns = [&#x27;.rss&#x27;]</div><div class="delete">-    pages = db().select(db.page.ALL, orderby=db.page.title)</div><div class="delete">-    return dict(</div><div class="delete">-       title = &#x27;mywiki rss feed&#x27;,</div><div class="delete">-       link = &#x27;http://127.0.0.1:8000/mywiki/default/index&#x27;,</div><div class="delete">-       description = &#x27;mywiki news&#x27;,</div><div class="delete">-       created_on = request.now,</div><div class="delete">-       items = [</div><div class="delete">-          dict(title = row.title,</div><div class="delete">-               link = URL(&#x27;show&#x27;, args=row.id),</div><div class="delete">-               description = MARKMIN(row.body).xml(),</div><div class="delete">-               created_on = row.created_on</div><div class="delete">-               ) for row in pages])</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-and when you visit the page</div><div class="delete">-``</div><div class="delete">-http://127.0.0.1:8000/mywiki/default/news.rss</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-you see the feed (the exact output depends on the feed reader). Notice that the dict is automatically converted to RSS, thanks to the .rss extension in the URL.</div><div class="delete">-</div><div class="delete">-[[image @///image/en4000.png center 480px]]</div><div class="delete">-</div><div class="delete">-web2py also includes feedparser to read third-party feeds.</div><div class="delete">-</div><div class="delete">-``XMLRPC``:inxx</div><div class="delete">-Finally, let&#x27;s add an XML-RPC handler that allows searching the wiki programmatically:</div><div class="delete">-``</div><div class="delete">-service = Service()</div><div class="delete">-</div><div class="delete">-@service.xmlrpc</div><div class="delete">-def find_by(keyword):</div><div class="delete">-     &quot;finds pages that contain keyword for XML-RPC&quot;</div><div class="delete">-     return db(db.page.title.contains(keyword)).select().as_list()</div><div class="delete">-</div><div class="delete">-def call():</div><div class="delete">-    &quot;exposes all registered services, including XML-RPC&quot;</div><div class="delete">-    return service()</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Here, the handler action simply publishes (via XML-RPC), the functions specified in the list. In this case, ``find_by``. ``find_by`` is not an action (because it takes an argument). It queries the database with ``.select()`` and then extracts the records as a list with ``.response`` and returns the list.</div><div class="delete">-</div><div class="delete">-Here is an example of how to access the XML-RPC handler from an external</div><div class="delete">-Python program.</div><div class="delete">-``</div><div class="delete">-&gt;&gt;&gt; import xmlrpclib</div><div class="delete">-&gt;&gt;&gt; server = xmlrpclib.ServerProxy(</div><div class="delete">-    &#x27;http://127.0.0.1:8000/mywiki/default/call/xmlrpc&#x27;)</div><div class="delete">-&gt;&gt;&gt; for item in server.find_by(&#x27;wiki&#x27;):</div><div class="delete">-        print item[&#x27;created_on&#x27;], item[&#x27;title&#x27;]</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-The handler can be accessed from many other programming languages that understand XML-RPC, including C, C++, C# and Java.</div><div class="delete">-</div><div class="delete">-#### On ``date``, ``datetime`` and ``time`` format</div><div class="delete">-</div><div class="delete">-There are three different representation for each of the field types ``date``, ``datetime`` and ``time``:</div><div class="delete">-- the database representation</div><div class="delete">-- the internal web2py prepresentation</div><div class="delete">-- the string representation in forms and tables</div><div class="delete">-</div><div class="delete">-The database representation is an internal issue and does not affect the code. Internally, at the web2py level, they are stored as ``datetime.date``, ``datetime.datetime`` and ``datetime.time`` object respectively and they can be manipulated as such:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-for page in db(db.page).select():</div><div class="delete">-    print page.title, page.day, page.month, page.year</div><div class="delete">-``</div><div class="delete">-</div><div class="delete">-When dates are converted to strings in forms they are converted using the ISO representation </div><div class="delete">-``</div><div class="delete">-%Y-%m-%d %H:%M:%S</div><div class="delete">-``</div><div class="delete">-</div><div class="delete">-yet this representation in internationalized and you can use the admin stranslation page to change the format to an alternate one. For example:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-%m/%b/%Y %H:%M:%S</div><div class="delete">-``</div><div class="delete">-</div><div class="delete">-Mind that by default English is not translated because web2py assumes the applications is already written in English. If you want internationalization to work for English you need to create the translation file (using admin) and you need declare that the application current language is something other than english, for example:</div><div class="delete">-``</div><div class="delete">-T.current_languages = [&#x27;null&#x27;]</div><div class="delete">-``</div><div class="delete">-</div><div class="delete">-### The built-in web2py wiki</div><div class="delete">-</div><div class="delete">-Now you can forget the code we have built-in the previous section (not what you have learned about web2py APIs, just the code of the specific example) as we are going to provide and example of the built-in web2py wiki. </div><div class="delete">-</div><div class="delete">-In fact, web2py comes with wiki capabilities including media attachments, tags, tag cloud, page permissions, and support for oembed ``oembed``:cite and components (chapter 14). This wiki can be used with any web2py application.</div><div class="delete">-</div><div class="delete">-Notice the API of the built-in wiki are still considered experimental and small changes are still possible.</div><div class="delete">-</div><div class="delete">-Here we assume we are starting from cratch from a simple clone of the &quot;welcome&quot; application called &quot;wikidemo&quot;. Edit the controller and replace the &quot;index&quot; action with</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-def index(): return auth.wiki()</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Done! You have a fully working wiki. At this point no page has been created and in order to create pages you must be logged-in and you must be member of a group called &quot;wiki-editor&quot; or &quot;wiki-author&quot;. If you are logged as administrator the &quot;wiki-editor&quot; group is created automatically and you are made a member. The difference between editors and authors is that the editors can create pages, edit and delete any page, while the authors can create pages (with some optional restrictions) and can only edit/delete the pages they have created.</div><div class="delete">-</div><div class="delete">-The ``auth.wiki()`` function returns in a dictionary with a key ``content`` which is undesrtood by the scaffolding &quot;views/default/index.html&quot;. You man make your own view for the this action:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-{{extend &#x27;layout.html&#x27;}}</div><div class="delete">-{{=content}}</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-and add extra HTML or code as needed. There is no need to call the action &quot;index&quot;.</div><div class="delete">-</div><div class="delete">-To try the wiki, simply login into admin, visit the page</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-http://127.0.0.1:8000/wikidemo/default/index</div><div class="delete">-``</div><div class="delete">-</div><div class="delete">-Then choose a slug (in the publishing business, a slug is a short name given to an article that is in production) and you will be redirected to an empty page where you can edit the content using MARKMIN wiki syntax. A new menu item called &quot;[wiki]&quot; will allow you create, search, and edit pages. Wiki pages have RULS like:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-http://127.0.0.1:8000/wikidemo/default/index/[slug]</div><div class="delete">-``</div><div class="delete">-</div><div class="delete">-Service pages have names which start by underscore:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-http://127.0.0.1:8000/wikidemo/default/index/_create</div><div class="delete">-http://127.0.0.1:8000/wikidemo/default/index/_search</div><div class="delete">-http://127.0.0.1:8000/wikidemo/default/index/_could</div><div class="delete">-http://127.0.0.1:8000/wikidemo/default/index/_recent</div><div class="delete">-http://127.0.0.1:8000/wikidemo/default/index/_edit/...</div><div class="delete">-http://127.0.0.1:8000/wikidemo/default/index/_editmedia/...</div><div class="delete">-http://127.0.0.1:8000/wikidemo/default/index/_preview/...</div><div class="delete">-``</div><div class="delete">-</div><div class="delete">-Try create more pages such as &quot;index&quot;, &quot;aboutus&quot;, and &quot;contactus&quot;.</div><div class="delete">-Try edit them. </div><div class="delete">-</div><div class="delete">-</div><div class="delete">-The ``wiki`` method takes some optional arguments:</div><div class="delete">-</div><div class="delete">-- ``render`` which defaults to ``&#x27;markmin&#x27;`` but can be set equal to ``&#x27;html&#x27;``. It termines the syntax of the wiki. We will discuss the makrmin wiki markup later. If you change it to HTML you may want to use a wysiwyg javascript editor such as TinyMCE of NicEdit.</div><div class="delete">-- ``manage_permissions``. This is set to ``False`` by default and only recognizes permissions for &quot;wiki-editor&quot; and &quot;wiki-author&quot;. If you change it to ``True`` the create/edit page will give the option to specify by names the groups whose members have permssion to read and edit the page. In this case is a group &quot;everybody&quot; to give read permission to everybody.</div><div class="delete">-- ``force_prefix``. If set to something like ``&#x27;%(id)s-&#x27;`` it will restict authors (not editors) to create page with a prefix like &quot;[user id]-[page name]&quot;. The prefix can contain the id (&quot;%(id)s&quot;) or the username (&quot;%(username)s&quot;) or any other field from the auth_user table, as long as the corresponding column contains valid string that would pass URL validation.</div><div class="delete">-- ``restrict_search``. This default to ``False`` and any logged-in user can search all wiki pages (but not necessary read or edit them). If set to ``True``, authors can search only their own pages, editors can search everything, other users cannot search anything.</div><div class="delete">-- ``menugroups``. This defaults to ``None`` and it indictates that wiki management menu (search, create, edit, etc.) is always displayed. You can set it to a list of group names whose members only can see this menu, for exmaple ``[&#x27;wiki-editor&#x27;,&#x27;wiki-author&#x27;]``. Notice that even if the menu is exposed to everybody does not mean everybody is allowed to perform actions listed in the menu since they are regulated by the access control system.</div><div class="delete">-</div><div class="delete">-The ``wiki`` method has some additional parameters which will be explained later: ``slug``, ``env``, and ``extra``.</div><div class="delete">-</div><div class="delete">-</div><div class="delete">-</div><div class="delete">-#### MARKMIN basics</div><div class="delete">-</div><div class="delete">-The MARKMIN syntax allows you to markup **bold** text using ``**bold**``, &#x27;&#x27;italic&#x27;&#x27; text with ``&#x27;&#x27;italic&#x27;&#x27;``, ``code`` text with ``\`\`code\`\```. Titles must be prefixed by a #, sections by ##, and sub-sections by ###. Use a minus(-) to prefix an un-ordered item and plus(+) to prefix an ordered item. URLs are automatically into links. For example:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-# This is title</div><div class="delete">-## this is a section title</div><div class="delete">-### this is a subsection title</div><div class="delete">-</div><div class="delete">-Text can be **bold**, &#x27;&#x27;italic&#x27;&#x27;, !`!!`!code!`!!`! etc.</div><div class="delete">-Learn more at:</div><div class="delete">-</div><div class="delete">-http://web2py.com</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-</div><div class="delete">-You can use the ``extra`` parameter of ``auth.wiki`` to pass extra rendering rules to the MARKMIN helper. For example:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.wiki(extra=dict(verbatim=lambda text: verbatim))</div><div class="delete">-``</div><div class="delete">-</div><div class="delete">-In the varbatim function will preprocess all the input marked as varbatim</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-!`!!`!</div><div class="delete">-hello world</div><div class="delete">-!`!!`!:verbatim</div><div class="delete">-``</div><div class="delete">-</div><div class="delete">-You can find more information about the MARKMIN syntax in chapter 5.</div><div class="delete">-``auth.wiki`` is more powerful than the barebone MARKMIN helpers. In fact it supports oembed and components.</div><div class="delete">-</div><div class="delete">-You can use theS ``env`` parameter of ``auth.wiki`` to expose functions to your wiki.</div><div class="delete">-For example:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.wiki(env=dict(join=lambda a,b,c:&quot;%s-%s-%s&quot; % (a,b,c)))</div><div class="delete">-``</div><div class="delete">-</div><div class="delete">-allows you to use the markup syntax:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-@(join:1,2,3)</div><div class="delete">-``</div><div class="delete">-</div><div class="delete">-</div><div class="delete">-This call the join function passed as extra with parameters ``a,b,c=1,2,3`` and will be redered as ``1-2-3``.</div><div class="delete">-</div><div class="delete">-#### Oembed protocol</div><div class="delete">-</div><div class="delete">-You can type in (or cut-and-paste) any URL into a wiki page it normally is rendered as a link to the URL. There are exceptions:</div><div class="delete">-</div><div class="delete">-- If the URL has an image extension, the link is embedded as an image, ``&lt;img/&gt;``.</div><div class="delete">-- If the URL has an audio extension, the link is embedded as HTML5 audio ``&lt;audio/&gt;``.</div><div class="delete">-- If the URL has a video extension, the link is embedded as HTML5 video ``&lt;video/&gt;``.</div><div class="delete">-- If the URL has a MS Office or PDF extension, Google Doc Viewer is embedded, showing the content of the document (only works for public documents).</div><div class="delete">-- If the URL points to a Youtube page, a Viemo page, or a Flickr page, web2py contacts the corrsponding web service and queries it about the propor way to embed the contect. This is done using the ``oembed`` protocol.</div><div class="delete">-</div><div class="delete">-Here is a complete list of supported formats:</div><div class="delete">-``</div><div class="delete">-Image (.PNG, .GIF, .JPG, .JPEG)</div><div class="delete">-Audio (.WAV, .OGG, .MP3)</div><div class="delete">-Video (.MOV, .MPE, .MP4, .MPG, .MPG2, .MPEG, .MPEG4, .MOVIE)</div><div class="delete">-``</div><div class="delete">-</div><div class="delete">-Supported via Google Doc Viewer:</div><div class="delete">-``</div><div class="delete">-Microsoft Excel (.XLS and .XLSX)                                                </div><div class="delete">-Microsoft PowerPoint 2007 / 2010 (.PPTX)                                        </div><div class="delete">-Apple Pages (.PAGES)                                                            </div><div class="delete">-Adobe PDF (.PDF)                                                                </div><div class="delete">-Adobe Illustrator (.AI)                                                         </div><div class="delete">-Adobe Photoshop (.PSD)                                                          </div><div class="delete">-Autodesk AutoCad (.DXF)                                                         </div><div class="delete">-Scalable Vector Graphics (.SVG)                                                 </div><div class="delete">-PostScript (.EPS, .PS)                                                          </div><div class="delete">-TrueType (.TTF)                                                                 </div><div class="delete">-XML Paper Specification (.XPS)                                                  </div><div class="delete">-``</div><div class="delete">-</div><div class="delete">-Supported by oembed:</div><div class="delete">-</div><div class="delete">-``                                                                                </div><div class="delete">-flickr.com                                                                      </div><div class="delete">-youtube.com                                                                     </div><div class="delete">-hulu.com                                                                        </div><div class="delete">-vimeo.com                                                                       </div><div class="delete">-slideshare.net                                                                  </div><div class="delete">-qik.com                                                                         </div><div class="delete">-polleverywhere.com                                                              </div><div class="delete">-wordpress.com                                                                   </div><div class="delete">-revision3.com                                                                   </div><div class="delete">-viddler.com </div><div class="delete">-``</div><div class="delete">-</div><div class="delete">-This is implemeneted in the web2py file ``gluon.contrib.autolinks`` and specifically in the function ``expand_one``. You can extend oembed support by registering more services. This is done by appending an entry to the ``EMBED_MAPS`` list:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-from gluon.contrib.autlinks import EMBED_MAPS</div><div class="delete">-EMBED_MAPS.append((re.compile(&#x27;http://vimeo.com/\S*&#x27;),</div><div class="delete">-                   &#x27;http://vimeo.com/api/oembed.json&#x27;))</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-#### Referencing wiki content</div><div class="delete">-</div><div class="delete">-If you create a wiki page with slug &quot;contactus&quot; you can refer to this page as</div><div class="delete">-</div><div class="delete">-``@+////contactus``:code</div><div class="delete">-</div><div class="delete">-Here ``@+////`` stands for</div><div class="delete">-</div><div class="delete">-``@+/app/controller/function/``:code</div><div class="delete">-</div><div class="delete">-but &quot;app&quot;, &quot;controller&quot;, and &quot;function&quot; are omitted thus assuming default.</div><div class="delete">-</div><div class="delete">-Similarly you can use the wiki menu to upload a media file (for example an image) linked to the page. The &quot;manage media&quot; page will show all files you have uploaded and will show the proper expression to link the media file. If, for example you upload a file &quot;test.jpg&quot; with title &quot;beach&quot;, the link expression will somthing like:</div><div class="delete">-</div><div class="delete">-``@+////15/beach.jpg``:code</div><div class="delete">-</div><div class="delete">-``@+////`` is the same prefix described before. ``15`` is the id of the record storing the media file. ``beach`` is the title. ``.jpg`` is the extension of the original file.</div><div class="delete">-</div><div class="delete">-If you cut and paste ``@+////15/beach.jpg`` into wiki pages you embed the image.</div><div class="delete">-</div><div class="delete">-Mind that media files are linked to pages and inherit access permission from the pages.</div><div class="delete">-</div><div class="delete">-#### Wiki menus</div><div class="delete">-</div><div class="delete">-If you create a page with slug &quot;wiki-menu&quot; page it will be interpreted as a description of the menu. Here is an example:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-- Home &gt; @+////index</div><div class="delete">-- Info &gt; @+////info</div><div class="delete">-- web2py &gt; http://google.com</div><div class="delete">-- - About us &gt; @+////aboutus</div><div class="delete">-- - Countact us &gt; @+////contactus</div><div class="delete">-``</div><div class="delete">-</div><div class="delete">-Each line a menu item. We used double dash for nested menu ites. The ``&gt;`` symbols separates the menu item title from the menu item link.</div><div class="delete">-</div><div class="delete">-Mind that the menu is appended to ``response.menu``. It does not replace it. The ``[wiki]`` menu tem with service functions is added automatically.</div><div class="delete">-</div><div class="delete">-#### Service functions</div><div class="delete">-</div><div class="delete">-If, for example, you want to use the wiki to create an editable sidebar you could create a page with ``slug=&quot;sidebar&quot;`` and then embed it in your layout.html with</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-{{=auth.wiki(slug=&#x27;sidebar&#x27;)}}</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Notice that there is nothing special with the word &quot;sidebar&quot;. Any wiki page can be retrieved and emebdded in any point in your code. This allows you mix and match wiki functionalities with regular web2py functionalities.</div><div class="delete">-</div><div class="delete">-You can also embed special wiki functions as the search by tags:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-{{=auth.wiki(&#x27;_search&#x27;)}}</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-or the tag cloud:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-{{=auth.wiki(&#x27;_cloud&#x27;)}}</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-#### Components</div><div class="delete">-</div><div class="delete">-One of the most powerful function of the new web2py consists in the ability of embedding an action inside another action. We call this a component.</div><div class="delete">-</div><div class="delete">-Consider the following model:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-db.define_table(&#x27;thing&#x27;,Field(&#x27;name&#x27;,requires=IS_NOT_EMPTY()))</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-and the following action:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-@auth.requires_login()</div><div class="delete">-def manage_things():</div><div class="delete">-    return SQLFORM.grid(db.thing)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-This action is special because it returns a widget/helper not a dict of objects. Now we can embed this ``manage_things`` action into any view, with</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-{{=LOAD(&#x27;default&#x27;,&#x27;manage_things&#x27;,ajax=True)}}</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-This allows the visitor interact with the component via Ajax without reloadin the host page that embeds the widget. Basically the action is called via Ajax, inherits the stile of the host page, and capture all forms submissions and flash messages so that thye are handled within the current page. On top of this the ``SQLFORM.grid`` widget uses digitally signed URLs to restrict access. More informaiton about components can be found in chapter 13.</div><div class="delete">-</div><div class="delete">-Components like the one above can be embedded into wiki pages using the MARKMIN syntax:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-@{component:default/manage_things}</div><div class="delete">-``</div><div class="delete">-</div><div class="delete">-This simply tells web2py that we want to incude the &quot;manage_things&quot; action defined in the &quot;default&quot; controller as an Ajax &quot;component&quot;.</div><div class="delete">-</div><div class="delete">-Most users will be able to build relatively complex applications simply by using ``auth.wiki`` to create pages and menus, and embedded custom components into wiki pages. Wiki can be tough as a mechanism to allow members of the group to create pages but they calso be though as a way to develop applications in a modular way.</div><div class="delete">-</div><div class="delete">-### More on **admin**</div><div class="delete">-``admin``:inxx</div><div class="delete">-</div><div class="delete">-The administrative interface provides additional functionality that we briefly review here.</div><div class="delete">-</div><div class="delete">-#### Site</div><div class="delete">-``site``:inxx</div><div class="delete">-</div><div class="delete">-This page lists all installed applications. There are two forms at the bottom.</div><div class="delete">-</div><div class="delete">-The first of them allows creating a new application by specifying its name.</div><div class="delete">-</div><div class="delete">-``Instant Press``:inxx ``Movuca``:inxx</div><div class="delete">-The second form allows uploading an existing application from either a local file or a remote URL. When you upload an application, you need to specify a name for it. This can be its original name, but does not need to be. This allows installing multiple copies of the same application. You can try, for example, to upload the Movuca Social Networking application app created by Bruno Rocha:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-http://code.google.com/p/instant-press/</div><div class="delete">-``</div><div class="delete">-</div><div class="delete">-or Instant Press CMS created by Martin Mulone:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-http://code.google.com/p/instant-press/</div><div class="delete">-``</div><div class="delete">-</div><div class="delete">-or one of the many example applications available at:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-http://web2py.com/appliances</div><div class="delete">-``</div><div class="delete">-</div><div class="delete">-Web2py files are packages as ``.w2p`` files. These ones are tar gzipped files. Web2py uses the ``.w2p`` extension instead of the ``.tgz`` extension to prevent the browser from unzipping on download. They can be uncompressed manually with ``tar zxvf [filename]`` although this is never necessary.</div><div class="delete">-</div><div class="delete">-[[image @///image/en4100.png center 444px]]</div><div class="delete">-</div><div class="delete">-Upon successful upload, web2py displays the MD5 checksum of the uploaded file. You can use it to verify that the file was not corrupted during upload. The InstantPress name will appear in the list of installed applications.</div><div class="delete">-</div><div class="delete">-Click on the application name on admin to get it up and running.</div><div class="delete">-</div><div class="delete">-If you run web2py from source and you have ``pyhton-git`` installed, you can install applications directly from git reporsitory using the ``.git`` URL in the upload form. In this case you will also be used to user the admin interface to push changes back into the repository.</div><div class="delete">-</div><div class="delete">-For each application the &#x27;&#x27;site&#x27;&#x27; page allows you to:</div><div class="delete">-- Uninstall the application.</div><div class="delete">-- Jump to the &#x27;&#x27;about&#x27;&#x27; page (read below).</div><div class="delete">-- Jump to the &#x27;&#x27;edit&#x27;&#x27; page (read below).</div><div class="delete">-- Jump to the &#x27;&#x27;errors&#x27;&#x27; page (read below).</div><div class="delete">-- Clean up temporary files (sessions, errors, and cache.disk files).</div><div class="delete">-- Pack all. This returns a tar file containing a complete copy of the application. We suggest that you clean up temporary files before packing an application.</div><div class="delete">-- Compile the application. If there are no errors, this option will bytecode-compile all models, controllers and views. Because views can extend and include other views in a tree, before bytecode compilation, the view tree for every controller is collapsed into a single file. The net effect is that a bytecode-compiled application is faster, because there is no more parsing of templates or string substitutions occurring at runtime.</div><div class="delete">-- Pack compiled. This option is only present for bytecode-compiled applications. It allows packing the application without source code for distribution as closed source. Note that Python (as any other programming language) can technically be decompiled; therefore compilation does not provide complete protection of the source code. Nevertheless, decompilation can be difficult and can be illegal.</div><div class="delete">-- Remove compiled. It simply removes the byte-code compiled models, views and controllers from the application. If the application was packaged with source code or edited locally, there is no harm in removing the bytecode-compiled files, and the application will continue to work. If the application was installed form a packed compiled file, then this is not safe, because there is no source code to revert to, and the application will no longer work.</div><div class="delete">-</div><div class="delete">-``admin.py``:inxx</div><div class="delete">-</div><div class="delete">-All the functionality available from the web2py admin site page is also accessible programmatically via the API defined in the module ``gluon/admin.py``. Simply open a python shell and import this module.</div><div class="delete">-</div><div class="delete">-If the Google App Engine SDK is installer the admin &#x27;&#x27;site&#x27;&#x27; page shows a button to push your applications to GAE. If ``python-git`` is installed, there is also a button to push your application to Open Shift. To install applications on ``heroku`` or other hosting system you should look into the &quot;scripts&quot; folder for the appropriate script.</div><div class="delete">-</div><div class="delete">-#### About</div><div class="delete">-``about``:inxx ``license``:inxx</div><div class="delete">-</div><div class="delete">-The &#x27;&#x27;about&#x27;&#x27; tab allows editing the description of the application and its license. These are written respectively in the ABOUT and LICENSE files in the application folder.</div><div class="delete">-</div><div class="delete">-[[image @///image/en4300.png center 480px]]</div><div class="delete">-</div><div class="delete">-You can use ``MARKMIN``, or ``gluon.contrib.markdown.WIKI`` syntax for these files as described in ref.``markdown2``:cite .</div><div class="delete">-</div><div class="delete">-#### Design</div><div class="delete">-``EDIT``:inxx</div><div class="delete">-You have used the &#x27;&#x27;edit&#x27;&#x27; page already in this chapter. Here we want to point out a few more functionalities of the &#x27;&#x27;edit&#x27;&#x27; page.</div><div class="delete">-- If you click on any file name, you can see the contents of the file with syntax highlighting.</div><div class="delete">-- If you click on edit, you can edit the file via a web interface.</div><div class="delete">-- If you click on delete, you can delete the file (permanently).</div><div class="delete">-- If you click on test, web2py will run tests. Tests are written by the developer using Python doctests, and each function should have its own tests.</div><div class="delete">-- You can add language files, scan the app to discover all strings, and edit string translations via the web interface.</div><div class="delete">-- If the static files are organized in folders and subfolders, the folder hierarchy can be toggled by clicking on a folder name.</div><div class="delete">-</div><div class="delete">-The image below shows the output of the test page for the welcome application.</div><div class="delete">-</div><div class="delete">-[[image @///image/en4400.png center 480px]]</div><div class="delete">-</div><div class="delete">-The image below show the languages tab for the welcome application.</div><div class="delete">-</div><div class="delete">-[[image @///image/en4500.png center 480px]]</div><div class="delete">-</div><div class="delete">-The image below shows how to edit a language file, in this case the &quot;it&quot; (Italian) language for the welcome application.</div><div class="delete">-</div><div class="delete">-[[image @///image/en4600.png center 480px]]</div><div class="delete">-</div><div class="delete">-##### Intergated debugger</div><div class="delete">-</div><div class="delete">-##### Shell</div><div class="delete">-</div><div class="delete">-If you click on the &quot;shell&quot; link under the controllers tab in &#x27;&#x27;edit&#x27;&#x27;, web2py will open a web based Python shell and will execute the models for the current application. This allows you to interactively talk to your application.</div><div class="delete">-</div><div class="delete">-[[image @///image/en4700.png center 480px]]</div><div class="delete">-</div><div class="delete">-##### Crontab</div><div class="delete">-</div><div class="delete">-Also under the controllers tab in &#x27;&#x27;edit&#x27;&#x27; there is a &quot;crontab&quot; link. By clicking on this link you will be able to edit the web2py crontab file. This follows the same syntax as the unix crontab but does not rely on unix. In fact, it only requires web2py, and it works on Windows. It allows you to register actions that need to be executed in background at scheduled times.</div><div class="delete">-For more information about this, see the next chapter.</div><div class="delete">-</div><div class="delete">-#### Errors</div><div class="delete">-``errors``:inxx</div><div class="delete">-</div><div class="delete">-When programming web2py, you will inevitably make mistakes and introduce bugs. web2py helps in two ways: 1) it allows you to create tests for every function that can be run in the browser from the &#x27;&#x27;edit&#x27;&#x27; page; and 2) when an error manifests itself, a ticket is issued to the visitor and the error is logged.</div><div class="delete">-</div><div class="delete">-Intentionally introduce an error in the images application as shown below:</div><div class="delete">-``</div><div class="delete">-def index():</div><div class="delete">-    images = db().select(db.image.ALL,orderby=db.image.title)</div><div class="delete">-    1/0</div><div class="delete">-    return dict(images=images)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-When you access the index action, you get the following ticket:</div><div class="delete">-</div><div class="delete">-[[image @///image/en4800.png center 480px]]</div><div class="delete">-</div><div class="delete">-Only the administrator can access the ticket:</div><div class="delete">-</div><div class="delete">-[[image @///image/en4900.png center 480px]]</div><div class="delete">-</div><div class="delete">-The ticket shows the traceback, and the content of the file that caused the problem, and the complete state of system (variables, request, session, etc.) If the error occurs in a view, web2py shows the view converted from HTML into Python code. This allows to easily identify the logical structure of the file.</div><div class="delete">-</div><div class="delete">-By default tickets are stored on filesystem and group by traceback. The administrative interface provides an aggregate views (type of traceback and number of occurrence) and a detailed view (all tickets are listed by ticket id). The administrator can switch between the two views.</div><div class="delete">-</div><div class="delete">-Notice that everywhere **admin** shows syntax-highlighted code (for example, in error reports, web2py keywords are shown in orange). If you click on a web2py keyword, you are redirected to a documentation page about the keyword.</div><div class="delete">-</div><div class="delete">-If you fix the divide-by-zero bug in the index action and introduce one in the index view:</div><div class="delete">-``</div><div class="delete">-{{extend &#x27;layout.html&#x27;}}</div><div class="delete">-</div><div class="delete">-&lt;h1&gt;Current Images&lt;/h1&gt;</div><div class="delete">-&lt;ul&gt;</div><div class="delete">-{{for image in images:}}</div><div class="delete">-{{1/0}}</div><div class="delete">-{{=LI(A(image.title, _href=URL(&quot;show&quot;, args=image.id)))}}</div><div class="delete">-{{pass}}</div><div class="delete">-&lt;/ul&gt;</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-you get the following ticket:</div><div class="delete">-</div><div class="delete">-[[image @///image/en5000.png center 480px]]</div><div class="delete">-</div><div class="delete">-Note that web2py has converted the view from HTML into a Python file, and the error described in the ticket refers to the generated Python code and NOT to the original view file:</div><div class="delete">-</div><div class="delete">-[[image @///image/en5100.png center 480px]]</div><div class="delete">-</div><div class="delete">-This may seem confusing at first, but in practice it makes debugging easier, because the Python indentation highlights the logical structure of the code that you embedded in the views.</div><div class="delete">-</div><div class="delete">-The code is shown at the bottom of the same page.</div><div class="delete">-</div><div class="delete">-All tickets are listed under admin in the &#x27;&#x27;errors&#x27;&#x27; page for each application:</div><div class="delete">-</div><div class="delete">-[[image @///image/en5200.png center 480px]]</div><div class="delete">-</div><div class="delete">-#### Mercurial</div><div class="delete">-``Mercurial``:inxx</div><div class="delete">-</div><div class="delete">-If you are running from source and you have the Mercurial version control libraries installed:</div><div class="delete">-``</div><div class="delete">-easy_install mercurial</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-then the administrative interface shows one more menu item called &quot;Versioning&quot;. It automatically creates a local Mercurial repository for the application. Pressing the &quot;commit&quot; button in the page will commit the current application. Mercurial creates and stores information about changes you make in your code into a hidden folder &quot;.hg&quot; in your app subfolder. Every app has its own &quot;.hg&quot; folder and its own &quot;.hgignore&quot; file (tells Mercurial which files to ignore).</div><div class="delete">-</div><div class="delete">-The Mercurial web interface does allow you to browse previous commit and diff files but we do recommend you use Mercurial directly from the shell or one of the many GUI-based Mercurial clients since they are more powerful. For example they will allow you sync your app with a remote source repository:</div><div class="delete">-</div><div class="delete">-[[images @///image/en5300.png center 480px]]</div><div class="delete">-</div><div class="delete">-</div><div class="delete">-You can read more about Mercurial here:</div><div class="delete">-``</div><div class="delete">-http://mercurial.selenic.com/</div><div class="delete">-``</div><div class="delete">-</div><div class="delete">-#### Application Wizard (experimental)</div><div class="delete">-</div><div class="delete">-The **admin** interface includes a Wizard that can help you create a new applications.</div><div class="delete">-You can access the wizard from the &quot;sites&quot; page as shown in the image below.</div><div class="delete">-</div><div class="delete">-[[image @///image/en5400.png center 480px]]</div><div class="delete">-</div><div class="delete">-The wizard will guide you through a series of steps involved in creating a new application:</div><div class="delete">-</div><div class="delete">-- Chose a name for the application</div><div class="delete">-- Configure the application and choose required plugins</div><div class="delete">-- Build required models (it will create CRUD pages for each model)</div><div class="delete">-- Allow you to edit the views of those pages using MARKMIN syntax</div><div class="delete">-</div><div class="delete">-The image below shows the second step of the process.</div><div class="delete">-</div><div class="delete">-[[image @///image/en5500.png center 480px]]</div><div class="delete">-</div><div class="delete">-You can see a dropdown to select a layout plugin (from ``web2py.com/layouts``), a multiple choice dropdown to check other plugins (from ``web2py.com/plugins``) and a &quot;login config&quot; field where to put the Janrain &quot;domain:key&quot;.</div><div class="delete">-</div><div class="delete">-The other steps are pretty much self-explanatory.</div><div class="delete">-</div><div class="delete">-The Wizard works well for what it does but it is considered an &#x27;&#x27;experimental feature&#x27;&#x27; for two reasons:</div><div class="delete">-</div><div class="delete">-- Applications created with the wizard and edited manually, cannot later be modified by the wizard.</div><div class="delete">-- The interface of the wizard will change over time to include support for more features and easier visual development.</div><div class="delete">-</div><div class="delete">-In any case the wizard is a handy tool for fast prototyping and it can be used to bootstrap a new application with an alternate layout and optional plugins.</div><div class="delete">-</div><div class="delete">-#### Configuring **admin**</div><div class="delete">-</div><div class="delete">-Normally there is no need to perform any configuration of admin but a few customizations are possible. After you login into admin you can edit the admin configuration file via the URL:</div><div class="delete">-``</div><div class="delete">-http://127.0.0.1:8000/admin/default/edit/admin/models/0.py</div><div class="delete">-``</div><div class="delete">-Notice that **admin** can be used to edit itself. In fact **admin** is an app as any other one.</div><div class="delete">-</div><div class="delete">-The file &quot;0.py&quot; is very much self documented and if you are opening probably you already know what you are looking for. Anyway few customizations exist that are more important than others:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-GAE_APPCFG = os.path.abspath(os.path.join(&#x27;/usr/local/bin/appcfg.py&#x27;))</div><div class="delete">-``</div><div class="delete">-This should point to the location of the &quot;appcfg.py&quot; file that comes with the Google App Engine SDK. If you have the SDK you may want to change this config parameters to the correct value. It will allow you to deploy to GAE from the admin interface.</div><div class="delete">-</div><div class="delete">-``DEMO_MODE``:inxx</div><div class="delete">-</div><div class="delete">-You can also set web2py admin in demo mode:</div><div class="delete">-``</div><div class="delete">-DEMO_MODE = True</div><div class="delete">-FILTER_APPS = [&#x27;welcome&#x27;]</div><div class="delete">-``</div><div class="delete">-And only the apps listed in filter apps will be accessible and they will be only accessible in read-only mode.</div><div class="delete">-</div><div class="delete">-``MULTI_USER_MODE``:inxx</div><div class="delete">-``virtual laboratory``:inxx</div><div class="delete">-</div><div class="delete">-If you are a teacher and want to expose the administrative interface to students so that students can share one administrative interface for their projects (think of a virtual lab), can do it by setting:</div><div class="delete">-``</div><div class="delete">-MULTI_USER_MODE = True</div><div class="delete">-``</div><div class="delete">-In this way students will be required to login and will only be able to access their own apps via admin. You, as first user/teacher, will be able to access them all.</div><div class="delete">-</div><div class="delete">-In multi user mode, you can register students using the &quot;bulk register&quot; link in admin and manage them using the &quot;manage students&quot; link. The system also keep track of when students login and how many lines of code add/remove to/from their code. This data is presented to the administrator as charts under the application &quot;about&quot; page.</div><div class="delete">-</div><div class="delete">-Mind that this mechanism still assumes all users are trusted. All the apps created under admin run under the same credentials on the same filesystem. It is possible for an app created by a student to access the data and the source of an app created by another student. It is also possible for a student to create an app that locks the server.</div><div class="delete">-</div><div class="delete">-#### Mobile **admin**</div><div class="delete">-</div><div class="delete">-Notice that the admin application includes &quot;plugin_jqmodile&quot; which packages jQuery Mobile. When admin is accessed from a mobile devide, this is detected by web2py and the interface is displayed using a mobile friendly layout.</div><div class="delete">-</div><div class="delete">-### More on **appadmin**</div><div class="delete">-</div><div class="delete">-``appadmin``:inxx</div><div class="delete">-</div><div class="delete">-**appadmin** is not intended to be exposed to the public. It is designed to help you by providing an easy access to the database. It consists of only two files: a controller &quot;appadmin.py&quot; and a view &quot;appadmin.html&quot; which are used by all actions in the controller.</div><div class="delete">-</div><div class="delete">-The **appadmin** controller is relatively small and readable; it provides an example of designing a database interface.</div><div class="delete">-</div><div class="delete">-**appadmin** shows which databases are available and which tables exist in each database. You can insert records and list all records for each table individually. **appadmin** paginates output 100 records at a time.</div><div class="delete">-</div><div class="delete">-Once a set of records is selected, the header of the pages changes, allowing you to update or delete the selected records.</div><div class="delete">-</div><div class="delete">-To update the records, enter an SQL assignment in the Query string field:</div><div class="delete">-``</div><div class="delete">-title = &#x27;test&#x27;</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-where string values must be enclosed in single quotes. Multiple fields can be separated by commas.</div><div class="delete">-</div><div class="delete">-To delete a record, click the corresponding checkbox to confirm that you are sure.</div><div class="delete">-</div><div class="delete">-**appadmin** can also perform joins if the SQL FILTER contains a SQL condition that involves two or more tables. For example, try:</div><div class="delete">-``</div><div class="delete">-db.image.id == db.comment.image_id</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-web2py passes this along to the DAL, and it understands that the query links two tables; hence, both tables are selected with an INNER JOIN. Here is the output:</div><div class="delete">-</div><div class="delete">-[[image @///image/en5600.png center 480px]]</div><div class="delete">-</div><div class="delete">-If you click on the number of an id field, you get an edit page for the record with the corresponding id.</div><div class="delete">-</div><div class="delete">-If you click on the number of a reference field, you get an edit page for the referenced record.</div><div class="delete">-</div><div class="delete">-You cannot update or delete rows selected by a join, because they involve records from multiple tables and this would be ambiguous.</div><div class="delete">-</div><div class="delete">-In addition to its database administration capabilities, **appadmin** also enables you to view details about the contents of the application&#x27;s ``cache`` (at ``/yourapp/appadmin/ccache``) as well as the contents of the current ``request``, ``response``, and ``session`` objects (at ``/yourapp/appadmin/state``).</div><div class="delete">-</div><div class="delete">-**appadmin** replaces ``response.menu`` with its own menu, which provides links to the application&#x27;s **edit** page in **admin**, the **db** (database administration) page, the **state** page, and the **cache** page. If your application&#x27;s layout does not generate a menu using ``response.menu``, then you will not see the **appadmin** menu. In that case, you can modify the appadmin.html file and add ``{{=MENU(response.menu)}}`` to display the menu.</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/ac4003f4349f9ee22c67309ceeb48de5539b0308">ac4003f</a><ul><li>Date : 2012-09-01</li><li>added lots of new features to book</li></ul></li></ul>
<div class="row-fluid" id="com_ac4003f4349f9ee22c67309ceeb48de5539b0308">
    <div class="span6"><div class="diff"><div class=""> -------</div><div class="insert">+``Mac Mail``:inxx ``Google Maps``:inxx ``jsonp``:inxx</div><div class="insert">+If an extension other than &quot;html&quot; is specified (&quot;json&quot; for example), and the view file &quot;[controller]/[function].json&quot; is not found, web2py looks for the view &quot;generic.json&quot;. web2py comes with generic.html, generic.json, generic.jsonp, generic.xml, generic.rss, generic.ics (for Mac Mail Calendar), generic.map (for embedding Google Mpas), and generic.pdf (based on fpdf). These generic views can be modified for each application individually, and additional views can be added easily.</div><div class=""> -------</div><div class=""> </div><div class=""> -------</div><div class=""> Generic views are a development tool. In production every action should have its own view. In fact, by default, generic views are only enabled from localhost.</div><div class=""> -------</div><div class=""> </div><div class=""> -------</div><div class=""> You can also specify a view with ``response.view = &#x27;default/something.html&#x27;``</div><div class=""> -------</div><div class=""> </div><div class=""> Read more on this topic in Chapter 10.</div><div class=""> </div><div class=""> If you go back to &quot;EDIT&quot; and click on index, you will now see the following HTML page:</div><div class=""> </div><div class=""> [[image @///image/en1200.png center 480px]]</div><div class=""> </div><div class=""> For debugging purposes you can always append</div><div class=""> </div><div class=""> ``</div><div class=""> {{=response.toolbar()}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> to the code in a view and it will show you some useful information, including the request, response and session objects, and list all db queries with their timing.</div><div class=""> </div><div class=""> ### Let&#x27;s count</div><div class=""> ``session``:inxx</div><div class=""> Let&#x27;s now add a counter to this page that will count how many times the same visitor displays the page.</div><div class=""> </div><div class=""> web2py automatically and transparently tracks visitors using sessions and cookies. For each new visitor, it creates a session and assigns a unique &quot;session_id&quot;. The session is a container for variables that are stored server-side. The unique id is sent to the browser via a cookie. When the visitor requests another page from the same application, the browser sends the cookie back, it is retrieved by web2py, and the corresponding session is restored.</div><div class=""> </div><div class=""> is rendered as:</div><div class=""> ``:code</div><div class=""> </div><div class=""> A handful of helpers (``INPUT``, ``TEXTAREA``, ``OPTION`` and ``SELECT``) also support some special named attributes not starting with underscore (``value``, and ``requires``). They are important for building custom forms and will be discussed later.</div><div class=""> </div><div class=""> Go back to the &#x27;&#x27;edit&#x27;&#x27; page. It now indicates that &quot;default.py exposes index&quot;. By clicking on &quot;index&quot;, you can visit the newly created page:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/index</div><div class=""> ``:code</div><div class=""> </div><div class=""> which looks like:</div><div class=""> </div><div class=""> [[image @///image/en2800.png center 480px]]</div><div class=""> </div><div class=""> If you click on the image name link, you are directed to:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/show/1</div><div class=""> ``:code</div><div class=""> </div><div class=""> and this results in an error, since you have not yet created an action called &quot;show&quot; in controller &quot;default.py&quot;.</div><div class=""> </div><div class=""> Let&#x27;s edit the &quot;default.py&quot; controller and replace its content with:</div><div class=""> </div><div class=""> ``SQLFORM``:inxx ``accepts``:inxx ``response.flash``:inxx ``request.args``:inxx</div><div class=""> ``response.download``:inxx</div><div class=""> ``</div><div class=""> def index():</div><div class="">     images = db().select(db.image.ALL, orderby=db.image.title)</div><div class="">     return dict(images=images)</div><div class=""> </div><div class=""> def show():</div><div class="insert">    image = db(db.image.id==request.args(0<span class="highlight">,cast=int</span>)).select().first()</div><div class="">     db.comment.image_id.default = image.id</div><div class="">     form = SQLFORM(db.comment)</div><div class="">     if form.process().accepted:</div><div class="">         response.flash = &#x27;your comment is posted&#x27;</div><div class="">     comments = db(db.comment.image_id==image.id).select()</div><div class="">     return dict(image=image, comments=comments, form=form)</div><div class=""> </div><div class=""> def download():</div><div class="">     return response.download(request, db)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The controller contains two actions: &quot;show&quot; and &quot;download&quot;.</div><div class=""> The &quot;show&quot; action selects the image with the ``id`` parsed from the request args and all comments related to the image. &quot;show&quot; then passes everything to the view &quot;default/show.html&quot;.</div><div class=""> </div><div class=""> The image id referenced by:</div><div class=""> ``</div><div class=""> URL(&#x27;show&#x27;, args=image.id)</div><div class=""> ``:code</div><div class=""> </div><div class=""> in &quot;default/index.html&quot;, can be accessed as:</div><div class="insert">+</div><div class="insert">+``request.args(0,cast=int)``</div><div class="insert">+</div><div class="insert">+from the &quot;show&quot; action. The ``cast=int`` argument is optional but very important. It attempts to cast the string value passed in the PATH_INFO into an int. On failure it raise a proper exception instead of causing a ticket. One can also specify a redirect in case of failure to cast:</div><div class="insert">+</div><div class="insert">+``request.args(0,cast=int,otherwise=URL(&#x27;error&#x27;))``</div><div class=""> </div><div class=""> The &quot;download&quot; action expects a filename in ``request.args(0)``, builds a path to the location where that file is supposed to be, and sends it back to the client. If the file is too large, it streams the file without incurring any memory overhead.</div><div class=""> </div><div class=""> Notice the following statements:</div><div class=""> - Line 7 creates an insert form SQLFORM for the ``db.comment`` table using only the specified fields.</div><div class=""> - Line 8 sets the value for the reference field, which is not part of the input form because it is not in the list of fields specified above.</div><div class=""> - Line 9 processes the submitted form (the submitted form variables are in ``request.vars``) within the current session (the session is used to prevent double submissions, and to enforce navigation). If the submitted form variables are validated, the new comment is inserted in the ``db.comment`` table; otherwise the form is modified to include error messages (for example, if the author&#x27;s email address is invalid). This is all done in line 9!.</div><div class=""> - Line 10 is only executed if the form is accepted, after the record is inserted into the database table. ``response.flash`` is a web2py variable that is displayed in the views and used to notify the visitor that something happened.</div><div class=""> - Line 11 selects all comments that reference the current image.</div><div class=""> </div><div class=""> -------</div><div class=""> The &quot;download&quot; action is already defined in the &quot;default.py&quot; controller of the scaffolding application.</div><div class=""> -------</div><div class=""> </div><div class=""> The &quot;download&quot; action does not return a dictionary, so it does not need a view. The &quot;show&quot; action, though, should have a view, so return to **admin** and create a new view called &quot;default/show.html&quot;.</div><div class=""> </div><div class=""> Edit this new file and replace its content with the following:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Image: {{=image.title}}&lt;/h1&gt;</div><div class=""> &lt;center&gt;</div><div class=""> &lt;img width=&quot;200px&quot;</div><div class="">      src=&quot;{{=URL(&#x27;download&#x27;, args=image.file)}}&quot; /&gt;</div><div class=""> &lt;/center&gt;</div><div class=""> {{if len(comments):}}</div><div class="">   &lt;h2&gt;Comments&lt;/h2&gt;&lt;br /&gt;&lt;p&gt;</div><div class="">   {{for comment in comments:}}</div><div class="">     &lt;p&gt;{{=comment.author}} says &lt;i&gt;{{=comment.body}}&lt;/i&gt;&lt;/p&gt;</div><div class="">   {{pass}}&lt;/p&gt;</div><div class=""> {{else:}}</div><div class=""> When a visitor submits a comment via this page, the comment is stored in the dat</div><div class=""> </div><div class=""> ### Adding CRUD</div><div class=""> </div><div class=""> web2py also provides a CRUD (Create/Read/Update/Delete) API that simplifies forms even more. To use CRUD it is necessary to define it somewhere, such as in file &quot;db.py&quot;:</div><div class=""> ``</div><div class=""> from gluon.tools import Crud</div><div class=""> crud = Crud(db)</div><div class=""> ``:code</div><div class=""> </div><div class=""> -------</div><div class=""> These two lines are already in the scaffolding application.</div><div class=""> -------</div><div class=""> </div><div class=""> The ``crud`` object provides high-level methods, for example:</div><div class=""> ``</div><div class=""> form = crud.create(table)</div><div class=""> ``:code</div><div class=""> </div><div class=""> that can be used to replace the programming pattern:</div><div class=""> ``</div><div class=""> form = SQLFORM(table)</div><div class=""> if form.process().accepted:</div><div class="">     session.flash = &#x27;...&#x27;</div><div class="">     redirect(&#x27;...&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Here, we rewrite the previous &quot;show&quot; action using crud and making some more improvements:</div><div class=""> </div><div class=""> ``</div><div class=""> def show():</div><div class="insert">    image = db.image(request.args(0<span class="highlight">,cast=int</span>)) or redirect(URL(&#x27;index&#x27;))</div><div class="">     db.comment.image_id.default = image.id</div><div class="">     form = crud.create(db.comment,</div><div class="">                        message=&#x27;your comment is posted&#x27;,</div><div class=""> 		       next=URL(args=image.id))</div><div class="">     comments = db(db.comment.image_id==image.id).select()</div><div class="">     return dict(image=image, comments=comments, form=form)</div><div class=""> ``:code</div><div class=""> </div><div class=""> First of all notice we have used the syntax</div><div class=""> </div><div class=""> ``</div><div class="insert">db.image(request.args(0<span class="highlight">,cast=int</span>)) or redirect(...)</div><div class=""> ``:code</div><div class=""> </div><div class=""> to fetch the required record. Since ```table(id)`` returns None if the record is not found, we can use ``or redirect(...)`` in this case in one line.</div><div class=""> </div><div class=""> The ``next`` argument of ``crud.create`` is the URL to redirect to after the form is accepted. The ``message`` argument is the one to be displayed upon acceptance. You can read more about CRUD in Chapter 7.</div><div class=""> </div><div class=""> ### Adding Authentication</div><div class=""> </div><div class=""> The web2py API for Role-Based Access Control is quite sophisticated, but for now we will limit ourselves to restricting access to the show action to authenticated users, deferring a more detailed discussion to Chapter 9.</div><div class=""> </div><div class=""> To limit access to authenticated users, we need to complete three steps. In a model, for example &quot;db.py&quot;, we need to add:</div><div class=""> ``</div><div class=""> from gluon.tools import Auth</div><div class=""> auth = Auth(db)</div><div class=""> auth.define_tables()</div><div class=""> ``:code</div><div class=""> </div><div class=""> In our controller, we need to add one action:</div><div class=""> ``</div><div class=""> def user():</div><div class="">     return dict(form=auth())</div><div class=""> ``:code</div><div class=""> </div><div class=""> This is sufficient to enable login, register, logout, etc. pages. The default layout will also show options to the corresponding pages in the top right corner.</div><div class=""> </div><div class=""> [[image @///image/en3000.png center 300px]]</div><div class=""> </div><div class=""> We can now decorate the functions that we want to restrict, for example:</div><div class=""> ``</div><div class=""> @auth.requires_login()</div><div class=""> def show():</div><div class="insert">    image = db.image(request.args(0<span class="highlight">,cast=int</span>)) or redirect(URL(&#x27;index&#x27;))</div><div class="">     db.comment.image_id.default = image.id</div><div class="">     form = crud.create(db.comment, next=URL(args=image.id),</div><div class="">                      message=&#x27;your comment is posted&#x27;)</div><div class="">     comments = db(db.comment.image_id==image.id).select()</div><div class="">     return dict(image=image, comments=comments, form=form)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Any attempt to access</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/show/[image_id]</div><div class=""> ``:code</div><div class=""> </div><div class=""> will require login. If the user is not logged it, the user will be redirected to</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/user/login</div><div class=""> ``:code</div><div class=""> </div><div class=""> [[image @///image/en3100.png center 480px]]</div><div class=""> </div><div class=""> The ``user`` function also exposes, among others, the following actions:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/user/logout</div><div class=""> http://127.0.0.1:8000/images/default/user/register</div><div class=""> http://127.0.0.1:8000/images/default/user/profile</div><div class=""> http://127.0.0.1:8000/images/default/user/change_password</div><div class=""> http://127.0.0.1:8000/images/default/user/request_reset_password</div><div class=""> http://127.0.0.1:8000/images/default/user/retrieve_username</div><div class=""> http://127.0.0.1:8000/images/default/user/retrieve_password</div><div class=""> http://127.0.0.1:8000/images/default/user/verify_email</div><div class=""> http://127.0.0.1:8000/images/default/user/impersonate</div><div class=""> db.document.created_on.readable = db.document.created_on.writable = False</div><div class=""> </div><div class=""> Edit the controller &quot;default.py&quot; and create the following actions:</div><div class=""> - index: list all wiki pages</div><div class=""> - create: post another wiki page</div><div class=""> - show: show a wiki page and its comments, and append comments</div><div class=""> - edit: edit an existing page</div><div class=""> - documents: manage the documents attached to a page</div><div class=""> - download: download a document (as in the images example)</div><div class=""> - search: display a search box and, via an Ajax callback, return all matching titles as the visitor types</div><div class=""> - callback: the Ajax callback function. It returns the HTML that gets embedded in the search page while the visitor types.</div><div class=""> </div><div class=""> Here is the &quot;default.py&quot; controller:</div><div class=""> ``</div><div class=""> def index():</div><div class="">      &quot;&quot;&quot; this controller returns a dictionary rendered by the view</div><div class="">          it lists all wiki pages</div><div class="">      &gt;&gt;&gt; index().has_key(&#x27;pages&#x27;)</div><div class="">      True</div><div class="">      &quot;&quot;&quot;</div><div class="">      pages = db().select(db.page.id,db.page.title,orderby=db.page.title)</div><div class="">      return dict(pages=pages)</div><div class=""> </div><div class=""> @auth.requires_login()</div><div class=""> def create():</div><div class="">      &quot;creates a new empty wiki page&quot;</div><div class="">      form = crud.create(db.page, next=URL(&#x27;index&#x27;))</div><div class="">      return dict(form=form)</div><div class=""> </div><div class=""> def show():</div><div class="">      &quot;shows a wiki page&quot;</div><div class="insert">     this_page = db.page(request.args(0<span class="highlight">,cast=int</span>)) or redirect(URL(&#x27;index&#x27;))</div><div class="">      db.comment.page_id.default = this_page.id</div><div class="">      form = crud.create(db.comment) if auth.user else None</div><div class="">      pagecomments = db(db.comment.page_id==this_page.id).select()</div><div class="">      return dict(page=this_page, comments=pagecomments, form=form)</div><div class=""> </div><div class=""> @auth.requires_login()</div><div class=""> def edit():</div><div class="">      &quot;edit an existing wiki page&quot;</div><div class="insert">     this_page = db.page(request.args(0<span class="highlight">,cast=int</span>)) or redirect(URL(&#x27;index&#x27;))</div><div class="">      form = crud.update(db.page, this_page,</div><div class="">                         next=URL(&#x27;show&#x27;,args=request.args))</div><div class="">      return dict(form=form)</div><div class=""> </div><div class=""> @auth.requires_login()</div><div class=""> def documents():</div><div class="">      &quot;browser, edit all documents attached to a certain page&quot;</div><div class="insert">     page = db.page(request.args(0<span class="highlight">,cast=int</span>)) or redirect(URL(&#x27;index&#x27;))</div><div class="">      db.document.page_id.default = page.id</div><div class="">      db.document.page_id.writable = False</div><div class="">      grid = SQLFORM.grid(db.document.page_id==page.id,args=[page.id])</div><div class="">      return dict(page=page, grid=grid)</div><div class=""> </div><div class=""> def user():</div><div class="">      return dict(form=auth())</div><div class=""> </div><div class=""> def download():</div><div class="">      &quot;allows downloading of documents&quot;</div><div class="">      return response.download(request, db)</div><div class=""> </div><div class=""> def search():</div><div class="">      &quot;an ajax wiki search page&quot;</div><div class="">      return dict(form=FORM(INPUT(_id=&#x27;keyword&#x27;,_name=&#x27;keyword&#x27;,</div><div class="">               _onkeyup=&quot;ajax(&#x27;callback&#x27;, [&#x27;keyword&#x27;], &#x27;target&#x27;);&quot;)),</div><div class="">               target_div=DIV(_id=&#x27;target&#x27;))</div><div class=""> </div><div class=""> def callback():</div><div class="">      &quot;an ajax callback that returns a &lt;ul&gt; of links to wiki pages&quot;</div><div class="">      query = db.page.title.contains(request.vars.keyword)</div><div class="">      pages = db(query).select(orderby=db.page.title)</div><div class="">      links = [A(p.title, _href=URL(&#x27;show&#x27;,args=p.id)) for p in pages]</div><div class="">      return UL(*links)</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> Lines 2-6 provide a comment for the index action. Lines 4-5 inside the comment are interpreted by python as test code (doctest). Tests can be run via the admin interface. In this case the tests verify that the index action runs without errors.</div><div class=""> </div><div class="insert">+Lines 18, 27, and 35 try to fetch a ``page`` record with the id in </div><div class="insert">+``request.args(0)``.</div></div></div>
    <div class="span6"><div class="diff"><div class=""> -------</div><div class="delete">-If an extension other than &quot;html&quot; is specified (&quot;json&quot; for example), and the view file &quot;[controller]/[function].json&quot; is not found, web2py looks for the view &quot;generic.json&quot;. web2py comes with generic.html, generic.json, generic.xml, and generic.rss. These generic views can be modified for each application individually, and additional views can be added easily.</div><div class=""> -------</div><div class=""> </div><div class=""> -------</div><div class=""> Generic views are a development tool. In production every action should have its own view. In fact, by default, generic views are only enabled from localhost.</div><div class=""> -------</div><div class=""> </div><div class=""> -------</div><div class=""> You can also specify a view with ``response.view = &#x27;default/something.html&#x27;``</div><div class=""> -------</div><div class=""> </div><div class=""> Read more on this topic in Chapter 10.</div><div class=""> </div><div class=""> If you go back to &quot;EDIT&quot; and click on index, you will now see the following HTML page:</div><div class=""> </div><div class=""> [[image @///image/en1200.png center 480px]]</div><div class=""> </div><div class=""> For debugging purposes you can always append</div><div class=""> </div><div class=""> ``</div><div class=""> {{=response.toolbar()}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> to the code in a view and it will show you some useful information, including the request, response and session objects, and list all db queries with their timing.</div><div class=""> </div><div class=""> ### Let&#x27;s count</div><div class=""> ``session``:inxx</div><div class=""> Let&#x27;s now add a counter to this page that will count how many times the same visitor displays the page.</div><div class=""> </div><div class=""> web2py automatically and transparently tracks visitors using sessions and cookies. For each new visitor, it creates a session and assigns a unique &quot;session_id&quot;. The session is a container for variables that are stored server-side. The unique id is sent to the browser via a cookie. When the visitor requests another page from the same application, the browser sends the cookie back, it is retrieved by web2py, and the corresponding session is restored.</div><div class=""> </div><div class=""> is rendered as:</div><div class=""> ``:code</div><div class=""> </div><div class=""> A handful of helpers (``INPUT``, ``TEXTAREA``, ``OPTION`` and ``SELECT``) also support some special named attributes not starting with underscore (``value``, and ``requires``). They are important for building custom forms and will be discussed later.</div><div class=""> </div><div class=""> Go back to the &#x27;&#x27;edit&#x27;&#x27; page. It now indicates that &quot;default.py exposes index&quot;. By clicking on &quot;index&quot;, you can visit the newly created page:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/index</div><div class=""> ``:code</div><div class=""> </div><div class=""> which looks like:</div><div class=""> </div><div class=""> [[image @///image/en2800.png center 480px]]</div><div class=""> </div><div class=""> If you click on the image name link, you are directed to:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/show/1</div><div class=""> ``:code</div><div class=""> </div><div class=""> and this results in an error, since you have not yet created an action called &quot;show&quot; in controller &quot;default.py&quot;.</div><div class=""> </div><div class=""> Let&#x27;s edit the &quot;default.py&quot; controller and replace its content with:</div><div class=""> </div><div class=""> ``SQLFORM``:inxx ``accepts``:inxx ``response.flash``:inxx ``request.args``:inxx</div><div class=""> ``response.download``:inxx</div><div class=""> ``</div><div class=""> def index():</div><div class="">     images = db().select(db.image.ALL, orderby=db.image.title)</div><div class="">     return dict(images=images)</div><div class=""> </div><div class=""> def show():</div><div class="delete">    image = db(db.image.id==request.args(0<span class="highlight"></span>)).select().first()</div><div class="">     db.comment.image_id.default = image.id</div><div class="">     form = SQLFORM(db.comment)</div><div class="">     if form.process().accepted:</div><div class="">         response.flash = &#x27;your comment is posted&#x27;</div><div class="">     comments = db(db.comment.image_id==image.id).select()</div><div class="">     return dict(image=image, comments=comments, form=form)</div><div class=""> </div><div class=""> def download():</div><div class="">     return response.download(request, db)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The controller contains two actions: &quot;show&quot; and &quot;download&quot;.</div><div class=""> The &quot;show&quot; action selects the image with the ``id`` parsed from the request args and all comments related to the image. &quot;show&quot; then passes everything to the view &quot;default/show.html&quot;.</div><div class=""> </div><div class=""> The image id referenced by:</div><div class=""> ``</div><div class=""> URL(&#x27;show&#x27;, args=image.id)</div><div class=""> ``:code</div><div class=""> </div><div class=""> in &quot;default/index.html&quot;, can be accessed as:</div><div class="delete">-``request.args(0)``</div><div class="delete">-from the &quot;show&quot; action.</div><div class=""> </div><div class=""> The &quot;download&quot; action expects a filename in ``request.args(0)``, builds a path to the location where that file is supposed to be, and sends it back to the client. If the file is too large, it streams the file without incurring any memory overhead.</div><div class=""> </div><div class=""> Notice the following statements:</div><div class=""> - Line 7 creates an insert form SQLFORM for the ``db.comment`` table using only the specified fields.</div><div class=""> - Line 8 sets the value for the reference field, which is not part of the input form because it is not in the list of fields specified above.</div><div class=""> - Line 9 processes the submitted form (the submitted form variables are in ``request.vars``) within the current session (the session is used to prevent double submissions, and to enforce navigation). If the submitted form variables are validated, the new comment is inserted in the ``db.comment`` table; otherwise the form is modified to include error messages (for example, if the author&#x27;s email address is invalid). This is all done in line 9!.</div><div class=""> - Line 10 is only executed if the form is accepted, after the record is inserted into the database table. ``response.flash`` is a web2py variable that is displayed in the views and used to notify the visitor that something happened.</div><div class=""> - Line 11 selects all comments that reference the current image.</div><div class=""> </div><div class=""> -------</div><div class=""> The &quot;download&quot; action is already defined in the &quot;default.py&quot; controller of the scaffolding application.</div><div class=""> -------</div><div class=""> </div><div class=""> The &quot;download&quot; action does not return a dictionary, so it does not need a view. The &quot;show&quot; action, though, should have a view, so return to **admin** and create a new view called &quot;default/show.html&quot;.</div><div class=""> </div><div class=""> Edit this new file and replace its content with the following:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Image: {{=image.title}}&lt;/h1&gt;</div><div class=""> &lt;center&gt;</div><div class=""> &lt;img width=&quot;200px&quot;</div><div class="">      src=&quot;{{=URL(&#x27;download&#x27;, args=image.file)}}&quot; /&gt;</div><div class=""> &lt;/center&gt;</div><div class=""> {{if len(comments):}}</div><div class="">   &lt;h2&gt;Comments&lt;/h2&gt;&lt;br /&gt;&lt;p&gt;</div><div class="">   {{for comment in comments:}}</div><div class="">     &lt;p&gt;{{=comment.author}} says &lt;i&gt;{{=comment.body}}&lt;/i&gt;&lt;/p&gt;</div><div class="">   {{pass}}&lt;/p&gt;</div><div class=""> {{else:}}</div><div class=""> When a visitor submits a comment via this page, the comment is stored in the dat</div><div class=""> </div><div class=""> ### Adding CRUD</div><div class=""> </div><div class=""> web2py also provides a CRUD (Create/Read/Update/Delete) API that simplifies forms even more. To use CRUD it is necessary to define it somewhere, such as in file &quot;db.py&quot;:</div><div class=""> ``</div><div class=""> from gluon.tools import Crud</div><div class=""> crud = Crud(db)</div><div class=""> ``:code</div><div class=""> </div><div class=""> -------</div><div class=""> These two lines are already in the scaffolding application.</div><div class=""> -------</div><div class=""> </div><div class=""> The ``crud`` object provides high-level methods, for example:</div><div class=""> ``</div><div class=""> form = crud.create(table)</div><div class=""> ``:code</div><div class=""> </div><div class=""> that can be used to replace the programming pattern:</div><div class=""> ``</div><div class=""> form = SQLFORM(table)</div><div class=""> if form.process().accepted:</div><div class="">     session.flash = &#x27;...&#x27;</div><div class="">     redirect(&#x27;...&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Here, we rewrite the previous &quot;show&quot; action using crud and making some more improvements:</div><div class=""> </div><div class=""> ``</div><div class=""> def show():</div><div class="delete">    image = db.image(request.args(0<span class="highlight"></span>)) or redirect(URL(&#x27;index&#x27;))</div><div class="">     db.comment.image_id.default = image.id</div><div class="">     form = crud.create(db.comment,</div><div class="">                        message=&#x27;your comment is posted&#x27;,</div><div class=""> 		       next=URL(args=image.id))</div><div class="">     comments = db(db.comment.image_id==image.id).select()</div><div class="">     return dict(image=image, comments=comments, form=form)</div><div class=""> ``:code</div><div class=""> </div><div class=""> First of all notice we have used the syntax</div><div class=""> </div><div class=""> ``</div><div class="delete">db.image(request.args(0<span class="highlight"></span>)) or redirect(...)</div><div class=""> ``:code</div><div class=""> </div><div class=""> to fetch the required record. Since ```table(id)`` returns None if the record is not found, we can use ``or redirect(...)`` in this case in one line.</div><div class=""> </div><div class=""> The ``next`` argument of ``crud.create`` is the URL to redirect to after the form is accepted. The ``message`` argument is the one to be displayed upon acceptance. You can read more about CRUD in Chapter 7.</div><div class=""> </div><div class=""> ### Adding Authentication</div><div class=""> </div><div class=""> The web2py API for Role-Based Access Control is quite sophisticated, but for now we will limit ourselves to restricting access to the show action to authenticated users, deferring a more detailed discussion to Chapter 9.</div><div class=""> </div><div class=""> To limit access to authenticated users, we need to complete three steps. In a model, for example &quot;db.py&quot;, we need to add:</div><div class=""> ``</div><div class=""> from gluon.tools import Auth</div><div class=""> auth = Auth(db)</div><div class=""> auth.define_tables()</div><div class=""> ``:code</div><div class=""> </div><div class=""> In our controller, we need to add one action:</div><div class=""> ``</div><div class=""> def user():</div><div class="">     return dict(form=auth())</div><div class=""> ``:code</div><div class=""> </div><div class=""> This is sufficient to enable login, register, logout, etc. pages. The default layout will also show options to the corresponding pages in the top right corner.</div><div class=""> </div><div class=""> [[image @///image/en3000.png center 300px]]</div><div class=""> </div><div class=""> We can now decorate the functions that we want to restrict, for example:</div><div class=""> ``</div><div class=""> @auth.requires_login()</div><div class=""> def show():</div><div class="delete">    image = db.image(request.args(0<span class="highlight"></span>)) or redirect(URL(&#x27;index&#x27;))</div><div class="">     db.comment.image_id.default = image.id</div><div class="">     form = crud.create(db.comment, next=URL(args=image.id),</div><div class="">                      message=&#x27;your comment is posted&#x27;)</div><div class="">     comments = db(db.comment.image_id==image.id).select()</div><div class="">     return dict(image=image, comments=comments, form=form)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Any attempt to access</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/show/[image_id]</div><div class=""> ``:code</div><div class=""> </div><div class=""> will require login. If the user is not logged it, the user will be redirected to</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/user/login</div><div class=""> ``:code</div><div class=""> </div><div class=""> [[image @///image/en3100.png center 480px]]</div><div class=""> </div><div class=""> The ``user`` function also exposes, among others, the following actions:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/user/logout</div><div class=""> http://127.0.0.1:8000/images/default/user/register</div><div class=""> http://127.0.0.1:8000/images/default/user/profile</div><div class=""> http://127.0.0.1:8000/images/default/user/change_password</div><div class=""> http://127.0.0.1:8000/images/default/user/request_reset_password</div><div class=""> http://127.0.0.1:8000/images/default/user/retrieve_username</div><div class=""> http://127.0.0.1:8000/images/default/user/retrieve_password</div><div class=""> http://127.0.0.1:8000/images/default/user/verify_email</div><div class=""> http://127.0.0.1:8000/images/default/user/impersonate</div><div class=""> db.document.created_on.readable = db.document.created_on.writable = False</div><div class=""> </div><div class=""> Edit the controller &quot;default.py&quot; and create the following actions:</div><div class=""> - index: list all wiki pages</div><div class=""> - create: post another wiki page</div><div class=""> - show: show a wiki page and its comments, and append comments</div><div class=""> - edit: edit an existing page</div><div class=""> - documents: manage the documents attached to a page</div><div class=""> - download: download a document (as in the images example)</div><div class=""> - search: display a search box and, via an Ajax callback, return all matching titles as the visitor types</div><div class=""> - callback: the Ajax callback function. It returns the HTML that gets embedded in the search page while the visitor types.</div><div class=""> </div><div class=""> Here is the &quot;default.py&quot; controller:</div><div class=""> ``</div><div class=""> def index():</div><div class="">      &quot;&quot;&quot; this controller returns a dictionary rendered by the view</div><div class="">          it lists all wiki pages</div><div class="">      &gt;&gt;&gt; index().has_key(&#x27;pages&#x27;)</div><div class="">      True</div><div class="">      &quot;&quot;&quot;</div><div class="">      pages = db().select(db.page.id,db.page.title,orderby=db.page.title)</div><div class="">      return dict(pages=pages)</div><div class=""> </div><div class=""> @auth.requires_login()</div><div class=""> def create():</div><div class="">      &quot;creates a new empty wiki page&quot;</div><div class="">      form = crud.create(db.page, next=URL(&#x27;index&#x27;))</div><div class="">      return dict(form=form)</div><div class=""> </div><div class=""> def show():</div><div class="">      &quot;shows a wiki page&quot;</div><div class="delete">     this_page = db.page(request.args(0<span class="highlight"></span>)) or redirect(URL(&#x27;index&#x27;))</div><div class="">      db.comment.page_id.default = this_page.id</div><div class="">      form = crud.create(db.comment) if auth.user else None</div><div class="">      pagecomments = db(db.comment.page_id==this_page.id).select()</div><div class="">      return dict(page=this_page, comments=pagecomments, form=form)</div><div class=""> </div><div class=""> @auth.requires_login()</div><div class=""> def edit():</div><div class="">      &quot;edit an existing wiki page&quot;</div><div class="delete">     this_page = db.page(request.args(0<span class="highlight"></span>)) or redirect(URL(&#x27;index&#x27;))</div><div class="">      form = crud.update(db.page, this_page,</div><div class="">                         next=URL(&#x27;show&#x27;,args=request.args))</div><div class="">      return dict(form=form)</div><div class=""> </div><div class=""> @auth.requires_login()</div><div class=""> def documents():</div><div class="">      &quot;browser, edit all documents attached to a certain page&quot;</div><div class="delete">     page = db.page(request.args(0<span class="highlight"></span>)) or redirect(URL(&#x27;index&#x27;))</div><div class="">      db.document.page_id.default = page.id</div><div class="">      db.document.page_id.writable = False</div><div class="">      grid = SQLFORM.grid(db.document.page_id==page.id,args=[page.id])</div><div class="">      return dict(page=page, grid=grid)</div><div class=""> </div><div class=""> def user():</div><div class="">      return dict(form=auth())</div><div class=""> </div><div class=""> def download():</div><div class="">      &quot;allows downloading of documents&quot;</div><div class="">      return response.download(request, db)</div><div class=""> </div><div class=""> def search():</div><div class="">      &quot;an ajax wiki search page&quot;</div><div class="">      return dict(form=FORM(INPUT(_id=&#x27;keyword&#x27;,_name=&#x27;keyword&#x27;,</div><div class="">               _onkeyup=&quot;ajax(&#x27;callback&#x27;, [&#x27;keyword&#x27;], &#x27;target&#x27;);&quot;)),</div><div class="">               target_div=DIV(_id=&#x27;target&#x27;))</div><div class=""> </div><div class=""> def callback():</div><div class="">      &quot;an ajax callback that returns a &lt;ul&gt; of links to wiki pages&quot;</div><div class="">      query = db.page.title.contains(request.vars.keyword)</div><div class="">      pages = db(query).select(orderby=db.page.title)</div><div class="">      links = [A(p.title, _href=URL(&#x27;show&#x27;,args=p.id)) for p in pages]</div><div class="">      return UL(*links)</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> Lines 2-6 provide a comment for the index action. Lines 4-5 inside the comment are interpreted by python as test code (doctest). Tests can be run via the admin interface. In this case the tests verify that the index action runs without errors.</div><div class=""> </div><div class="delete">-Lines 18, 27, and 35 try to fetch a ``page`` record with the id in ``request.args(0)``.</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/83521b165c2d34b0f5904766b5cf9d6f9cf3660a">83521b1</a><ul><li>Date : 2013-02-04</li><li>added pythonanywhere screenshots</li></ul></li></ul>
<div class="row-fluid" id="com_83521b165c2d34b0f5904766b5cf9d6f9cf3660a">
    <div class="span6"><div class="diff"><div class=""> ``layout``:inxx</div><div class="insert">In both views we have extended the basic &quot;layout.html&quot; view that comes with web2py. The layout view keeps the look and feel of the two pages co<span class="highlight">nsist</span>ent. The layout file can be edited and replaced easily, since it mainly contains HTML code.</div><div class=""> </div><div class=""> If you now visit the first page, type your name:</div><div class=""> </div><div class=""> [[image @///image/en1500.png center 480px]]</div><div class=""> </div><div class=""> and submit the form, you will receive a greeting:</div><div class=""> </div><div class=""> [[image @///image/en1600.png center 480px]]</div><div class=""> </div><div class=""> #### Postbacks</div><div class=""> ``redirect``:inxx ``URL``:inxx ``postback``:inxx</div><div class=""> </div><div class=""> The mechanism for form submission that we used before is very common, but it is not good programming practice. All input should be validated and, in the above example, the burden of validation would fall on the second action. Thus the action that performs the validation is different from the action that generated the form. This tends to cause redundancy in the code.</div><div class=""> </div><div class=""> A better pattern for form submission is to submit forms to the same action that generated them, in our example the &quot;first&quot;. The &quot;first&quot; action should receive the variables, process them, store them server-side, and redirect the visitor to the &quot;second&quot; page, which retrieves the variables. This mechanism is called a &#x27;&#x27;postback&#x27;&#x27;.</div><div class=""> </div><div class=""> [[yUML diagram @///image/en1700.png center 200px]]</div><div class=""> </div><div class=""> Modify the default controller to implement self-submission:</div><div class=""> ``</div><div class=""> def first():</div><div class="">     if request.vars.visitor_name:</div><div class="">         session.visitor_name = request.vars.visitor_name</div><div class="">         redirect(URL(&#x27;second&#x27;))</div><div class="">     return dict()</div><div class=""> </div><div class=""> def second():</div><div class="">     return dict()</div><div class=""> ``:code</div><div class=""> </div><div class=""> def first():</div><div class="">     return dict(form=form)</div><div class=""> ``:code</div><div class=""> </div><div class=""> where we are saying that the FORM tag contains two INPUT tags. The attributes of the input tags are specified by the named arguments starting with underscore. The ``requires`` argument is not a tag attribute (because it does not start by underscore) but it sets a validator for the value of visitor_name.</div><div class=""> </div><div class=""> Here is yet another better way to create the same form:</div><div class=""> </div><div class=""> ``</div><div class=""> def first():</div><div class="">     form = SQLFORM.factory(Field(&#x27;visitor_name&#x27;,</div><div class="">                                  label=&#x27;what is your name?&#x27;,</div><div class="">                                  requires=IS_NOT_EMPTY()))</div><div class="">     if form.process().accepted:</div><div class="">         session.visitor_name = form.vars.visitor_name</div><div class="">         redirect(URL(&#x27;second&#x27;))</div><div class="">     return dict(form=form)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The ``form`` object can be easily serialized in HTML by embedding it in the &quot;default/first.html&quot; view.</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> {{=form}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> The ``form.process()`` method applies the validators and returns the form itself. The ``form.accepted`` variable is set to True if the form was processed and passed validation. If the self-submitted form passes validation, it stores the variables in the session and redirects as before. If the form does not pass validation, error messages are inserted into the form and shown to the user, as below:</div><div class=""> </div><div class=""> [[image @///image/en1800.png center 480px]]</div><div class=""> </div><div class=""> In the next section we will show how forms can be generated automatically from a model.</div><div class=""> </div><div class="insert">In all o<span class="highlight">u</span>r examples we have used the session to pass the user name from the first action to the second. We could have used a different mechanism and pass<span class="highlight">ed</span> data as part of a redirect URL:</div></div></div>
    <div class="span6"><div class="diff"><div class=""> ``layout``:inxx</div><div class="delete">In both views we have extended the basic &quot;layout.html&quot; view that comes with web2py. The layout view keeps the look and feel of the two pages co<span class="highlight">her</span>ent. The layout file can be edited and replaced easily, since it mainly contains HTML code.</div><div class=""> </div><div class=""> If you now visit the first page, type your name:</div><div class=""> </div><div class=""> [[image @///image/en1500.png center 480px]]</div><div class=""> </div><div class=""> and submit the form, you will receive a greeting:</div><div class=""> </div><div class=""> [[image @///image/en1600.png center 480px]]</div><div class=""> </div><div class=""> #### Postbacks</div><div class=""> ``redirect``:inxx ``URL``:inxx ``postback``:inxx</div><div class=""> </div><div class=""> The mechanism for form submission that we used before is very common, but it is not good programming practice. All input should be validated and, in the above example, the burden of validation would fall on the second action. Thus the action that performs the validation is different from the action that generated the form. This tends to cause redundancy in the code.</div><div class=""> </div><div class=""> A better pattern for form submission is to submit forms to the same action that generated them, in our example the &quot;first&quot;. The &quot;first&quot; action should receive the variables, process them, store them server-side, and redirect the visitor to the &quot;second&quot; page, which retrieves the variables. This mechanism is called a &#x27;&#x27;postback&#x27;&#x27;.</div><div class=""> </div><div class=""> [[yUML diagram @///image/en1700.png center 200px]]</div><div class=""> </div><div class=""> Modify the default controller to implement self-submission:</div><div class=""> ``</div><div class=""> def first():</div><div class="">     if request.vars.visitor_name:</div><div class="">         session.visitor_name = request.vars.visitor_name</div><div class="">         redirect(URL(&#x27;second&#x27;))</div><div class="">     return dict()</div><div class=""> </div><div class=""> def second():</div><div class="">     return dict()</div><div class=""> ``:code</div><div class=""> </div><div class=""> def first():</div><div class="">     return dict(form=form)</div><div class=""> ``:code</div><div class=""> </div><div class=""> where we are saying that the FORM tag contains two INPUT tags. The attributes of the input tags are specified by the named arguments starting with underscore. The ``requires`` argument is not a tag attribute (because it does not start by underscore) but it sets a validator for the value of visitor_name.</div><div class=""> </div><div class=""> Here is yet another better way to create the same form:</div><div class=""> </div><div class=""> ``</div><div class=""> def first():</div><div class="">     form = SQLFORM.factory(Field(&#x27;visitor_name&#x27;,</div><div class="">                                  label=&#x27;what is your name?&#x27;,</div><div class="">                                  requires=IS_NOT_EMPTY()))</div><div class="">     if form.process().accepted:</div><div class="">         session.visitor_name = form.vars.visitor_name</div><div class="">         redirect(URL(&#x27;second&#x27;))</div><div class="">     return dict(form=form)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The ``form`` object can be easily serialized in HTML by embedding it in the &quot;default/first.html&quot; view.</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> {{=form}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> The ``form.process()`` method applies the validators and returns the form itself. The ``form.accepted`` variable is set to True if the form was processed and passed validation. If the self-submitted form passes validation, it stores the variables in the session and redirects as before. If the form does not pass validation, error messages are inserted into the form and shown to the user, as below:</div><div class=""> </div><div class=""> [[image @///image/en1800.png center 480px]]</div><div class=""> </div><div class=""> In the next section we will show how forms can be generated automatically from a model.</div><div class=""> </div><div class="delete">In all o<span class="highlight"></span>r examples we have used the session to pass the user name from the first action to the second. We could have used a different mechanism and pass<span class="highlight"></span> data as part of a redirect URL:</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/4bd17bc2562076b27a8ea4f179e9752e3dd36086">4bd17bc</a><ul><li>Date : 2012-12-28</li><li>remove redundancy, thanks Sasa</li></ul></li></ul>
<div class="row-fluid" id="com_4bd17bc2562076b27a8ea4f179e9752e3dd36086">
    <div class="span6"><div class="diff"><div class="insert">web2py comes in binary packages for Windows and Mac OS X. They include the Python interpreter so you do not need to have it pre-installed. There is also a source code version that runs on Windows, Mac, Linux, and other Unix systems. The <span class="highlight">source code package assumes that</span> Python i<span class="highlight">s already installed on the compu</span>ter.<span class="highlight"></span></div></div></div>
    <div class="span6"><div class="diff"><div class="delete">web2py comes in binary packages for Windows and Mac OS X. They include the Python interpreter so you do not need to have it pre-installed. There is also a source code version that runs on Windows, Mac, Linux, and other Unix systems. The <span class="highlight">Windows and OS X binary versions include the necessary</span> Python i<span class="highlight">nterpre</span>ter.<span class="highlight"> The source code package assumes that Python is already installed on the computer.</span></div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/7bce1473ce90f4e60f49d72bf1b61d32f430cb54">7bce147</a><ul><li>Date : 2012-12-22</li><li>scheduler.queue_task</li></ul></li></ul>
<div class="row-fluid" id="com_7bce1473ce90f4e60f49d72bf1b61d32f430cb54">
    <div class="span6"><div class="diff"><div class=""> -----</div><div class="insert">When you create a new application using **admin**, it starts as a clone of the &quot;welcome&quot; scaffolding app with a &quot;models/db.py&quot; that creates a SQLite database, connects to it, instantiates Auth, Crud<span class="highlight">,</span> and Service, configures them. It also provides a &quot;controller/default.py&quot; which exposes actions &quot;index&quot;, &quot;download&quot;, &quot;user&quot; for user management, and &quot;call&quot; for services. In the following, we assume that these files have been removed; we will be creating apps from scratch.</div><div class=""> -----</div></div></div>
    <div class="span6"><div class="diff"><div class=""> -----</div><div class="delete">When you create a new application using **admin**, it starts as a clone of the &quot;welcome&quot; scaffolding app with a &quot;models/db.py&quot; that creates a SQLite database, connects to it, instantiates Auth, Crud<span class="highlight"></span> and Service, configures them. It also provides a &quot;controller/default.py&quot; which exposes actions &quot;index&quot;, &quot;download&quot;, &quot;user&quot; for user management, and &quot;call&quot; for services. In the following, we assume that these files have been removed; we will be creating apps from scratch.</div><div class=""> -----</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/13346ee2edacdf0949376d16611c0c74748f4e41">13346ee</a><ul><li>Date : 2013-02-10</li><li>fixed link to movica</li></ul></li></ul>
<div class="row-fluid" id="com_13346ee2edacdf0949376d16611c0c74748f4e41">
    <div class="span6"><div class="diff"><div class=""> ``</div><div class="insert">http<span class="highlight">s</span>://<span class="highlight"></span>g<span class="highlight">ithub</span>.com/<span class="highlight">rochacbruno</span>/<span class="highlight">Movuc</span>a<span class="highlight"></span></div><div class=""> ``</div></div></div>
    <div class="span6"><div class="diff"><div class=""> ``</div><div class="delete">http<span class="highlight"></span>://<span class="highlight">code.</span>g<span class="highlight">oogle</span>.com/<span class="highlight">p</span>/<span class="highlight">inst</span>a<span class="highlight">nt-press/</span></div><div class=""> ``</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/26f5cf563dc22ad8fe7c18e13ab0b772051279b6">26f5cf5</a><ul><li>Date : 2013-02-04</li><li>more corrections</li></ul></li></ul>
<div class="row-fluid" id="com_26f5cf563dc22ad8fe7c18e13ab0b772051279b6">
    <div class="span6"><div class="diff"><div class="insert">Mind that by default English is not translated because web2py assumes the applications <span class="highlight">are</span> written in English. If you want internationalization to work for English you need to create the translation file (using admin) and you need to declare that the application&#x27;s current language is something other than english, for example:</div><div class=""> ``</div><div class=""> T.current_languages = [&#x27;null&#x27;]</div><div class=""> ``</div><div class=""> </div><div class=""> ### The built-in web2py wiki</div><div class=""> </div><div class=""> Now you can forget the code we have built-in the previous section (not what you have learned about web2py APIs, just the code of the specific example) as we are going to provide an example of the built-in web2py wiki.</div><div class=""> </div><div class=""> In fact, web2py comes with wiki capabilities including media attachments, tags, tag cloud, page permissions, and support for oembed ``oembed``:cite and components (chapter 14). This wiki can be used with any web2py application.</div><div class=""> </div><div class=""> ------</div><div class=""> Notice the API of the built-in wiki is still considered experimental and small changes are still possible.</div><div class=""> ------</div><div class=""> </div><div class=""> Here we assume we are starting from scratch from a simple clone of the &quot;welcome&quot; application called &quot;wikidemo&quot;. Edit the controller and replace the &quot;index&quot; action with</div><div class=""> </div><div class=""> ``</div><div class=""> def index(): return auth.wiki()</div><div class=""> ``:code</div><div class=""> </div><div class=""> Done! You have a fully working wiki. At this point no page has been created and in order to create pages you must be logged-in and you must be member of a group called &quot;wiki-editor&quot; or &quot;wiki-author&quot;. If you are logged-in as administrator the &quot;wiki-editor&quot; group is created automatically and you are made a member. The difference between editors and authors is that the editors can create pages, edit and delete any page, while the authors can create pages (with some optional restrictions) and can only edit/delete the pages they have created.</div><div class=""> </div><div class=""> The ``auth.wiki()`` function returns in a dictionary with a key ``content`` which is understood by the scaffolding &quot;views/default/index.html&quot;. You can make your own view for this action:</div><div class=""> </div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> {{=content}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> and add extra HTML or code as needed. There is no need to call the action &quot;index&quot;.</div><div class=""> </div><div class=""> To try the wiki, simply login into admin, visit the page</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index</div><div class=""> ``</div><div class=""> </div><div class=""> Then choose a slug (in the publishing business, a slug is a short name given to an article that is in production) and you will be redirected to an empty page where you can edit the content using MARKMIN wiki syntax. A new menu item called &quot;[wiki]&quot; will allow you to create, search, and edit pages. Wiki pages have URLs like:</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/[slug]</div><div class=""> ``</div><div class=""> </div><div class=""> Service pages have names which start by underscore:</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_create</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_search</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_could</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_recent</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_edit/...</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_editmedia/...</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_preview/...</div><div class=""> ``</div><div class=""> </div><div class="insert">+Try to create more pages such as &quot;index&quot;, &quot;aboutus&quot;, and &quot;contactus&quot;.</div><div class="insert">+Try to edit them.</div><div class=""> </div><div class=""> </div><div class=""> The ``wiki`` method has the following signature:</div><div class=""> </div><div class=""> ``</div><div class=""> def wiki(self, slug=None, env=None, render=&#x27;markmin&#x27;,</div><div class="">          manage_permissions=False, force_prefix=&#x27;&#x27;,</div><div class="">          restrict_search=False, resolve=True,</div><div class="">          extra=None, menugroups=None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> It takes the following arguments:</div><div class=""> </div><div class=""> - ``render`` which defaults to ``&#x27;markmin&#x27;`` but can be set equal to ``&#x27;html&#x27;``. It determines the syntax of the wiki. We will discuss the markmin wiki markup later. If you change it to HTML you may want to use a wysiwyg javascript editor such as TinyMCE or NicEdit.</div><div class="insert">+- ``manage_permissions``. This is set to ``False`` by default and only recognizes permissions for &quot;wiki-editor&quot; and &quot;wiki-author&quot;. If you change it to ``True`` the create/edit page will give the option to specify by names the group(s) whose members have permission to read and edit the page. There is a group &quot;everybody&quot; which includes all users.</div><div class="insert">+</div><div class=""> - ``force_prefix``. If set to something like ``&#x27;%(id)s-&#x27;`` it will restrict authors (not editors) to creating pages with a prefix like &quot;[user id]-[page name]&quot;. The prefix can contain the id (&quot;%(id)s&quot;) or the username (&quot;%(username)s&quot;) or any other field from the auth_user table, as long as the corresponding column contains valid string that would pass URL validation.</div><div class=""> - ``restrict_search``. This defaults to ``False`` and any logged-in user can search all wiki pages (but not necessary read or edit them). If set to ``True``, authors can search only their own pages, editors can search everything, other users cannot search anything.</div><div class=""> - ``menugroups``. This defaults to ``None`` and it indicates that wiki management menu (search, create, edit, etc.) is always displayed. You can set it to a list of group names whose members only can see this menu, for example ``[&#x27;wiki-editor&#x27;,&#x27;wiki-author&#x27;]``. Notice that even if the menu is exposed to everybody that does not mean everybody is allowed to perform actions listed in the menu since they are regulated by the access control system.</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">Mind that by default English is not translated because web2py assumes the applications <span class="highlight">is already</span> written in English. If you want internationalization to work for English you need to create the translation file (using admin) and you need to declare that the application&#x27;s current language is something other than english, for example:</div><div class=""> ``</div><div class=""> T.current_languages = [&#x27;null&#x27;]</div><div class=""> ``</div><div class=""> </div><div class=""> ### The built-in web2py wiki</div><div class=""> </div><div class=""> Now you can forget the code we have built-in the previous section (not what you have learned about web2py APIs, just the code of the specific example) as we are going to provide an example of the built-in web2py wiki.</div><div class=""> </div><div class=""> In fact, web2py comes with wiki capabilities including media attachments, tags, tag cloud, page permissions, and support for oembed ``oembed``:cite and components (chapter 14). This wiki can be used with any web2py application.</div><div class=""> </div><div class=""> ------</div><div class=""> Notice the API of the built-in wiki is still considered experimental and small changes are still possible.</div><div class=""> ------</div><div class=""> </div><div class=""> Here we assume we are starting from scratch from a simple clone of the &quot;welcome&quot; application called &quot;wikidemo&quot;. Edit the controller and replace the &quot;index&quot; action with</div><div class=""> </div><div class=""> ``</div><div class=""> def index(): return auth.wiki()</div><div class=""> ``:code</div><div class=""> </div><div class=""> Done! You have a fully working wiki. At this point no page has been created and in order to create pages you must be logged-in and you must be member of a group called &quot;wiki-editor&quot; or &quot;wiki-author&quot;. If you are logged-in as administrator the &quot;wiki-editor&quot; group is created automatically and you are made a member. The difference between editors and authors is that the editors can create pages, edit and delete any page, while the authors can create pages (with some optional restrictions) and can only edit/delete the pages they have created.</div><div class=""> </div><div class=""> The ``auth.wiki()`` function returns in a dictionary with a key ``content`` which is understood by the scaffolding &quot;views/default/index.html&quot;. You can make your own view for this action:</div><div class=""> </div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> {{=content}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> and add extra HTML or code as needed. There is no need to call the action &quot;index&quot;.</div><div class=""> </div><div class=""> To try the wiki, simply login into admin, visit the page</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index</div><div class=""> ``</div><div class=""> </div><div class=""> Then choose a slug (in the publishing business, a slug is a short name given to an article that is in production) and you will be redirected to an empty page where you can edit the content using MARKMIN wiki syntax. A new menu item called &quot;[wiki]&quot; will allow you to create, search, and edit pages. Wiki pages have URLs like:</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/[slug]</div><div class=""> ``</div><div class=""> </div><div class=""> Service pages have names which start by underscore:</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_create</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_search</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_could</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_recent</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_edit/...</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_editmedia/...</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_preview/...</div><div class=""> ``</div><div class=""> </div><div class="delete">-Try creating more pages such as &quot;index&quot;, &quot;aboutus&quot;, and &quot;contactus&quot;.</div><div class="delete">-Try editing them.</div><div class=""> </div><div class=""> </div><div class=""> The ``wiki`` method has the following signature:</div><div class=""> </div><div class=""> ``</div><div class=""> def wiki(self, slug=None, env=None, render=&#x27;markmin&#x27;,</div><div class="">          manage_permissions=False, force_prefix=&#x27;&#x27;,</div><div class="">          restrict_search=False, resolve=True,</div><div class="">          extra=None, menugroups=None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> It takes the following arguments:</div><div class=""> </div><div class=""> - ``render`` which defaults to ``&#x27;markmin&#x27;`` but can be set equal to ``&#x27;html&#x27;``. It determines the syntax of the wiki. We will discuss the markmin wiki markup later. If you change it to HTML you may want to use a wysiwyg javascript editor such as TinyMCE or NicEdit.</div><div class="delete">-- ``manage_permissions``. This is set to ``False`` by default and only recognizes permissions for &quot;wiki-editor&quot; and &quot;wiki-author&quot;. If you change it to ``True`` the create/edit page will give the option to specify by names the group(s) whose members have permission to read and edit the page. In this case is a group &quot;everybody&quot; to give read permission to everybody.</div><div class=""> - ``force_prefix``. If set to something like ``&#x27;%(id)s-&#x27;`` it will restrict authors (not editors) to creating pages with a prefix like &quot;[user id]-[page name]&quot;. The prefix can contain the id (&quot;%(id)s&quot;) or the username (&quot;%(username)s&quot;) or any other field from the auth_user table, as long as the corresponding column contains valid string that would pass URL validation.</div><div class=""> - ``restrict_search``. This defaults to ``False`` and any logged-in user can search all wiki pages (but not necessary read or edit them). If set to ``True``, authors can search only their own pages, editors can search everything, other users cannot search anything.</div><div class=""> - ``menugroups``. This defaults to ``None`` and it indicates that wiki management menu (search, create, edit, etc.) is always displayed. You can set it to a list of group names whose members only can see this menu, for example ``[&#x27;wiki-editor&#x27;,&#x27;wiki-author&#x27;]``. Notice that even if the menu is exposed to everybody that does not mean everybody is allowed to perform actions listed in the menu since they are regulated by the access control system.</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/042a31d45d81ff3bc7ce198a6007d2750e27c39e">042a31d</a><ul><li>Date : 2012-12-28</li><li>... setting resolve to False ...</li></ul></li></ul>
<div class="row-fluid" id="com_042a31d45d81ff3bc7ce198a6007d2750e27c39e">
    <div class="span6"><div class="diff"><div class="insert">Also, by setting resolve to ``<span class="highlight">Fals</span>e`` in the method call, the wiki tables will be now accesible trough the app&#x27;s default db interface at ``&lt;app&gt;/appadmin`` for managing wiki records.</div><div class=""> </div><div class=""> </div><div class=""> Another customization possible is adding extra fields to the standard wiki tables (in the same way as with the ``auth_user`` table, as described in Chapter 9). Here is how:</div><div class=""> </div><div class=""> ``</div><div class=""> # Place this after auth object initialization</div><div class=""> auth.settings.extra_fields[&quot;wiki_page&quot;] = [Field(&quot;ablob&quot;, &quot;blob&quot;),]</div><div class=""> ``:code</div><div class=""> </div><div class="insert">The line above adds a <span class="highlight">``blob``</span> field to the <span class="highlight">``</span>wiki_page<span class="highlight">``</span> table. There is no need to call ``auth.wiki(resolve=False)``:code for this option, unless you need access to the wiki model for other customizations.</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">Also, by setting resolve to ``<span class="highlight">Tru</span>e`` in the method call, the wiki tables will be now accesible trough the app&#x27;s default db interface at ``&lt;app&gt;/appadmin`` for managing wiki records.</div><div class=""> </div><div class=""> </div><div class=""> Another customization possible is adding extra fields to the standard wiki tables (in the same way as with the ``auth_user`` table, as described in Chapter 9). Here is how:</div><div class=""> </div><div class=""> ``</div><div class=""> # Place this after auth object initialization</div><div class=""> auth.settings.extra_fields[&quot;wiki_page&quot;] = [Field(&quot;ablob&quot;, &quot;blob&quot;),]</div><div class=""> ``:code</div><div class=""> </div><div class="delete">The line above adds a <span class="highlight">blob</span> field to the <span class="highlight"></span>wiki_page<span class="highlight"></span> table. There is no need to call ``auth.wiki(resolve=False)``:code for this option, unless you need access to the wiki model for other customizations.</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/6e285db3ac654e46aae2fe589b7505f177354fce">6e285db</a><ul><li>Date : 2012-12-28</li><li>qdb and Expose</li></ul></li></ul>
<div class="row-fluid" id="com_6e285db3ac654e46aae2fe589b7505f177354fce">
    <div class="span6"><div class="diff"><div class="insert">+&#x27;&#x27;(requires Python 2.6 or later)&#x27;&#x27;</div><div class="insert">+</div><div class="insert">+The web2py admin includes a web based debugger. Using the provided web-based editor you can add breakpoints to the Python code and, from the associated debugger console, you can inspect the system variables at those breakpoints and resume execution. This is illustrated in the following screenshot:</div><div class="insert">+</div><div class=""> [[image @///image/debugger.png center 480px]]</div><div class=""> </div><div class="insert">+This functionality is based on the Qdb debugger created by Mariano Reingart.</div><div class="insert">+It uses multiprocessing.connection to communicate between the backend</div><div class="insert">+and frontend, with a JSONRPC-like stream protocol. ``qdb``:cite</div><div class="insert">+</div><div class=""> ##### Shell</div></div></div>
    <div class="span6"><div class="diff"><div class=""> [[image @///image/debugger.png center 480px]]</div><div class=""> </div><div class=""> ##### Shell</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/49f38ab7ef56de1eb4ef48f68427ebf8a46b505d">49f38ab</a><ul><li>Date : 2012-12-26</li><li>more small edits</li></ul></li></ul>
<div class="row-fluid" id="com_49f38ab7ef56de1eb4ef48f68427ebf8a46b505d">
    <div class="span6"><div class="diff"><div class="insert">On <span class="highlight">Unix and L</span>in<span class="highlight">ux (source </span>d<span class="highlight">istributi</span>o<span class="highlight">n)</span>, run:</div><div class=""> ``</div><div class="insert"><span class="highlight">python </span>web2py.<span class="highlight">py</span></div><div class=""> ``:code</div><div class=""> </div><div class="insert">On OS X<span class="highlight"> (binary distribution)</span>, run:</div><div class=""> ``</div><div class=""> open web2py.app</div><div class=""> ``:code</div><div class=""> </div><div class="insert">On <span class="highlight">W</span>i<span class="highlight"></span>nd<span class="highlight">ows</span> <span class="highlight">(b</span>in<span class="highlight">ary web2py distrib</span>u<span class="highlight">tion)</span>, run<span class="highlight"></span>:</div><div class=""> ``</div><div class="insert"><span class="highlight"></span>web2py.<span class="highlight">exe</span></div><div class=""> ``:code</div><div class=""> </div><div class="insert"><span class="highlight">O</span>n Windows <span class="highlight">(</span>source <span class="highlight">web2py d</span>i<span class="highlight"></span>st<span class="highlight">r</span>i<span class="highlight">bu</span>t<span class="highlight"></span>ion<span class="highlight">)</span>,<span class="highlight"></span> run:</div><div class=""> ``</div><div class="insert"><span class="highlight">c:/Python27/</span>python<span class="highlight"></span>.<span class="highlight">exe</span> web2py.<span class="highlight">exe</span></div><div class=""> ``:code</div><div class=""> </div><div class="insert">+------</div><div class="insert">+Attention, to run web2py on Windows from source you must install first Mark Hammond&#x27;s [[Python for Windows extensions http://sourceforge.net/projects/pywin32/]]</div><div class="insert">+------</div><div class=""> </div><div class=""> The web2py program accepts various command line options which are discussed later.</div><div class=""> </div><div class=""> By default, at startup, web2py displays a startup window and then displays a GUI widget that asks you to choose a one-time administrator password, the IP address of the network interface to be used for the web server, and a port number from which to serve requests. By default, web2py runs its web server on 127.0.0.1:8000 (port 8000 on localhost), but you can run it on any available IP address and port. You can query the IP address of your network interface by opening a command line and typing ``ipconfig`` on Windows or ``ifconfig`` on OS X and Linux. From now on we assume web2py is running on localhost (127.0.0.1:8000). Use 0.0.0.0:80 to run web2py publicly on any of your network interfaces.</div><div class=""> </div><div class=""> [[image @///image/en400.png center 306px]]</div><div class=""> </div><div class=""> If you do not provide an administrator password, the administration interface is disabled. This is a security measure to prevent publicly exposing the admin interface.</div><div class=""> </div><div class=""> The administrative interface, **admin**, is only accessible from localhost unless you run web2py behind Apache with mod_proxy. If **admin** detects a proxy, the session cookie is set to secure and **admin** login does not work unless the communication between the client and the proxy goes over HTTPS; this is a security measure. All communications between the client and **admin** must always be local or encrypted; otherwise an attacker would be able to perform a man-in-the middle attack or a replay attack and execute arbitrary code on the server.</div><div class=""> </div><div class=""> After the administration password has been set, web2py starts up the web browser at the page:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/</div><div class=""> ``:code</div><div class=""> </div><div class=""> If the computer does not have a default browser, open a web browser and enter the URL.</div><div class=""> </div><div class=""> [[image @///image/en500.png center 480px]]</div><div class=""> </div><div class=""> Clicking on &quot;administrative interface&quot; takes you to the login page for the administration interface.</div><div class=""> </div><div class=""> [[image @///image/en600.png center 480px]]</div><div class=""> </div><div class=""> The administrator password is the password you chose at startup.</div><div class=""> Notice that there is only one administrator, and therefore only one administrator password. For security reasons, the developer is asked to choose a new password every time web2py starts unless the &lt;recycle&gt; option is specified. This is distinct from the authentication mechanism in web2py applications.</div><div class=""> </div><div class=""> After the administrator logs into web2py, the browser is redirected to the &quot;site&quot; page.</div><div class=""> </div><div class=""> [[image @///image/en700.png center 480px]]</div><div class=""> Notice that ``counter`` is not a web2py keyword but ``session`` is. We are askin</div><div class=""> A more compact way to code the same function is this:</div><div class=""> ``</div><div class=""> def index():</div><div class="">     session.counter = (session.counter or 0) + 1</div><div class="">     return dict(message=&quot;Hello from MyApp&quot;, counter=session.counter)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Now modify the view to add a line that displays the value of the counter:</div><div class=""> ``</div><div class=""> &lt;html&gt;</div><div class="">    &lt;head&gt;&lt;/head&gt;</div><div class="">    &lt;body&gt;</div><div class="">       &lt;h1&gt;{{=message}}&lt;/h1&gt;</div><div class="">       &lt;h2&gt;Number of visits: {{=counter}}&lt;/h2&gt;</div><div class="">    &lt;/body&gt;</div><div class=""> &lt;/html&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> When you visit the index page again (and again) you should get the following HTML page:</div><div class=""> </div><div class=""> [[image @///image/en1300.png center 480px]]</div><div class=""> </div><div class=""> The counter is associated with each visitor, and is incremented each time the visitor reloads the page. Different visitors see different counters.</div><div class=""> </div><div class=""> </div><div class=""> #### Say my name</div><div class=""> ``form``:inxx ``request.vars``:inxx</div><div class=""> </div><div class=""> Now create two pages (first and second), where the first page creates a form, asks the visitor&#x27;s name, and redirects to the second page, which greets the visitor by name.</div><div class=""> </div><div class="insert">[[yUML diagram @///image/en1400.png center 2<span class="highlight">00</span>px]]</div><div class=""> </div><div class=""> Write the corresponding actions in the default controller:</div><div class=""> ``</div><div class=""> def first():</div><div class="">     return dict()</div><div class=""> </div><div class=""> def second():</div><div class="">     return dict()</div><div class=""> ``:code</div><div class=""> </div><div class=""> Then create a view &quot;default/first.html&quot; for the first action,</div><div class=""> and enter:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;What is your name?&lt;/h1&gt;</div><div class=""> &lt;form action=&quot;second&quot;&gt;</div><div class="">   &lt;input name=&quot;visitor_name&quot; /&gt;</div><div class="">   &lt;input type=&quot;submit&quot; /&gt;</div><div class=""> &lt;/form&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> Finally, create a view &quot;default/second.html&quot; for the second action:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Hello {{=request.vars.visitor_name}}&lt;/h1&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> ``layout``:inxx</div><div class=""> In both views we have extended the basic &quot;layout.html&quot; view that comes with web2py. The layout view keeps the look and feel of the two pages coherent. The layout file can be edited and replaced easily, since it mainly contains HTML code.</div><div class=""> </div><div class=""> If you now visit the first page, type your name:</div><div class=""> </div><div class=""> [[image @///image/en1500.png center 480px]]</div><div class=""> </div><div class=""> and submit the form, you will receive a greeting:</div><div class=""> </div><div class=""> [[image @///image/en1600.png center 480px]]</div><div class=""> </div><div class=""> #### Postbacks</div><div class=""> ``redirect``:inxx ``URL``:inxx ``postback``:inxx</div><div class=""> </div><div class=""> The mechanism for form submission that we used before is very common, but it is not good programming practice. All input should be validated and, in the above example, the burden of validation would fall on the second action. Thus the action that performs the validation is different from the action that generated the form. This tends to cause redundancy in the code.</div><div class=""> </div><div class=""> A better pattern for form submission is to submit forms to the same action that generated them, in our example the &quot;first&quot;. The &quot;first&quot; action should receive the variables, process them, store them server-side, and redirect the visitor to the &quot;second&quot; page, which retrieves the variables. This mechanism is called a &#x27;&#x27;postback&#x27;&#x27;.</div><div class=""> </div><div class="insert">[[yUML diagram @///image/en1700.png center 2<span class="highlight">00</span>px]]</div><div class=""> </div><div class=""> Modify the default controller to implement self-submission:</div><div class=""> ``</div><div class=""> def first():</div><div class="">     if request.vars.visitor_name:</div><div class="">         session.visitor_name = request.vars.visitor_name</div><div class="">         redirect(URL(&#x27;second&#x27;))</div><div class="">     return dict()</div><div class=""> </div><div class=""> def second():</div><div class="">     return dict()</div><div class=""> ``:code</div><div class=""> </div><div class=""> Then modify the &quot;default/first.html&quot; view:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> What is your name?</div><div class=""> &lt;form&gt;</div><div class="">   &lt;input name=&quot;visitor_name&quot; /&gt;</div><div class="">   &lt;input type=&quot;submit&quot; /&gt;</div><div class=""> &lt;/form&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> and the &quot;default/second.html&quot; view needs to retrieve the data from the ``session`` instead of from the ``request.vars``:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Hello {{=session.visitor_name or &quot;anonymous&quot;}}&lt;/h1&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> From the point of view of the visitor, the self-submission behaves exactly the same as the previous implementation. We have not added validation yet, but it is now clear that validation should be performed by the first action.</div><div class=""> with associated &quot;views/default/manage.html&quot;</div><div class=""> Using appadmin create a group &quot;manager&quot; and make some users members of the group. They will not be able to access</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/manage</div><div class=""> ``</div><div class=""> </div><div class=""> and browse, search:</div><div class=""> </div><div class=""> [[image @///image/en3200.png center 480px]]</div><div class=""> </div><div class=""> create, update and delete images and their comments:</div><div class=""> </div><div class=""> [[image @///image/en3300.png center 480px]]</div><div class=""> </div><div class=""> #### Configuring the layout</div><div class=""> </div><div class=""> You can configure the default layout by editing &quot;views/layout.html&quot; but you can also configure it without editing the HTML. In fact, the &quot;static/base.css&quot; stylesheet is well documented and described in Chapter 5. You can change color, columns, size, borders and background without editing the HTML. If you want to edit the menu, the title or the subtitle, you can do so in any model file. The scaffolding app, sets default values of these parameters in the file &quot;models/menu.py&quot;:</div><div class=""> </div><div class=""> ``</div><div class=""> response.title = request.application</div><div class=""> response.subtitle = &#x27;customize me!&#x27;</div><div class=""> response.meta.author = &#x27;you&#x27;</div><div class=""> response.meta.description = &#x27;describe your app&#x27;</div><div class=""> response.meta.keywords = &#x27;bla bla bla&#x27;</div><div class=""> response.menu = [ [ &#x27;Index&#x27;, False, URL(&#x27;index&#x27;) ] ]</div><div class=""> ``:code</div><div class=""> </div><div class=""> ### A simple wiki</div><div class=""> ``wiki``:inxx ``RSS``:inxx ``Ajax``:inxx ``XMLRPC``:inxx</div><div class=""> </div><div class="insert"><span class="highlight">In this section, we build a simple wiki from scratch using only low level APIs (as opposed to using the built-in wiki capabilities of web2py demonstrated in the next section). </span>The <span class="highlight">visitor will be able to create pages, search them (by title), and edit them. The visitor will also be able to post comments (exactly as in the previous applications), and also post documents (as attachments to the pages) and link them </span>f<span class="highlight">rom the pages. As a convention, we adopt the Mar</span>k<span class="highlight">min syntax for o</span>u<span class="highlight">r wiki syntax</span>.<span class="highlight"> We will also implement a search page with Ajax, an RSS feed for the pages, and a handler to search the pages via XML-RPC``xmlrpc``:cite . The following diagram lists the actions that we need to implement and the links we intend to build among them.</span></div><div class=""> </div><div class="insert">[[yUML diagram @///image/en3400.png center 2<span class="highlight">0</span>0px]]</div><div class=""> </div><div class=""> Start by creating a new scaffolding app, naming it &quot;mywiki&quot;.</div><div class=""> </div><div class=""> The model must contain three tables: page, comment, and document. Both comment and document reference page because they belong to page. A document contains a file field of type upload as in the previous images application.</div><div class=""> </div><div class=""> Here is the complete model:</div><div class=""> ``</div><div class=""> db = DAL(&#x27;sqlite://storage.sqlite&#x27;)</div><div class=""> </div><div class=""> from gluon.tools import *</div><div class=""> auth = Auth(db)</div><div class=""> auth.define_tables()</div><div class=""> crud = Crud(db)</div><div class=""> </div><div class=""> db.define_table(&#x27;page&#x27;,</div><div class="">     Field(&#x27;title&#x27;),</div><div class="">     Field(&#x27;body&#x27;, &#x27;text&#x27;),</div><div class="">     Field(&#x27;created_on&#x27;, &#x27;datetime&#x27;, default=request.now),</div><div class="">     Field(&#x27;created_by&#x27;, &#x27;reference auth_user&#x27;, default=auth.user_id),</div><div class="">     format=&#x27;%(title)s&#x27;)</div><div class=""> </div><div class=""> db.define_table(&#x27;comment&#x27;,</div><div class="">     Field(&#x27;page_id&#x27;, &#x27;reference page&#x27;),</div><div class="">     Field(&#x27;body&#x27;, &#x27;text&#x27;),</div><div class="">     Field(&#x27;created_on&#x27;, &#x27;datetime&#x27;, default=request.now),</div><div class="">     Field(&#x27;created_by&#x27;, &#x27;reference auth_user&#x27;, default=auth.user_id))</div><div class=""> </div><div class=""> db.define_table(&#x27;document&#x27;,</div><div class="">     Field(&#x27;page_id&#x27;, &#x27;reference page&#x27;),</div><div class="">     Field(&#x27;name&#x27;),</div><div class=""> Python program.</div><div class="">         print item[&#x27;created_on&#x27;], item[&#x27;title&#x27;]</div><div class=""> ``:code</div><div class=""> </div><div class=""> The handler can be accessed from many other programming languages that understand XML-RPC, including C, C++, C# and Java.</div><div class=""> </div><div class=""> #### On ``date``, ``datetime`` and ``time`` format</div><div class=""> </div><div class=""> There are three different representation for each of the field types ``date``, ``datetime`` and ``time``:</div><div class=""> - the database representation</div><div class=""> - the internal web2py prepresentation</div><div class=""> - the string representation in forms and tables</div><div class=""> </div><div class=""> The database representation is an internal issue and does not affect the code. Internally, at the web2py level, they are stored as ``datetime.date``, ``datetime.datetime`` and ``datetime.time`` object respectively and they can be manipulated as such:</div><div class=""> </div><div class=""> ``</div><div class=""> for page in db(db.page).select():</div><div class="">     print page.title, page.day, page.month, page.year</div><div class=""> ``</div><div class=""> </div><div class=""> When dates are converted to strings in forms they are converted using the ISO representation </div><div class=""> ``</div><div class=""> %Y-%m-%d %H:%M:%S</div><div class=""> ``</div><div class=""> </div><div class=""> yet this representation in internationalized and you can use the admin stranslation page to change the format to an alternate one. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> %m/%b/%Y %H:%M:%S</div><div class=""> ``</div><div class=""> </div><div class=""> Mind that by default English is not translated because web2py assumes the applications is already written in English. If you want internationalization to work for English you need to create the translation file (using admin) and you need declare that the application current language is something other than english, for example:</div><div class=""> ``</div><div class=""> T.current_languages = [&#x27;null&#x27;]</div><div class=""> ``</div><div class=""> </div><div class=""> ### The built-in web2py wiki</div><div class=""> </div><div class="insert">Now you can forget the code we have built-in the previous section (not what you have learned about web2py APIs, just the code of the specific example) as we are going to provide and example of the built-in web2py wiki.<span class="highlight"> </span></div><div class=""> </div><div class=""> In fact, web2py comes with wiki capabilities including media attachments, tags, tag cloud, page permissions, and support for oembed ``oembed``:cite and components (chapter 14). This wiki can be used with any web2py application.</div><div class=""> </div><div class="insert">+------</div><div class="insert">+Notice the API of the built-in wiki are still considered experimental and small changes are still possible.</div><div class="insert">+------</div><div class="insert">+</div><div class=""> Here we assume we are starting from cratch from a simple clone of the &quot;welcome&quot; application called &quot;wikidemo&quot;. Edit the controller and replace the &quot;index&quot; action with</div><div class=""> </div><div class=""> ``</div><div class=""> def index(): return auth.wiki()</div><div class=""> ``:code</div><div class=""> </div><div class=""> Done! You have a fully working wiki. At this point no page has been created and in order to create pages you must be logged-in and you must be member of a group called &quot;wiki-editor&quot; or &quot;wiki-author&quot;. If you are logged as administrator the &quot;wiki-editor&quot; group is created automatically and you are made a member. The difference between editors and authors is that the editors can create pages, edit and delete any page, while the authors can create pages (with some optional restrictions) and can only edit/delete the pages they have created.</div><div class=""> </div><div class=""> The ``auth.wiki()`` function returns in a dictionary with a key ``content`` which is undesrtood by the scaffolding &quot;views/default/index.html&quot;. You man make your own view for the this action:</div><div class=""> </div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> {{=content}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> and add extra HTML or code as needed. There is no need to call the action &quot;index&quot;.</div><div class=""> </div><div class=""> To try the wiki, simply login into admin, visit the page</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index</div><div class=""> ``</div><div class=""> </div><div class=""> Then choose a slug (in the publishing business, a slug is a short name given to an article that is in production) and you will be redirected to an empty page where you can edit the content using MARKMIN wiki syntax. A new menu item called &quot;[wiki]&quot; will allow you create, search, and edit pages. Wiki pages have RULS like:</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/[slug]</div><div class=""> ``</div><div class=""> </div><div class=""> Service pages have names which start by underscore:</div><div class=""> and the following action:</div><div class=""> @auth.requires_login()</div><div class=""> def manage_things():</div><div class="">     return SQLFORM.grid(db.thing)</div><div class=""> ``:code</div><div class=""> </div><div class=""> This action is special because it returns a widget/helper not a dict of objects. Now we can embed this ``manage_things`` action into any view, with</div><div class=""> </div><div class=""> ``</div><div class=""> {{=LOAD(&#x27;default&#x27;,&#x27;manage_things&#x27;,ajax=True)}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> This allows the visitor interact with the component via Ajax without reloadin the host page that embeds the widget. Basically the action is called via Ajax, inherits the stile of the host page, and capture all forms submissions and flash messages so that thye are handled within the current page. On top of this the ``SQLFORM.grid`` widget uses digitally signed URLs to restrict access. More informaiton about components can be found in chapter 13.</div><div class=""> </div><div class=""> Components like the one above can be embedded into wiki pages using the MARKMIN syntax:</div><div class=""> </div><div class=""> ``</div><div class=""> @{component:default/manage_things}</div><div class=""> ``</div><div class=""> </div><div class=""> This simply tells web2py that we want to incude the &quot;manage_things&quot; action defined in the &quot;default&quot; controller as an Ajax &quot;component&quot;.</div><div class=""> </div><div class=""> ---------</div><div class=""> Most users will be able to build relatively complex applications simply by using ``auth.wiki`` to create pages and menus, and embedded custom components into wiki pages. Wiki can be tough as a mechanism to allow members of the group to create pages but they calso be though as a way to develop applications in a modular way.</div><div class=""> ---------</div><div class=""> </div><div class=""> ### More on **admin**</div><div class=""> ``admin``:inxx</div><div class=""> </div><div class=""> The administrative interface provides additional functionality that we briefly review here.</div><div class=""> </div><div class="insert">#### <span class="highlight">S</span>ite<span class="highlight"></span></div><div class=""> ``site``:inxx</div><div class=""> </div><div class=""> This page lists all installed applications. There are two forms at the bottom.</div><div class=""> </div><div class=""> The first of them allows creating a new application by specifying its name.</div><div class=""> </div><div class=""> ``Instant Press``:inxx ``Movuca``:inxx</div><div class=""> The second form allows uploading an existing application from either a local file or a remote URL. When you upload an application, you need to specify a name for it. This can be its original name, but does not need to be. This allows installing multiple copies of the same application. You can try, for example, to upload the Movuca Social Networking application app created by Bruno Rocha:</div><div class=""> </div><div class=""> ``</div><div class=""> http://code.google.com/p/instant-press/</div><div class=""> ``</div><div class=""> </div><div class=""> or Instant Press CMS created by Martin Mulone:</div><div class=""> </div><div class=""> ``</div><div class=""> http://code.google.com/p/instant-press/</div><div class=""> ``</div><div class=""> </div><div class=""> or one of the many example applications available at:</div><div class=""> </div><div class=""> ``</div><div class=""> http://web2py.com/appliances</div><div class=""> ``</div><div class=""> </div><div class=""> ------</div><div class=""> Web2py files are packages as ``.w2p`` files. These ones are tar gzipped files. Web2py uses the ``.w2p`` extension instead of the ``.tgz`` extension to prevent the browser from unzipping on download. They can be uncompressed manually with ``tar zxvf [filename]`` although this is never necessary.</div><div class=""> ------</div><div class=""> </div><div class=""> [[image @///image/en4100.png center 444px]]</div><div class=""> </div><div class=""> Upon successful upload, web2py displays the MD5 checksum of the uploaded file. You can use it to verify that the file was not corrupted during upload. The InstantPress name will appear in the list of installed applications.</div><div class=""> </div><div class=""> Click on the application name on admin to get it up and running.</div><div class=""> </div><div class=""> If you run web2py from source and you have ``pyhton-git`` installed, you can install applications directly from git reporsitory using the ``.git`` URL in the upload form. In this case you will also be used to user the admin interface to push changes back into the repository.</div><div class=""> </div><div class=""> For each application the &#x27;&#x27;site&#x27;&#x27; page allows you to:</div><div class=""> - Uninstall the application.</div><div class=""> - Jump to the &#x27;&#x27;about&#x27;&#x27; page (read below).</div><div class=""> - Jump to the &#x27;&#x27;edit&#x27;&#x27; page (read below).</div><div class=""> - Jump to the &#x27;&#x27;errors&#x27;&#x27; page (read below).</div><div class=""> - Clean up temporary files (sessions, errors, and cache.disk files).</div><div class=""> - Pack all. This returns a tar file containing a complete copy of the application. We suggest that you clean up temporary files before packing an application.</div><div class=""> - Compile the application. If there are no errors, this option will bytecode-compile all models, controllers and views. Because views can extend and include other views in a tree, before bytecode compilation, the view tree for every controller is collapsed into a single file. The net effect is that a bytecode-compiled application is faster, because there is no more parsing of templates or string substitutions occurring at runtime.</div><div class=""> - Pack compiled. This option is only present for bytecode-compiled applications. It allows packing the application without source code for distribution as closed source. Note that Python (as any other programming language) can technically be decompiled; therefore compilation does not provide complete protection of the source code. Nevertheless, decompilation can be difficult and can be illegal.</div><div class=""> - Remove compiled. It simply removes the byte-code compiled models, views and controllers from the application. If the application was packaged with source code or edited locally, there is no harm in removing the bytecode-compiled files, and the application will continue to work. If the application was installed form a packed compiled file, then this is not safe, because there is no source code to revert to, and the application will no longer work.</div><div class=""> </div><div class=""> ``admin.py``:inxx</div><div class=""> </div><div class=""> -------</div><div class=""> All the functionality available from the web2py admin site page is also accessible programmatically via the API defined in the module ``gluon/admin.py``. Simply open a python shell and import this module.</div><div class=""> -------</div><div class=""> </div><div class=""> If the Google App Engine SDK is installer the admin &#x27;&#x27;site&#x27;&#x27; page shows a button to push your applications to GAE. If ``python-git`` is installed, there is also a button to push your application to Open Shift. To install applications on ``heroku`` or other hosting system you should look into the &quot;scripts&quot; folder for the appropriate script.</div><div class=""> </div><div class="insert">#### <span class="highlight">A</span>bout<span class="highlight"></span></div><div class=""> ``about``:inxx ``license``:inxx</div><div class=""> </div><div class=""> The &#x27;&#x27;about&#x27;&#x27; tab allows editing the description of the application and its license. These are written respectively in the ABOUT and LICENSE files in the application folder.</div><div class=""> </div><div class=""> [[image @///image/en4300.png center 480px]]</div><div class=""> </div><div class=""> You can use ``MARKMIN``, or ``gluon.contrib.markdown.WIKI`` syntax for these files as described in ref.``markdown2``:cite .</div><div class=""> </div><div class="insert">#### <span class="highlight">D</span>e<span class="highlight">s</span>i<span class="highlight">gn</span></div><div class=""> ``EDIT``:inxx</div><div class=""> You have used the &#x27;&#x27;edit&#x27;&#x27; page already in this chapter. Here we want to point out a few more functionalities of the &#x27;&#x27;edit&#x27;&#x27; page.</div><div class=""> - If you click on any file name, you can see the contents of the file with syntax highlighting.</div><div class=""> - If you click on edit, you can edit the file via a web interface.</div><div class=""> - If you click on delete, you can delete the file (permanently).</div><div class=""> - If you click on test, web2py will run tests. Tests are written by the developer using Python doctests, and each function should have its own tests.</div><div class=""> - You can add language files, scan the app to discover all strings, and edit string translations via the web interface.</div><div class=""> - If the static files are organized in folders and subfolders, the folder hierarchy can be toggled by clicking on a folder name.</div><div class=""> </div><div class=""> The image below shows the output of the test page for the welcome application.</div><div class=""> </div><div class=""> [[image @///image/en4400.png center 480px]]</div><div class=""> </div><div class=""> The image below show the languages tab for the welcome application.</div><div class=""> </div><div class=""> [[image @///image/en4500.png center 480px]]</div><div class=""> </div><div class=""> The image below shows how to edit a language file, in this case the &quot;it&quot; (Italian) language for the welcome application.</div><div class=""> </div><div class=""> [[image @///image/en4600.png center 480px]]</div><div class=""> </div><div class="insert">+##### Intergated debugger</div><div class="insert">+</div><div class="insert">+##### Shell</div><div class=""> </div><div class=""> If you click on the &quot;shell&quot; link under the controllers tab in &#x27;&#x27;edit&#x27;&#x27;, web2py will open a web based Python shell and will execute the models for the current application. This allows you to interactively talk to your application.</div><div class=""> </div><div class=""> [[image @///image/en4700.png center 480px]]</div><div class=""> </div><div class="insert">##### <span class="highlight">C</span>rontab<span class="highlight"></span></div><div class=""> </div><div class=""> Also under the controllers tab in &#x27;&#x27;edit&#x27;&#x27; there is a &quot;crontab&quot; link. By clicking on this link you will be able to edit the web2py crontab file. This follows the same syntax as the unix crontab but does not rely on unix. In fact, it only requires web2py, and it works on Windows. It allows you to register actions that need to be executed in background at scheduled times.</div><div class=""> For more information about this, see the next chapter.</div><div class=""> </div><div class="insert">#### <span class="highlight">E</span>rrors<span class="highlight"></span></div><div class=""> ``errors``:inxx</div><div class="insert">+</div><div class=""> When programming web2py, you will inevitably make mistakes and introduce bugs. web2py helps in two ways: 1) it allows you to create tests for every function that can be run in the browser from the &#x27;&#x27;edit&#x27;&#x27; page; and 2) when an error manifests itself, a ticket is issued to the visitor and the error is logged.</div><div class=""> </div><div class=""> Intentionally introduce an error in the images application as shown below:</div><div class=""> ``</div><div class=""> def index():</div><div class="">     images = db().select(db.image.ALL,orderby=db.image.title)</div><div class="">     1/0</div><div class="">     return dict(images=images)</div><div class=""> ``:code</div><div class=""> </div><div class=""> When you access the index action, you get the following ticket:</div><div class=""> </div><div class=""> [[image @///image/en4800.png center 480px]]</div><div class=""> </div><div class=""> Only the administrator can access the ticket:</div><div class=""> </div><div class=""> [[image @///image/en4900.png center 480px]]</div><div class=""> </div><div class=""> The ticket shows the traceback, and the content of the file that caused the problem, and the complete state of system (variables, request, session, etc.) If the error occurs in a view, web2py shows the view converted from HTML into Python code. This allows to easily identify the logical structure of the file.</div><div class=""> </div><div class=""> By default tickets are stored on filesystem and group by traceback. The administrative interface provides an aggregate views (type of traceback and number of occurrence) and a detailed view (all tickets are listed by ticket id). The administrator can switch between the two views.</div><div class=""> </div><div class=""> Notice that everywhere **admin** shows syntax-highlighted code (for example, in error reports, web2py keywords are shown in orange). If you click on a web2py keyword, you are redirected to a documentation page about the keyword.</div><div class=""> </div><div class=""> If you fix the divide-by-zero bug in the index action and introduce one in the index view:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> </div><div class=""> &lt;h1&gt;Current Images&lt;/h1&gt;</div><div class=""> &lt;ul&gt;</div><div class=""> {{for image in images:}}</div><div class=""> {{1/0}}</div><div class=""> {{=LI(A(image.title, _href=URL(&quot;show&quot;, args=image.id)))}}</div><div class=""> {{pass}}</div><div class=""> &lt;/ul&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> you get the following ticket:</div><div class=""> </div><div class=""> [[image @///image/en5000.png center 480px]]</div><div class=""> </div><div class=""> Note that web2py has converted the view from HTML into a Python file, and the error described in the ticket refers to the generated Python code and NOT to the original view file:</div><div class=""> </div><div class=""> [[image @///image/en5100.png center 480px]]</div><div class=""> </div><div class=""> This may seem confusing at first, but in practice it makes debugging easier, because the Python indentation highlights the logical structure of the code that you embedded in the views.</div><div class=""> </div><div class=""> The code is shown at the bottom of the same page.</div><div class=""> </div><div class=""> All tickets are listed under admin in the &#x27;&#x27;errors&#x27;&#x27; page for each application:</div><div class=""> </div><div class=""> [[image @///image/en5200.png center 480px]]</div><div class=""> </div><div class="insert">#### <span class="highlight"></span>Mercurial<span class="highlight"></span></div><div class=""> ``Mercurial``:inxx</div><div class=""> </div><div class=""> If you are running from source and you have the Mercurial version control libraries installed:</div><div class=""> ``</div><div class=""> easy_install mercurial</div><div class=""> ``:code</div><div class=""> </div><div class=""> then the administrative interface shows one more menu item called &quot;Versioning&quot;. It automatically creates a local Mercurial repository for the application. Pressing the &quot;commit&quot; button in the page will commit the current application. Mercurial creates and stores information about changes you make in your code into a hidden folder &quot;.hg&quot; in your app subfolder. Every app has its own &quot;.hg&quot; folder and its own &quot;.hgignore&quot; file (tells Mercurial which files to ignore).</div><div class=""> </div><div class=""> The Mercurial web interface does allow you to browse previous commit and diff files but we do recommend you use Mercurial directly from the shell or one of the many GUI-based Mercurial clients since they are more powerful. For example they will allow you sync your app with a remote source repository:</div><div class=""> </div><div class=""> [[images @///image/en5300.png center 480px]]</div><div class=""> </div><div class=""> </div><div class=""> You can read more about Mercurial here:</div><div class=""> ``</div><div class=""> http://mercurial.selenic.com/</div><div class=""> ``</div><div class=""> </div><div class="insert">#### A<span class="highlight">ppl</span>i<span class="highlight">catio</span>n <span class="highlight">W</span>izard (experimental)</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">On <span class="highlight">W</span>in<span class="highlight"></span>d<span class="highlight"></span>o<span class="highlight">ws</span>, run:</div><div class=""> ``</div><div class="delete"><span class="highlight"></span>web2py.<span class="highlight">exe</span></div><div class=""> ``:code</div><div class=""> </div><div class="delete">On OS X<span class="highlight"></span>, run:</div><div class=""> ``</div><div class=""> open web2py.app</div><div class=""> ``:code</div><div class=""> </div><div class="delete">On <span class="highlight">Un</span>i<span class="highlight">x a</span>nd<span class="highlight"></span> <span class="highlight">L</span>in<span class="highlight"></span>u<span class="highlight">x</span>, run<span class="highlight"> from source by typing</span>:</div><div class=""> ``</div><div class="delete"><span class="highlight">python2.5 </span>web2py.<span class="highlight">py</span></div><div class=""> ``:code</div><div class=""> </div><div class="delete"><span class="highlight">To run web2py o</span>n Windows <span class="highlight">from </span>source <span class="highlight"></span>i<span class="highlight">n</span>st<span class="highlight">all f</span>i<span class="highlight">rs</span>t<span class="highlight"> Mark Hammond&#x27;s [[Python for Windows extens</span>ion<span class="highlight">s http://sourceforge.net/projects/pywin32/]]</span>,<span class="highlight"> then</span> run:</div><div class=""> ``</div><div class="delete"><span class="highlight"></span>python<span class="highlight">2</span>.<span class="highlight">5</span> web2py.<span class="highlight">py</span></div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> The web2py program accepts various command line options which are discussed later.</div><div class=""> </div><div class=""> By default, at startup, web2py displays a startup window and then displays a GUI widget that asks you to choose a one-time administrator password, the IP address of the network interface to be used for the web server, and a port number from which to serve requests. By default, web2py runs its web server on 127.0.0.1:8000 (port 8000 on localhost), but you can run it on any available IP address and port. You can query the IP address of your network interface by opening a command line and typing ``ipconfig`` on Windows or ``ifconfig`` on OS X and Linux. From now on we assume web2py is running on localhost (127.0.0.1:8000). Use 0.0.0.0:80 to run web2py publicly on any of your network interfaces.</div><div class=""> </div><div class=""> [[image @///image/en400.png center 306px]]</div><div class=""> </div><div class=""> If you do not provide an administrator password, the administration interface is disabled. This is a security measure to prevent publicly exposing the admin interface.</div><div class=""> </div><div class=""> The administrative interface, **admin**, is only accessible from localhost unless you run web2py behind Apache with mod_proxy. If **admin** detects a proxy, the session cookie is set to secure and **admin** login does not work unless the communication between the client and the proxy goes over HTTPS; this is a security measure. All communications between the client and **admin** must always be local or encrypted; otherwise an attacker would be able to perform a man-in-the middle attack or a replay attack and execute arbitrary code on the server.</div><div class=""> </div><div class=""> After the administration password has been set, web2py starts up the web browser at the page:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/</div><div class=""> ``:code</div><div class=""> </div><div class=""> If the computer does not have a default browser, open a web browser and enter the URL.</div><div class=""> </div><div class=""> [[image @///image/en500.png center 480px]]</div><div class=""> </div><div class=""> Clicking on &quot;administrative interface&quot; takes you to the login page for the administration interface.</div><div class=""> </div><div class=""> [[image @///image/en600.png center 480px]]</div><div class=""> </div><div class=""> The administrator password is the password you chose at startup.</div><div class=""> Notice that there is only one administrator, and therefore only one administrator password. For security reasons, the developer is asked to choose a new password every time web2py starts unless the &lt;recycle&gt; option is specified. This is distinct from the authentication mechanism in web2py applications.</div><div class=""> </div><div class=""> After the administrator logs into web2py, the browser is redirected to the &quot;site&quot; page.</div><div class=""> </div><div class=""> [[image @///image/en700.png center 480px]]</div><div class=""> Notice that ``counter`` is not a web2py keyword but ``session`` is. We are askin</div><div class=""> A more compact way to code the same function is this:</div><div class=""> ``</div><div class=""> def index():</div><div class="">     session.counter = (session.counter or 0) + 1</div><div class="">     return dict(message=&quot;Hello from MyApp&quot;, counter=session.counter)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Now modify the view to add a line that displays the value of the counter:</div><div class=""> ``</div><div class=""> &lt;html&gt;</div><div class="">    &lt;head&gt;&lt;/head&gt;</div><div class="">    &lt;body&gt;</div><div class="">       &lt;h1&gt;{{=message}}&lt;/h1&gt;</div><div class="">       &lt;h2&gt;Number of visits: {{=counter}}&lt;/h2&gt;</div><div class="">    &lt;/body&gt;</div><div class=""> &lt;/html&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> When you visit the index page again (and again) you should get the following HTML page:</div><div class=""> </div><div class=""> [[image @///image/en1300.png center 480px]]</div><div class=""> </div><div class=""> The counter is associated with each visitor, and is incremented each time the visitor reloads the page. Different visitors see different counters.</div><div class=""> </div><div class=""> </div><div class=""> #### Say my name</div><div class=""> ``form``:inxx ``request.vars``:inxx</div><div class=""> </div><div class=""> Now create two pages (first and second), where the first page creates a form, asks the visitor&#x27;s name, and redirects to the second page, which greets the visitor by name.</div><div class=""> </div><div class="delete">[[yUML diagram @///image/en1400.png center 2<span class="highlight">93</span>px]]</div><div class=""> </div><div class=""> Write the corresponding actions in the default controller:</div><div class=""> ``</div><div class=""> def first():</div><div class="">     return dict()</div><div class=""> </div><div class=""> def second():</div><div class="">     return dict()</div><div class=""> ``:code</div><div class=""> </div><div class=""> Then create a view &quot;default/first.html&quot; for the first action,</div><div class=""> and enter:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;What is your name?&lt;/h1&gt;</div><div class=""> &lt;form action=&quot;second&quot;&gt;</div><div class="">   &lt;input name=&quot;visitor_name&quot; /&gt;</div><div class="">   &lt;input type=&quot;submit&quot; /&gt;</div><div class=""> &lt;/form&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> Finally, create a view &quot;default/second.html&quot; for the second action:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Hello {{=request.vars.visitor_name}}&lt;/h1&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> ``layout``:inxx</div><div class=""> In both views we have extended the basic &quot;layout.html&quot; view that comes with web2py. The layout view keeps the look and feel of the two pages coherent. The layout file can be edited and replaced easily, since it mainly contains HTML code.</div><div class=""> </div><div class=""> If you now visit the first page, type your name:</div><div class=""> </div><div class=""> [[image @///image/en1500.png center 480px]]</div><div class=""> </div><div class=""> and submit the form, you will receive a greeting:</div><div class=""> </div><div class=""> [[image @///image/en1600.png center 480px]]</div><div class=""> </div><div class=""> #### Postbacks</div><div class=""> ``redirect``:inxx ``URL``:inxx ``postback``:inxx</div><div class=""> </div><div class=""> The mechanism for form submission that we used before is very common, but it is not good programming practice. All input should be validated and, in the above example, the burden of validation would fall on the second action. Thus the action that performs the validation is different from the action that generated the form. This tends to cause redundancy in the code.</div><div class=""> </div><div class=""> A better pattern for form submission is to submit forms to the same action that generated them, in our example the &quot;first&quot;. The &quot;first&quot; action should receive the variables, process them, store them server-side, and redirect the visitor to the &quot;second&quot; page, which retrieves the variables. This mechanism is called a &#x27;&#x27;postback&#x27;&#x27;.</div><div class=""> </div><div class="delete">[[yUML diagram @///image/en1700.png center 2<span class="highlight">93</span>px]]</div><div class=""> </div><div class=""> Modify the default controller to implement self-submission:</div><div class=""> ``</div><div class=""> def first():</div><div class="">     if request.vars.visitor_name:</div><div class="">         session.visitor_name = request.vars.visitor_name</div><div class="">         redirect(URL(&#x27;second&#x27;))</div><div class="">     return dict()</div><div class=""> </div><div class=""> def second():</div><div class="">     return dict()</div><div class=""> ``:code</div><div class=""> </div><div class=""> Then modify the &quot;default/first.html&quot; view:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> What is your name?</div><div class=""> &lt;form&gt;</div><div class="">   &lt;input name=&quot;visitor_name&quot; /&gt;</div><div class="">   &lt;input type=&quot;submit&quot; /&gt;</div><div class=""> &lt;/form&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> and the &quot;default/second.html&quot; view needs to retrieve the data from the ``session`` instead of from the ``request.vars``:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Hello {{=session.visitor_name or &quot;anonymous&quot;}}&lt;/h1&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> From the point of view of the visitor, the self-submission behaves exactly the same as the previous implementation. We have not added validation yet, but it is now clear that validation should be performed by the first action.</div><div class=""> with associated &quot;views/default/manage.html&quot;</div><div class=""> Using appadmin create a group &quot;manager&quot; and make some users members of the group. They will not be able to access</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/manage</div><div class=""> ``</div><div class=""> </div><div class=""> and browse, search:</div><div class=""> </div><div class=""> [[image @///image/en3200.png center 480px]]</div><div class=""> </div><div class=""> create, update and delete images and their comments:</div><div class=""> </div><div class=""> [[image @///image/en3300.png center 480px]]</div><div class=""> </div><div class=""> #### Configuring the layout</div><div class=""> </div><div class=""> You can configure the default layout by editing &quot;views/layout.html&quot; but you can also configure it without editing the HTML. In fact, the &quot;static/base.css&quot; stylesheet is well documented and described in Chapter 5. You can change color, columns, size, borders and background without editing the HTML. If you want to edit the menu, the title or the subtitle, you can do so in any model file. The scaffolding app, sets default values of these parameters in the file &quot;models/menu.py&quot;:</div><div class=""> </div><div class=""> ``</div><div class=""> response.title = request.application</div><div class=""> response.subtitle = &#x27;customize me!&#x27;</div><div class=""> response.meta.author = &#x27;you&#x27;</div><div class=""> response.meta.description = &#x27;describe your app&#x27;</div><div class=""> response.meta.keywords = &#x27;bla bla bla&#x27;</div><div class=""> response.menu = [ [ &#x27;Index&#x27;, False, URL(&#x27;index&#x27;) ] ]</div><div class=""> ``:code</div><div class=""> </div><div class=""> ### A simple wiki</div><div class=""> ``wiki``:inxx ``RSS``:inxx ``Ajax``:inxx ``XMLRPC``:inxx</div><div class=""> </div><div class="delete">-In this section, we build a simple wiki from scratch using only low level APIs (as opposed to using the built-in wiki capabilities of web2py demonstrated in the next section). The visitor will be able to create pages, search them (by title), and edit them. The visitor will also be able to post comments (exactly as in the previous applications), and also post documents (as attachments to the pages) and link them from the pages. As a convention, we adopt the Markmin syntax for our wiki syntax. We will also implement a search page with Ajax, an RSS feed for the pages, and a handler to search the pages via XML-RPC``xmlrpc``:cite .</div><div class="delete">-</div><div class="delete"><span class="highlight"></span>The <span class="highlight"></span>f<span class="highlight">ollowing diagram lists the actions that we need to implement and the lin</span>k<span class="highlight">s we intend to b</span>u<span class="highlight">ild among them</span>.<span class="highlight"></span></div><div class=""> </div><div class="delete">[[yUML diagram @///image/en3400.png center 2<span class="highlight">5</span>0px]]</div><div class=""> </div><div class=""> Start by creating a new scaffolding app, naming it &quot;mywiki&quot;.</div><div class=""> </div><div class=""> The model must contain three tables: page, comment, and document. Both comment and document reference page because they belong to page. A document contains a file field of type upload as in the previous images application.</div><div class=""> </div><div class=""> Here is the complete model:</div><div class=""> ``</div><div class=""> db = DAL(&#x27;sqlite://storage.sqlite&#x27;)</div><div class=""> </div><div class=""> from gluon.tools import *</div><div class=""> auth = Auth(db)</div><div class=""> auth.define_tables()</div><div class=""> crud = Crud(db)</div><div class=""> </div><div class=""> db.define_table(&#x27;page&#x27;,</div><div class="">     Field(&#x27;title&#x27;),</div><div class="">     Field(&#x27;body&#x27;, &#x27;text&#x27;),</div><div class="">     Field(&#x27;created_on&#x27;, &#x27;datetime&#x27;, default=request.now),</div><div class="">     Field(&#x27;created_by&#x27;, &#x27;reference auth_user&#x27;, default=auth.user_id),</div><div class="">     format=&#x27;%(title)s&#x27;)</div><div class=""> </div><div class=""> db.define_table(&#x27;comment&#x27;,</div><div class="">     Field(&#x27;page_id&#x27;, &#x27;reference page&#x27;),</div><div class="">     Field(&#x27;body&#x27;, &#x27;text&#x27;),</div><div class="">     Field(&#x27;created_on&#x27;, &#x27;datetime&#x27;, default=request.now),</div><div class="">     Field(&#x27;created_by&#x27;, &#x27;reference auth_user&#x27;, default=auth.user_id))</div><div class=""> </div><div class=""> db.define_table(&#x27;document&#x27;,</div><div class="">     Field(&#x27;page_id&#x27;, &#x27;reference page&#x27;),</div><div class="">     Field(&#x27;name&#x27;),</div><div class=""> Python program.</div><div class="">         print item[&#x27;created_on&#x27;], item[&#x27;title&#x27;]</div><div class=""> ``:code</div><div class=""> </div><div class=""> The handler can be accessed from many other programming languages that understand XML-RPC, including C, C++, C# and Java.</div><div class=""> </div><div class=""> #### On ``date``, ``datetime`` and ``time`` format</div><div class=""> </div><div class=""> There are three different representation for each of the field types ``date``, ``datetime`` and ``time``:</div><div class=""> - the database representation</div><div class=""> - the internal web2py prepresentation</div><div class=""> - the string representation in forms and tables</div><div class=""> </div><div class=""> The database representation is an internal issue and does not affect the code. Internally, at the web2py level, they are stored as ``datetime.date``, ``datetime.datetime`` and ``datetime.time`` object respectively and they can be manipulated as such:</div><div class=""> </div><div class=""> ``</div><div class=""> for page in db(db.page).select():</div><div class="">     print page.title, page.day, page.month, page.year</div><div class=""> ``</div><div class=""> </div><div class=""> When dates are converted to strings in forms they are converted using the ISO representation </div><div class=""> ``</div><div class=""> %Y-%m-%d %H:%M:%S</div><div class=""> ``</div><div class=""> </div><div class=""> yet this representation in internationalized and you can use the admin stranslation page to change the format to an alternate one. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> %m/%b/%Y %H:%M:%S</div><div class=""> ``</div><div class=""> </div><div class=""> Mind that by default English is not translated because web2py assumes the applications is already written in English. If you want internationalization to work for English you need to create the translation file (using admin) and you need declare that the application current language is something other than english, for example:</div><div class=""> ``</div><div class=""> T.current_languages = [&#x27;null&#x27;]</div><div class=""> ``</div><div class=""> </div><div class=""> ### The built-in web2py wiki</div><div class=""> </div><div class="delete">Now you can forget the code we have built-in the previous section (not what you have learned about web2py APIs, just the code of the specific example) as we are going to provide and example of the built-in web2py wiki.<span class="highlight"></span></div><div class=""> </div><div class=""> In fact, web2py comes with wiki capabilities including media attachments, tags, tag cloud, page permissions, and support for oembed ``oembed``:cite and components (chapter 14). This wiki can be used with any web2py application.</div><div class=""> </div><div class=""> Here we assume we are starting from cratch from a simple clone of the &quot;welcome&quot; application called &quot;wikidemo&quot;. Edit the controller and replace the &quot;index&quot; action with</div><div class=""> </div><div class=""> ``</div><div class=""> def index(): return auth.wiki()</div><div class=""> ``:code</div><div class=""> </div><div class=""> Done! You have a fully working wiki. At this point no page has been created and in order to create pages you must be logged-in and you must be member of a group called &quot;wiki-editor&quot; or &quot;wiki-author&quot;. If you are logged as administrator the &quot;wiki-editor&quot; group is created automatically and you are made a member. The difference between editors and authors is that the editors can create pages, edit and delete any page, while the authors can create pages (with some optional restrictions) and can only edit/delete the pages they have created.</div><div class=""> </div><div class=""> The ``auth.wiki()`` function returns in a dictionary with a key ``content`` which is undesrtood by the scaffolding &quot;views/default/index.html&quot;. You man make your own view for the this action:</div><div class=""> </div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> {{=content}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> and add extra HTML or code as needed. There is no need to call the action &quot;index&quot;.</div><div class=""> </div><div class=""> To try the wiki, simply login into admin, visit the page</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index</div><div class=""> ``</div><div class=""> </div><div class=""> Then choose a slug (in the publishing business, a slug is a short name given to an article that is in production) and you will be redirected to an empty page where you can edit the content using MARKMIN wiki syntax. A new menu item called &quot;[wiki]&quot; will allow you create, search, and edit pages. Wiki pages have RULS like:</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/[slug]</div><div class=""> ``</div><div class=""> </div><div class=""> Service pages have names which start by underscore:</div><div class=""> and the following action:</div><div class=""> @auth.requires_login()</div><div class=""> def manage_things():</div><div class="">     return SQLFORM.grid(db.thing)</div><div class=""> ``:code</div><div class=""> </div><div class=""> This action is special because it returns a widget/helper not a dict of objects. Now we can embed this ``manage_things`` action into any view, with</div><div class=""> </div><div class=""> ``</div><div class=""> {{=LOAD(&#x27;default&#x27;,&#x27;manage_things&#x27;,ajax=True)}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> This allows the visitor interact with the component via Ajax without reloadin the host page that embeds the widget. Basically the action is called via Ajax, inherits the stile of the host page, and capture all forms submissions and flash messages so that thye are handled within the current page. On top of this the ``SQLFORM.grid`` widget uses digitally signed URLs to restrict access. More informaiton about components can be found in chapter 13.</div><div class=""> </div><div class=""> Components like the one above can be embedded into wiki pages using the MARKMIN syntax:</div><div class=""> </div><div class=""> ``</div><div class=""> @{component:default/manage_things}</div><div class=""> ``</div><div class=""> </div><div class=""> This simply tells web2py that we want to incude the &quot;manage_things&quot; action defined in the &quot;default&quot; controller as an Ajax &quot;component&quot;.</div><div class=""> </div><div class=""> ---------</div><div class=""> Most users will be able to build relatively complex applications simply by using ``auth.wiki`` to create pages and menus, and embedded custom components into wiki pages. Wiki can be tough as a mechanism to allow members of the group to create pages but they calso be though as a way to develop applications in a modular way.</div><div class=""> ---------</div><div class=""> </div><div class=""> ### More on **admin**</div><div class=""> ``admin``:inxx</div><div class=""> </div><div class=""> The administrative interface provides additional functionality that we briefly review here.</div><div class=""> </div><div class="delete">#### <span class="highlight">&#x27;&#x27;s</span>ite<span class="highlight">&#x27;&#x27;</span></div><div class=""> ``site``:inxx</div><div class=""> </div><div class=""> This page lists all installed applications. There are two forms at the bottom.</div><div class=""> </div><div class=""> The first of them allows creating a new application by specifying its name.</div><div class=""> </div><div class=""> ``Instant Press``:inxx ``Movuca``:inxx</div><div class=""> The second form allows uploading an existing application from either a local file or a remote URL. When you upload an application, you need to specify a name for it. This can be its original name, but does not need to be. This allows installing multiple copies of the same application. You can try, for example, to upload the Movuca Social Networking application app created by Bruno Rocha:</div><div class=""> </div><div class=""> ``</div><div class=""> http://code.google.com/p/instant-press/</div><div class=""> ``</div><div class=""> </div><div class=""> or Instant Press CMS created by Martin Mulone:</div><div class=""> </div><div class=""> ``</div><div class=""> http://code.google.com/p/instant-press/</div><div class=""> ``</div><div class=""> </div><div class=""> or one of the many example applications available at:</div><div class=""> </div><div class=""> ``</div><div class=""> http://web2py.com/appliances</div><div class=""> ``</div><div class=""> </div><div class=""> ------</div><div class=""> Web2py files are packages as ``.w2p`` files. These ones are tar gzipped files. Web2py uses the ``.w2p`` extension instead of the ``.tgz`` extension to prevent the browser from unzipping on download. They can be uncompressed manually with ``tar zxvf [filename]`` although this is never necessary.</div><div class=""> ------</div><div class=""> </div><div class=""> [[image @///image/en4100.png center 444px]]</div><div class=""> </div><div class=""> Upon successful upload, web2py displays the MD5 checksum of the uploaded file. You can use it to verify that the file was not corrupted during upload. The InstantPress name will appear in the list of installed applications.</div><div class=""> </div><div class=""> Click on the application name on admin to get it up and running.</div><div class=""> </div><div class=""> If you run web2py from source and you have ``pyhton-git`` installed, you can install applications directly from git reporsitory using the ``.git`` URL in the upload form. In this case you will also be used to user the admin interface to push changes back into the repository.</div><div class=""> </div><div class=""> For each application the &#x27;&#x27;site&#x27;&#x27; page allows you to:</div><div class=""> - Uninstall the application.</div><div class=""> - Jump to the &#x27;&#x27;about&#x27;&#x27; page (read below).</div><div class=""> - Jump to the &#x27;&#x27;edit&#x27;&#x27; page (read below).</div><div class=""> - Jump to the &#x27;&#x27;errors&#x27;&#x27; page (read below).</div><div class=""> - Clean up temporary files (sessions, errors, and cache.disk files).</div><div class=""> - Pack all. This returns a tar file containing a complete copy of the application. We suggest that you clean up temporary files before packing an application.</div><div class=""> - Compile the application. If there are no errors, this option will bytecode-compile all models, controllers and views. Because views can extend and include other views in a tree, before bytecode compilation, the view tree for every controller is collapsed into a single file. The net effect is that a bytecode-compiled application is faster, because there is no more parsing of templates or string substitutions occurring at runtime.</div><div class=""> - Pack compiled. This option is only present for bytecode-compiled applications. It allows packing the application without source code for distribution as closed source. Note that Python (as any other programming language) can technically be decompiled; therefore compilation does not provide complete protection of the source code. Nevertheless, decompilation can be difficult and can be illegal.</div><div class=""> - Remove compiled. It simply removes the byte-code compiled models, views and controllers from the application. If the application was packaged with source code or edited locally, there is no harm in removing the bytecode-compiled files, and the application will continue to work. If the application was installed form a packed compiled file, then this is not safe, because there is no source code to revert to, and the application will no longer work.</div><div class=""> </div><div class=""> ``admin.py``:inxx</div><div class=""> </div><div class=""> -------</div><div class=""> All the functionality available from the web2py admin site page is also accessible programmatically via the API defined in the module ``gluon/admin.py``. Simply open a python shell and import this module.</div><div class=""> -------</div><div class=""> </div><div class=""> If the Google App Engine SDK is installer the admin &#x27;&#x27;site&#x27;&#x27; page shows a button to push your applications to GAE. If ``python-git`` is installed, there is also a button to push your application to Open Shift. To install applications on ``heroku`` or other hosting system you should look into the &quot;scripts&quot; folder for the appropriate script.</div><div class=""> </div><div class="delete">#### <span class="highlight">&#x27;&#x27;a</span>bout<span class="highlight">&#x27;&#x27;</span></div><div class=""> ``about``:inxx ``license``:inxx</div><div class=""> </div><div class=""> The &#x27;&#x27;about&#x27;&#x27; tab allows editing the description of the application and its license. These are written respectively in the ABOUT and LICENSE files in the application folder.</div><div class=""> </div><div class=""> [[image @///image/en4300.png center 480px]]</div><div class=""> </div><div class=""> You can use ``MARKMIN``, or ``gluon.contrib.markdown.WIKI`` syntax for these files as described in ref.``markdown2``:cite .</div><div class=""> </div><div class="delete">#### <span class="highlight">&#x27;&#x27;</span>e<span class="highlight">d</span>i<span class="highlight">t&#x27;&#x27;</span></div><div class=""> ``EDIT``:inxx</div><div class=""> You have used the &#x27;&#x27;edit&#x27;&#x27; page already in this chapter. Here we want to point out a few more functionalities of the &#x27;&#x27;edit&#x27;&#x27; page.</div><div class=""> - If you click on any file name, you can see the contents of the file with syntax highlighting.</div><div class=""> - If you click on edit, you can edit the file via a web interface.</div><div class=""> - If you click on delete, you can delete the file (permanently).</div><div class=""> - If you click on test, web2py will run tests. Tests are written by the developer using Python doctests, and each function should have its own tests.</div><div class=""> - You can add language files, scan the app to discover all strings, and edit string translations via the web interface.</div><div class=""> - If the static files are organized in folders and subfolders, the folder hierarchy can be toggled by clicking on a folder name.</div><div class=""> </div><div class=""> The image below shows the output of the test page for the welcome application.</div><div class=""> </div><div class=""> [[image @///image/en4400.png center 480px]]</div><div class=""> </div><div class=""> The image below show the languages tab for the welcome application.</div><div class=""> </div><div class=""> [[image @///image/en4500.png center 480px]]</div><div class=""> </div><div class=""> The image below shows how to edit a language file, in this case the &quot;it&quot; (Italian) language for the welcome application.</div><div class=""> </div><div class=""> [[image @///image/en4600.png center 480px]]</div><div class=""> </div><div class="delete">-##### &#x27;&#x27;shell&#x27;&#x27;</div><div class=""> </div><div class=""> If you click on the &quot;shell&quot; link under the controllers tab in &#x27;&#x27;edit&#x27;&#x27;, web2py will open a web based Python shell and will execute the models for the current application. This allows you to interactively talk to your application.</div><div class=""> </div><div class=""> [[image @///image/en4700.png center 480px]]</div><div class=""> </div><div class="delete">##### <span class="highlight">&#x27;&#x27;c</span>rontab<span class="highlight">&#x27;&#x27;</span></div><div class=""> </div><div class=""> Also under the controllers tab in &#x27;&#x27;edit&#x27;&#x27; there is a &quot;crontab&quot; link. By clicking on this link you will be able to edit the web2py crontab file. This follows the same syntax as the unix crontab but does not rely on unix. In fact, it only requires web2py, and it works on Windows. It allows you to register actions that need to be executed in background at scheduled times.</div><div class=""> For more information about this, see the next chapter.</div><div class=""> </div><div class="delete">#### <span class="highlight">&#x27;&#x27;e</span>rrors<span class="highlight">&#x27;&#x27;</span></div><div class=""> ``errors``:inxx</div><div class=""> When programming web2py, you will inevitably make mistakes and introduce bugs. web2py helps in two ways: 1) it allows you to create tests for every function that can be run in the browser from the &#x27;&#x27;edit&#x27;&#x27; page; and 2) when an error manifests itself, a ticket is issued to the visitor and the error is logged.</div><div class=""> </div><div class=""> Intentionally introduce an error in the images application as shown below:</div><div class=""> ``</div><div class=""> def index():</div><div class="">     images = db().select(db.image.ALL,orderby=db.image.title)</div><div class="">     1/0</div><div class="">     return dict(images=images)</div><div class=""> ``:code</div><div class=""> </div><div class=""> When you access the index action, you get the following ticket:</div><div class=""> </div><div class=""> [[image @///image/en4800.png center 480px]]</div><div class=""> </div><div class=""> Only the administrator can access the ticket:</div><div class=""> </div><div class=""> [[image @///image/en4900.png center 480px]]</div><div class=""> </div><div class=""> The ticket shows the traceback, and the content of the file that caused the problem, and the complete state of system (variables, request, session, etc.) If the error occurs in a view, web2py shows the view converted from HTML into Python code. This allows to easily identify the logical structure of the file.</div><div class=""> </div><div class=""> By default tickets are stored on filesystem and group by traceback. The administrative interface provides an aggregate views (type of traceback and number of occurrence) and a detailed view (all tickets are listed by ticket id). The administrator can switch between the two views.</div><div class=""> </div><div class=""> Notice that everywhere **admin** shows syntax-highlighted code (for example, in error reports, web2py keywords are shown in orange). If you click on a web2py keyword, you are redirected to a documentation page about the keyword.</div><div class=""> </div><div class=""> If you fix the divide-by-zero bug in the index action and introduce one in the index view:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> </div><div class=""> &lt;h1&gt;Current Images&lt;/h1&gt;</div><div class=""> &lt;ul&gt;</div><div class=""> {{for image in images:}}</div><div class=""> {{1/0}}</div><div class=""> {{=LI(A(image.title, _href=URL(&quot;show&quot;, args=image.id)))}}</div><div class=""> {{pass}}</div><div class=""> &lt;/ul&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> you get the following ticket:</div><div class=""> </div><div class=""> [[image @///image/en5000.png center 480px]]</div><div class=""> </div><div class=""> Note that web2py has converted the view from HTML into a Python file, and the error described in the ticket refers to the generated Python code and NOT to the original view file:</div><div class=""> </div><div class=""> [[image @///image/en5100.png center 480px]]</div><div class=""> </div><div class=""> This may seem confusing at first, but in practice it makes debugging easier, because the Python indentation highlights the logical structure of the code that you embedded in the views.</div><div class=""> </div><div class=""> The code is shown at the bottom of the same page.</div><div class=""> </div><div class=""> All tickets are listed under admin in the &#x27;&#x27;errors&#x27;&#x27; page for each application:</div><div class=""> </div><div class=""> [[image @///image/en5200.png center 480px]]</div><div class=""> </div><div class="delete">#### <span class="highlight">&#x27;&#x27;</span>Mercurial<span class="highlight">&#x27;&#x27;</span></div><div class=""> ``Mercurial``:inxx</div><div class=""> </div><div class=""> If you are running from source and you have the Mercurial version control libraries installed:</div><div class=""> ``</div><div class=""> easy_install mercurial</div><div class=""> ``:code</div><div class=""> </div><div class=""> then the administrative interface shows one more menu item called &quot;Versioning&quot;. It automatically creates a local Mercurial repository for the application. Pressing the &quot;commit&quot; button in the page will commit the current application. Mercurial creates and stores information about changes you make in your code into a hidden folder &quot;.hg&quot; in your app subfolder. Every app has its own &quot;.hg&quot; folder and its own &quot;.hgignore&quot; file (tells Mercurial which files to ignore).</div><div class=""> </div><div class=""> The Mercurial web interface does allow you to browse previous commit and diff files but we do recommend you use Mercurial directly from the shell or one of the many GUI-based Mercurial clients since they are more powerful. For example they will allow you sync your app with a remote source repository:</div><div class=""> </div><div class=""> [[images @///image/en5300.png center 480px]]</div><div class=""> </div><div class=""> </div><div class=""> You can read more about Mercurial here:</div><div class=""> ``</div><div class=""> http://mercurial.selenic.com/</div><div class=""> ``</div><div class=""> </div><div class="delete">#### A<span class="highlight">dm</span>i<span class="highlight"></span>n <span class="highlight">w</span>izard (experimental)</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/e059d270da4678676e9c42dc3c0c2d130342c905">e059d27</a><ul><li>Date : 2012-11-13</li><li>typos</li></ul></li></ul>
<div class="row-fluid" id="com_e059d270da4678676e9c42dc3c0c2d130342c905">
    <div class="span6"><div class="diff"><div class="insert">Here is yet another better wa<span class="highlight">y</span> to create the same form:</div><div class=""> </div><div class=""> ``</div><div class=""> def first():</div><div class="">     form = SQLFORM.factory(Field(&#x27;visitor_name&#x27;, requires=IS_NOT_EMPTY()))</div><div class="">     if form.process().accepted:</div><div class="">         session.visitor_name = form.vars.visitor_name</div><div class="">         redirect(URL(&#x27;second&#x27;))</div><div class="">     return dict(form=form)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The ``form`` object can be easily serialized in HTML by embedding it in the &quot;default/first.html&quot; view.</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> What is your name?</div><div class=""> {{=form}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> The ``form.process()`` method applies the validators and returns the form itself. The ``form.accepted`` variable is set to True if the form was processed and passed validation. If the self-submitted form passes validation, it stores the variables in the session and redirects as before. If the form does not pass validation, error messages are inserted into the form and shown to the user, as below:</div><div class=""> </div><div class=""> [[image @///image/en1800.png center 480px]]</div><div class=""> </div><div class=""> In the next section we will show how forms can be generated automatically from a model.</div><div class=""> </div><div class=""> ### An image blog</div><div class=""> ``upload``:inxx</div><div class=""> </div><div class=""> Here, as another example, we wish to create a web application that allows the administrator to post images and give them a name, and allows the visitors of the web site to view the named images and submit comments.</div><div class=""> </div><div class=""> As before, from the **site** page in **admin**, create a new application called ``images``, and navigate to the &#x27;&#x27;edit&#x27;&#x27; page:</div><div class=""> </div><div class=""> If you fix the divide-by-zero bug in the index action and introduce one in the i</div><div class=""> {{1/0}}</div><div class=""> {{=LI(A(image.title, _href=URL(&quot;show&quot;, args=image.id)))}}</div><div class=""> {{pass}}</div><div class=""> &lt;/ul&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> you get the following ticket:</div><div class=""> </div><div class=""> [[image @///image/en5000.png center 480px]]</div><div class=""> </div><div class=""> Note that web2py has converted the view from HTML into a Python file, and the error described in the ticket refers to the generated Python code and NOT to the original view file:</div><div class=""> </div><div class=""> [[image @///image/en5100.png center 480px]]</div><div class=""> </div><div class=""> This may seem confusing at first, but in practice it makes debugging easier, because the Python indentation highlights the logical structure of the code that you embedded in the views.</div><div class=""> </div><div class=""> The code is shown at the bottom of the same page.</div><div class=""> </div><div class=""> All tickets are listed under admin in the &#x27;&#x27;errors&#x27;&#x27; page for each application:</div><div class=""> </div><div class=""> [[image @///image/en5200.png center 480px]]</div><div class=""> </div><div class=""> #### &#x27;&#x27;Mercurial&#x27;&#x27;</div><div class=""> ``Mercurial``:inxx</div><div class=""> </div><div class=""> If you are running from source and you have the Mercurial version control libraries installed:</div><div class=""> ``</div><div class=""> easy_install mercurial</div><div class=""> ``:code</div><div class=""> </div><div class="insert">then the administrative interface shows one more menu item called &quot;<span class="highlight">Versioning</span>&quot;. It automatically creates a local Mercurial repository for the application. Pressing the &quot;commit&quot; button in the page will commit the current application. Mercurial creates and stores information about changes you make in your code into a hidden folder &quot;.hg&quot; in your app subfolder. Every app has its own &quot;.hg&quot; folder and its own &quot;.hgignore&quot; file (tells Mercurial which files to ignore).</div><div class=""> </div><div class="insert">The Mercurial web interface does allow you to browse previous commit and diff files but we do recommend you use Mercurial directly from the shell or one of the ma<span class="highlight">n</span>y GUI-based Mercurial clients since they are more powerful. For example they will allow you sync your app with a remote source repository:</div><div class=""> </div><div class=""> [[images @///image/en5300.png center 480px]]</div><div class=""> </div><div class=""> </div><div class=""> You can read more about Mercurial here:</div><div class=""> ``</div><div class=""> http://mercurial.selenic.com/</div><div class=""> ``</div><div class=""> </div><div class=""> #### Admin wizard (experimental)</div><div class=""> </div><div class=""> The **admin** interface includes a Wizard that can help you create a new applications.</div><div class=""> You can access the wizard from the &quot;sites&quot; page as shown in the image below.</div><div class=""> </div><div class=""> [[image @///image/en5400.png center 480px]]</div><div class=""> </div><div class=""> The wizard will guide you through a series of steps involved in creating a new application:</div><div class=""> </div><div class=""> - Chose a name for the application</div><div class=""> - Configure the application and choose required plugins</div><div class=""> - Build required models (it will create CRUD pages for each model)</div><div class=""> - Allow you to edit the views of those pages using MARKMIN syntax</div><div class=""> </div><div class=""> The image below shows the second step of the process.</div><div class=""> </div><div class=""> [[image @///image/en5500.png center 480px]]</div><div class=""> </div><div class=""> You can see a dropdown to select a layout plugin (from ``web2py.com/layouts``), a multiple choice dropdown to check other plugins (from ``web2py.com/plugins``) and a &quot;login config&quot; field where to put the Janrain &quot;domain:key&quot;.</div><div class=""> </div><div class=""> The other steps are pretty much self-explanatory.</div><div class=""> </div><div class=""> The Wizard works well for what it does but it is considered an &#x27;&#x27;experimental feature&#x27;&#x27; for two reasons:</div><div class=""> </div><div class=""> - Applications created with the wizard and edited manually, cannot later be modified by the wizard.</div><div class=""> - The interface of the wizard will change over time to include support for more features and easier visual development.</div><div class=""> </div><div class=""> In any case the wizard is a handy tool for fast prototyping and it can be used to bootstrap a new application with an alternate layout and optional plugins.</div><div class=""> </div><div class=""> #### Configuring **admin**</div><div class=""> </div><div class=""> Normally there is no need to perform any configuration of admin but a few customizations are possible. After you login into admin you can edit the admin configuration file via the URL:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/admin/default/edit/admin/models/0.py</div><div class=""> ``</div><div class=""> Notice that **admin** can be used to edit itself. In fact **admin** is an app as any other one.</div><div class=""> </div><div class="insert">The file &quot;0.py&quot; is very much self documented and if you are opening probably you already know what you are looking for. Anyway <span class="highlight"></span>few customizations<span class="highlight"> exist</span> that are more important than others:</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">Here is yet another better wa<span class="highlight">t</span> to create the same form:</div><div class=""> </div><div class=""> ``</div><div class=""> def first():</div><div class="">     form = SQLFORM.factory(Field(&#x27;visitor_name&#x27;, requires=IS_NOT_EMPTY()))</div><div class="">     if form.process().accepted:</div><div class="">         session.visitor_name = form.vars.visitor_name</div><div class="">         redirect(URL(&#x27;second&#x27;))</div><div class="">     return dict(form=form)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The ``form`` object can be easily serialized in HTML by embedding it in the &quot;default/first.html&quot; view.</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> What is your name?</div><div class=""> {{=form}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> The ``form.process()`` method applies the validators and returns the form itself. The ``form.accepted`` variable is set to True if the form was processed and passed validation. If the self-submitted form passes validation, it stores the variables in the session and redirects as before. If the form does not pass validation, error messages are inserted into the form and shown to the user, as below:</div><div class=""> </div><div class=""> [[image @///image/en1800.png center 480px]]</div><div class=""> </div><div class=""> In the next section we will show how forms can be generated automatically from a model.</div><div class=""> </div><div class=""> ### An image blog</div><div class=""> ``upload``:inxx</div><div class=""> </div><div class=""> Here, as another example, we wish to create a web application that allows the administrator to post images and give them a name, and allows the visitors of the web site to view the named images and submit comments.</div><div class=""> </div><div class=""> As before, from the **site** page in **admin**, create a new application called ``images``, and navigate to the &#x27;&#x27;edit&#x27;&#x27; page:</div><div class=""> </div><div class=""> If you fix the divide-by-zero bug in the index action and introduce one in the i</div><div class=""> {{1/0}}</div><div class=""> {{=LI(A(image.title, _href=URL(&quot;show&quot;, args=image.id)))}}</div><div class=""> {{pass}}</div><div class=""> &lt;/ul&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> you get the following ticket:</div><div class=""> </div><div class=""> [[image @///image/en5000.png center 480px]]</div><div class=""> </div><div class=""> Note that web2py has converted the view from HTML into a Python file, and the error described in the ticket refers to the generated Python code and NOT to the original view file:</div><div class=""> </div><div class=""> [[image @///image/en5100.png center 480px]]</div><div class=""> </div><div class=""> This may seem confusing at first, but in practice it makes debugging easier, because the Python indentation highlights the logical structure of the code that you embedded in the views.</div><div class=""> </div><div class=""> The code is shown at the bottom of the same page.</div><div class=""> </div><div class=""> All tickets are listed under admin in the &#x27;&#x27;errors&#x27;&#x27; page for each application:</div><div class=""> </div><div class=""> [[image @///image/en5200.png center 480px]]</div><div class=""> </div><div class=""> #### &#x27;&#x27;Mercurial&#x27;&#x27;</div><div class=""> ``Mercurial``:inxx</div><div class=""> </div><div class=""> If you are running from source and you have the Mercurial version control libraries installed:</div><div class=""> ``</div><div class=""> easy_install mercurial</div><div class=""> ``:code</div><div class=""> </div><div class="delete">then the administrative interface shows one more menu item called &quot;<span class="highlight">mercurial</span>&quot;. It automatically creates a local Mercurial repository for the application. Pressing the &quot;commit&quot; button in the page will commit the current application. Mercurial creates and stores information about changes you make in your code into a hidden folder &quot;.hg&quot; in your app subfolder. Every app has its own &quot;.hg&quot; folder and its own &quot;.hgignore&quot; file (tells Mercurial which files to ignore).</div><div class=""> </div><div class="delete">The Mercurial web interface does allow you to browse previous commit and diff files but we do recommend you use Mercurial directly from the shell or one of the ma<span class="highlight"></span>y GUI-based Mercurial clients since they are more powerful. For example they will allow you sync your app with a remote source repository:</div><div class=""> </div><div class=""> [[images @///image/en5300.png center 480px]]</div><div class=""> </div><div class=""> </div><div class=""> You can read more about Mercurial here:</div><div class=""> ``</div><div class=""> http://mercurial.selenic.com/</div><div class=""> ``</div><div class=""> </div><div class=""> #### Admin wizard (experimental)</div><div class=""> </div><div class=""> The **admin** interface includes a Wizard that can help you create a new applications.</div><div class=""> You can access the wizard from the &quot;sites&quot; page as shown in the image below.</div><div class=""> </div><div class=""> [[image @///image/en5400.png center 480px]]</div><div class=""> </div><div class=""> The wizard will guide you through a series of steps involved in creating a new application:</div><div class=""> </div><div class=""> - Chose a name for the application</div><div class=""> - Configure the application and choose required plugins</div><div class=""> - Build required models (it will create CRUD pages for each model)</div><div class=""> - Allow you to edit the views of those pages using MARKMIN syntax</div><div class=""> </div><div class=""> The image below shows the second step of the process.</div><div class=""> </div><div class=""> [[image @///image/en5500.png center 480px]]</div><div class=""> </div><div class=""> You can see a dropdown to select a layout plugin (from ``web2py.com/layouts``), a multiple choice dropdown to check other plugins (from ``web2py.com/plugins``) and a &quot;login config&quot; field where to put the Janrain &quot;domain:key&quot;.</div><div class=""> </div><div class=""> The other steps are pretty much self-explanatory.</div><div class=""> </div><div class=""> The Wizard works well for what it does but it is considered an &#x27;&#x27;experimental feature&#x27;&#x27; for two reasons:</div><div class=""> </div><div class=""> - Applications created with the wizard and edited manually, cannot later be modified by the wizard.</div><div class=""> - The interface of the wizard will change over time to include support for more features and easier visual development.</div><div class=""> </div><div class=""> In any case the wizard is a handy tool for fast prototyping and it can be used to bootstrap a new application with an alternate layout and optional plugins.</div><div class=""> </div><div class=""> #### Configuring **admin**</div><div class=""> </div><div class=""> Normally there is no need to perform any configuration of admin but a few customizations are possible. After you login into admin you can edit the admin configuration file via the URL:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/admin/default/edit/admin/models/0.py</div><div class=""> ``</div><div class=""> Notice that **admin** can be used to edit itself. In fact **admin** is an app as any other one.</div><div class=""> </div><div class="delete">The file &quot;0.py&quot; is very much self documented and if you are opening probably you already know what you are looking for. Anyway <span class="highlight">there a </span>few customizations<span class="highlight"></span> that are more important than others:</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/f2fd41dd2a0d4bf68f5cd4f0989fb32bdc35eac5">f2fd41d</a><ul><li>Date : 2012-12-31</li><li>spell check of diffs, thanks Joanthan</li></ul></li></ul>
<div class="row-fluid" id="com_f2fd41dd2a0d4bf68f5cd4f0989fb32bdc35eac5">
    <div class="span6"><div class="diff"><div class=""> ``</div><div class=""> def first():</div><div class="">     form = SQLFORM.factory(Field(&#x27;visitor_name&#x27;,</div><div class="insert">                                 label=&#x27;what is you<span class="highlight">r</span> name?&#x27;,</div><div class="">                                  requires=IS_NOT_EMPTY()))</div><div class="">     if form.process().accepted:</div><div class="">         session.visitor_name = form.vars.visitor_name</div><div class="">         redirect(URL(&#x27;second&#x27;))</div><div class="">     return dict(form=form)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The ``form`` object can be easily serialized in HTML by embedding it in the &quot;default/first.html&quot; view.</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> {{=form}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> The ``form.process()`` method applies the validators and returns the form itself. The ``form.accepted`` variable is set to True if the form was processed and passed validation. If the self-submitted form passes validation, it stores the variables in the session and redirects as before. If the form does not pass validation, error messages are inserted into the form and shown to the user, as below:</div><div class=""> </div><div class=""> [[image @///image/en1800.png center 480px]]</div><div class=""> </div><div class=""> In the next section we will show how forms can be generated automatically from a model.</div><div class=""> </div><div class=""> In all or examples we have used the session to pass the user name from the first action to the second. We could have used a different mechanism and pass data as part of a redirect URL:</div><div class=""> </div><div class=""> ``</div><div class=""> def first():</div><div class="">     form = SQLFORM.factory(Field(&#x27;visitor_name&#x27;, requires=IS_NOT_EMPTY()))</div><div class="">     if form.process().accepted:</div><div class="">         name = form.vars.visitor_name</div><div class="">         redirect(URL(&#x27;second&#x27;,vars=dict(name=name)))</div><div class="">     return dict(form=form)</div><div class=""> </div><div class=""> def second():</div><div class="">     name = request.vars.visitor_name or redirect(URL(&#x27;first&#x27;))</div><div class="">     return dict(name=name)</div><div class=""> ``:code</div><div class=""> </div><div class=""> #### Internationalization</div><div class=""> </div><div class="insert">You code is likely to include hardcoded strings such as &quot;What is your name?&quot;. You should be able to customize strings without editing the code and in particular insert translations for these strings in different languages. In this wa<span class="highlight"></span>y if a visitor has the language preference of the browser set to &quot;Italian&quot;, web2py will use the Italian translation for the strings, if available. This feature of web2py is called &quot;internationalization&quot; and it is described in more detail in the next chapter.</div><div class=""> </div><div class="insert">Here we just observe that in order to use this feature you should markup strings that need<span class="highlight">s</span> <span class="highlight"></span>translation. This is done by wrapping a a quoted string in code such as</div><div class=""> </div><div class=""> ``</div><div class=""> &quot;What is your name?&quot;</div><div class=""> ``:code</div><div class=""> </div><div class=""> with the ``T`` operator:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;What is your name?&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> You can also mark fo translations strings hardcoded in views. For example</div><div class=""> </div><div class=""> ``</div><div class=""> &lt;h1&gt;What is your name?&lt;/h1&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> becomes</div><div class=""> </div><div class=""> ``</div><div class=""> &lt;h1&gt;{{=T(&quot;What is your name?&quot;)}}&lt;/h1&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> It is good practice to do this for every string in the code (field labels, flash messages, etc.) except for tables and field names.</div><div class=""> </div><div class="insert">Once the strings are i<span class="highlight"></span>dentified and marked up, web2py takes care of almost ev<span class="highlight">e</span>rything else. The admin interface also provides a page where you can translate each string in the languages you desire to support.</div><div class=""> </div><div class=""> ### An image blog</div><div class=""> ``upload``:inxx</div><div class=""> </div><div class=""> Here, as another example, we wish to create a web application that allows the administrator to post images and give them a name, and allows the visitors of the web site to view the named images and submit comments (posts).</div><div class=""> </div><div class=""> As before, from the **site** page in **admin**, create a new application called ``images``, and navigate to the &#x27;&#x27;edit&#x27;&#x27; page:</div><div class=""> </div><div class=""> [[image @///image/en1900.png center 480px]]</div><div class=""> </div><div class=""> We start by creating a model, a representation of the persistent data in the application (the images to upload, their names, and the comments). First, you need to create/edit a model file which, for lack of imagination, we call &quot;db.py&quot;. We assume the code below will replace any existing code in &quot;db.py&quot;. Models and controllers must have a ``.py`` extension since they are Python code. If the extension is not provided, it is appended by web2py. Views instead have a ``.html`` extension since they mainly contain HTML code.</div><div class=""> </div><div class=""> Edit the &quot;db.py&quot; file by clicking the corresponding &quot;edit&quot; button:</div><div class=""> </div><div class=""> [[image @///image/en2000.png center 480px]]</div><div class=""> </div><div class=""> and enter the following:</div><div class=""> </div><div class=""> ``IS_EMAIL``:inxx ``IS_NOT_EMPTY``:inxx ``IS_IN_DB``:inxx</div><div class=""> ``</div><div class=""> db = DAL(&quot;sqlite://storage.sqlite&quot;)</div><div class=""> </div><div class=""> db.define_table(&#x27;image&#x27;,</div><div class="">    Field(&#x27;title&#x27;, unique=True),</div><div class="">    Field(&#x27;file&#x27;, &#x27;upload&#x27;),</div><div class="">    format = &#x27;%(title)s&#x27;)</div><div class=""> </div><div class=""> db.define_table(&#x27;post&#x27;,</div><div class="">    Field(&#x27;image_id&#x27;, &#x27;reference image&#x27;),</div><div class="">    Field(&#x27;author&#x27;),</div><div class=""> The database representation is an internal issue and does not affect the code. I</div><div class=""> for page in db(db.page).select():</div><div class="">     print page.title, page.day, page.month, page.year</div><div class=""> ``</div><div class=""> </div><div class=""> When dates are converted to strings in forms they are converted using the ISO representation</div><div class=""> ``</div><div class=""> %Y-%m-%d %H:%M:%S</div><div class=""> ``</div><div class=""> </div><div class=""> yet this representation in internationalized and you can use the admin stranslation page to change the format to an alternate one. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> %m/%b/%Y %H:%M:%S</div><div class=""> ``</div><div class=""> </div><div class=""> Mind that by default English is not translated because web2py assumes the applications is already written in English. If you want internationalization to work for English you need to create the translation file (using admin) and you need declare that the application current language is something other than english, for example:</div><div class=""> ``</div><div class=""> T.current_languages = [&#x27;null&#x27;]</div><div class=""> ``</div><div class=""> </div><div class=""> ### The built-in web2py wiki</div><div class=""> </div><div class=""> Now you can forget the code we have built-in the previous section (not what you have learned about web2py APIs, just the code of the specific example) as we are going to provide and example of the built-in web2py wiki.</div><div class=""> </div><div class=""> In fact, web2py comes with wiki capabilities including media attachments, tags, tag cloud, page permissions, and support for oembed ``oembed``:cite and components (chapter 14). This wiki can be used with any web2py application.</div><div class=""> </div><div class=""> ------</div><div class=""> Notice the API of the built-in wiki are still considered experimental and small changes are still possible.</div><div class=""> ------</div><div class=""> </div><div class="insert">Here we assume we are starting from <span class="highlight">s</span>cratch from a simple clone of the &quot;welcome&quot; application called &quot;wikidemo&quot;. Edit the controller and replace the &quot;index&quot; action with</div><div class=""> </div><div class=""> ``</div><div class=""> def index(): return auth.wiki()</div><div class=""> ``:code</div><div class=""> </div><div class=""> Done! You have a fully working wiki. At this point no page has been created and in order to create pages you must be logged-in and you must be member of a group called &quot;wiki-editor&quot; or &quot;wiki-author&quot;. If you are logged as administrator the &quot;wiki-editor&quot; group is created automatically and you are made a member. The difference between editors and authors is that the editors can create pages, edit and delete any page, while the authors can create pages (with some optional restrictions) and can only edit/delete the pages they have created.</div><div class=""> </div><div class=""> The ``auth.wiki()`` function returns in a dictionary with a key ``content`` which is understood by the scaffolding &quot;views/default/index.html&quot;. You man make your own view for this action:</div><div class=""> </div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> {{=content}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> and add extra HTML or code as needed. There is no need to call the action &quot;index&quot;.</div><div class=""> </div><div class=""> To try the wiki, simply login into admin, visit the page</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index</div><div class=""> ``</div><div class=""> </div><div class=""> Then choose a slug (in the publishing business, a slug is a short name given to an article that is in production) and you will be redirected to an empty page where you can edit the content using MARKMIN wiki syntax. A new menu item called &quot;[wiki]&quot; will allow you create, search, and edit pages. Wiki pages have RULS like:</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/[slug]</div><div class=""> ``</div><div class=""> </div><div class=""> Service pages have names which start by underscore:</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_create</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_search</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_could</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_recent</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_edit/...</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_editmedia/...</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_preview/...</div><div class=""> ``</div><div class=""> </div><div class=""> Try create more pages such as &quot;index&quot;, &quot;aboutus&quot;, and &quot;contactus&quot;.</div><div class=""> Try edit them.</div><div class=""> </div><div class=""> </div><div class=""> The ``wiki`` method has the following signature:</div><div class=""> </div><div class=""> ``</div><div class=""> def wiki(self, slug=None, env=None, render=&#x27;markmin&#x27;,</div><div class="">          manage_permissions=False, force_prefix=&#x27;&#x27;,</div><div class="">          restrict_search=False, resolve=True,</div><div class="">          extra=None, menugroups=None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> It takes the following arguments:</div><div class=""> </div><div class="insert">+- ``render`` which defaults to ``&#x27;markmin&#x27;`` but can be set equal to ``&#x27;html&#x27;``. It termines the syntax of the wiki. We will discuss the markmin wiki markup later. If you change it to HTML you may want to use a wysiwyg javascript editor such as TinyMCE of NicEdit.</div><div class="insert">+- ``manage_permissions``. This is set to ``False`` by default and only recognizes permissions for &quot;wiki-editor&quot; and &quot;wiki-author&quot;. If you change it to ``True`` the create/edit page will give the option to specify by names the groups whose members have permission to read and edit the page. In this case is a group &quot;everybody&quot; to give read permission to everybody.</div><div class="insert">+- ``force_prefix``. If set to something like ``&#x27;%(id)s-&#x27;`` it will restrict authors (not editors) to create page with a prefix like &quot;[user id]-[page name]&quot;. The prefix can contain the id (&quot;%(id)s&quot;) or the username (&quot;%(username)s&quot;) or any other field from the auth_user table, as long as the corresponding column contains valid string that would pass URL validation.</div><div class=""> - ``restrict_search``. This default to ``False`` and any logged-in user can search all wiki pages (but not necessary read or edit them). If set to ``True``, authors can search only their own pages, editors can search everything, other users cannot search anything.</div><div class="insert">- ``menugroups``. This defaults to ``None`` and it indic<span class="highlight"></span>ates that wiki management menu (search, create, edit, etc.) is always displayed. You can set it to a list of group names whose members only can see this menu, for ex<span class="highlight">am</span>ple ``[&#x27;wiki-editor&#x27;,&#x27;wiki-author&#x27;]``. Notice that even if the menu is exposed to everybody does not mean everybody is allowed to perform actions listed in the menu since they are regulated by the access control system.</div><div class=""> </div><div class=""> The ``wiki`` method has some additional parameters which will be explained later: ``slug``, ``env``, and ``extra``.</div><div class=""> </div><div class=""> </div><div class=""> </div><div class=""> #### MARKMIN basics</div><div class=""> </div><div class=""> The MARKMIN syntax allows you to markup **bold** text using ``**bold**``, &#x27;&#x27;italic&#x27;&#x27; text with ``&#x27;&#x27;italic&#x27;&#x27;``, ``code`` text with ``\`\`code\`\```. Titles must be prefixed by a #, sections by ##, and sub-sections by ###. Use a minus(-) to prefix an un-ordered item and plus(+) to prefix an ordered item. URLs are automatically into links. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> # This is title</div><div class=""> ## this is a section title</div><div class=""> ### this is a subsection title</div><div class=""> </div><div class=""> Text can be **bold**, &#x27;&#x27;italic&#x27;&#x27;, !`!!`!code!`!!`! etc.</div><div class=""> Learn more at:</div><div class=""> </div><div class=""> http://web2py.com</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> You can use the ``extra`` parameter of ``auth.wiki`` to pass extra rendering rules to the MARKMIN helper.</div><div class=""> </div><div class=""> You can find more information about the MARKMIN syntax in chapter 5.</div><div class=""> </div><div class="insert">``auth.wiki`` is more powerful than the barebone<span class="highlight">s</span> MARKMIN helpers<span class="highlight">,</span> support<span class="highlight">ing</span> oembed and components.</div><div class=""> </div><div class=""> You can use theS ``env`` parameter of ``auth.wiki`` to expose functions to your wiki.</div><div class=""> For example:</div><div class=""> </div><div class=""> ``</div><div class=""> auth.wiki(env=dict(join=lambda a,b,c:&quot;%s-%s-%s&quot; % (a,b,c)))</div><div class=""> ``</div><div class=""> </div><div class=""> allows you to use the markup syntax:</div><div class=""> </div><div class=""> ``</div><div class=""> @(join:1,2,3)</div><div class=""> ``</div><div class=""> </div><div class=""> </div><div class="insert">This call the join function passed as extra with parameters ``a,b,c=1,2,3`` and will be re<span class="highlight">n</span>dered as ``1-2-3``.</div><div class=""> </div><div class=""> #### Oembed protocol</div><div class=""> </div><div class=""> You can type in (or cut-and-paste) any URL into a wiki page it normally is rendered as a link to the URL. There are exceptions:</div><div class=""> </div><div class=""> - If the URL has an image extension, the link is embedded as an image, ``&lt;img/&gt;``.</div><div class=""> - If the URL has an audio extension, the link is embedded as HTML5 audio ``&lt;audio/&gt;``.</div><div class=""> - If the URL has a video extension, the link is embedded as HTML5 video ``&lt;video/&gt;``.</div><div class=""> - If the URL has a MS Office or PDF extension, Google Doc Viewer is embedded, showing the content of the document (only works for public documents).</div><div class="insert">- If the URL points to a Youtube page, a Vi<span class="highlight"></span>m<span class="highlight">e</span>o page, or a Flickr page, web2py contacts the corr<span class="highlight">e</span>sponding web service and queries it about the prop<span class="highlight">e</span>r way to embed the conte<span class="highlight">n</span>t. This is done using the ``oembed`` protocol.</div><div class=""> </div><div class=""> Here is a complete list of supported formats:</div><div class=""> ``</div><div class=""> Image (.PNG, .GIF, .JPG, .JPEG)</div><div class=""> Audio (.WAV, .OGG, .MP3)</div><div class=""> Video (.MOV, .MPE, .MP4, .MPG, .MPG2, .MPEG, .MPEG4, .MOVIE)</div><div class=""> ``</div><div class=""> </div><div class=""> Supported via Google Doc Viewer:</div><div class=""> </div><div class=""> ``</div><div class=""> Microsoft Excel (.XLS and .XLSX)</div><div class=""> Microsoft PowerPoint 2007 / 2010 (.PPTX)</div><div class=""> Apple Pages (.PAGES)</div><div class=""> Adobe PDF (.PDF)</div><div class=""> Adobe Illustrator (.AI)</div><div class=""> Adobe Photoshop (.PSD)</div><div class=""> Autodesk AutoCad (.DXF)</div><div class=""> Scalable Vector Graphics (.SVG)</div><div class=""> PostScript (.EPS, .PS)</div><div class=""> TrueType (.TTF)</div><div class=""> xml Paper Specification (.XPS)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Supported by oembed:</div><div class=""> </div><div class=""> ``</div><div class=""> flickr.com</div><div class=""> youtube.com</div><div class=""> hulu.com</div><div class=""> vimeo.com</div><div class=""> slideshare.net</div><div class=""> qik.com</div><div class=""> polleverywhere.com</div><div class=""> wordpress.com</div><div class=""> revision3.com</div><div class=""> viddler.com</div><div class=""> ``:code</div><div class=""> </div><div class="insert">This is implemen<span class="highlight"></span>ted in the web2py file ``gluon.contrib.autolinks`` and specifically in the function ``expand_one``. You can extend oembed support by registering more services. This is done by appending an entry to the ``EMBED_MAPS`` list:</div><div class=""> </div><div class=""> ``</div><div class="insert">from gluon.contrib.aut<span class="highlight">o</span>links import EMBED_MAPS</div><div class=""> EMBED_MAPS.append((re.compile(&#x27;http://vimeo.com/\S*&#x27;),</div><div class="">                    &#x27;http://vimeo.com/api/oembed.json&#x27;))</div><div class=""> ``:code</div><div class=""> </div><div class=""> #### Referencing wiki content</div><div class=""> </div><div class=""> If you create a wiki page with slug &quot;contactus&quot; you can refer to this page as</div><div class=""> </div><div class=""> ``</div><div class=""> \@////contactus</div><div class=""> ``:code</div><div class=""> </div><div class=""> Here ``\@////`` stands for</div><div class=""> </div><div class=""> ``</div><div class=""> \@/app/controller/function/</div><div class=""> ``:code</div><div class=""> </div><div class=""> but &quot;app&quot;, &quot;controller&quot;, and &quot;function&quot; are omitted thus assuming default.</div><div class=""> </div><div class="insert">Similarly you can use the wiki menu to upload a media file (for example an image) linked to the page. The &quot;manage media&quot; page will show all files you have uploaded and will show the proper expression to link the media file. If, for example you upload a file &quot;test.jpg&quot; with title &quot;beach&quot;, the link expression will som<span class="highlight">e</span>thing like:</div><div class=""> </div><div class=""> ``</div><div class=""> \@////15/beach.jpg</div><div class=""> ``:code</div><div class=""> </div><div class=""> ``\@////`` is the same prefix described before. ``15`` is the id of the record storing the media file. ``beach`` is the title. ``.jpg`` is the extension of the original file.</div><div class=""> </div><div class=""> If you cut and paste ``\@////15/beach.jpg`` into wiki pages you embed the image.</div><div class=""> </div><div class=""> Mind that media files are linked to pages and inherit access permission from the pages.</div><div class=""> </div><div class=""> #### Wiki menus</div><div class=""> </div><div class=""> If you create a page with slug &quot;wiki-menu&quot; page it will be interpreted as a description of the menu. Here is an example:</div><div class=""> </div><div class=""> ``</div><div class=""> - Home &gt; \@////index</div><div class=""> - Info &gt; \@////info</div><div class=""> - web2py &gt; http://google.com</div><div class=""> - - About us &gt; \@////aboutus</div><div class="insert">- - Co<span class="highlight"></span>ntact us &gt; \@////contactus</div><div class=""> ``</div><div class=""> </div><div class="insert">Each line a menu item. We used double dash for nested menu ite<span class="highlight">m</span>s. The ``&gt;`` symbols separates the menu item title from the menu item link.</div><div class=""> </div><div class=""> Mind that the menu is appended to ``response.menu``. It does not replace it. The ``[wiki]`` menu tem with service functions is added automatically.</div><div class=""> </div><div class=""> #### Service functions</div><div class=""> </div><div class=""> If, for example, you want to use the wiki to create an editable sidebar you could create a page with ``slug=&quot;sidebar&quot;`` and then embed it in your layout.html with</div><div class=""> </div><div class=""> ``</div><div class=""> {{=auth.wiki(slug=&#x27;sidebar&#x27;)}}</div><div class=""> ``:code</div><div class=""> </div><div class="insert">Notice that there is nothing special with the word &quot;sidebar&quot;. Any wiki page can be retrieved and em<span class="highlight">be</span>dded in any point in your code. This allows you mix and match wiki functionalities with regular web2py functionalities.</div><div class=""> </div><div class=""> You can also embed special wiki functions as the search by tags:</div><div class=""> </div><div class=""> ``</div><div class=""> {{=auth.wiki(&#x27;_search&#x27;)}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> or the tag cloud:</div><div class=""> </div><div class=""> ``</div><div class=""> {{=auth.wiki(&#x27;_cloud&#x27;)}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> #### Components</div><div class=""> </div><div class=""> One of the most powerful function of the new web2py consists in the ability of embedding an action inside another action. We call this a component.</div><div class=""> </div><div class=""> Consider the following model:</div><div class=""> </div><div class=""> ``</div><div class=""> db.define_table(&#x27;thing&#x27;,Field(&#x27;name&#x27;,requires=IS_NOT_EMPTY()))</div><div class=""> ``:code</div><div class=""> </div><div class=""> and the following action:</div><div class=""> </div><div class=""> ``</div><div class=""> @auth.requires_login()</div><div class=""> def manage_things():</div><div class="">     return SQLFORM.grid(db.thing)</div><div class=""> ``:code</div><div class=""> </div><div class=""> This action is special because it returns a widget/helper not a dict of objects. Now we can embed this ``manage_things`` action into any view, with</div><div class=""> </div><div class=""> ``</div><div class=""> {{=LOAD(&#x27;default&#x27;,&#x27;manage_things&#x27;,ajax=True)}}</div><div class=""> ``:code</div><div class=""> </div><div class="insert">This allows the visitor interact with the component via Ajax without reloadin<span class="highlight">g</span> the host page that embeds the widget. Basically the action is called via Ajax, inherits the stile of the host page, and capture all forms submissions and flash messages so that th<span class="highlight">e</span>y<span class="highlight"></span> are handled within the current page. On top of this the ``SQLFORM.grid`` widget uses digitally signed URLs to restrict access. More informa<span class="highlight">ti</span>on about components can be found in chapter 13.</div><div class=""> </div><div class=""> Components like the one above can be embedded into wiki pages using the MARKMIN syntax:</div><div class=""> </div><div class=""> ``</div><div class=""> @{component:default/manage_things}</div><div class=""> ``</div><div class=""> </div><div class=""> This simply tells web2py that we want to incude the &quot;manage_things&quot; action defined in the &quot;default&quot; controller as an Ajax &quot;component&quot;.</div><div class=""> </div><div class=""> ---------</div><div class="insert">Most users will be able to build relatively complex applications simply by using ``auth.wiki`` to create pages and menus<span class="highlight"> and embedded custom components into wiki pages. Wikis can be thought of as a mechanism to allow members of the group to create pages</span>, <span class="highlight">but they can also be thought of as a way to develop applications in a modular way</span>.<span class="highlight"></span></div><div class=""> ---------</div><div class=""> </div><div class=""> ### More on **admin**</div><div class=""> ``admin``:inxx</div><div class=""> </div><div class=""> The administrative interface provides additional functionality that we briefly review here.</div><div class=""> </div><div class=""> #### Site</div><div class=""> ``site``:inxx</div><div class=""> </div><div class=""> This page lists all installed applications. There are two forms at the bottom.</div><div class=""> </div><div class=""> The first of them allows creating a new application by specifying its name.</div><div class=""> </div><div class=""> ``Instant Press``:inxx ``Movuca``:inxx</div><div class=""> The second form allows uploading an existing application from either a local file or a remote URL. When you upload an application, you need to specify a name for it. This can be its original name, but does not need to be. This allows installing multiple copies of the same application. You can try, for example, to upload the Movuca Social Networking application app created by Bruno Rocha:</div><div class=""> </div><div class=""> ``</div><div class=""> http://code.google.com/p/instant-press/</div><div class=""> ``</div><div class=""> </div><div class=""> or Instant Press CMS created by Martin Mulone:</div><div class=""> </div><div class=""> ``</div><div class=""> http://code.google.com/p/instant-press/</div><div class=""> ``</div><div class=""> </div><div class=""> or one of the many example applications available at:</div><div class=""> </div><div class=""> ``</div><div class=""> http://web2py.com/appliances</div><div class=""> ``</div><div class=""> </div><div class=""> ------</div><div class=""> Web2py files are packages as ``.w2p`` files. These ones are tar gzipped files. Web2py uses the ``.w2p`` extension instead of the ``.tgz`` extension to prevent the browser from unzipping on download. They can be uncompressed manually with ``tar zxvf [filename]`` although this is never necessary.</div><div class=""> ------</div><div class=""> </div><div class=""> [[image @///image/en4100.png center 444px]]</div><div class=""> </div><div class=""> Upon successful upload, web2py displays the MD5 checksum of the uploaded file. You can use it to verify that the file was not corrupted during upload. The InstantPress name will appear in the list of installed applications.</div><div class=""> </div><div class=""> Click on the application name on admin to get it up and running.</div><div class=""> </div><div class="insert">If you run web2py from source and you have ``py<span class="highlight">th</span>on-git`` installed, you can install applications directly from git repo<span class="highlight"></span>sitory using the ``.git`` URL in the upload form. In this case you will also be used to user the admin interface to push changes back into the repository.</div><div class=""> </div><div class=""> For each application the &#x27;&#x27;site&#x27;&#x27; page allows you to:</div><div class=""> - Uninstall the application.</div><div class=""> - Jump to the &#x27;&#x27;about&#x27;&#x27; page (read below).</div><div class=""> - Jump to the &#x27;&#x27;edit&#x27;&#x27; page (read below).</div><div class=""> - Jump to the &#x27;&#x27;errors&#x27;&#x27; page (read below).</div><div class=""> - Clean up temporary files (sessions, errors, and cache.disk files).</div><div class=""> - Pack all. This returns a tar file containing a complete copy of the application. We suggest that you clean up temporary files before packing an application.</div><div class=""> - Compile the application. If there are no errors, this option will bytecode-compile all models, controllers and views. Because views can extend and include other views in a tree, before bytecode compilation, the view tree for every controller is collapsed into a single file. The net effect is that a bytecode-compiled application is faster, because there is no more parsing of templates or string substitutions occurring at runtime.</div><div class=""> - Pack compiled. This option is only present for bytecode-compiled applications. It allows packing the application without source code for distribution as closed source. Note that Python (as any other programming language) can technically be decompiled; therefore compilation does not provide complete protection of the source code. Nevertheless, decompilation can be difficult and can be illegal.</div><div class=""> - Remove compiled. It simply removes the byte-code compiled models, views and controllers from the application. If the application was packaged with source code or edited locally, there is no harm in removing the bytecode-compiled files, and the application will continue to work. If the application was installed form a packed compiled file, then this is not safe, because there is no source code to revert to, and the application will no longer work.</div><div class=""> </div><div class=""> ``admin.py``:inxx</div><div class=""> </div><div class=""> -------</div><div class=""> All the functionality available from the web2py admin site page is also accessible programmatically via the API defined in the module ``gluon/admin.py``. Simply open a python shell and import this module.</div><div class=""> -------</div><div class=""> </div><div class="insert">If the Google App Engine SDK is installer the admin &#x27;&#x27;site&#x27;&#x27; page shows a button to push your applications to GAE. If ``python-git`` is installed, there is also a button to push your application to Open Shift. To install applications on ``<span class="highlight">H</span>eroku`` or other hosting system you should look into the &quot;scripts&quot; folder for the appropriate script.</div><div class=""> </div><div class=""> #### About</div><div class=""> ``about``:inxx ``license``:inxx</div><div class=""> </div><div class=""> The &#x27;&#x27;about&#x27;&#x27; tab allows editing the description of the application and its license. These are written respectively in the ABOUT and LICENSE files in the application folder.</div><div class=""> </div><div class=""> [[image @///image/en4300.png center 480px]]</div><div class=""> </div><div class=""> You can use ``MARKMIN``, or ``gluon.contrib.markdown.WIKI`` syntax for these files as described in ref.``markdown2``:cite .</div><div class=""> </div><div class=""> #### Design</div><div class=""> ``EDIT``:inxx</div><div class=""> You have used the &#x27;&#x27;edit&#x27;&#x27; page already in this chapter. Here we want to point out a few more functionalities of the &#x27;&#x27;edit&#x27;&#x27; page.</div><div class=""> - If you click on any file name, you can see the contents of the file with syntax highlighting.</div><div class=""> - If you click on edit, you can edit the file via a web interface.</div><div class=""> - If you click on delete, you can delete the file (permanently).</div><div class=""> - If you click on test, web2py will run tests. Tests are written by the developer using Python doctests, and each function should have its own tests.</div><div class=""> - You can add language files, scan the app to discover all strings, and edit string translations via the web interface.</div><div class=""> - If the static files are organized in folders and subfolders, the folder hierarchy can be toggled by clicking on a folder name.</div><div class=""> </div><div class=""> The image below shows the output of the test page for the welcome application.</div><div class=""> </div><div class=""> [[image @///image/en4400.png center 480px]]</div><div class=""> </div><div class=""> The image below show the languages tab for the welcome application.</div><div class=""> </div><div class=""> [[image @///image/en4500.png center 480px]]</div><div class=""> </div><div class=""> The image below shows how to edit a language file, in this case the &quot;it&quot; (Italian) language for the welcome application.</div><div class=""> </div><div class=""> [[image @///image/en4600.png center 480px]]</div><div class=""> </div><div class="insert">##### Inte<span class="highlight">g</span>r<span class="highlight"></span>ated debugger</div><div class=""> </div><div class=""> &#x27;&#x27;(requires Python 2.6 or later)&#x27;&#x27;</div><div class=""> </div><div class=""> The web2py admin includes a web based debugger. Using the provided web-based editor you can add breakpoints to the Python code and, from the associated debugger console, you can inspect the system variables at those breakpoints and resume execution. This is illustrated in the following screenshot:</div><div class=""> </div><div class=""> [[image @///image/debugger.png center 480px]]</div><div class=""> </div><div class=""> This functionality is based on the Qdb debugger created by Mariano Reingart.</div><div class=""> It uses multiprocessing.connection to communicate between the backend</div><div class="insert">and frontend, with a JSON<span class="highlight">-</span>RPC-like stream protocol. ``qdb``:cite</div><div class=""> </div><div class=""> ##### Shell</div><div class=""> </div><div class=""> If you click on the &quot;shell&quot; link under the controllers tab in &#x27;&#x27;edit&#x27;&#x27;, web2py will open a web based Python shell and will execute the models for the current application. This allows you to interactively talk to your application.</div><div class=""> </div><div class=""> [[image @///image/en4700.png center 480px]]</div><div class=""> </div><div class=""> ##### Crontab</div><div class=""> </div><div class=""> Also under the controllers tab in &#x27;&#x27;edit&#x27;&#x27; there is a &quot;crontab&quot; link. By clicking on this link you will be able to edit the web2py crontab file. This follows the same syntax as the unix crontab but does not rely on unix. In fact, it only requires web2py, and it works on Windows. It allows you to register actions that need to be executed in background at scheduled times.</div><div class=""> For more information about this, see the next chapter.</div><div class=""> </div><div class=""> #### Errors</div><div class=""> ``errors``:inxx</div><div class=""> </div><div class=""> When programming web2py, you will inevitably make mistakes and introduce bugs. web2py helps in two ways: 1) it allows you to create tests for every function that can be run in the browser from the &#x27;&#x27;edit&#x27;&#x27; page; and 2) when an error manifests itself, a ticket is issued to the visitor and the error is logged.</div><div class=""> </div><div class=""> Intentionally introduce an error in the images application as shown below:</div><div class=""> ``</div><div class=""> def index():</div><div class="">     images = db().select(db.image.ALL,orderby=db.image.title)</div><div class="">     1/0</div><div class="">     return dict(images=images)</div><div class=""> ``:code</div><div class=""> </div><div class=""> When you access the index action, you get the following ticket:</div><div class=""> </div><div class=""> [[image @///image/en4800.png center 480px]]</div><div class=""> </div><div class=""> Only the administrator can access the ticket:</div><div class=""> The file &quot;0.py&quot; is very much self documented and if you are opening probably you</div><div class=""> </div><div class=""> ``</div><div class=""> GAE_APPCFG = os.path.abspath(os.path.join(&#x27;/usr/local/bin/appcfg.py&#x27;))</div><div class=""> ``</div><div class=""> This should point to the location of the &quot;appcfg.py&quot; file that comes with the Google App Engine SDK. If you have the SDK you may want to change this config parameters to the correct value. It will allow you to deploy to GAE from the admin interface.</div><div class=""> </div><div class=""> ``DEMO_MODE``:inxx</div><div class=""> </div><div class=""> You can also set web2py admin in demo mode:</div><div class=""> ``</div><div class=""> DEMO_MODE = True</div><div class=""> FILTER_APPS = [&#x27;welcome&#x27;]</div><div class=""> ``</div><div class=""> And only the apps listed in filter apps will be accessible and they will be only accessible in read-only mode.</div><div class=""> </div><div class=""> ``MULTI_USER_MODE``:inxx</div><div class=""> ``virtual laboratory``:inxx</div><div class=""> </div><div class=""> If you are a teacher and want to expose the administrative interface to students so that students can share one administrative interface for their projects (think of a virtual lab), can do it by setting:</div><div class=""> ``</div><div class=""> MULTI_USER_MODE = True</div><div class=""> ``</div><div class=""> In this way students will be required to login and will only be able to access their own apps via admin. You, as first user/teacher, will be able to access them all.</div><div class=""> </div><div class=""> In multi user mode, you can register students using the &quot;bulk register&quot; link in admin and manage them using the &quot;manage students&quot; link. The system also keep track of when students login and how many lines of code add/remove to/from their code. This data is presented to the administrator as charts under the application &quot;about&quot; page.</div><div class=""> </div><div class=""> Mind that this mechanism still assumes all users are trusted. All the apps created under admin run under the same credentials on the same filesystem. It is possible for an app created by a student to access the data and the source of an app created by another student. It is also possible for a student to create an app that locks the server.</div><div class=""> </div><div class=""> #### Mobile **admin**</div><div class=""> </div><div class="insert">Notice that the admin application includes &quot;plugin_jqmodile&quot; which packages jQuery Mobile. When admin is accessed from a mobile devi<span class="highlight">ce;</span> this is detected by web2py and the interface is displayed using a mobile<span class="highlight">-</span>friendly layout.</div></div></div>
    <div class="span6"><div class="diff"><div class=""> ``</div><div class=""> def first():</div><div class="">     form = SQLFORM.factory(Field(&#x27;visitor_name&#x27;,</div><div class="delete">                                 label=&#x27;what is you<span class="highlight">t</span> name?&#x27;,</div><div class="">                                  requires=IS_NOT_EMPTY()))</div><div class="">     if form.process().accepted:</div><div class="">         session.visitor_name = form.vars.visitor_name</div><div class="">         redirect(URL(&#x27;second&#x27;))</div><div class="">     return dict(form=form)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The ``form`` object can be easily serialized in HTML by embedding it in the &quot;default/first.html&quot; view.</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> {{=form}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> The ``form.process()`` method applies the validators and returns the form itself. The ``form.accepted`` variable is set to True if the form was processed and passed validation. If the self-submitted form passes validation, it stores the variables in the session and redirects as before. If the form does not pass validation, error messages are inserted into the form and shown to the user, as below:</div><div class=""> </div><div class=""> [[image @///image/en1800.png center 480px]]</div><div class=""> </div><div class=""> In the next section we will show how forms can be generated automatically from a model.</div><div class=""> </div><div class=""> In all or examples we have used the session to pass the user name from the first action to the second. We could have used a different mechanism and pass data as part of a redirect URL:</div><div class=""> </div><div class=""> ``</div><div class=""> def first():</div><div class="">     form = SQLFORM.factory(Field(&#x27;visitor_name&#x27;, requires=IS_NOT_EMPTY()))</div><div class="">     if form.process().accepted:</div><div class="">         name = form.vars.visitor_name</div><div class="">         redirect(URL(&#x27;second&#x27;,vars=dict(name=name)))</div><div class="">     return dict(form=form)</div><div class=""> </div><div class=""> def second():</div><div class="">     name = request.vars.visitor_name or redirect(URL(&#x27;first&#x27;))</div><div class="">     return dict(name=name)</div><div class=""> ``:code</div><div class=""> </div><div class=""> #### Internationalization</div><div class=""> </div><div class="delete">You code is likely to include hardcoded strings such as &quot;What is your name?&quot;. You should be able to customize strings without editing the code and in particular insert translations for these strings in different languages. In this wa<span class="highlight">s</span>y if a visitor has the language preference of the browser set to &quot;Italian&quot;, web2py will use the Italian translation for the strings, if available. This feature of web2py is called &quot;internationalization&quot; and it is described in more detail in the next chapter.</div><div class=""> </div><div class="delete">Here we just observe that in order to use this feature you should markup strings that need<span class="highlight"></span> <span class="highlight">s</span>translation. This is done by wrapping a a quoted string in code such as</div><div class=""> </div><div class=""> ``</div><div class=""> &quot;What is your name?&quot;</div><div class=""> ``:code</div><div class=""> </div><div class=""> with the ``T`` operator:</div><div class=""> </div><div class=""> ``</div><div class=""> T(&quot;What is your name?&quot;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> You can also mark fo translations strings hardcoded in views. For example</div><div class=""> </div><div class=""> ``</div><div class=""> &lt;h1&gt;What is your name?&lt;/h1&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> becomes</div><div class=""> </div><div class=""> ``</div><div class=""> &lt;h1&gt;{{=T(&quot;What is your name?&quot;)}}&lt;/h1&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> It is good practice to do this for every string in the code (field labels, flash messages, etc.) except for tables and field names.</div><div class=""> </div><div class="delete">Once the strings are i<span class="highlight">n</span>dentified and marked up, web2py takes care of almost ev<span class="highlight"></span>rything else. The admin interface also provides a page where you can translate each string in the languages you desire to support.</div><div class=""> </div><div class=""> ### An image blog</div><div class=""> ``upload``:inxx</div><div class=""> </div><div class=""> Here, as another example, we wish to create a web application that allows the administrator to post images and give them a name, and allows the visitors of the web site to view the named images and submit comments (posts).</div><div class=""> </div><div class=""> As before, from the **site** page in **admin**, create a new application called ``images``, and navigate to the &#x27;&#x27;edit&#x27;&#x27; page:</div><div class=""> </div><div class=""> [[image @///image/en1900.png center 480px]]</div><div class=""> </div><div class=""> We start by creating a model, a representation of the persistent data in the application (the images to upload, their names, and the comments). First, you need to create/edit a model file which, for lack of imagination, we call &quot;db.py&quot;. We assume the code below will replace any existing code in &quot;db.py&quot;. Models and controllers must have a ``.py`` extension since they are Python code. If the extension is not provided, it is appended by web2py. Views instead have a ``.html`` extension since they mainly contain HTML code.</div><div class=""> </div><div class=""> Edit the &quot;db.py&quot; file by clicking the corresponding &quot;edit&quot; button:</div><div class=""> </div><div class=""> [[image @///image/en2000.png center 480px]]</div><div class=""> </div><div class=""> and enter the following:</div><div class=""> </div><div class=""> ``IS_EMAIL``:inxx ``IS_NOT_EMPTY``:inxx ``IS_IN_DB``:inxx</div><div class=""> ``</div><div class=""> db = DAL(&quot;sqlite://storage.sqlite&quot;)</div><div class=""> </div><div class=""> db.define_table(&#x27;image&#x27;,</div><div class="">    Field(&#x27;title&#x27;, unique=True),</div><div class="">    Field(&#x27;file&#x27;, &#x27;upload&#x27;),</div><div class="">    format = &#x27;%(title)s&#x27;)</div><div class=""> </div><div class=""> db.define_table(&#x27;post&#x27;,</div><div class="">    Field(&#x27;image_id&#x27;, &#x27;reference image&#x27;),</div><div class="">    Field(&#x27;author&#x27;),</div><div class=""> The database representation is an internal issue and does not affect the code. I</div><div class=""> for page in db(db.page).select():</div><div class="">     print page.title, page.day, page.month, page.year</div><div class=""> ``</div><div class=""> </div><div class=""> When dates are converted to strings in forms they are converted using the ISO representation</div><div class=""> ``</div><div class=""> %Y-%m-%d %H:%M:%S</div><div class=""> ``</div><div class=""> </div><div class=""> yet this representation in internationalized and you can use the admin stranslation page to change the format to an alternate one. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> %m/%b/%Y %H:%M:%S</div><div class=""> ``</div><div class=""> </div><div class=""> Mind that by default English is not translated because web2py assumes the applications is already written in English. If you want internationalization to work for English you need to create the translation file (using admin) and you need declare that the application current language is something other than english, for example:</div><div class=""> ``</div><div class=""> T.current_languages = [&#x27;null&#x27;]</div><div class=""> ``</div><div class=""> </div><div class=""> ### The built-in web2py wiki</div><div class=""> </div><div class=""> Now you can forget the code we have built-in the previous section (not what you have learned about web2py APIs, just the code of the specific example) as we are going to provide and example of the built-in web2py wiki.</div><div class=""> </div><div class=""> In fact, web2py comes with wiki capabilities including media attachments, tags, tag cloud, page permissions, and support for oembed ``oembed``:cite and components (chapter 14). This wiki can be used with any web2py application.</div><div class=""> </div><div class=""> ------</div><div class=""> Notice the API of the built-in wiki are still considered experimental and small changes are still possible.</div><div class=""> ------</div><div class=""> </div><div class="delete">Here we assume we are starting from <span class="highlight"></span>cratch from a simple clone of the &quot;welcome&quot; application called &quot;wikidemo&quot;. Edit the controller and replace the &quot;index&quot; action with</div><div class=""> </div><div class=""> ``</div><div class=""> def index(): return auth.wiki()</div><div class=""> ``:code</div><div class=""> </div><div class=""> Done! You have a fully working wiki. At this point no page has been created and in order to create pages you must be logged-in and you must be member of a group called &quot;wiki-editor&quot; or &quot;wiki-author&quot;. If you are logged as administrator the &quot;wiki-editor&quot; group is created automatically and you are made a member. The difference between editors and authors is that the editors can create pages, edit and delete any page, while the authors can create pages (with some optional restrictions) and can only edit/delete the pages they have created.</div><div class=""> </div><div class=""> The ``auth.wiki()`` function returns in a dictionary with a key ``content`` which is understood by the scaffolding &quot;views/default/index.html&quot;. You man make your own view for this action:</div><div class=""> </div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> {{=content}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> and add extra HTML or code as needed. There is no need to call the action &quot;index&quot;.</div><div class=""> </div><div class=""> To try the wiki, simply login into admin, visit the page</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index</div><div class=""> ``</div><div class=""> </div><div class=""> Then choose a slug (in the publishing business, a slug is a short name given to an article that is in production) and you will be redirected to an empty page where you can edit the content using MARKMIN wiki syntax. A new menu item called &quot;[wiki]&quot; will allow you create, search, and edit pages. Wiki pages have RULS like:</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/[slug]</div><div class=""> ``</div><div class=""> </div><div class=""> Service pages have names which start by underscore:</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_create</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_search</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_could</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_recent</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_edit/...</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_editmedia/...</div><div class=""> http://127.0.0.1:8000/wikidemo/default/index/_preview/...</div><div class=""> ``</div><div class=""> </div><div class=""> Try create more pages such as &quot;index&quot;, &quot;aboutus&quot;, and &quot;contactus&quot;.</div><div class=""> Try edit them.</div><div class=""> </div><div class=""> </div><div class=""> The ``wiki`` method has the following signature:</div><div class=""> </div><div class=""> ``</div><div class=""> def wiki(self, slug=None, env=None, render=&#x27;markmin&#x27;,</div><div class="">          manage_permissions=False, force_prefix=&#x27;&#x27;,</div><div class="">          restrict_search=False, resolve=True,</div><div class="">          extra=None, menugroups=None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> It takes the following arguments:</div><div class=""> </div><div class="delete">-- ``render`` which defaults to ``&#x27;markmin&#x27;`` but can be set equal to ``&#x27;html&#x27;``. It termines the syntax of the wiki. We will discuss the makrmin wiki markup later. If you change it to HTML you may want to use a wysiwyg javascript editor such as TinyMCE of NicEdit.</div><div class="delete">-- ``manage_permissions``. This is set to ``False`` by default and only recognizes permissions for &quot;wiki-editor&quot; and &quot;wiki-author&quot;. If you change it to ``True`` the create/edit page will give the option to specify by names the groups whose members have permssion to read and edit the page. In this case is a group &quot;everybody&quot; to give read permission to everybody.</div><div class="delete">-- ``force_prefix``. If set to something like ``&#x27;%(id)s-&#x27;`` it will restict authors (not editors) to create page with a prefix like &quot;[user id]-[page name]&quot;. The prefix can contain the id (&quot;%(id)s&quot;) or the username (&quot;%(username)s&quot;) or any other field from the auth_user table, as long as the corresponding column contains valid string that would pass URL validation.</div><div class=""> - ``restrict_search``. This default to ``False`` and any logged-in user can search all wiki pages (but not necessary read or edit them). If set to ``True``, authors can search only their own pages, editors can search everything, other users cannot search anything.</div><div class="delete">- ``menugroups``. This defaults to ``None`` and it indic<span class="highlight">t</span>ates that wiki management menu (search, create, edit, etc.) is always displayed. You can set it to a list of group names whose members only can see this menu, for ex<span class="highlight">ma</span>ple ``[&#x27;wiki-editor&#x27;,&#x27;wiki-author&#x27;]``. Notice that even if the menu is exposed to everybody does not mean everybody is allowed to perform actions listed in the menu since they are regulated by the access control system.</div><div class=""> </div><div class=""> The ``wiki`` method has some additional parameters which will be explained later: ``slug``, ``env``, and ``extra``.</div><div class=""> </div><div class=""> </div><div class=""> </div><div class=""> #### MARKMIN basics</div><div class=""> </div><div class=""> The MARKMIN syntax allows you to markup **bold** text using ``**bold**``, &#x27;&#x27;italic&#x27;&#x27; text with ``&#x27;&#x27;italic&#x27;&#x27;``, ``code`` text with ``\`\`code\`\```. Titles must be prefixed by a #, sections by ##, and sub-sections by ###. Use a minus(-) to prefix an un-ordered item and plus(+) to prefix an ordered item. URLs are automatically into links. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> # This is title</div><div class=""> ## this is a section title</div><div class=""> ### this is a subsection title</div><div class=""> </div><div class=""> Text can be **bold**, &#x27;&#x27;italic&#x27;&#x27;, !`!!`!code!`!!`! etc.</div><div class=""> Learn more at:</div><div class=""> </div><div class=""> http://web2py.com</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> You can use the ``extra`` parameter of ``auth.wiki`` to pass extra rendering rules to the MARKMIN helper.</div><div class=""> </div><div class=""> You can find more information about the MARKMIN syntax in chapter 5.</div><div class=""> </div><div class="delete">``auth.wiki`` is more powerful than the barebone<span class="highlight"></span> MARKMIN helpers<span class="highlight">. In fact it</span> support<span class="highlight">s</span> oembed and components.</div><div class=""> </div><div class=""> You can use theS ``env`` parameter of ``auth.wiki`` to expose functions to your wiki.</div><div class=""> For example:</div><div class=""> </div><div class=""> ``</div><div class=""> auth.wiki(env=dict(join=lambda a,b,c:&quot;%s-%s-%s&quot; % (a,b,c)))</div><div class=""> ``</div><div class=""> </div><div class=""> allows you to use the markup syntax:</div><div class=""> </div><div class=""> ``</div><div class=""> @(join:1,2,3)</div><div class=""> ``</div><div class=""> </div><div class=""> </div><div class="delete">This call the join function passed as extra with parameters ``a,b,c=1,2,3`` and will be re<span class="highlight"></span>dered as ``1-2-3``.</div><div class=""> </div><div class=""> #### Oembed protocol</div><div class=""> </div><div class=""> You can type in (or cut-and-paste) any URL into a wiki page it normally is rendered as a link to the URL. There are exceptions:</div><div class=""> </div><div class=""> - If the URL has an image extension, the link is embedded as an image, ``&lt;img/&gt;``.</div><div class=""> - If the URL has an audio extension, the link is embedded as HTML5 audio ``&lt;audio/&gt;``.</div><div class=""> - If the URL has a video extension, the link is embedded as HTML5 video ``&lt;video/&gt;``.</div><div class=""> - If the URL has a MS Office or PDF extension, Google Doc Viewer is embedded, showing the content of the document (only works for public documents).</div><div class="delete">- If the URL points to a Youtube page, a Vi<span class="highlight">e</span>m<span class="highlight"></span>o page, or a Flickr page, web2py contacts the corr<span class="highlight"></span>sponding web service and queries it about the prop<span class="highlight">o</span>r way to embed the conte<span class="highlight">c</span>t. This is done using the ``oembed`` protocol.</div><div class=""> </div><div class=""> Here is a complete list of supported formats:</div><div class=""> ``</div><div class=""> Image (.PNG, .GIF, .JPG, .JPEG)</div><div class=""> Audio (.WAV, .OGG, .MP3)</div><div class=""> Video (.MOV, .MPE, .MP4, .MPG, .MPG2, .MPEG, .MPEG4, .MOVIE)</div><div class=""> ``</div><div class=""> </div><div class=""> Supported via Google Doc Viewer:</div><div class=""> </div><div class=""> ``</div><div class=""> Microsoft Excel (.XLS and .XLSX)</div><div class=""> Microsoft PowerPoint 2007 / 2010 (.PPTX)</div><div class=""> Apple Pages (.PAGES)</div><div class=""> Adobe PDF (.PDF)</div><div class=""> Adobe Illustrator (.AI)</div><div class=""> Adobe Photoshop (.PSD)</div><div class=""> Autodesk AutoCad (.DXF)</div><div class=""> Scalable Vector Graphics (.SVG)</div><div class=""> PostScript (.EPS, .PS)</div><div class=""> TrueType (.TTF)</div><div class=""> xml Paper Specification (.XPS)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Supported by oembed:</div><div class=""> </div><div class=""> ``</div><div class=""> flickr.com</div><div class=""> youtube.com</div><div class=""> hulu.com</div><div class=""> vimeo.com</div><div class=""> slideshare.net</div><div class=""> qik.com</div><div class=""> polleverywhere.com</div><div class=""> wordpress.com</div><div class=""> revision3.com</div><div class=""> viddler.com</div><div class=""> ``:code</div><div class=""> </div><div class="delete">This is implemen<span class="highlight">e</span>ted in the web2py file ``gluon.contrib.autolinks`` and specifically in the function ``expand_one``. You can extend oembed support by registering more services. This is done by appending an entry to the ``EMBED_MAPS`` list:</div><div class=""> </div><div class=""> ``</div><div class="delete">from gluon.contrib.aut<span class="highlight"></span>links import EMBED_MAPS</div><div class=""> EMBED_MAPS.append((re.compile(&#x27;http://vimeo.com/\S*&#x27;),</div><div class="">                    &#x27;http://vimeo.com/api/oembed.json&#x27;))</div><div class=""> ``:code</div><div class=""> </div><div class=""> #### Referencing wiki content</div><div class=""> </div><div class=""> If you create a wiki page with slug &quot;contactus&quot; you can refer to this page as</div><div class=""> </div><div class=""> ``</div><div class=""> \@////contactus</div><div class=""> ``:code</div><div class=""> </div><div class=""> Here ``\@////`` stands for</div><div class=""> </div><div class=""> ``</div><div class=""> \@/app/controller/function/</div><div class=""> ``:code</div><div class=""> </div><div class=""> but &quot;app&quot;, &quot;controller&quot;, and &quot;function&quot; are omitted thus assuming default.</div><div class=""> </div><div class="delete">Similarly you can use the wiki menu to upload a media file (for example an image) linked to the page. The &quot;manage media&quot; page will show all files you have uploaded and will show the proper expression to link the media file. If, for example you upload a file &quot;test.jpg&quot; with title &quot;beach&quot;, the link expression will som<span class="highlight"></span>thing like:</div><div class=""> </div><div class=""> ``</div><div class=""> \@////15/beach.jpg</div><div class=""> ``:code</div><div class=""> </div><div class=""> ``\@////`` is the same prefix described before. ``15`` is the id of the record storing the media file. ``beach`` is the title. ``.jpg`` is the extension of the original file.</div><div class=""> </div><div class=""> If you cut and paste ``\@////15/beach.jpg`` into wiki pages you embed the image.</div><div class=""> </div><div class=""> Mind that media files are linked to pages and inherit access permission from the pages.</div><div class=""> </div><div class=""> #### Wiki menus</div><div class=""> </div><div class=""> If you create a page with slug &quot;wiki-menu&quot; page it will be interpreted as a description of the menu. Here is an example:</div><div class=""> </div><div class=""> ``</div><div class=""> - Home &gt; \@////index</div><div class=""> - Info &gt; \@////info</div><div class=""> - web2py &gt; http://google.com</div><div class=""> - - About us &gt; \@////aboutus</div><div class="delete">- - Co<span class="highlight">u</span>ntact us &gt; \@////contactus</div><div class=""> ``</div><div class=""> </div><div class="delete">Each line a menu item. We used double dash for nested menu ite<span class="highlight"></span>s. The ``&gt;`` symbols separates the menu item title from the menu item link.</div><div class=""> </div><div class=""> Mind that the menu is appended to ``response.menu``. It does not replace it. The ``[wiki]`` menu tem with service functions is added automatically.</div><div class=""> </div><div class=""> #### Service functions</div><div class=""> </div><div class=""> If, for example, you want to use the wiki to create an editable sidebar you could create a page with ``slug=&quot;sidebar&quot;`` and then embed it in your layout.html with</div><div class=""> </div><div class=""> ``</div><div class=""> {{=auth.wiki(slug=&#x27;sidebar&#x27;)}}</div><div class=""> ``:code</div><div class=""> </div><div class="delete">Notice that there is nothing special with the word &quot;sidebar&quot;. Any wiki page can be retrieved and em<span class="highlight">eb</span>dded in any point in your code. This allows you mix and match wiki functionalities with regular web2py functionalities.</div><div class=""> </div><div class=""> You can also embed special wiki functions as the search by tags:</div><div class=""> </div><div class=""> ``</div><div class=""> {{=auth.wiki(&#x27;_search&#x27;)}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> or the tag cloud:</div><div class=""> </div><div class=""> ``</div><div class=""> {{=auth.wiki(&#x27;_cloud&#x27;)}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> #### Components</div><div class=""> </div><div class=""> One of the most powerful function of the new web2py consists in the ability of embedding an action inside another action. We call this a component.</div><div class=""> </div><div class=""> Consider the following model:</div><div class=""> </div><div class=""> ``</div><div class=""> db.define_table(&#x27;thing&#x27;,Field(&#x27;name&#x27;,requires=IS_NOT_EMPTY()))</div><div class=""> ``:code</div><div class=""> </div><div class=""> and the following action:</div><div class=""> </div><div class=""> ``</div><div class=""> @auth.requires_login()</div><div class=""> def manage_things():</div><div class="">     return SQLFORM.grid(db.thing)</div><div class=""> ``:code</div><div class=""> </div><div class=""> This action is special because it returns a widget/helper not a dict of objects. Now we can embed this ``manage_things`` action into any view, with</div><div class=""> </div><div class=""> ``</div><div class=""> {{=LOAD(&#x27;default&#x27;,&#x27;manage_things&#x27;,ajax=True)}}</div><div class=""> ``:code</div><div class=""> </div><div class="delete">This allows the visitor interact with the component via Ajax without reloadin<span class="highlight"></span> the host page that embeds the widget. Basically the action is called via Ajax, inherits the stile of the host page, and capture all forms submissions and flash messages so that th<span class="highlight"></span>y<span class="highlight">e</span> are handled within the current page. On top of this the ``SQLFORM.grid`` widget uses digitally signed URLs to restrict access. More informa<span class="highlight">it</span>on about components can be found in chapter 13.</div><div class=""> </div><div class=""> Components like the one above can be embedded into wiki pages using the MARKMIN syntax:</div><div class=""> </div><div class=""> ``</div><div class=""> @{component:default/manage_things}</div><div class=""> ``</div><div class=""> </div><div class=""> This simply tells web2py that we want to incude the &quot;manage_things&quot; action defined in the &quot;default&quot; controller as an Ajax &quot;component&quot;.</div><div class=""> </div><div class=""> ---------</div><div class="delete">Most users will be able to build relatively complex applications simply by using ``auth.wiki`` to create pages and menus<span class="highlight"></span>, <span class="highlight">and embedded custom components into wiki pages</span>.<span class="highlight"> Wiki can be tough as a mechanism to allow members of the group to create pages but they calso be though as a way to develop applications in a modular way.</span></div><div class=""> ---------</div><div class=""> </div><div class=""> ### More on **admin**</div><div class=""> ``admin``:inxx</div><div class=""> </div><div class=""> The administrative interface provides additional functionality that we briefly review here.</div><div class=""> </div><div class=""> #### Site</div><div class=""> ``site``:inxx</div><div class=""> </div><div class=""> This page lists all installed applications. There are two forms at the bottom.</div><div class=""> </div><div class=""> The first of them allows creating a new application by specifying its name.</div><div class=""> </div><div class=""> ``Instant Press``:inxx ``Movuca``:inxx</div><div class=""> The second form allows uploading an existing application from either a local file or a remote URL. When you upload an application, you need to specify a name for it. This can be its original name, but does not need to be. This allows installing multiple copies of the same application. You can try, for example, to upload the Movuca Social Networking application app created by Bruno Rocha:</div><div class=""> </div><div class=""> ``</div><div class=""> http://code.google.com/p/instant-press/</div><div class=""> ``</div><div class=""> </div><div class=""> or Instant Press CMS created by Martin Mulone:</div><div class=""> </div><div class=""> ``</div><div class=""> http://code.google.com/p/instant-press/</div><div class=""> ``</div><div class=""> </div><div class=""> or one of the many example applications available at:</div><div class=""> </div><div class=""> ``</div><div class=""> http://web2py.com/appliances</div><div class=""> ``</div><div class=""> </div><div class=""> ------</div><div class=""> Web2py files are packages as ``.w2p`` files. These ones are tar gzipped files. Web2py uses the ``.w2p`` extension instead of the ``.tgz`` extension to prevent the browser from unzipping on download. They can be uncompressed manually with ``tar zxvf [filename]`` although this is never necessary.</div><div class=""> ------</div><div class=""> </div><div class=""> [[image @///image/en4100.png center 444px]]</div><div class=""> </div><div class=""> Upon successful upload, web2py displays the MD5 checksum of the uploaded file. You can use it to verify that the file was not corrupted during upload. The InstantPress name will appear in the list of installed applications.</div><div class=""> </div><div class=""> Click on the application name on admin to get it up and running.</div><div class=""> </div><div class="delete">If you run web2py from source and you have ``py<span class="highlight">ht</span>on-git`` installed, you can install applications directly from git repo<span class="highlight">r</span>sitory using the ``.git`` URL in the upload form. In this case you will also be used to user the admin interface to push changes back into the repository.</div><div class=""> </div><div class=""> For each application the &#x27;&#x27;site&#x27;&#x27; page allows you to:</div><div class=""> - Uninstall the application.</div><div class=""> - Jump to the &#x27;&#x27;about&#x27;&#x27; page (read below).</div><div class=""> - Jump to the &#x27;&#x27;edit&#x27;&#x27; page (read below).</div><div class=""> - Jump to the &#x27;&#x27;errors&#x27;&#x27; page (read below).</div><div class=""> - Clean up temporary files (sessions, errors, and cache.disk files).</div><div class=""> - Pack all. This returns a tar file containing a complete copy of the application. We suggest that you clean up temporary files before packing an application.</div><div class=""> - Compile the application. If there are no errors, this option will bytecode-compile all models, controllers and views. Because views can extend and include other views in a tree, before bytecode compilation, the view tree for every controller is collapsed into a single file. The net effect is that a bytecode-compiled application is faster, because there is no more parsing of templates or string substitutions occurring at runtime.</div><div class=""> - Pack compiled. This option is only present for bytecode-compiled applications. It allows packing the application without source code for distribution as closed source. Note that Python (as any other programming language) can technically be decompiled; therefore compilation does not provide complete protection of the source code. Nevertheless, decompilation can be difficult and can be illegal.</div><div class=""> - Remove compiled. It simply removes the byte-code compiled models, views and controllers from the application. If the application was packaged with source code or edited locally, there is no harm in removing the bytecode-compiled files, and the application will continue to work. If the application was installed form a packed compiled file, then this is not safe, because there is no source code to revert to, and the application will no longer work.</div><div class=""> </div><div class=""> ``admin.py``:inxx</div><div class=""> </div><div class=""> -------</div><div class=""> All the functionality available from the web2py admin site page is also accessible programmatically via the API defined in the module ``gluon/admin.py``. Simply open a python shell and import this module.</div><div class=""> -------</div><div class=""> </div><div class="delete">If the Google App Engine SDK is installer the admin &#x27;&#x27;site&#x27;&#x27; page shows a button to push your applications to GAE. If ``python-git`` is installed, there is also a button to push your application to Open Shift. To install applications on ``<span class="highlight">h</span>eroku`` or other hosting system you should look into the &quot;scripts&quot; folder for the appropriate script.</div><div class=""> </div><div class=""> #### About</div><div class=""> ``about``:inxx ``license``:inxx</div><div class=""> </div><div class=""> The &#x27;&#x27;about&#x27;&#x27; tab allows editing the description of the application and its license. These are written respectively in the ABOUT and LICENSE files in the application folder.</div><div class=""> </div><div class=""> [[image @///image/en4300.png center 480px]]</div><div class=""> </div><div class=""> You can use ``MARKMIN``, or ``gluon.contrib.markdown.WIKI`` syntax for these files as described in ref.``markdown2``:cite .</div><div class=""> </div><div class=""> #### Design</div><div class=""> ``EDIT``:inxx</div><div class=""> You have used the &#x27;&#x27;edit&#x27;&#x27; page already in this chapter. Here we want to point out a few more functionalities of the &#x27;&#x27;edit&#x27;&#x27; page.</div><div class=""> - If you click on any file name, you can see the contents of the file with syntax highlighting.</div><div class=""> - If you click on edit, you can edit the file via a web interface.</div><div class=""> - If you click on delete, you can delete the file (permanently).</div><div class=""> - If you click on test, web2py will run tests. Tests are written by the developer using Python doctests, and each function should have its own tests.</div><div class=""> - You can add language files, scan the app to discover all strings, and edit string translations via the web interface.</div><div class=""> - If the static files are organized in folders and subfolders, the folder hierarchy can be toggled by clicking on a folder name.</div><div class=""> </div><div class=""> The image below shows the output of the test page for the welcome application.</div><div class=""> </div><div class=""> [[image @///image/en4400.png center 480px]]</div><div class=""> </div><div class=""> The image below show the languages tab for the welcome application.</div><div class=""> </div><div class=""> [[image @///image/en4500.png center 480px]]</div><div class=""> </div><div class=""> The image below shows how to edit a language file, in this case the &quot;it&quot; (Italian) language for the welcome application.</div><div class=""> </div><div class=""> [[image @///image/en4600.png center 480px]]</div><div class=""> </div><div class="delete">##### Inte<span class="highlight"></span>r<span class="highlight">g</span>ated debugger</div><div class=""> </div><div class=""> &#x27;&#x27;(requires Python 2.6 or later)&#x27;&#x27;</div><div class=""> </div><div class=""> The web2py admin includes a web based debugger. Using the provided web-based editor you can add breakpoints to the Python code and, from the associated debugger console, you can inspect the system variables at those breakpoints and resume execution. This is illustrated in the following screenshot:</div><div class=""> </div><div class=""> [[image @///image/debugger.png center 480px]]</div><div class=""> </div><div class=""> This functionality is based on the Qdb debugger created by Mariano Reingart.</div><div class=""> It uses multiprocessing.connection to communicate between the backend</div><div class="delete">and frontend, with a JSON<span class="highlight"></span>RPC-like stream protocol. ``qdb``:cite</div><div class=""> </div><div class=""> ##### Shell</div><div class=""> </div><div class=""> If you click on the &quot;shell&quot; link under the controllers tab in &#x27;&#x27;edit&#x27;&#x27;, web2py will open a web based Python shell and will execute the models for the current application. This allows you to interactively talk to your application.</div><div class=""> </div><div class=""> [[image @///image/en4700.png center 480px]]</div><div class=""> </div><div class=""> ##### Crontab</div><div class=""> </div><div class=""> Also under the controllers tab in &#x27;&#x27;edit&#x27;&#x27; there is a &quot;crontab&quot; link. By clicking on this link you will be able to edit the web2py crontab file. This follows the same syntax as the unix crontab but does not rely on unix. In fact, it only requires web2py, and it works on Windows. It allows you to register actions that need to be executed in background at scheduled times.</div><div class=""> For more information about this, see the next chapter.</div><div class=""> </div><div class=""> #### Errors</div><div class=""> ``errors``:inxx</div><div class=""> </div><div class=""> When programming web2py, you will inevitably make mistakes and introduce bugs. web2py helps in two ways: 1) it allows you to create tests for every function that can be run in the browser from the &#x27;&#x27;edit&#x27;&#x27; page; and 2) when an error manifests itself, a ticket is issued to the visitor and the error is logged.</div><div class=""> </div><div class=""> Intentionally introduce an error in the images application as shown below:</div><div class=""> ``</div><div class=""> def index():</div><div class="">     images = db().select(db.image.ALL,orderby=db.image.title)</div><div class="">     1/0</div><div class="">     return dict(images=images)</div><div class=""> ``:code</div><div class=""> </div><div class=""> When you access the index action, you get the following ticket:</div><div class=""> </div><div class=""> [[image @///image/en4800.png center 480px]]</div><div class=""> </div><div class=""> Only the administrator can access the ticket:</div><div class=""> The file &quot;0.py&quot; is very much self documented and if you are opening probably you</div><div class=""> </div><div class=""> ``</div><div class=""> GAE_APPCFG = os.path.abspath(os.path.join(&#x27;/usr/local/bin/appcfg.py&#x27;))</div><div class=""> ``</div><div class=""> This should point to the location of the &quot;appcfg.py&quot; file that comes with the Google App Engine SDK. If you have the SDK you may want to change this config parameters to the correct value. It will allow you to deploy to GAE from the admin interface.</div><div class=""> </div><div class=""> ``DEMO_MODE``:inxx</div><div class=""> </div><div class=""> You can also set web2py admin in demo mode:</div><div class=""> ``</div><div class=""> DEMO_MODE = True</div><div class=""> FILTER_APPS = [&#x27;welcome&#x27;]</div><div class=""> ``</div><div class=""> And only the apps listed in filter apps will be accessible and they will be only accessible in read-only mode.</div><div class=""> </div><div class=""> ``MULTI_USER_MODE``:inxx</div><div class=""> ``virtual laboratory``:inxx</div><div class=""> </div><div class=""> If you are a teacher and want to expose the administrative interface to students so that students can share one administrative interface for their projects (think of a virtual lab), can do it by setting:</div><div class=""> ``</div><div class=""> MULTI_USER_MODE = True</div><div class=""> ``</div><div class=""> In this way students will be required to login and will only be able to access their own apps via admin. You, as first user/teacher, will be able to access them all.</div><div class=""> </div><div class=""> In multi user mode, you can register students using the &quot;bulk register&quot; link in admin and manage them using the &quot;manage students&quot; link. The system also keep track of when students login and how many lines of code add/remove to/from their code. This data is presented to the administrator as charts under the application &quot;about&quot; page.</div><div class=""> </div><div class=""> Mind that this mechanism still assumes all users are trusted. All the apps created under admin run under the same credentials on the same filesystem. It is possible for an app created by a student to access the data and the source of an app created by another student. It is also possible for a student to create an app that locks the server.</div><div class=""> </div><div class=""> #### Mobile **admin**</div><div class=""> </div><div class="delete">Notice that the admin application includes &quot;plugin_jqmodile&quot; which packages jQuery Mobile. When admin is accessed from a mobile devi<span class="highlight">de,</span> this is detected by web2py and the interface is displayed using a mobile<span class="highlight"> </span>friendly layout.</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/e234f6edf67361b3ba718ea10184ba8e7c2f773d">e234f6e</a><ul><li>Date : 2012-12-20</li><li>lots of improvements</li></ul></li></ul>
<div class="row-fluid" id="com_e234f6edf67361b3ba718ea10184ba8e7c2f773d">
    <div class="span6"><div class="diff"><div class=""> Clicking on &quot;administrative interface&quot; takes you to the login page for the admin</div></div></div>
    <div class="span6"><div class="diff"><div class=""> Clicking on &quot;administrative interface&quot; takes you to the login page for the admin</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/eaaa0e14bf17cdc4d0edd2ea9daa9af5f3484c09">eaaa0e1</a><ul><li>Date : 2012-12-25</li><li>changes to style</li></ul></li></ul>
<div class="row-fluid" id="com_eaaa0e14bf17cdc4d0edd2ea9daa9af5f3484c09">
    <div class="span6"><div class="diff"><div class="insert">+</div><div class=""> #### Say my name</div><div class=""> ``form``:inxx ``request.vars``:inxx</div><div class=""> </div><div class=""> Now create two pages (first and second), where the first page creates a form, asks the visitor&#x27;s name, and redirects to the second page, which greets the visitor by name.</div><div class=""> </div><div class=""> [[yUML diagram @///image/en1400.png center 293px]]</div><div class=""> </div><div class=""> Write the corresponding actions in the default controller:</div><div class=""> ``</div><div class=""> def first():</div><div class="">     return dict()</div><div class=""> </div><div class=""> def second():</div><div class="">     return dict()</div><div class=""> ``:code</div><div class=""> </div><div class=""> Then create a view &quot;default/first.html&quot; for the first action,</div><div class=""> and enter:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class="insert"><span class="highlight">&lt;h1&gt;</span>What is your name?<span class="highlight">&lt;/h1&gt;</span></div><div class=""> &lt;form action=&quot;second&quot;&gt;</div><div class="">   &lt;input name=&quot;visitor_name&quot; /&gt;</div><div class="">   &lt;input type=&quot;submit&quot; /&gt;</div><div class=""> &lt;/form&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> Finally, create a view &quot;default/second.html&quot; for the second action:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Hello {{=request.vars.visitor_name}}&lt;/h1&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> ``layout``:inxx</div><div class=""> In both views we have extended the basic &quot;layout.html&quot; view that comes with web2py. The layout view keeps the look and feel of the two pages coherent. The layout file can be edited and replaced easily, since it mainly contains HTML code.</div><div class=""> </div><div class=""> If you now visit the first page, type your name:</div><div class=""> </div><div class=""> [[image @///image/en1500.png center 480px]]</div><div class=""> </div><div class=""> and submit the form, you will receive a greeting:</div><div class=""> </div><div class=""> [[image @///image/en1600.png center 480px]]</div><div class=""> </div><div class=""> #### Postbacks</div><div class=""> ``redirect``:inxx ``URL``:inxx ``postback``:inxx</div><div class=""> </div><div class=""> The mechanism for form submission that we used before is very common, but it is not good programming practice. All input should be validated and, in the above example, the burden of validation would fall on the second action. Thus the action that performs the validation is different from the action that generated the form. This tends to cause redundancy in the code.</div><div class=""> </div><div class=""> A better pattern for form submission is to submit forms to the same action that generated them, in our example the &quot;first&quot;. The &quot;first&quot; action should receive the variables, process them, store them server-side, and redirect the visitor to the &quot;second&quot; page, which retrieves the variables. This mechanism is called a &#x27;&#x27;postback&#x27;&#x27;.</div><div class=""> </div><div class=""> This approach is better also because the name of the visitor stays in the sessio</div><div class=""> Note that if the &quot;second&quot; action is ever called before a visitor name is set, it will display &quot;Hello anonymous&quot; because  ``session.visitor_name`` returns ``None``. Alternatively we could have added the following code in the controller (inside the ``second`` function):</div><div class=""> </div><div class=""> ``</div><div class=""> if not request.function==&#x27;first&#x27; and not session.visitor_name:</div><div class="">     redirect(URL(&#x27;first&#x27;))</div><div class=""> ``:code</div><div class=""> </div><div class=""> This is a general mechanism that you can use to enforce authorization on controllers, though see Chapter 9 for a more powerful method.</div><div class=""> </div><div class=""> ``FORM``:inxx ``INPUT``:inxx ``requires``:inxx ``IS_NOT_EMPTY``:inxx ``accepts``:inxx</div><div class=""> </div><div class=""> With web2py we can move one step further and ask web2py to generate the form for us, including validation. web2py provides helpers (FORM, INPUT, TEXTAREA, and SELECT/OPTION) with the same names as the equivalent HTML tags. They can be used to build forms either in the controller or in the view.</div><div class=""> </div><div class=""> For example, here is one possible way to rewrite the first action:</div><div class=""> ``</div><div class=""> def first():</div><div class="">     form = FORM(INPUT(_name=&#x27;visitor_name&#x27;, requires=IS_NOT_EMPTY()),</div><div class="">               INPUT(_type=&#x27;submit&#x27;))</div><div class="">     if form.process().accepted:</div><div class="">         session.visitor_name = form.vars.visitor_name</div><div class="">         redirect(URL(&#x27;second&#x27;))</div><div class="">     return dict(form=form)</div><div class=""> ``:code</div><div class=""> </div><div class=""> where we are saying that the FORM tag contains two INPUT tags. The attributes of the input tags are specified by the named arguments starting with underscore. The ``requires`` argument is not a tag attribute (because it does not start by underscore) but it sets a validator for the value of visitor_name.</div><div class=""> </div><div class=""> Here is yet another better way to create the same form:</div><div class=""> </div><div class=""> ``</div><div class=""> def first():</div><div class="insert">+    form = SQLFORM.factory(Field(&#x27;visitor_name&#x27;, </div><div class="insert">+                                 label=&#x27;what is yout name?&#x27;,</div><div class="insert">+                                 requires=IS_NOT_EMPTY()))</div><div class="">     if form.process().accepted:</div><div class="">         session.visitor_name = form.vars.visitor_name</div><div class="">         redirect(URL(&#x27;second&#x27;))</div><div class="">     return dict(form=form)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The ``form`` object can be easily serialized in HTML by embedding it in the &quot;default/first.html&quot; view.</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> {{=form}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> The ``form.process()`` method applies the validators and returns the form itself. The ``form.accepted`` variable is set to True if the form was processed and passed validation. If the self-submitted form passes validation, it stores the variables in the session and redirects as before. If the form does not pass validation, error messages are inserted into the form and shown to the user, as below:</div><div class=""> </div><div class=""> [[image @///image/en1800.png center 480px]]</div><div class=""> </div><div class=""> In the next section we will show how forms can be generated automatically from a model.</div><div class=""> </div><div class=""> In all or examples we have used the session to pass the user name from the first action to the second. We could have used a different mechanism and pass data as part of a redirect URL:</div><div class=""> </div><div class=""> ``</div><div class=""> def first():</div><div class="">     form = SQLFORM.factory(Field(&#x27;visitor_name&#x27;, requires=IS_NOT_EMPTY()))</div><div class="">     if form.process().accepted:</div><div class="">         name = form.vars.visitor_name</div><div class="">         redirect(URL(&#x27;second&#x27;,vars=dict(name=name)))</div><div class="">     return dict(form=form)</div><div class=""> </div><div class=""> def second():</div><div class="">     name = request.vars.visitor_name or redirect(URL(&#x27;first&#x27;))</div><div class="">     return dict(name=name)</div><div class=""> ``:code</div><div class=""> </div><div class="insert">+#### Internationalization</div><div class="insert">+</div><div class="insert">+You code is likely to include hardcoded strings such as &quot;What is your name?&quot;. You should be able to customize strings without editing the code and in particular insert translations for these strings in different languages. In this wasy if a visitor has the language preference of the browser set to &quot;Italian&quot;, web2py will use the Italian translation for the strings, if available. This feature of web2py is called &quot;internationalization&quot; and it is described in more detail in the next chapter.</div><div class="insert">+</div><div class="insert">+Here we just observe that in order to use this feature you should markup strings that need stranslation. This is done by wrapping a a quoted string in code such as </div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+&quot;What is your name?&quot;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+with the ``T`` operator:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+T(&quot;What is your name?&quot;)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+</div><div class="insert">+You can also mark fo translations strings hardcoded in views. For example</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+&lt;h1&gt;What is your name?&lt;/h1&gt;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+becomes</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+&lt;h1&gt;{{=T(&quot;What is your name?&quot;)}}&lt;/h1&gt;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+It is good practice to do this for every string in the code (field labels, flash messages, etc.) except for tables and field names.</div><div class="insert">+</div><div class="insert">+Once the strings are indentified and marked up, web2py takes care of almost evrything else. The admin interface also provides a page where you can translate each string in the languages you desire to support.</div><div class="insert">+</div><div class=""> ### An image blog</div><div class=""> ``upload``:inxx</div><div class=""> </div><div class=""> Here, as another example, we wish to create a web application that allows the administrator to post images and give them a name, and allows the visitors of the web site to view the named images and submit comments.</div><div class=""> </div><div class=""> As before, from the **site** page in **admin**, create a new application called ``images``, and navigate to the &#x27;&#x27;edit&#x27;&#x27; page:</div><div class=""> </div><div class=""> [[image @///image/en1900.png center 480px]]</div><div class=""> </div><div class=""> We start by creating a model, a representation of the persistent data in the application (the images to upload, their names, and the comments). First, you need to create/edit a model file which, for lack of imagination, we call &quot;db.py&quot;. We assume the code below will replace any existing code in &quot;db.py&quot;. Models and controllers must have a ``.py`` extension since they are Python code. If the extension is not provided, it is appended by web2py. Views instead have a ``.html`` extension since they mainly contain HTML code.</div><div class=""> </div><div class=""> Edit the &quot;db.py&quot; file by clicking the corresponding &quot;edit&quot; button:</div><div class=""> </div><div class=""> [[image @///image/en2000.png center 480px]]</div><div class=""> </div><div class=""> and enter the following:</div><div class=""> </div><div class=""> ``IS_EMAIL``:inxx ``IS_NOT_EMPTY``:inxx ``IS_IN_DB``:inxx</div><div class=""> ``</div><div class=""> db = DAL(&quot;sqlite://storage.sqlite&quot;)</div><div class=""> </div><div class=""> db.define_table(&#x27;image&#x27;,</div><div class="">    Field(&#x27;title&#x27;, unique=True),</div><div class="">    Field(&#x27;file&#x27;, &#x27;upload&#x27;),</div><div class="">    format = &#x27;%(title)s&#x27;)</div><div class=""> </div><div class=""> db.define_table(&#x27;comment&#x27;,</div><div class="">    Field(&#x27;image_id&#x27;, &#x27;reference image&#x27;),</div><div class="">    Field(&#x27;author&#x27;),</div><div class="">    Field(&#x27;email&#x27;),</div><div class=""> The &quot;download&quot; action does not return a dictionary, so it does not need a view.</div><div class=""> </div><div class=""> Edit this new file and replace its content with the following:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Image: {{=image.title}}&lt;/h1&gt;</div><div class=""> &lt;center&gt;</div><div class=""> &lt;img width=&quot;200px&quot;</div><div class="">      src=&quot;{{=URL(&#x27;download&#x27;, args=image.file)}}&quot; /&gt;</div><div class=""> &lt;/center&gt;</div><div class=""> {{if len(comments):}}</div><div class="">   &lt;h2&gt;Comments&lt;/h2&gt;&lt;br /&gt;&lt;p&gt;</div><div class="">   {{for comment in comments:}}</div><div class="">     &lt;p&gt;{{=comment.author}} says &lt;i&gt;{{=comment.body}}&lt;/i&gt;&lt;/p&gt;</div><div class="">   {{pass}}&lt;/p&gt;</div><div class=""> {{else:}}</div><div class="">   &lt;h2&gt;No comments posted yet&lt;/h2&gt;</div><div class=""> {{pass}}</div><div class=""> &lt;h2&gt;Post a comment&lt;/h2&gt;</div><div class=""> {{=form}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> This view displays the **image.file** by calling the &quot;download&quot; action inside an ``&lt;img ... /&gt;`` tag.</div><div class=""> If there are comments, it loops over them and displays each one.</div><div class=""> </div><div class=""> Here is how everything will appear to a visitor.</div><div class=""> </div><div class=""> [[image @///image/en2900.png center 480px]]</div><div class=""> </div><div class=""> When a visitor submits a comment via this page, the comment is stored in the database and appended at the bottom of the page.</div><div class=""> </div><div class="insert">#### Adding <span class="highlight">a</span>uthentication</div><div class=""> </div><div class=""> The web2py API for Role-Based Access Control is quite sophisticated, but for now we will limit ourselves to restricting access to the show action to authenticated users, deferring a more detailed discussion to Chapter 9.</div><div class=""> </div><div class=""> To limit access to authenticated users, we need to complete three steps. In a model, for example &quot;db.py&quot;, we need to add:</div><div class=""> ``</div><div class=""> from gluon.tools import Auth</div><div class=""> auth = Auth(db)</div><div class=""> auth.define_tables(username=True)</div><div class=""> ``:code</div><div class=""> </div><div class=""> In our controller, we need to add one action:</div><div class=""> ``</div><div class=""> def user():</div><div class="">     return dict(form=auth())</div><div class=""> ``:code</div><div class=""> </div><div class=""> This is sufficient to enable login, register, logout, etc. pages. The default layout will also show options to the corresponding pages in the top right corner.</div><div class=""> </div><div class=""> [[image @///image/en3000.png center 300px]]</div><div class=""> </div><div class=""> We can now decorate the functions that we want to restrict, for example:</div><div class=""> ``</div><div class=""> @auth.requires_login()</div><div class=""> def show():</div><div class="">     ...</div><div class=""> ``:code</div><div class=""> </div><div class=""> Any attempt to access</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/show/[image_id]</div><div class=""> def manage():</div><div class=""> ``:code</div><div class=""> </div><div class=""> with associated &quot;views/default/manage.html&quot;</div><div class=""> </div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h2&gt;Management Interface&lt;/h2&gt;</div><div class=""> {{=grid}}</div><div class=""> ``</div><div class=""> </div><div class=""> Using appadmin create a group &quot;manager&quot; and make some users members of the group. They will not be able to access</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/manage</div><div class=""> ``</div><div class=""> </div><div class=""> and browse, search:</div><div class=""> </div><div class=""> [[image @///image/en3200.png center 480px]]</div><div class=""> </div><div class=""> create, update and delete images and their comments:</div><div class=""> </div><div class=""> [[image @///image/en3300.png center 480px]]</div><div class=""> </div><div class=""> #### Configuring the layout</div><div class=""> </div><div class=""> You can configure the default layout by editing &quot;views/layout.html&quot; but you can also configure it without editing the HTML. In fact, the &quot;static/base.css&quot; stylesheet is well documented and described in Chapter 5. You can change color, columns, size, borders and background without editing the HTML. If you want to edit the menu, the title or the subtitle, you can do so in any model file. The scaffolding app, sets default values of these parameters in the file &quot;models/menu.py&quot;:</div><div class=""> </div><div class=""> ``</div><div class=""> response.title = request.application</div><div class="insert">response.subtitle = <span class="highlight"></span>&#x27;customize me!&#x27;<span class="highlight"></span></div><div class=""> response.meta.author = &#x27;you&#x27;</div><div class=""> response.meta.description = &#x27;describe your app&#x27;</div><div class=""> response.meta.keywords = &#x27;bla bla bla&#x27;</div><div class=""> response.menu = [ [ &#x27;Index&#x27;, False, URL(&#x27;index&#x27;) ] ]</div><div class=""> ``:code</div></div></div>
    <div class="span6"><div class="diff"><div class=""> #### Say my name</div><div class=""> ``form``:inxx ``request.vars``:inxx</div><div class=""> </div><div class=""> Now create two pages (first and second), where the first page creates a form, asks the visitor&#x27;s name, and redirects to the second page, which greets the visitor by name.</div><div class=""> </div><div class=""> [[yUML diagram @///image/en1400.png center 293px]]</div><div class=""> </div><div class=""> Write the corresponding actions in the default controller:</div><div class=""> ``</div><div class=""> def first():</div><div class="">     return dict()</div><div class=""> </div><div class=""> def second():</div><div class="">     return dict()</div><div class=""> ``:code</div><div class=""> </div><div class=""> Then create a view &quot;default/first.html&quot; for the first action,</div><div class=""> and enter:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class="delete"><span class="highlight"></span>What is your name?<span class="highlight"></span></div><div class=""> &lt;form action=&quot;second&quot;&gt;</div><div class="">   &lt;input name=&quot;visitor_name&quot; /&gt;</div><div class="">   &lt;input type=&quot;submit&quot; /&gt;</div><div class=""> &lt;/form&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> Finally, create a view &quot;default/second.html&quot; for the second action:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Hello {{=request.vars.visitor_name}}&lt;/h1&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> ``layout``:inxx</div><div class=""> In both views we have extended the basic &quot;layout.html&quot; view that comes with web2py. The layout view keeps the look and feel of the two pages coherent. The layout file can be edited and replaced easily, since it mainly contains HTML code.</div><div class=""> </div><div class=""> If you now visit the first page, type your name:</div><div class=""> </div><div class=""> [[image @///image/en1500.png center 480px]]</div><div class=""> </div><div class=""> and submit the form, you will receive a greeting:</div><div class=""> </div><div class=""> [[image @///image/en1600.png center 480px]]</div><div class=""> </div><div class=""> #### Postbacks</div><div class=""> ``redirect``:inxx ``URL``:inxx ``postback``:inxx</div><div class=""> </div><div class=""> The mechanism for form submission that we used before is very common, but it is not good programming practice. All input should be validated and, in the above example, the burden of validation would fall on the second action. Thus the action that performs the validation is different from the action that generated the form. This tends to cause redundancy in the code.</div><div class=""> </div><div class=""> A better pattern for form submission is to submit forms to the same action that generated them, in our example the &quot;first&quot;. The &quot;first&quot; action should receive the variables, process them, store them server-side, and redirect the visitor to the &quot;second&quot; page, which retrieves the variables. This mechanism is called a &#x27;&#x27;postback&#x27;&#x27;.</div><div class=""> </div><div class=""> This approach is better also because the name of the visitor stays in the sessio</div><div class=""> Note that if the &quot;second&quot; action is ever called before a visitor name is set, it will display &quot;Hello anonymous&quot; because  ``session.visitor_name`` returns ``None``. Alternatively we could have added the following code in the controller (inside the ``second`` function):</div><div class=""> </div><div class=""> ``</div><div class=""> if not request.function==&#x27;first&#x27; and not session.visitor_name:</div><div class="">     redirect(URL(&#x27;first&#x27;))</div><div class=""> ``:code</div><div class=""> </div><div class=""> This is a general mechanism that you can use to enforce authorization on controllers, though see Chapter 9 for a more powerful method.</div><div class=""> </div><div class=""> ``FORM``:inxx ``INPUT``:inxx ``requires``:inxx ``IS_NOT_EMPTY``:inxx ``accepts``:inxx</div><div class=""> </div><div class=""> With web2py we can move one step further and ask web2py to generate the form for us, including validation. web2py provides helpers (FORM, INPUT, TEXTAREA, and SELECT/OPTION) with the same names as the equivalent HTML tags. They can be used to build forms either in the controller or in the view.</div><div class=""> </div><div class=""> For example, here is one possible way to rewrite the first action:</div><div class=""> ``</div><div class=""> def first():</div><div class="">     form = FORM(INPUT(_name=&#x27;visitor_name&#x27;, requires=IS_NOT_EMPTY()),</div><div class="">               INPUT(_type=&#x27;submit&#x27;))</div><div class="">     if form.process().accepted:</div><div class="">         session.visitor_name = form.vars.visitor_name</div><div class="">         redirect(URL(&#x27;second&#x27;))</div><div class="">     return dict(form=form)</div><div class=""> ``:code</div><div class=""> </div><div class=""> where we are saying that the FORM tag contains two INPUT tags. The attributes of the input tags are specified by the named arguments starting with underscore. The ``requires`` argument is not a tag attribute (because it does not start by underscore) but it sets a validator for the value of visitor_name.</div><div class=""> </div><div class=""> Here is yet another better way to create the same form:</div><div class=""> </div><div class=""> ``</div><div class=""> def first():</div><div class="delete">-    form = SQLFORM.factory(Field(&#x27;visitor_name&#x27;, requires=IS_NOT_EMPTY()))</div><div class="">     if form.process().accepted:</div><div class="">         session.visitor_name = form.vars.visitor_name</div><div class="">         redirect(URL(&#x27;second&#x27;))</div><div class="">     return dict(form=form)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The ``form`` object can be easily serialized in HTML by embedding it in the &quot;default/first.html&quot; view.</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class="delete">-What is your name?</div><div class=""> {{=form}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> The ``form.process()`` method applies the validators and returns the form itself. The ``form.accepted`` variable is set to True if the form was processed and passed validation. If the self-submitted form passes validation, it stores the variables in the session and redirects as before. If the form does not pass validation, error messages are inserted into the form and shown to the user, as below:</div><div class=""> </div><div class=""> [[image @///image/en1800.png center 480px]]</div><div class=""> </div><div class=""> In the next section we will show how forms can be generated automatically from a model.</div><div class=""> </div><div class=""> In all or examples we have used the session to pass the user name from the first action to the second. We could have used a different mechanism and pass data as part of a redirect URL:</div><div class=""> </div><div class=""> ``</div><div class=""> def first():</div><div class="">     form = SQLFORM.factory(Field(&#x27;visitor_name&#x27;, requires=IS_NOT_EMPTY()))</div><div class="">     if form.process().accepted:</div><div class="">         name = form.vars.visitor_name</div><div class="">         redirect(URL(&#x27;second&#x27;,vars=dict(name=name)))</div><div class="">     return dict(form=form)</div><div class=""> </div><div class=""> def second():</div><div class="">     name = request.vars.visitor_name or redirect(URL(&#x27;first&#x27;))</div><div class="">     return dict(name=name)</div><div class=""> ``:code</div><div class=""> </div><div class=""> ### An image blog</div><div class=""> ``upload``:inxx</div><div class=""> </div><div class=""> Here, as another example, we wish to create a web application that allows the administrator to post images and give them a name, and allows the visitors of the web site to view the named images and submit comments.</div><div class=""> </div><div class=""> As before, from the **site** page in **admin**, create a new application called ``images``, and navigate to the &#x27;&#x27;edit&#x27;&#x27; page:</div><div class=""> </div><div class=""> [[image @///image/en1900.png center 480px]]</div><div class=""> </div><div class=""> We start by creating a model, a representation of the persistent data in the application (the images to upload, their names, and the comments). First, you need to create/edit a model file which, for lack of imagination, we call &quot;db.py&quot;. We assume the code below will replace any existing code in &quot;db.py&quot;. Models and controllers must have a ``.py`` extension since they are Python code. If the extension is not provided, it is appended by web2py. Views instead have a ``.html`` extension since they mainly contain HTML code.</div><div class=""> </div><div class=""> Edit the &quot;db.py&quot; file by clicking the corresponding &quot;edit&quot; button:</div><div class=""> </div><div class=""> [[image @///image/en2000.png center 480px]]</div><div class=""> </div><div class=""> and enter the following:</div><div class=""> </div><div class=""> ``IS_EMAIL``:inxx ``IS_NOT_EMPTY``:inxx ``IS_IN_DB``:inxx</div><div class=""> ``</div><div class=""> db = DAL(&quot;sqlite://storage.sqlite&quot;)</div><div class=""> </div><div class=""> db.define_table(&#x27;image&#x27;,</div><div class="">    Field(&#x27;title&#x27;, unique=True),</div><div class="">    Field(&#x27;file&#x27;, &#x27;upload&#x27;),</div><div class="">    format = &#x27;%(title)s&#x27;)</div><div class=""> </div><div class=""> db.define_table(&#x27;comment&#x27;,</div><div class="">    Field(&#x27;image_id&#x27;, &#x27;reference image&#x27;),</div><div class="">    Field(&#x27;author&#x27;),</div><div class="">    Field(&#x27;email&#x27;),</div><div class=""> The &quot;download&quot; action does not return a dictionary, so it does not need a view.</div><div class=""> </div><div class=""> Edit this new file and replace its content with the following:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Image: {{=image.title}}&lt;/h1&gt;</div><div class=""> &lt;center&gt;</div><div class=""> &lt;img width=&quot;200px&quot;</div><div class="">      src=&quot;{{=URL(&#x27;download&#x27;, args=image.file)}}&quot; /&gt;</div><div class=""> &lt;/center&gt;</div><div class=""> {{if len(comments):}}</div><div class="">   &lt;h2&gt;Comments&lt;/h2&gt;&lt;br /&gt;&lt;p&gt;</div><div class="">   {{for comment in comments:}}</div><div class="">     &lt;p&gt;{{=comment.author}} says &lt;i&gt;{{=comment.body}}&lt;/i&gt;&lt;/p&gt;</div><div class="">   {{pass}}&lt;/p&gt;</div><div class=""> {{else:}}</div><div class="">   &lt;h2&gt;No comments posted yet&lt;/h2&gt;</div><div class=""> {{pass}}</div><div class=""> &lt;h2&gt;Post a comment&lt;/h2&gt;</div><div class=""> {{=form}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> This view displays the **image.file** by calling the &quot;download&quot; action inside an ``&lt;img ... /&gt;`` tag.</div><div class=""> If there are comments, it loops over them and displays each one.</div><div class=""> </div><div class=""> Here is how everything will appear to a visitor.</div><div class=""> </div><div class=""> [[image @///image/en2900.png center 480px]]</div><div class=""> </div><div class=""> When a visitor submits a comment via this page, the comment is stored in the database and appended at the bottom of the page.</div><div class=""> </div><div class="delete">#### Adding <span class="highlight">A</span>uthentication</div><div class=""> </div><div class=""> The web2py API for Role-Based Access Control is quite sophisticated, but for now we will limit ourselves to restricting access to the show action to authenticated users, deferring a more detailed discussion to Chapter 9.</div><div class=""> </div><div class=""> To limit access to authenticated users, we need to complete three steps. In a model, for example &quot;db.py&quot;, we need to add:</div><div class=""> ``</div><div class=""> from gluon.tools import Auth</div><div class=""> auth = Auth(db)</div><div class=""> auth.define_tables(username=True)</div><div class=""> ``:code</div><div class=""> </div><div class=""> In our controller, we need to add one action:</div><div class=""> ``</div><div class=""> def user():</div><div class="">     return dict(form=auth())</div><div class=""> ``:code</div><div class=""> </div><div class=""> This is sufficient to enable login, register, logout, etc. pages. The default layout will also show options to the corresponding pages in the top right corner.</div><div class=""> </div><div class=""> [[image @///image/en3000.png center 300px]]</div><div class=""> </div><div class=""> We can now decorate the functions that we want to restrict, for example:</div><div class=""> ``</div><div class=""> @auth.requires_login()</div><div class=""> def show():</div><div class="">     ...</div><div class=""> ``:code</div><div class=""> </div><div class=""> Any attempt to access</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/show/[image_id]</div><div class=""> def manage():</div><div class=""> ``:code</div><div class=""> </div><div class=""> with associated &quot;views/default/manage.html&quot;</div><div class=""> </div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h2&gt;Management Interface&lt;/h2&gt;</div><div class=""> {{=grid}}</div><div class=""> ``</div><div class=""> </div><div class=""> Using appadmin create a group &quot;manager&quot; and make some users members of the group. They will not be able to access</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/manage</div><div class=""> ``</div><div class=""> </div><div class=""> and browse, search:</div><div class=""> </div><div class=""> [[image @///image/en3200.png center 480px]]</div><div class=""> </div><div class=""> create, update and delete images and their comments:</div><div class=""> </div><div class=""> [[image @///image/en3300.png center 480px]]</div><div class=""> </div><div class=""> #### Configuring the layout</div><div class=""> </div><div class=""> You can configure the default layout by editing &quot;views/layout.html&quot; but you can also configure it without editing the HTML. In fact, the &quot;static/base.css&quot; stylesheet is well documented and described in Chapter 5. You can change color, columns, size, borders and background without editing the HTML. If you want to edit the menu, the title or the subtitle, you can do so in any model file. The scaffolding app, sets default values of these parameters in the file &quot;models/menu.py&quot;:</div><div class=""> </div><div class=""> ``</div><div class=""> response.title = request.application</div><div class="delete">response.subtitle = <span class="highlight">T(</span>&#x27;customize me!&#x27;<span class="highlight">)</span></div><div class=""> response.meta.author = &#x27;you&#x27;</div><div class=""> response.meta.description = &#x27;describe your app&#x27;</div><div class=""> response.meta.keywords = &#x27;bla bla bla&#x27;</div><div class=""> response.menu = [ [ &#x27;Index&#x27;, False, URL(&#x27;index&#x27;) ] ]</div><div class=""> ``:code</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/d23ab29383f8cf32f606974aad31c5f519e2c166">d23ab29</a><ul><li>Date : 2012-12-27</li><li>marmin problem @/</li></ul></li></ul>
<div class="row-fluid" id="com_d23ab29383f8cf32f606974aad31c5f519e2c166">
    <div class="span6"><div class="diff"><div class=""> Supported by oembed:</div><div class="insert">+</div><div class=""> ``                                                                                </div><div class=""> flickr.com                                                                      </div><div class=""> youtube.com                                                                     </div><div class=""> hulu.com                                                                        </div><div class=""> vimeo.com                                                                       </div><div class=""> slideshare.net                                                                  </div><div class=""> qik.com                                                                         </div><div class=""> polleverywhere.com                                                              </div><div class=""> wordpress.com                                                                   </div><div class=""> revision3.com                                                                   </div><div class=""> viddler.com </div><div class=""> ``</div><div class=""> </div><div class=""> This is implemeneted in the web2py file ``gluon.contrib.autolinks`` and specifically in the function ``expand_one``. You can extend oembed support by registering more services. This is done by appending an entry to the ``EMBED_MAPS`` list:</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.contrib.autlinks import EMBED_MAPS</div><div class=""> EMBED_MAPS.append((re.compile(&#x27;http://vimeo.com/\S*&#x27;),</div><div class="">                    &#x27;http://vimeo.com/api/oembed.json&#x27;))</div><div class=""> ``:code</div><div class=""> </div><div class=""> #### Referencing wiki content</div><div class=""> </div><div class=""> If you create a wiki page with slug &quot;contactus&quot; you can refer to this page as</div><div class=""> </div><div class="insert"><span class="highlight">``@+////contactus</span>``:code</div><div class=""> </div><div class="insert">Here ``@<span class="highlight">+</span>////`` stands for</div><div class=""> </div><div class="insert"><span class="highlight">``@+/app/controller/function/</span>``:code</div><div class=""> </div><div class=""> but &quot;app&quot;, &quot;controller&quot;, and &quot;function&quot; are omitted thus assuming default.</div><div class=""> </div><div class=""> Similarly you can use the wiki menu to upload a media file (for example an image) linked to the page. The &quot;manage media&quot; page will show all files you have uploaded and will show the proper expression to link the media file. If, for example you upload a file &quot;test.jpg&quot; with title &quot;beach&quot;, the link expression will somthing like:</div><div class=""> </div><div class="insert"><span class="highlight">``@+////15/beach.jpg</span>``:code</div><div class=""> </div><div class="insert">``@<span class="highlight">+</span>////`` is the same prefix described before. ``15`` is the id of the record storing the media file. ``beach`` is the title. ``.jpg`` is the extension of the original file.</div><div class=""> </div><div class="insert">If you cut and paste ``@<span class="highlight">+</span>////15/beach.jpg`` into wiki pages you embed the image.</div><div class=""> </div><div class=""> Mind that media files are linked to pages and inherit access permission from the pages.</div><div class=""> </div><div class=""> #### Wiki menus</div><div class=""> </div><div class=""> If you create a page with slug &quot;wiki-menu&quot; page it will be interpreted as a description of the menu. Here is an example:</div><div class=""> </div><div class=""> ``</div><div class="insert">+- Home &gt; @+////index</div><div class="insert">+- Info &gt; @+////info</div><div class=""> - web2py &gt; http://google.com</div><div class="insert">+- - About us &gt; @+////aboutus</div><div class="insert">+- - Countact us &gt; @+////contactus</div><div class=""> ``</div></div></div>
    <div class="span6"><div class="diff"><div class=""> Supported by oembed:</div><div class=""> ``                                                                                </div><div class=""> flickr.com                                                                      </div><div class=""> youtube.com                                                                     </div><div class=""> hulu.com                                                                        </div><div class=""> vimeo.com                                                                       </div><div class=""> slideshare.net                                                                  </div><div class=""> qik.com                                                                         </div><div class=""> polleverywhere.com                                                              </div><div class=""> wordpress.com                                                                   </div><div class=""> revision3.com                                                                   </div><div class=""> viddler.com </div><div class=""> ``</div><div class=""> </div><div class=""> This is implemeneted in the web2py file ``gluon.contrib.autolinks`` and specifically in the function ``expand_one``. You can extend oembed support by registering more services. This is done by appending an entry to the ``EMBED_MAPS`` list:</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.contrib.autlinks import EMBED_MAPS</div><div class=""> EMBED_MAPS.append((re.compile(&#x27;http://vimeo.com/\S*&#x27;),</div><div class="">                    &#x27;http://vimeo.com/api/oembed.json&#x27;))</div><div class=""> ``:code</div><div class=""> </div><div class=""> #### Referencing wiki content</div><div class=""> </div><div class=""> If you create a wiki page with slug &quot;contactus&quot; you can refer to this page as</div><div class=""> </div><div class="delete">-``</div><div class="delete">-@////contactus</div><div class="delete"><span class="highlight"></span>``:code</div><div class=""> </div><div class="delete">Here ``@<span class="highlight"></span>////`` stands for</div><div class=""> </div><div class="delete">-``</div><div class="delete">-@/app/controller/function/</div><div class="delete"><span class="highlight"></span>``:code</div><div class=""> </div><div class=""> but &quot;app&quot;, &quot;controller&quot;, and &quot;function&quot; are omitted thus assuming default.</div><div class=""> </div><div class=""> Similarly you can use the wiki menu to upload a media file (for example an image) linked to the page. The &quot;manage media&quot; page will show all files you have uploaded and will show the proper expression to link the media file. If, for example you upload a file &quot;test.jpg&quot; with title &quot;beach&quot;, the link expression will somthing like:</div><div class=""> </div><div class="delete">-``</div><div class="delete">-@////15/beach.jpg</div><div class="delete"><span class="highlight"></span>``:code</div><div class=""> </div><div class="delete">``@<span class="highlight"></span>////`` is the same prefix described before. ``15`` is the id of the record storing the media file. ``beach`` is the title. ``.jpg`` is the extension of the original file.</div><div class=""> </div><div class="delete">If you cut and paste ``@<span class="highlight"></span>////15/beach.jpg`` into wiki pages you embed the image.</div><div class=""> </div><div class=""> Mind that media files are linked to pages and inherit access permission from the pages.</div><div class=""> </div><div class=""> #### Wiki menus</div><div class=""> </div><div class=""> If you create a page with slug &quot;wiki-menu&quot; page it will be interpreted as a description of the menu. Here is an example:</div><div class=""> </div><div class=""> ``</div><div class="delete">-- Home &gt; @////index</div><div class="delete">-- Info &gt; @////info</div><div class=""> - web2py &gt; http://google.com</div><div class="delete">-- - About us &gt; @////aboutus</div><div class="delete">-- - Countact us &gt; @////contactus</div><div class=""> ``</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/76c0363755694c36971ffc9db176312fe5c14276">76c0363</a><ul><li>Date : 2012-12-22</li><li>more and more additions and corrections</li></ul></li></ul>
<div class="row-fluid" id="com_76c0363755694c36971ffc9db176312fe5c14276">
    <div class="span6"><div class="diff"><div class="insert">+In all or examples we have used the session to pass the user name from the first action to the second. We could have used a different mechanism and pass data as part of a redirect URL:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+def first():</div><div class="insert">+    form = SQLFORM.factory(Field(&#x27;visitor_name&#x27;, requires=IS_NOT_EMPTY()))</div><div class="insert">+    if form.process().accepted:</div><div class="insert">+        name = form.vars.visitor_name</div><div class="insert">+        redirect(URL(&#x27;second&#x27;,vars=dict(name=name)))</div><div class="insert">+    return dict(form=form)</div><div class="insert">+</div><div class="insert">+def second():</div><div class="insert">+    name = request.vars.visitor_name or redirect(URL(&#x27;first&#x27;))</div><div class="insert">+    return dict(name=name)</div><div class="insert">+``:code</div><div class="insert">+</div><div class=""> ### An image blog</div><div class=""> ``upload``:inxx</div><div class=""> </div><div class=""> Here, as another example, we wish to create a web application that allows the administrator to post images and give them a name, and allows the visitors of the web site to view the named images and submit comments.</div><div class=""> </div><div class=""> As before, from the **site** page in **admin**, create a new application called ``images``, and navigate to the &#x27;&#x27;edit&#x27;&#x27; page:</div><div class=""> </div><div class=""> [[image @///image/en1900.png center 480px]]</div><div class=""> </div><div class=""> We start by creating a model, a representation of the persistent data in the application (the images to upload, their names, and the comments). First, you need to create/edit a model file which, for lack of imagination, we call &quot;db.py&quot;. We assume the code below will replace any existing code in &quot;db.py&quot;. Models and controllers must have a ``.py`` extension since they are Python code. If the extension is not provided, it is appended by web2py. Views instead have a ``.html`` extension since they mainly contain HTML code.</div><div class=""> </div><div class=""> Edit the &quot;db.py&quot; file by clicking the corresponding &quot;edit&quot; button:</div><div class=""> </div><div class=""> [[image @///image/en2000.png center 480px]]</div><div class=""> </div><div class=""> and enter the following:</div><div class=""> </div><div class=""> ``IS_EMAIL``:inxx ``IS_NOT_EMPTY``:inxx ``IS_IN_DB``:inxx</div><div class=""> ``</div><div class=""> db = DAL(&quot;sqlite://storage.sqlite&quot;)</div><div class=""> </div><div class=""> db.define_table(&#x27;image&#x27;,</div><div class="">    Field(&#x27;title&#x27;, unique=True),</div><div class="">    Field(&#x27;file&#x27;, &#x27;upload&#x27;),</div><div class="">    format = &#x27;%(title)s&#x27;)</div><div class=""> </div><div class=""> db.define_table(&#x27;comment&#x27;,</div><div class="">    Field(&#x27;image_id&#x27;, &#x27;reference image&#x27;),</div><div class="">    Field(&#x27;author&#x27;),</div><div class="">    Field(&#x27;email&#x27;),</div><div class=""> is rendered as:</div><div class=""> ``:code</div><div class=""> </div><div class=""> A handful of helpers (``INPUT``, ``TEXTAREA``, ``OPTION`` and ``SELECT``) also support some special named attributes not starting with underscore (``value``, and ``requires``). They are important for building custom forms and will be discussed later.</div><div class=""> </div><div class=""> Go back to the &#x27;&#x27;edit&#x27;&#x27; page. It now indicates that &quot;default.py exposes index&quot;. By clicking on &quot;index&quot;, you can visit the newly created page:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/index</div><div class=""> ``:code</div><div class=""> </div><div class=""> which looks like:</div><div class=""> </div><div class=""> [[image @///image/en2800.png center 480px]]</div><div class=""> </div><div class=""> If you click on the image name link, you are directed to:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/show/1</div><div class=""> ``:code</div><div class=""> </div><div class=""> and this results in an error, since you have not yet created an action called &quot;show&quot; in controller &quot;default.py&quot;.</div><div class=""> </div><div class=""> Let&#x27;s edit the &quot;default.py&quot; controller and replace its content with:</div><div class=""> </div><div class=""> ``SQLFORM``:inxx ``accepts``:inxx ``response.flash``:inxx ``request.args``:inxx</div><div class=""> ``response.download``:inxx</div><div class=""> ``</div><div class=""> def index():</div><div class="">     images = db().select(db.image.ALL, orderby=db.image.title)</div><div class="">     return dict(images=images)</div><div class=""> </div><div class=""> def show():</div><div class="insert">    image = db<span class="highlight"></span>.image<span class="highlight">(</span>request.args(0,cast=int))<span class="highlight"> or r</span>e<span class="highlight">dir</span>ect(<span class="highlight">URL(&#x27;index&#x27;</span>)<span class="highlight"></span>)</div><div class="">     db.comment.image_id.default = image.id</div><div class="">     form = SQLFORM(db.comment)</div><div class="">     if form.process().accepted:</div><div class="">         response.flash = &#x27;your comment is posted&#x27;</div><div class="">     comments = db(db.comment.image_id==image.id).select()</div><div class="">     return dict(image=image, comments=comments, form=form)</div><div class=""> </div><div class=""> def download():</div><div class="">     return response.download(request, db)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The controller contains two actions: &quot;show&quot; and &quot;download&quot;.</div><div class=""> The &quot;show&quot; action selects the image with the ``id`` parsed from the request args and all comments related to the image. &quot;show&quot; then passes everything to the view &quot;default/show.html&quot;.</div><div class=""> </div><div class=""> The image id referenced by:</div><div class=""> ``</div><div class=""> URL(&#x27;show&#x27;, args=image.id)</div><div class=""> ``:code</div><div class=""> </div><div class=""> in &quot;default/index.html&quot;, can be accessed as:</div><div class=""> </div><div class=""> ``request.args(0,cast=int)``</div><div class=""> </div><div class=""> from the &quot;show&quot; action. The ``cast=int`` argument is optional but very important. It attempts to cast the string value passed in the PATH_INFO into an int. On failure it raise a proper exception instead of causing a ticket. One can also specify a redirect in case of failure to cast:</div><div class=""> </div><div class=""> ``request.args(0,cast=int,otherwise=URL(&#x27;error&#x27;))``</div><div class=""> </div><div class="insert">+Moreover ``db.image(...)`` is a shortcut for </div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+db(db.image.id==...).select().first()</div><div class="insert">+``:code</div><div class="insert">+</div><div class=""> The &quot;download&quot; action expects a filename in ``request.args(0)``, builds a path to the location where that file is supposed to be, and sends it back to the client. If the file is too large, it streams the file without incurring any memory overhead.</div><div class=""> </div><div class=""> Notice the following statements:</div><div class=""> - Line 7 creates an insert form SQLFORM for the ``db.comment`` table using only the specified fields.</div><div class=""> - Line 8 sets the value for the reference field, which is not part of the input form because it is not in the list of fields specified above.</div><div class=""> - Line 9 processes the submitted form (the submitted form variables are in ``request.vars``) within the current session (the session is used to prevent double submissions, and to enforce navigation). If the submitted form variables are validated, the new comment is inserted in the ``db.comment`` table; otherwise the form is modified to include error messages (for example, if the author&#x27;s email address is invalid). This is all done in line 9!.</div><div class=""> - Line 10 is only executed if the form is accepted, after the record is inserted into the database table. ``response.flash`` is a web2py variable that is displayed in the views and used to notify the visitor that something happened.</div><div class=""> - Line 11 selects all comments that reference the current image.</div><div class=""> </div><div class=""> -------</div><div class=""> The &quot;download&quot; action is already defined in the &quot;default.py&quot; controller of the scaffolding application.</div><div class=""> -------</div><div class=""> </div><div class=""> The &quot;download&quot; action does not return a dictionary, so it does not need a view. The &quot;show&quot; action, though, should have a view, so return to **admin** and create a new view called &quot;default/show.html&quot;.</div><div class=""> </div><div class=""> Edit this new file and replace its content with the following:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Image: {{=image.title}}&lt;/h1&gt;</div><div class=""> &lt;center&gt;</div><div class=""> &lt;img width=&quot;200px&quot;</div><div class="">      src=&quot;{{=URL(&#x27;download&#x27;, args=image.file)}}&quot; /&gt;</div><div class=""> &lt;/center&gt;</div><div class=""> {{if len(comments):}}</div><div class="">   &lt;h2&gt;Comments&lt;/h2&gt;&lt;br /&gt;&lt;p&gt;</div><div class="">   {{for comment in comments:}}</div><div class="">     &lt;p&gt;{{=comment.author}} says &lt;i&gt;{{=comment.body}}&lt;/i&gt;&lt;/p&gt;</div><div class="">   {{pass}}&lt;/p&gt;</div><div class=""> {{else:}}</div><div class="">   &lt;h2&gt;No comments posted yet&lt;/h2&gt;</div><div class=""> {{pass}}</div><div class=""> &lt;h2&gt;Post a comment&lt;/h2&gt;</div><div class=""> {{=form}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> This view displays the **image.file** by calling the &quot;download&quot; action inside an ``&lt;img ... /&gt;`` tag.</div><div class=""> If there are comments, it loops over them and displays each one.</div><div class=""> </div><div class=""> Here is how everything will appear to a visitor.</div><div class=""> </div><div class=""> [[image @///image/en2900.png center 480px]]</div><div class=""> </div><div class=""> When a visitor submits a comment via this page, the comment is stored in the database and appended at the bottom of the page.</div><div class=""> </div><div class=""> ### Adding Authentication</div><div class=""> </div><div class=""> The web2py API for Role-Based Access Control is quite sophisticated, but for now we will limit ourselves to restricting access to the show action to authenticated users, deferring a more detailed discussion to Chapter 9.</div><div class=""> </div><div class=""> To limit access to authenticated users, we need to complete three steps. In a model, for example &quot;db.py&quot;, we need to add:</div><div class=""> ``</div><div class=""> from gluon.tools import Auth</div><div class=""> auth = Auth(db)</div><div class="insert">auth.define_tables(<span class="highlight">username=True</span>)</div><div class=""> ``:code</div><div class=""> </div><div class=""> In our controller, we need to add one action:</div><div class=""> ``</div><div class=""> def user():</div><div class="">     return dict(form=auth())</div><div class=""> ``:code</div><div class=""> </div><div class=""> This is sufficient to enable login, register, logout, etc. pages. The default layout will also show options to the corresponding pages in the top right corner.</div><div class=""> </div><div class=""> [[image @///image/en3000.png center 300px]]</div><div class=""> </div><div class=""> We can now decorate the functions that we want to restrict, for example:</div><div class=""> ``</div><div class=""> @auth.requires_login()</div><div class=""> def show():</div><div class="insert">    <span class="highlight">...</span></div><div class=""> ``:code</div><div class=""> </div><div class=""> Any attempt to access</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/show/[image_id]</div><div class=""> ``:code</div><div class=""> </div><div class=""> will require login. If the user is not logged it, the user will be redirected to</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/user/login</div><div class=""> ``:code</div><div class=""> </div><div class=""> [[image @///image/en3100.png center 480px]]</div><div class=""> </div><div class=""> The ``user`` function also exposes, among others, the following actions:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/user/logout</div><div class=""> http://127.0.0.1:8000/images/default/user/register</div><div class=""> http://127.0.0.1:8000/images/default/user/profile</div><div class=""> http://127.0.0.1:8000/images/default/user/change_password</div><div class=""> http://127.0.0.1:8000/images/default/user/request_reset_password</div><div class=""> http://127.0.0.1:8000/images/default/user/retrieve_username</div><div class=""> http://127.0.0.1:8000/images/default/user/retrieve_password</div><div class=""> http://127.0.0.1:8000/images/default/user/verify_email</div><div class=""> http://127.0.0.1:8000/images/default/user/impersonate</div><div class=""> http://127.0.0.1:8000/images/default/user/not_authorized</div><div class=""> ``:code</div><div class=""> </div><div class=""> Now, a first-time user needs to register in order to be able to log in and read or post comments.</div><div class=""> </div><div class=""> -------</div><div class=""> Both the ``auth`` object and the ``user`` function are already defined in the scaffolding application. The ``auth`` object is highly customizable and can deal with email verification, registration approvals, CAPTCHA, and alternate login methods via plugins.</div><div class=""> -------</div><div class=""> </div><div class=""> #### Adding grids</div><div class=""> </div><div class=""> We can improve this further using the ``SQLFORM.grid`` and ``SQLFORM.smartgrid`` gadgets to create a management interface for our application:</div><div class=""> </div><div class=""> ``</div><div class=""> @auth.requires_membership(&#x27;manager&#x27;)</div><div class=""> def manage():</div><div class="insert">    grid = SQLFORM.smartgrid(db.image<span class="highlight">,linked_tables=[&#x27;comment&#x27;]</span>)</div><div class="">     return dict(grid=grid)</div><div class=""> ``:code</div><div class=""> </div><div class=""> with associated &quot;views/default/manage.html&quot;</div><div class=""> </div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h2&gt;Management Interface&lt;/h2&gt;</div><div class=""> {{=grid}}</div><div class=""> ``</div><div class=""> </div><div class=""> Using appadmin create a group &quot;manager&quot; and make some users members of the group. They will not be able to access</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/manage</div><div class=""> ``</div><div class=""> </div><div class=""> and browse, search:</div><div class=""> </div><div class=""> [[image @///image/en3200.png center 480px]]</div><div class=""> </div><div class=""> create, update and delete images and their comments:</div><div class=""> </div><div class=""> [[image @///image/en3300.png center 480px]]</div><div class=""> </div><div class=""> ### Configuring the layout</div><div class=""> </div><div class=""> You can configure the default layout by editing &quot;views/layout.html&quot; but you can also configure it without editing the HTML. In fact, the &quot;static/base.css&quot; stylesheet is well documented and described in Chapter 5. You can change color, columns, size, borders and background without editing the HTML. If you want to edit the menu, the title or the subtitle, you can do so in any model file. The scaffolding app, sets default values of these parameters in the file &quot;models/menu.py&quot;:</div><div class=""> </div><div class=""> ``</div><div class=""> response.title = request.application</div><div class=""> response.subtitle = T(&#x27;customize me!&#x27;)</div><div class=""> response.meta.author = &#x27;you&#x27;</div><div class=""> response.meta.description = &#x27;describe your app&#x27;</div><div class=""> response.meta.keywords = &#x27;bla bla bla&#x27;</div><div class=""> response.menu = [ [ &#x27;Index&#x27;, False, URL(&#x27;index&#x27;) ] ]</div><div class=""> ``:code</div><div class=""> </div><div class=""> ### A wiki</div><div class=""> ``wiki``:inxx ``RSS``:inxx ``Ajax``:inxx ``XMLRPC``:inxx</div><div class="insert">+</div><div class="insert">+In web2py you can create a complete Wiki with tags, tag could, search, media files, and oembed support using only one line of code:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+def index(): return auth.wiki()</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+This function is documented later in this book and can be used to add a wiki to any existing application.</div><div class="insert">+</div><div class="insert">+In this section, we build a wiki from scratch using only low level APIs. The visitor will be able to create pages, search them (by title), and edit them. The visitor will also be able to post comments (exactly as in the previous applications), and also post documents (as attachments to the pages) and link them from the pages. As a convention, we adopt the Markmin syntax for our wiki syntax. We will also implement a search page with Ajax, an RSS feed for the pages, and a handler to search the pages via XML-RPC``xmlrpc``:cite .</div><div class=""> </div><div class=""> The following diagram lists the actions that we need to implement and the links we intend to build among them.</div><div class=""> </div><div class=""> [[yUML diagram @///image/en3400.png center 250px]]</div><div class=""> </div><div class=""> Start by creating a new scaffolding app, naming it &quot;mywiki&quot;.</div><div class=""> </div><div class=""> The model must contain three tables: page, comment, and document. Both comment and document reference page because they belong to page. A document contains a file field of type upload as in the previous images application.</div><div class=""> </div><div class=""> Here is the complete model:</div><div class=""> ``</div><div class=""> db = DAL(&#x27;sqlite://storage.sqlite&#x27;)</div><div class=""> </div><div class=""> from gluon.tools import *</div><div class=""> auth = Auth(db)</div><div class=""> auth.define_tables()</div><div class=""> crud = Crud(db)</div><div class=""> </div><div class=""> db.define_table(&#x27;page&#x27;,</div><div class="">     Field(&#x27;title&#x27;),</div><div class="">     Field(&#x27;body&#x27;, &#x27;text&#x27;),</div><div class="">     Field(&#x27;created_on&#x27;, &#x27;datetime&#x27;, default=request.now),</div><div class="">     Field(&#x27;created_by&#x27;, &#x27;reference auth_user&#x27;, default=auth.user_id),</div><div class="">     format=&#x27;%(title)s&#x27;)</div><div class=""> </div><div class=""> db.define_table(&#x27;comment&#x27;,</div><div class="">     Field(&#x27;page_id&#x27;, &#x27;reference page&#x27;),</div><div class="">     Field(&#x27;body&#x27;, &#x27;text&#x27;),</div><div class="">     Field(&#x27;created_on&#x27;, &#x27;datetime&#x27;, default=request.now),</div><div class="">     Field(&#x27;created_by&#x27;, &#x27;reference auth_user&#x27;, default=auth.user_id))</div><div class=""> db.comment.created_on.readable = db.comment.created_on.writable = False</div><div class=""> db.document.name.requires = IS_NOT_IN_DB(db, &#x27;document.name&#x27;)</div><div class=""> db.document.page_id.readable = db.document.page_id.writable = False</div><div class=""> db.document.created_by.readable = db.document.created_by.writable = False</div><div class=""> db.document.created_on.readable = db.document.created_on.writable = False</div><div class=""> ``:code</div><div class=""> </div><div class=""> Edit the controller &quot;default.py&quot; and create the following actions:</div><div class=""> - index: list all wiki pages</div><div class=""> - create: post another wiki page</div><div class=""> - show: show a wiki page and its comments, and append comments</div><div class=""> - edit: edit an existing page</div><div class=""> - documents: manage the documents attached to a page</div><div class=""> - download: download a document (as in the images example)</div><div class=""> - search: display a search box and, via an Ajax callback, return all matching titles as the visitor types</div><div class=""> - callback: the Ajax callback function. It returns the HTML that gets embedded in the search page while the visitor types.</div><div class=""> </div><div class=""> Here is the &quot;default.py&quot; controller:</div><div class=""> ``</div><div class=""> def index():</div><div class="">      &quot;&quot;&quot; this controller returns a dictionary rendered by the view</div><div class="">          it lists all wiki pages</div><div class="">      &gt;&gt;&gt; index().has_key(&#x27;pages&#x27;)</div><div class="">      True</div><div class="">      &quot;&quot;&quot;</div><div class="">      pages = db().select(db.page.id,db.page.title,orderby=db.page.title)</div><div class="">      return dict(pages=pages)</div><div class=""> </div><div class=""> @auth.requires_login()</div><div class=""> def create():</div><div class="">      &quot;creates a new empty wiki page&quot;</div><div class="insert">     form = <span class="highlight">SQLFORM</span>(db.page<span class="highlight">).process(</span>next=URL(&#x27;index&#x27;))</div><div class="">      return dict(form=form)</div><div class=""> </div><div class=""> def show():</div><div class="">      &quot;shows a wiki page&quot;</div><div class="">      this_page = db.page(request.args(0,cast=int)) or redirect(URL(&#x27;index&#x27;))</div><div class="">      db.comment.page_id.default = this_page.id</div><div class="insert">     form = <span class="highlight">SQLFORM</span>(db.comment<span class="highlight">).process(</span>) if auth.user else None</div><div class="">      pagecomments = db(db.comment.page_id==this_page.id).select()</div><div class="">      return dict(page=this_page, comments=pagecomments, form=form)</div><div class=""> </div><div class=""> @auth.requires_login()</div><div class=""> def edit():</div><div class="">      &quot;edit an existing wiki page&quot;</div><div class="">      this_page = db.page(request.args(0,cast=int)) or redirect(URL(&#x27;index&#x27;))</div><div class="insert">+     form = SQLFORM(db.page, this_page).process(</div><div class="insert">+         next = URL(&#x27;show&#x27;,args=request.args)) </div><div class="">      return dict(form=form)</div><div class=""> </div><div class=""> @auth.requires_login()</div><div class=""> def documents():</div><div class="">      &quot;browser, edit all documents attached to a certain page&quot;</div><div class="">      page = db.page(request.args(0,cast=int)) or redirect(URL(&#x27;index&#x27;))</div><div class="">      db.document.page_id.default = page.id</div><div class="">      db.document.page_id.writable = False</div><div class="">      grid = SQLFORM.grid(db.document.page_id==page.id,args=[page.id])</div><div class="">      return dict(page=page, grid=grid)</div><div class=""> </div><div class=""> def user():</div><div class="">      return dict(form=auth())</div><div class=""> </div><div class=""> def download():</div><div class="">      &quot;allows downloading of documents&quot;</div><div class="">      return response.download(request, db)</div><div class=""> </div><div class=""> def search():</div><div class="">      &quot;an ajax wiki search page&quot;</div><div class="">      return dict(form=FORM(INPUT(_id=&#x27;keyword&#x27;,_name=&#x27;keyword&#x27;,</div><div class="">               _onkeyup=&quot;ajax(&#x27;callback&#x27;, [&#x27;keyword&#x27;], &#x27;target&#x27;);&quot;)),</div><div class="">               target_div=DIV(_id=&#x27;target&#x27;))</div><div class=""> </div><div class=""> def callback():</div><div class="">      &quot;an ajax callback that returns a &lt;ul&gt; of links to wiki pages&quot;</div><div class="">      query = db.page.title.contains(request.vars.keyword)</div><div class="">      pages = db(query).select(orderby=db.page.title)</div><div class="">      links = [A(p.title, _href=URL(&#x27;show&#x27;,args=p.id)) for p in pages]</div><div class="">      return UL(*links)</div><div class=""> The handler can be accessed from many other programming languages that understan</div><div class=""> There are three different representation for each of the field types ``date``, ``datetime`` and ``time``:</div><div class=""> - the database representation</div><div class=""> - the internal web2py prepresentation</div><div class=""> - the string representation in forms and tables</div><div class=""> </div><div class=""> The database representation is an internal issue and does not affect the code. Internally, at the web2py level, they are stored as ``datetime.date``, ``datetime.datetime`` and ``datetime.time`` object respectively and they can be manipulated as such:</div><div class=""> </div><div class=""> ``</div><div class=""> for page in db(db.page).select():</div><div class="">     print page.title, page.day, page.month, page.year</div><div class=""> ``</div><div class=""> </div><div class=""> When dates are converted to strings in forms they are converted using the ISO representation </div><div class=""> ``</div><div class=""> %Y-%m-%d %H:%M:%S</div><div class=""> ``</div><div class=""> </div><div class=""> yet this representation in internationalized and you can use the admin stranslation page to change the format to an alternate one. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> %m/%b/%Y %H:%M:%S</div><div class=""> ``</div><div class=""> </div><div class=""> ------</div><div class=""> Mind that by default English is not translated because web2py assumes the applications is already written in English. If you want internationalization to work for English you need to create the translation file (using admin) and you need declare that the application current language is something other than english, for example:</div><div class=""> ``</div><div class=""> T.current_languages = [&#x27;null&#x27;]</div><div class=""> ``</div><div class=""> ------</div><div class=""> </div><div class=""> ### More on **admin**</div><div class=""> ``admin``:inxx</div><div class=""> </div><div class=""> The administrative interface provides additional functionality that we briefly review here.</div><div class=""> </div><div class=""> #### &#x27;&#x27;site&#x27;&#x27;</div><div class=""> ``site``:inxx</div><div class=""> </div><div class=""> This page lists all installed applications. There are two forms at the bottom.</div><div class=""> </div><div class=""> The first of them allows creating a new application by specifying its name.</div><div class=""> </div><div class="insert">+``Instant Press``:inxx ``Movuca``:inxx</div><div class="insert">+The second form allows uploading an existing application from either a local file or a remote URL. When you upload an application, you need to specify a name for it. This can be its original name, but does not need to be. This allows installing multiple copies of the same application. You can try, for example, to upload the Movuca Social Networking application app created by Bruno Rocha:</div><div class=""> </div><div class=""> ``</div><div class=""> http://code.google.com/p/instant-press/</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+or Instant Press CMS created by Martin Mulone:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+http://code.google.com/p/instant-press/</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+or one of the many example applications available at:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+http://web2py.com/appliances</div><div class="insert">+``</div><div class=""> </div><div class=""> ------</div><div class=""> Web2py files are packages as ``.w2p`` files. These ones are tar gzipped files. Web2py uses the ``.w2p`` extension instead of the ``.tgz`` extension to prevent the browser from unzipping on download. They can be uncompressed manually with ``tar zxvf [filename]`` although this is never necessary.</div><div class=""> ------</div><div class=""> </div><div class=""> [[image @///image/en4100.png center 444px]]</div><div class=""> </div><div class=""> Upon successful upload, web2py displays the MD5 checksum of the uploaded file. You can use it to verify that the file was not corrupted during upload. The InstantPress name will appear in the list of installed applications.</div><div class=""> </div><div class="insert"><span class="highlight">Cl</span>i<span class="highlight">ck on the application na</span>m<span class="highlight">e on </span>a<span class="highlight">dmin to </span>ge<span class="highlight">t</span> <span class="highlight"></span>i<span class="highlight">t up </span>a<span class="highlight"></span>n<span class="highlight">d runni</span>ng<span class="highlight">.</span></div><div class=""> </div><div class="insert"><span class="highlight">If you run web2py from source and you have ``pyhton-git`` installed, you can install applications directly from git reporsitory using the ``.git`` URL in the upload form. In this case you will also be used to user the admin interface to push changes back into the repository.</span></div><div class=""> </div><div class=""> For each application the &#x27;&#x27;site&#x27;&#x27; page allows you to:</div><div class=""> - Uninstall the application.</div><div class=""> - Jump to the &#x27;&#x27;about&#x27;&#x27; page (read below).</div><div class=""> - Jump to the &#x27;&#x27;edit&#x27;&#x27; page (read below).</div><div class=""> - Jump to the &#x27;&#x27;errors&#x27;&#x27; page (read below).</div><div class=""> - Clean up temporary files (sessions, errors, and cache.disk files).</div><div class=""> - Pack all. This returns a tar file containing a complete copy of the application. We suggest that you clean up temporary files before packing an application.</div><div class=""> - Compile the application. If there are no errors, this option will bytecode-compile all models, controllers and views. Because views can extend and include other views in a tree, before bytecode compilation, the view tree for every controller is collapsed into a single file. The net effect is that a bytecode-compiled application is faster, because there is no more parsing of templates or string substitutions occurring at runtime.</div><div class=""> - Pack compiled. This option is only present for bytecode-compiled applications. It allows packing the application without source code for distribution as closed source. Note that Python (as any other programming language) can technically be decompiled; therefore compilation does not provide complete protection of the source code. Nevertheless, decompilation can be difficult and can be illegal.</div><div class=""> - Remove compiled. It simply removes the byte-code compiled models, views and controllers from the application. If the application was packaged with source code or edited locally, there is no harm in removing the bytecode-compiled files, and the application will continue to work. If the application was installed form a packed compiled file, then this is not safe, because there is no source code to revert to, and the application will no longer work.</div><div class=""> </div><div class=""> ``admin.py``:inxx</div><div class=""> </div><div class=""> -------</div><div class=""> All the functionality available from the web2py admin site page is also accessible programmatically via the API defined in the module ``gluon/admin.py``. Simply open a python shell and import this module.</div><div class=""> -------</div><div class=""> </div><div class="insert">+If the Google App Engine SDK is installer the admin &#x27;&#x27;site&#x27;&#x27; page shows a button to push your applications to GAE. If ``python-git`` is installed, there is also a button to push your application to Open Shift. To install applications on ``heroku`` or other hosting system you should look into the &quot;scripts&quot; folder for the appropriate script.</div><div class="insert">+</div><div class=""> #### &#x27;&#x27;about&#x27;&#x27;</div><div class=""> ``about``:inxx ``license``:inxx</div><div class=""> </div><div class=""> The &#x27;&#x27;about&#x27;&#x27; tab allows editing the description of the application and its license. These are written respectively in the ABOUT and LICENSE files in the application folder.</div><div class=""> </div><div class=""> [[image @///image/en4300.png center 480px]]</div><div class=""> </div><div class=""> You can use ``MARKMIN``, or ``gluon.contrib.markdown.WIKI`` syntax for these files as described in ref.``markdown2``:cite .</div><div class=""> </div><div class=""> #### &#x27;&#x27;edit&#x27;&#x27;</div><div class=""> ``EDIT``:inxx</div><div class=""> You have used the &#x27;&#x27;edit&#x27;&#x27; page already in this chapter. Here we want to point out a few more functionalities of the &#x27;&#x27;edit&#x27;&#x27; page.</div><div class=""> - If you click on any file name, you can see the contents of the file with syntax highlighting.</div><div class=""> - If you click on edit, you can edit the file via a web interface.</div><div class=""> - If you click on delete, you can delete the file (permanently).</div><div class=""> - If you click on test, web2py will run tests. Tests are written by the developer using Python doctests, and each function should have its own tests.</div><div class=""> - You can add language files, scan the app to discover all strings, and edit string translations via the web interface.</div><div class=""> - If the static files are organized in folders and subfolders, the folder hierarchy can be toggled by clicking on a folder name.</div><div class=""> </div><div class=""> The image below shows the output of the test page for the welcome application.</div><div class=""> </div><div class=""> [[image @///image/en4400.png center 480px]]</div><div class=""> </div><div class=""> The image below show the languages tab for the welcome application.</div><div class=""> </div><div class=""> [[image @///image/en4500.png center 480px]]</div><div class=""> </div><div class=""> The image below shows how to edit a language file, in this case the &quot;it&quot; (Italian) language for the welcome application.</div><div class=""> </div><div class=""> [[image @///image/en4600.png center 480px]]</div><div class=""> Normally there is no need to perform any configuration of admin but a few custom</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/admin/default/edit/admin/models/0.py</div><div class=""> ``</div><div class=""> Notice that **admin** can be used to edit itself. In fact **admin** is an app as any other one.</div><div class=""> </div><div class=""> The file &quot;0.py&quot; is very much self documented and if you are opening probably you already know what you are looking for. Anyway few customizations exist that are more important than others:</div><div class=""> </div><div class=""> ``</div><div class=""> GAE_APPCFG = os.path.abspath(os.path.join(&#x27;/usr/local/bin/appcfg.py&#x27;))</div><div class=""> ``</div><div class=""> This should point to the location of the &quot;appcfg.py&quot; file that comes with the Google App Engine SDK. If you have the SDK you may want to change this config parameters to the correct value. It will allow you to deploy to GAE from the admin interface.</div><div class=""> </div><div class=""> ``DEMO_MODE``:inxx</div><div class=""> </div><div class=""> You can also set web2py admin in demo mode:</div><div class=""> ``</div><div class=""> DEMO_MODE = True</div><div class=""> FILTER_APPS = [&#x27;welcome&#x27;]</div><div class=""> ``</div><div class=""> And only the apps listed in filter apps will be accessible and they will be only accessible in read-only mode.</div><div class=""> </div><div class=""> ``MULTI_USER_MODE``:inxx</div><div class=""> ``virtual laboratory``:inxx</div><div class=""> </div><div class=""> If you are a teacher and want to expose the administrative interface to students so that students can share one administrative interface for their projects (think of a virtual lab), can do it by setting:</div><div class=""> ``</div><div class=""> MULTI_USER_MODE = True</div><div class=""> ``</div><div class=""> In this way students will be required to login and will only be able to access their own apps via admin. You, as first user/teacher, will be able to access them all.</div><div class=""> </div><div class="insert">+In multi user mode, you can register students using the &quot;bulk register&quot; link in admin and manage them using the &quot;manage students&quot; link. The system also keep track of when students login and how many lines of code add/remove to/from their code. This data is presented to the administrator as charts under the application &quot;about&quot; page.</div><div class="insert">+</div><div class="insert">+Mind that this mechanism still assumes all users are trusted. All the apps created under admin run under the same credentials on the same filesystem. It is possible for an app created by a student to access the data and the source of an app created by another student. It is also possible for a student to create an app that locks the server.</div><div class="insert">+</div><div class="insert">+#### Mobile **admin**</div><div class="insert">+</div><div class="insert">+Notice that the admin application includes &quot;plugin_jqmodile&quot; which packages jQuery Mobile. When admin is accessed from a mobile devide, this is detected by web2py and the interface is displayed using a mobile friendly layout.</div></div></div>
    <div class="span6"><div class="diff"><div class=""> ### An image blog</div><div class=""> ``upload``:inxx</div><div class=""> </div><div class=""> Here, as another example, we wish to create a web application that allows the administrator to post images and give them a name, and allows the visitors of the web site to view the named images and submit comments.</div><div class=""> </div><div class=""> As before, from the **site** page in **admin**, create a new application called ``images``, and navigate to the &#x27;&#x27;edit&#x27;&#x27; page:</div><div class=""> </div><div class=""> [[image @///image/en1900.png center 480px]]</div><div class=""> </div><div class=""> We start by creating a model, a representation of the persistent data in the application (the images to upload, their names, and the comments). First, you need to create/edit a model file which, for lack of imagination, we call &quot;db.py&quot;. We assume the code below will replace any existing code in &quot;db.py&quot;. Models and controllers must have a ``.py`` extension since they are Python code. If the extension is not provided, it is appended by web2py. Views instead have a ``.html`` extension since they mainly contain HTML code.</div><div class=""> </div><div class=""> Edit the &quot;db.py&quot; file by clicking the corresponding &quot;edit&quot; button:</div><div class=""> </div><div class=""> [[image @///image/en2000.png center 480px]]</div><div class=""> </div><div class=""> and enter the following:</div><div class=""> </div><div class=""> ``IS_EMAIL``:inxx ``IS_NOT_EMPTY``:inxx ``IS_IN_DB``:inxx</div><div class=""> ``</div><div class=""> db = DAL(&quot;sqlite://storage.sqlite&quot;)</div><div class=""> </div><div class=""> db.define_table(&#x27;image&#x27;,</div><div class="">    Field(&#x27;title&#x27;, unique=True),</div><div class="">    Field(&#x27;file&#x27;, &#x27;upload&#x27;),</div><div class="">    format = &#x27;%(title)s&#x27;)</div><div class=""> </div><div class=""> db.define_table(&#x27;comment&#x27;,</div><div class="">    Field(&#x27;image_id&#x27;, &#x27;reference image&#x27;),</div><div class="">    Field(&#x27;author&#x27;),</div><div class="">    Field(&#x27;email&#x27;),</div><div class=""> is rendered as:</div><div class=""> ``:code</div><div class=""> </div><div class=""> A handful of helpers (``INPUT``, ``TEXTAREA``, ``OPTION`` and ``SELECT``) also support some special named attributes not starting with underscore (``value``, and ``requires``). They are important for building custom forms and will be discussed later.</div><div class=""> </div><div class=""> Go back to the &#x27;&#x27;edit&#x27;&#x27; page. It now indicates that &quot;default.py exposes index&quot;. By clicking on &quot;index&quot;, you can visit the newly created page:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/index</div><div class=""> ``:code</div><div class=""> </div><div class=""> which looks like:</div><div class=""> </div><div class=""> [[image @///image/en2800.png center 480px]]</div><div class=""> </div><div class=""> If you click on the image name link, you are directed to:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/show/1</div><div class=""> ``:code</div><div class=""> </div><div class=""> and this results in an error, since you have not yet created an action called &quot;show&quot; in controller &quot;default.py&quot;.</div><div class=""> </div><div class=""> Let&#x27;s edit the &quot;default.py&quot; controller and replace its content with:</div><div class=""> </div><div class=""> ``SQLFORM``:inxx ``accepts``:inxx ``response.flash``:inxx ``request.args``:inxx</div><div class=""> ``response.download``:inxx</div><div class=""> ``</div><div class=""> def index():</div><div class="">     images = db().select(db.image.ALL, orderby=db.image.title)</div><div class="">     return dict(images=images)</div><div class=""> </div><div class=""> def show():</div><div class="delete">    image = db<span class="highlight">(db</span>.image<span class="highlight">.id==</span>request.args(0,cast=int))<span class="highlight">.s</span>e<span class="highlight">l</span>ect(<span class="highlight"></span>)<span class="highlight">.first(</span>)</div><div class="">     db.comment.image_id.default = image.id</div><div class="">     form = SQLFORM(db.comment)</div><div class="">     if form.process().accepted:</div><div class="">         response.flash = &#x27;your comment is posted&#x27;</div><div class="">     comments = db(db.comment.image_id==image.id).select()</div><div class="">     return dict(image=image, comments=comments, form=form)</div><div class=""> </div><div class=""> def download():</div><div class="">     return response.download(request, db)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The controller contains two actions: &quot;show&quot; and &quot;download&quot;.</div><div class=""> The &quot;show&quot; action selects the image with the ``id`` parsed from the request args and all comments related to the image. &quot;show&quot; then passes everything to the view &quot;default/show.html&quot;.</div><div class=""> </div><div class=""> The image id referenced by:</div><div class=""> ``</div><div class=""> URL(&#x27;show&#x27;, args=image.id)</div><div class=""> ``:code</div><div class=""> </div><div class=""> in &quot;default/index.html&quot;, can be accessed as:</div><div class=""> </div><div class=""> ``request.args(0,cast=int)``</div><div class=""> </div><div class=""> from the &quot;show&quot; action. The ``cast=int`` argument is optional but very important. It attempts to cast the string value passed in the PATH_INFO into an int. On failure it raise a proper exception instead of causing a ticket. One can also specify a redirect in case of failure to cast:</div><div class=""> </div><div class=""> ``request.args(0,cast=int,otherwise=URL(&#x27;error&#x27;))``</div><div class=""> </div><div class=""> The &quot;download&quot; action expects a filename in ``request.args(0)``, builds a path to the location where that file is supposed to be, and sends it back to the client. If the file is too large, it streams the file without incurring any memory overhead.</div><div class=""> </div><div class=""> Notice the following statements:</div><div class=""> - Line 7 creates an insert form SQLFORM for the ``db.comment`` table using only the specified fields.</div><div class=""> - Line 8 sets the value for the reference field, which is not part of the input form because it is not in the list of fields specified above.</div><div class=""> - Line 9 processes the submitted form (the submitted form variables are in ``request.vars``) within the current session (the session is used to prevent double submissions, and to enforce navigation). If the submitted form variables are validated, the new comment is inserted in the ``db.comment`` table; otherwise the form is modified to include error messages (for example, if the author&#x27;s email address is invalid). This is all done in line 9!.</div><div class=""> - Line 10 is only executed if the form is accepted, after the record is inserted into the database table. ``response.flash`` is a web2py variable that is displayed in the views and used to notify the visitor that something happened.</div><div class=""> - Line 11 selects all comments that reference the current image.</div><div class=""> </div><div class=""> -------</div><div class=""> The &quot;download&quot; action is already defined in the &quot;default.py&quot; controller of the scaffolding application.</div><div class=""> -------</div><div class=""> </div><div class=""> The &quot;download&quot; action does not return a dictionary, so it does not need a view. The &quot;show&quot; action, though, should have a view, so return to **admin** and create a new view called &quot;default/show.html&quot;.</div><div class=""> </div><div class=""> Edit this new file and replace its content with the following:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Image: {{=image.title}}&lt;/h1&gt;</div><div class=""> &lt;center&gt;</div><div class=""> &lt;img width=&quot;200px&quot;</div><div class="">      src=&quot;{{=URL(&#x27;download&#x27;, args=image.file)}}&quot; /&gt;</div><div class=""> &lt;/center&gt;</div><div class=""> {{if len(comments):}}</div><div class="">   &lt;h2&gt;Comments&lt;/h2&gt;&lt;br /&gt;&lt;p&gt;</div><div class="">   {{for comment in comments:}}</div><div class="">     &lt;p&gt;{{=comment.author}} says &lt;i&gt;{{=comment.body}}&lt;/i&gt;&lt;/p&gt;</div><div class="">   {{pass}}&lt;/p&gt;</div><div class=""> {{else:}}</div><div class="">   &lt;h2&gt;No comments posted yet&lt;/h2&gt;</div><div class=""> {{pass}}</div><div class=""> &lt;h2&gt;Post a comment&lt;/h2&gt;</div><div class=""> {{=form}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> This view displays the **image.file** by calling the &quot;download&quot; action inside an ``&lt;img ... /&gt;`` tag.</div><div class=""> If there are comments, it loops over them and displays each one.</div><div class=""> </div><div class=""> Here is how everything will appear to a visitor.</div><div class=""> </div><div class=""> [[image @///image/en2900.png center 480px]]</div><div class=""> </div><div class=""> When a visitor submits a comment via this page, the comment is stored in the database and appended at the bottom of the page.</div><div class=""> </div><div class="delete">-### Adding CRUD</div><div class="delete">-</div><div class="delete">-web2py also provides a CRUD (Create/Read/Update/Delete) API that simplifies forms even more. To use CRUD it is necessary to define it somewhere, such as in file &quot;db.py&quot;:</div><div class="delete">-``</div><div class="delete">-from gluon.tools import Crud</div><div class="delete">-crud = Crud(db)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-These two lines are already in the scaffolding application.</div><div class="delete">-</div><div class="delete">-The ``crud`` object provides high-level methods, for example:</div><div class="delete">-``</div><div class="delete">-form = crud.create(table)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-that can be used to replace the programming pattern:</div><div class="delete">-``</div><div class="delete">-form = SQLFORM(table)</div><div class="delete">-if form.process().accepted:</div><div class="delete">-    session.flash = &#x27;...&#x27;</div><div class="delete">-    redirect(&#x27;...&#x27;)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Here, we rewrite the previous &quot;show&quot; action using crud and making some more improvements:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-def show():</div><div class="delete">-    image = db.image(request.args(0,cast=int)) or redirect(URL(&#x27;index&#x27;))</div><div class="delete">-    db.comment.image_id.default = image.id</div><div class="delete">-    form = crud.create(db.comment,</div><div class="delete">-                       message=&#x27;your comment is posted&#x27;,</div><div class="delete">-		       next=URL(args=image.id))</div><div class="delete">-    comments = db(db.comment.image_id==image.id).select()</div><div class="delete">-    return dict(image=image, comments=comments, form=form)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-First of all notice we have used the syntax</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-db.image(request.args(0,cast=int)) or redirect(...)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-to fetch the required record. Since ```table(id)`` returns None if the record is not found, we can use ``or redirect(...)`` in this case in one line.</div><div class="delete">-</div><div class="delete">-The ``next`` argument of ``crud.create`` is the URL to redirect to after the form is accepted. The ``message`` argument is the one to be displayed upon acceptance. You can read more about CRUD in Chapter 7.</div><div class="delete">-</div><div class=""> ### Adding Authentication</div><div class=""> </div><div class=""> The web2py API for Role-Based Access Control is quite sophisticated, but for now we will limit ourselves to restricting access to the show action to authenticated users, deferring a more detailed discussion to Chapter 9.</div><div class=""> </div><div class=""> To limit access to authenticated users, we need to complete three steps. In a model, for example &quot;db.py&quot;, we need to add:</div><div class=""> ``</div><div class=""> from gluon.tools import Auth</div><div class=""> auth = Auth(db)</div><div class="delete">auth.define_tables(<span class="highlight"></span>)</div><div class=""> ``:code</div><div class=""> </div><div class=""> In our controller, we need to add one action:</div><div class=""> ``</div><div class=""> def user():</div><div class="">     return dict(form=auth())</div><div class=""> ``:code</div><div class=""> </div><div class=""> This is sufficient to enable login, register, logout, etc. pages. The default layout will also show options to the corresponding pages in the top right corner.</div><div class=""> </div><div class=""> [[image @///image/en3000.png center 300px]]</div><div class=""> </div><div class=""> We can now decorate the functions that we want to restrict, for example:</div><div class=""> ``</div><div class=""> @auth.requires_login()</div><div class=""> def show():</div><div class="delete">-    image = db.image(request.args(0,cast=int)) or redirect(URL(&#x27;index&#x27;))</div><div class="delete">-    db.comment.image_id.default = image.id</div><div class="delete">-    form = crud.create(db.comment, next=URL(args=image.id),</div><div class="delete">-                     message=&#x27;your comment is posted&#x27;)</div><div class="delete">-    comments = db(db.comment.image_id==image.id).select()</div><div class="delete">    <span class="highlight">return dict(image=image, comments=comments, form=form)</span></div><div class=""> ``:code</div><div class=""> </div><div class=""> Any attempt to access</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/show/[image_id]</div><div class=""> ``:code</div><div class=""> </div><div class=""> will require login. If the user is not logged it, the user will be redirected to</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/user/login</div><div class=""> ``:code</div><div class=""> </div><div class=""> [[image @///image/en3100.png center 480px]]</div><div class=""> </div><div class=""> The ``user`` function also exposes, among others, the following actions:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/user/logout</div><div class=""> http://127.0.0.1:8000/images/default/user/register</div><div class=""> http://127.0.0.1:8000/images/default/user/profile</div><div class=""> http://127.0.0.1:8000/images/default/user/change_password</div><div class=""> http://127.0.0.1:8000/images/default/user/request_reset_password</div><div class=""> http://127.0.0.1:8000/images/default/user/retrieve_username</div><div class=""> http://127.0.0.1:8000/images/default/user/retrieve_password</div><div class=""> http://127.0.0.1:8000/images/default/user/verify_email</div><div class=""> http://127.0.0.1:8000/images/default/user/impersonate</div><div class=""> http://127.0.0.1:8000/images/default/user/not_authorized</div><div class=""> ``:code</div><div class=""> </div><div class=""> Now, a first-time user needs to register in order to be able to log in and read or post comments.</div><div class=""> </div><div class=""> -------</div><div class=""> Both the ``auth`` object and the ``user`` function are already defined in the scaffolding application. The ``auth`` object is highly customizable and can deal with email verification, registration approvals, CAPTCHA, and alternate login methods via plugins.</div><div class=""> -------</div><div class=""> </div><div class=""> #### Adding grids</div><div class=""> </div><div class=""> We can improve this further using the ``SQLFORM.grid`` and ``SQLFORM.smartgrid`` gadgets to create a management interface for our application:</div><div class=""> </div><div class=""> ``</div><div class=""> @auth.requires_membership(&#x27;manager&#x27;)</div><div class=""> def manage():</div><div class="delete">    grid = SQLFORM.smartgrid(db.image<span class="highlight"></span>)</div><div class="">     return dict(grid=grid)</div><div class=""> ``:code</div><div class=""> </div><div class=""> with associated &quot;views/default/manage.html&quot;</div><div class=""> </div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h2&gt;Management Interface&lt;/h2&gt;</div><div class=""> {{=grid}}</div><div class=""> ``</div><div class=""> </div><div class=""> Using appadmin create a group &quot;manager&quot; and make some users members of the group. They will not be able to access</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/manage</div><div class=""> ``</div><div class=""> </div><div class=""> and browse, search:</div><div class=""> </div><div class=""> [[image @///image/en3200.png center 480px]]</div><div class=""> </div><div class=""> create, update and delete images and their comments:</div><div class=""> </div><div class=""> [[image @///image/en3300.png center 480px]]</div><div class=""> </div><div class=""> ### Configuring the layout</div><div class=""> </div><div class=""> You can configure the default layout by editing &quot;views/layout.html&quot; but you can also configure it without editing the HTML. In fact, the &quot;static/base.css&quot; stylesheet is well documented and described in Chapter 5. You can change color, columns, size, borders and background without editing the HTML. If you want to edit the menu, the title or the subtitle, you can do so in any model file. The scaffolding app, sets default values of these parameters in the file &quot;models/menu.py&quot;:</div><div class=""> </div><div class=""> ``</div><div class=""> response.title = request.application</div><div class=""> response.subtitle = T(&#x27;customize me!&#x27;)</div><div class=""> response.meta.author = &#x27;you&#x27;</div><div class=""> response.meta.description = &#x27;describe your app&#x27;</div><div class=""> response.meta.keywords = &#x27;bla bla bla&#x27;</div><div class=""> response.menu = [ [ &#x27;Index&#x27;, False, URL(&#x27;index&#x27;) ] ]</div><div class=""> ``:code</div><div class=""> </div><div class=""> ### A wiki</div><div class=""> ``wiki``:inxx ``RSS``:inxx ``Ajax``:inxx ``XMLRPC``:inxx</div><div class="delete">-In this section, we build a wiki, from scratch and without using the extended functionality provided by plugin_wiki which is described in chapter 12. The visitor will be able to create pages, search them (by title), and edit them. The visitor will also be able to post comments (exactly as in the previous applications), and also post documents (as attachments to the pages) and link them from the pages. As a convention, we adopt the Markmin syntax for our wiki syntax. We will also implement a search page with Ajax, an RSS feed for the pages, and a handler to search the pages via XML-RPC``xmlrpc``:cite .</div><div class=""> </div><div class=""> The following diagram lists the actions that we need to implement and the links we intend to build among them.</div><div class=""> </div><div class=""> [[yUML diagram @///image/en3400.png center 250px]]</div><div class=""> </div><div class=""> Start by creating a new scaffolding app, naming it &quot;mywiki&quot;.</div><div class=""> </div><div class=""> The model must contain three tables: page, comment, and document. Both comment and document reference page because they belong to page. A document contains a file field of type upload as in the previous images application.</div><div class=""> </div><div class=""> Here is the complete model:</div><div class=""> ``</div><div class=""> db = DAL(&#x27;sqlite://storage.sqlite&#x27;)</div><div class=""> </div><div class=""> from gluon.tools import *</div><div class=""> auth = Auth(db)</div><div class=""> auth.define_tables()</div><div class=""> crud = Crud(db)</div><div class=""> </div><div class=""> db.define_table(&#x27;page&#x27;,</div><div class="">     Field(&#x27;title&#x27;),</div><div class="">     Field(&#x27;body&#x27;, &#x27;text&#x27;),</div><div class="">     Field(&#x27;created_on&#x27;, &#x27;datetime&#x27;, default=request.now),</div><div class="">     Field(&#x27;created_by&#x27;, &#x27;reference auth_user&#x27;, default=auth.user_id),</div><div class="">     format=&#x27;%(title)s&#x27;)</div><div class=""> </div><div class=""> db.define_table(&#x27;comment&#x27;,</div><div class="">     Field(&#x27;page_id&#x27;, &#x27;reference page&#x27;),</div><div class="">     Field(&#x27;body&#x27;, &#x27;text&#x27;),</div><div class="">     Field(&#x27;created_on&#x27;, &#x27;datetime&#x27;, default=request.now),</div><div class="">     Field(&#x27;created_by&#x27;, &#x27;reference auth_user&#x27;, default=auth.user_id))</div><div class=""> db.comment.created_on.readable = db.comment.created_on.writable = False</div><div class=""> db.document.name.requires = IS_NOT_IN_DB(db, &#x27;document.name&#x27;)</div><div class=""> db.document.page_id.readable = db.document.page_id.writable = False</div><div class=""> db.document.created_by.readable = db.document.created_by.writable = False</div><div class=""> db.document.created_on.readable = db.document.created_on.writable = False</div><div class=""> ``:code</div><div class=""> </div><div class=""> Edit the controller &quot;default.py&quot; and create the following actions:</div><div class=""> - index: list all wiki pages</div><div class=""> - create: post another wiki page</div><div class=""> - show: show a wiki page and its comments, and append comments</div><div class=""> - edit: edit an existing page</div><div class=""> - documents: manage the documents attached to a page</div><div class=""> - download: download a document (as in the images example)</div><div class=""> - search: display a search box and, via an Ajax callback, return all matching titles as the visitor types</div><div class=""> - callback: the Ajax callback function. It returns the HTML that gets embedded in the search page while the visitor types.</div><div class=""> </div><div class=""> Here is the &quot;default.py&quot; controller:</div><div class=""> ``</div><div class=""> def index():</div><div class="">      &quot;&quot;&quot; this controller returns a dictionary rendered by the view</div><div class="">          it lists all wiki pages</div><div class="">      &gt;&gt;&gt; index().has_key(&#x27;pages&#x27;)</div><div class="">      True</div><div class="">      &quot;&quot;&quot;</div><div class="">      pages = db().select(db.page.id,db.page.title,orderby=db.page.title)</div><div class="">      return dict(pages=pages)</div><div class=""> </div><div class=""> @auth.requires_login()</div><div class=""> def create():</div><div class="">      &quot;creates a new empty wiki page&quot;</div><div class="delete">     form = <span class="highlight">crud.create</span>(db.page<span class="highlight">, </span>next=URL(&#x27;index&#x27;))</div><div class="">      return dict(form=form)</div><div class=""> </div><div class=""> def show():</div><div class="">      &quot;shows a wiki page&quot;</div><div class="">      this_page = db.page(request.args(0,cast=int)) or redirect(URL(&#x27;index&#x27;))</div><div class="">      db.comment.page_id.default = this_page.id</div><div class="delete">     form = <span class="highlight">crud.create</span>(db.comment<span class="highlight"></span>) if auth.user else None</div><div class="">      pagecomments = db(db.comment.page_id==this_page.id).select()</div><div class="">      return dict(page=this_page, comments=pagecomments, form=form)</div><div class=""> </div><div class=""> @auth.requires_login()</div><div class=""> def edit():</div><div class="">      &quot;edit an existing wiki page&quot;</div><div class="">      this_page = db.page(request.args(0,cast=int)) or redirect(URL(&#x27;index&#x27;))</div><div class="delete">-     form = crud.update(db.page, this_page,</div><div class="delete">-                        next=URL(&#x27;show&#x27;,args=request.args))</div><div class="">      return dict(form=form)</div><div class=""> </div><div class=""> @auth.requires_login()</div><div class=""> def documents():</div><div class="">      &quot;browser, edit all documents attached to a certain page&quot;</div><div class="">      page = db.page(request.args(0,cast=int)) or redirect(URL(&#x27;index&#x27;))</div><div class="">      db.document.page_id.default = page.id</div><div class="">      db.document.page_id.writable = False</div><div class="">      grid = SQLFORM.grid(db.document.page_id==page.id,args=[page.id])</div><div class="">      return dict(page=page, grid=grid)</div><div class=""> </div><div class=""> def user():</div><div class="">      return dict(form=auth())</div><div class=""> </div><div class=""> def download():</div><div class="">      &quot;allows downloading of documents&quot;</div><div class="">      return response.download(request, db)</div><div class=""> </div><div class=""> def search():</div><div class="">      &quot;an ajax wiki search page&quot;</div><div class="">      return dict(form=FORM(INPUT(_id=&#x27;keyword&#x27;,_name=&#x27;keyword&#x27;,</div><div class="">               _onkeyup=&quot;ajax(&#x27;callback&#x27;, [&#x27;keyword&#x27;], &#x27;target&#x27;);&quot;)),</div><div class="">               target_div=DIV(_id=&#x27;target&#x27;))</div><div class=""> </div><div class=""> def callback():</div><div class="">      &quot;an ajax callback that returns a &lt;ul&gt; of links to wiki pages&quot;</div><div class="">      query = db.page.title.contains(request.vars.keyword)</div><div class="">      pages = db(query).select(orderby=db.page.title)</div><div class="">      links = [A(p.title, _href=URL(&#x27;show&#x27;,args=p.id)) for p in pages]</div><div class="">      return UL(*links)</div><div class=""> The handler can be accessed from many other programming languages that understan</div><div class=""> There are three different representation for each of the field types ``date``, ``datetime`` and ``time``:</div><div class=""> - the database representation</div><div class=""> - the internal web2py prepresentation</div><div class=""> - the string representation in forms and tables</div><div class=""> </div><div class=""> The database representation is an internal issue and does not affect the code. Internally, at the web2py level, they are stored as ``datetime.date``, ``datetime.datetime`` and ``datetime.time`` object respectively and they can be manipulated as such:</div><div class=""> </div><div class=""> ``</div><div class=""> for page in db(db.page).select():</div><div class="">     print page.title, page.day, page.month, page.year</div><div class=""> ``</div><div class=""> </div><div class=""> When dates are converted to strings in forms they are converted using the ISO representation </div><div class=""> ``</div><div class=""> %Y-%m-%d %H:%M:%S</div><div class=""> ``</div><div class=""> </div><div class=""> yet this representation in internationalized and you can use the admin stranslation page to change the format to an alternate one. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> %m/%b/%Y %H:%M:%S</div><div class=""> ``</div><div class=""> </div><div class=""> ------</div><div class=""> Mind that by default English is not translated because web2py assumes the applications is already written in English. If you want internationalization to work for English you need to create the translation file (using admin) and you need declare that the application current language is something other than english, for example:</div><div class=""> ``</div><div class=""> T.current_languages = [&#x27;null&#x27;]</div><div class=""> ``</div><div class=""> ------</div><div class=""> </div><div class="delete">-</div><div class="delete">-</div><div class="delete">-</div><div class=""> ### More on **admin**</div><div class=""> ``admin``:inxx</div><div class=""> </div><div class=""> The administrative interface provides additional functionality that we briefly review here.</div><div class=""> </div><div class=""> #### &#x27;&#x27;site&#x27;&#x27;</div><div class=""> ``site``:inxx</div><div class=""> </div><div class=""> This page lists all installed applications. There are two forms at the bottom.</div><div class=""> </div><div class=""> The first of them allows creating a new application by specifying its name.</div><div class=""> </div><div class="delete">-``Instant Press``:inxx</div><div class="delete">-The second form allows uploading an existing application from either a local file or a remote URL. When you upload an application, you need to specify a name for it. This can be its original name, but does not need to be. This allows installing multiple copies of the same application. You can try, for example, to upload the the Instant Press CMS created by Martin Mulone from:</div><div class=""> </div><div class=""> ``</div><div class=""> http://code.google.com/p/instant-press/</div><div class="delete">-``:code</div><div class=""> </div><div class=""> ------</div><div class=""> Web2py files are packages as ``.w2p`` files. These ones are tar gzipped files. Web2py uses the ``.w2p`` extension instead of the ``.tgz`` extension to prevent the browser from unzipping on download. They can be uncompressed manually with ``tar zxvf [filename]`` although this is never necessary.</div><div class=""> ------</div><div class=""> </div><div class=""> [[image @///image/en4100.png center 444px]]</div><div class=""> </div><div class=""> Upon successful upload, web2py displays the MD5 checksum of the uploaded file. You can use it to verify that the file was not corrupted during upload. The InstantPress name will appear in the list of installed applications.</div><div class=""> </div><div class="delete">-Click on the InstantPress name on admin to get it up and running.</div><div class="delete">-</div><div class="delete"><span class="highlight">[[</span>i<span class="highlight"></span>m<span class="highlight"></span>a<span class="highlight"></span>ge<span class="highlight"></span> <span class="highlight">@///</span>i<span class="highlight">m</span>a<span class="highlight">ge/e</span>n<span class="highlight">4200.p</span>ng<span class="highlight"> center 480px]]</span></div><div class=""> </div><div class="delete">-You can read more about Instant Press at the following URL:</div><div class="delete">-``</div><div class="delete">-http://code.google.com/p/instant-press/</div><div class="delete"><span class="highlight">``</span></div><div class=""> </div><div class=""> For each application the &#x27;&#x27;site&#x27;&#x27; page allows you to:</div><div class=""> - Uninstall the application.</div><div class=""> - Jump to the &#x27;&#x27;about&#x27;&#x27; page (read below).</div><div class=""> - Jump to the &#x27;&#x27;edit&#x27;&#x27; page (read below).</div><div class=""> - Jump to the &#x27;&#x27;errors&#x27;&#x27; page (read below).</div><div class=""> - Clean up temporary files (sessions, errors, and cache.disk files).</div><div class=""> - Pack all. This returns a tar file containing a complete copy of the application. We suggest that you clean up temporary files before packing an application.</div><div class=""> - Compile the application. If there are no errors, this option will bytecode-compile all models, controllers and views. Because views can extend and include other views in a tree, before bytecode compilation, the view tree for every controller is collapsed into a single file. The net effect is that a bytecode-compiled application is faster, because there is no more parsing of templates or string substitutions occurring at runtime.</div><div class=""> - Pack compiled. This option is only present for bytecode-compiled applications. It allows packing the application without source code for distribution as closed source. Note that Python (as any other programming language) can technically be decompiled; therefore compilation does not provide complete protection of the source code. Nevertheless, decompilation can be difficult and can be illegal.</div><div class=""> - Remove compiled. It simply removes the byte-code compiled models, views and controllers from the application. If the application was packaged with source code or edited locally, there is no harm in removing the bytecode-compiled files, and the application will continue to work. If the application was installed form a packed compiled file, then this is not safe, because there is no source code to revert to, and the application will no longer work.</div><div class=""> </div><div class=""> ``admin.py``:inxx</div><div class=""> </div><div class=""> -------</div><div class=""> All the functionality available from the web2py admin site page is also accessible programmatically via the API defined in the module ``gluon/admin.py``. Simply open a python shell and import this module.</div><div class=""> -------</div><div class=""> </div><div class=""> #### &#x27;&#x27;about&#x27;&#x27;</div><div class=""> ``about``:inxx ``license``:inxx</div><div class=""> </div><div class=""> The &#x27;&#x27;about&#x27;&#x27; tab allows editing the description of the application and its license. These are written respectively in the ABOUT and LICENSE files in the application folder.</div><div class=""> </div><div class=""> [[image @///image/en4300.png center 480px]]</div><div class=""> </div><div class=""> You can use ``MARKMIN``, or ``gluon.contrib.markdown.WIKI`` syntax for these files as described in ref.``markdown2``:cite .</div><div class=""> </div><div class=""> #### &#x27;&#x27;edit&#x27;&#x27;</div><div class=""> ``EDIT``:inxx</div><div class=""> You have used the &#x27;&#x27;edit&#x27;&#x27; page already in this chapter. Here we want to point out a few more functionalities of the &#x27;&#x27;edit&#x27;&#x27; page.</div><div class=""> - If you click on any file name, you can see the contents of the file with syntax highlighting.</div><div class=""> - If you click on edit, you can edit the file via a web interface.</div><div class=""> - If you click on delete, you can delete the file (permanently).</div><div class=""> - If you click on test, web2py will run tests. Tests are written by the developer using Python doctests, and each function should have its own tests.</div><div class=""> - You can add language files, scan the app to discover all strings, and edit string translations via the web interface.</div><div class=""> - If the static files are organized in folders and subfolders, the folder hierarchy can be toggled by clicking on a folder name.</div><div class=""> </div><div class=""> The image below shows the output of the test page for the welcome application.</div><div class=""> </div><div class=""> [[image @///image/en4400.png center 480px]]</div><div class=""> </div><div class=""> The image below show the languages tab for the welcome application.</div><div class=""> </div><div class=""> [[image @///image/en4500.png center 480px]]</div><div class=""> </div><div class=""> The image below shows how to edit a language file, in this case the &quot;it&quot; (Italian) language for the welcome application.</div><div class=""> </div><div class=""> [[image @///image/en4600.png center 480px]]</div><div class=""> Normally there is no need to perform any configuration of admin but a few custom</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/admin/default/edit/admin/models/0.py</div><div class=""> ``</div><div class=""> Notice that **admin** can be used to edit itself. In fact **admin** is an app as any other one.</div><div class=""> </div><div class=""> The file &quot;0.py&quot; is very much self documented and if you are opening probably you already know what you are looking for. Anyway few customizations exist that are more important than others:</div><div class=""> </div><div class=""> ``</div><div class=""> GAE_APPCFG = os.path.abspath(os.path.join(&#x27;/usr/local/bin/appcfg.py&#x27;))</div><div class=""> ``</div><div class=""> This should point to the location of the &quot;appcfg.py&quot; file that comes with the Google App Engine SDK. If you have the SDK you may want to change this config parameters to the correct value. It will allow you to deploy to GAE from the admin interface.</div><div class=""> </div><div class=""> ``DEMO_MODE``:inxx</div><div class=""> </div><div class=""> You can also set web2py admin in demo mode:</div><div class=""> ``</div><div class=""> DEMO_MODE = True</div><div class=""> FILTER_APPS = [&#x27;welcome&#x27;]</div><div class=""> ``</div><div class=""> And only the apps listed in filter apps will be accessible and they will be only accessible in read-only mode.</div><div class=""> </div><div class=""> ``MULTI_USER_MODE``:inxx</div><div class=""> ``virtual laboratory``:inxx</div><div class=""> </div><div class=""> If you are a teacher and want to expose the administrative interface to students so that students can share one administrative interface for their projects (think of a virtual lab), can do it by setting:</div><div class=""> ``</div><div class=""> MULTI_USER_MODE = True</div><div class=""> ``</div><div class=""> In this way students will be required to login and will only be able to access their own apps via admin. You, as first user/teacher, will be able to access them all.</div><div class=""> </div><div class="delete">-Mind that this mechanism still assumes all users are trusted. All the apps created under admin run under the same credentials on the same filesystem. It is possible for an app created by a student to access the data and the source of an app created by another student.</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/f2d73d8caa8283f9cbd978713b92c3f2b041db77">f2d73d8</a><ul><li>Date : 2012-12-27</li><li>comments -&gt; posts</li></ul></li></ul>
<div class="row-fluid" id="com_f2d73d8caa8283f9cbd978713b92c3f2b041db77">
    <div class="span6"><div class="diff"><div class="insert">Here, as another example, we wish to create a web application that allows the administrator to post images and give them a name, and allows the visitors of the web site to view the named images and submit comments<span class="highlight"> (posts)</span>.</div><div class=""> </div><div class=""> As before, from the **site** page in **admin**, create a new application called ``images``, and navigate to the &#x27;&#x27;edit&#x27;&#x27; page:</div><div class=""> </div><div class=""> [[image @///image/en1900.png center 480px]]</div><div class=""> </div><div class=""> We start by creating a model, a representation of the persistent data in the application (the images to upload, their names, and the comments). First, you need to create/edit a model file which, for lack of imagination, we call &quot;db.py&quot;. We assume the code below will replace any existing code in &quot;db.py&quot;. Models and controllers must have a ``.py`` extension since they are Python code. If the extension is not provided, it is appended by web2py. Views instead have a ``.html`` extension since they mainly contain HTML code.</div><div class=""> </div><div class=""> Edit the &quot;db.py&quot; file by clicking the corresponding &quot;edit&quot; button:</div><div class=""> </div><div class=""> [[image @///image/en2000.png center 480px]]</div><div class=""> </div><div class=""> and enter the following:</div><div class=""> </div><div class=""> ``IS_EMAIL``:inxx ``IS_NOT_EMPTY``:inxx ``IS_IN_DB``:inxx</div><div class=""> ``</div><div class=""> db = DAL(&quot;sqlite://storage.sqlite&quot;)</div><div class=""> </div><div class=""> db.define_table(&#x27;image&#x27;,</div><div class="">    Field(&#x27;title&#x27;, unique=True),</div><div class="">    Field(&#x27;file&#x27;, &#x27;upload&#x27;),</div><div class="">    format = &#x27;%(title)s&#x27;)</div><div class=""> </div><div class="insert">db.define_table(&#x27;<span class="highlight">p</span>o<span class="highlight">s</span>t&#x27;,</div><div class="">    Field(&#x27;image_id&#x27;, &#x27;reference image&#x27;),</div><div class="">    Field(&#x27;author&#x27;),</div><div class="">    Field(&#x27;email&#x27;),</div><div class="">    Field(&#x27;body&#x27;, &#x27;text&#x27;))</div><div class=""> </div><div class=""> db.image.title.requires = IS_NOT_IN_DB(db, db.image.title)</div><div class="insert">+db.post.image_id.requires = IS_IN_DB(db, db.image.id, &#x27;%(title)s&#x27;)</div><div class="insert">+db.post.author.requires = IS_NOT_EMPTY()</div><div class="insert">+db.post.email.requires = IS_EMAIL()</div><div class="insert">+db.post.body.requires = IS_NOT_EMPTY()</div><div class=""> </div><div class="insert">db.<span class="highlight">p</span>o<span class="highlight">s</span>t.image_id.writable = db.<span class="highlight">p</span>o<span class="highlight">s</span>t.image_id.readable = False</div><div class=""> ``:code</div><div class=""> </div><div class=""> Let&#x27;s analyze this line by line.</div><div class=""> </div><div class=""> Line 1 defines a global variable called ``db`` that represents the database connection. In this case it is a connection to a SQLite database stored in the file  &quot;applications/images/databases/storage.sqlite&quot;. In the SQLite case, if the database does not exist, it is created. You can change the name of the file, as well as the name of the global variable ``db``, but it is convenient to give them the same name, to make it easy to remember.</div><div class=""> </div><div class=""> Lines 3-5 define a table &quot;image&quot;. ``define_table`` is a method of the ``db`` object. The first argument, &quot;image&quot;, is the name of the table we are defining. The other arguments are the fields belonging to that table. This table has a field called &quot;title&quot;, a field called &quot;file&quot;, and a field called &quot;id&quot; that serves as the table primary key (&quot;id&quot; is not explicitly declared because all tables have an id field by default). The field &quot;title&quot; is a string, and the field &quot;file&quot; is of type &quot;upload&quot;. &quot;upload&quot; is a special type of field used by the web2py Data Abstraction Layer (DAL) to store the names of uploaded files. web2py knows how to upload files (via streaming if they are large), rename them safely, and store them.</div><div class=""> </div><div class=""> When a table is defined, web2py takes one of several possible actions:</div><div class=""> - if the table does not exist, the table is created;</div><div class=""> - if the table exists and does not correspond to the definition, the table is altered accordingly, and if a field has a different type, web2py tries to convert its contents;</div><div class=""> - if the table exists and corresponds to the definition, web2py does nothing.</div><div class=""> </div><div class=""> This behavior is called &quot;migration&quot;. In web2py migrations are automatic, but can be disabled for each table by passing ``migrate=False`` as the last argument of ``define_table``.</div><div class=""> </div><div class=""> Line 6 defines a format string for the table. It determines how a record should be represented as a string. Notice that the ``format`` argument can also be a function that takes a record and returns a string. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> format=lambda row: row.title</div><div class=""> ``:code</div><div class=""> </div><div class="insert">+Lines 8-12 define another table called &quot;post&quot;.</div><div class="insert">+A post has an &quot;author&quot;, an &quot;email&quot; (we intend to store the email address of the author of the post), a &quot;body&quot; of type &quot;text&quot; (we intend to use it to store the actual comment posted by the author), and an &quot;image_id&quot; field of type reference that points to ``db.image`` via the &quot;id&quot; field.</div><div class=""> </div><div class=""> In line 14, ``db.image.title`` represents the field &quot;title&quot; of table &quot;image&quot;. The attribute ``requires`` allows you to set requirements/constraints that will be enforced by web2py forms. Here we require that the &quot;title&quot; is unique:</div><div class=""> </div><div class=""> ``IS_NOT_IN_DB(db, db.image.title)``:code</div><div class=""> </div><div class=""> &#x27;&#x27;Notice this is optional because it is set automatically given that ``Field(&#x27;title&#x27;, unique=True)``&#x27;&#x27;.</div><div class=""> </div><div class=""> The objects representing these constraints are called validators. Multiple validators can be grouped in a list. Validators are executed in the order they appear.</div><div class=""> ``IS_NOT_IN_DB(a, b)`` is a special validator that checks that the value of a field ``b`` for a new record is not already in ``a``.</div><div class=""> </div><div class="insert">Line 15 requires that the field &quot;image_id&quot; of table &quot;<span class="highlight">p</span>o<span class="highlight">s</span>t&quot; is in ``db.image.id``. As far as the database is concerned, we had already declared this  when we defined the table &quot;<span class="highlight">p</span>o<span class="highlight">s</span>t&quot;.</div><div class=""> Now we are explicitly telling the model that this condition should be enforced by web2py, too, at the form processing level when a new comment is posted, so that invalid values do not propagate from input forms to the database. We also require that the &quot;image_id&quot; be represented by the &quot;title&quot;, ``&#x27;%(title)s&#x27;``, of the corresponding record.</div><div class=""> </div><div class="insert">Line 20 indicates that the field &quot;image_id&quot; of table &quot;<span class="highlight">p</span>o<span class="highlight">s</span>t&quot; should not be shown in forms, ``writable=False`` and not even in readonly forms, ``readable=False``.</div><div class=""> </div><div class=""> The meaning of the validators in lines 15-17 should be obvious.</div><div class=""> </div><div class=""> ``format``:inxx</div><div class=""> Notice that the validator</div><div class=""> ``</div><div class="insert">db.<span class="highlight">p</span>o<span class="highlight">s</span>t.image_id.requires = IS_IN_DB(db, db.image.id, &#x27;%(title)s&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> can be omitted (and would be automatic) if we specify a format for referenced table:</div><div class=""> ``</div><div class=""> db.define_table(&#x27;image&#x27;, ..., format=&#x27;%(title)s&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> where the format can be a string or a function that takes a record and returns a string.</div><div class=""> </div><div class=""> ``appadmin``:inxx</div><div class=""> Once a model is defined, if there are no errors, web2py creates an application administration interface to manage the database. You access it via the &quot;database administration&quot; link in the &#x27;&#x27;edit&#x27;&#x27; page or directly:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/appadmin</div><div class=""> ``:code</div><div class=""> </div><div class=""> Here is a screenshot of the **appadmin** interface:</div><div class=""> </div><div class=""> [[image @///image/en2100.png center 480px]]</div><div class=""> </div><div class=""> This interface is coded in the controller called &quot;appadmin.py&quot; and the corresponding view &quot;appadmin.html&quot;. From now on, we will refer to this interface simply as **appadmin**. It allows the administrator to insert new database records, edit and delete existing records, browse tables, and perform database joins.</div><div class=""> </div><div class=""> The first time **appadmin** is accessed, the model is executed and the tables are created. The web2py DAL translates Python code into SQL statements that are specific to the selected database back-end (SQLite in this example). You can see the generated SQL from the &#x27;&#x27;edit&#x27;&#x27; page by clicking on the &quot;sql.log&quot; link under &quot;models&quot;. Notice that the link is not present until the tables have been created.</div><div class=""> </div><div class=""> [[image @///image/en2200.png center 480px]]</div><div class=""> </div><div class=""> If you were to edit the model and access **appadmin** again, web2py would generate SQL to alter the existing tables. The generated SQL is logged into &quot;sql.log&quot;.</div><div class=""> </div><div class=""> Now go back to **appadmin** and try to insert a new image record:</div><div class=""> </div><div class=""> [[image @///image/en2300.png center 480px]]</div><div class=""> is rendered as:</div><div class=""> </div><div class=""> A handful of helpers (``INPUT``, ``TEXTAREA``, ``OPTION`` and ``SELECT``) also support some special named attributes not starting with underscore (``value``, and ``requires``). They are important for building custom forms and will be discussed later.</div><div class=""> </div><div class=""> Go back to the &#x27;&#x27;edit&#x27;&#x27; page. It now indicates that &quot;default.py exposes index&quot;. By clicking on &quot;index&quot;, you can visit the newly created page:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/index</div><div class=""> ``:code</div><div class=""> </div><div class=""> which looks like:</div><div class=""> </div><div class=""> [[image @///image/en2800.png center 480px]]</div><div class=""> </div><div class=""> If you click on the image name link, you are directed to:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/show/1</div><div class=""> ``:code</div><div class=""> </div><div class=""> and this results in an error, since you have not yet created an action called &quot;show&quot; in controller &quot;default.py&quot;.</div><div class=""> </div><div class=""> Let&#x27;s edit the &quot;default.py&quot; controller and replace its content with:</div><div class=""> </div><div class=""> ``SQLFORM``:inxx ``accepts``:inxx ``response.flash``:inxx ``request.args``:inxx</div><div class=""> ``response.download``:inxx</div><div class=""> ``</div><div class=""> def index():</div><div class="">     images = db().select(db.image.ALL, orderby=db.image.title)</div><div class="">     return dict(images=images)</div><div class=""> </div><div class=""> def show():</div><div class="">     image = db.image(request.args(0,cast=int)) or redirect(URL(&#x27;index&#x27;))</div><div class="insert">+    db.post.image_id.default = image.id</div><div class="insert">+    form = SQLFORM(db.post)</div><div class="">     if form.process().accepted:</div><div class="">         response.flash = &#x27;your comment is posted&#x27;</div><div class="insert">    comments = db(db.<span class="highlight">p</span>o<span class="highlight">s</span>t.image_id==image.id).select()</div><div class="">     return dict(image=image, comments=comments, form=form)</div><div class=""> </div><div class=""> def download():</div><div class="">     return response.download(request, db)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The controller contains two actions: &quot;show&quot; and &quot;download&quot;.</div><div class=""> The &quot;show&quot; action selects the image with the ``id`` parsed from the request args and all comments related to the image. &quot;show&quot; then passes everything to the view &quot;default/show.html&quot;.</div><div class=""> </div><div class=""> The image id referenced by:</div><div class=""> ``</div><div class=""> URL(&#x27;show&#x27;, args=image.id)</div><div class=""> ``:code</div><div class=""> </div><div class=""> in &quot;default/index.html&quot;, can be accessed as:</div><div class=""> </div><div class=""> ``request.args(0,cast=int)``</div><div class=""> </div><div class=""> from the &quot;show&quot; action. The ``cast=int`` argument is optional but very important. It attempts to cast the string value passed in the PATH_INFO into an int. On failure it raise a proper exception instead of causing a ticket. One can also specify a redirect in case of failure to cast:</div><div class=""> </div><div class=""> ``request.args(0,cast=int,otherwise=URL(&#x27;error&#x27;))``</div><div class=""> </div><div class=""> Moreover ``db.image(...)`` is a shortcut for</div><div class=""> </div><div class=""> ``</div><div class=""> db(db.image.id==...).select().first()</div><div class=""> ``:code</div><div class=""> </div><div class=""> The &quot;download&quot; action expects a filename in ``request.args(0)``, builds a path to the location where that file is supposed to be, and sends it back to the client. If the file is too large, it streams the file without incurring any memory overhead.</div><div class=""> </div><div class=""> Notice the following statements:</div><div class="insert">- Line 7 creates an insert form SQLFORM for the ``db.<span class="highlight">p</span>o<span class="highlight">s</span>t`` table using only the specified fields.</div><div class=""> - Line 8 sets the value for the reference field, which is not part of the input form because it is not in the list of fields specified above.</div><div class="insert">- Line 9 processes the submitted form (the submitted form variables are in ``request.vars``) within the current session (the session is used to prevent double submissions, and to enforce navigation). If the submitted form variables are validated, the new comment is inserted in the ``db.<span class="highlight">pos</span>t`` table; otherwise the form is modified to include error messages (for example, if the author&#x27;s email address is invalid). This is all done in line 9!.</div><div class=""> - Line 10 is only executed if the form is accepted, after the record is inserted into the database table. ``response.flash`` is a web2py variable that is displayed in the views and used to notify the visitor that something happened.</div><div class=""> - Line 11 selects all comments that reference the current image.</div><div class=""> </div><div class=""> -------</div><div class=""> The &quot;download&quot; action is already defined in the &quot;default.py&quot; controller of the scaffolding application.</div><div class=""> -------</div><div class=""> </div><div class=""> The &quot;download&quot; action does not return a dictionary, so it does not need a view. The &quot;show&quot; action, though, should have a view, so return to **admin** and create a new view called &quot;default/show.html&quot;.</div><div class=""> </div><div class=""> Edit this new file and replace its content with the following:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Image: {{=image.title}}&lt;/h1&gt;</div><div class=""> &lt;center&gt;</div><div class=""> &lt;img width=&quot;200px&quot;</div><div class="">      src=&quot;{{=URL(&#x27;download&#x27;, args=image.file)}}&quot; /&gt;</div><div class=""> &lt;/center&gt;</div><div class=""> {{if len(comments):}}</div><div class="">   &lt;h2&gt;Comments&lt;/h2&gt;&lt;br /&gt;&lt;p&gt;</div><div class="insert">+  {{for post in comments:}}</div><div class="insert">+    &lt;p&gt;{{=post.author}} says &lt;i&gt;{{=post.body}}&lt;/i&gt;&lt;/p&gt;</div><div class="">   {{pass}}&lt;/p&gt;</div><div class=""> {{else:}}</div><div class="">   &lt;h2&gt;No comments posted yet&lt;/h2&gt;</div><div class=""> {{pass}}</div><div class=""> &lt;h2&gt;Post a comment&lt;/h2&gt;</div><div class=""> {{=form}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> This view displays the **image.file** by calling the &quot;download&quot; action inside an ``&lt;img ... /&gt;`` tag.</div><div class=""> If there are comments, it loops over them and displays each one.</div><div class=""> </div><div class=""> Here is how everything will appear to a visitor.</div><div class=""> </div><div class=""> [[image @///image/en2900.png center 480px]]</div><div class=""> </div><div class=""> When a visitor submits a comment via this page, the comment is stored in the database and appended at the bottom of the page.</div><div class=""> </div><div class=""> #### Adding authentication</div><div class=""> </div><div class=""> The web2py API for Role-Based Access Control is quite sophisticated, but for now we will limit ourselves to restricting access to the show action to authenticated users, deferring a more detailed discussion to Chapter 9.</div><div class=""> </div><div class=""> To limit access to authenticated users, we need to complete three steps. In a model, for example &quot;db.py&quot;, we need to add:</div><div class=""> ``</div><div class=""> from gluon.tools import Auth</div><div class=""> auth = Auth(db)</div><div class=""> auth.define_tables(username=True)</div><div class=""> ``:code</div><div class=""> </div><div class=""> In our controller, we need to add one action:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/user/login</div><div class=""> </div><div class=""> [[image @///image/en3100.png center 480px]]</div><div class=""> </div><div class=""> The ``user`` function also exposes, among others, the following actions:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/user/logout</div><div class=""> http://127.0.0.1:8000/images/default/user/register</div><div class=""> http://127.0.0.1:8000/images/default/user/profile</div><div class=""> http://127.0.0.1:8000/images/default/user/change_password</div><div class=""> http://127.0.0.1:8000/images/default/user/request_reset_password</div><div class=""> http://127.0.0.1:8000/images/default/user/retrieve_username</div><div class=""> http://127.0.0.1:8000/images/default/user/retrieve_password</div><div class=""> http://127.0.0.1:8000/images/default/user/verify_email</div><div class=""> http://127.0.0.1:8000/images/default/user/impersonate</div><div class=""> http://127.0.0.1:8000/images/default/user/not_authorized</div><div class=""> ``:code</div><div class=""> </div><div class=""> Now, a first-time user needs to register in order to be able to log in and read or post comments.</div><div class=""> </div><div class=""> -------</div><div class=""> Both the ``auth`` object and the ``user`` function are already defined in the scaffolding application. The ``auth`` object is highly customizable and can deal with email verification, registration approvals, CAPTCHA, and alternate login methods via plugins.</div><div class=""> -------</div><div class=""> </div><div class=""> #### Adding grids</div><div class=""> </div><div class=""> We can improve this further using the ``SQLFORM.grid`` and ``SQLFORM.smartgrid`` gadgets to create a management interface for our application:</div><div class=""> </div><div class=""> ``</div><div class=""> @auth.requires_membership(&#x27;manager&#x27;)</div><div class=""> def manage():</div><div class="insert">    grid = SQLFORM.smartgrid(db.image,linked_tables=[&#x27;<span class="highlight">p</span>o<span class="highlight">s</span>t&#x27;])</div><div class="">     return dict(grid=grid)</div><div class=""> ``:code</div><div class=""> </div><div class=""> with associated &quot;views/default/manage.html&quot;</div><div class=""> </div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h2&gt;Management Interface&lt;/h2&gt;</div><div class=""> {{=grid}}</div><div class=""> ``</div><div class=""> </div><div class=""> Using appadmin create a group &quot;manager&quot; and make some users members of the group. They will not be able to access</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/manage</div><div class=""> ``</div><div class=""> </div><div class=""> and browse, search:</div><div class=""> </div><div class=""> [[image @///image/en3200.png center 480px]]</div><div class=""> </div><div class=""> create, update and delete images and their comments:</div><div class=""> </div><div class=""> [[image @///image/en3300.png center 480px]]</div><div class=""> </div><div class=""> #### Configuring the layout</div><div class=""> </div><div class=""> You can configure the default layout by editing &quot;views/layout.html&quot; but you can also configure it without editing the HTML. In fact, the &quot;static/base.css&quot; stylesheet is well documented and described in Chapter 5. You can change color, columns, size, borders and background without editing the HTML. If you want to edit the menu, the title or the subtitle, you can do so in any model file. The scaffolding app, sets default values of these parameters in the file &quot;models/menu.py&quot;:</div><div class=""> </div><div class=""> ``</div><div class=""> response.meta.keywords = &#x27;bla bla bla&#x27;</div><div class=""> response.menu = [ [ &#x27;Index&#x27;, False, URL(&#x27;index&#x27;) ] ]</div><div class=""> ``:code</div><div class=""> </div><div class=""> ### A simple wiki</div><div class=""> ``wiki``:inxx ``RSS``:inxx ``Ajax``:inxx ``XMLRPC``:inxx</div><div class=""> </div><div class=""> In this section, we build a simple wiki from scratch using only low level APIs (as opposed to using the built-in wiki capabilities of web2py demonstrated in the next section). The visitor will be able to create pages, search them (by title), and edit them. The visitor will also be able to post comments (exactly as in the previous applications), and also post documents (as attachments to the pages) and link them from the pages. As a convention, we adopt the Markmin syntax for our wiki syntax. We will also implement a search page with Ajax, an RSS feed for the pages, and a handler to search the pages via XML-RPC``xmlrpc``:cite . The following diagram lists the actions that we need to implement and the links we intend to build among them.</div><div class=""> </div><div class=""> [[yUML diagram @///image/en3400.png center 200px]]</div><div class=""> </div><div class=""> Start by creating a new scaffolding app, naming it &quot;mywiki&quot;.</div><div class=""> </div><div class=""> The model must contain three tables: page, comment, and document. Both comment and document reference page because they belong to page. A document contains a file field of type upload as in the previous images application.</div><div class=""> </div><div class=""> Here is the complete model:</div><div class=""> ``</div><div class=""> db = DAL(&#x27;sqlite://storage.sqlite&#x27;)</div><div class=""> </div><div class=""> from gluon.tools import *</div><div class=""> auth = Auth(db)</div><div class=""> auth.define_tables()</div><div class=""> crud = Crud(db)</div><div class=""> </div><div class=""> db.define_table(&#x27;page&#x27;,</div><div class="">     Field(&#x27;title&#x27;),</div><div class="">     Field(&#x27;body&#x27;, &#x27;text&#x27;),</div><div class="">     Field(&#x27;created_on&#x27;, &#x27;datetime&#x27;, default=request.now),</div><div class="">     Field(&#x27;created_by&#x27;, &#x27;reference auth_user&#x27;, default=auth.user_id),</div><div class="">     format=&#x27;%(title)s&#x27;)</div><div class=""> </div><div class="insert">db.define_table(&#x27;<span class="highlight">p</span>o<span class="highlight">s</span>t&#x27;,</div><div class="">     Field(&#x27;page_id&#x27;, &#x27;reference page&#x27;),</div><div class="">     Field(&#x27;body&#x27;, &#x27;text&#x27;),</div><div class="">     Field(&#x27;created_on&#x27;, &#x27;datetime&#x27;, default=request.now),</div><div class="">     Field(&#x27;created_by&#x27;, &#x27;reference auth_user&#x27;, default=auth.user_id))</div><div class=""> </div><div class=""> db.define_table(&#x27;document&#x27;,</div><div class="">     Field(&#x27;page_id&#x27;, &#x27;reference page&#x27;),</div><div class="">     Field(&#x27;name&#x27;),</div><div class="">     Field(&#x27;file&#x27;, &#x27;upload&#x27;),</div><div class="">     Field(&#x27;created_on&#x27;, &#x27;datetime&#x27;, default=request.now),</div><div class="">     Field(&#x27;created_by&#x27;, &#x27;reference auth_user&#x27;, default=auth.user_id),</div><div class="">     format=&#x27;%(name)s&#x27;)</div><div class=""> </div><div class=""> db.page.title.requires = IS_NOT_IN_DB(db, &#x27;page.title&#x27;)</div><div class=""> db.page.body.requires = IS_NOT_EMPTY()</div><div class=""> db.page.created_by.readable = db.page.created_by.writable = False</div><div class=""> db.page.created_on.readable = db.page.created_on.writable = False</div><div class=""> </div><div class="insert">+db.post.body.requires = IS_NOT_EMPTY()</div><div class="insert">+db.post.page_id.readable = db.post.page_id.writable = False</div><div class="insert">+db.post.created_by.readable = db.post.created_by.writable = False</div><div class="insert">+db.post.created_on.readable = db.post.created_on.writable = False</div><div class=""> </div><div class=""> db.document.name.requires = IS_NOT_IN_DB(db, &#x27;document.name&#x27;)</div><div class=""> db.document.page_id.readable = db.document.page_id.writable = False</div><div class=""> db.document.created_by.readable = db.document.created_by.writable = False</div><div class=""> db.document.created_on.readable = db.document.created_on.writable = False</div><div class=""> ``:code</div><div class=""> </div><div class=""> Edit the controller &quot;default.py&quot; and create the following actions:</div><div class=""> - index: list all wiki pages</div><div class=""> - create: post another wiki page</div><div class=""> - show: show a wiki page and its comments, and append comments</div><div class=""> - edit: edit an existing page</div><div class=""> - documents: manage the documents attached to a page</div><div class=""> - download: download a document (as in the images example)</div><div class=""> - search: display a search box and, via an Ajax callback, return all matching titles as the visitor types</div><div class=""> - callback: the Ajax callback function. It returns the HTML that gets embedded in the search page while the visitor types.</div><div class=""> </div><div class=""> Here is the &quot;default.py&quot; controller:</div><div class=""> ``</div><div class=""> def index():</div><div class="">      &quot;&quot;&quot; this controller returns a dictionary rendered by the view</div><div class="">          it lists all wiki pages</div><div class="">      &gt;&gt;&gt; index().has_key(&#x27;pages&#x27;)</div><div class="">      True</div><div class="">      &quot;&quot;&quot;</div><div class="">      pages = db().select(db.page.id,db.page.title,orderby=db.page.title)</div><div class="">      return dict(pages=pages)</div><div class=""> </div><div class=""> @auth.requires_login()</div><div class=""> def create():</div><div class="">      &quot;creates a new empty wiki page&quot;</div><div class="">      form = SQLFORM(db.page).process(next=URL(&#x27;index&#x27;))</div><div class="">      return dict(form=form)</div><div class=""> </div><div class=""> def show():</div><div class="">      &quot;shows a wiki page&quot;</div><div class="">      this_page = db.page(request.args(0,cast=int)) or redirect(URL(&#x27;index&#x27;))</div><div class="insert">+     db.post.page_id.default = this_page.id</div><div class="insert">+     form = SQLFORM(db.post).process() if auth.user else None</div><div class="insert">+     pagecomments = db(db.post.page_id==this_page.id).select()</div><div class="">      return dict(page=this_page, comments=pagecomments, form=form)</div><div class=""> </div><div class=""> @auth.requires_login()</div><div class=""> def edit():</div><div class="">      &quot;edit an existing wiki page&quot;</div><div class="">      this_page = db.page(request.args(0,cast=int)) or redirect(URL(&#x27;index&#x27;))</div><div class="">      form = SQLFORM(db.page, this_page).process(</div><div class="">          next = URL(&#x27;show&#x27;,args=request.args))</div><div class="">      return dict(form=form)</div><div class=""> </div><div class=""> @auth.requires_login()</div><div class=""> def documents():</div><div class="">      &quot;browser, edit all documents attached to a certain page&quot;</div><div class="">      page = db.page(request.args(0,cast=int)) or redirect(URL(&#x27;index&#x27;))</div><div class="">      db.document.page_id.default = page.id</div><div class="">      db.document.page_id.writable = False</div><div class="">      grid = SQLFORM.grid(db.document.page_id==page.id,args=[page.id])</div><div class="">      return dict(page=page, grid=grid)</div><div class=""> </div><div class=""> def user():</div><div class="">      return dict(form=auth())</div><div class=""> </div><div class=""> def download():</div><div class="">      &quot;allows downloading of documents&quot;</div><div class="">      return response.download(request, db)</div><div class=""> </div><div class=""> def search():</div><div class="">      &quot;an ajax wiki search page&quot;</div><div class="">      return dict(form=FORM(INPUT(_id=&#x27;keyword&#x27;,_name=&#x27;keyword&#x27;,</div><div class="">               _onkeyup=&quot;ajax(&#x27;callback&#x27;, [&#x27;keyword&#x27;], &#x27;target&#x27;);&quot;)),</div><div class=""> Here is the code for the view &quot;default/create.html&quot;:</div><div class=""> </div><div class=""> If you visit the **create** page, you see the following:</div><div class=""> </div><div class=""> [[image @///image/en3500.png center 480px]]</div><div class=""> </div><div class=""> Here is the code for the view &quot;default/index.html&quot;:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Available wiki pages&lt;/h1&gt;</div><div class=""> [ {{=A(&#x27;search&#x27;, _href=URL(&#x27;search&#x27;))}} ]&lt;br /&gt;</div><div class=""> &lt;ul&gt;{{for page in pages:}}</div><div class="">      {{=LI(A(page.title, _href=URL(&#x27;show&#x27;, args=page.id)))}}</div><div class=""> {{pass}}&lt;/ul&gt;</div><div class=""> [ {{=A(&#x27;create page&#x27;, _href=URL(&#x27;create&#x27;))}} ]</div><div class=""> ``:code</div><div class=""> </div><div class=""> It generates the following page:</div><div class=""> </div><div class=""> [[image @///image/en3600.png center 480px]]</div><div class=""> </div><div class=""> Here is the code for the view &quot;default/show.html&quot;:</div><div class=""> </div><div class=""> ``markdown``:inxx ``MARKMIN``:inxx</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;{{=page.title}}&lt;/h1&gt;</div><div class=""> [ {{=A(&#x27;edit&#x27;, _href=URL(&#x27;edit&#x27;, args=request.args))}}</div><div class=""> | {{=A(&#x27;documents&#x27;, _href=URL(&#x27;documents&#x27;, args=request.args))}} ]&lt;br /&gt;</div><div class=""> {{=MARKMIN(page.body)}}</div><div class=""> &lt;h2&gt;Comments&lt;/h2&gt;</div><div class="insert">+{{for post in comments:}}</div><div class="insert">+  &lt;p&gt;{{=db.auth_user[post.created_by].first_name}} on {{=post.created_on}}</div><div class="insert">+     says &lt;i&gt;{{=post.body}}&lt;/i&gt;&lt;/p&gt;</div><div class=""> {{pass}}</div><div class=""> &lt;h2&gt;Post a comment&lt;/h2&gt;</div><div class=""> {{=form}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> If you wish to use markdown syntax instead of markmin syntax:</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.contrib.markdown import WIKI</div><div class=""> ``:code</div><div class=""> </div><div class=""> and use ``WIKI`` instead of the ``MARKMIN`` helper.</div><div class=""> Alternatively, you can choose to accept raw HTML instead of markmin syntax. In this case you would replace:</div><div class=""> ``</div><div class=""> {{=MARKMIN(page.body)}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> with:</div><div class=""> ``</div><div class=""> {{=XML(page.body)}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> ``sanitize``:inxx</div><div class=""> (so that the XML does not get escaped, as by default web2py behavior).</div><div class=""> </div><div class=""> This can be done better with:</div><div class=""> ``</div><div class=""> {{=XML(page.body, sanitize=True)}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> If you fix the divide-by-zero bug in the index action and introduce one in the i</div><div class=""> {{1/0}}</div><div class=""> {{=LI(A(image.title, _href=URL(&quot;show&quot;, args=image.id)))}}</div><div class=""> {{pass}}</div><div class=""> &lt;/ul&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> you get the following ticket:</div><div class=""> </div><div class=""> [[image @///image/en5000.png center 480px]]</div><div class=""> </div><div class=""> Note that web2py has converted the view from HTML into a Python file, and the error described in the ticket refers to the generated Python code and NOT to the original view file:</div><div class=""> </div><div class=""> [[image @///image/en5100.png center 480px]]</div><div class=""> </div><div class=""> This may seem confusing at first, but in practice it makes debugging easier, because the Python indentation highlights the logical structure of the code that you embedded in the views.</div><div class=""> </div><div class=""> The code is shown at the bottom of the same page.</div><div class=""> </div><div class=""> All tickets are listed under admin in the &#x27;&#x27;errors&#x27;&#x27; page for each application:</div><div class=""> </div><div class=""> [[image @///image/en5200.png center 480px]]</div><div class=""> </div><div class=""> #### Mercurial</div><div class=""> ``Mercurial``:inxx</div><div class=""> </div><div class=""> If you are running from source and you have the Mercurial version control libraries installed:</div><div class=""> ``</div><div class=""> easy_install mercurial</div><div class=""> ``:code</div><div class=""> </div><div class="insert">then the administrative interface shows one more menu item called &quot;Versioning&quot;. It automatically creates a local Mercurial repository for the application. Pressing the &quot;comm<span class="highlight">en</span>t&quot; button in the page will commit the current application. Mercurial creates and stores information about changes you make in your code into a hidden folder &quot;.hg&quot; in your app subfolder. Every app has its own &quot;.hg&quot; folder and its own &quot;.hgignore&quot; file (tells Mercurial which files to ignore).</div><div class=""> </div><div class=""> The Mercurial web interface does allow you to browse previous commit and diff files but we do recommend you use Mercurial directly from the shell or one of the many GUI-based Mercurial clients since they are more powerful. For example they will allow you sync your app with a remote source repository:</div><div class=""> </div><div class=""> [[images @///image/en5300.png center 480px]]</div><div class=""> </div><div class=""> </div><div class=""> You can read more about Mercurial here:</div><div class=""> ``</div><div class=""> http://mercurial.selenic.com/</div><div class=""> ``</div><div class=""> </div><div class=""> #### Application Wizard (experimental)</div><div class=""> </div><div class=""> The **admin** interface includes a Wizard that can help you create a new applications.</div><div class=""> You can access the wizard from the &quot;sites&quot; page as shown in the image below.</div><div class=""> </div><div class=""> [[image @///image/en5400.png center 480px]]</div><div class=""> </div><div class=""> The wizard will guide you through a series of steps involved in creating a new application:</div><div class=""> </div><div class=""> - Chose a name for the application</div><div class=""> - Configure the application and choose required plugins</div><div class=""> - Build required models (it will create CRUD pages for each model)</div><div class=""> - Allow you to edit the views of those pages using MARKMIN syntax</div><div class=""> </div><div class=""> The image below shows the second step of the process.</div><div class=""> </div><div class=""> [[image @///image/en5500.png center 480px]]</div><div class=""> </div><div class=""> You can see a dropdown to select a layout plugin (from ``web2py.com/layouts``), a multiple choice dropdown to check other plugins (from ``web2py.com/plugins``) and a &quot;login config&quot; field where to put the Janrain &quot;domain:key&quot;.</div><div class=""> In multi user mode, you can register students using the &quot;bulk register&quot; link in</div><div class=""> </div><div class=""> Mind that this mechanism still assumes all users are trusted. All the apps created under admin run under the same credentials on the same filesystem. It is possible for an app created by a student to access the data and the source of an app created by another student. It is also possible for a student to create an app that locks the server.</div><div class=""> </div><div class=""> #### Mobile **admin**</div><div class=""> </div><div class=""> Notice that the admin application includes &quot;plugin_jqmodile&quot; which packages jQuery Mobile. When admin is accessed from a mobile devide, this is detected by web2py and the interface is displayed using a mobile friendly layout.</div><div class=""> </div><div class=""> ### More on **appadmin**</div><div class=""> </div><div class=""> ``appadmin``:inxx</div><div class=""> </div><div class=""> **appadmin** is not intended to be exposed to the public. It is designed to help you by providing an easy access to the database. It consists of only two files: a controller &quot;appadmin.py&quot; and a view &quot;appadmin.html&quot; which are used by all actions in the controller.</div><div class=""> </div><div class=""> The **appadmin** controller is relatively small and readable; it provides an example of designing a database interface.</div><div class=""> </div><div class=""> **appadmin** shows which databases are available and which tables exist in each database. You can insert records and list all records for each table individually. **appadmin** paginates output 100 records at a time.</div><div class=""> </div><div class=""> Once a set of records is selected, the header of the pages changes, allowing you to update or delete the selected records.</div><div class=""> </div><div class=""> To update the records, enter an SQL assignment in the Query string field:</div><div class=""> ``</div><div class=""> title = &#x27;test&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class=""> where string values must be enclosed in single quotes. Multiple fields can be separated by commas.</div><div class=""> </div><div class=""> To delete a record, click the corresponding checkbox to confirm that you are sure.</div><div class=""> </div><div class=""> **appadmin** can also perform joins if the SQL FILTER contains a SQL condition that involves two or more tables. For example, try:</div><div class=""> ``</div><div class="insert">db.image.id == db.<span class="highlight">p</span>o<span class="highlight">s</span>t.image_id</div><div class=""> ``:code</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">Here, as another example, we wish to create a web application that allows the administrator to post images and give them a name, and allows the visitors of the web site to view the named images and submit comments<span class="highlight"></span>.</div><div class=""> </div><div class=""> As before, from the **site** page in **admin**, create a new application called ``images``, and navigate to the &#x27;&#x27;edit&#x27;&#x27; page:</div><div class=""> </div><div class=""> [[image @///image/en1900.png center 480px]]</div><div class=""> </div><div class=""> We start by creating a model, a representation of the persistent data in the application (the images to upload, their names, and the comments). First, you need to create/edit a model file which, for lack of imagination, we call &quot;db.py&quot;. We assume the code below will replace any existing code in &quot;db.py&quot;. Models and controllers must have a ``.py`` extension since they are Python code. If the extension is not provided, it is appended by web2py. Views instead have a ``.html`` extension since they mainly contain HTML code.</div><div class=""> </div><div class=""> Edit the &quot;db.py&quot; file by clicking the corresponding &quot;edit&quot; button:</div><div class=""> </div><div class=""> [[image @///image/en2000.png center 480px]]</div><div class=""> </div><div class=""> and enter the following:</div><div class=""> </div><div class=""> ``IS_EMAIL``:inxx ``IS_NOT_EMPTY``:inxx ``IS_IN_DB``:inxx</div><div class=""> ``</div><div class=""> db = DAL(&quot;sqlite://storage.sqlite&quot;)</div><div class=""> </div><div class=""> db.define_table(&#x27;image&#x27;,</div><div class="">    Field(&#x27;title&#x27;, unique=True),</div><div class="">    Field(&#x27;file&#x27;, &#x27;upload&#x27;),</div><div class="">    format = &#x27;%(title)s&#x27;)</div><div class=""> </div><div class="delete">db.define_table(&#x27;<span class="highlight">c</span>o<span class="highlight">mmen</span>t&#x27;,</div><div class="">    Field(&#x27;image_id&#x27;, &#x27;reference image&#x27;),</div><div class="">    Field(&#x27;author&#x27;),</div><div class="">    Field(&#x27;email&#x27;),</div><div class="">    Field(&#x27;body&#x27;, &#x27;text&#x27;))</div><div class=""> </div><div class=""> db.image.title.requires = IS_NOT_IN_DB(db, db.image.title)</div><div class="delete">-db.comment.image_id.requires = IS_IN_DB(db, db.image.id, &#x27;%(title)s&#x27;)</div><div class="delete">-db.comment.author.requires = IS_NOT_EMPTY()</div><div class="delete">-db.comment.email.requires = IS_EMAIL()</div><div class="delete">-db.comment.body.requires = IS_NOT_EMPTY()</div><div class=""> </div><div class="delete">db.<span class="highlight">c</span>o<span class="highlight">mmen</span>t.image_id.writable = db.<span class="highlight">c</span>o<span class="highlight">mmen</span>t.image_id.readable = False</div><div class=""> ``:code</div><div class=""> </div><div class=""> Let&#x27;s analyze this line by line.</div><div class=""> </div><div class=""> Line 1 defines a global variable called ``db`` that represents the database connection. In this case it is a connection to a SQLite database stored in the file  &quot;applications/images/databases/storage.sqlite&quot;. In the SQLite case, if the database does not exist, it is created. You can change the name of the file, as well as the name of the global variable ``db``, but it is convenient to give them the same name, to make it easy to remember.</div><div class=""> </div><div class=""> Lines 3-5 define a table &quot;image&quot;. ``define_table`` is a method of the ``db`` object. The first argument, &quot;image&quot;, is the name of the table we are defining. The other arguments are the fields belonging to that table. This table has a field called &quot;title&quot;, a field called &quot;file&quot;, and a field called &quot;id&quot; that serves as the table primary key (&quot;id&quot; is not explicitly declared because all tables have an id field by default). The field &quot;title&quot; is a string, and the field &quot;file&quot; is of type &quot;upload&quot;. &quot;upload&quot; is a special type of field used by the web2py Data Abstraction Layer (DAL) to store the names of uploaded files. web2py knows how to upload files (via streaming if they are large), rename them safely, and store them.</div><div class=""> </div><div class=""> When a table is defined, web2py takes one of several possible actions:</div><div class=""> - if the table does not exist, the table is created;</div><div class=""> - if the table exists and does not correspond to the definition, the table is altered accordingly, and if a field has a different type, web2py tries to convert its contents;</div><div class=""> - if the table exists and corresponds to the definition, web2py does nothing.</div><div class=""> </div><div class=""> This behavior is called &quot;migration&quot;. In web2py migrations are automatic, but can be disabled for each table by passing ``migrate=False`` as the last argument of ``define_table``.</div><div class=""> </div><div class=""> Line 6 defines a format string for the table. It determines how a record should be represented as a string. Notice that the ``format`` argument can also be a function that takes a record and returns a string. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> format=lambda row: row.title</div><div class=""> ``:code</div><div class=""> </div><div class="delete">-Lines 8-12 define another table called &quot;comment&quot;.</div><div class="delete">-A comment has an &quot;author&quot;, an &quot;email&quot; (we intend to store the email address of the author of the comment), a &quot;body&quot; of type &quot;text&quot; (we intend to use it to store the actual comment posted by the author), and an &quot;image_id&quot; field of type reference that points to ``db.image`` via the &quot;id&quot; field.</div><div class=""> </div><div class=""> In line 14, ``db.image.title`` represents the field &quot;title&quot; of table &quot;image&quot;. The attribute ``requires`` allows you to set requirements/constraints that will be enforced by web2py forms. Here we require that the &quot;title&quot; is unique:</div><div class=""> </div><div class=""> ``IS_NOT_IN_DB(db, db.image.title)``:code</div><div class=""> </div><div class=""> &#x27;&#x27;Notice this is optional because it is set automatically given that ``Field(&#x27;title&#x27;, unique=True)``&#x27;&#x27;.</div><div class=""> </div><div class=""> The objects representing these constraints are called validators. Multiple validators can be grouped in a list. Validators are executed in the order they appear.</div><div class=""> ``IS_NOT_IN_DB(a, b)`` is a special validator that checks that the value of a field ``b`` for a new record is not already in ``a``.</div><div class=""> </div><div class="delete">Line 15 requires that the field &quot;image_id&quot; of table &quot;<span class="highlight">c</span>o<span class="highlight">mmen</span>t&quot; is in ``db.image.id``. As far as the database is concerned, we had already declared this  when we defined the table &quot;<span class="highlight">c</span>o<span class="highlight">mmen</span>t&quot;.</div><div class=""> Now we are explicitly telling the model that this condition should be enforced by web2py, too, at the form processing level when a new comment is posted, so that invalid values do not propagate from input forms to the database. We also require that the &quot;image_id&quot; be represented by the &quot;title&quot;, ``&#x27;%(title)s&#x27;``, of the corresponding record.</div><div class=""> </div><div class="delete">Line 20 indicates that the field &quot;image_id&quot; of table &quot;<span class="highlight">c</span>o<span class="highlight">mmen</span>t&quot; should not be shown in forms, ``writable=False`` and not even in readonly forms, ``readable=False``.</div><div class=""> </div><div class=""> The meaning of the validators in lines 15-17 should be obvious.</div><div class=""> </div><div class=""> ``format``:inxx</div><div class=""> Notice that the validator</div><div class=""> ``</div><div class="delete">db.<span class="highlight">c</span>o<span class="highlight">mmen</span>t.image_id.requires = IS_IN_DB(db, db.image.id, &#x27;%(title)s&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> can be omitted (and would be automatic) if we specify a format for referenced table:</div><div class=""> ``</div><div class=""> db.define_table(&#x27;image&#x27;, ..., format=&#x27;%(title)s&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> where the format can be a string or a function that takes a record and returns a string.</div><div class=""> </div><div class=""> ``appadmin``:inxx</div><div class=""> Once a model is defined, if there are no errors, web2py creates an application administration interface to manage the database. You access it via the &quot;database administration&quot; link in the &#x27;&#x27;edit&#x27;&#x27; page or directly:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/appadmin</div><div class=""> ``:code</div><div class=""> </div><div class=""> Here is a screenshot of the **appadmin** interface:</div><div class=""> </div><div class=""> [[image @///image/en2100.png center 480px]]</div><div class=""> </div><div class=""> This interface is coded in the controller called &quot;appadmin.py&quot; and the corresponding view &quot;appadmin.html&quot;. From now on, we will refer to this interface simply as **appadmin**. It allows the administrator to insert new database records, edit and delete existing records, browse tables, and perform database joins.</div><div class=""> </div><div class=""> The first time **appadmin** is accessed, the model is executed and the tables are created. The web2py DAL translates Python code into SQL statements that are specific to the selected database back-end (SQLite in this example). You can see the generated SQL from the &#x27;&#x27;edit&#x27;&#x27; page by clicking on the &quot;sql.log&quot; link under &quot;models&quot;. Notice that the link is not present until the tables have been created.</div><div class=""> </div><div class=""> [[image @///image/en2200.png center 480px]]</div><div class=""> </div><div class=""> If you were to edit the model and access **appadmin** again, web2py would generate SQL to alter the existing tables. The generated SQL is logged into &quot;sql.log&quot;.</div><div class=""> </div><div class=""> Now go back to **appadmin** and try to insert a new image record:</div><div class=""> </div><div class=""> [[image @///image/en2300.png center 480px]]</div><div class=""> is rendered as:</div><div class=""> </div><div class=""> A handful of helpers (``INPUT``, ``TEXTAREA``, ``OPTION`` and ``SELECT``) also support some special named attributes not starting with underscore (``value``, and ``requires``). They are important for building custom forms and will be discussed later.</div><div class=""> </div><div class=""> Go back to the &#x27;&#x27;edit&#x27;&#x27; page. It now indicates that &quot;default.py exposes index&quot;. By clicking on &quot;index&quot;, you can visit the newly created page:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/index</div><div class=""> ``:code</div><div class=""> </div><div class=""> which looks like:</div><div class=""> </div><div class=""> [[image @///image/en2800.png center 480px]]</div><div class=""> </div><div class=""> If you click on the image name link, you are directed to:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/show/1</div><div class=""> ``:code</div><div class=""> </div><div class=""> and this results in an error, since you have not yet created an action called &quot;show&quot; in controller &quot;default.py&quot;.</div><div class=""> </div><div class=""> Let&#x27;s edit the &quot;default.py&quot; controller and replace its content with:</div><div class=""> </div><div class=""> ``SQLFORM``:inxx ``accepts``:inxx ``response.flash``:inxx ``request.args``:inxx</div><div class=""> ``response.download``:inxx</div><div class=""> ``</div><div class=""> def index():</div><div class="">     images = db().select(db.image.ALL, orderby=db.image.title)</div><div class="">     return dict(images=images)</div><div class=""> </div><div class=""> def show():</div><div class="">     image = db.image(request.args(0,cast=int)) or redirect(URL(&#x27;index&#x27;))</div><div class="delete">-    db.comment.image_id.default = image.id</div><div class="delete">-    form = SQLFORM(db.comment)</div><div class="">     if form.process().accepted:</div><div class="">         response.flash = &#x27;your comment is posted&#x27;</div><div class="delete">    comments = db(db.<span class="highlight">c</span>o<span class="highlight">mmen</span>t.image_id==image.id).select()</div><div class="">     return dict(image=image, comments=comments, form=form)</div><div class=""> </div><div class=""> def download():</div><div class="">     return response.download(request, db)</div><div class=""> ``:code</div><div class=""> </div><div class=""> The controller contains two actions: &quot;show&quot; and &quot;download&quot;.</div><div class=""> The &quot;show&quot; action selects the image with the ``id`` parsed from the request args and all comments related to the image. &quot;show&quot; then passes everything to the view &quot;default/show.html&quot;.</div><div class=""> </div><div class=""> The image id referenced by:</div><div class=""> ``</div><div class=""> URL(&#x27;show&#x27;, args=image.id)</div><div class=""> ``:code</div><div class=""> </div><div class=""> in &quot;default/index.html&quot;, can be accessed as:</div><div class=""> </div><div class=""> ``request.args(0,cast=int)``</div><div class=""> </div><div class=""> from the &quot;show&quot; action. The ``cast=int`` argument is optional but very important. It attempts to cast the string value passed in the PATH_INFO into an int. On failure it raise a proper exception instead of causing a ticket. One can also specify a redirect in case of failure to cast:</div><div class=""> </div><div class=""> ``request.args(0,cast=int,otherwise=URL(&#x27;error&#x27;))``</div><div class=""> </div><div class=""> Moreover ``db.image(...)`` is a shortcut for</div><div class=""> </div><div class=""> ``</div><div class=""> db(db.image.id==...).select().first()</div><div class=""> ``:code</div><div class=""> </div><div class=""> The &quot;download&quot; action expects a filename in ``request.args(0)``, builds a path to the location where that file is supposed to be, and sends it back to the client. If the file is too large, it streams the file without incurring any memory overhead.</div><div class=""> </div><div class=""> Notice the following statements:</div><div class="delete">- Line 7 creates an insert form SQLFORM for the ``db.<span class="highlight">c</span>o<span class="highlight">mmen</span>t`` table using only the specified fields.</div><div class=""> - Line 8 sets the value for the reference field, which is not part of the input form because it is not in the list of fields specified above.</div><div class="delete">- Line 9 processes the submitted form (the submitted form variables are in ``request.vars``) within the current session (the session is used to prevent double submissions, and to enforce navigation). If the submitted form variables are validated, the new comment is inserted in the ``db.<span class="highlight">commen</span>t`` table; otherwise the form is modified to include error messages (for example, if the author&#x27;s email address is invalid). This is all done in line 9!.</div><div class=""> - Line 10 is only executed if the form is accepted, after the record is inserted into the database table. ``response.flash`` is a web2py variable that is displayed in the views and used to notify the visitor that something happened.</div><div class=""> - Line 11 selects all comments that reference the current image.</div><div class=""> </div><div class=""> -------</div><div class=""> The &quot;download&quot; action is already defined in the &quot;default.py&quot; controller of the scaffolding application.</div><div class=""> -------</div><div class=""> </div><div class=""> The &quot;download&quot; action does not return a dictionary, so it does not need a view. The &quot;show&quot; action, though, should have a view, so return to **admin** and create a new view called &quot;default/show.html&quot;.</div><div class=""> </div><div class=""> Edit this new file and replace its content with the following:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Image: {{=image.title}}&lt;/h1&gt;</div><div class=""> &lt;center&gt;</div><div class=""> &lt;img width=&quot;200px&quot;</div><div class="">      src=&quot;{{=URL(&#x27;download&#x27;, args=image.file)}}&quot; /&gt;</div><div class=""> &lt;/center&gt;</div><div class=""> {{if len(comments):}}</div><div class="">   &lt;h2&gt;Comments&lt;/h2&gt;&lt;br /&gt;&lt;p&gt;</div><div class="delete">-  {{for comment in comments:}}</div><div class="delete">-    &lt;p&gt;{{=comment.author}} says &lt;i&gt;{{=comment.body}}&lt;/i&gt;&lt;/p&gt;</div><div class="">   {{pass}}&lt;/p&gt;</div><div class=""> {{else:}}</div><div class="">   &lt;h2&gt;No comments posted yet&lt;/h2&gt;</div><div class=""> {{pass}}</div><div class=""> &lt;h2&gt;Post a comment&lt;/h2&gt;</div><div class=""> {{=form}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> This view displays the **image.file** by calling the &quot;download&quot; action inside an ``&lt;img ... /&gt;`` tag.</div><div class=""> If there are comments, it loops over them and displays each one.</div><div class=""> </div><div class=""> Here is how everything will appear to a visitor.</div><div class=""> </div><div class=""> [[image @///image/en2900.png center 480px]]</div><div class=""> </div><div class=""> When a visitor submits a comment via this page, the comment is stored in the database and appended at the bottom of the page.</div><div class=""> </div><div class=""> #### Adding authentication</div><div class=""> </div><div class=""> The web2py API for Role-Based Access Control is quite sophisticated, but for now we will limit ourselves to restricting access to the show action to authenticated users, deferring a more detailed discussion to Chapter 9.</div><div class=""> </div><div class=""> To limit access to authenticated users, we need to complete three steps. In a model, for example &quot;db.py&quot;, we need to add:</div><div class=""> ``</div><div class=""> from gluon.tools import Auth</div><div class=""> auth = Auth(db)</div><div class=""> auth.define_tables(username=True)</div><div class=""> ``:code</div><div class=""> </div><div class=""> In our controller, we need to add one action:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/user/login</div><div class=""> </div><div class=""> [[image @///image/en3100.png center 480px]]</div><div class=""> </div><div class=""> The ``user`` function also exposes, among others, the following actions:</div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/user/logout</div><div class=""> http://127.0.0.1:8000/images/default/user/register</div><div class=""> http://127.0.0.1:8000/images/default/user/profile</div><div class=""> http://127.0.0.1:8000/images/default/user/change_password</div><div class=""> http://127.0.0.1:8000/images/default/user/request_reset_password</div><div class=""> http://127.0.0.1:8000/images/default/user/retrieve_username</div><div class=""> http://127.0.0.1:8000/images/default/user/retrieve_password</div><div class=""> http://127.0.0.1:8000/images/default/user/verify_email</div><div class=""> http://127.0.0.1:8000/images/default/user/impersonate</div><div class=""> http://127.0.0.1:8000/images/default/user/not_authorized</div><div class=""> ``:code</div><div class=""> </div><div class=""> Now, a first-time user needs to register in order to be able to log in and read or post comments.</div><div class=""> </div><div class=""> -------</div><div class=""> Both the ``auth`` object and the ``user`` function are already defined in the scaffolding application. The ``auth`` object is highly customizable and can deal with email verification, registration approvals, CAPTCHA, and alternate login methods via plugins.</div><div class=""> -------</div><div class=""> </div><div class=""> #### Adding grids</div><div class=""> </div><div class=""> We can improve this further using the ``SQLFORM.grid`` and ``SQLFORM.smartgrid`` gadgets to create a management interface for our application:</div><div class=""> </div><div class=""> ``</div><div class=""> @auth.requires_membership(&#x27;manager&#x27;)</div><div class=""> def manage():</div><div class="delete">    grid = SQLFORM.smartgrid(db.image,linked_tables=[&#x27;<span class="highlight">c</span>o<span class="highlight">mmen</span>t&#x27;])</div><div class="">     return dict(grid=grid)</div><div class=""> ``:code</div><div class=""> </div><div class=""> with associated &quot;views/default/manage.html&quot;</div><div class=""> </div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h2&gt;Management Interface&lt;/h2&gt;</div><div class=""> {{=grid}}</div><div class=""> ``</div><div class=""> </div><div class=""> Using appadmin create a group &quot;manager&quot; and make some users members of the group. They will not be able to access</div><div class=""> </div><div class=""> ``</div><div class=""> http://127.0.0.1:8000/images/default/manage</div><div class=""> ``</div><div class=""> </div><div class=""> and browse, search:</div><div class=""> </div><div class=""> [[image @///image/en3200.png center 480px]]</div><div class=""> </div><div class=""> create, update and delete images and their comments:</div><div class=""> </div><div class=""> [[image @///image/en3300.png center 480px]]</div><div class=""> </div><div class=""> #### Configuring the layout</div><div class=""> </div><div class=""> You can configure the default layout by editing &quot;views/layout.html&quot; but you can also configure it without editing the HTML. In fact, the &quot;static/base.css&quot; stylesheet is well documented and described in Chapter 5. You can change color, columns, size, borders and background without editing the HTML. If you want to edit the menu, the title or the subtitle, you can do so in any model file. The scaffolding app, sets default values of these parameters in the file &quot;models/menu.py&quot;:</div><div class=""> </div><div class=""> ``</div><div class=""> response.meta.keywords = &#x27;bla bla bla&#x27;</div><div class=""> response.menu = [ [ &#x27;Index&#x27;, False, URL(&#x27;index&#x27;) ] ]</div><div class=""> ``:code</div><div class=""> </div><div class=""> ### A simple wiki</div><div class=""> ``wiki``:inxx ``RSS``:inxx ``Ajax``:inxx ``XMLRPC``:inxx</div><div class=""> </div><div class=""> In this section, we build a simple wiki from scratch using only low level APIs (as opposed to using the built-in wiki capabilities of web2py demonstrated in the next section). The visitor will be able to create pages, search them (by title), and edit them. The visitor will also be able to post comments (exactly as in the previous applications), and also post documents (as attachments to the pages) and link them from the pages. As a convention, we adopt the Markmin syntax for our wiki syntax. We will also implement a search page with Ajax, an RSS feed for the pages, and a handler to search the pages via XML-RPC``xmlrpc``:cite . The following diagram lists the actions that we need to implement and the links we intend to build among them.</div><div class=""> </div><div class=""> [[yUML diagram @///image/en3400.png center 200px]]</div><div class=""> </div><div class=""> Start by creating a new scaffolding app, naming it &quot;mywiki&quot;.</div><div class=""> </div><div class=""> The model must contain three tables: page, comment, and document. Both comment and document reference page because they belong to page. A document contains a file field of type upload as in the previous images application.</div><div class=""> </div><div class=""> Here is the complete model:</div><div class=""> ``</div><div class=""> db = DAL(&#x27;sqlite://storage.sqlite&#x27;)</div><div class=""> </div><div class=""> from gluon.tools import *</div><div class=""> auth = Auth(db)</div><div class=""> auth.define_tables()</div><div class=""> crud = Crud(db)</div><div class=""> </div><div class=""> db.define_table(&#x27;page&#x27;,</div><div class="">     Field(&#x27;title&#x27;),</div><div class="">     Field(&#x27;body&#x27;, &#x27;text&#x27;),</div><div class="">     Field(&#x27;created_on&#x27;, &#x27;datetime&#x27;, default=request.now),</div><div class="">     Field(&#x27;created_by&#x27;, &#x27;reference auth_user&#x27;, default=auth.user_id),</div><div class="">     format=&#x27;%(title)s&#x27;)</div><div class=""> </div><div class="delete">db.define_table(&#x27;<span class="highlight">c</span>o<span class="highlight">mmen</span>t&#x27;,</div><div class="">     Field(&#x27;page_id&#x27;, &#x27;reference page&#x27;),</div><div class="">     Field(&#x27;body&#x27;, &#x27;text&#x27;),</div><div class="">     Field(&#x27;created_on&#x27;, &#x27;datetime&#x27;, default=request.now),</div><div class="">     Field(&#x27;created_by&#x27;, &#x27;reference auth_user&#x27;, default=auth.user_id))</div><div class=""> </div><div class=""> db.define_table(&#x27;document&#x27;,</div><div class="">     Field(&#x27;page_id&#x27;, &#x27;reference page&#x27;),</div><div class="">     Field(&#x27;name&#x27;),</div><div class="">     Field(&#x27;file&#x27;, &#x27;upload&#x27;),</div><div class="">     Field(&#x27;created_on&#x27;, &#x27;datetime&#x27;, default=request.now),</div><div class="">     Field(&#x27;created_by&#x27;, &#x27;reference auth_user&#x27;, default=auth.user_id),</div><div class="">     format=&#x27;%(name)s&#x27;)</div><div class=""> </div><div class=""> db.page.title.requires = IS_NOT_IN_DB(db, &#x27;page.title&#x27;)</div><div class=""> db.page.body.requires = IS_NOT_EMPTY()</div><div class=""> db.page.created_by.readable = db.page.created_by.writable = False</div><div class=""> db.page.created_on.readable = db.page.created_on.writable = False</div><div class=""> </div><div class="delete">-db.comment.body.requires = IS_NOT_EMPTY()</div><div class="delete">-db.comment.page_id.readable = db.comment.page_id.writable = False</div><div class="delete">-db.comment.created_by.readable = db.comment.created_by.writable = False</div><div class="delete">-db.comment.created_on.readable = db.comment.created_on.writable = False</div><div class=""> </div><div class=""> db.document.name.requires = IS_NOT_IN_DB(db, &#x27;document.name&#x27;)</div><div class=""> db.document.page_id.readable = db.document.page_id.writable = False</div><div class=""> db.document.created_by.readable = db.document.created_by.writable = False</div><div class=""> db.document.created_on.readable = db.document.created_on.writable = False</div><div class=""> ``:code</div><div class=""> </div><div class=""> Edit the controller &quot;default.py&quot; and create the following actions:</div><div class=""> - index: list all wiki pages</div><div class=""> - create: post another wiki page</div><div class=""> - show: show a wiki page and its comments, and append comments</div><div class=""> - edit: edit an existing page</div><div class=""> - documents: manage the documents attached to a page</div><div class=""> - download: download a document (as in the images example)</div><div class=""> - search: display a search box and, via an Ajax callback, return all matching titles as the visitor types</div><div class=""> - callback: the Ajax callback function. It returns the HTML that gets embedded in the search page while the visitor types.</div><div class=""> </div><div class=""> Here is the &quot;default.py&quot; controller:</div><div class=""> ``</div><div class=""> def index():</div><div class="">      &quot;&quot;&quot; this controller returns a dictionary rendered by the view</div><div class="">          it lists all wiki pages</div><div class="">      &gt;&gt;&gt; index().has_key(&#x27;pages&#x27;)</div><div class="">      True</div><div class="">      &quot;&quot;&quot;</div><div class="">      pages = db().select(db.page.id,db.page.title,orderby=db.page.title)</div><div class="">      return dict(pages=pages)</div><div class=""> </div><div class=""> @auth.requires_login()</div><div class=""> def create():</div><div class="">      &quot;creates a new empty wiki page&quot;</div><div class="">      form = SQLFORM(db.page).process(next=URL(&#x27;index&#x27;))</div><div class="">      return dict(form=form)</div><div class=""> </div><div class=""> def show():</div><div class="">      &quot;shows a wiki page&quot;</div><div class="">      this_page = db.page(request.args(0,cast=int)) or redirect(URL(&#x27;index&#x27;))</div><div class="delete">-     db.comment.page_id.default = this_page.id</div><div class="delete">-     form = SQLFORM(db.comment).process() if auth.user else None</div><div class="delete">-     pagecomments = db(db.comment.page_id==this_page.id).select()</div><div class="">      return dict(page=this_page, comments=pagecomments, form=form)</div><div class=""> </div><div class=""> @auth.requires_login()</div><div class=""> def edit():</div><div class="">      &quot;edit an existing wiki page&quot;</div><div class="">      this_page = db.page(request.args(0,cast=int)) or redirect(URL(&#x27;index&#x27;))</div><div class="">      form = SQLFORM(db.page, this_page).process(</div><div class="">          next = URL(&#x27;show&#x27;,args=request.args))</div><div class="">      return dict(form=form)</div><div class=""> </div><div class=""> @auth.requires_login()</div><div class=""> def documents():</div><div class="">      &quot;browser, edit all documents attached to a certain page&quot;</div><div class="">      page = db.page(request.args(0,cast=int)) or redirect(URL(&#x27;index&#x27;))</div><div class="">      db.document.page_id.default = page.id</div><div class="">      db.document.page_id.writable = False</div><div class="">      grid = SQLFORM.grid(db.document.page_id==page.id,args=[page.id])</div><div class="">      return dict(page=page, grid=grid)</div><div class=""> </div><div class=""> def user():</div><div class="">      return dict(form=auth())</div><div class=""> </div><div class=""> def download():</div><div class="">      &quot;allows downloading of documents&quot;</div><div class="">      return response.download(request, db)</div><div class=""> </div><div class=""> def search():</div><div class="">      &quot;an ajax wiki search page&quot;</div><div class="">      return dict(form=FORM(INPUT(_id=&#x27;keyword&#x27;,_name=&#x27;keyword&#x27;,</div><div class="">               _onkeyup=&quot;ajax(&#x27;callback&#x27;, [&#x27;keyword&#x27;], &#x27;target&#x27;);&quot;)),</div><div class=""> Here is the code for the view &quot;default/create.html&quot;:</div><div class=""> </div><div class=""> If you visit the **create** page, you see the following:</div><div class=""> </div><div class=""> [[image @///image/en3500.png center 480px]]</div><div class=""> </div><div class=""> Here is the code for the view &quot;default/index.html&quot;:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;Available wiki pages&lt;/h1&gt;</div><div class=""> [ {{=A(&#x27;search&#x27;, _href=URL(&#x27;search&#x27;))}} ]&lt;br /&gt;</div><div class=""> &lt;ul&gt;{{for page in pages:}}</div><div class="">      {{=LI(A(page.title, _href=URL(&#x27;show&#x27;, args=page.id)))}}</div><div class=""> {{pass}}&lt;/ul&gt;</div><div class=""> [ {{=A(&#x27;create page&#x27;, _href=URL(&#x27;create&#x27;))}} ]</div><div class=""> ``:code</div><div class=""> </div><div class=""> It generates the following page:</div><div class=""> </div><div class=""> [[image @///image/en3600.png center 480px]]</div><div class=""> </div><div class=""> Here is the code for the view &quot;default/show.html&quot;:</div><div class=""> </div><div class=""> ``markdown``:inxx ``MARKMIN``:inxx</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h1&gt;{{=page.title}}&lt;/h1&gt;</div><div class=""> [ {{=A(&#x27;edit&#x27;, _href=URL(&#x27;edit&#x27;, args=request.args))}}</div><div class=""> | {{=A(&#x27;documents&#x27;, _href=URL(&#x27;documents&#x27;, args=request.args))}} ]&lt;br /&gt;</div><div class=""> {{=MARKMIN(page.body)}}</div><div class=""> &lt;h2&gt;Comments&lt;/h2&gt;</div><div class="delete">-{{for comment in comments:}}</div><div class="delete">-  &lt;p&gt;{{=db.auth_user[comment.created_by].first_name}} on {{=comment.created_on}}</div><div class="delete">-          says &lt;I&gt;{{=comment.body}}&lt;/i&gt;&lt;/p&gt;</div><div class=""> {{pass}}</div><div class=""> &lt;h2&gt;Post a comment&lt;/h2&gt;</div><div class=""> {{=form}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> If you wish to use markdown syntax instead of markmin syntax:</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.contrib.markdown import WIKI</div><div class=""> ``:code</div><div class=""> </div><div class=""> and use ``WIKI`` instead of the ``MARKMIN`` helper.</div><div class=""> Alternatively, you can choose to accept raw HTML instead of markmin syntax. In this case you would replace:</div><div class=""> ``</div><div class=""> {{=MARKMIN(page.body)}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> with:</div><div class=""> ``</div><div class=""> {{=XML(page.body)}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> ``sanitize``:inxx</div><div class=""> (so that the XML does not get escaped, as by default web2py behavior).</div><div class=""> </div><div class=""> This can be done better with:</div><div class=""> ``</div><div class=""> {{=XML(page.body, sanitize=True)}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> If you fix the divide-by-zero bug in the index action and introduce one in the i</div><div class=""> {{1/0}}</div><div class=""> {{=LI(A(image.title, _href=URL(&quot;show&quot;, args=image.id)))}}</div><div class=""> {{pass}}</div><div class=""> &lt;/ul&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> you get the following ticket:</div><div class=""> </div><div class=""> [[image @///image/en5000.png center 480px]]</div><div class=""> </div><div class=""> Note that web2py has converted the view from HTML into a Python file, and the error described in the ticket refers to the generated Python code and NOT to the original view file:</div><div class=""> </div><div class=""> [[image @///image/en5100.png center 480px]]</div><div class=""> </div><div class=""> This may seem confusing at first, but in practice it makes debugging easier, because the Python indentation highlights the logical structure of the code that you embedded in the views.</div><div class=""> </div><div class=""> The code is shown at the bottom of the same page.</div><div class=""> </div><div class=""> All tickets are listed under admin in the &#x27;&#x27;errors&#x27;&#x27; page for each application:</div><div class=""> </div><div class=""> [[image @///image/en5200.png center 480px]]</div><div class=""> </div><div class=""> #### Mercurial</div><div class=""> ``Mercurial``:inxx</div><div class=""> </div><div class=""> If you are running from source and you have the Mercurial version control libraries installed:</div><div class=""> ``</div><div class=""> easy_install mercurial</div><div class=""> ``:code</div><div class=""> </div><div class="delete">then the administrative interface shows one more menu item called &quot;Versioning&quot;. It automatically creates a local Mercurial repository for the application. Pressing the &quot;comm<span class="highlight">i</span>t&quot; button in the page will commit the current application. Mercurial creates and stores information about changes you make in your code into a hidden folder &quot;.hg&quot; in your app subfolder. Every app has its own &quot;.hg&quot; folder and its own &quot;.hgignore&quot; file (tells Mercurial which files to ignore).</div><div class=""> </div><div class=""> The Mercurial web interface does allow you to browse previous commit and diff files but we do recommend you use Mercurial directly from the shell or one of the many GUI-based Mercurial clients since they are more powerful. For example they will allow you sync your app with a remote source repository:</div><div class=""> </div><div class=""> [[images @///image/en5300.png center 480px]]</div><div class=""> </div><div class=""> </div><div class=""> You can read more about Mercurial here:</div><div class=""> ``</div><div class=""> http://mercurial.selenic.com/</div><div class=""> ``</div><div class=""> </div><div class=""> #### Application Wizard (experimental)</div><div class=""> </div><div class=""> The **admin** interface includes a Wizard that can help you create a new applications.</div><div class=""> You can access the wizard from the &quot;sites&quot; page as shown in the image below.</div><div class=""> </div><div class=""> [[image @///image/en5400.png center 480px]]</div><div class=""> </div><div class=""> The wizard will guide you through a series of steps involved in creating a new application:</div><div class=""> </div><div class=""> - Chose a name for the application</div><div class=""> - Configure the application and choose required plugins</div><div class=""> - Build required models (it will create CRUD pages for each model)</div><div class=""> - Allow you to edit the views of those pages using MARKMIN syntax</div><div class=""> </div><div class=""> The image below shows the second step of the process.</div><div class=""> </div><div class=""> [[image @///image/en5500.png center 480px]]</div><div class=""> </div><div class=""> You can see a dropdown to select a layout plugin (from ``web2py.com/layouts``), a multiple choice dropdown to check other plugins (from ``web2py.com/plugins``) and a &quot;login config&quot; field where to put the Janrain &quot;domain:key&quot;.</div><div class=""> In multi user mode, you can register students using the &quot;bulk register&quot; link in</div><div class=""> </div><div class=""> Mind that this mechanism still assumes all users are trusted. All the apps created under admin run under the same credentials on the same filesystem. It is possible for an app created by a student to access the data and the source of an app created by another student. It is also possible for a student to create an app that locks the server.</div><div class=""> </div><div class=""> #### Mobile **admin**</div><div class=""> </div><div class=""> Notice that the admin application includes &quot;plugin_jqmodile&quot; which packages jQuery Mobile. When admin is accessed from a mobile devide, this is detected by web2py and the interface is displayed using a mobile friendly layout.</div><div class=""> </div><div class=""> ### More on **appadmin**</div><div class=""> </div><div class=""> ``appadmin``:inxx</div><div class=""> </div><div class=""> **appadmin** is not intended to be exposed to the public. It is designed to help you by providing an easy access to the database. It consists of only two files: a controller &quot;appadmin.py&quot; and a view &quot;appadmin.html&quot; which are used by all actions in the controller.</div><div class=""> </div><div class=""> The **appadmin** controller is relatively small and readable; it provides an example of designing a database interface.</div><div class=""> </div><div class=""> **appadmin** shows which databases are available and which tables exist in each database. You can insert records and list all records for each table individually. **appadmin** paginates output 100 records at a time.</div><div class=""> </div><div class=""> Once a set of records is selected, the header of the pages changes, allowing you to update or delete the selected records.</div><div class=""> </div><div class=""> To update the records, enter an SQL assignment in the Query string field:</div><div class=""> ``</div><div class=""> title = &#x27;test&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class=""> where string values must be enclosed in single quotes. Multiple fields can be separated by commas.</div><div class=""> </div><div class=""> To delete a record, click the corresponding checkbox to confirm that you are sure.</div><div class=""> </div><div class=""> **appadmin** can also perform joins if the SQL FILTER contains a SQL condition that involves two or more tables. For example, try:</div><div class=""> ``</div><div class="delete">db.image.id == db.<span class="highlight">c</span>o<span class="highlight">mmen</span>t.image_id</div><div class=""> ``:code</div></div></div>
</div>
<hr />


        
      </div>

      <div id="push"></div>
    </div>

    <div id="footer">
      <div class="container-fluid">
          <div class="copyright pull-left">Copyright &#169; 2013</div>
          <div id="poweredBy" class="pull-right">
              Powered by
              <a href="http://www.web2py.com/">web2py</a>
          </div>
      </div>
    </div>
<script src="static/js/bootstrap.min.js"></script>
<script src="static/js/web2py_bootstrap.js"></script>
</body>
</html>
