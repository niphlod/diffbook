<!DOCTYPE html>
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7]><html class="ie ie6 ie-lte9 ie-lte8 ie-lte7 no-js" lang="en-us"> <![endif]-->
<!--[if IE 7]><html class="ie ie7 ie-lte9 ie-lte8 ie-lte7 no-js" lang="en-us"> <![endif]-->
<!--[if IE 8]><html class="ie ie8 ie-lte9 ie-lte8 no-js" lang="en-us"> <![endif]-->
<!--[if IE 9]><html class="ie9 ie-lte9 no-js" lang="en-us"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html class="no-js" lang="en-us"> <!--<![endif]-->
<head>
  <meta charset="utf-8" />
  <!-- www.phpied.com/conditional-comments-block-downloads/ -->
  <!-- Always force latest IE rendering engine
       (even in intranet) & Chrome Frame
       Remove this if you use the .htaccess -->
  <!--[if IE]>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <![endif]-->

  <title>Diffbook</title>

  <!-- http://dev.w3.org/html5/markup/meta.name.html -->
  <meta name="application-name" content="diffbook" />

  <!-- Speaking of Google, don't forget to set your site up:
       http://google.com/webmasters -->
  <meta name="google-site-verification" content="" />

  <!--  Mobile Viewport Fix
        j.mp/mobileviewport & davidbcalhoun.com/2010/viewport-metatag
        device-width: Occupy full width of the screen in its current orientation
        initial-scale = 1.0 retains dimensions instead of zooming out if page height > device height
        user-scalable = yes allows the user to zoom in -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="shortcut icon" href="static/images/favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" href="static/images/favicon.png">

  <!-- All JavaScript at the bottom, except for Modernizr which enables
       HTML5 elements & feature detects -->
  <script src="static/js/modernizr.custom.js"></script>

  <!-- include stylesheets -->
  

  <script type="text/javascript"><!--
    // These variables are used by the web2py_ajax_init function in web2py_ajax.js (which is loaded below).
    var w2p_ajax_confirm_message = "Are you sure you want to delete this object?";
    var w2p_ajax_date_format = "%Y-%m-%d";
    var w2p_ajax_datetime_format = "%Y-%m-%d %H:%M:%S";
    //--></script>
<meta name="keywords" content="web2py, python, framework" />

<meta name="description" content="a cool new app" />

<meta name="generator" content="Web2py Web Framework" />

<meta name="author" content="Your Name &lt;you@example.com&gt;" />
<script src="static/js/jquery.js" type="text/javascript"></script><link href="static/css/calendar.css" rel="stylesheet" type="text/css" /><script src="static/js/calendar.js" type="text/javascript"></script><script src="static/js/web2py.js" type="text/javascript"></script><link href="static/css/web2py.css" rel="stylesheet" type="text/css" /><link href="static/css/bootstrap.min.css" rel="stylesheet" type="text/css" /><link href="static/css/bootstrap-responsive.min.css" rel="stylesheet" type="text/css" /><link href="static/css/web2py_bootstrap.css" rel="stylesheet" type="text/css" />


  

  <!-- uncomment here to load jquery-ui
       <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/themes/base/jquery-ui.css" type="text/css" media="all" />
       <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js" type="text/javascript"></script>
       uncomment to load jquery-ui //-->
  <noscript><link href="static/css/web2py_bootstrap_nojs.css" rel="stylesheet" type="text/css" /></noscript>
  
  <style type="text/css">

      /* Sticky footer styles
      -------------------------------------------------- */

      html,
      body {
        height: 100%;
        /* The html and body elements cannot have any padding or margin. */
      }

      /* Wrapper for page content to push down footer */
      #wrap {
        min-height: 100%;
        height: auto !important;
        height: 100%;
        /* Negative indent footer by it's height */
        margin: 0 auto -60px;
      }

      /* Set the fixed height of the footer here */
      #push,
      #footer {
        height: 60px;
      }
      #footer {
        background-color: #f5f5f5;
      }

      /* Lastly, apply responsive CSS fixes as necessary */
      @media (max-width: 767px) {
        #footer {
          margin-left: -20px;
          margin-right: -20px;
          padding-left: 20px;
          padding-right: 20px;
        }
      }



      /* Custom page CSS
      -------------------------------------------------- */
      /* Not required for template or sticky footer method. */

      .container {
        width: auto;
        max-width: 680px;
      }
      .container .credit {
        margin: 20px 0;
      }

    </style>
</head>

<body>
  
  <body>


    <!-- Part 1: Wrap all page content here -->
    <div id="wrap">

      <!-- Begin page content -->
      <div class="container-fluid">
        <div class="page-header">
          	<h1>
              Diffbook
              <small>easy? diffbook</small>
            </h1>
        </div>
        
        


<div class="pagination">
  <ul>

      <li><a href="/diffbook/0.html">Chapter 0</a></li>

      <li><a href="/diffbook/1.html">Chapter 1</a></li>

      <li><a href="/diffbook/2.html">Chapter 2</a></li>

      <li><a href="/diffbook/3.html">Chapter 3</a></li>

      <li><a href="/diffbook/4.html">Chapter 4</a></li>

      <li><a href="/diffbook/5.html">Chapter 5</a></li>

      <li><a href="/diffbook/6.html">Chapter 6</a></li>

      <li><a href="/diffbook/7.html">Chapter 7</a></li>

      <li><a href="/diffbook/8.html">Chapter 8</a></li>

      <li><a href="/diffbook/9.html">Chapter 9</a></li>

      <li><a href="/diffbook/10.html">Chapter 10</a></li>

      <li><a href="/diffbook/11.html">Chapter 11</a></li>

      <li><a href="/diffbook/12.html">Chapter 12</a></li>

  </ul>
</div>

<div class="pagination">
  <ul>

      <li><a href="#com_e8428580c4f1c39b457a9b9614f3ccd14f6b3fb5">e842858</a></li>

      <li><a href="#com_c877880cf4b1b62260c1d2fc817ce0c02b6a29a1">c877880</a></li>

      <li><a href="#com_4554a3f1098bc968b8595d3b90640c9464a07135">4554a3f</a></li>

      <li><a href="#com_f74941a5a1e849459f1fbea6dc9a2861e40e419a">f74941a</a></li>

      <li><a href="#com_d9fb0f6b2ee04c7256f280df7821ef0f99adbc91">d9fb0f6</a></li>

      <li><a href="#com_7bce1473ce90f4e60f49d72bf1b61d32f430cb54">7bce147</a></li>

      <li><a href="#com_f2fd41dd2a0d4bf68f5cd4f0989fb32bdc35eac5">f2fd41d</a></li>

      <li><a href="#com_8ec972820c26ac5695a72b3b0d93e1422449853e">8ec9728</a></li>

      <li><a href="#com_e234f6edf67361b3ba718ea10184ba8e7c2f773d">e234f6e</a></li>

      <li><a href="#com_eaaa0e14bf17cdc4d0edd2ea9daa9af5f3484c09">eaaa0e1</a></li>

      <li><a href="#com_097d699dc16179206ccb7e4aee863d6523cd471c">097d699</a></li>

      <li><a href="#com_bb5fb21852c40f3b628510ef0be7a07d53cf4f9d">bb5fb21</a></li>

      <li><a href="#com_885e6c33d6165e8cccf89b33130de7a03534b119">885e6c3</a></li>

      <li><a href="#com_ec3132989d6a44efafb59155ad3a3f06df599ec7">ec31329</a></li>

      <li><a href="#com_716473666742d68f3ed66204eb0682e076e90b99">7164736</a></li>

      <li><a href="#com_49f38ab7ef56de1eb4ef48f68427ebf8a46b505d">49f38ab</a></li>

  </ul>
</div>



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/e8428580c4f1c39b457a9b9614f3ccd14f6b3fb5">e842858</a><ul><li>Date : 2012-12-18</li><li>fixed Mail.Attachment-&gt;mail.Attachment, thanks Nick</li></ul></li></ul>
<div class="row-fluid" id="com_e8428580c4f1c39b457a9b9614f3ccd14f6b3fb5">
    <div class="span6"><div class="diff"><div class=""> ``</div><div class=""> mail.send(&#x27;you@example.com&#x27;,</div><div class="">   &#x27;Message subject&#x27;,</div><div class="">   &#x27;&lt;html&gt;&lt;img src=&quot;cid:photo&quot; /&gt;&lt;/html&gt;&#x27;,</div><div class="insert">  attachments = <span class="highlight">m</span>ail.Attachment(&#x27;/path/to/photo.jpg&#x27;, content_id=&#x27;photo&#x27;))</div><div class=""> ``:code</div><div class=""> </div><div class=""> #### Multiple attachments</div><div class=""> </div><div class=""> ``</div><div class=""> mail.send(&#x27;you@example.com&#x27;,</div><div class="">   &#x27;Message subject&#x27;,</div><div class="">   &#x27;Message body&#x27;,</div><div class="insert">+  attachments = [mail.Attachment(&#x27;/path/to/fist.file&#x27;),</div><div class="insert">+                 mail.Attachment(&#x27;/path/to/second.file&#x27;)])</div><div class=""> ``:code</div></div></div>
    <div class="span6"><div class="diff"><div class=""> ``</div><div class=""> mail.send(&#x27;you@example.com&#x27;,</div><div class="">   &#x27;Message subject&#x27;,</div><div class="">   &#x27;&lt;html&gt;&lt;img src=&quot;cid:photo&quot; /&gt;&lt;/html&gt;&#x27;,</div><div class="delete">  attachments = <span class="highlight">M</span>ail.Attachment(&#x27;/path/to/photo.jpg&#x27;, content_id=&#x27;photo&#x27;))</div><div class=""> ``:code</div><div class=""> </div><div class=""> #### Multiple attachments</div><div class=""> </div><div class=""> ``</div><div class=""> mail.send(&#x27;you@example.com&#x27;,</div><div class="">   &#x27;Message subject&#x27;,</div><div class="">   &#x27;Message body&#x27;,</div><div class="delete">-  attachments = [Mail.Attachment(&#x27;/path/to/fist.file&#x27;),</div><div class="delete">-                 Mail.Attachment(&#x27;/path/to/second.file&#x27;)])</div><div class=""> ``:code</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/c877880cf4b1b62260c1d2fc817ce0c02b6a29a1">c877880</a><ul><li>Date : 2013-01-26</li><li>fixed pgp, thanks Martin</li></ul></li></ul>
<div class="row-fluid" id="com_c877880cf4b1b62260c1d2fc817ce0c02b6a29a1">
    <div class="span6"><div class="diff"><div class="insert">+It is possible to send PGP encrypted emails. First of all you need to install the python-pyme package. Then you can use GnuPG (GPG) to create the key-files for the sender (take the email-address from mail.settings.sender) and put the files pubring.gpg and  secring.gpg in a directory (e.g. &quot;/home/www-data/.gnupg&quot;).</div><div class="insert">+</div><div class="insert">+Use the following settings:</div><div class="insert">+</div><div class=""> ``</div><div class="insert"><span class="highlight"></span>m<span class="highlight">ail.settings.</span>gpg<span class="highlight">_ho</span>me <span class="highlight">= &#x27;/ho</span>m<span class="highlight">e/www-da</span>t<span class="highlight">a/.gnu</span>pg<span class="highlight">/&#x27;</span></div><div class=""> mail.settings.cipher_type = &#x27;gpg&#x27;</div><div class=""> mail.settings.sign = True</div><div class=""> mail.settings.sign_passphrase = &#x27;your passphrase&#x27;</div><div class=""> mail.settings.encrypt = True</div><div class=""> ``:code</div><div class=""> </div><div class=""> ### Sending emails</div><div class=""> ``mail.send``:inxx ``email html``:inxx ``email attachments``:inxx</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">-It is possible to send PGP encrypted emails using the following settings:</div><div class=""> ``</div><div class="delete"><span class="highlight">fro</span>m<span class="highlight"> </span>gpg<span class="highlight"></span>me <span class="highlight">i</span>m<span class="highlight">por</span>t<span class="highlight"> </span>pg<span class="highlight">p</span></div><div class=""> mail.settings.cipher_type = &#x27;gpg&#x27;</div><div class=""> mail.settings.sign = True</div><div class=""> mail.settings.sign_passphrase = &#x27;your passphrase&#x27;</div><div class=""> mail.settings.encrypt = True</div><div class=""> ``:code</div><div class=""> </div><div class="delete">-The latter requires the python-pyme package.</div><div class="delete">-</div><div class=""> ### Sending emails</div><div class=""> ``mail.send``:inxx ``email html``:inxx ``email attachments``:inxx</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/4554a3f1098bc968b8595d3b90640c9464a07135">4554a3f</a><ul><li>Date : 2012-09-16</li><li>pool_size option</li></ul></li></ul>
<div class="row-fluid" id="com_4554a3f1098bc968b8595d3b90640c9464a07135">
    <div class="span6"><div class="diff"><div class=""> ``</div><div class=""> # Replace user, password, server and port in the connection string</div><div class=""> # Set port as 993 for ssl support</div><div class="insert">imapdb = DAL(&quot;imap://user:password@server:port&quot;<span class="highlight">, pool_size=1</span>)</div><div class=""> imapdb.define_tables()</div><div class=""> ``:code</div></div></div>
    <div class="span6"><div class="diff"><div class=""> ``</div><div class=""> # Replace user, password, server and port in the connection string</div><div class=""> # Set port as 993 for ssl support</div><div class="delete">imapdb = DAL(&quot;imap://user:password@server:port&quot;<span class="highlight"></span>)</div><div class=""> imapdb.define_tables()</div><div class=""> ``:code</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/f74941a5a1e849459f1fbea6dc9a2861e40e419a">f74941a</a><ul><li>Date : 2013-01-08</li><li>Added documentation on mail.settings.tls</li></ul></li></ul>
<div class="row-fluid" id="com_f74941a5a1e849459f1fbea6dc9a2861e40e419a">
    <div class="span6"><div class="diff"><div class=""> You need to replace the mail.settings with the proper parameters for your SMTP server. Set ``mail.settings.login = None`` if the SMTP server does not require authentication.</div><div class="insert">+If you don&#x27;t want to use TLS, set ``mail.settings.tls = False``</div></div></div>
    <div class="span6"><div class="diff"><div class=""> You need to replace the mail.settings with the proper parameters for your SMTP server. Set ``mail.settings.login = None`` if the SMTP server does not require authentication.</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/d9fb0f6b2ee04c7256f280df7821ef0f99adbc91">d9fb0f6</a><ul><li>Date : 2012-10-05</li><li>The first can be useful</li></ul></li></ul>
<div class="row-fluid" id="com_d9fb0f6b2ee04c7256f280df7821ef0f99adbc91">
    <div class="span6"><div class="diff"><div class="insert">The <span class="highlight">fir</span>s<span class="highlight">t</span> can be useful to retrieve imap query sets by the native email service mailbox</div><div class=""> ``</div><div class=""> # mailbox is a string containing the actual mailbox name</div><div class=""> tablenames = dict([(v,k) for k,v in imapdb.mailboxes.items()])</div><div class="insert">myset = imapdb(imapdb[tablename<span class="highlight">s[mailbox]</span>])</div><div class=""> ``:code</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">-</div><div class="delete">The <span class="highlight"></span>s<span class="highlight">econd</span> can be useful to retrieve imap query sets by the native email service mailbox</div><div class=""> ``</div><div class=""> # mailbox is a string containing the actual mailbox name</div><div class=""> tablenames = dict([(v,k) for k,v in imapdb.mailboxes.items()])</div><div class="delete">-tablename = tablenames[mailbox]</div><div class="delete">myset = imapdb(imapdb[tablename<span class="highlight"></span>])</div><div class=""> ``:code</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/7bce1473ce90f4e60f49d72bf1b61d32f430cb54">7bce147</a><ul><li>Date : 2012-12-22</li><li>scheduler.queue_task</li></ul></li></ul>
<div class="row-fluid" id="com_7bce1473ce90f4e60f49d72bf1b61d32f430cb54">
    <div class="span6"><div class="diff"><div class="insert">+## Emails and SMS</div><div class="insert">+</div><div class=""> ``Mail``:inxx</div><div class=""> </div><div class=""> ### Setting up email</div><div class=""> </div><div class=""> Web2py provides the ``gluon.tools.Mail`` class to make it easy to send emails using web2py. One can define a mailer with</div><div class=""> ``</div><div class=""> from gluon.tools import Mail</div><div class=""> mail = Mail()</div><div class=""> mail.settings.server = &#x27;smtp.example.com:25&#x27;</div><div class=""> mail.settings.sender = &#x27;you@example.com&#x27;</div><div class=""> mail.settings.login = &#x27;username:password&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class=""> Note, if your application uses ``Auth`` (discussed in the next chapter), the ``auth`` object will include its own mailer in ``auth.settings.mailer``, so you can use that instead as follows:</div><div class=""> ``</div><div class=""> mail = auth.settings.mailer</div><div class=""> mail.settings.server = &#x27;smtp.example.com:25&#x27;</div><div class=""> mail.settings.sender = &#x27;you@example.com&#x27;</div><div class=""> mail.settings.login = &#x27;username:password&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class=""> You need to replace the mail.settings with the proper parameters for your SMTP server. Set ``mail.settings.login = None`` if the SMTP server does not require authentication.</div><div class=""> </div><div class=""> ``email logging``:inxx</div><div class=""> </div><div class=""> --------</div><div class=""> For debugging purposes you can set</div><div class=""> ``</div><div class=""> mail.settings.server = &#x27;logging&#x27;</div><div class=""> ``:code</div><div class=""> and emails will not be sent but logged to the console instead.</div><div class=""> -------</div><div class=""> </div><div class=""> #### Configuring email for Google App Engine</div><div class=""> ``email from GAE``:inxx</div><div class=""> For sending emails from Google App Engine account:</div><div class=""> </div><div class=""> ``</div><div class=""> mail.settings.server = &#x27;gae&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class="insert">At the time of writing web2py does not support attachments and encrypted emails on Google App Engine.<span class="highlight"> Notice cron and scheduler do not work on GAE.</span></div></div></div>
    <div class="span6"><div class="diff"><div class="delete">-## Email and SMS</div><div class=""> ``Mail``:inxx</div><div class=""> </div><div class=""> ### Setting up email</div><div class=""> </div><div class=""> Web2py provides the ``gluon.tools.Mail`` class to make it easy to send emails using web2py. One can define a mailer with</div><div class=""> ``</div><div class=""> from gluon.tools import Mail</div><div class=""> mail = Mail()</div><div class=""> mail.settings.server = &#x27;smtp.example.com:25&#x27;</div><div class=""> mail.settings.sender = &#x27;you@example.com&#x27;</div><div class=""> mail.settings.login = &#x27;username:password&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class=""> Note, if your application uses ``Auth`` (discussed in the next chapter), the ``auth`` object will include its own mailer in ``auth.settings.mailer``, so you can use that instead as follows:</div><div class=""> ``</div><div class=""> mail = auth.settings.mailer</div><div class=""> mail.settings.server = &#x27;smtp.example.com:25&#x27;</div><div class=""> mail.settings.sender = &#x27;you@example.com&#x27;</div><div class=""> mail.settings.login = &#x27;username:password&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class=""> You need to replace the mail.settings with the proper parameters for your SMTP server. Set ``mail.settings.login = None`` if the SMTP server does not require authentication.</div><div class=""> </div><div class=""> ``email logging``:inxx</div><div class=""> </div><div class=""> --------</div><div class=""> For debugging purposes you can set</div><div class=""> ``</div><div class=""> mail.settings.server = &#x27;logging&#x27;</div><div class=""> ``:code</div><div class=""> and emails will not be sent but logged to the console instead.</div><div class=""> -------</div><div class=""> </div><div class=""> #### Configuring email for Google App Engine</div><div class=""> ``email from GAE``:inxx</div><div class=""> For sending emails from Google App Engine account:</div><div class=""> </div><div class=""> ``</div><div class=""> mail.settings.server = &#x27;gae&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class="delete">At the time of writing web2py does not support attachments and encrypted emails on Google App Engine.<span class="highlight"></span></div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/f2fd41dd2a0d4bf68f5cd4f0989fb32bdc35eac5">f2fd41d</a><ul><li>Date : 2012-12-31</li><li>spell check of diffs, thanks Joanthan</li></ul></li></ul>
<div class="row-fluid" id="com_f2fd41dd2a0d4bf68f5cd4f0989fb32bdc35eac5">
    <div class="span6"><div class="diff"><div class="insert">For a single mail account, this is the code recommended to start <span class="highlight">IMAP</span> support at the app&#x27;s model</div><div class=""> </div><div class=""> ``</div><div class=""> # Replace user, password, server and port in the connection string</div><div class="insert"># Set port as 993 for <span class="highlight">SSL</span> support</div><div class=""> imapdb = DAL(&quot;imap://user:password@server:port&quot;, pool_size=1)</div><div class=""> imapdb.define_tables()</div><div class=""> ``:code</div><div class=""> </div><div class="insert">Note that ``&lt;imapdb&gt;.define_tables()`` returns a dictionary of strings mapping <span class="highlight">DAL</span> tablenames to the server mailbox names with the structure ``{&lt;tablename&gt;: &lt;server mailbox name&gt;, ...}``, so you can get the actual mailbox name in the IMAP server.</div><div class=""> </div><div class=""> </div><div class=""> To handle the different native mailbox names for the user interface,  the following attributes give access to the adapter auto mailbox mapped names (which native mailbox has what table name and vice versa):</div><div class=""> </div><div class=""> -------------------------------------</div><div class=""> **Attribute** | **Type** | **Format**</div><div class=""> imapdb.mailboxes | dict | ``{&lt;tablename&gt;: &lt;server native name&gt;, ...}``</div><div class=""> imapdb.&lt;table&gt;.mailbox | string | ``&quot;server native name&quot;``</div><div class=""> -------------------------------------</div><div class=""> </div><div class="insert">The first can be useful to retrieve <span class="highlight">IMAP</span> query sets by the native email service mailbox</div><div class=""> ``</div><div class=""> # mailbox is a string containing the actual mailbox name</div><div class=""> tablenames = dict([(v,k) for k,v in imapdb.mailboxes.items()])</div><div class=""> myset = imapdb(imapdb[tablenames[mailbox]])</div><div class=""> ``:code</div><div class=""> </div><div class=""> #### Fetching mail and updating flags</div><div class=""> </div><div class="insert">Here&#x27;s a list of <span class="highlight">IMAP</span> commands you could use in the controller. For the examples, it&#x27;s assumed that your <span class="highlight">IMAP</span> service has a mailbox named ``INBOX``, which is the case for Gmail(r) accounts.</div><div class=""> </div><div class=""> </div><div class=""> To count today&#x27;s unseen messages smaller than 6000 octets from the inbox mailbox do</div><div class=""> ``</div><div class=""> q = imapdb.INBOX.seen == False</div><div class=""> q &amp;= imapdb.INBOX.created == datetime.date.today()</div><div class=""> q &amp;= imapdb.INBOX.size &lt; 6000</div><div class=""> unread = imapdb(q).count()</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> You can fetch the previous query messages with</div><div class=""> ``</div><div class=""> rows = imapdb(q).select()</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> Usual query operators are implemented, including belongs</div><div class=""> </div><div class=""> ``</div><div class=""> messages = imapdb(imapdb.INBOX.uid.belongs(&lt;uid sequence&gt;)).select()</div><div class=""> ``:code</div><div class=""> </div><div class="insert">**Note**: It&#x27;s strongly advi<span class="highlight">s</span>ed that you keep the query results below a given data size threshold to avoid jamming the server with large select commands. As of now, the messages are retrieved entirely by the adapter before any filter by field can be applied.</div><div class=""> </div><div class=""> It is possible to filter query select results with limitby and sequences of mailbox fields</div><div class=""> ``</div><div class=""> # Replace the arguments with actual values</div><div class=""> myset.select(&lt;fields sequence&gt;, limitby=(&lt;int&gt;, &lt;int&gt;))</div><div class=""> ``:code</div><div class=""> </div><div class=""> Say you want to have an app action show a mailbox message. First we retrieve the message (If your IMAP service supports it, fetch messages by ``uid`` field to avoid using old sequence references).</div><div class=""> </div><div class=""> ``</div><div class=""> mymessage = imapdb(imapdb.INBOX.uid == &lt;uid&gt;).select().first()</div><div class=""> ``:code</div><div class=""> </div><div class=""> Otherwise, you can use the message&#x27;s ``id``.</div><div class=""> </div><div class=""> ``</div><div class=""> mymessage = imapdb.INBOX[&lt;id&gt;]</div><div class=""> ``:code</div><div class=""> </div><div class="insert">Note that using the message&#x27;s id as reference is not recommended, because sequence numbers can change with mailbox ma<span class="highlight">inte</span>nance operations as message deletions. If you still want to record references to messages (i.e. in another database&#x27;s record field), the solution is to use the uid field as reference whenever supported, and retrieve each message with the recorded value.</div><div class=""> </div><div class=""> Finally, add something like the following to show the message content in a view</div><div class=""> </div><div class=""> ``</div><div class=""> {{=P(T(&quot;Message from&quot;), &quot; &quot;, mymessage.sender)}}</div><div class=""> {{=P(T(&quot;Received on&quot;), &quot; &quot;, mymessage.created)}}</div><div class=""> {{=H5(mymessage.subject)}}</div><div class=""> {{for text in mymessage.content:}}</div><div class="">   {{=DIV(text)}}</div><div class="">   {{=TR()}}</div><div class=""> {{pass}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> As expected, we can take advantage of the ``SQLTABLE`` helper to build message lists in views</div><div class=""> </div><div class=""> ``</div><div class=""> {{=SQLTABLE(myset.select(), linkto=URL(...))}}</div><div class=""> ``:code</div><div class=""> </div><div class="insert">And of course, it&#x27;s possible to feed a form helper with the approp<span class="highlight">r</span>iate sequence id value</div><div class=""> </div><div class=""> ``</div><div class=""> {{=SQLFORM(imapdb.INBOX, &lt;message id&gt;, fields=[...])}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> The current adapter supported fields available are the following:</div><div class=""> </div><div class=""> ---------------------------------------</div><div class=""> **Field** | **Type** | **Description**</div><div class=""> uid | string | ````</div><div class=""> answered | boolean | Flag</div><div class=""> created | date | ````</div><div class=""> content | list:string | A list of text or html parts</div><div class=""> to | string | ````</div><div class=""> cc | string | ````</div><div class=""> bcc | string | ````</div><div class=""> size | integer | the amount of octets of the message*</div><div class=""> deleted | boolean | Flag</div><div class=""> draft | boolean | Flag</div><div class=""> flagged | boolean | Flag</div><div class=""> sender | string | ````</div><div class=""> recent | boolean | Flag</div><div class=""> seen | boolean  | Flag</div><div class=""> subject | string| ````</div><div class=""> mime | string | The mime header declaration</div><div class=""> email | string | The complete RFC822 message**</div><div class=""> attachments | list:string | Each non text decoded part as string</div><div class=""> ---------------------------------------------------</div><div class=""> </div><div class=""> *At the application side it is measured as the length of the RFC822</div><div class=""> message string</div><div class=""> </div><div class="insert">**WARNING**: As row id&#x27;s are mapped to email sequence numbers, make sure your <span class="highlight">IMAP</span> client web2py app does not delete messages</div><div class=""> during select or update actions, to prevent updating or deleting different messages.</div><div class=""> </div><div class=""> </div><div class="insert">Standard ``CRUD`` database operations are not supported. There&#x27;s no way of defining custom fields or tables and make inserts with different data types because updating mailboxes with IMAP services is usually reduced to posting flag updates to the server. Still, it&#x27;s possible to access those flag commands t<span class="highlight">hrough the</span> DAL IMAP inte<span class="highlight">rface</span></div><div class=""> </div><div class=""> To mark last query messages as seen</div><div class=""> ``</div><div class=""> seen = imapdb(q).update(seen=True)</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class="insert">Here we delete messages in the <span class="highlight">IMAP</span> database that have mails from mr. Gumby</div><div class=""> ``</div><div class=""> deleted = 0</div><div class=""> for tablename in imapdb.tables():</div><div class="">     deleted += imapdb(imapdb[tablename].sender.contains(&quot;gumby&quot;)).delete()</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class="insert">It is possible also to mark messages for deletion instead of er<span class="highlight"></span>asing them</div><div class=""> directly with</div><div class=""> ``</div><div class=""> myset.update(deleted=True)</div><div class=""> ``:code</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">For a single mail account, this is the code recommended to start <span class="highlight">imap</span> support at the app&#x27;s model</div><div class=""> </div><div class=""> ``</div><div class=""> # Replace user, password, server and port in the connection string</div><div class="delete"># Set port as 993 for <span class="highlight">ssl</span> support</div><div class=""> imapdb = DAL(&quot;imap://user:password@server:port&quot;, pool_size=1)</div><div class=""> imapdb.define_tables()</div><div class=""> ``:code</div><div class=""> </div><div class="delete">Note that ``&lt;imapdb&gt;.define_tables()`` returns a dictionary of strings mapping <span class="highlight">dal</span> tablenames to the server mailbox names with the structure ``{&lt;tablename&gt;: &lt;server mailbox name&gt;, ...}``, so you can get the actual mailbox name in the IMAP server.</div><div class=""> </div><div class=""> </div><div class=""> To handle the different native mailbox names for the user interface,  the following attributes give access to the adapter auto mailbox mapped names (which native mailbox has what table name and vice versa):</div><div class=""> </div><div class=""> -------------------------------------</div><div class=""> **Attribute** | **Type** | **Format**</div><div class=""> imapdb.mailboxes | dict | ``{&lt;tablename&gt;: &lt;server native name&gt;, ...}``</div><div class=""> imapdb.&lt;table&gt;.mailbox | string | ``&quot;server native name&quot;``</div><div class=""> -------------------------------------</div><div class=""> </div><div class="delete">The first can be useful to retrieve <span class="highlight">imap</span> query sets by the native email service mailbox</div><div class=""> ``</div><div class=""> # mailbox is a string containing the actual mailbox name</div><div class=""> tablenames = dict([(v,k) for k,v in imapdb.mailboxes.items()])</div><div class=""> myset = imapdb(imapdb[tablenames[mailbox]])</div><div class=""> ``:code</div><div class=""> </div><div class=""> #### Fetching mail and updating flags</div><div class=""> </div><div class="delete">Here&#x27;s a list of <span class="highlight">imap</span> commands you could use in the controller. For the examples, it&#x27;s assumed that your <span class="highlight">imap</span> service has a mailbox named ``INBOX``, which is the case for Gmail(r) accounts.</div><div class=""> </div><div class=""> </div><div class=""> To count today&#x27;s unseen messages smaller than 6000 octets from the inbox mailbox do</div><div class=""> ``</div><div class=""> q = imapdb.INBOX.seen == False</div><div class=""> q &amp;= imapdb.INBOX.created == datetime.date.today()</div><div class=""> q &amp;= imapdb.INBOX.size &lt; 6000</div><div class=""> unread = imapdb(q).count()</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> You can fetch the previous query messages with</div><div class=""> ``</div><div class=""> rows = imapdb(q).select()</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> Usual query operators are implemented, including belongs</div><div class=""> </div><div class=""> ``</div><div class=""> messages = imapdb(imapdb.INBOX.uid.belongs(&lt;uid sequence&gt;)).select()</div><div class=""> ``:code</div><div class=""> </div><div class="delete">**Note**: It&#x27;s strongly advi<span class="highlight">c</span>ed that you keep the query results below a given data size threshold to avoid jamming the server with large select commands. As of now, the messages are retrieved entirely by the adapter before any filter by field can be applied.</div><div class=""> </div><div class=""> It is possible to filter query select results with limitby and sequences of mailbox fields</div><div class=""> ``</div><div class=""> # Replace the arguments with actual values</div><div class=""> myset.select(&lt;fields sequence&gt;, limitby=(&lt;int&gt;, &lt;int&gt;))</div><div class=""> ``:code</div><div class=""> </div><div class=""> Say you want to have an app action show a mailbox message. First we retrieve the message (If your IMAP service supports it, fetch messages by ``uid`` field to avoid using old sequence references).</div><div class=""> </div><div class=""> ``</div><div class=""> mymessage = imapdb(imapdb.INBOX.uid == &lt;uid&gt;).select().first()</div><div class=""> ``:code</div><div class=""> </div><div class=""> Otherwise, you can use the message&#x27;s ``id``.</div><div class=""> </div><div class=""> ``</div><div class=""> mymessage = imapdb.INBOX[&lt;id&gt;]</div><div class=""> ``:code</div><div class=""> </div><div class="delete">Note that using the message&#x27;s id as reference is not recommended, because sequence numbers can change with mailbox ma<span class="highlight">ntai</span>nance operations as message deletions. If you still want to record references to messages (i.e. in another database&#x27;s record field), the solution is to use the uid field as reference whenever supported, and retrieve each message with the recorded value.</div><div class=""> </div><div class=""> Finally, add something like the following to show the message content in a view</div><div class=""> </div><div class=""> ``</div><div class=""> {{=P(T(&quot;Message from&quot;), &quot; &quot;, mymessage.sender)}}</div><div class=""> {{=P(T(&quot;Received on&quot;), &quot; &quot;, mymessage.created)}}</div><div class=""> {{=H5(mymessage.subject)}}</div><div class=""> {{for text in mymessage.content:}}</div><div class="">   {{=DIV(text)}}</div><div class="">   {{=TR()}}</div><div class=""> {{pass}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> As expected, we can take advantage of the ``SQLTABLE`` helper to build message lists in views</div><div class=""> </div><div class=""> ``</div><div class=""> {{=SQLTABLE(myset.select(), linkto=URL(...))}}</div><div class=""> ``:code</div><div class=""> </div><div class="delete">And of course, it&#x27;s possible to feed a form helper with the approp<span class="highlight"></span>iate sequence id value</div><div class=""> </div><div class=""> ``</div><div class=""> {{=SQLFORM(imapdb.INBOX, &lt;message id&gt;, fields=[...])}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> The current adapter supported fields available are the following:</div><div class=""> </div><div class=""> ---------------------------------------</div><div class=""> **Field** | **Type** | **Description**</div><div class=""> uid | string | ````</div><div class=""> answered | boolean | Flag</div><div class=""> created | date | ````</div><div class=""> content | list:string | A list of text or html parts</div><div class=""> to | string | ````</div><div class=""> cc | string | ````</div><div class=""> bcc | string | ````</div><div class=""> size | integer | the amount of octets of the message*</div><div class=""> deleted | boolean | Flag</div><div class=""> draft | boolean | Flag</div><div class=""> flagged | boolean | Flag</div><div class=""> sender | string | ````</div><div class=""> recent | boolean | Flag</div><div class=""> seen | boolean  | Flag</div><div class=""> subject | string| ````</div><div class=""> mime | string | The mime header declaration</div><div class=""> email | string | The complete RFC822 message**</div><div class=""> attachments | list:string | Each non text decoded part as string</div><div class=""> ---------------------------------------------------</div><div class=""> </div><div class=""> *At the application side it is measured as the length of the RFC822</div><div class=""> message string</div><div class=""> </div><div class="delete">**WARNING**: As row id&#x27;s are mapped to email sequence numbers, make sure your <span class="highlight">imap</span> client web2py app does not delete messages</div><div class=""> during select or update actions, to prevent updating or deleting different messages.</div><div class=""> </div><div class=""> </div><div class="delete">Standard ``CRUD`` database operations are not supported. There&#x27;s no way of defining custom fields or tables and make inserts with different data types because updating mailboxes with IMAP services is usually reduced to posting flag updates to the server. Still, it&#x27;s possible to access those flag commands t<span class="highlight">rough</span> DAL IMAP inte<span class="highlight">face</span></div><div class=""> </div><div class=""> To mark last query messages as seen</div><div class=""> ``</div><div class=""> seen = imapdb(q).update(seen=True)</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class="delete">Here we delete messages in the <span class="highlight">imap</span> database that have mails from mr. Gumby</div><div class=""> ``</div><div class=""> deleted = 0</div><div class=""> for tablename in imapdb.tables():</div><div class="">     deleted += imapdb(imapdb[tablename].sender.contains(&quot;gumby&quot;)).delete()</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class="delete">It is possible also to mark messages for deletion instead of er<span class="highlight">e</span>asing them</div><div class=""> directly with</div><div class=""> ``</div><div class=""> myset.update(deleted=True)</div><div class=""> ``:code</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/8ec972820c26ac5695a72b3b0d93e1422449853e">8ec9728</a><ul><li>Date : 2012-10-05</li><li>New usage of adapter attributes</li></ul></li></ul>
<div class="row-fluid" id="com_8ec972820c26ac5695a72b3b0d93e1422449853e">
    <div class="span6"><div class="diff"><div class=""> -------------------------------------------------------</div><div class=""> **Attribute** | **Type** | **Format**</div><div class=""> =======================================================================</div><div class="insert">+imapdb.mailboxes | dict | ``{&lt;tablename&gt;: &lt;server native name&gt;, ...}``</div><div class="insert">+imapdb.&lt;table&gt;.mailbox | string | ``&quot;server native name&quot;``</div><div class=""> =======================================================================</div><div class=""> -------------------------------------------------------</div><div class=""> </div><div class=""> </div><div class=""> The second can be useful to retrieve imap query sets by the native email service mailbox</div><div class=""> ``</div><div class=""> # mailbox is a string containing the actual mailbox name</div><div class="insert">tablename = imapdb.mailbox<span class="highlight"></span>es[mailbox]</div><div class=""> myset = imapdb(imapdb[tablename])</div><div class=""> ``:code</div><div class=""> </div><div class=""> #### Fetching mail and updating flags</div><div class=""> </div><div class=""> Here&#x27;s a list of imap commands you could use in the controller. For the examples, it&#x27;s assumed that your imap service has a mailbox named ``INBOX``, which is the case for Gmail(r) accounts.</div><div class=""> </div><div class=""> </div><div class=""> To count today&#x27;s unseen messages smaller than 6000 octets from the inbox mailbox do</div><div class=""> ``</div><div class=""> q = imapdb.INBOX.seen == False</div><div class=""> q &amp;= imapdb.INBOX.created == datetime.date.today()</div><div class=""> q &amp;= imapdb.INBOX.size &lt; 6000</div><div class=""> unread = imapdb(q).count()</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> You can fetch the previous query messages with</div><div class=""> ``</div><div class=""> rows = imapdb(q).select()</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> Usual query operators are implemented, including belongs</div><div class=""> </div><div class=""> ``</div><div class=""> messages = imapdb(imapdb.INBOX.uid.belongs(&lt;uid sequence&gt;)).select()</div><div class=""> ``:code</div><div class=""> </div><div class=""> **Note**: It&#x27;s strongly adviced that you keep the query results below a given data size threshold to avoid jamming the server with large select commands. As of now, the messages are retrieved entirely by the adapter before any filter by field can be applied.</div><div class=""> deleted | boolean | Flag</div><div class=""> draft | boolean | Flag</div><div class=""> flagged | boolean | Flag</div><div class=""> sender | string |</div><div class=""> recent | boolean | Flag</div><div class=""> seen | boolean  | Flag</div><div class=""> subject | string|</div><div class=""> mime | string | The mime header declaration</div><div class=""> email | string | The complete RFC822 message**</div><div class=""> attachments | list:string | Each non text decoded part as string</div><div class=""> ================================================================</div><div class=""> ----------------------------------------------------------------</div><div class=""> </div><div class=""> *At the application side it is measured as the length of the RFC822</div><div class=""> message string</div><div class=""> </div><div class=""> **WARNING**: As row id&#x27;s are mapped to email sequence numbers, make sure your imap client web2py app does not delete messages</div><div class=""> during select or update actions, to prevent updating or deleting different messages.</div><div class=""> </div><div class=""> </div><div class=""> Standard ``CRUD`` database operations are not supported. There&#x27;s no way of defining custom fields or tables and make inserts with different data types because updating mailboxes with IMAP services is usually reduced to posting flag updates to the server. Still, it&#x27;s possible to access those flag commands trough DAL IMAP inteface</div><div class=""> </div><div class=""> To mark last query messages as seen</div><div class=""> ``</div><div class=""> seen = imapdb(q).update(seen=True)</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> Here we delete messages in the imap database that have mails from mr. Gumby</div><div class=""> ``</div><div class=""> deleted = 0</div><div class="insert">for tablename in imapdb.tables<span class="highlight">():</span></div><div class="">     deleted += imapdb(imapdb[tablename].sender.contains(&quot;gumby&quot;)).delete()</div><div class=""> ``:code</div></div></div>
    <div class="span6"><div class="diff"><div class=""> -------------------------------------------------------</div><div class=""> **Attribute** | **Type** | **Format**</div><div class=""> =======================================================================</div><div class="delete">-imapdb.mailboxes | list | ``[&lt;tablename&gt;, ...]``</div><div class="delete">-imapdb.mailbox_names | dict | ``{&lt;tablename&gt;: &lt;server native name&gt;, ...}``</div><div class=""> =======================================================================</div><div class=""> -------------------------------------------------------</div><div class=""> </div><div class=""> </div><div class=""> The second can be useful to retrieve imap query sets by the native email service mailbox</div><div class=""> ``</div><div class=""> # mailbox is a string containing the actual mailbox name</div><div class="delete">tablename = imapdb.mailbox<span class="highlight">_nam</span>es[mailbox]</div><div class=""> myset = imapdb(imapdb[tablename])</div><div class=""> ``:code</div><div class=""> </div><div class=""> #### Fetching mail and updating flags</div><div class=""> </div><div class=""> Here&#x27;s a list of imap commands you could use in the controller. For the examples, it&#x27;s assumed that your imap service has a mailbox named ``INBOX``, which is the case for Gmail(r) accounts.</div><div class=""> </div><div class=""> </div><div class=""> To count today&#x27;s unseen messages smaller than 6000 octets from the inbox mailbox do</div><div class=""> ``</div><div class=""> q = imapdb.INBOX.seen == False</div><div class=""> q &amp;= imapdb.INBOX.created == datetime.date.today()</div><div class=""> q &amp;= imapdb.INBOX.size &lt; 6000</div><div class=""> unread = imapdb(q).count()</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> You can fetch the previous query messages with</div><div class=""> ``</div><div class=""> rows = imapdb(q).select()</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> Usual query operators are implemented, including belongs</div><div class=""> </div><div class=""> ``</div><div class=""> messages = imapdb(imapdb.INBOX.uid.belongs(&lt;uid sequence&gt;)).select()</div><div class=""> ``:code</div><div class=""> </div><div class=""> **Note**: It&#x27;s strongly adviced that you keep the query results below a given data size threshold to avoid jamming the server with large select commands. As of now, the messages are retrieved entirely by the adapter before any filter by field can be applied.</div><div class=""> deleted | boolean | Flag</div><div class=""> draft | boolean | Flag</div><div class=""> flagged | boolean | Flag</div><div class=""> sender | string |</div><div class=""> recent | boolean | Flag</div><div class=""> seen | boolean  | Flag</div><div class=""> subject | string|</div><div class=""> mime | string | The mime header declaration</div><div class=""> email | string | The complete RFC822 message**</div><div class=""> attachments | list:string | Each non text decoded part as string</div><div class=""> ================================================================</div><div class=""> ----------------------------------------------------------------</div><div class=""> </div><div class=""> *At the application side it is measured as the length of the RFC822</div><div class=""> message string</div><div class=""> </div><div class=""> **WARNING**: As row id&#x27;s are mapped to email sequence numbers, make sure your imap client web2py app does not delete messages</div><div class=""> during select or update actions, to prevent updating or deleting different messages.</div><div class=""> </div><div class=""> </div><div class=""> Standard ``CRUD`` database operations are not supported. There&#x27;s no way of defining custom fields or tables and make inserts with different data types because updating mailboxes with IMAP services is usually reduced to posting flag updates to the server. Still, it&#x27;s possible to access those flag commands trough DAL IMAP inteface</div><div class=""> </div><div class=""> To mark last query messages as seen</div><div class=""> ``</div><div class=""> seen = imapdb(q).update(seen=True)</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> Here we delete messages in the imap database that have mails from mr. Gumby</div><div class=""> ``</div><div class=""> deleted = 0</div><div class="delete">for tablename in imapdb.tables<span class="highlight"></span></div><div class="">     deleted += imapdb(imapdb[tablename].sender.contains(&quot;gumby&quot;)).delete()</div><div class=""> ``:code</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/e234f6edf67361b3ba718ea10184ba8e7c2f773d">e234f6e</a><ul><li>Date : 2012-12-20</li><li>lots of improvements</li></ul></li></ul>
<div class="row-fluid" id="com_e234f6edf67361b3ba718ea10184ba8e7c2f773d">
    <div class="span6"><div class="diff"><div class=""> ``</div><div class=""> send(self, to, subject=&#x27;None&#x27;, message=&#x27;None&#x27;, attachments=1,</div><div class="insert">+     cc=1, bcc=1, reply_to=1, encoding=&#x27;utf-8&#x27;,headers={},</div><div class="insert">+     sender=None)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Note, ``to``, ``cc``, and ``bcc`` each take a list of email addresses.</div><div class=""> </div><div class=""> ``headers`` is dictionary of headers to refine the headers just before sending the email. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> headers = {&#x27;Return-Path&#x27; : &#x27;bounces@example.org&#x27;}</div><div class=""> ``:code</div><div class=""> </div><div class="insert">+``sender`` defaults to ``None`` and in this case the sender will be set to ``mail.settings.sender``.</div><div class="insert">+</div><div class=""> Following are some additional examples demonstrating the use of ``mail.send()``.</div></div></div>
    <div class="span6"><div class="diff"><div class=""> ``</div><div class=""> send(self, to, subject=&#x27;None&#x27;, message=&#x27;None&#x27;, attachments=1,</div><div class="delete">-     cc=1, bcc=1, reply_to=1, encoding=&#x27;utf-8&#x27;,headers={})</div><div class=""> ``:code</div><div class=""> </div><div class=""> Note, ``to``, ``cc``, and ``bcc`` each take a list of email addresses.</div><div class=""> </div><div class=""> ``headers`` is dictionary of headers to refine the headers just before sending the email. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> headers = {&#x27;Return-Path&#x27; : &#x27;bounces@example.org&#x27;}</div><div class=""> ``:code</div><div class=""> </div><div class=""> Following are some additional examples demonstrating the use of ``mail.send()``.</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/eaaa0e14bf17cdc4d0edd2ea9daa9af5f3484c09">eaaa0e1</a><ul><li>Date : 2012-12-25</li><li>changes to style</li></ul></li></ul>
<div class="row-fluid" id="com_eaaa0e14bf17cdc4d0edd2ea9daa9af5f3484c09">
    <div class="span6"><div class="diff"><div class="insert">+-------------------------------------</div><div class=""> **Attribute** | **Type** | **Format**</div><div class=""> imapdb.mailboxes | dict | ``{&lt;tablename&gt;: &lt;server native name&gt;, ...}``</div><div class=""> imapdb.&lt;table&gt;.mailbox | string | ``&quot;server native name&quot;``</div><div class="insert"><span class="highlight">-------------------------------------</span></div><div class=""> </div><div class=""> The first can be useful to retrieve imap query sets by the native email service mailbox</div><div class=""> ``</div><div class=""> # mailbox is a string containing the actual mailbox name</div><div class=""> tablenames = dict([(v,k) for k,v in imapdb.mailboxes.items()])</div><div class=""> myset = imapdb(imapdb[tablenames[mailbox]])</div><div class=""> ``:code</div><div class=""> </div><div class=""> #### Fetching mail and updating flags</div><div class=""> </div><div class=""> Here&#x27;s a list of imap commands you could use in the controller. For the examples, it&#x27;s assumed that your imap service has a mailbox named ``INBOX``, which is the case for Gmail(r) accounts.</div><div class=""> </div><div class=""> </div><div class=""> To count today&#x27;s unseen messages smaller than 6000 octets from the inbox mailbox do</div><div class=""> ``</div><div class=""> q = imapdb.INBOX.seen == False</div><div class=""> q &amp;= imapdb.INBOX.created == datetime.date.today()</div><div class=""> q &amp;= imapdb.INBOX.size &lt; 6000</div><div class=""> unread = imapdb(q).count()</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> You can fetch the previous query messages with</div><div class=""> ``</div><div class=""> rows = imapdb(q).select()</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> Usual query operators are implemented, including belongs</div><div class=""> </div><div class=""> mymessage = imapdb.INBOX[&lt;id&gt;]</div><div class=""> Note that using the message&#x27;s id as reference is not recommended, because sequence numbers can change with mailbox mantainance operations as message deletions. If you still want to record references to messages (i.e. in another database&#x27;s record field), the solution is to use the uid field as reference whenever supported, and retrieve each message with the recorded value.</div><div class=""> </div><div class=""> Finally, add something like the following to show the message content in a view</div><div class=""> </div><div class=""> ``</div><div class=""> {{=P(T(&quot;Message from&quot;), &quot; &quot;, mymessage.sender)}}</div><div class=""> {{=P(T(&quot;Received on&quot;), &quot; &quot;, mymessage.created)}}</div><div class=""> {{=H5(mymessage.subject)}}</div><div class=""> {{for text in mymessage.content:}}</div><div class="">   {{=DIV(text)}}</div><div class="">   {{=TR()}}</div><div class=""> {{pass}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> As expected, we can take advantage of the ``SQLTABLE`` helper to build message lists in views</div><div class=""> </div><div class=""> ``</div><div class=""> {{=SQLTABLE(myset.select(), linkto=URL(...))}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> And of course, it&#x27;s possible to feed a form helper with the appropiate sequence id value</div><div class=""> </div><div class=""> ``</div><div class=""> {{=SQLFORM(imapdb.INBOX, &lt;message id&gt;, fields=[...])}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> The current adapter supported fields available are the following:</div><div class=""> </div><div class=""> ---------------------------------------</div><div class=""> **Field** | **Type** | **Description**</div><div class=""> uid | string |</div><div class=""> answered | boolean | Flag</div><div class=""> created | date |</div><div class=""> content | list:string | A list of text or html parts</div><div class=""> to | string |</div><div class=""> cc | string |</div><div class=""> bcc | string |</div><div class=""> size | integer | the amount of octets of the message*</div><div class=""> deleted | boolean | Flag</div><div class=""> draft | boolean | Flag</div><div class=""> flagged | boolean | Flag</div><div class=""> sender | string |</div><div class=""> recent | boolean | Flag</div><div class=""> seen | boolean  | Flag</div><div class=""> subject | string|</div><div class=""> mime | string | The mime header declaration</div><div class=""> email | string | The complete RFC822 message**</div><div class=""> attachments | list:string | Each non text decoded part as string</div><div class="insert"><span class="highlight">---------------------------------------------------</span></div></div></div>
    <div class="span6"><div class="diff"><div class=""> **Attribute** | **Type** | **Format**</div><div class="delete">-=======================================================================</div><div class=""> imapdb.mailboxes | dict | ``{&lt;tablename&gt;: &lt;server native name&gt;, ...}``</div><div class=""> imapdb.&lt;table&gt;.mailbox | string | ``&quot;server native name&quot;``</div><div class="delete"><span class="highlight">=======================================================================</span></div><div class=""> </div><div class=""> The first can be useful to retrieve imap query sets by the native email service mailbox</div><div class=""> ``</div><div class=""> # mailbox is a string containing the actual mailbox name</div><div class=""> tablenames = dict([(v,k) for k,v in imapdb.mailboxes.items()])</div><div class=""> myset = imapdb(imapdb[tablenames[mailbox]])</div><div class=""> ``:code</div><div class=""> </div><div class=""> #### Fetching mail and updating flags</div><div class=""> </div><div class=""> Here&#x27;s a list of imap commands you could use in the controller. For the examples, it&#x27;s assumed that your imap service has a mailbox named ``INBOX``, which is the case for Gmail(r) accounts.</div><div class=""> </div><div class=""> </div><div class=""> To count today&#x27;s unseen messages smaller than 6000 octets from the inbox mailbox do</div><div class=""> ``</div><div class=""> q = imapdb.INBOX.seen == False</div><div class=""> q &amp;= imapdb.INBOX.created == datetime.date.today()</div><div class=""> q &amp;= imapdb.INBOX.size &lt; 6000</div><div class=""> unread = imapdb(q).count()</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> You can fetch the previous query messages with</div><div class=""> ``</div><div class=""> rows = imapdb(q).select()</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> Usual query operators are implemented, including belongs</div><div class=""> </div><div class=""> mymessage = imapdb.INBOX[&lt;id&gt;]</div><div class=""> Note that using the message&#x27;s id as reference is not recommended, because sequence numbers can change with mailbox mantainance operations as message deletions. If you still want to record references to messages (i.e. in another database&#x27;s record field), the solution is to use the uid field as reference whenever supported, and retrieve each message with the recorded value.</div><div class=""> </div><div class=""> Finally, add something like the following to show the message content in a view</div><div class=""> </div><div class=""> ``</div><div class=""> {{=P(T(&quot;Message from&quot;), &quot; &quot;, mymessage.sender)}}</div><div class=""> {{=P(T(&quot;Received on&quot;), &quot; &quot;, mymessage.created)}}</div><div class=""> {{=H5(mymessage.subject)}}</div><div class=""> {{for text in mymessage.content:}}</div><div class="">   {{=DIV(text)}}</div><div class="">   {{=TR()}}</div><div class=""> {{pass}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> As expected, we can take advantage of the ``SQLTABLE`` helper to build message lists in views</div><div class=""> </div><div class=""> ``</div><div class=""> {{=SQLTABLE(myset.select(), linkto=URL(...))}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> And of course, it&#x27;s possible to feed a form helper with the appropiate sequence id value</div><div class=""> </div><div class=""> ``</div><div class=""> {{=SQLFORM(imapdb.INBOX, &lt;message id&gt;, fields=[...])}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> The current adapter supported fields available are the following:</div><div class=""> </div><div class=""> ---------------------------------------</div><div class=""> **Field** | **Type** | **Description**</div><div class="delete">-=======================================</div><div class=""> uid | string |</div><div class=""> answered | boolean | Flag</div><div class=""> created | date |</div><div class=""> content | list:string | A list of text or html parts</div><div class=""> to | string |</div><div class=""> cc | string |</div><div class=""> bcc | string |</div><div class=""> size | integer | the amount of octets of the message*</div><div class=""> deleted | boolean | Flag</div><div class=""> draft | boolean | Flag</div><div class=""> flagged | boolean | Flag</div><div class=""> sender | string |</div><div class=""> recent | boolean | Flag</div><div class=""> seen | boolean  | Flag</div><div class=""> subject | string|</div><div class=""> mime | string | The mime header declaration</div><div class=""> email | string | The complete RFC822 message**</div><div class=""> attachments | list:string | Each non text decoded part as string</div><div class="delete"><span class="highlight">================================================================</span></div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/097d699dc16179206ccb7e4aee863d6523cd471c">097d699</a><ul><li>Date : 2012-12-27</li><li>fixed typo, thanks Andrew</li></ul></li></ul>
<div class="row-fluid" id="com_097d699dc16179206ccb7e4aee863d6523cd471c">
    <div class="span6"><div class="diff"><div class="insert">+## Emails and SMS</div><div class="insert">+</div><div class="insert">+``Mail``:inxx</div><div class="insert">+</div><div class="insert">+### Setting up email</div><div class="insert">+</div><div class="insert">+Web2py provides the ``gluon.tools.Mail`` class to make it easy to send emails using web2py. One can define a mailer with</div><div class="insert">+``</div><div class="insert">+from gluon.tools import Mail</div><div class="insert">+mail = Mail()</div><div class="insert">+mail.settings.server = &#x27;smtp.example.com:25&#x27;</div><div class="insert">+mail.settings.sender = &#x27;you@example.com&#x27;</div><div class="insert">+mail.settings.login = &#x27;username:password&#x27;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Note, if your application uses ``Auth`` (discussed in the next chapter), the ``auth`` object will include its own mailer in ``auth.settings.mailer``, so you can use that instead as follows:</div><div class="insert">+``</div><div class="insert">+mail = auth.settings.mailer</div><div class="insert">+mail.settings.server = &#x27;smtp.example.com:25&#x27;</div><div class="insert">+mail.settings.sender = &#x27;you@example.com&#x27;</div><div class="insert">+mail.settings.login = &#x27;username:password&#x27;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+You need to replace the mail.settings with the proper parameters for your SMTP server. Set ``mail.settings.login = None`` if the SMTP server does not require authentication.</div><div class="insert">+</div><div class="insert">+``email logging``:inxx</div><div class="insert">+</div><div class="insert">+--------</div><div class="insert">+For debugging purposes you can set</div><div class="insert">+``</div><div class="insert">+mail.settings.server = &#x27;logging&#x27;</div><div class="insert">+``:code</div><div class="insert">+and emails will not be sent but logged to the console instead.</div><div class="insert">+-------</div><div class="insert">+</div><div class="insert">+#### Configuring email for Google App Engine</div><div class="insert">+``email from GAE``:inxx</div><div class="insert">+For sending emails from Google App Engine account:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+mail.settings.server = &#x27;gae&#x27;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+At the time of writing web2py does not support attachments and encrypted emails on Google App Engine. Notice cron and scheduler do not work on GAE.</div><div class="insert">+</div><div class="insert">+#### x509 and PGP Encryption</div><div class="insert">+``PGP``:inxx ``x509``:inxx</div><div class="insert">+</div><div class="insert">+It is possible to send x509 (SMIME) encrypted emails using the following settings:</div><div class="insert">+``</div><div class="insert">+mail.settings.cipher_type = &#x27;x509&#x27;</div><div class="insert">+mail.settings.sign = True</div><div class="insert">+mail.settings.sign_passphrase = &#x27;your passphrase&#x27;</div><div class="insert">+mail.settings.encrypt = True</div><div class="insert">+mail.settings.x509_sign_keyfile = &#x27;filename.key&#x27;</div><div class="insert">+mail.settings.x509_sign_certfile = &#x27;filename.cert&#x27;</div><div class="insert">+mail.settings.x509_crypt_certfiles = &#x27;filename.cert&#x27;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+It is possible to send PGP encrypted emails using the following settings:</div><div class="insert">+``</div><div class="insert">+from gpgme import pgp</div><div class="insert">+mail.settings.cipher_type = &#x27;gpg&#x27;</div><div class="insert">+mail.settings.sign = True</div><div class="insert">+mail.settings.sign_passphrase = &#x27;your passphrase&#x27;</div><div class="insert">+mail.settings.encrypt = True</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+The latter requires the python-pyme package.</div><div class="insert">+</div><div class="insert">+### Sending emails</div><div class="insert">+``mail.send``:inxx ``email html``:inxx ``email attachments``:inxx</div><div class="insert">+</div><div class="insert">+Once ``mail`` is defined, it can be used to send email via:</div><div class="insert">+``</div><div class="insert">+mail.send(to=[&#x27;somebody@example.com&#x27;],</div><div class="insert">+          subject=&#x27;hello&#x27;,</div><div class="insert">+          # If reply_to is omitted, then mail.settings.sender is used</div><div class="insert">+          reply_to=&#x27;us@example.com&#x27;,</div><div class="insert">+          message=&#x27;hi there&#x27;)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Mail returns ``True`` if it succeeds in sending the email and ``False`` otherwise.  A complete argument list for ``mail.send()`` is as follows:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+send(self, to, subject=&#x27;None&#x27;, message=&#x27;None&#x27;, attachments=1,</div><div class="insert">+     cc=1, bcc=1, reply_to=1, encoding=&#x27;utf-8&#x27;,headers={},</div><div class="insert">+     sender=None)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Note, ``to``, ``cc``, and ``bcc`` each take a list of email addresses.</div><div class="insert">+</div><div class="insert">+``headers`` is dictionary of headers to refine the headers just before sending the email. For example:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+headers = {&#x27;Return-Path&#x27; : &#x27;bounces@example.org&#x27;}</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+``sender`` defaults to ``None`` and in this case the sender will be set to ``mail.settings.sender``.</div><div class="insert">+</div><div class="insert">+Following are some additional examples demonstrating the use of ``mail.send()``.</div><div class="insert">+</div><div class="insert">+#### Simple text email</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+mail.send(&#x27;you@example.com&#x27;,</div><div class="insert">+  &#x27;Message subject&#x27;,</div><div class="insert">+  &#x27;Plain text body of the message&#x27;)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+#### HTML emails</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+mail.send(&#x27;you@example.com&#x27;,</div><div class="insert">+  &#x27;Message subject&#x27;,</div><div class="insert">+  &#x27;&lt;html&gt;html body&lt;/html&gt;&#x27;)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+If the email body starts with ``&lt;html&gt;`` and ends with ``&lt;/html&gt;``, it will be sent as a HTML email.</div><div class="insert">+</div><div class="insert">+#### Combining text and HTML emails</div><div class="insert">+</div><div class="insert">+The email message can be a tuple (text, html):</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+mail.send(&#x27;you@example.com&#x27;,</div><div class="insert">+  &#x27;Message subject&#x27;,</div><div class="insert">+  (&#x27;Plain text body&#x27;, &#x27;&lt;html&gt;html body&lt;/html&gt;&#x27;))</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+#### ``cc`` and ``bcc`` emails</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+mail.send(&#x27;you@example.com&#x27;,</div><div class="insert">+  &#x27;Message subject&#x27;,</div><div class="insert">+  &#x27;Plain text body&#x27;,</div><div class="insert">+  cc=[&#x27;other1@example.com&#x27;, &#x27;other2@example.com&#x27;],</div><div class="insert">+  bcc=[&#x27;other3@example.com&#x27;, &#x27;other4@example.com&#x27;])</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+#### Attachments</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+mail.send(&#x27;you@example.com&#x27;,</div><div class="insert">+  &#x27;Message subject&#x27;,</div><div class="insert">+  &#x27;&lt;html&gt;&lt;img src=&quot;cid:photo&quot; /&gt;&lt;/html&gt;&#x27;,</div><div class="insert">+  attachments = mail.Attachment(&#x27;/path/to/photo.jpg&#x27;, content_id=&#x27;photo&#x27;))</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+#### Multiple attachments</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+mail.send(&#x27;you@example.com&#x27;,</div><div class="insert">+  &#x27;Message subject&#x27;,</div><div class="insert">+  &#x27;Message body&#x27;,</div><div class="insert">+  attachments = [mail.Attachment(&#x27;/path/to/fist.file&#x27;),</div><div class="insert">+                 mail.Attachment(&#x27;/path/to/second.file&#x27;)])</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+### Sending SMS messages</div><div class="insert">+``SMS``:inxx</div><div class="insert">+Sending SMS messages from a web2py application requires a third party service that can relay the messages to the receiver. Usually this is not a free service, but it differs from country to country. We have tried a few of these services with little success. Phone companies block emails originating from these services since they are eventually used as a source of spam.</div><div class="insert">+</div><div class="insert">+A better way is to use the phone companies themselves to relay the SMS. Each phone company has an email address uniquely associated with every cell-phone number, so SMS messages can be sent as emails to the phone number.</div><div class="insert">+</div><div class="insert">+web2py comes with a module to help in this process:</div><div class="insert">+``</div><div class="insert">+from gluon.contrib.sms_utils import SMSCODES, sms_email</div><div class="insert">+email = sms_email(&#x27;1 (111) 111-1111&#x27;,&#x27;T-Mobile USA (tmail)&#x27;)</div><div class="insert">+mail.sent(to=email, subject=&#x27;test&#x27;, message=&#x27;test&#x27;)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+SMSCODES is a dictionary that maps names of major phone companies to the email address postfix. The ``sms_email`` function takes a phone number (as a string) and the name of a phone company and returns the email address of the phone.</div><div class="insert">+</div><div class="insert">+### Using the template system to generate messages</div><div class="insert">+``emails``:inxx</div><div class="insert">+</div><div class="insert">+It is possible to use the template system to generate emails. For example, consider the database table</div><div class="insert">+``</div><div class="insert">+db.define_table(&#x27;person&#x27;, Field(&#x27;name&#x27;))</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+where you want to send to every person in the database the following message,</div><div class="insert">+stored in a view file &quot;message.html&quot;:</div><div class="insert">+``</div><div class="insert">+Dear {{=person.name}},</div><div class="insert">+You have won the second prize, a set of steak knives.</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+You can achieve this in the following way</div><div class="insert">+``</div><div class="insert">+for person in db(db.person).select():</div><div class="insert">+    context = dict(person=person)</div><div class="insert">+    message = response.render(&#x27;message.html&#x27;, context)</div><div class="insert">+    mail.send(to=[&#x27;who@example.com&#x27;],</div><div class="insert">+              subject=&#x27;None&#x27;,</div><div class="insert">+              message=message)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Most of the work is done in the statement</div><div class="insert">+``</div><div class="insert">+response.render(&#x27;message.html&#x27;, context)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+It renders the view &quot;message.html&quot; with the variables defined in the dictionary &quot;context&quot;, and it returns a string with the rendered email text. The context is a dictionary that contains variables that will be visible to the template file.</div><div class="insert">+</div><div class="insert">+If the message starts with ``&lt;html&gt;`` and ends with ``&lt;/html&gt;``, the email will be an HTML email.</div><div class="insert">+</div><div class="insert">+Note, if you want to include a link back to your website in an HTML email, you can use the ``URL`` function. However, by default, the ``URL`` function generates a relative URL, which will not work from an email. To generate an absolute URL, you need to specify the ``scheme`` and ``host`` arguments to the URL function. For example:</div><div class="insert">+``</div><div class="insert">+&lt;a href=&quot;{{=URL(..., scheme=True, host=True)}}&quot;&gt;Click here&lt;/a&gt;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+or</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+&lt;a href=&quot;{{=URL(..., scheme=&#x27;http&#x27;, host=&#x27;www.site.com&#x27;)}}&quot;&gt;Click here&lt;/a&gt;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+The same mechanism that is used to generate email text can also be used to generate SMS messages or any other type of message based on a template.</div><div class="insert">+</div><div class="insert">+### Sending messages using a background task</div><div class="insert">+</div><div class="insert">+The operation of sending an email message can take up to several seconds because of the need to log into and communicate with a potentially remote SMTP server. To keep the user from having to wait for the send operation to complete, it is sometimes desirable to queue the email to be sent at a later time via a background task. As described in Chapter 4, this can be done by setting up a homemade task queue or using the web2py scheduler. Here we provide an example using a homemade task queue.</div><div class="insert">+</div><div class="insert">+First, in a model file within our application, we set up a database model to store our email queue:</div><div class="insert">+``</div><div class="insert">+db.define_table(&#x27;queue&#x27;,</div><div class="insert">+    Field(&#x27;status&#x27;),</div><div class="insert">+    Field(&#x27;email&#x27;),</div><div class="insert">+    Field(&#x27;subject&#x27;),</div><div class="insert">+    Field(&#x27;message&#x27;))</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+From a controller, we can then enqueue messages to be sent by:</div><div class="insert">+``</div><div class="insert">+db.queue.insert(status=&#x27;pending&#x27;,</div><div class="insert">+                email=&#x27;you@example.com&#x27;,</div><div class="insert">+                subject=&#x27;test&#x27;,</div><div class="insert">+                message=&#x27;test&#x27;)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Next, we need a background processing script that reads the queue and sends the emails:</div><div class="insert">+``</div><div class="insert">+## in file /app/private/mail_queue.py</div><div class="insert">+import time</div><div class="insert">+while True:</div><div class="insert">+    rows = db(db.queue.status==&#x27;pending&#x27;).select()</div><div class="insert">+    for row in rows:</div><div class="insert">+        if mail.send(to=row.email,</div><div class="insert">+            subject=row.subject,</div><div class="insert">+            message=row.message):</div><div class="insert">+            row.update_record(status=&#x27;sent&#x27;)</div><div class="insert">+        else:</div><div class="insert">+            row.update_record(status=&#x27;failed&#x27;)</div><div class="insert">+        db.commit()</div><div class="insert">+    time.sleep(60) # check every minute</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Finally, as described in Chapter 4, we need to run the mail_queue.py script as if it were inside a controller in our app:</div><div class="insert">+``</div><div class="insert">+python web2py.py -S app -M -N -R applications/app/private/mail_queue.py</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+where ``-S app`` tells web2py to run &quot;mail_queue.py&quot; as &quot;app&quot;, ``-M`` tells web2py to execute models, and ``-N`` tells web2py not to run cron.</div><div class="insert">+</div><div class="insert">+Here we assume that the ``mail`` object referenced in &quot;mail_queue.py&quot; is defined in a model file in our app and is therefore available in the &quot;mail_queue.py&quot; script because of the ``-M`` option. Also notice that it is important to commit any change as soon as possible in order not to lock the database to other concurrent processes.</div><div class="insert">+</div><div class="insert">+As noted in Chapter 4, this type of background process should not be executed via cron (except perhaps for cron @reboot) because you need to be sure that no more than one instance is running at the same time.</div><div class="insert">+</div><div class="insert">+Note, one drawback to sending email via a background process is that it makes it difficult to provide feedback to the user in case the email fails. If email is sent directly from the controller action, you can catch any errors and immediately return an error message to the user. With a background process, however, the email is sent asynchronously, after the controller action has already returned its response, so it becomes more complex to notify the user of a failure.</div><div class="insert">+</div><div class="insert">+</div><div class="insert">+### Reading and managing email boxes (Experimental)</div><div class="insert">+</div><div class="insert">+The ``IMAP`` adapter is intended as an interface with email IMAP servers to perform simple queries in the web2py ``DAL`` query syntax, so email read, search and other related IMAP mail services (as those implemented by brands like Google(r), and Yahoo(r) can be managed from web2py applications.</div><div class="insert">+</div><div class="insert">+It creates its table and field names &quot;statically&quot;, meaning that the developer should leave the table and field definitions to the DAL instance by calling the adapter ``.define_tables()`` method. The tables are defined with the IMAP server mailbox list information.</div><div class="insert">+</div><div class="insert">+</div><div class="insert">+#### Connection</div><div class="insert">+</div><div class="insert">+For a single mail account, this is the code recommended to start imap support at the app&#x27;s model</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+# Replace user, password, server and port in the connection string</div><div class="insert">+# Set port as 993 for ssl support</div><div class="insert">+imapdb = DAL(&quot;imap://user:password@server:port&quot;, pool_size=1)</div><div class="insert">+imapdb.define_tables()</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Note that ``&lt;imapdb&gt;.define_tables()`` returns a dictionary of strings mapping dal tablenames to the server mailbox names with the structure ``{&lt;tablename&gt;: &lt;server mailbox name&gt;, ...}``, so you can get the actual mailbox name in the IMAP server.</div><div class="insert">+</div><div class="insert">+</div><div class="insert">+To handle the different native mailbox names for the user interface,  the following attributes give access to the adapter auto mailbox mapped names (which native mailbox has what table name and vice versa):</div><div class="insert">+</div><div class="insert">+-------------------------------------</div><div class="insert">+**Attribute** | **Type** | **Format**</div><div class="insert">+imapdb.mailboxes | dict | ``{&lt;tablename&gt;: &lt;server native name&gt;, ...}``</div><div class="insert">+imapdb.&lt;table&gt;.mailbox | string | ``&quot;server native name&quot;``</div><div class="insert">+-------------------------------------</div><div class="insert">+</div><div class="insert">+The first can be useful to retrieve imap query sets by the native email service mailbox</div><div class="insert">+``</div><div class="insert">+# mailbox is a string containing the actual mailbox name</div><div class="insert">+tablenames = dict([(v,k) for k,v in imapdb.mailboxes.items()])</div><div class="insert">+myset = imapdb(imapdb[tablenames[mailbox]])</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+#### Fetching mail and updating flags</div><div class="insert">+</div><div class="insert">+Here&#x27;s a list of imap commands you could use in the controller. For the examples, it&#x27;s assumed that your imap service has a mailbox named ``INBOX``, which is the case for Gmail(r) accounts.</div><div class="insert">+</div><div class="insert">+</div><div class="insert">+To count today&#x27;s unseen messages smaller than 6000 octets from the inbox mailbox do</div><div class="insert">+``</div><div class="insert">+q = imapdb.INBOX.seen == False</div><div class="insert">+q &amp;= imapdb.INBOX.created == datetime.date.today()</div><div class="insert">+q &amp;= imapdb.INBOX.size &lt; 6000</div><div class="insert">+unread = imapdb(q).count()</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+</div><div class="insert">+You can fetch the previous query messages with</div><div class="insert">+``</div><div class="insert">+rows = imapdb(q).select()</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+</div><div class="insert">+Usual query operators are implemented, including belongs</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+messages = imapdb(imapdb.INBOX.uid.belongs(&lt;uid sequence&gt;)).select()</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+**Note**: It&#x27;s strongly adviced that you keep the query results below a given data size threshold to avoid jamming the server with large select commands. As of now, the messages are retrieved entirely by the adapter before any filter by field can be applied.</div><div class="insert">+</div><div class="insert">+It is possible to filter query select results with limitby and sequences of mailbox fields</div><div class="insert">+``</div><div class="insert">+# Replace the arguments with actual values</div><div class="insert">+myset.select(&lt;fields sequence&gt;, limitby=(&lt;int&gt;, &lt;int&gt;))</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Say you want to have an app action show a mailbox message. First we retrieve the message (If your IMAP service supports it, fetch messages by ``uid`` field to avoid using old sequence references).</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+mymessage = imapdb(imapdb.INBOX.uid == &lt;uid&gt;).select().first()</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Otherwise, you can use the message&#x27;s ``id``.</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+mymessage = imapdb.INBOX[&lt;id&gt;]</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Note that using the message&#x27;s id as reference is not recommended, because sequence numbers can change with mailbox mantainance operations as message deletions. If you still want to record references to messages (i.e. in another database&#x27;s record field), the solution is to use the uid field as reference whenever supported, and retrieve each message with the recorded value.</div><div class="insert">+</div><div class="insert">+Finally, add something like the following to show the message content in a view</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+{{=P(T(&quot;Message from&quot;), &quot; &quot;, mymessage.sender)}}</div><div class="insert">+{{=P(T(&quot;Received on&quot;), &quot; &quot;, mymessage.created)}}</div><div class="insert">+{{=H5(mymessage.subject)}}</div><div class="insert">+{{for text in mymessage.content:}}</div><div class="insert">+  {{=DIV(text)}}</div><div class="insert">+  {{=TR()}}</div><div class="insert">+{{pass}}</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+As expected, we can take advantage of the ``SQLTABLE`` helper to build message lists in views</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+{{=SQLTABLE(myset.select(), linkto=URL(...))}}</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+And of course, it&#x27;s possible to feed a form helper with the appropiate sequence id value</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+{{=SQLFORM(imapdb.INBOX, &lt;message id&gt;, fields=[...])}}</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+The current adapter supported fields available are the following:</div><div class="insert">+</div><div class="insert">+---------------------------------------</div><div class="insert">+**Field** | **Type** | **Description**</div><div class="insert">+uid | string | ````</div><div class="insert">+answered | boolean | Flag</div><div class="insert">+created | date | ````</div><div class="insert">+content | list:string | A list of text or html parts</div><div class="insert">+to | string | ````</div><div class="insert">+cc | string | ````</div><div class="insert">+bcc | string | ````</div><div class="insert">+size | integer | the amount of octets of the message*</div><div class="insert">+deleted | boolean | Flag</div><div class="insert">+draft | boolean | Flag</div><div class="insert">+flagged | boolean | Flag</div><div class="insert">+sender | string | ````</div><div class="insert">+recent | boolean | Flag</div><div class="insert">+seen | boolean  | Flag</div><div class="insert">+subject | string| ````</div><div class="insert">+mime | string | The mime header declaration</div><div class="insert">+email | string | The complete RFC822 message**</div><div class="insert">+attachments | list:string | Each non text decoded part as string</div><div class="insert">+---------------------------------------------------</div><div class="insert">+</div><div class="insert">+*At the application side it is measured as the length of the RFC822</div><div class="insert">+message string</div><div class="insert">+</div><div class="insert">+**WARNING**: As row id&#x27;s are mapped to email sequence numbers, make sure your imap client web2py app does not delete messages</div><div class="insert">+during select or update actions, to prevent updating or deleting different messages.</div><div class="insert">+</div><div class="insert">+</div><div class="insert">+Standard ``CRUD`` database operations are not supported. There&#x27;s no way of defining custom fields or tables and make inserts with different data types because updating mailboxes with IMAP services is usually reduced to posting flag updates to the server. Still, it&#x27;s possible to access those flag commands trough DAL IMAP inteface</div><div class="insert">+</div><div class="insert">+To mark last query messages as seen</div><div class="insert">+``</div><div class="insert">+seen = imapdb(q).update(seen=True)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+</div><div class="insert">+Here we delete messages in the imap database that have mails from mr. Gumby</div><div class="insert">+``</div><div class="insert">+deleted = 0</div><div class="insert">+for tablename in imapdb.tables():</div><div class="insert">+    deleted += imapdb(imapdb[tablename].sender.contains(&quot;gumby&quot;)).delete()</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+</div><div class="insert">+It is possible also to mark messages for deletion instead of ereasing them</div><div class="insert">+directly with</div><div class="insert">+``</div><div class="insert">+myset.update(deleted=True)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+``IMAP``:inxx</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">-## Emails and SMS</div><div class="delete">-</div><div class="delete">-``Mail``:inxx</div><div class="delete">-</div><div class="delete">-### Setting up email</div><div class="delete">-</div><div class="delete">-Web2py provides the ``gluon.tools.Mail`` class to make it easy to send emails using web2py. One can define a mailer with</div><div class="delete">-``</div><div class="delete">-from gluon.tools import Mail</div><div class="delete">-mail = Mail()</div><div class="delete">-mail.settings.server = &#x27;smtp.example.com:25&#x27;</div><div class="delete">-mail.settings.sender = &#x27;you@example.com&#x27;</div><div class="delete">-mail.settings.login = &#x27;username:password&#x27;</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Note, if your application uses ``Auth`` (discussed in the next chapter), the ``auth`` object will include its own mailer in ``auth.settings.mailer``, so you can use that instead as follows:</div><div class="delete">-``</div><div class="delete">-mail = auth.settings.mailer</div><div class="delete">-mail.settings.server = &#x27;smtp.example.com:25&#x27;</div><div class="delete">-mail.settings.sender = &#x27;you@example.com&#x27;</div><div class="delete">-mail.settings.login = &#x27;username:password&#x27;</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-You need to replace the mail.settings with the proper parameters for your SMTP server. Set ``mail.settings.login = None`` if the SMTP server does not require authentication.</div><div class="delete">-</div><div class="delete">-``email logging``:inxx</div><div class="delete">-</div><div class="delete">-For debugging purposes you can set</div><div class="delete">-``</div><div class="delete">-mail.settings.server = &#x27;logging&#x27;</div><div class="delete">-``:code</div><div class="delete">-and emails will not be sent but logged to the console instead.</div><div class="delete">-</div><div class="delete">-#### Configuring email for Google App Engine</div><div class="delete">-``email from GAE``:inxx</div><div class="delete">-For sending emails from Google App Engine account:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-mail.settings.server = &#x27;gae&#x27;</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-At the time of writing web2py does not support attachments and encrypted emails on Google App Engine. Notice cron and scheduler do not work on GAE.</div><div class="delete">-</div><div class="delete">-#### x509 and PGP Encryption</div><div class="delete">-``PGP``:inxx ``x509``:inxx</div><div class="delete">-</div><div class="delete">-It is possible to send x509 (SMIME) encrypted emails using the following settings:</div><div class="delete">-``</div><div class="delete">-mail.settings.cipher_type = &#x27;x509&#x27;</div><div class="delete">-mail.settings.sign = True</div><div class="delete">-mail.settings.sign_passphrase = &#x27;your passphrase&#x27;</div><div class="delete">-mail.settings.encrypt = True</div><div class="delete">-mail.settings.x509_sign_keyfile = &#x27;filename.key&#x27;</div><div class="delete">-mail.settings.x509_sign_certfile = &#x27;filename.cert&#x27;</div><div class="delete">-mail.settings.x509_crypt_certfiles = &#x27;filename.cert&#x27;</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-It is possible to send PGP encrypted emails using the following settings:</div><div class="delete">-``</div><div class="delete">-from gpgme import pgp</div><div class="delete">-mail.settings.cipher_type = &#x27;gpg&#x27;</div><div class="delete">-mail.settings.sign = True</div><div class="delete">-mail.settings.sign_passphrase = &#x27;your passphrase&#x27;</div><div class="delete">-mail.settings.encrypt = True</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-The latter requires the python-pyme package.</div><div class="delete">-</div><div class="delete">-### Sending emails</div><div class="delete">-``mail.send``:inxx ``email html``:inxx ``email attachments``:inxx</div><div class="delete">-</div><div class="delete">-Once ``mail`` is defined, it can be used to send email via:</div><div class="delete">-``</div><div class="delete">-mail.send(to=[&#x27;somebody@example.com&#x27;],</div><div class="delete">-          subject=&#x27;hello&#x27;,</div><div class="delete">-          # If reply_to is omitted, then mail.settings.sender is used</div><div class="delete">-          reply_to=&#x27;us@example.com&#x27;,</div><div class="delete">-          message=&#x27;hi there&#x27;)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Mail returns ``True`` if it succeeds in sending the email and ``False`` otherwise.  A complete argument list for ``mail.send()`` is as follows:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-send(self, to, subject=&#x27;None&#x27;, message=&#x27;None&#x27;, attachments=1,</div><div class="delete">-     cc=1, bcc=1, reply_to=1, encoding=&#x27;utf-8&#x27;,headers={},</div><div class="delete">-     sender=None)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Note, ``to``, ``cc``, and ``bcc`` each take a list of email addresses.</div><div class="delete">-</div><div class="delete">-``headers`` is dictionary of headers to refine the headers just before sending the email. For example:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-headers = {&#x27;Return-Path&#x27; : &#x27;bounces@example.org&#x27;}</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-``sender`` defaults to ``None`` and in this case the sender will be set to ``mail.settings.sender``.</div><div class="delete">-</div><div class="delete">-Following are some additional examples demonstrating the use of ``mail.send()``.</div><div class="delete">-</div><div class="delete">-#### Simple text email</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-mail.send(&#x27;you@example.com&#x27;,</div><div class="delete">-  &#x27;Message subject&#x27;,</div><div class="delete">-  &#x27;Plain text body of the message&#x27;)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-#### HTML emails</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-mail.send(&#x27;you@example.com&#x27;,</div><div class="delete">-  &#x27;Message subject&#x27;,</div><div class="delete">-  &#x27;&lt;html&gt;html body&lt;/html&gt;&#x27;)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-If the email body starts with ``&lt;html&gt;`` and ends with ``&lt;/html&gt;``, it will be sent as a HTML email.</div><div class="delete">-</div><div class="delete">-#### Combining text and HTML emails</div><div class="delete">-</div><div class="delete">-The email message can be a tuple (text, html):</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-mail.send(&#x27;you@example.com&#x27;,</div><div class="delete">-  &#x27;Message subject&#x27;,</div><div class="delete">-  (&#x27;Plain text body&#x27;, &#x27;&lt;html&gt;html body&lt;/html&gt;&#x27;))</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-#### ``cc`` and ``bcc`` emails</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-mail.send(&#x27;you@example.com&#x27;,</div><div class="delete">-  &#x27;Message subject&#x27;,</div><div class="delete">-  &#x27;Plain text body&#x27;,</div><div class="delete">-  cc=[&#x27;other1@example.com&#x27;, &#x27;other2@example.com&#x27;],</div><div class="delete">-  bcc=[&#x27;other3@example.com&#x27;, &#x27;other4@example.com&#x27;])</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-#### Attachments</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-mail.send(&#x27;you@example.com&#x27;,</div><div class="delete">-  &#x27;Message subject&#x27;,</div><div class="delete">-  &#x27;&lt;html&gt;&lt;img src=&quot;cid:photo&quot; /&gt;&lt;/html&gt;&#x27;,</div><div class="delete">-  attachments = mail.Attachment(&#x27;/path/to/photo.jpg&#x27;, content_id=&#x27;photo&#x27;))</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-#### Multiple attachments</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-mail.send(&#x27;you@example.com&#x27;,</div><div class="delete">-  &#x27;Message subject&#x27;,</div><div class="delete">-  &#x27;Message body&#x27;,</div><div class="delete">-  attachments = [mail.Attachment(&#x27;/path/to/fist.file&#x27;),</div><div class="delete">-                 mail.Attachment(&#x27;/path/to/second.file&#x27;)])</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-### Sending SMS messages</div><div class="delete">-``SMS``:inxx</div><div class="delete">-Sending SMS messages from a web2py application requires a third party service that can relay the messages to the receiver. Usually this is not a free service, but it differs from country to country. We have tried a few of these services with little success. Phone companies block emails originating from these services since they are eventually used as a source of spam.</div><div class="delete">-</div><div class="delete">-A better way is to use the phone companies themselves to relay the SMS. Each phone company has an email address uniquely associated with every cell-phone number, so SMS messages can be sent as emails to the phone number.</div><div class="delete">-</div><div class="delete">-web2py comes with a module to help in this process:</div><div class="delete">-``</div><div class="delete">-from gluon.contrib.sms_utils import SMSCODES, sms_email</div><div class="delete">-email = sms_email(&#x27;1 (111) 111-1111&#x27;,&#x27;T-Mobile USA (tmail)&#x27;)</div><div class="delete">-mail.sent(to=email, subject=&#x27;test&#x27;, message=&#x27;test&#x27;)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-SMSCODES is a dictionary that maps names of major phone companies to the email address postfix. The ``sms_email`` function takes a phone number (as a string) and the name of a phone company and returns the email address of the phone.</div><div class="delete">-</div><div class="delete">-### Using the template system to generate messages</div><div class="delete">-``emails``:inxx</div><div class="delete">-</div><div class="delete">-It is possible to use the template system to generate emails. For example, consider the database table</div><div class="delete">-``</div><div class="delete">-db.define_table(&#x27;person&#x27;, Field(&#x27;name&#x27;))</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-where you want to send to every person in the database the following message,</div><div class="delete">-stored in a view file &quot;message.html&quot;:</div><div class="delete">-``</div><div class="delete">-Dear {{=person.name}},</div><div class="delete">-You have won the second prize, a set of steak knives.</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-You can achieve this in the following way</div><div class="delete">-``</div><div class="delete">-for person in db(db.person).select():</div><div class="delete">-    context = dict(person=person)</div><div class="delete">-    message = response.render(&#x27;message.html&#x27;, context)</div><div class="delete">-    mail.send(to=[&#x27;who@example.com&#x27;],</div><div class="delete">-              subject=&#x27;None&#x27;,</div><div class="delete">-              message=message)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Most of the work is done in the statement</div><div class="delete">-``</div><div class="delete">-response.render(&#x27;message.html&#x27;, context)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-It renders the view &quot;message.html&quot; with the variables defined in the dictionary &quot;context&quot;, and it returns a string with the rendered email text. The context is a dictionary that contains variables that will be visible to the template file.</div><div class="delete">-</div><div class="delete">-If the message starts with ``&lt;html&gt;`` and ends with ``&lt;/html&gt;``, the email will be an HTML email.</div><div class="delete">-</div><div class="delete">-Note, if you want to include a link back to your website in an HTML email, you can use the ``URL`` function. However, by default, the ``URL`` function generates a relative URL, which will not work from an email. To generate an absolute URL, you need to specify the ``scheme`` and ``host`` arguments to the URL function. For example:</div><div class="delete">-``</div><div class="delete">-&lt;a href=&quot;{{=URL(..., scheme=True, host=True)}}&quot;&gt;Click here&lt;/a&gt;</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-or</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-&lt;a href=&quot;{{=URL(..., scheme=&#x27;http&#x27;, host=&#x27;www.site.com&#x27;)}}&quot;&gt;Click here&lt;/a&gt;</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-The same mechanism that is used to generate email text can also be used to generate SMS messages or any other type of message based on a template.</div><div class="delete">-</div><div class="delete">-### Sending messages using a background task</div><div class="delete">-</div><div class="delete">-The operation of sending an email message can take up to several seconds because of the need to log into and communicate with a potentially remote SMTP server. To keep the user from having to wait for the send operation to complete, it is sometimes desirable to queue the email to be sent at a later time via a background task. As described in Chapter 4, this can be done by setting up a homemade task queue or using the web2py scheduler. Here we provide an example using a homemade task queue.</div><div class="delete">-</div><div class="delete">-First, in a model file within our application, we set up a database model to store our email queue:</div><div class="delete">-``</div><div class="delete">-db.define_table(&#x27;queue&#x27;,</div><div class="delete">-    Field(&#x27;status&#x27;),</div><div class="delete">-    Field(&#x27;email&#x27;),</div><div class="delete">-    Field(&#x27;subject&#x27;),</div><div class="delete">-    Field(&#x27;message&#x27;))</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-From a controller, we can then enqueue messages to be sent by:</div><div class="delete">-``</div><div class="delete">-db.queue.insert(status=&#x27;pending&#x27;,</div><div class="delete">-                email=&#x27;you@example.com&#x27;,</div><div class="delete">-                subject=&#x27;test&#x27;,</div><div class="delete">-                message=&#x27;test&#x27;)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Next, we need a background processing script that reads the queue and sends the emails:</div><div class="delete">-``</div><div class="delete">-## in file /app/private/mail_queue.py</div><div class="delete">-import time</div><div class="delete">-while True:</div><div class="delete">-    rows = db(db.queue.status==&#x27;pending&#x27;).select()</div><div class="delete">-    for row in rows:</div><div class="delete">-        if mail.send(to=row.email,</div><div class="delete">-            subject=row.subject,</div><div class="delete">-            message=row.message):</div><div class="delete">-            row.update_record(status=&#x27;sent&#x27;)</div><div class="delete">-        else:</div><div class="delete">-            row.update_record(status=&#x27;failed&#x27;)</div><div class="delete">-        db.commit()</div><div class="delete">-    time.sleep(60) # check every minute</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Finally, as described in Chapter 4, we need to run the mail_queue.py script as if it were inside a controller in our app:</div><div class="delete">-``</div><div class="delete">-python web2py.py -S app -M -N -R applications/app/private/mail_queue.py</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-where ``-S app`` tells web2py to run &quot;mail_queue.py&quot; as &quot;app&quot;, ``-M`` tells web2py to execute models, and ``-N`` tells web2py not to run cron.</div><div class="delete">-</div><div class="delete">-Here we assume that the ``mail`` object referenced in &quot;mail_queue.py&quot; is defined in a model file in our app and is therefore available in the &quot;mail_queue.py&quot; script because of the ``-M`` option. Also notice that it is important to commit any change as soon as possible in order not to lock the database to other concurrent processes.</div><div class="delete">-</div><div class="delete">-As noted in Chapter 4, this type of background process should not be executed via cron (except perhaps for cron @reboot) because you need to be sure that no more than one instance is running at the same time.</div><div class="delete">-</div><div class="delete">-Note, one drawback to sending email via a background process is that it makes it difficult to provide feedback to the user in case the email fails. If email is sent directly from the controller action, you can catch any errors and immediately return an error message to the user. With a background process, however, the email is sent asynchronously, after the controller action has already returned its response, so it becomes more complex to notify the user of a failure.</div><div class="delete">-</div><div class="delete">-</div><div class="delete">-### Reading and managing email boxes (Experimental)</div><div class="delete">-</div><div class="delete">-The ``IMAP`` adapter is intended as an interface with email IMAP servers to perform simple queries in the web2py ``DAL`` query syntax, so email read, search and other related IMAP mail services (as those implemented by brands like Google(r), and Yahoo(r) can be managed from web2py applications.</div><div class="delete">-</div><div class="delete">-It creates its table and field names &quot;statically&quot;, meaning that the developer should leave the table and field definitions to the DAL instance by calling the adapter ``.define_tables()`` method. The tables are defined with the IMAP server mailbox list information.</div><div class="delete">-</div><div class="delete">-</div><div class="delete">-#### Connection</div><div class="delete">-</div><div class="delete">-For a single mail account, this is the code recommended to start imap support at the app&#x27;s model</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-# Replace user, password, server and port in the connection string</div><div class="delete">-# Set port as 993 for ssl support</div><div class="delete">-imapdb = DAL(&quot;imap://user:password@server:port&quot;, pool_size=1)</div><div class="delete">-imapdb.define_tables()</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Note that ``&lt;imapdb&gt;.define_tables()`` returns a dictionary of strings mapping dal tablenames to the server mailbox names with the structure ``{&lt;tablename&gt;: &lt;server mailbox name&gt;, ...}``, so you can get the actual mailbox name in the IMAP server.</div><div class="delete">-</div><div class="delete">-</div><div class="delete">-To handle the different native mailbox names for the user interface,  the following attributes give access to the adapter auto mailbox mapped names (which native mailbox has what table name and vice versa):</div><div class="delete">-</div><div class="delete">-**Attribute** | **Type** | **Format**</div><div class="delete">-imapdb.mailboxes | dict | ``{&lt;tablename&gt;: &lt;server native name&gt;, ...}``</div><div class="delete">-imapdb.&lt;table&gt;.mailbox | string | ``&quot;server native name&quot;``</div><div class="delete">-</div><div class="delete">-The first can be useful to retrieve imap query sets by the native email service mailbox</div><div class="delete">-``</div><div class="delete">-# mailbox is a string containing the actual mailbox name</div><div class="delete">-tablenames = dict([(v,k) for k,v in imapdb.mailboxes.items()])</div><div class="delete">-myset = imapdb(imapdb[tablenames[mailbox]])</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-#### Fetching mail and updating flags</div><div class="delete">-</div><div class="delete">-Here&#x27;s a list of imap commands you could use in the controller. For the examples, it&#x27;s assumed that your imap service has a mailbox named ``INBOX``, which is the case for Gmail(r) accounts.</div><div class="delete">-</div><div class="delete">-</div><div class="delete">-To count today&#x27;s unseen messages smaller than 6000 octets from the inbox mailbox do</div><div class="delete">-``</div><div class="delete">-q = imapdb.INBOX.seen == False</div><div class="delete">-q &amp;= imapdb.INBOX.created == datetime.date.today()</div><div class="delete">-q &amp;= imapdb.INBOX.size &lt; 6000</div><div class="delete">-unread = imapdb(q).count()</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-</div><div class="delete">-You can fetch the previous query messages with</div><div class="delete">-``</div><div class="delete">-rows = imapdb(q).select()</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-</div><div class="delete">-Usual query operators are implemented, including belongs</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-messages = imapdb(imapdb.INBOX.uid.belongs(&lt;uid sequence&gt;)).select()</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-**Note**: It&#x27;s strongly adviced that you keep the query results below a given data size threshold to avoid jamming the server with large select commands. As of now, the messages are retrieved entirely by the adapter before any filter by field can be applied.</div><div class="delete">-</div><div class="delete">-It is possible to filter query select results with limitby and sequences of mailbox fields</div><div class="delete">-``</div><div class="delete">-# Replace the arguments with actual values</div><div class="delete">-myset.select(&lt;fields sequence&gt;, limitby=(&lt;int&gt;, &lt;int&gt;))</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Say you want to have an app action show a mailbox message. First we retrieve the message (If your IMAP service supports it, fetch messages by ``uid`` field to avoid using old sequence references).</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-mymessage = imapdb(imapdb.INBOX.uid == &lt;uid&gt;).select().first()</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Otherwise, you can use the message&#x27;s ``id``.</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-mymessage = imapdb.INBOX[&lt;id&gt;]</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Note that using the message&#x27;s id as reference is not recommended, because sequence numbers can change with mailbox mantainance operations as message deletions. If you still want to record references to messages (i.e. in another database&#x27;s record field), the solution is to use the uid field as reference whenever supported, and retrieve each message with the recorded value.</div><div class="delete">-</div><div class="delete">-Finally, add something like the following to show the message content in a view</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-{{=P(T(&quot;Message from&quot;), &quot; &quot;, mymessage.sender)}}</div><div class="delete">-{{=P(T(&quot;Received on&quot;), &quot; &quot;, mymessage.created)}}</div><div class="delete">-{{=H5(mymessage.subject)}}</div><div class="delete">-{{for text in mymessage.content:}}</div><div class="delete">-  {{=DIV(text)}}</div><div class="delete">-  {{=TR()}}</div><div class="delete">-{{pass}}</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-As expected, we can take advantage of the ``SQLTABLE`` helper to build message lists in views</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-{{=SQLTABLE(myset.select(), linkto=URL(...))}}</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-And of course, it&#x27;s possible to feed a form helper with the appropiate sequence id value</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-{{=SQLFORM(imapdb.INBOX, &lt;message id&gt;, fields=[...])}}</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-The current adapter supported fields available are the following:</div><div class="delete">-</div><div class="delete">-**Field** | **Type** | **Description**</div><div class="delete">-uid | string | ````</div><div class="delete">-answered | boolean | Flag</div><div class="delete">-created | date | ````</div><div class="delete">-content | list:string | A list of text or html parts</div><div class="delete">-to | string | ````</div><div class="delete">-cc | string | ````</div><div class="delete">-bcc | string | ````</div><div class="delete">-size | integer | the amount of octets of the message*</div><div class="delete">-deleted | boolean | Flag</div><div class="delete">-draft | boolean | Flag</div><div class="delete">-flagged | boolean | Flag</div><div class="delete">-sender | string | ````</div><div class="delete">-recent | boolean | Flag</div><div class="delete">-seen | boolean  | Flag</div><div class="delete">-subject | string| ````</div><div class="delete">-mime | string | The mime header declaration</div><div class="delete">-email | string | The complete RFC822 message**</div><div class="delete">-attachments | list:string | Each non text decoded part as string</div><div class="delete">-</div><div class="delete">-*At the application side it is measured as the length of the RFC822</div><div class="delete">-message string</div><div class="delete">-</div><div class="delete">-**WARNING**: As row id&#x27;s are mapped to email sequence numbers, make sure your imap client web2py app does not delete messages</div><div class="delete">-during select or update actions, to prevent updating or deleting different messages.</div><div class="delete">-</div><div class="delete">-</div><div class="delete">-Standard ``CRUD`` database operations are not supported. There&#x27;s no way of defining custom fields or tables and make inserts with different data types because updating mailboxes with IMAP services is usually reduced to posting flag updates to the server. Still, it&#x27;s possible to access those flag commands trough DAL IMAP inteface</div><div class="delete">-</div><div class="delete">-To mark last query messages as seen</div><div class="delete">-``</div><div class="delete">-seen = imapdb(q).update(seen=True)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-</div><div class="delete">-Here we delete messages in the imap database that have mails from mr. Gumby</div><div class="delete">-``</div><div class="delete">-deleted = 0</div><div class="delete">-for tablename in imapdb.tables():</div><div class="delete">-    deleted += imapdb(imapdb[tablename].sender.contains(&quot;gumby&quot;)).delete()</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-</div><div class="delete">-It is possible also to mark messages for deletion instead of ereasing them</div><div class="delete">-directly with</div><div class="delete">-``</div><div class="delete">-myset.update(deleted=True)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-``IMAP``:inxx</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/bb5fb21852c40f3b628510ef0be7a07d53cf4f9d">bb5fb21</a><ul><li>Date : 2012-09-16</li><li>Update sources/29-web2py-english/08.markmin</li></ul></li></ul>
<div class="row-fluid" id="com_bb5fb21852c40f3b628510ef0be7a07d53cf4f9d">
    <div class="span6"><div class="diff"><div class="insert">The current adapter supported fields available are the <span class="highlight"></span>follow<span class="highlight">ing</span>:</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">The current adapter supported fields available are the <span class="highlight">as </span>follow<span class="highlight">s</span>:</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/885e6c33d6165e8cccf89b33130de7a03534b119">885e6c3</a><ul><li>Date : 2012-09-16</li><li>Update sources/29-web2py-english/08.markmin</li></ul></li></ul>
<div class="row-fluid" id="com_885e6c33d6165e8cccf89b33130de7a03534b119">
    <div class="span6"><div class="diff"><div class="insert">### Read<span class="highlight">ing and manag</span>ing email boxes (Experimental)</div><div class=""> </div><div class=""> The ``IMAP`` adapter is intended as an interface with email IMAP servers to perform simple queries in the web2py ``DAL`` query syntax, so email read, search and other related IMAP mail services (as those implemented by brands like Google(r), and Yahoo(r) can be managed from web2py applications.</div><div class=""> </div><div class=""> It creates its table and field names &quot;statically&quot;, meaning that the developer should leave the table and field definitions to the DAL instance by calling the adapter ``.define_tables()`` method. The tables are defined with the IMAP server mailbox list information.</div><div class=""> </div><div class=""> </div><div class=""> #### Connection</div><div class=""> </div><div class=""> For a single mail account, this is the code recommended to start imap support at the app&#x27;s model</div><div class=""> </div><div class=""> ``</div><div class=""> # Replace user, password, server and port in the connection string</div><div class=""> # Set port as 993 for ssl support</div><div class=""> imapdb = DAL(&quot;imap://user:password@server:port&quot;, pool_size=1)</div><div class=""> imapdb.define_tables()</div><div class=""> ``:code</div><div class=""> </div><div class=""> Note that ``&lt;imapdb&gt;.define_tables()`` returns a dictionary of strings mapping dal tablenames to the server mailbox names with the structure ``{&lt;tablename&gt;: &lt;server mailbox name&gt;, ...}``, so you can get the actual mailbox name in the IMAP server.</div><div class=""> </div><div class=""> </div><div class=""> To handle the different native mailbox names for the user interface,  the following attributes give access to the adapter auto mailbox mapped names (which native mailbox has what table name and vice versa):</div><div class=""> </div><div class=""> -------------------------------------------------------</div><div class=""> **Attribute** | **Type** | **Format**</div><div class=""> =======================================================================</div><div class=""> imapdb.mailboxes | dict | {&lt;tablename&gt;: &lt;server native name&gt;, ...}</div><div class=""> imapdb.mailbox_names | dict | {&lt;server native name&gt;: &lt;tablename&gt;, ...}</div><div class=""> =======================================================================</div><div class=""> -------------------------------------------------------</div><div class=""> </div><div class=""> You can fetch the previous query messages with</div><div class=""> rows = imapdb(q).select()</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> Usual query operators are implemented, including belongs</div><div class=""> </div><div class=""> ``</div><div class=""> messages = imapdb(imapdb.INBOX.uid.belongs(&lt;uid sequence&gt;)).select()</div><div class=""> ``:code</div><div class=""> </div><div class=""> **Note**: It&#x27;s strongly adviced that you keep the query results below a given data size threshold to avoid jamming the server with large select commands. As of now, the messages are retrieved entirely by the adapter before any filter by field can be applied.</div><div class=""> </div><div class=""> It is possible to filter query select results with limitby and sequences of mailbox fields</div><div class=""> ``</div><div class=""> # Replace the arguments with actual values</div><div class=""> myset.select(&lt;fields sequence&gt;, limitby=(&lt;int&gt;, &lt;int&gt;))</div><div class=""> ``:code</div><div class=""> </div><div class=""> Say you want to have an app action show a mailbox message. First we retrieve the message (If your IMAP service supports it, fetch messages by ``uid`` field to avoid using old sequence references).</div><div class=""> </div><div class=""> ``</div><div class=""> mymessage = imapdb(imapdb.INBOX.uid == &lt;uid&gt;).select().first()</div><div class=""> ``:code</div><div class=""> </div><div class=""> Otherwise, you can use the message&#x27;s ``id``.</div><div class=""> </div><div class=""> ``</div><div class=""> mymessage = imapdb.INBOX[&lt;id&gt;]</div><div class=""> ``:code</div><div class=""> </div><div class="insert"><span class="highlight">Note that using the message&#x27;s id as reference is not recommended, because sequence numbers can change with mailbox mantainance operations as message deletions. If you still want to record references to messages (i.e. in another database&#x27;s record field), the solution is to use the uid field as reference whenever supported, and retrieve each message with the recorded value.</span></div><div class=""> </div><div class=""> Finally, add something like the following to show the message content in a view</div><div class=""> </div><div class=""> ``</div><div class=""> {{=P(T(&quot;Message from&quot;), &quot; &quot;, mymessage.sender)}}</div><div class=""> {{=P(T(&quot;Received on&quot;), &quot; &quot;, mymessage.created)}}</div><div class=""> {{=H5(mymessage.subject)}}</div><div class=""> {{for text in mymessage.content:}}</div><div class="">   {{=DIV(text)}}</div><div class="">   {{=TR()}}</div><div class=""> {{pass}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> As expected, we can take advantage of the ``SQLTABLE`` helper to build message lists in views</div><div class=""> </div><div class=""> ``</div><div class=""> {{=SQLTABLE(myset.select(), linkto=URL(...))}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> And of course, it&#x27;s possible to feed a form helper with the appropiate sequence id value</div><div class=""> </div><div class=""> ``</div><div class=""> {{=SQLFORM(imapdb.INBOX, &lt;message id&gt;, fields=[...])}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> The current adapter supported fields available are the as follows:</div><div class=""> </div><div class=""> ---------------------------------------</div><div class=""> **Field** | **Type** | **Description**</div><div class=""> =======================================</div><div class=""> uid | string |</div><div class=""> answered | boolean | Flag</div><div class=""> created | date |</div><div class=""> content | list:string | A list of text or html parts</div><div class=""> to | string |</div><div class=""> cc | string |</div><div class=""> bcc | string |</div><div class=""> size | integer | the amount of octets of the message*</div><div class=""> deleted | boolean | Flag</div><div class=""> draft | boolean | Flag</div><div class=""> flagged | boolean | Flag</div><div class=""> sender | string |</div><div class=""> recent | boolean | Flag</div><div class=""> seen | boolean  | Flag</div><div class=""> subject | string|</div><div class=""> mime | string | The mime header declaration</div><div class=""> email | string | The complete RFC822 message**</div><div class=""> attachments | list:string | Each non text decoded part as string</div><div class=""> ================================================================</div><div class=""> ----------------------------------------------------------------</div><div class=""> </div><div class=""> *At the application side it is measured as the length of the RFC822</div><div class=""> message string</div><div class=""> </div><div class=""> **WARNING**: As row id&#x27;s are mapped to email sequence numbers, make sure your imap client web2py app does not delete messages</div><div class=""> during select or update actions, to prevent updating or deleting different messages.</div><div class=""> </div><div class=""> </div><div class="insert">+Standard ``CRUD`` database operations are not supported. There&#x27;s no way of defining custom fields or tables and make inserts with different data types because updating mailboxes with IMAP services is usually reduced to posting flag updates to the server. Still, it&#x27;s possible to access those flag commands trough DAL IMAP inteface</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">### Read<span class="highlight"></span>ing email boxes (Experimental)</div><div class=""> </div><div class=""> The ``IMAP`` adapter is intended as an interface with email IMAP servers to perform simple queries in the web2py ``DAL`` query syntax, so email read, search and other related IMAP mail services (as those implemented by brands like Google(r), and Yahoo(r) can be managed from web2py applications.</div><div class=""> </div><div class=""> It creates its table and field names &quot;statically&quot;, meaning that the developer should leave the table and field definitions to the DAL instance by calling the adapter ``.define_tables()`` method. The tables are defined with the IMAP server mailbox list information.</div><div class=""> </div><div class=""> </div><div class=""> #### Connection</div><div class=""> </div><div class=""> For a single mail account, this is the code recommended to start imap support at the app&#x27;s model</div><div class=""> </div><div class=""> ``</div><div class=""> # Replace user, password, server and port in the connection string</div><div class=""> # Set port as 993 for ssl support</div><div class=""> imapdb = DAL(&quot;imap://user:password@server:port&quot;, pool_size=1)</div><div class=""> imapdb.define_tables()</div><div class=""> ``:code</div><div class=""> </div><div class=""> Note that ``&lt;imapdb&gt;.define_tables()`` returns a dictionary of strings mapping dal tablenames to the server mailbox names with the structure ``{&lt;tablename&gt;: &lt;server mailbox name&gt;, ...}``, so you can get the actual mailbox name in the IMAP server.</div><div class=""> </div><div class=""> </div><div class=""> To handle the different native mailbox names for the user interface,  the following attributes give access to the adapter auto mailbox mapped names (which native mailbox has what table name and vice versa):</div><div class=""> </div><div class=""> -------------------------------------------------------</div><div class=""> **Attribute** | **Type** | **Format**</div><div class=""> =======================================================================</div><div class=""> imapdb.mailboxes | dict | {&lt;tablename&gt;: &lt;server native name&gt;, ...}</div><div class=""> imapdb.mailbox_names | dict | {&lt;server native name&gt;: &lt;tablename&gt;, ...}</div><div class=""> =======================================================================</div><div class=""> -------------------------------------------------------</div><div class=""> </div><div class=""> You can fetch the previous query messages with</div><div class=""> rows = imapdb(q).select()</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> Usual query operators are implemented, including belongs</div><div class=""> </div><div class=""> ``</div><div class=""> messages = imapdb(imapdb.INBOX.uid.belongs(&lt;uid sequence&gt;)).select()</div><div class=""> ``:code</div><div class=""> </div><div class=""> **Note**: It&#x27;s strongly adviced that you keep the query results below a given data size threshold to avoid jamming the server with large select commands. As of now, the messages are retrieved entirely by the adapter before any filter by field can be applied.</div><div class=""> </div><div class=""> It is possible to filter query select results with limitby and sequences of mailbox fields</div><div class=""> ``</div><div class=""> # Replace the arguments with actual values</div><div class=""> myset.select(&lt;fields sequence&gt;, limitby=(&lt;int&gt;, &lt;int&gt;))</div><div class=""> ``:code</div><div class=""> </div><div class=""> Say you want to have an app action show a mailbox message. First we retrieve the message (If your IMAP service supports it, fetch messages by ``uid`` field to avoid using old sequence references).</div><div class=""> </div><div class=""> ``</div><div class=""> mymessage = imapdb(imapdb.INBOX.uid == &lt;uid&gt;).select().first()</div><div class=""> ``:code</div><div class=""> </div><div class=""> Otherwise, you can use the message&#x27;s ``id``.</div><div class=""> </div><div class=""> ``</div><div class=""> mymessage = imapdb.INBOX[&lt;id&gt;]</div><div class=""> ``:code</div><div class=""> </div><div class="delete">-Note that using the id in a reference field is not supported, because there&#x27;s no way of writing to the tables the same way as in other standard database adapters. If you still want to record references to messages in another database, the solution is to use the uid field as reference whenever supported, and retrieve each message with the recorded value.</div><div class="delete"><span class="highlight"></span></div><div class=""> </div><div class=""> Finally, add something like the following to show the message content in a view</div><div class=""> </div><div class=""> ``</div><div class=""> {{=P(T(&quot;Message from&quot;), &quot; &quot;, mymessage.sender)}}</div><div class=""> {{=P(T(&quot;Received on&quot;), &quot; &quot;, mymessage.created)}}</div><div class=""> {{=H5(mymessage.subject)}}</div><div class=""> {{for text in mymessage.content:}}</div><div class="">   {{=DIV(text)}}</div><div class="">   {{=TR()}}</div><div class=""> {{pass}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> As expected, we can take advantage of the ``SQLTABLE`` helper to build message lists in views</div><div class=""> </div><div class=""> ``</div><div class=""> {{=SQLTABLE(myset.select(), linkto=URL(...))}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> And of course, it&#x27;s possible to feed a form helper with the appropiate sequence id value</div><div class=""> </div><div class=""> ``</div><div class=""> {{=SQLFORM(imapdb.INBOX, &lt;message id&gt;, fields=[...])}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> The current adapter supported fields available are the as follows:</div><div class=""> </div><div class=""> ---------------------------------------</div><div class=""> **Field** | **Type** | **Description**</div><div class=""> =======================================</div><div class=""> uid | string |</div><div class=""> answered | boolean | Flag</div><div class=""> created | date |</div><div class=""> content | list:string | A list of text or html parts</div><div class=""> to | string |</div><div class=""> cc | string |</div><div class=""> bcc | string |</div><div class=""> size | integer | the amount of octets of the message*</div><div class=""> deleted | boolean | Flag</div><div class=""> draft | boolean | Flag</div><div class=""> flagged | boolean | Flag</div><div class=""> sender | string |</div><div class=""> recent | boolean | Flag</div><div class=""> seen | boolean  | Flag</div><div class=""> subject | string|</div><div class=""> mime | string | The mime header declaration</div><div class=""> email | string | The complete RFC822 message**</div><div class=""> attachments | list:string | Each non text decoded part as string</div><div class=""> ================================================================</div><div class=""> ----------------------------------------------------------------</div><div class=""> </div><div class=""> *At the application side it is measured as the length of the RFC822</div><div class=""> message string</div><div class=""> </div><div class=""> **WARNING**: As row id&#x27;s are mapped to email sequence numbers, make sure your imap client web2py app does not delete messages</div><div class=""> during select or update actions, to prevent updating or deleting different messages.</div><div class=""> </div><div class="delete">-Sequence numbers change whenever the mailbox is updated. To avoid this sequence numbers issues, it is recommended the use</div><div class="delete">-of uid fields in query references (although the update and delete in separate actions rule still applies).</div><div class=""> </div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/ec3132989d6a44efafb59155ad3a3f06df599ec7">ec31329</a><ul><li>Date : 2012-10-05</li><li>Switch tablename and actual name in example</li></ul></li></ul>
<div class="row-fluid" id="com_ec3132989d6a44efafb59155ad3a3f06df599ec7">
    <div class="span6"><div class="diff"><div class=""> The second can be useful to retrieve imap query sets by the native email service mailbox</div><div class=""> ``</div><div class=""> # mailbox is a string containing the actual mailbox name</div><div class="insert">+tablenames = dict([(v,k) for k,v in imapdb.mailboxes.items()])</div><div class="insert">+tablename = tablenames[mailbox]</div><div class=""> myset = imapdb(imapdb[tablename])</div><div class=""> ``:code</div></div></div>
    <div class="span6"><div class="diff"><div class=""> The second can be useful to retrieve imap query sets by the native email service mailbox</div><div class=""> ``</div><div class=""> # mailbox is a string containing the actual mailbox name</div><div class="delete">-tablename = imapdb.mailboxes[mailbox]</div><div class=""> myset = imapdb(imapdb[tablename])</div><div class=""> ``:code</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/716473666742d68f3ed66204eb0682e076e90b99">7164736</a><ul><li>Date : 2012-09-16</li><li>Update sources/29-web2py-english/08.markmin</li></ul></li></ul>
<div class="row-fluid" id="com_716473666742d68f3ed66204eb0682e076e90b99">
    <div class="span6"><div class="diff"><div class=""> ``</div><div class=""> # Replace user, password, server and port in the connection string</div><div class=""> # Set port as 993 for ssl support</div><div class="insert">imapdb = DAL(&quot;imap://user:password@server:port&quot;<span class="highlight"></span>)</div><div class=""> imapdb.define_tables()</div><div class=""> ``:code</div><div class=""> </div><div class=""> Note that ``&lt;imapdb&gt;.define_tables()`` returns a dictionary of strings mapping dal tablenames to the server mailbox names with the structure ``{&lt;tablename&gt;: &lt;server mailbox name&gt;, ...}``, so you can get the actual mailbox name in the IMAP server.</div><div class=""> </div><div class=""> </div><div class=""> To handle the different native mailbox names for the user interface,  the following attributes give access to the adapter auto mailbox mapped names (which native mailbox has what table name and vice versa):</div><div class=""> </div><div class=""> -------------------------------------------------------</div><div class=""> **Attribute** | **Type** | **Format**</div><div class=""> =======================================================================</div><div class="insert">+imapdb.mailboxes | list | ``[&lt;tablename&gt;, ...]``</div><div class="insert">+imapdb.mailbox_names | dict | ``{&lt;tablename&gt;: &lt;server native name&gt;, ...}``</div><div class=""> =======================================================================</div><div class=""> -------------------------------------------------------</div></div></div>
    <div class="span6"><div class="diff"><div class=""> ``</div><div class=""> # Replace user, password, server and port in the connection string</div><div class=""> # Set port as 993 for ssl support</div><div class="delete">imapdb = DAL(&quot;imap://user:password@server:port&quot;<span class="highlight">, pool_size=1</span>)</div><div class=""> imapdb.define_tables()</div><div class=""> ``:code</div><div class=""> </div><div class=""> Note that ``&lt;imapdb&gt;.define_tables()`` returns a dictionary of strings mapping dal tablenames to the server mailbox names with the structure ``{&lt;tablename&gt;: &lt;server mailbox name&gt;, ...}``, so you can get the actual mailbox name in the IMAP server.</div><div class=""> </div><div class=""> </div><div class=""> To handle the different native mailbox names for the user interface,  the following attributes give access to the adapter auto mailbox mapped names (which native mailbox has what table name and vice versa):</div><div class=""> </div><div class=""> -------------------------------------------------------</div><div class=""> **Attribute** | **Type** | **Format**</div><div class=""> =======================================================================</div><div class="delete">-imapdb.mailboxes | dict | {&lt;tablename&gt;: &lt;server native name&gt;, ...}</div><div class="delete">-imapdb.mailbox_names | dict | {&lt;server native name&gt;: &lt;tablename&gt;, ...}</div><div class=""> =======================================================================</div><div class=""> -------------------------------------------------------</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/49f38ab7ef56de1eb4ef48f68427ebf8a46b505d">49f38ab</a><ul><li>Date : 2012-12-26</li><li>more small edits</li></ul></li></ul>
<div class="row-fluid" id="com_49f38ab7ef56de1eb4ef48f68427ebf8a46b505d">
    <div class="span6"><div class="diff"><div class=""> ---------------------------------------</div><div class=""> **Field** | **Type** | **Description**</div><div class="insert">uid | string |<span class="highlight"> ````</span></div><div class=""> answered | boolean | Flag</div><div class="insert">created | date |<span class="highlight"> ````</span></div><div class=""> content | list:string | A list of text or html parts</div><div class="insert">+to | string | ````</div><div class="insert">+cc | string | ````</div><div class="insert">+bcc | string | ````</div><div class=""> size | integer | the amount of octets of the message*</div><div class=""> deleted | boolean | Flag</div><div class=""> draft | boolean | Flag</div><div class=""> flagged | boolean | Flag</div><div class="insert">sender | string |<span class="highlight"> ````</span></div><div class=""> recent | boolean | Flag</div><div class=""> seen | boolean  | Flag</div><div class="insert">subject | string|<span class="highlight"> ````</span></div><div class=""> mime | string | The mime header declaration</div><div class=""> email | string | The complete RFC822 message**</div><div class=""> attachments | list:string | Each non text decoded part as string</div><div class=""> ---------------------------------------------------</div></div></div>
    <div class="span6"><div class="diff"><div class=""> ---------------------------------------</div><div class=""> **Field** | **Type** | **Description**</div><div class="delete">uid | string |<span class="highlight"></span></div><div class=""> answered | boolean | Flag</div><div class="delete">created | date |<span class="highlight"></span></div><div class=""> content | list:string | A list of text or html parts</div><div class="delete">-to | string |</div><div class="delete">-cc | string |</div><div class="delete">-bcc | string |</div><div class=""> size | integer | the amount of octets of the message*</div><div class=""> deleted | boolean | Flag</div><div class=""> draft | boolean | Flag</div><div class=""> flagged | boolean | Flag</div><div class="delete">sender | string |<span class="highlight"></span></div><div class=""> recent | boolean | Flag</div><div class=""> seen | boolean  | Flag</div><div class="delete">subject | string|<span class="highlight"></span></div><div class=""> mime | string | The mime header declaration</div><div class=""> email | string | The complete RFC822 message**</div><div class=""> attachments | list:string | Each non text decoded part as string</div><div class=""> ---------------------------------------------------</div></div></div>
</div>
<hr />


        
      </div>

      <div id="push"></div>
    </div>

    <div id="footer">
      <div class="container-fluid">
          <div class="copyright pull-left">Copyright &#169; 2013</div>
          <div id="poweredBy" class="pull-right">
              Powered by
              <a href="http://www.web2py.com/">web2py</a>
          </div>
      </div>
    </div>
<script src="static/js/bootstrap.min.js"></script>
<script src="static/js/web2py_bootstrap.js"></script>
</body>
</html>
