<!DOCTYPE html>
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7]><html class="ie ie6 ie-lte9 ie-lte8 ie-lte7 no-js" lang="en-us"> <![endif]-->
<!--[if IE 7]><html class="ie ie7 ie-lte9 ie-lte8 ie-lte7 no-js" lang="en-us"> <![endif]-->
<!--[if IE 8]><html class="ie ie8 ie-lte9 ie-lte8 no-js" lang="en-us"> <![endif]-->
<!--[if IE 9]><html class="ie9 ie-lte9 no-js" lang="en-us"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html class="no-js" lang="en-us"> <!--<![endif]-->
<head>
  <meta charset="utf-8" />
  <!-- www.phpied.com/conditional-comments-block-downloads/ -->
  <!-- Always force latest IE rendering engine
       (even in intranet) & Chrome Frame
       Remove this if you use the .htaccess -->
  <!--[if IE]>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <![endif]-->

  <title>Diffbook</title>

  <!-- http://dev.w3.org/html5/markup/meta.name.html -->
  <meta name="application-name" content="diffbook" />

  <!-- Speaking of Google, don't forget to set your site up:
       http://google.com/webmasters -->
  <meta name="google-site-verification" content="" />

  <!--  Mobile Viewport Fix
        j.mp/mobileviewport & davidbcalhoun.com/2010/viewport-metatag
        device-width: Occupy full width of the screen in its current orientation
        initial-scale = 1.0 retains dimensions instead of zooming out if page height > device height
        user-scalable = yes allows the user to zoom in -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="shortcut icon" href="static/images/favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" href="static/images/favicon.png">

  <!-- All JavaScript at the bottom, except for Modernizr which enables
       HTML5 elements & feature detects -->
  <script src="static/js/modernizr.custom.js"></script>

  <!-- include stylesheets -->
  

  <script type="text/javascript"><!--
    // These variables are used by the web2py_ajax_init function in web2py_ajax.js (which is loaded below).
    var w2p_ajax_confirm_message = "Are you sure you want to delete this object?";
    var w2p_ajax_date_format = "%Y-%m-%d";
    var w2p_ajax_datetime_format = "%Y-%m-%d %H:%M:%S";
    //--></script>
<meta name="keywords" content="web2py, python, framework" />

<meta name="description" content="a cool new app" />

<meta name="generator" content="Web2py Web Framework" />

<meta name="author" content="Your Name &lt;you@example.com&gt;" />
<script src="static/js/jquery.js" type="text/javascript"></script><link href="static/css/calendar.css" rel="stylesheet" type="text/css" /><script src="static/js/calendar.js" type="text/javascript"></script><script src="static/js/web2py.js" type="text/javascript"></script><link href="static/css/web2py.css" rel="stylesheet" type="text/css" /><link href="static/css/bootstrap.min.css" rel="stylesheet" type="text/css" /><link href="static/css/bootstrap-responsive.min.css" rel="stylesheet" type="text/css" /><link href="static/css/web2py_bootstrap.css" rel="stylesheet" type="text/css" />


  

  <!-- uncomment here to load jquery-ui
       <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/themes/base/jquery-ui.css" type="text/css" media="all" />
       <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js" type="text/javascript"></script>
       uncomment to load jquery-ui //-->
  <noscript><link href="static/css/web2py_bootstrap_nojs.css" rel="stylesheet" type="text/css" /></noscript>
  
  <style type="text/css">

      /* Sticky footer styles
      -------------------------------------------------- */

      html,
      body {
        height: 100%;
        /* The html and body elements cannot have any padding or margin. */
      }

      /* Wrapper for page content to push down footer */
      #wrap {
        min-height: 100%;
        height: auto !important;
        height: 100%;
        /* Negative indent footer by it's height */
        margin: 0 auto -60px;
      }

      /* Set the fixed height of the footer here */
      #push,
      #footer {
        height: 60px;
      }
      #footer {
        background-color: #f5f5f5;
      }

      /* Lastly, apply responsive CSS fixes as necessary */
      @media (max-width: 767px) {
        #footer {
          margin-left: -20px;
          margin-right: -20px;
          padding-left: 20px;
          padding-right: 20px;
        }
      }



      /* Custom page CSS
      -------------------------------------------------- */
      /* Not required for template or sticky footer method. */

      .container {
        width: auto;
        max-width: 680px;
      }
      .container .credit {
        margin: 20px 0;
      }

    </style>
</head>

<body>
  
  <body>


    <!-- Part 1: Wrap all page content here -->
    <div id="wrap">

      <!-- Begin page content -->
      <div class="container-fluid">
        <div class="page-header">
          	<h1>
              Diffbook
              <small>easy? diffbook</small>
            </h1>
        </div>
        
        


<div class="pagination">
  <ul>

      <li><a href="/diffbook/0.html">Chapter 0</a></li>

      <li><a href="/diffbook/1.html">Chapter 1</a></li>

      <li><a href="/diffbook/2.html">Chapter 2</a></li>

      <li><a href="/diffbook/3.html">Chapter 3</a></li>

      <li><a href="/diffbook/4.html">Chapter 4</a></li>

      <li><a href="/diffbook/5.html">Chapter 5</a></li>

      <li><a href="/diffbook/6.html">Chapter 6</a></li>

      <li><a href="/diffbook/7.html">Chapter 7</a></li>

      <li><a href="/diffbook/8.html">Chapter 8</a></li>

      <li><a href="/diffbook/9.html">Chapter 9</a></li>

      <li><a href="/diffbook/10.html">Chapter 10</a></li>

      <li><a href="/diffbook/11.html">Chapter 11</a></li>

      <li><a href="/diffbook/12.html">Chapter 12</a></li>

  </ul>
</div>

<div class="pagination">
  <ul>

      
      <li><a href="#com_aa8c6f2ce6834fd2012620b2baac8e6aab96021a">aa8c6f2</a></li>
      

      
      <li><a href="#com_b6138becbd29a3d279014b2f81cf80b00cadda4b">b6138be</a></li>
      

      
      <li><a href="#com_cdab07ce9ee10a52cad1ec7eafdb66b3e051ff00">cdab07c</a></li>
      

      
      <li><a href="#com_02ed8b803e09906751f2703096310c2e81378f33">02ed8b8</a></li>
      

      
      <li><a href="#com_ee3d8a8861ed4d5ea90c606fcf5a53770265bd53">ee3d8a8</a></li>
      

      
      <li><a href="#com_89895b1356603e62bf9ca83bf1e7a7d751af98a5">89895b1</a></li>
      

      
      <li><a href="#com_739a4c66c06a1aa5de5f4bd07b49e2f04ec30290">739a4c6</a></li>
      

      
      <li><a href="#com_e8219d5f3760c9d20419ee76e9eb514a4046ce1c">e8219d5</a></li>
      

      
      <li><a href="#com_83521b165c2d34b0f5904766b5cf9d6f9cf3660a">83521b1</a></li>
      

      
      <li><a href="#com_d864cef3b68d807ffe8dbc10c26845734fefb97b">d864cef</a></li>
      

      
      <li><a href="#com_56409943ff62a997f7c1326dc264c8f53e5b722e">5640994</a></li>
      

      
      <li><a href="#com_f74941a5a1e849459f1fbea6dc9a2861e40e419a">f74941a</a></li>
      

      
      <li><a href="#com_f2fd41dd2a0d4bf68f5cd4f0989fb32bdc35eac5">f2fd41d</a></li>
      

      
      <li><a href="#com_329109afbb83ba34de23d586d44aedbaa27502e5">329109a</a></li>
      

      
      <li><a href="#com_097d699dc16179206ccb7e4aee863d6523cd471c">097d699</a></li>
      

      
      <li><a href="#com_eaaa0e14bf17cdc4d0edd2ea9daa9af5f3484c09">eaaa0e1</a></li>
      

      
      <li><a href="#com_28816a98948c4a6577f73bdeb2b7424dc55d2582">28816a9</a></li>
      

      
      <li><a href="#com_c4e4f430a3fe8433d95790170768d74eaf109a49">c4e4f43</a></li>
      

      
      <li><a href="#com_76c0363755694c36971ffc9db176312fe5c14276">76c0363</a></li>
      

      
      <li><a href="#com_7bce1473ce90f4e60f49d72bf1b61d32f430cb54">7bce147</a></li>
      

      
      <li><a href="#com_e234f6edf67361b3ba718ea10184ba8e7c2f773d">e234f6e</a></li>
      

      
      <li><a href="#com_82dc64e7baa231edd3896ca7a0d41393e426f123">82dc64e</a></li>
      

      
      <li><a href="#com_c0da1a23055a3368a1a4b20f5e90fcd6ef18f4f8">c0da1a2</a></li>
      

      
      <li><a href="#com_ac4003f4349f9ee22c67309ceeb48de5539b0308">ac4003f</a></li>
      

      

  </ul>
</div>




<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/aa8c6f2ce6834fd2012620b2baac8e6aab96021a">aa8c6f2</a><ul><li>Date : 2013-08-12</li><li>Fix typo</li></ul></li></ul>
<div class="row-fluid" id="com_aa8c6f2ce6834fd2012620b2baac8e6aab96021a">
    <div class="span6"><div class="diff"><div class="insert">To disable<span class="highlight"></span> an action append its name to this list:</div><div class=""> ``</div><div class=""> auth.settings.actions_disabled = []</div><div class=""> ``:code</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">To disable<span class="highlight">d</span> an action append its name to this list:</div><div class=""> ``</div><div class=""> auth.settings.actions_disabled = []</div><div class=""> ``:code</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/b6138becbd29a3d279014b2f81cf80b00cadda4b">b6138be</a><ul><li>Date : 2013-07-25</li><li>Document the 2.6 version of privileged user database admin</li></ul></li></ul>
<div class="row-fluid" id="com_b6138becbd29a3d279014b2f81cf80b00cadda4b">
    <div class="span6"><div class="diff"><div class="insert">The concept allows different management settings, each of which allows a user group to edit <span class="highlight"></span>a certain set of tables in this application.</div><div class=""> </div><div class=""> Example:</div><div class=""> First, create a group (also known as a role) for your privileged users. In this example, it will be called admin.</div><div class=""> Give a user membership of this role.</div><div class=""> Second, think of a name to describe this management setting, such as db_admin.</div><div class=""> </div><div class=""> Add the following setting in the model where you created and configured your auth object (probably in the model db):</div><div class=""> ``</div><div class=""> auth.settings.manager_actions = dict(db_admin=dict(role=&#x27;admin&#x27;,heading=&#x27;Manage Database&#x27;,tables = db.tables))</div><div class=""> </div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> A menu item has the URL like below, passing the management setting name as an arg:</div><div class=""> ``</div><div class=""> URL(&#x27;appadmin&#x27;,&#x27;manage&#x27;,args=[&#x27;db_admin&#x27;])</div><div class=""> ``:code</div><div class=""> This URL appears as /appadmin/manage/auth.</div><div class=""> </div><div class=""> ##### Advanced use</div><div class="insert">This mechanism<span class="highlight"></span> allows multiple management settings; each additional management setting is just another key defined in auth.settings.manager_actions.</div><div class=""> </div><div class=""> For example, you may want a group of users (such as &#x27;Super&#x27;) to have access to every table in a management setting called &quot;db_admin&quot;, and another group (such as &#x27;Content Manager&#x27;) to have admin access to tables relating to content in a management setting called &quot;content_admin&quot;. </div><div class=""> </div><div class=""> This can be set up like this:</div><div class=""> ``</div><div class=""> auth.settings.manager_actions = dict(</div><div class="">     db_admin=dict(role=&#x27;Super&#x27;, heading=&#x27;Manage Database&#x27;, tables=db.tables),</div><div class="">     content_admin=dict(role=&#x27;Content Manager&#x27;, tables=[content_db.articles, content_db.recipes, content_db.comments])</div><div class="insert">+    content_mgr_group_v2 = dict(role=&#x27;Content Manager v2&#x27;, db=content_db,</div><div class="insert">+        tables=[&#x27;articles&#x27;,&#x27;recipes&#x27;,&#x27;comments&#x27;],</div><div class="insert">+        smartgrid_args=dict(</div><div class="insert">+           DEFAULT=dict(maxtextlength=50,paginate=30), </div><div class="insert">+           comments=dict(maxtextlength=100,editable=False)</div><div class="insert">+        )</div><div class="insert">+     )</div><div class=""> ``:code</div><div class=""> </div><div class=""> (The heading key is optional. If missing, a smart default will be used)</div><div class=""> </div><div class=""> You could then make two new menu items with these URLs:</div><div class=""> ``</div><div class=""> URL(&#x27;appadmin&#x27;,&#x27;manage&#x27;,args=[&#x27;db_admin&#x27;])</div><div class=""> URL(&#x27;appadmin&#x27;,&#x27;manage&#x27;,args=[&#x27;content_admin&#x27;])</div><div class=""> ``:code</div><div class=""> </div><div class="insert">+The management setting called &quot;content_mgr_group_v2&quot; shows some more advanced possibilities. The key smartgrid_args is passed to the smartgrid used to edit or view the tables. Apart from the special key DEFAULT, table names are passed as keys (such as the table called &quot;comments&quot;). The syntax in this example names the tables as a list of strings, using the key db=content_db to specify the database.</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">The concept allows different management settings, each of which allows a user group to edit <span class="highlight">to </span>a certain set of tables in this application.</div><div class=""> </div><div class=""> Example:</div><div class=""> First, create a group (also known as a role) for your privileged users. In this example, it will be called admin.</div><div class=""> Give a user membership of this role.</div><div class=""> Second, think of a name to describe this management setting, such as db_admin.</div><div class=""> </div><div class=""> Add the following setting in the model where you created and configured your auth object (probably in the model db):</div><div class=""> ``</div><div class=""> auth.settings.manager_actions = dict(db_admin=dict(role=&#x27;admin&#x27;,heading=&#x27;Manage Database&#x27;,tables = db.tables))</div><div class=""> </div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> A menu item has the URL like below, passing the management setting name as an arg:</div><div class=""> ``</div><div class=""> URL(&#x27;appadmin&#x27;,&#x27;manage&#x27;,args=[&#x27;db_admin&#x27;])</div><div class=""> ``:code</div><div class=""> This URL appears as /appadmin/manage/auth.</div><div class=""> </div><div class=""> ##### Advanced use</div><div class="delete">This mechanism<span class="highlight"> is</span> allows multiple management settings; each additional management setting is just another key defined in auth.settings.manager_actions.</div><div class=""> </div><div class=""> For example, you may want a group of users (such as &#x27;Super&#x27;) to have access to every table in a management setting called &quot;db_admin&quot;, and another group (such as &#x27;Content Manager&#x27;) to have admin access to tables relating to content in a management setting called &quot;content_admin&quot;. </div><div class=""> </div><div class=""> This can be set up like this:</div><div class=""> ``</div><div class=""> auth.settings.manager_actions = dict(</div><div class="">     db_admin=dict(role=&#x27;Super&#x27;, heading=&#x27;Manage Database&#x27;, tables=db.tables),</div><div class="">     content_admin=dict(role=&#x27;Content Manager&#x27;, tables=[content_db.articles, content_db.recipes, content_db.comments])</div><div class=""> ``:code</div><div class=""> </div><div class=""> (The heading key is optional. If missing, a smart default will be used)</div><div class=""> </div><div class=""> You could then make two new menu items with these URLs:</div><div class=""> ``</div><div class=""> URL(&#x27;appadmin&#x27;,&#x27;manage&#x27;,args=[&#x27;db_admin&#x27;])</div><div class=""> URL(&#x27;appadmin&#x27;,&#x27;manage&#x27;,args=[&#x27;content_admin&#x27;])</div><div class=""> ``:code</div><div class=""> </div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/cdab07ce9ee10a52cad1ec7eafdb66b3e051ff00">cdab07c</a><ul><li>Date : 2013-07-25</li><li>Updated for v2.6 privileged user admin</li></ul></li></ul>
<div class="row-fluid" id="com_cdab07ce9ee10a52cad1ec7eafdb66b3e051ff00">
    <div class="span6"><div class="diff"><div class=""> #### Application Management via privileged users (Experimental)</div><div class=""> Normally administrator functions such as defining users and groups are managed by the server administrator. However, you may want a group of privileged users to have administrator rights for a specific application. </div><div class="insert">+This is possible with versions after web2py v2.5.1 </div><div class="insert">+(Upgrading an existing application requires the new appadmin controller and the new appadmin.html view, copied from the welcome app. Also, apps created prior to web2py v2.6 need the new javascript file in welcome/static/js/web2py.js)</div><div class=""> </div><div class="insert">+The concept allows different management settings, each of which allows a user group to edit to a certain set of tables in this application.</div><div class="insert">+</div><div class="insert">+Example:</div><div class=""> First, create a group (also known as a role) for your privileged users. In this example, it will be called admin.</div><div class=""> Give a user membership of this role.</div><div class="insert">+Second, think of a name to describe this management setting, such as db_admin.</div><div class=""> </div><div class=""> Add the following setting in the model where you created and configured your auth object (probably in the model db):</div><div class=""> ``</div><div class="insert">+auth.settings.manager_actions = dict(db_admin=dict(role=&#x27;admin&#x27;,heading=&#x27;Manage Database&#x27;,tables = db.tables))</div><div class="insert">+</div><div class=""> ``:code</div><div class=""> </div><div class="insert">+</div><div class="insert">+A menu item has the URL like below, passing the management setting name as an arg:</div><div class=""> ``</div><div class="insert">URL(&#x27;appadmin&#x27;,&#x27;manage&#x27;,args=[&#x27;<span class="highlight">db_</span>a<span class="highlight">dmin</span>&#x27;])</div><div class=""> ``:code</div><div class=""> This URL appears as /appadmin/manage/auth.</div><div class=""> </div><div class=""> ##### Advanced use</div><div class="insert">+This mechanism is allows multiple management settings; each additional management setting is just another key defined in auth.settings.manager_actions.</div><div class="insert">+</div><div class="insert">+For example, you may want a group of users (such as &#x27;Super&#x27;) to have access to every table in a management setting called &quot;db_admin&quot;, and another group (such as &#x27;Content Manager&#x27;) to have admin access to tables relating to content in a management setting called &quot;content_admin&quot;. </div><div class=""> </div><div class=""> This can be set up like this:</div><div class=""> ``</div><div class=""> auth.settings.manager_actions = dict(</div><div class="insert">+    db_admin=dict(role=&#x27;Super&#x27;, heading=&#x27;Manage Database&#x27;, tables=db.tables),</div><div class="insert">+    content_admin=dict(role=&#x27;Content Manager&#x27;, tables=[content_db.articles, content_db.recipes, content_db.comments])</div><div class=""> ``:code</div><div class=""> </div><div class=""> (The heading key is optional. If missing, a smart default will be used)</div><div class=""> </div><div class=""> You could then make two new menu items with these URLs:</div><div class=""> ``</div><div class="insert">+URL(&#x27;appadmin&#x27;,&#x27;manage&#x27;,args=[&#x27;db_admin&#x27;])</div><div class="insert">+URL(&#x27;appadmin&#x27;,&#x27;manage&#x27;,args=[&#x27;content_admin&#x27;])</div><div class=""> ``:code</div></div></div>
    <div class="span6"><div class="diff"><div class=""> #### Application Management via privileged users (Experimental)</div><div class=""> Normally administrator functions such as defining users and groups are managed by the server administrator. However, you may want a group of privileged users to have administrator rights for a specific application. </div><div class="delete">-This is possible with versions after web2py 2.5.1 </div><div class="delete">-(Upgrading an existing application requires the new appadmin controller and the new appadmin.html view, copied from the welcome app.)</div><div class=""> </div><div class=""> First, create a group (also known as a role) for your privileged users. In this example, it will be called admin.</div><div class=""> Give a user membership of this role.</div><div class=""> </div><div class=""> Add the following setting in the model where you created and configured your auth object (probably in the model db):</div><div class=""> ``</div><div class="delete">-auth.settings.auth_manager_role = &#x27;admin&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class="delete">-A menu item has the URL:</div><div class=""> ``</div><div class="delete">URL(&#x27;appadmin&#x27;,&#x27;manage&#x27;,args=[&#x27;<span class="highlight"></span>a<span class="highlight">uth</span>&#x27;])</div><div class=""> ``:code</div><div class=""> This URL appears as /appadmin/manage/auth.</div><div class=""> </div><div class="delete">-Members of the auth_manager_role (in this case, &#x27;auth&#x27;) can now edit the tables associated with user management for this specific application.</div><div class="delete">-</div><div class=""> ##### Advanced use</div><div class="delete">-This mechanism is generalised to allow different groups of privileged users administrator access to certain tables. </div><div class="delete">-For example, you may want a group of users (such as &#x27;Super&#x27;) to have access to every table, and another group (such as &#x27;Content Manager&#x27;) to have admin access to tables relating to content. </div><div class=""> </div><div class=""> This can be set up like this:</div><div class=""> ``</div><div class=""> auth.settings.manager_actions = dict(</div><div class="delete">-    db=dict(role=&#x27;Super&#x27;, heading=&#x27;Manage Database&#x27;, tables=db.tables),</div><div class="delete">-    content=dict(role=&#x27;Content Manager&#x27;, tables=[content_db.articles, content_db.recipes, content_db.comments])</div><div class=""> ``:code</div><div class=""> </div><div class=""> (The heading key is optional. If missing, a smart default will be used)</div><div class=""> </div><div class=""> You could then make two new menu items with these URLs:</div><div class=""> ``</div><div class="delete">-URL(&#x27;appadmin&#x27;,&#x27;manage&#x27;,args=[&#x27;db&#x27;])</div><div class="delete">-URL(&#x27;appadmin&#x27;,&#x27;manage&#x27;,args=[&#x27;content&#x27;])</div><div class=""> ``:code</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/02ed8b803e09906751f2703096310c2e81378f33">02ed8b8</a><ul><li>Date : 2013-06-25</li><li>whoops, typos</li></ul></li></ul>
<div class="row-fluid" id="com_02ed8b803e09906751f2703096310c2e81378f33">
    <div class="span6"><div class="diff"><div class=""> #### Application Management via privileged users (Experimental)</div><div class=""> Normally administrator functions such as defining users and groups are managed by the server administrator. However, you may want a group of privileged users to have administrator rights for a specific application. </div><div class=""> This is possible with versions after web2py 2.5.1 </div><div class="insert">(Upgrading an existing application requires the new appadmin controller and the new appadmin.h<span class="highlight">t</span>ml view, copied from the welcome app.)</div><div class=""> </div><div class=""> First, create a group (also known as a role) for your privileged users. In this example, it will be called admin.</div><div class=""> Give a user membership of this role.</div><div class=""> </div><div class=""> Add the following setting in the model where you created and configured your auth object (probably in the model db):</div><div class=""> ``</div><div class=""> auth.settings.auth_manager_role = &#x27;admin&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class=""> A menu item has the URL:</div><div class=""> ``</div><div class=""> URL(&#x27;appadmin&#x27;,&#x27;manage&#x27;,args=[&#x27;auth&#x27;])</div><div class=""> ``:code</div><div class=""> This URL appears as /appadmin/manage/auth.</div><div class=""> </div><div class=""> Members of the auth_manager_role (in this case, &#x27;auth&#x27;) can now edit the tables associated with user management for this specific application.</div><div class=""> </div><div class=""> ##### Advanced use</div><div class=""> This mechanism is generalised to allow different groups of privileged users administrator access to certain tables. </div><div class=""> For example, you may want a group of users (such as &#x27;Super&#x27;) to have access to every table, and another group (such as &#x27;Content Manager&#x27;) to have admin access to tables relating to content. </div><div class=""> </div><div class=""> This can be set up like this:</div><div class=""> ``</div><div class=""> auth.settings.manager_actions = dict(</div><div class="">     db=dict(role=&#x27;Super&#x27;, heading=&#x27;Manage Database&#x27;, tables=db.tables),</div><div class="">     content=dict(role=&#x27;Content Manager&#x27;, tables=[content_db.articles, content_db.recipes, content_db.comments])</div><div class=""> ``:code</div><div class=""> </div><div class="insert">+(The heading key is optional. If missing, a smart default will be used)</div><div class="insert">+</div><div class=""> You could then make two new menu items with these URLs:</div><div class=""> ``</div><div class=""> URL(&#x27;appadmin&#x27;,&#x27;manage&#x27;,args=[&#x27;db&#x27;])</div><div class="insert">URL(&#x27;appadmin&#x27;,&#x27;manage&#x27;,args=[&#x27;<span class="highlight">c</span>ontent<span class="highlight"></span>&#x27;])</div><div class=""> ``:code</div><div class=""> </div></div></div>
    <div class="span6"><div class="diff"><div class=""> #### Application Management via privileged users (Experimental)</div><div class=""> Normally administrator functions such as defining users and groups are managed by the server administrator. However, you may want a group of privileged users to have administrator rights for a specific application. </div><div class=""> This is possible with versions after web2py 2.5.1 </div><div class="delete">(Upgrading an existing application requires the new appadmin controller and the new appadmin.h<span class="highlight">e</span>ml view, copied from the welcome app.)</div><div class=""> </div><div class=""> First, create a group (also known as a role) for your privileged users. In this example, it will be called admin.</div><div class=""> Give a user membership of this role.</div><div class=""> </div><div class=""> Add the following setting in the model where you created and configured your auth object (probably in the model db):</div><div class=""> ``</div><div class=""> auth.settings.auth_manager_role = &#x27;admin&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class=""> A menu item has the URL:</div><div class=""> ``</div><div class=""> URL(&#x27;appadmin&#x27;,&#x27;manage&#x27;,args=[&#x27;auth&#x27;])</div><div class=""> ``:code</div><div class=""> This URL appears as /appadmin/manage/auth.</div><div class=""> </div><div class=""> Members of the auth_manager_role (in this case, &#x27;auth&#x27;) can now edit the tables associated with user management for this specific application.</div><div class=""> </div><div class=""> ##### Advanced use</div><div class=""> This mechanism is generalised to allow different groups of privileged users administrator access to certain tables. </div><div class=""> For example, you may want a group of users (such as &#x27;Super&#x27;) to have access to every table, and another group (such as &#x27;Content Manager&#x27;) to have admin access to tables relating to content. </div><div class=""> </div><div class=""> This can be set up like this:</div><div class=""> ``</div><div class=""> auth.settings.manager_actions = dict(</div><div class="">     db=dict(role=&#x27;Super&#x27;, heading=&#x27;Manage Database&#x27;, tables=db.tables),</div><div class="">     content=dict(role=&#x27;Content Manager&#x27;, tables=[content_db.articles, content_db.recipes, content_db.comments])</div><div class=""> ``:code</div><div class=""> </div><div class=""> You could then make two new menu items with these URLs:</div><div class=""> ``</div><div class=""> URL(&#x27;appadmin&#x27;,&#x27;manage&#x27;,args=[&#x27;db&#x27;])</div><div class="delete">URL(&#x27;appadmin&#x27;,&#x27;manage&#x27;,args=[&#x27;<span class="highlight">C</span>ontent<span class="highlight"> Manager</span>&#x27;])</div><div class=""> ``:code</div><div class=""> </div><div class="delete">-(The heading key is optional. If missing, a smart default will be used)</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/ee3d8a8861ed4d5ea90c606fcf5a53770265bd53">ee3d8a8</a><ul><li>Date : 2013-06-24</li><li>Changed instructions on privileged user roles to catch up with Anthony's changes of June 13, 2013</li></ul></li></ul>
<div class="row-fluid" id="com_ee3d8a8861ed4d5ea90c606fcf5a53770265bd53">
    <div class="span6"><div class="diff"><div class="insert">+#### Application Management via privileged users (Experimental)</div><div class="insert">+Normally administrator functions such as defining users and groups are managed by the server administrator. However, you may want a group of privileged users to have administrator rights for a specific application. </div><div class="insert">+This is possible with versions after web2py 2.5.1 </div><div class="insert">+(Upgrading an existing application requires the new appadmin controller and the new appadmin.heml view, copied from the welcome app.)</div><div class="insert">+</div><div class=""> First, create a group (also known as a role) for your privileged users. In this example, it will be called admin.</div><div class=""> Give a user membership of this role.</div><div class=""> </div><div class=""> Add the following setting in the model where you created and configured your auth object (probably in the model db):</div><div class=""> ``</div><div class="insert">+auth.settings.auth_manager_role = &#x27;admin&#x27;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+A menu item has the URL:</div><div class="insert">+``</div><div class="insert">+URL(&#x27;appadmin&#x27;,&#x27;manage&#x27;,args=[&#x27;auth&#x27;])</div><div class=""> ``:code</div><div class="insert">+This URL appears as /appadmin/manage/auth.</div><div class=""> </div><div class="insert">+Members of the auth_manager_role (in this case, &#x27;auth&#x27;) can now edit the tables associated with user management for this specific application.</div><div class="insert">+</div><div class="insert">+##### Advanced use</div><div class="insert">+This mechanism is generalised to allow different groups of privileged users administrator access to certain tables. </div><div class="insert">+For example, you may want a group of users (such as &#x27;Super&#x27;) to have access to every table, and another group (such as &#x27;Content Manager&#x27;) to have admin access to tables relating to content. </div><div class="insert">+</div><div class="insert">+This can be set up like this:</div><div class=""> ``</div><div class="insert">+auth.settings.manager_actions = dict(</div><div class="insert">+    db=dict(role=&#x27;Super&#x27;, heading=&#x27;Manage Database&#x27;, tables=db.tables),</div><div class="insert">+    content=dict(role=&#x27;Content Manager&#x27;, tables=[content_db.articles, content_db.recipes, content_db.comments])</div><div class=""> ``:code</div><div class=""> </div><div class="insert">+You could then make two new menu items with these URLs:</div><div class="insert">+``</div><div class="insert">+URL(&#x27;appadmin&#x27;,&#x27;manage&#x27;,args=[&#x27;db&#x27;])</div><div class="insert">+URL(&#x27;appadmin&#x27;,&#x27;manage&#x27;,args=[&#x27;Content Manager&#x27;])</div><div class="insert">+``:code</div><div class=""> </div><div class="insert">+(The heading key is optional. If missing, a smart default will be used)</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">-#### User Management via privileged users (Experimental)</div><div class="delete">-Normally users and groups are managed by the server administrator. However, you may want a group of privileged users that can manage users and groups just for one application.</div><div class="delete">-Starting from web2py 2.5, you can do this.</div><div class=""> First, create a group (also known as a role) for your privileged users. In this example, it will be called admin.</div><div class=""> Give a user membership of this role.</div><div class=""> </div><div class=""> Add the following setting in the model where you created and configured your auth object (probably in the model db):</div><div class=""> ``</div><div class="delete">-auth.settings.manager_group_role = &#x27;admin&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class="delete">-The user and groups administration menu has this URL (for adding to a menu)</div><div class=""> ``</div><div class="delete">-URL(&#x27;appadmin&#x27;,&#x27;auth_manage&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class="delete">-Upgrading an existing application requires a new appadmin controller (copied from the welcome app) and the new appadmin.html view.</div><div class=""> </div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/89895b1356603e62bf9ca83bf1e7a7d751af98a5">89895b1</a><ul><li>Date : 2013-06-08</li><li>Added text explaining the new experimental privilged user capability for user and group administration</li></ul></li></ul>
<div class="row-fluid" id="com_89895b1356603e62bf9ca83bf1e7a7d751af98a5">
    <div class="span6"><div class="diff"><div class="insert">+#### User Management via privileged users (Experimental)</div><div class="insert">+Normally users and groups are managed by the server administrator. However, you may want a group of privileged users that can manage users and groups just for one application.</div><div class="insert">+Starting from web2py 2.5, you can do this.</div><div class="insert">+First, create a group (also known as a role) for your privileged users. In this example, it will be called admin.</div><div class="insert">+Give a user membership of this role.</div><div class="insert">+</div><div class="insert">+Add the following setting in the model where you created and configured your auth object (probably in the model db):</div><div class="insert">+``</div><div class="insert">+auth.settings.manager_group_role = &#x27;admin&#x27;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+The user and groups administration menu has this URL (for adding to a menu)</div><div class="insert">+``</div><div class="insert">+URL(&#x27;appadmin&#x27;,&#x27;auth_manage&#x27;)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Upgrading an existing application requires a new appadmin controller (copied from the welcome app) and the new appadmin.html view.</div><div class="insert">+</div><div class="insert">+</div><div class=""> #### Manual Authentication</div></div></div>
    <div class="span6"><div class="diff"><div class=""> #### Manual Authentication</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/739a4c66c06a1aa5de5f4bd07b49e2f04ec30290">739a4c6</a><ul><li>Date : 2013-04-04</li><li>English 5th: Various text corrections</li></ul></li></ul>
<div class="row-fluid" id="com_739a4c66c06a1aa5de5f4bd07b49e2f04ec30290">
    <div class="span6"><div class="diff"><div class="insert">If you want to connect to a web2py CAS provider from a different domain, you must enable them by a<span class="highlight">pp</span>ending to the list of allowed domain<span class="highlight">s</span>:</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">If you want to connect to a web2py CAS provider from a different domain, you must enable them by a<span class="highlight">tt</span>ending to the list of allowed domain<span class="highlight"></span>:</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/e8219d5f3760c9d20419ee76e9eb514a4046ce1c">e8219d5</a><ul><li>Date : 2013-02-15</li><li>Corrected a small typo</li></ul></li></ul>
<div class="row-fluid" id="com_e8219d5f3760c9d20419ee76e9eb514a4046ce1c">
    <div class="span6"><div class="diff"><div class=""> Occasionally, it is necessary to combine requirements. This can be done via a generic ``requires`` decorator which takes a single argument, a true or false condition. For example, to give access to agents, but only on Tuesday:</div><div class=""> ``</div><div class="insert">@auth.requires(auth.has_membership(group_id=<span class="highlight">&#x27;</span>agents<span class="highlight">&#x27;</span> \</div><div class="">                and request.now.weekday()==1)</div><div class=""> def function_seven():</div><div class="">     return &#x27;Hello agent, it must be Tuesday!&#x27;</div><div class=""> ``:code</div></div></div>
    <div class="span6"><div class="diff"><div class=""> Occasionally, it is necessary to combine requirements. This can be done via a generic ``requires`` decorator which takes a single argument, a true or false condition. For example, to give access to agents, but only on Tuesday:</div><div class=""> ``</div><div class="delete">@auth.requires(auth.has_membership(group_id=<span class="highlight"></span>agents<span class="highlight">)</span> \</div><div class="">                and request.now.weekday()==1)</div><div class=""> def function_seven():</div><div class="">     return &#x27;Hello agent, it must be Tuesday!&#x27;</div><div class=""> ``:code</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/83521b165c2d34b0f5904766b5cf9d6f9cf3660a">83521b1</a><ul><li>Date : 2013-02-04</li><li>added pythonanywhere screenshots</li></ul></li></ul>
<div class="row-fluid" id="com_83521b165c2d34b0f5904766b5cf9d6f9cf3660a">
    <div class="span6"><div class="diff"><div class=""> ``</div><div class=""> from gluon.contrib.login_methods.rpx_account import RPXAccount</div><div class=""> auth.settings.actions_disabled=[&#x27;register&#x27;,&#x27;change_password&#x27;,&#x27;request_reset_password&#x27;]</div><div class=""> auth.settings.login_form = RPXAccount(request,</div><div class="">     api_key=&#x27;...&#x27;,</div><div class="">     domain=&#x27;...&#x27;,</div><div class="insert">    url = &quot;http://<span class="highlight">y</span>o<span class="highlight">ur-extern</span>al<span class="highlight">-addre</span>s<span class="highlight">s</span>/%s/default/user/login&quot; % request.application)</div><div class=""> ``:code</div><div class=""> </div><div class="insert">+The first line imports the new login method, the second line disables local registration, and the third line asks web2py to use the RPX login method. You must insert your own ``api_key`` provided by Janrain.com, the domain you choose upon registration and the external ``url`` of your login page. To obtain then login at janrain.com, then go to [Deployment][Application Settings]. On the right side there is the &quot;Application Info&quot;, The api_key  is called &quot;API Key (Secret)&quot;.</div><div class="insert">+</div><div class="insert">+The domain is the &quot;Application Domain&quot; without leading &quot;https://&quot; and without the trailing &quot;.rpxnow.com/&quot;</div><div class="insert">+For example: if you have registered a website as &quot;secure.mywebsite.org&quot;, Janrain turns it to the Application Domain &quot;https://secure-mywebsite.rpxnow.com&quot;. </div><div class="insert">+</div></div></div>
    <div class="span6"><div class="diff"><div class=""> ``</div><div class=""> from gluon.contrib.login_methods.rpx_account import RPXAccount</div><div class=""> auth.settings.actions_disabled=[&#x27;register&#x27;,&#x27;change_password&#x27;,&#x27;request_reset_password&#x27;]</div><div class=""> auth.settings.login_form = RPXAccount(request,</div><div class="">     api_key=&#x27;...&#x27;,</div><div class="">     domain=&#x27;...&#x27;,</div><div class="delete">    url = &quot;http://<span class="highlight">l</span>o<span class="highlight">c</span>al<span class="highlight">ho</span>s<span class="highlight">t:8000</span>/%s/default/user/login&quot; % request.application)</div><div class=""> ``:code</div><div class=""> </div><div class="delete">-The first line imports the new login method, the second line disables local registration, and the third line asks web2py to use the RPX login method. You must insert your own ``api_key`` provided by Janrain.com, the domain you choose upon registration and the external ``url`` of your login page.</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/d864cef3b68d807ffe8dbc10c26845734fefb97b">d864cef</a><ul><li>Date : 2013-02-04</li><li>fixed all but chap 6</li></ul></li></ul>
<div class="row-fluid" id="com_d864cef3b68d807ffe8dbc10c26845734fefb97b">
    <div class="span6"><div class="diff"><div class=""> -------</div><div class="insert">The ``password`` field of the ``db.auth_user`` table defaults to a ``CRYPT`` validator, which needs and ``hmac_key``. On legacy web2py applications you may see an extra argument passed to the Auth constructor: ``hmac_key = Auth.get_or_create_key()``. The latter is a function that read the HMAC key from a file &quot;private/auth.key&quot; within the application folder. If the file does not exist it creates a random ``hmac_key``. If multiple apps share the same auth database, make sure they also use the same ``hmac_key``. This is no lo<span class="highlight">n</span>ger necessary for new applications since passwords are salted with an individual random salt.</div><div class=""> -------</div><div class=""> </div><div class=""> By default, web2py uses email for login. If instead you want to log in using username set ``auth.define_tables(username=True)``</div><div class=""> </div><div class=""> If multiple apps share the same auth database you may want to disable migrations: ``auth.define_tables(migrate=False)``.</div><div class=""> </div><div class=""> To expose **Auth**, you also need the following function in a controller (for example in &quot;default.py&quot;):</div><div class=""> ``</div><div class=""> def user(): return dict(form=auth())</div><div class=""> ``:code</div><div class=""> </div><div class=""> -------</div><div class=""> The ``auth`` object and the ``user`` action are already defined in the</div><div class=""> scaffolding application.</div><div class=""> -------</div><div class=""> </div><div class=""> web2py also includes a sample view &quot;welcome/views/default/user.html&quot; to render this function properly that looks like this:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h2&gt;{{=T( request.args(0).replace(&#x27;_&#x27;,&#x27; &#x27;).capitalize() )}}&lt;/h2&gt;</div><div class=""> auth.messages.reset_password = &#x27;Click on the link http://&#x27; + \</div><div class=""> </div><div class=""> In the two ``auth.messages`` above, you may need to replace the URL portion of the string with the proper complete URL of the action. This is necessary because web2py may be installed behind a proxy, and it cannot determine its own public URLs with absolute certainty. The above examples (which are the default values) should, however, work in most cases.</div><div class=""> </div><div class=""> ### Authorization</div><div class=""> </div><div class=""> Once a new user is registered, a new group is created to contain the user. The role of the new user is conventionally &quot;user_[id]&quot; where [id] is the id of the newly created user. The creation of the group can be disabled with</div><div class=""> ``</div><div class=""> auth.settings.create_user_groups = None</div><div class=""> ``:code</div><div class=""> </div><div class=""> although we do not suggest doing so. Notice that ``create_user_groups`` is not a boolean (although it can be ``False``) but it defaults to:</div><div class=""> </div><div class=""> ``</div><div class=""> auth.settings.create_user_groups=&quot;user_%(id)s&quot;</div><div class=""> ``:code</div><div class=""> </div><div class=""> It store a template for the name of the group created for user ``id``.</div><div class=""> </div><div class=""> Users have membership in groups. Each group is identified by a name/role. Groups have permissions. Users have permissions because of the groups they belong to. By default each user is made member of their own group.</div><div class=""> </div><div class="insert">You can also <span class="highlight"></span>do</div><div class=""> ``</div><div class=""> auth.settings.everybody_group_id = 5</div><div class=""> ``:code</div></div></div>
    <div class="span6"><div class="diff"><div class=""> -------</div><div class="delete">The ``password`` field of the ``db.auth_user`` table defaults to a ``CRYPT`` validator, which needs and ``hmac_key``. On legacy web2py applications you may see an extra argument passed to the Auth constructor: ``hmac_key = Auth.get_or_create_key()``. The latter is a function that read the HMAC key from a file &quot;private/auth.key&quot; within the application folder. If the file does not exist it creates a random ``hmac_key``. If multiple apps share the same auth database, make sure they also use the same ``hmac_key``. This is no lo<span class="highlight"></span>ger necessary for new applications since passwords are salted with an individual random salt.</div><div class=""> -------</div><div class=""> </div><div class=""> By default, web2py uses email for login. If instead you want to log in using username set ``auth.define_tables(username=True)``</div><div class=""> </div><div class=""> If multiple apps share the same auth database you may want to disable migrations: ``auth.define_tables(migrate=False)``.</div><div class=""> </div><div class=""> To expose **Auth**, you also need the following function in a controller (for example in &quot;default.py&quot;):</div><div class=""> ``</div><div class=""> def user(): return dict(form=auth())</div><div class=""> ``:code</div><div class=""> </div><div class=""> -------</div><div class=""> The ``auth`` object and the ``user`` action are already defined in the</div><div class=""> scaffolding application.</div><div class=""> -------</div><div class=""> </div><div class=""> web2py also includes a sample view &quot;welcome/views/default/user.html&quot; to render this function properly that looks like this:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h2&gt;{{=T( request.args(0).replace(&#x27;_&#x27;,&#x27; &#x27;).capitalize() )}}&lt;/h2&gt;</div><div class=""> auth.messages.reset_password = &#x27;Click on the link http://&#x27; + \</div><div class=""> </div><div class=""> In the two ``auth.messages`` above, you may need to replace the URL portion of the string with the proper complete URL of the action. This is necessary because web2py may be installed behind a proxy, and it cannot determine its own public URLs with absolute certainty. The above examples (which are the default values) should, however, work in most cases.</div><div class=""> </div><div class=""> ### Authorization</div><div class=""> </div><div class=""> Once a new user is registered, a new group is created to contain the user. The role of the new user is conventionally &quot;user_[id]&quot; where [id] is the id of the newly created user. The creation of the group can be disabled with</div><div class=""> ``</div><div class=""> auth.settings.create_user_groups = None</div><div class=""> ``:code</div><div class=""> </div><div class=""> although we do not suggest doing so. Notice that ``create_user_groups`` is not a boolean (although it can be ``False``) but it defaults to:</div><div class=""> </div><div class=""> ``</div><div class=""> auth.settings.create_user_groups=&quot;user_%(id)s&quot;</div><div class=""> ``:code</div><div class=""> </div><div class=""> It store a template for the name of the group created for user ``id``.</div><div class=""> </div><div class=""> Users have membership in groups. Each group is identified by a name/role. Groups have permissions. Users have permissions because of the groups they belong to. By default each user is made member of their own group.</div><div class=""> </div><div class="delete">You can also <span class="highlight">also </span>do</div><div class=""> ``</div><div class=""> auth.settings.everybody_group_id = 5</div><div class=""> ``:code</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/56409943ff62a997f7c1326dc264c8f53e5b722e">5640994</a><ul><li>Date : 2013-01-18</li><li>Update sources/29-web2py-english/09.markmin</li></ul></li></ul>
<div class="row-fluid" id="com_56409943ff62a997f7c1326dc264c8f53e5b722e">
    <div class="span6"><div class="diff"><div class="insert">First of all you must install the [[Facebook Python SDK https://github.com/<span class="highlight">pythonfor</span>facebook/<span class="highlight">faceb</span>o<span class="highlight">ok</span>-sdk<span class="highlight">/</span>]].</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">First of all you must install the [[Facebook Python SDK https://github.com/<span class="highlight"></span>facebook/<span class="highlight">pyth</span>o<span class="highlight">n</span>-sdk<span class="highlight"></span>]].</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/f74941a5a1e849459f1fbea6dc9a2861e40e419a">f74941a</a><ul><li>Date : 2013-01-08</li><li>Added documentation on mail.settings.tls</li></ul></li></ul>
<div class="row-fluid" id="com_f74941a5a1e849459f1fbea6dc9a2861e40e419a">
    <div class="span6"><div class="diff"><div class="insert">You need to replace the mail.settings with the proper parameters for your SMTP server. Set ``mail.settings.login = None`` if the SMTP server does not require authentication.<span class="highlight"> If you don&#x27;t want to use TLS, set ``mail.settings.tls = False``</span></div></div></div>
    <div class="span6"><div class="diff"><div class="delete">You need to replace the mail.settings with the proper parameters for your SMTP server. Set ``mail.settings.login = None`` if the SMTP server does not require authentication.<span class="highlight"></span></div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/f2fd41dd2a0d4bf68f5cd4f0989fb32bdc35eac5">f2fd41d</a><ul><li>Date : 2012-12-31</li><li>spell check of diffs, thanks Joanthan</li></ul></li></ul>
<div class="row-fluid" id="com_f2fd41dd2a0d4bf68f5cd4f0989fb32bdc35eac5">
    <div class="span6"><div class="diff"><div class=""> **Auth** needs (and defines) the following tables:</div><div class=""> - ``auth_user`` stores users&#x27; name, email address, password, and status (registration pending, accepted, blocked)</div><div class=""> - ``auth_group`` stores groups or roles for users in a many-to-many structure. By default, each user is in its own group, but a user can be in multiple groups, and each group can contain multiple users. A group is identified by a role and a description.</div><div class=""> - ``auth_membership`` links users and groups in a many-to-many structure.</div><div class=""> - ``auth_permission`` links groups and permissions. A permission is identified by a name and, optionally, a table and a record. For example, members of a certain group can have &quot;update&quot; permissions on a specific record of a specific table.</div><div class=""> - ``auth_event`` logs changes in the other tables and successful access via CRUD to objects controlled by the RBAC.</div><div class="insert">- ``auth_cas`` is used for Central Authe<span class="highlight">n</span>tication Service (CAS). Every web2py application is a CAS provider and can optionally be a CAS consumer.</div><div class=""> </div><div class=""> The schema is reproduced graphically in the image below:</div><div class=""> </div><div class=""> [[image @///image/schema_auth.png center 300px]]</div><div class=""> </div><div class=""> </div><div class=""> </div><div class=""> In principle, there is no restriction on the names of the roles and the names of the permissions; the developer can create them to fix the roles and permissions in the organization. Once they have been created, web2py provides an API to check if a user is logged in, if a user is a member of a given group, and/or if the user is a member of any group that has a given required permission.</div><div class=""> </div><div class=""> web2py also provides decorators to restrict access to any function based on login, membership and permissions.</div><div class=""> </div><div class=""> web2py also understands some specific permissions, i.e., those that have a name that correspond to the CRUD methods (create, read, update, delete) and can enforce them automatically without the need to use decorators.</div><div class=""> </div><div class=""> In this chapter, we are going to discuss different parts of RBAC one by one.</div><div class=""> </div><div class=""> ### Authentication</div><div class=""> </div><div class=""> In order to use RBAC, users need to be identified. This means that they need to register (or be registered) and log in.</div><div class=""> </div><div class=""> **Auth** provides multiple login methods. The default one consists of identifying users based on the local ``auth_user`` table.</div><div class=""> Alternatively, it can log in users against third-party authentication systems and single sign on providers such as Google, PAM, LDAP, Facebook, LinkedIn, Dropbox, OpenID, OAuth, etc..</div><div class=""> </div><div class=""> To start using ``Auth``, you need at least this code in a model file, which is also provided with the web2py &quot;welcome&quot; application and assumes a ``db`` connection object:</div><div class=""> ``</div><div class=""> from gluon.tools import Auth</div><div class=""> auth = Auth(db)</div><div class=""> auth.define_tables()</div><div class=""> ``:code</div><div class=""> </div><div class=""> Auth has an optional ``secure=True`` argument, which will force authenticated pages to go over HTTPS. ``https``:inxx</div><div class=""> </div><div class=""> -------</div><div class="insert">The ``password`` field of the ``db.auth_user`` table defaults to a ``CRYPT`` validator, which needs and ``hmac_key``. On legacy web2py applications you may see an extra argument passed to the Auth constructor: ``hmac_key = Auth.get_or_create_key()``. The latter is a function that read the <span class="highlight">HMAC ke</span>y from a file &quot;private/auth.key&quot; within the application folder. If the file does not exist it creates a random ``hmac_key``. If multiple apps share the same auth database, make sure they also use the same ``hmac_key``. This is no loger necessary for new applications since passwords are salted with an individual random salt.</div><div class=""> -------</div><div class=""> </div><div class=""> By default, web2py uses email for login. If instead you want to log in using username set ``auth.define_tables(username=True)``</div><div class=""> </div><div class=""> If multiple apps share the same auth database you may want to disable migrations: ``auth.define_tables(migrate=False)``.</div><div class=""> </div><div class=""> To expose **Auth**, you also need the following function in a controller (for example in &quot;default.py&quot;):</div><div class=""> ``</div><div class=""> def user(): return dict(form=auth())</div><div class=""> ``:code</div><div class=""> </div><div class=""> -------</div><div class=""> The ``auth`` object and the ``user`` action are already defined in the</div><div class=""> scaffolding application.</div><div class=""> -------</div><div class=""> </div><div class=""> web2py also includes a sample view &quot;welcome/views/default/user.html&quot; to render this function properly that looks like this:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h2&gt;{{=T( request.args(0).replace(&#x27;_&#x27;,&#x27; &#x27;).capitalize() )}}&lt;/h2&gt;</div><div class=""> Notice that this function simply displays a ``form`` and therefore it can be cus</div><div class=""> {{if request.args(0)==&#x27;login&#x27;:}}...custom login form...{{pass}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> ``auth.impersonate``:inxx ``auth.is_impersonating``:inxx</div><div class=""> </div><div class=""> The controller above exposes multiple actions:</div><div class=""> ``</div><div class=""> http://.../[app]/default/user/register</div><div class=""> http://.../[app]/default/user/login</div><div class=""> http://.../[app]/default/user/logout</div><div class=""> http://.../[app]/default/user/profile</div><div class=""> http://.../[app]/default/user/change_password</div><div class=""> http://.../[app]/default/user/verify_email</div><div class=""> http://.../[app]/default/user/retrieve_username</div><div class=""> http://.../[app]/default/user/request_reset_password</div><div class=""> http://.../[app]/default/user/reset_password</div><div class=""> http://.../[app]/default/user/impersonate</div><div class=""> http://.../[app]/default/user/groups</div><div class=""> http://.../[app]/default/user/not_authorized</div><div class=""> ``:code</div><div class="insert">- **register** allows users to register. It is integrated with CAPTCHA, although this is disabled by default. This is also integrated with a client-side entropy calculator defined in &quot;web2py.js&quot;. The calculator indic<span class="highlight">ates the strength</span> of the new password. You can use the ``IS_STRONG`` validator to prevent web2py from accepting weak passwords.</div><div class=""> - **login** allows users who are registered to log in (if the registration is verified or does not require verification, if it has been approved or does not require approval, and if it has not been blocked).</div><div class=""> - **logout** does what you would expect but also, as the other methods, logs the event and can be used to trigger some event.</div><div class=""> - **profile** allows users to edit their profile, i.e. the content of the ``auth_user`` table. Notice that this table does not have a fixed structure and can be customized.</div><div class=""> - **change_password** allows users to change their password in a fail-safe way.</div><div class=""> - **verify_email**. If email verification is turned on, then visitors, upon registration, receive an email with a link to verify their email information. The link points to this action.</div><div class=""> - **retrieve_username**. By default, **Auth** uses email and password for login, but it can, optionally, use username instead of email. In this latter case, if a user forgets his/her username, the ``retrieve_username`` method allows the user to type the email address and retrieve the username by email.</div><div class=""> - **request_reset_password**. Allows users who forgot their password to request a new password. They will get a confirmation email pointing to **reset_password**.</div><div class=""> - **impersonate** allows a user to &quot;impersonate&quot; another user. This is important for debugging and for support purposes. ``request.args[0]`` is the id of the user to be impersonated. This is only allowed if the logged in user ``has_permission(&#x27;impersonate&#x27;, db.auth_user, user_id)``. You can use ``auth.is_impersonating()`` to check is the current user is impersonating somebody else.</div><div class=""> - **groups** lists the groups of which the current logged in user is a member.</div><div class=""> - **not_authorized** displays an error message when the visitor tried to do something that he/she is not authorized to do</div><div class=""> - **navbar** is a helper that generates a bar with login/register/etc. links.</div><div class=""> </div><div class=""> Logout, profile, change_password, impersonate, and groups require login.</div><div class=""> </div><div class=""> By default they are all exposed, but it is possible to restrict access to only some of these actions.</div><div class=""> </div><div class=""> All of the methods above can be extended or replaced by subclassing **Auth**.</div><div class=""> </div><div class=""> All of the methods above can be used in separate actions. For example:</div><div class=""> </div><div class=""> auth.settings.registration_requires_approval = False</div><div class=""> auth.settings.reset_password_requires_verification = True</div><div class=""> auth.messages.verify_email = &#x27;Click on the link http://&#x27; + \</div><div class="">     request.env.http_host + \</div><div class="">     URL(r=request,c=&#x27;default&#x27;,f=&#x27;user&#x27;,args=[&#x27;verify_email&#x27;]) + \</div><div class="">     &#x27;/%(key)s to verify your email&#x27;</div><div class=""> auth.messages.reset_password = &#x27;Click on the link http://&#x27; + \</div><div class="">     request.env.http_host + \</div><div class="">     URL(r=request,c=&#x27;default&#x27;,f=&#x27;user&#x27;,args=[&#x27;reset_password&#x27;]) + \</div><div class="">     &#x27;/%(key)s to reset your password&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class=""> In the two ``auth.messages`` above, you may need to replace the URL portion of the string with the proper complete URL of the action. This is necessary because web2py may be installed behind a proxy, and it cannot determine its own public URLs with absolute certainty. The above examples (which are the default values) should, however, work in most cases.</div><div class=""> </div><div class=""> ### Authorization</div><div class=""> </div><div class=""> Once a new user is registered, a new group is created to contain the user. The role of the new user is conventionally &quot;user_[id]&quot; where [id] is the id of the newly created user. The creation of the group can be disabled with</div><div class=""> ``</div><div class=""> auth.settings.create_user_groups = None</div><div class=""> ``:code</div><div class=""> </div><div class="insert">although we do not suggest doing so. Notice that ``create_user_groups`` is not a boolean (although<span class="highlight"></span> it can be ``False``) but it defaults to:</div></div></div>
    <div class="span6"><div class="diff"><div class=""> **Auth** needs (and defines) the following tables:</div><div class=""> - ``auth_user`` stores users&#x27; name, email address, password, and status (registration pending, accepted, blocked)</div><div class=""> - ``auth_group`` stores groups or roles for users in a many-to-many structure. By default, each user is in its own group, but a user can be in multiple groups, and each group can contain multiple users. A group is identified by a role and a description.</div><div class=""> - ``auth_membership`` links users and groups in a many-to-many structure.</div><div class=""> - ``auth_permission`` links groups and permissions. A permission is identified by a name and, optionally, a table and a record. For example, members of a certain group can have &quot;update&quot; permissions on a specific record of a specific table.</div><div class=""> - ``auth_event`` logs changes in the other tables and successful access via CRUD to objects controlled by the RBAC.</div><div class="delete">- ``auth_cas`` is used for Central Authe<span class="highlight">tica</span>tication Service (CAS). Every web2py application is a CAS provider and can optionally be a CAS consumer.</div><div class=""> </div><div class=""> The schema is reproduced graphically in the image below:</div><div class=""> </div><div class=""> [[image @///image/schema_auth.png center 300px]]</div><div class=""> </div><div class=""> </div><div class=""> </div><div class=""> In principle, there is no restriction on the names of the roles and the names of the permissions; the developer can create them to fix the roles and permissions in the organization. Once they have been created, web2py provides an API to check if a user is logged in, if a user is a member of a given group, and/or if the user is a member of any group that has a given required permission.</div><div class=""> </div><div class=""> web2py also provides decorators to restrict access to any function based on login, membership and permissions.</div><div class=""> </div><div class=""> web2py also understands some specific permissions, i.e., those that have a name that correspond to the CRUD methods (create, read, update, delete) and can enforce them automatically without the need to use decorators.</div><div class=""> </div><div class=""> In this chapter, we are going to discuss different parts of RBAC one by one.</div><div class=""> </div><div class=""> ### Authentication</div><div class=""> </div><div class=""> In order to use RBAC, users need to be identified. This means that they need to register (or be registered) and log in.</div><div class=""> </div><div class=""> **Auth** provides multiple login methods. The default one consists of identifying users based on the local ``auth_user`` table.</div><div class=""> Alternatively, it can log in users against third-party authentication systems and single sign on providers such as Google, PAM, LDAP, Facebook, LinkedIn, Dropbox, OpenID, OAuth, etc..</div><div class=""> </div><div class=""> To start using ``Auth``, you need at least this code in a model file, which is also provided with the web2py &quot;welcome&quot; application and assumes a ``db`` connection object:</div><div class=""> ``</div><div class=""> from gluon.tools import Auth</div><div class=""> auth = Auth(db)</div><div class=""> auth.define_tables()</div><div class=""> ``:code</div><div class=""> </div><div class=""> Auth has an optional ``secure=True`` argument, which will force authenticated pages to go over HTTPS. ``https``:inxx</div><div class=""> </div><div class=""> -------</div><div class="delete">The ``password`` field of the ``db.auth_user`` table defaults to a ``CRYPT`` validator, which needs and ``hmac_key``. On legacy web2py applications you may see an extra argument passed to the Auth constructor: ``hmac_key = Auth.get_or_create_key()``. The latter is a function that read the <span class="highlight">hmac ka</span>y from a file &quot;private/auth.key&quot; within the application folder. If the file does not exist it creates a random ``hmac_key``. If multiple apps share the same auth database, make sure they also use the same ``hmac_key``. This is no loger necessary for new applications since passwords are salted with an individual random salt.</div><div class=""> -------</div><div class=""> </div><div class=""> By default, web2py uses email for login. If instead you want to log in using username set ``auth.define_tables(username=True)``</div><div class=""> </div><div class=""> If multiple apps share the same auth database you may want to disable migrations: ``auth.define_tables(migrate=False)``.</div><div class=""> </div><div class=""> To expose **Auth**, you also need the following function in a controller (for example in &quot;default.py&quot;):</div><div class=""> ``</div><div class=""> def user(): return dict(form=auth())</div><div class=""> ``:code</div><div class=""> </div><div class=""> -------</div><div class=""> The ``auth`` object and the ``user`` action are already defined in the</div><div class=""> scaffolding application.</div><div class=""> -------</div><div class=""> </div><div class=""> web2py also includes a sample view &quot;welcome/views/default/user.html&quot; to render this function properly that looks like this:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h2&gt;{{=T( request.args(0).replace(&#x27;_&#x27;,&#x27; &#x27;).capitalize() )}}&lt;/h2&gt;</div><div class=""> Notice that this function simply displays a ``form`` and therefore it can be cus</div><div class=""> {{if request.args(0)==&#x27;login&#x27;:}}...custom login form...{{pass}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> ``auth.impersonate``:inxx ``auth.is_impersonating``:inxx</div><div class=""> </div><div class=""> The controller above exposes multiple actions:</div><div class=""> ``</div><div class=""> http://.../[app]/default/user/register</div><div class=""> http://.../[app]/default/user/login</div><div class=""> http://.../[app]/default/user/logout</div><div class=""> http://.../[app]/default/user/profile</div><div class=""> http://.../[app]/default/user/change_password</div><div class=""> http://.../[app]/default/user/verify_email</div><div class=""> http://.../[app]/default/user/retrieve_username</div><div class=""> http://.../[app]/default/user/request_reset_password</div><div class=""> http://.../[app]/default/user/reset_password</div><div class=""> http://.../[app]/default/user/impersonate</div><div class=""> http://.../[app]/default/user/groups</div><div class=""> http://.../[app]/default/user/not_authorized</div><div class=""> ``:code</div><div class="delete">- **register** allows users to register. It is integrated with CAPTCHA, although this is disabled by default. This is also integrated with a client-side entropy calculator defined in &quot;web2py.js&quot;. The calculator indic<span class="highlight">tates the strenght</span> of the new password. You can use the ``IS_STRONG`` validator to prevent web2py from accepting weak passwords.</div><div class=""> - **login** allows users who are registered to log in (if the registration is verified or does not require verification, if it has been approved or does not require approval, and if it has not been blocked).</div><div class=""> - **logout** does what you would expect but also, as the other methods, logs the event and can be used to trigger some event.</div><div class=""> - **profile** allows users to edit their profile, i.e. the content of the ``auth_user`` table. Notice that this table does not have a fixed structure and can be customized.</div><div class=""> - **change_password** allows users to change their password in a fail-safe way.</div><div class=""> - **verify_email**. If email verification is turned on, then visitors, upon registration, receive an email with a link to verify their email information. The link points to this action.</div><div class=""> - **retrieve_username**. By default, **Auth** uses email and password for login, but it can, optionally, use username instead of email. In this latter case, if a user forgets his/her username, the ``retrieve_username`` method allows the user to type the email address and retrieve the username by email.</div><div class=""> - **request_reset_password**. Allows users who forgot their password to request a new password. They will get a confirmation email pointing to **reset_password**.</div><div class=""> - **impersonate** allows a user to &quot;impersonate&quot; another user. This is important for debugging and for support purposes. ``request.args[0]`` is the id of the user to be impersonated. This is only allowed if the logged in user ``has_permission(&#x27;impersonate&#x27;, db.auth_user, user_id)``. You can use ``auth.is_impersonating()`` to check is the current user is impersonating somebody else.</div><div class=""> - **groups** lists the groups of which the current logged in user is a member.</div><div class=""> - **not_authorized** displays an error message when the visitor tried to do something that he/she is not authorized to do</div><div class=""> - **navbar** is a helper that generates a bar with login/register/etc. links.</div><div class=""> </div><div class=""> Logout, profile, change_password, impersonate, and groups require login.</div><div class=""> </div><div class=""> By default they are all exposed, but it is possible to restrict access to only some of these actions.</div><div class=""> </div><div class=""> All of the methods above can be extended or replaced by subclassing **Auth**.</div><div class=""> </div><div class=""> All of the methods above can be used in separate actions. For example:</div><div class=""> </div><div class=""> auth.settings.registration_requires_approval = False</div><div class=""> auth.settings.reset_password_requires_verification = True</div><div class=""> auth.messages.verify_email = &#x27;Click on the link http://&#x27; + \</div><div class="">     request.env.http_host + \</div><div class="">     URL(r=request,c=&#x27;default&#x27;,f=&#x27;user&#x27;,args=[&#x27;verify_email&#x27;]) + \</div><div class="">     &#x27;/%(key)s to verify your email&#x27;</div><div class=""> auth.messages.reset_password = &#x27;Click on the link http://&#x27; + \</div><div class="">     request.env.http_host + \</div><div class="">     URL(r=request,c=&#x27;default&#x27;,f=&#x27;user&#x27;,args=[&#x27;reset_password&#x27;]) + \</div><div class="">     &#x27;/%(key)s to reset your password&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class=""> In the two ``auth.messages`` above, you may need to replace the URL portion of the string with the proper complete URL of the action. This is necessary because web2py may be installed behind a proxy, and it cannot determine its own public URLs with absolute certainty. The above examples (which are the default values) should, however, work in most cases.</div><div class=""> </div><div class=""> ### Authorization</div><div class=""> </div><div class=""> Once a new user is registered, a new group is created to contain the user. The role of the new user is conventionally &quot;user_[id]&quot; where [id] is the id of the newly created user. The creation of the group can be disabled with</div><div class=""> ``</div><div class=""> auth.settings.create_user_groups = None</div><div class=""> ``:code</div><div class=""> </div><div class="delete">although we do not suggest doing so. Notice that ``create_user_groups`` is not a boolean (although<span class="highlight">t</span> it can be ``False``) but it defaults to:</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/329109afbb83ba34de23d586d44aedbaa27502e5">329109a</a><ul><li>Date : 2012-12-28</li><li>added schema image</li></ul></li></ul>
<div class="row-fluid" id="com_329109afbb83ba34de23d586d44aedbaa27502e5">
    <div class="span6"><div class="diff"><div class=""> **Auth** needs (and defines) the following tables:</div><div class=""> - ``auth_user`` stores users&#x27; name, email address, password, and status (registration pending, accepted, blocked)</div><div class=""> - ``auth_group`` stores groups or roles for users in a many-to-many structure. By default, each user is in its own group, but a user can be in multiple groups, and each group can contain multiple users. A group is identified by a role and a description.</div><div class=""> - ``auth_membership`` links users and groups in a many-to-many structure.</div><div class=""> - ``auth_permission`` links groups and permissions. A permission is identified by a name and, optionally, a table and a record. For example, members of a certain group can have &quot;update&quot; permissions on a specific record of a specific table.</div><div class=""> - ``auth_event`` logs changes in the other tables and successful access via CRUD to objects controlled by the RBAC.</div><div class="insert">+- ``auth_cas`` is used for Central Autheticatication Service (CAS). Every web2py application is a CAS provider and can optionally be a CAS consumer.</div><div class="insert">+</div><div class="insert">+The schema is reproduced graphically in the image below:</div><div class="insert">+</div><div class="insert">+[[image @///image/schema_auth.png center 300px]]</div><div class="insert">+</div><div class="insert">+</div></div></div>
    <div class="span6"><div class="diff"><div class=""> **Auth** needs (and defines) the following tables:</div><div class=""> - ``auth_user`` stores users&#x27; name, email address, password, and status (registration pending, accepted, blocked)</div><div class=""> - ``auth_group`` stores groups or roles for users in a many-to-many structure. By default, each user is in its own group, but a user can be in multiple groups, and each group can contain multiple users. A group is identified by a role and a description.</div><div class=""> - ``auth_membership`` links users and groups in a many-to-many structure.</div><div class=""> - ``auth_permission`` links groups and permissions. A permission is identified by a name and, optionally, a table and a record. For example, members of a certain group can have &quot;update&quot; permissions on a specific record of a specific table.</div><div class=""> - ``auth_event`` logs changes in the other tables and successful access via CRUD to objects controlled by the RBAC.</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/097d699dc16179206ccb7e4aee863d6523cd471c">097d699</a><ul><li>Date : 2012-12-27</li><li>fixed typo, thanks Andrew</li></ul></li></ul>
<div class="row-fluid" id="com_097d699dc16179206ccb7e4aee863d6523cd471c">
    <div class="span6"><div class="diff"><div class=""> ``</div><div class="insert">auth.settings.label_separator =<span class="highlight">        </span>&#x27;:&#x27;</div><div class=""> ``:code</div></div></div>
    <div class="span6"><div class="diff"><div class=""> ``</div><div class="delete">auth.settings.label_separator =<span class="highlight">	</span>&#x27;:&#x27;</div><div class=""> ``:code</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/eaaa0e14bf17cdc4d0edd2ea9daa9af5f3484c09">eaaa0e1</a><ul><li>Date : 2012-12-25</li><li>changes to style</li></ul></li></ul>
<div class="row-fluid" id="com_eaaa0e14bf17cdc4d0edd2ea9daa9af5f3484c09">
    <div class="span6"><div class="diff"><div class="insert">Another way to do this<span class="highlight">, although not really recommended,</span> consists of defining your auth tables yourself. If a table is declared before ``auth.define_tables()`` it is used instead of the default one. Here is how to do it:</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">Another way to do this<span class="highlight"> (for experts!)</span> consists of defining your auth tables yourself. If a table is declared before ``auth.define_tables()`` it is used instead of the default one. Here is how to do it:</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/28816a98948c4a6577f73bdeb2b7424dc55d2582">28816a9</a><ul><li>Date : 2012-12-23</li><li>code building book</li></ul></li></ul>
<div class="row-fluid" id="com_28816a98948c4a6577f73bdeb2b7424dc55d2582">
    <div class="span6"><div class="diff"><div class="insert">More details: [[reCAPTCHA http://www.google.com/recaptcha]]``recaptchagoogle``:cite  and [[customizing http://code.google.com/apis/recaptcha/docs/customization.html]]<span class="highlight"></span>  .</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">More details: [[reCAPTCHA http://www.google.com/recaptcha]]``recaptchagoogle``:cite  and [[customizing http://code.google.com/apis/recaptcha/docs/customization.html]]<span class="highlight">``recaptchacustomizing``:cite</span>  .</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/c4e4f430a3fe8433d95790170768d74eaf109a49">c4e4f43</a><ul><li>Date : 2012-12-22</li><li>fixed subsection level</li></ul></li></ul>
<div class="row-fluid" id="com_c4e4f430a3fe8433d95790170768d74eaf109a49">
    <div class="span6"><div class="diff"><div class="insert"><span class="highlight">#</span>### ``Mail`` and ``Auth``</div></div></div>
    <div class="span6"><div class="diff"><div class="delete"><span class="highlight"></span>### ``Mail`` and ``Auth``</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/76c0363755694c36971ffc9db176312fe5c14276">76c0363</a><ul><li>Date : 2012-12-22</li><li>more and more additions and corrections</li></ul></li></ul>
<div class="row-fluid" id="com_76c0363755694c36971ffc9db176312fe5c14276">
    <div class="span6"><div class="diff"><div class=""> The controller above exposes multiple actions:</div><div class=""> ``</div><div class=""> http://.../[app]/default/user/register</div><div class=""> http://.../[app]/default/user/login</div><div class=""> http://.../[app]/default/user/logout</div><div class=""> http://.../[app]/default/user/profile</div><div class=""> http://.../[app]/default/user/change_password</div><div class=""> http://.../[app]/default/user/verify_email</div><div class=""> http://.../[app]/default/user/retrieve_username</div><div class=""> http://.../[app]/default/user/request_reset_password</div><div class=""> http://.../[app]/default/user/reset_password</div><div class=""> http://.../[app]/default/user/impersonate</div><div class=""> http://.../[app]/default/user/groups</div><div class=""> http://.../[app]/default/user/not_authorized</div><div class=""> ``:code</div><div class="insert">- **register** allows users to register. It is integrated with CAPTCHA, although this is disabled by default.<span class="highlight"> This is also integrated with a client-side entropy calculator defined in &quot;web2py.js&quot;. The calculator indictates the strenght of the new password. You can use the ``IS_STRONG`` validator to prevent web2py from accepting weak passwords. </span></div><div class=""> - **login** allows users who are registered to log in (if the registration is verified or does not require verification, if it has been approved or does not require approval, and if it has not been blocked).</div><div class=""> - **logout** does what you would expect but also, as the other methods, logs the event and can be used to trigger some event.</div><div class=""> - **profile** allows users to edit their profile, i.e. the content of the ``auth_user`` table. Notice that this table does not have a fixed structure and can be customized.</div><div class=""> - **change_password** allows users to change their password in a fail-safe way.</div><div class=""> - **verify_email**. If email verification is turned on, then visitors, upon registration, receive an email with a link to verify their email information. The link points to this action.</div><div class=""> - **retrieve_username**. By default, **Auth** uses email and password for login, but it can, optionally, use username instead of email. In this latter case, if a user forgets his/her username, the ``retrieve_username`` method allows the user to type the email address and retrieve the username by email.</div><div class=""> - **request_reset_password**. Allows users who forgot their password to request a new password. They will get a confirmation email pointing to **reset_password**.</div><div class=""> - **impersonate** allows a user to &quot;impersonate&quot; another user. This is important for debugging and for support purposes. ``request.args[0]`` is the id of the user to be impersonated. This is only allowed if the logged in user ``has_permission(&#x27;impersonate&#x27;, db.auth_user, user_id)``. You can use ``auth.is_impersonating()`` to check is the current user is impersonating somebody else.</div><div class=""> - **groups** lists the groups of which the current logged in user is a member.</div><div class=""> - **not_authorized** displays an error message when the visitor tried to do something that he/she is not authorized to do</div><div class=""> - **navbar** is a helper that generates a bar with login/register/etc. links.</div></div></div>
    <div class="span6"><div class="diff"><div class=""> The controller above exposes multiple actions:</div><div class=""> ``</div><div class=""> http://.../[app]/default/user/register</div><div class=""> http://.../[app]/default/user/login</div><div class=""> http://.../[app]/default/user/logout</div><div class=""> http://.../[app]/default/user/profile</div><div class=""> http://.../[app]/default/user/change_password</div><div class=""> http://.../[app]/default/user/verify_email</div><div class=""> http://.../[app]/default/user/retrieve_username</div><div class=""> http://.../[app]/default/user/request_reset_password</div><div class=""> http://.../[app]/default/user/reset_password</div><div class=""> http://.../[app]/default/user/impersonate</div><div class=""> http://.../[app]/default/user/groups</div><div class=""> http://.../[app]/default/user/not_authorized</div><div class=""> ``:code</div><div class="delete">- **register** allows users to register. It is integrated with CAPTCHA, although this is disabled by default.<span class="highlight"></span></div><div class=""> - **login** allows users who are registered to log in (if the registration is verified or does not require verification, if it has been approved or does not require approval, and if it has not been blocked).</div><div class=""> - **logout** does what you would expect but also, as the other methods, logs the event and can be used to trigger some event.</div><div class=""> - **profile** allows users to edit their profile, i.e. the content of the ``auth_user`` table. Notice that this table does not have a fixed structure and can be customized.</div><div class=""> - **change_password** allows users to change their password in a fail-safe way.</div><div class=""> - **verify_email**. If email verification is turned on, then visitors, upon registration, receive an email with a link to verify their email information. The link points to this action.</div><div class=""> - **retrieve_username**. By default, **Auth** uses email and password for login, but it can, optionally, use username instead of email. In this latter case, if a user forgets his/her username, the ``retrieve_username`` method allows the user to type the email address and retrieve the username by email.</div><div class=""> - **request_reset_password**. Allows users who forgot their password to request a new password. They will get a confirmation email pointing to **reset_password**.</div><div class=""> - **impersonate** allows a user to &quot;impersonate&quot; another user. This is important for debugging and for support purposes. ``request.args[0]`` is the id of the user to be impersonated. This is only allowed if the logged in user ``has_permission(&#x27;impersonate&#x27;, db.auth_user, user_id)``. You can use ``auth.is_impersonating()`` to check is the current user is impersonating somebody else.</div><div class=""> - **groups** lists the groups of which the current logged in user is a member.</div><div class=""> - **not_authorized** displays an error message when the visitor tried to do something that he/she is not authorized to do</div><div class=""> - **navbar** is a helper that generates a bar with login/register/etc. links.</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/7bce1473ce90f4e60f49d72bf1b61d32f430cb54">7bce147</a><ul><li>Date : 2012-12-22</li><li>scheduler.queue_task</li></ul></li></ul>
<div class="row-fluid" id="com_7bce1473ce90f4e60f49d72bf1b61d32f430cb54">
    <div class="span6"><div class="diff"><div class="insert">gives permission &quot;name&quot; (user defined) on the object &quot;object&quot; (also user defined) to members of the group ``group_id``. If &quot;object&quot; is a tablename then the permission can refer to the entire table by setting ``record_id`` to a value of zero, or the permission can refer to a specific record by specifying a ``record_id`` value greater than zero. When giving permissions on tables, it is common to use a permission name in the set (&#x27;create&#x27;, &#x27;read&#x27;, &#x27;update&#x27;, &#x27;delete&#x27;, &#x27;select&#x27;) since these permissions are understood and can be enforced by<span class="highlight"> the</span> CRUD<span class="highlight"> APIs</span>.</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">gives permission &quot;name&quot; (user defined) on the object &quot;object&quot; (also user defined) to members of the group ``group_id``. If &quot;object&quot; is a tablename then the permission can refer to the entire table by setting ``record_id`` to a value of zero, or the permission can refer to a specific record by specifying a ``record_id`` value greater than zero. When giving permissions on tables, it is common to use a permission name in the set (&#x27;create&#x27;, &#x27;read&#x27;, &#x27;update&#x27;, &#x27;delete&#x27;, &#x27;select&#x27;) since these permissions are understood and can be enforced by<span class="highlight"></span> CRUD<span class="highlight"></span>.</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/e234f6edf67361b3ba718ea10184ba8e7c2f773d">e234f6e</a><ul><li>Date : 2012-12-20</li><li>lots of improvements</li></ul></li></ul>
<div class="row-fluid" id="com_e234f6edf67361b3ba718ea10184ba8e7c2f773d">
    <div class="span6"><div class="diff"><div class="insert">+Auth has an optional ``secure=True`` argument, which will force authenticated pages to go over HTTPS. ``https``:inxx</div><div class="insert">+</div><div class=""> -------</div><div class=""> The ``password`` field of the ``db.auth_user`` table defaults to a ``CRYPT`` validator, which needs and ``hmac_key``. On legacy web2py applications you may see an extra argument passed to the Auth constructor: ``hmac_key = Auth.get_or_create_key()``. The latter is a function that read the hmac kay from a file &quot;private/auth.key&quot; within the application folder. If the file does not exist it creates a random ``hmac_key``. If multiple apps share the same auth database, make sure they also use the same ``hmac_key``. This is no loger necessary for new applications since passwords are salted with an individual random salt.</div><div class=""> -------</div><div class=""> </div><div class=""> By default, web2py uses email for login. If instead you want to log in using username set ``auth.define_tables(username=True)``</div><div class=""> </div><div class=""> If multiple apps share the same auth database you may want to disable migrations: ``auth.define_tables(migrate=False)``.</div><div class=""> </div><div class=""> To expose **Auth**, you also need the following function in a controller (for example in &quot;default.py&quot;):</div><div class=""> ``</div><div class=""> def user(): return dict(form=auth())</div><div class=""> ``:code</div><div class=""> </div><div class=""> -------</div><div class=""> The ``auth`` object and the ``user`` action are already defined in the</div><div class=""> scaffolding application.</div><div class=""> -------</div><div class=""> </div><div class=""> web2py also includes a sample view &quot;welcome/views/default/user.html&quot; to render this function properly that looks like this:</div><div class=""> ``</div><div class=""> web2py also includes a sample view &quot;welcome/views/default/user.html&quot; to render t</div><div class=""> &lt;h2&gt;{{=T( request.args(0).replace(&#x27;_&#x27;,&#x27; &#x27;).capitalize() )}}&lt;/h2&gt;</div><div class=""> &lt;div id=&quot;web2py_user_form&quot;&gt;</div><div class="">   {{=form}}</div><div class="">   {{if request.args(0)==&#x27;login&#x27;:}}</div><div class="">     {{if not &#x27;register&#x27; in auth.settings.actions_disabled:}}</div><div class="">       &lt;br/&gt;&lt;a href=&quot;{{=URL(args=&#x27;register&#x27;)}}&quot;&gt;register&lt;/a&gt;</div><div class="">     {{pass}}</div><div class="">     {{if not &#x27;request_reset_password&#x27; in auth.settings.actions_disabled:}}</div><div class="">       &lt;br/&gt;</div><div class="">       &lt;a href=&quot;{{=URL(args=&#x27;request_reset_password&#x27;)}}&quot;&gt;lost password&lt;/a&gt;</div><div class="">     {{pass}}</div><div class="">   {{pass}}</div><div class=""> &lt;/div&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> Notice that this function simply displays a ``form`` and therefore it can be customized using normal custom form syntax. The only caveat is that the form displayed by ``form=auth()`` depends on ``request.args(0)``; therefore, if you replace the default ``auth()`` login form with a custom login form, you may need an ``if`` statement like this in the view:</div><div class=""> ``</div><div class=""> {{if request.args(0)==&#x27;login&#x27;:}}...custom login form...{{pass}}</div><div class=""> ``:code</div><div class=""> </div><div class="insert">+``auth.impersonate``:inxx ``auth.is_impersonating``:inxx</div><div class="insert">+</div><div class=""> The controller above exposes multiple actions:</div><div class=""> ``</div><div class=""> http://.../[app]/default/user/register</div><div class=""> http://.../[app]/default/user/login</div><div class=""> http://.../[app]/default/user/logout</div><div class=""> http://.../[app]/default/user/profile</div><div class=""> http://.../[app]/default/user/change_password</div><div class=""> http://.../[app]/default/user/verify_email</div><div class=""> http://.../[app]/default/user/retrieve_username</div><div class=""> http://.../[app]/default/user/request_reset_password</div><div class=""> http://.../[app]/default/user/reset_password</div><div class=""> http://.../[app]/default/user/impersonate</div><div class=""> http://.../[app]/default/user/groups</div><div class=""> http://.../[app]/default/user/not_authorized</div><div class=""> ``:code</div><div class=""> - **register** allows users to register. It is integrated with CAPTCHA, although this is disabled by default.</div><div class=""> - **login** allows users who are registered to log in (if the registration is verified or does not require verification, if it has been approved or does not require approval, and if it has not been blocked).</div><div class=""> - **logout** does what you would expect but also, as the other methods, logs the event and can be used to trigger some event.</div><div class=""> - **profile** allows users to edit their profile, i.e. the content of the ``auth_user`` table. Notice that this table does not have a fixed structure and can be customized.</div><div class=""> - **change_password** allows users to change their password in a fail-safe way.</div><div class=""> - **verify_email**. If email verification is turned on, then visitors, upon registration, receive an email with a link to verify their email information. The link points to this action.</div><div class=""> - **retrieve_username**. By default, **Auth** uses email and password for login, but it can, optionally, use username instead of email. In this latter case, if a user forgets his/her username, the ``retrieve_username`` method allows the user to type the email address and retrieve the username by email.</div><div class=""> - **request_reset_password**. Allows users who forgot their password to request a new password. They will get a confirmation email pointing to **reset_password**.</div><div class="insert">- **impersonate** allows a user to &quot;impersonate&quot; another user. This is important for debugging and for support purposes. ``request.args[0]`` is the id of the user to be impersonated. This is only allowed if the logged in user ``has_permission(&#x27;impersonate&#x27;, db.auth_user, user_id)``.<span class="highlight"> You can use ``auth.is_impersonating()`` to check is the current user is impersonating somebody else.</span></div><div class=""> - **groups** lists the groups of which the current logged in user is a member.</div><div class=""> - **not_authorized** displays an error message when the visitor tried to do something that he/she is not authorized to do</div><div class=""> - **navbar** is a helper that generates a bar with login/register/etc. links.</div><div class=""> </div><div class=""> Logout, profile, change_password, impersonate, and groups require login.</div><div class=""> </div><div class=""> By default they are all exposed, but it is possible to restrict access to only some of these actions.</div><div class=""> </div><div class=""> All of the methods above can be extended or replaced by subclassing **Auth**.</div><div class=""> </div><div class=""> All of the methods above can be used in separate actions. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> def mylogin(): return dict(form=auth.login())</div><div class=""> def myregister(): return dict(form=auth.register())</div><div class=""> def myprofile(): return dict(form=auth.profile())</div><div class=""> ...</div><div class=""> ``</div><div class=""> </div><div class=""> To restrict access to functions to only logged in visitors, decorate the function as in the following example</div><div class=""> ``</div><div class=""> @auth.requires_login()</div><div class=""> def hello():</div><div class="">     return dict(message=&#x27;hello %(first_name)s&#x27; % auth.user)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Any function can be decorated, not just exposed actions. Of course this is still only a very simple example of access control. More complex examples will be discussed later.</div><div class="insert">``auth.user``:inxx ``auth.user_id``:inxx<span class="highlight"> ``auth.user_groups``.</span></div><div class=""> </div><div class=""> -----</div><div class="insert">``auth.user`` contains a copy of the ``db.auth_user`` records for the current logged in user or ``None`` otherwise. There is also a ``auth.user_id`` which is the same as ``auth.user.id`` (i.e. the id of the current logger in user) or ``None``.<span class="highlight"> Similarly, ``auth.user_groups`` contains a dictionary where each key is the id of a group of with the current logged in user is member of, the value is the corresponding group role.</span></div><div class=""> -----</div><div class=""> </div><div class=""> ``otherwise``:inxx</div><div class=""> </div><div class=""> The ``auth.requires_login()`` decorator as well as the other ``auth.requires_*`` decorators take an optional ``otherwise`` argument. It can be set to a string where to redirect the user if registration files or to a callable object. It is called if registration fails.</div><div class=""> </div><div class=""> #### Restrictions on registration</div><div class=""> </div><div class=""> If you want to allow visitors to register but not to log in until registration has been approved by the administrator:</div><div class=""> ``</div><div class=""> auth.settings.registration_requires_approval = True</div><div class=""> ``:code</div><div class=""> </div><div class=""> You can approve a registration via the appadmin interface. Look into the table ``auth_user``. Pending registrations have a ``registration_key`` field set to &quot;pending&quot;. A registration is approved when this field is set to blank.</div><div class=""> </div><div class=""> Via the appadmin interface, you can also block a user from logging in. Locate the user in the table ``auth_user`` and set the ``registration_key`` to &quot;blocked&quot;. &quot;blocked&quot; users are not allowed to log in. Notice that this will prevent a visitor from logging in but it will not force a visitor who is already logged in to log out. The word &quot;disabled&quot; may be used instead of &quot;blocked&quot; if preferred, with exactly the same behavior.</div><div class=""> </div><div class=""> You can also block access to the &quot;register&quot; page completely with this statement:</div><div class=""> ``</div><div class=""> auth.settings.actions_disabled.append(&#x27;register&#x27;)</div><div class=""> curl -d &quot;firstName=John&amp;lastName=Smith&quot; -G -v --key private.key \</div><div class=""> </div><div class=""> This works out of the box with Rocket (the web2py built-in web server) but you may need some extra configuration work on the web server side if you are using a different web server. In particular you need to tell your web server where the certificates are located on local host and that it needs to verify certificates coming from the clients. How to do it is web server dependent and therefore omitted here.</div><div class=""> </div><div class=""> ##### Multiple login forms</div><div class=""> </div><div class=""> Some login methods modify the login_form, some do not. When they do that, they may not be able to coexist. Yet some coexist by providing multiple login forms in the same page. web2py provides a way to do it. Here is an example mixing normal login (auth) and RPX login (janrain.com):</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.contrib.login_methods.extended_login_form import ExtendedLoginForm</div><div class=""> other_form = RPXAccount(request, api_key=&#x27;...&#x27;, domain=&#x27;...&#x27;, url=&#x27;...&#x27;)</div><div class=""> auth.settings.login_form = ExtendedLoginForm(auth, other_form, signals=[&#x27;token&#x27;])</div><div class=""> ``:code</div><div class=""> </div><div class=""> If signals are set and a parameter in request matches any signals,</div><div class=""> it will return the call of ``other_form.login_form`` instead.</div><div class=""> ``other_form`` can handle some particular situations, for example,</div><div class=""> multiple steps of OpenID login inside ``other_form.login_form``.</div><div class=""> </div><div class=""> Otherwise it will render the normal login form together with the ``other_form``.</div><div class=""> </div><div class="insert">+#### Record versioning</div><div class="insert">+</div><div class="insert">+You can use Auth to enable full record versioning:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+db.enable_record_versioning(db,</div><div class="insert">+    archive_db=None,</div><div class="insert">+    archive_names=&#x27;%(tablename)s_archive&#x27;,</div><div class="insert">+    current_record=&#x27;current_record&#x27;):</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+This tells web2py to create an archive table for each of the tables in ``db`` and store a copy of each record when modified. The old copy is stored. The new copy is not.</div><div class="insert">+</div><div class="insert">+The last three parameters are optional:</div><div class="insert">+</div><div class="insert">+- ``archive_db`` allows to specify another database where the archive tables are to be stored. Setting it to ``None`` is the same as setting it to ``db``.</div><div class="insert">+- ``archive_names`` provides a pattern for naming each archive table.</div><div class="insert">+- ``current_record`` specified the name of the reference field to be used in the archive table to refer to the original, unmodified, record. Notice that ``archive_db!=db`` then the reference field is just an integer field since cross database references are not possible.</div><div class="insert">+</div><div class="insert">+</div><div class="insert">+Only tables with ``modified_by`` and ``modified_on`` fields (as created</div><div class="insert">+for example by auth.signature) will be archived.</div><div class="insert">+</div><div class="insert">+When you ``enable_record_versioning``, if records have an </div><div class="insert">+``is_active`` field (also created by auth.signature), </div><div class="insert">+records will never be deleted but they will be marked with ``is_active=False``.</div><div class="insert">+In fact, ``enable_record_versioning`` adds a ``common_filter`` to </div><div class="insert">+every versioned table that filters out records with ``is_active=False`` so they essentially become invisible.</div><div class="insert">+</div><div class="insert">+If you ``enable_record_versioning``, you should not use </div><div class="insert">+``auth.archive`` or ``crud.archive`` else you will end up with duplicate records.</div><div class="insert">+Those functions do explicitly what ``enable_record_versioning`` does automatically and</div><div class="insert">+they will be deprecated.</div><div class="insert">+</div><div class="insert">+</div><div class=""> ### ``Mail`` and ``Auth``</div><div class=""> </div><div class=""> One can define a mailer with</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.tools import Mail</div><div class=""> mail = Mail()</div><div class=""> mail.settings.server = &#x27;smtp.example.com:25&#x27;</div><div class=""> mail.settings.sender = &#x27;you@example.com&#x27;</div><div class=""> mail.settings.login = &#x27;username:password&#x27;</div><div class=""> </div><div class=""> ``</div><div class=""> </div><div class=""> or simply use the mailer provided by ``auth``:</div><div class=""> </div><div class=""> ``</div><div class=""> mail = auth.settings.mailer</div><div class=""> mail.settings.server = &#x27;smtp.example.com:25&#x27;</div><div class=""> mail.settings.sender = &#x27;you@example.com&#x27;</div><div class=""> mail.settings.login = &#x27;username:password&#x27;</div><div class=""> To enable email, append the following lines in the model where ``auth`` is defin</div><div class=""> ``</div><div class=""> auth.settings.registration_requires_verification = True</div><div class=""> auth.settings.registration_requires_approval = False</div><div class=""> auth.settings.reset_password_requires_verification = True</div><div class=""> auth.messages.verify_email = &#x27;Click on the link http://&#x27; + \</div><div class="">     request.env.http_host + \</div><div class="">     URL(r=request,c=&#x27;default&#x27;,f=&#x27;user&#x27;,args=[&#x27;verify_email&#x27;]) + \</div><div class="">     &#x27;/%(key)s to verify your email&#x27;</div><div class=""> auth.messages.reset_password = &#x27;Click on the link http://&#x27; + \</div><div class="">     request.env.http_host + \</div><div class="">     URL(r=request,c=&#x27;default&#x27;,f=&#x27;user&#x27;,args=[&#x27;reset_password&#x27;]) + \</div><div class="">     &#x27;/%(key)s to reset your password&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class=""> In the two ``auth.messages`` above, you may need to replace the URL portion of the string with the proper complete URL of the action. This is necessary because web2py may be installed behind a proxy, and it cannot determine its own public URLs with absolute certainty. The above examples (which are the default values) should, however, work in most cases.</div><div class=""> </div><div class=""> ### Authorization</div><div class=""> </div><div class=""> Once a new user is registered, a new group is created to contain the user. The role of the new user is conventionally &quot;user_[id]&quot; where [id] is the id of the newly created user. The creation of the group can be disabled with</div><div class=""> ``</div><div class="insert">auth.settings.create_user_groups = <span class="highlight">Non</span>e</div><div class=""> ``:code</div><div class=""> </div><div class="insert">+although we do not suggest doing so. Notice that ``create_user_groups`` is not a boolean (althought it can be ``False``) but it defaults to:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.settings.create_user_groups=&quot;user_%(id)s&quot;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+It store a template for the name of the group created for user ``id``.</div><div class="insert">+</div><div class="insert">+Users have membership in groups. Each group is identified by a name/role. Groups have permissions. Users have permissions because of the groups they belong to. By default each user is made member of their own group.</div><div class="insert">+</div><div class="insert">+You can also also do</div><div class="insert">+``</div><div class="insert">+auth.settings.everybody_group_id = 5</div><div class="insert">+``:code</div><div class=""> </div><div class="insert"><span class="highlight">to make any new u</span>ser<span class="highlight"></span> <span class="highlight"></span>a<span class="highlight">utomatically</span> member<span class="highlight"></span> <span class="highlight"></span>o<span class="highlight">f</span> group <span class="highlight">number 5. Here 5 </span>is <span class="highlight">us</span>ed <span class="highlight">as</span> a<span class="highlight">n</span> <span class="highlight">ex</span>am<span class="highlight">p</span>le<span class="highlight"></span> <span class="highlight">and</span> <span class="highlight">w</span>e <span class="highlight">a</span>ss<span class="highlight">um</span>e<span class="highlight"></span> the group<span class="highlight"> wa</span>s <span class="highlight">crea</span>t<span class="highlight"></span>e<span class="highlight">d alread</span>y<span class="highlight"></span>.</div></div></div>
    <div class="span6"><div class="diff"><div class=""> -------</div><div class=""> The ``password`` field of the ``db.auth_user`` table defaults to a ``CRYPT`` validator, which needs and ``hmac_key``. On legacy web2py applications you may see an extra argument passed to the Auth constructor: ``hmac_key = Auth.get_or_create_key()``. The latter is a function that read the hmac kay from a file &quot;private/auth.key&quot; within the application folder. If the file does not exist it creates a random ``hmac_key``. If multiple apps share the same auth database, make sure they also use the same ``hmac_key``. This is no loger necessary for new applications since passwords are salted with an individual random salt.</div><div class=""> -------</div><div class=""> </div><div class=""> By default, web2py uses email for login. If instead you want to log in using username set ``auth.define_tables(username=True)``</div><div class=""> </div><div class=""> If multiple apps share the same auth database you may want to disable migrations: ``auth.define_tables(migrate=False)``.</div><div class=""> </div><div class=""> To expose **Auth**, you also need the following function in a controller (for example in &quot;default.py&quot;):</div><div class=""> ``</div><div class=""> def user(): return dict(form=auth())</div><div class=""> ``:code</div><div class=""> </div><div class=""> -------</div><div class=""> The ``auth`` object and the ``user`` action are already defined in the</div><div class=""> scaffolding application.</div><div class=""> -------</div><div class=""> </div><div class=""> web2py also includes a sample view &quot;welcome/views/default/user.html&quot; to render this function properly that looks like this:</div><div class=""> ``</div><div class=""> web2py also includes a sample view &quot;welcome/views/default/user.html&quot; to render t</div><div class=""> &lt;h2&gt;{{=T( request.args(0).replace(&#x27;_&#x27;,&#x27; &#x27;).capitalize() )}}&lt;/h2&gt;</div><div class=""> &lt;div id=&quot;web2py_user_form&quot;&gt;</div><div class="">   {{=form}}</div><div class="">   {{if request.args(0)==&#x27;login&#x27;:}}</div><div class="">     {{if not &#x27;register&#x27; in auth.settings.actions_disabled:}}</div><div class="">       &lt;br/&gt;&lt;a href=&quot;{{=URL(args=&#x27;register&#x27;)}}&quot;&gt;register&lt;/a&gt;</div><div class="">     {{pass}}</div><div class="">     {{if not &#x27;request_reset_password&#x27; in auth.settings.actions_disabled:}}</div><div class="">       &lt;br/&gt;</div><div class="">       &lt;a href=&quot;{{=URL(args=&#x27;request_reset_password&#x27;)}}&quot;&gt;lost password&lt;/a&gt;</div><div class="">     {{pass}}</div><div class="">   {{pass}}</div><div class=""> &lt;/div&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> Notice that this function simply displays a ``form`` and therefore it can be customized using normal custom form syntax. The only caveat is that the form displayed by ``form=auth()`` depends on ``request.args(0)``; therefore, if you replace the default ``auth()`` login form with a custom login form, you may need an ``if`` statement like this in the view:</div><div class=""> ``</div><div class=""> {{if request.args(0)==&#x27;login&#x27;:}}...custom login form...{{pass}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> The controller above exposes multiple actions:</div><div class=""> ``</div><div class=""> http://.../[app]/default/user/register</div><div class=""> http://.../[app]/default/user/login</div><div class=""> http://.../[app]/default/user/logout</div><div class=""> http://.../[app]/default/user/profile</div><div class=""> http://.../[app]/default/user/change_password</div><div class=""> http://.../[app]/default/user/verify_email</div><div class=""> http://.../[app]/default/user/retrieve_username</div><div class=""> http://.../[app]/default/user/request_reset_password</div><div class=""> http://.../[app]/default/user/reset_password</div><div class=""> http://.../[app]/default/user/impersonate</div><div class=""> http://.../[app]/default/user/groups</div><div class=""> http://.../[app]/default/user/not_authorized</div><div class=""> ``:code</div><div class=""> - **register** allows users to register. It is integrated with CAPTCHA, although this is disabled by default.</div><div class=""> - **login** allows users who are registered to log in (if the registration is verified or does not require verification, if it has been approved or does not require approval, and if it has not been blocked).</div><div class=""> - **logout** does what you would expect but also, as the other methods, logs the event and can be used to trigger some event.</div><div class=""> - **profile** allows users to edit their profile, i.e. the content of the ``auth_user`` table. Notice that this table does not have a fixed structure and can be customized.</div><div class=""> - **change_password** allows users to change their password in a fail-safe way.</div><div class=""> - **verify_email**. If email verification is turned on, then visitors, upon registration, receive an email with a link to verify their email information. The link points to this action.</div><div class=""> - **retrieve_username**. By default, **Auth** uses email and password for login, but it can, optionally, use username instead of email. In this latter case, if a user forgets his/her username, the ``retrieve_username`` method allows the user to type the email address and retrieve the username by email.</div><div class=""> - **request_reset_password**. Allows users who forgot their password to request a new password. They will get a confirmation email pointing to **reset_password**.</div><div class="delete">- **impersonate** allows a user to &quot;impersonate&quot; another user. This is important for debugging and for support purposes. ``request.args[0]`` is the id of the user to be impersonated. This is only allowed if the logged in user ``has_permission(&#x27;impersonate&#x27;, db.auth_user, user_id)``.<span class="highlight"></span></div><div class=""> - **groups** lists the groups of which the current logged in user is a member.</div><div class=""> - **not_authorized** displays an error message when the visitor tried to do something that he/she is not authorized to do</div><div class=""> - **navbar** is a helper that generates a bar with login/register/etc. links.</div><div class=""> </div><div class=""> Logout, profile, change_password, impersonate, and groups require login.</div><div class=""> </div><div class=""> By default they are all exposed, but it is possible to restrict access to only some of these actions.</div><div class=""> </div><div class=""> All of the methods above can be extended or replaced by subclassing **Auth**.</div><div class=""> </div><div class=""> All of the methods above can be used in separate actions. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> def mylogin(): return dict(form=auth.login())</div><div class=""> def myregister(): return dict(form=auth.register())</div><div class=""> def myprofile(): return dict(form=auth.profile())</div><div class=""> ...</div><div class=""> ``</div><div class=""> </div><div class=""> To restrict access to functions to only logged in visitors, decorate the function as in the following example</div><div class=""> ``</div><div class=""> @auth.requires_login()</div><div class=""> def hello():</div><div class="">     return dict(message=&#x27;hello %(first_name)s&#x27; % auth.user)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Any function can be decorated, not just exposed actions. Of course this is still only a very simple example of access control. More complex examples will be discussed later.</div><div class="delete">``auth.user``:inxx ``auth.user_id``:inxx<span class="highlight"></span></div><div class=""> </div><div class=""> -----</div><div class="delete">``auth.user`` contains a copy of the ``db.auth_user`` records for the current logged in user or ``None`` otherwise. There is also a ``auth.user_id`` which is the same as ``auth.user.id`` (i.e. the id of the current logger in user) or ``None``.<span class="highlight"></span></div><div class=""> -----</div><div class=""> </div><div class=""> ``otherwise``:inxx</div><div class=""> </div><div class=""> The ``auth.requires_login()`` decorator as well as the other ``auth.requires_*`` decorators take an optional ``otherwise`` argument. It can be set to a string where to redirect the user if registration files or to a callable object. It is called if registration fails.</div><div class=""> </div><div class=""> #### Restrictions on registration</div><div class=""> </div><div class=""> If you want to allow visitors to register but not to log in until registration has been approved by the administrator:</div><div class=""> ``</div><div class=""> auth.settings.registration_requires_approval = True</div><div class=""> ``:code</div><div class=""> </div><div class=""> You can approve a registration via the appadmin interface. Look into the table ``auth_user``. Pending registrations have a ``registration_key`` field set to &quot;pending&quot;. A registration is approved when this field is set to blank.</div><div class=""> </div><div class=""> Via the appadmin interface, you can also block a user from logging in. Locate the user in the table ``auth_user`` and set the ``registration_key`` to &quot;blocked&quot;. &quot;blocked&quot; users are not allowed to log in. Notice that this will prevent a visitor from logging in but it will not force a visitor who is already logged in to log out. The word &quot;disabled&quot; may be used instead of &quot;blocked&quot; if preferred, with exactly the same behavior.</div><div class=""> </div><div class=""> You can also block access to the &quot;register&quot; page completely with this statement:</div><div class=""> ``</div><div class=""> auth.settings.actions_disabled.append(&#x27;register&#x27;)</div><div class=""> curl -d &quot;firstName=John&amp;lastName=Smith&quot; -G -v --key private.key \</div><div class=""> </div><div class=""> This works out of the box with Rocket (the web2py built-in web server) but you may need some extra configuration work on the web server side if you are using a different web server. In particular you need to tell your web server where the certificates are located on local host and that it needs to verify certificates coming from the clients. How to do it is web server dependent and therefore omitted here.</div><div class=""> </div><div class=""> ##### Multiple login forms</div><div class=""> </div><div class=""> Some login methods modify the login_form, some do not. When they do that, they may not be able to coexist. Yet some coexist by providing multiple login forms in the same page. web2py provides a way to do it. Here is an example mixing normal login (auth) and RPX login (janrain.com):</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.contrib.login_methods.extended_login_form import ExtendedLoginForm</div><div class=""> other_form = RPXAccount(request, api_key=&#x27;...&#x27;, domain=&#x27;...&#x27;, url=&#x27;...&#x27;)</div><div class=""> auth.settings.login_form = ExtendedLoginForm(auth, other_form, signals=[&#x27;token&#x27;])</div><div class=""> ``:code</div><div class=""> </div><div class=""> If signals are set and a parameter in request matches any signals,</div><div class=""> it will return the call of ``other_form.login_form`` instead.</div><div class=""> ``other_form`` can handle some particular situations, for example,</div><div class=""> multiple steps of OpenID login inside ``other_form.login_form``.</div><div class=""> </div><div class=""> Otherwise it will render the normal login form together with the ``other_form``.</div><div class=""> </div><div class=""> ### ``Mail`` and ``Auth``</div><div class=""> </div><div class=""> One can define a mailer with</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.tools import Mail</div><div class=""> mail = Mail()</div><div class=""> mail.settings.server = &#x27;smtp.example.com:25&#x27;</div><div class=""> mail.settings.sender = &#x27;you@example.com&#x27;</div><div class=""> mail.settings.login = &#x27;username:password&#x27;</div><div class=""> </div><div class=""> ``</div><div class=""> </div><div class=""> or simply use the mailer provided by ``auth``:</div><div class=""> </div><div class=""> ``</div><div class=""> mail = auth.settings.mailer</div><div class=""> mail.settings.server = &#x27;smtp.example.com:25&#x27;</div><div class=""> mail.settings.sender = &#x27;you@example.com&#x27;</div><div class=""> mail.settings.login = &#x27;username:password&#x27;</div><div class=""> To enable email, append the following lines in the model where ``auth`` is defin</div><div class=""> ``</div><div class=""> auth.settings.registration_requires_verification = True</div><div class=""> auth.settings.registration_requires_approval = False</div><div class=""> auth.settings.reset_password_requires_verification = True</div><div class=""> auth.messages.verify_email = &#x27;Click on the link http://&#x27; + \</div><div class="">     request.env.http_host + \</div><div class="">     URL(r=request,c=&#x27;default&#x27;,f=&#x27;user&#x27;,args=[&#x27;verify_email&#x27;]) + \</div><div class="">     &#x27;/%(key)s to verify your email&#x27;</div><div class=""> auth.messages.reset_password = &#x27;Click on the link http://&#x27; + \</div><div class="">     request.env.http_host + \</div><div class="">     URL(r=request,c=&#x27;default&#x27;,f=&#x27;user&#x27;,args=[&#x27;reset_password&#x27;]) + \</div><div class="">     &#x27;/%(key)s to reset your password&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class=""> In the two ``auth.messages`` above, you may need to replace the URL portion of the string with the proper complete URL of the action. This is necessary because web2py may be installed behind a proxy, and it cannot determine its own public URLs with absolute certainty. The above examples (which are the default values) should, however, work in most cases.</div><div class=""> </div><div class=""> ### Authorization</div><div class=""> </div><div class=""> Once a new user is registered, a new group is created to contain the user. The role of the new user is conventionally &quot;user_[id]&quot; where [id] is the id of the newly created user. The creation of the group can be disabled with</div><div class=""> ``</div><div class="delete">auth.settings.create_user_groups = <span class="highlight">Fals</span>e</div><div class=""> ``:code</div><div class=""> </div><div class="delete">-although we do not suggest doing so.</div><div class=""> </div><div class="delete"><span class="highlight">U</span>ser<span class="highlight">s</span> <span class="highlight">h</span>a<span class="highlight">ve</span> member<span class="highlight">ship</span> <span class="highlight">in gr</span>o<span class="highlight">ups. Each</span> group <span class="highlight"></span>is <span class="highlight">identifi</span>ed <span class="highlight">by</span> a<span class="highlight"></span> <span class="highlight">n</span>am<span class="highlight">e/ro</span>le<span class="highlight">.</span> <span class="highlight">Groups</span> <span class="highlight">hav</span>e <span class="highlight">permi</span>ss<span class="highlight">ions. Us</span>e<span class="highlight">rs have permissions because of</span> the group<span class="highlight"></span>s <span class="highlight"></span>t<span class="highlight">h</span>e<span class="highlight"></span>y<span class="highlight"> belong to</span>.</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/82dc64e7baa231edd3896ca7a0d41393e426f123">82dc64e</a><ul><li>Date : 2012-12-19</li><li>lots of small additions</li></ul></li></ul>
<div class="row-fluid" id="com_82dc64e7baa231edd3896ca7a0d41393e426f123">
    <div class="span6"><div class="diff"><div class="insert">+The condition argument of ``@auth.requires(condition)`` can be a callable and unless the condition is simple, it better to pass a callable than a condition since this will be faster, as the condition will only be evaluated if needed. For example</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+@auth.requires(lambda: check_condition())</div><div class="insert">+def action():</div><div class="insert">+    ....</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+``@auth.requires`` also takes an optional argument ``requires_login`` which defaults to ``True``. If set to False, it does not require login before evaluating the condition as true/false. The condition can be a boolean value or a function evaluating to boolean.</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">-The condition argument of ``@auth.requires(condition)`` can be a callable. ``@auth.requires`` also takes an optional argument ``requires_login`` which defaults to ``True``. If set to False, it does not require login before evaluating the condition as true/false. The condition can be a boolean value or a function evaluating to boolean.</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/c0da1a23055a3368a1a4b20f5e90fcd6ef18f4f8">c0da1a2</a><ul><li>Date : 2012-09-06</li><li>fix more typos</li></ul></li></ul>
<div class="row-fluid" id="com_c0da1a23055a3368a1a4b20f5e90fcd6ef18f4f8">
    <div class="span6"><div class="diff"><div class=""> -------</div><div class="insert">The ``password`` field of the ``db.auth_user`` table defaults to a ``CRYPT`` validator, which needs and ``hmac_key``. On legacy web2py applications you may see an extra argument passed to the Auth con<span class="highlight">s</span>tructor: ``hmac_key = Auth.get_or_create_key()``. The latter is a function that read the hmac kay from a file &quot;private/auth.key&quot; within the application folder. If the file does not exist it creates a random ``hmac_key``. If multiple apps share the same auth database, make sure they also use the same ``hmac_key``. This is no loger necessary for new applications since passwords are salted with an individual random salt.</div><div class=""> -------</div><div class=""> </div><div class=""> By default, web2py uses email for login. If instead you want to log in using username set ``auth.define_tables(username=True)``</div><div class=""> </div><div class=""> If multiple apps share the same auth database you may want to disable migrations: ``auth.define_tables(migrate=False)``.</div><div class=""> </div><div class=""> To expose **Auth**, you also need the following function in a controller (for example in &quot;default.py&quot;):</div><div class=""> ``</div><div class=""> def user(): return dict(form=auth())</div><div class=""> ``:code</div><div class=""> </div><div class=""> -------</div><div class=""> The ``auth`` object and the ``user`` action are already defined in the</div><div class=""> scaffolding application.</div><div class=""> -------</div><div class=""> </div><div class=""> web2py also includes a sample view &quot;welcome/views/default/user.html&quot; to render this function properly that looks like this:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h2&gt;{{=T( request.args(0).replace(&#x27;_&#x27;,&#x27; &#x27;).capitalize() )}}&lt;/h2&gt;</div><div class=""> The call to</div><div class=""> auth.define_tables()</div><div class=""> ``:code</div><div class=""> </div><div class=""> defines all **Auth** tables that have not been defined already. This means that if you wish to do so, you can define your own ``auth_user`` table.</div><div class=""> </div><div class=""> There are a number of ways to customize auth. The simplest way is to add extra fields:</div><div class=""> </div><div class=""> ``</div><div class=""> ## after auth = Auth(db)</div><div class=""> auth.settings.extra_fields[&#x27;auth_user&#x27;]= [</div><div class="">   Field(&#x27;address&#x27;),</div><div class="">   Field(&#x27;city&#x27;),</div><div class="">   Field(&#x27;zip&#x27;),</div><div class="">   Field(&#x27;phone&#x27;)]</div><div class=""> ## before auth.define_tables(username=True)</div><div class=""> ``</div><div class=""> </div><div class=""> You can declare extra fields not just for table &quot;auth_user&quot; but also for other &quot;auth_&quot; tables.</div><div class=""> Using ``extra_fields`` is the recommended way as it will not break any internal mechanism.</div><div class=""> </div><div class="insert">Another way to do<span class="highlight"> this</span> (for experts!) consists of defining your auth tables you<span class="highlight">r</span>self. If a table is declared before ``auth.define_tables()`` it is used instead of the default one. Here is how to do it:</div><div class=""> </div><div class=""> ``</div><div class=""> ## after auth = Auth(db)</div><div class=""> db.define_table(</div><div class="">     auth.settings.table_user_name,</div><div class="">     Field(&#x27;first_name&#x27;, length=128, default=&#x27;&#x27;),</div><div class="">     Field(&#x27;last_name&#x27;, length=128, default=&#x27;&#x27;),</div><div class="">     Field(&#x27;email&#x27;, length=128, default=&#x27;&#x27;, unique=True), # required</div><div class="">     Field(&#x27;password&#x27;, &#x27;password&#x27;, length=512,            # required</div><div class="">           readable=False, label=&#x27;Password&#x27;),</div><div class="">     Field(&#x27;address&#x27;),</div><div class="">     Field(&#x27;city&#x27;),</div><div class="">     Field(&#x27;zip&#x27;),</div><div class="">     Field(&#x27;phone&#x27;),</div><div class="">     Field(&#x27;registration_key&#x27;, length=512,                # required</div><div class="">           writable=False, readable=False, default=&#x27;&#x27;),</div><div class="">     Field(&#x27;reset_password_key&#x27;, length=512,              # required</div><div class="">           writable=False, readable=False, default=&#x27;&#x27;),</div><div class="">     Field(&#x27;registration_id&#x27;, length=512,                 # required</div><div class="">           writable=False, readable=False, default=&#x27;&#x27;))</div><div class=""> auth.settings.login_form=LinkedInAccount(request,KEY,SECRET,RETURN_URL)</div><div class=""> ``:code</div><div class=""> </div><div class=""> ``LinkedInAccount`` requires the &quot;python-linkedin&quot; module installed separately.</div><div class=""> </div><div class=""> ##### X509</div><div class=""> </div><div class=""> You can also login by passing to the page an x509 certificate and your credential will be extracted from the certificate. This requires ``M2Crypto`` installed from</div><div class=""> </div><div class=""> ``</div><div class=""> http://chandlerproject.org/bin/view/Projects/MeTooCrypto</div><div class=""> ``</div><div class=""> </div><div class=""> Once you have M2Cryption installed you can do:</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.contrib.login_methods.x509_auth import X509Account</div><div class=""> auth.settings.actions_disabled=[&#x27;register&#x27;,&#x27;change_password&#x27;,&#x27;request_reset_password&#x27;]</div><div class=""> auth.settings.login_form = X509Account()</div><div class=""> ``:code</div><div class=""> </div><div class="insert">You can now authenticate into web2py passing your x509 certificate. How to do this is browser<span class="highlight">-</span>depend<span class="highlight">ent,</span> but probably you are more likely to use certificates for web services. In this case you can use for example ``cURL`` to try out your authentication:</div></div></div>
    <div class="span6"><div class="diff"><div class=""> -------</div><div class="delete">The ``password`` field of the ``db.auth_user`` table defaults to a ``CRYPT`` validator, which needs and ``hmac_key``. On legacy web2py applications you may see an extra argument passed to the Auth con<span class="highlight"></span>tructor: ``hmac_key = Auth.get_or_create_key()``. The latter is a function that read the hmac kay from a file &quot;private/auth.key&quot; within the application folder. If the file does not exist it creates a random ``hmac_key``. If multiple apps share the same auth database, make sure they also use the same ``hmac_key``. This is no loger necessary for new applications since passwords are salted with an individual random salt.</div><div class=""> -------</div><div class=""> </div><div class=""> By default, web2py uses email for login. If instead you want to log in using username set ``auth.define_tables(username=True)``</div><div class=""> </div><div class=""> If multiple apps share the same auth database you may want to disable migrations: ``auth.define_tables(migrate=False)``.</div><div class=""> </div><div class=""> To expose **Auth**, you also need the following function in a controller (for example in &quot;default.py&quot;):</div><div class=""> ``</div><div class=""> def user(): return dict(form=auth())</div><div class=""> ``:code</div><div class=""> </div><div class=""> -------</div><div class=""> The ``auth`` object and the ``user`` action are already defined in the</div><div class=""> scaffolding application.</div><div class=""> -------</div><div class=""> </div><div class=""> web2py also includes a sample view &quot;welcome/views/default/user.html&quot; to render this function properly that looks like this:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h2&gt;{{=T( request.args(0).replace(&#x27;_&#x27;,&#x27; &#x27;).capitalize() )}}&lt;/h2&gt;</div><div class=""> The call to</div><div class=""> auth.define_tables()</div><div class=""> ``:code</div><div class=""> </div><div class=""> defines all **Auth** tables that have not been defined already. This means that if you wish to do so, you can define your own ``auth_user`` table.</div><div class=""> </div><div class=""> There are a number of ways to customize auth. The simplest way is to add extra fields:</div><div class=""> </div><div class=""> ``</div><div class=""> ## after auth = Auth(db)</div><div class=""> auth.settings.extra_fields[&#x27;auth_user&#x27;]= [</div><div class="">   Field(&#x27;address&#x27;),</div><div class="">   Field(&#x27;city&#x27;),</div><div class="">   Field(&#x27;zip&#x27;),</div><div class="">   Field(&#x27;phone&#x27;)]</div><div class=""> ## before auth.define_tables(username=True)</div><div class=""> ``</div><div class=""> </div><div class=""> You can declare extra fields not just for table &quot;auth_user&quot; but also for other &quot;auth_&quot; tables.</div><div class=""> Using ``extra_fields`` is the recommended way as it will not break any internal mechanism.</div><div class=""> </div><div class="delete">Another way to do<span class="highlight"></span> (for experts!) consists of defining your auth tables you<span class="highlight"></span>self. If a table is declared before ``auth.define_tables()`` it is used instead of the default one. Here is how to do it:</div><div class=""> </div><div class=""> ``</div><div class=""> ## after auth = Auth(db)</div><div class=""> db.define_table(</div><div class="">     auth.settings.table_user_name,</div><div class="">     Field(&#x27;first_name&#x27;, length=128, default=&#x27;&#x27;),</div><div class="">     Field(&#x27;last_name&#x27;, length=128, default=&#x27;&#x27;),</div><div class="">     Field(&#x27;email&#x27;, length=128, default=&#x27;&#x27;, unique=True), # required</div><div class="">     Field(&#x27;password&#x27;, &#x27;password&#x27;, length=512,            # required</div><div class="">           readable=False, label=&#x27;Password&#x27;),</div><div class="">     Field(&#x27;address&#x27;),</div><div class="">     Field(&#x27;city&#x27;),</div><div class="">     Field(&#x27;zip&#x27;),</div><div class="">     Field(&#x27;phone&#x27;),</div><div class="">     Field(&#x27;registration_key&#x27;, length=512,                # required</div><div class="">           writable=False, readable=False, default=&#x27;&#x27;),</div><div class="">     Field(&#x27;reset_password_key&#x27;, length=512,              # required</div><div class="">           writable=False, readable=False, default=&#x27;&#x27;),</div><div class="">     Field(&#x27;registration_id&#x27;, length=512,                 # required</div><div class="">           writable=False, readable=False, default=&#x27;&#x27;))</div><div class=""> auth.settings.login_form=LinkedInAccount(request,KEY,SECRET,RETURN_URL)</div><div class=""> ``:code</div><div class=""> </div><div class=""> ``LinkedInAccount`` requires the &quot;python-linkedin&quot; module installed separately.</div><div class=""> </div><div class=""> ##### X509</div><div class=""> </div><div class=""> You can also login by passing to the page an x509 certificate and your credential will be extracted from the certificate. This requires ``M2Crypto`` installed from</div><div class=""> </div><div class=""> ``</div><div class=""> http://chandlerproject.org/bin/view/Projects/MeTooCrypto</div><div class=""> ``</div><div class=""> </div><div class=""> Once you have M2Cryption installed you can do:</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.contrib.login_methods.x509_auth import X509Account</div><div class=""> auth.settings.actions_disabled=[&#x27;register&#x27;,&#x27;change_password&#x27;,&#x27;request_reset_password&#x27;]</div><div class=""> auth.settings.login_form = X509Account()</div><div class=""> ``:code</div><div class=""> </div><div class="delete">You can now authenticate into web2py passing your x509 certificate. How to do this is browser<span class="highlight"> </span>depend<span class="highlight">ant</span> but probably you are more likely to use certificates for web services. In this case you can use for example ``cURL`` to try out your authentication:</div></div></div>
</div>
<hr />



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/ac4003f4349f9ee22c67309ceeb48de5539b0308">ac4003f</a><ul><li>Date : 2012-09-01</li><li>added lots of new features to book</li></ul></li></ul>
<div class="row-fluid" id="com_ac4003f4349f9ee22c67309ceeb48de5539b0308">
    <div class="span6"><div class="diff"><div class=""> To start using ``Auth``, you need at least this code in a model file, which is also provided with the web2py &quot;welcome&quot; application and assumes a ``db`` connection object:</div><div class=""> ``</div><div class=""> from gluon.tools import Auth</div><div class="insert">auth = Auth(db<span class="highlight"></span>)<span class="highlight"></span></div><div class=""> auth.define_tables()</div><div class=""> ``:code</div><div class=""> </div><div class=""> -------</div><div class="insert">The ``password`` field of the ``db.auth_user`` table defaults to a ``CRYPT`` validator, which needs and ``hmac_key``. <span class="highlight">On legacy web2py applications you may see an extra argument passed to the Auth contructor: ``hmac_key = </span>Auth.get_or_create_key()``<span class="highlight">. The latter</span> is a function that read the hmac kay from a file &quot;private/auth.key&quot; within the application folder. If the file does not exist it creates a random ``hmac_key``. If multiple apps share the same auth database, make sure they also use the same ``hmac_key``.<span class="highlight"> This is no loger necessary for new applications since passwords are salted with an individual random salt.</span></div><div class=""> -------</div><div class=""> </div><div class=""> By default, web2py uses email for login. If instead you want to log in using username set ``auth.define_tables(username=True)``</div><div class=""> </div><div class=""> If multiple apps share the same auth database you may want to disable migrations: ``auth.define_tables(migrate=False)``.</div><div class=""> </div><div class=""> To expose **Auth**, you also need the following function in a controller (for example in &quot;default.py&quot;):</div><div class=""> ``</div><div class=""> def user(): return dict(form=auth())</div><div class=""> ``:code</div><div class=""> </div><div class=""> -------</div><div class=""> The ``auth`` object and the ``user`` action are already defined in the</div><div class=""> scaffolding application.</div><div class=""> -------</div><div class=""> </div><div class=""> web2py also includes a sample view &quot;welcome/views/default/user.html&quot; to render this function properly that looks like this:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h2&gt;{{=T( request.args(0).replace(&#x27;_&#x27;,&#x27; &#x27;).capitalize() )}}&lt;/h2&gt;</div><div class=""> All of the methods above can be used in separate actions. For example:</div><div class=""> def mylogin(): return dict(form=auth.login())</div><div class=""> def myregister(): return dict(form=auth.register())</div><div class=""> def myprofile(): return dict(form=auth.profile())</div><div class=""> ...</div><div class=""> ``</div><div class=""> </div><div class=""> To restrict access to functions to only logged in visitors, decorate the function as in the following example</div><div class=""> ``</div><div class=""> @auth.requires_login()</div><div class=""> def hello():</div><div class="">     return dict(message=&#x27;hello %(first_name)s&#x27; % auth.user)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Any function can be decorated, not just exposed actions. Of course this is still only a very simple example of access control. More complex examples will be discussed later.</div><div class=""> ``auth.user``:inxx ``auth.user_id``:inxx</div><div class=""> </div><div class=""> -----</div><div class=""> ``auth.user`` contains a copy of the ``db.auth_user`` records for the current logged in user or ``None`` otherwise. There is also a ``auth.user_id`` which is the same as ``auth.user.id`` (i.e. the id of the current logger in user) or ``None``.</div><div class=""> -----</div><div class=""> </div><div class="insert">+``otherwise``:inxx</div><div class="insert">+</div><div class="insert">+The ``auth.requires_login()`` decorator as well as the other ``auth.requires_*`` decorators take an optional ``otherwise`` argument. It can be set to a string where to redirect the user if registration files or to a callable object. It is called if registration fails.</div><div class="insert">+</div><div class=""> #### Restrictions on registration</div></div></div>
    <div class="span6"><div class="diff"><div class=""> To start using ``Auth``, you need at least this code in a model file, which is also provided with the web2py &quot;welcome&quot; application and assumes a ``db`` connection object:</div><div class=""> ``</div><div class=""> from gluon.tools import Auth</div><div class="delete">auth = Auth(db<span class="highlight">, hmac_key=Auth.get_or_create_key(</span>)<span class="highlight">)</span></div><div class=""> auth.define_tables()</div><div class=""> ``:code</div><div class=""> </div><div class=""> -------</div><div class="delete">The ``password`` field of the ``db.auth_user`` table defaults to a ``CRYPT`` validator, which needs and ``hmac_key``. <span class="highlight">The ``</span>Auth.get_or_create_key()``<span class="highlight"></span> is a function that read the hmac kay from a file &quot;private/auth.key&quot; within the application folder. If the file does not exist it creates a random ``hmac_key``. If multiple apps share the same auth database, make sure they also use the same ``hmac_key``.<span class="highlight"></span></div><div class=""> -------</div><div class=""> </div><div class=""> By default, web2py uses email for login. If instead you want to log in using username set ``auth.define_tables(username=True)``</div><div class=""> </div><div class=""> If multiple apps share the same auth database you may want to disable migrations: ``auth.define_tables(migrate=False)``.</div><div class=""> </div><div class=""> To expose **Auth**, you also need the following function in a controller (for example in &quot;default.py&quot;):</div><div class=""> ``</div><div class=""> def user(): return dict(form=auth())</div><div class=""> ``:code</div><div class=""> </div><div class=""> -------</div><div class=""> The ``auth`` object and the ``user`` action are already defined in the</div><div class=""> scaffolding application.</div><div class=""> -------</div><div class=""> </div><div class=""> web2py also includes a sample view &quot;welcome/views/default/user.html&quot; to render this function properly that looks like this:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h2&gt;{{=T( request.args(0).replace(&#x27;_&#x27;,&#x27; &#x27;).capitalize() )}}&lt;/h2&gt;</div><div class=""> All of the methods above can be used in separate actions. For example:</div><div class=""> def mylogin(): return dict(form=auth.login())</div><div class=""> def myregister(): return dict(form=auth.register())</div><div class=""> def myprofile(): return dict(form=auth.profile())</div><div class=""> ...</div><div class=""> ``</div><div class=""> </div><div class=""> To restrict access to functions to only logged in visitors, decorate the function as in the following example</div><div class=""> ``</div><div class=""> @auth.requires_login()</div><div class=""> def hello():</div><div class="">     return dict(message=&#x27;hello %(first_name)s&#x27; % auth.user)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Any function can be decorated, not just exposed actions. Of course this is still only a very simple example of access control. More complex examples will be discussed later.</div><div class=""> ``auth.user``:inxx ``auth.user_id``:inxx</div><div class=""> </div><div class=""> -----</div><div class=""> ``auth.user`` contains a copy of the ``db.auth_user`` records for the current logged in user or ``None`` otherwise. There is also a ``auth.user_id`` which is the same as ``auth.user.id`` (i.e. the id of the current logger in user) or ``None``.</div><div class=""> -----</div><div class=""> </div><div class=""> #### Restrictions on registration</div></div></div>
</div>
<hr />





        
      </div>

      <div id="push"></div>
    </div>

    <div id="footer">
      <div class="container-fluid">
          <div class="copyright pull-left">Copyright &#169; 2013</div>
          <div id="poweredBy" class="pull-right">
              Powered by
              <a href="http://www.web2py.com/">web2py</a>
          </div>
      </div>
    </div>
<script src="static/js/bootstrap.min.js"></script>
<script src="static/js/web2py_bootstrap.js"></script>
</body>
</html>
