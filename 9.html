<!DOCTYPE html>
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7]><html class="ie ie6 ie-lte9 ie-lte8 ie-lte7 no-js" lang="en-us"> <![endif]-->
<!--[if IE 7]><html class="ie ie7 ie-lte9 ie-lte8 ie-lte7 no-js" lang="en-us"> <![endif]-->
<!--[if IE 8]><html class="ie ie8 ie-lte9 ie-lte8 no-js" lang="en-us"> <![endif]-->
<!--[if IE 9]><html class="ie9 ie-lte9 no-js" lang="en-us"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html class="no-js" lang="en-us"> <!--<![endif]-->
<head>
  <meta charset="utf-8" />
  <!-- www.phpied.com/conditional-comments-block-downloads/ -->
  <!-- Always force latest IE rendering engine
       (even in intranet) & Chrome Frame
       Remove this if you use the .htaccess -->
  <!--[if IE]>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <![endif]-->

  <title>Diffbook</title>

  <!-- http://dev.w3.org/html5/markup/meta.name.html -->
  <meta name="application-name" content="diffbook" />

  <!-- Speaking of Google, don't forget to set your site up:
       http://google.com/webmasters -->
  <meta name="google-site-verification" content="" />

  <!--  Mobile Viewport Fix
        j.mp/mobileviewport & davidbcalhoun.com/2010/viewport-metatag
        device-width: Occupy full width of the screen in its current orientation
        initial-scale = 1.0 retains dimensions instead of zooming out if page height > device height
        user-scalable = yes allows the user to zoom in -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="shortcut icon" href="static/images/favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" href="static/images/favicon.png">

  <!-- All JavaScript at the bottom, except for Modernizr which enables
       HTML5 elements & feature detects -->
  <script src="static/js/modernizr.custom.js"></script>

  <!-- include stylesheets -->
  

  <script type="text/javascript"><!--
    // These variables are used by the web2py_ajax_init function in web2py_ajax.js (which is loaded below).
    var w2p_ajax_confirm_message = "Are you sure you want to delete this object?";
    var w2p_ajax_date_format = "%Y-%m-%d";
    var w2p_ajax_datetime_format = "%Y-%m-%d %H:%M:%S";
    //--></script>
<meta name="keywords" content="web2py, python, framework" />

<meta name="description" content="a cool new app" />

<meta name="generator" content="Web2py Web Framework" />

<meta name="author" content="Your Name &lt;you@example.com&gt;" />
<script src="static/js/jquery.js" type="text/javascript"></script><link href="static/css/calendar.css" rel="stylesheet" type="text/css" /><script src="static/js/calendar.js" type="text/javascript"></script><script src="static/js/web2py.js" type="text/javascript"></script><link href="static/css/web2py.css" rel="stylesheet" type="text/css" /><link href="static/css/bootstrap.min.css" rel="stylesheet" type="text/css" /><link href="static/css/bootstrap-responsive.min.css" rel="stylesheet" type="text/css" /><link href="static/css/web2py_bootstrap.css" rel="stylesheet" type="text/css" />


  

  <!-- uncomment here to load jquery-ui
       <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/themes/base/jquery-ui.css" type="text/css" media="all" />
       <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js" type="text/javascript"></script>
       uncomment to load jquery-ui //-->
  <noscript><link href="static/css/web2py_bootstrap_nojs.css" rel="stylesheet" type="text/css" /></noscript>
  
  <style type="text/css">

      /* Sticky footer styles
      -------------------------------------------------- */

      html,
      body {
        height: 100%;
        /* The html and body elements cannot have any padding or margin. */
      }

      /* Wrapper for page content to push down footer */
      #wrap {
        min-height: 100%;
        height: auto !important;
        height: 100%;
        /* Negative indent footer by it's height */
        margin: 0 auto -60px;
      }

      /* Set the fixed height of the footer here */
      #push,
      #footer {
        height: 60px;
      }
      #footer {
        background-color: #f5f5f5;
      }

      /* Lastly, apply responsive CSS fixes as necessary */
      @media (max-width: 767px) {
        #footer {
          margin-left: -20px;
          margin-right: -20px;
          padding-left: 20px;
          padding-right: 20px;
        }
      }



      /* Custom page CSS
      -------------------------------------------------- */
      /* Not required for template or sticky footer method. */

      .container {
        width: auto;
        max-width: 680px;
      }
      .container .credit {
        margin: 20px 0;
      }

    </style>
</head>

<body>
  
  <body>


    <!-- Part 1: Wrap all page content here -->
    <div id="wrap">

      <!-- Begin page content -->
      <div class="container-fluid">
        <div class="page-header">
          	<h1>
              Diffbook
              <small>easy? diffbook</small>
            </h1>
        </div>
        
        


<div class="pagination">
  <ul>

      <li><a href="/diffbook/0.html">Chapter 0</a></li>

      <li><a href="/diffbook/1.html">Chapter 1</a></li>

      <li><a href="/diffbook/2.html">Chapter 2</a></li>

      <li><a href="/diffbook/3.html">Chapter 3</a></li>

      <li><a href="/diffbook/4.html">Chapter 4</a></li>

      <li><a href="/diffbook/5.html">Chapter 5</a></li>

      <li><a href="/diffbook/6.html">Chapter 6</a></li>

      <li><a href="/diffbook/7.html">Chapter 7</a></li>

      <li><a href="/diffbook/8.html">Chapter 8</a></li>

      <li><a href="/diffbook/9.html">Chapter 9</a></li>

      <li><a href="/diffbook/10.html">Chapter 10</a></li>

      <li><a href="/diffbook/11.html">Chapter 11</a></li>

      <li><a href="/diffbook/12.html">Chapter 12</a></li>

  </ul>
</div>

<div class="pagination">
  <ul>

      <li><a href="#com_83521b165c2d34b0f5904766b5cf9d6f9cf3660a">83521b1</a></li>

      <li><a href="#com_097d699dc16179206ccb7e4aee863d6523cd471c">097d699</a></li>

      <li><a href="#com_e234f6edf67361b3ba718ea10184ba8e7c2f773d">e234f6e</a></li>

      <li><a href="#com_c4e4f430a3fe8433d95790170768d74eaf109a49">c4e4f43</a></li>

      <li><a href="#com_f2fd41dd2a0d4bf68f5cd4f0989fb32bdc35eac5">f2fd41d</a></li>

      <li><a href="#com_7bce1473ce90f4e60f49d72bf1b61d32f430cb54">7bce147</a></li>

      <li><a href="#com_d864cef3b68d807ffe8dbc10c26845734fefb97b">d864cef</a></li>

      <li><a href="#com_e8219d5f3760c9d20419ee76e9eb514a4046ce1c">e8219d5</a></li>

      <li><a href="#com_329109afbb83ba34de23d586d44aedbaa27502e5">329109a</a></li>

      <li><a href="#com_56409943ff62a997f7c1326dc264c8f53e5b722e">5640994</a></li>

      <li><a href="#com_eaaa0e14bf17cdc4d0edd2ea9daa9af5f3484c09">eaaa0e1</a></li>

      <li><a href="#com_82dc64e7baa231edd3896ca7a0d41393e426f123">82dc64e</a></li>

      <li><a href="#com_76c0363755694c36971ffc9db176312fe5c14276">76c0363</a></li>

      <li><a href="#com_28816a98948c4a6577f73bdeb2b7424dc55d2582">28816a9</a></li>

      <li><a href="#com_ac4003f4349f9ee22c67309ceeb48de5539b0308">ac4003f</a></li>

      <li><a href="#com_c0da1a23055a3368a1a4b20f5e90fcd6ef18f4f8">c0da1a2</a></li>

      <li><a href="#com_f74941a5a1e849459f1fbea6dc9a2861e40e419a">f74941a</a></li>

  </ul>
</div>



<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/83521b165c2d34b0f5904766b5cf9d6f9cf3660a">83521b1</a><ul><li>Date : 2013-02-04</li><li>added pythonanywhere screenshots</li></ul></li></ul>
<div class="row-fluid" id="com_83521b165c2d34b0f5904766b5cf9d6f9cf3660a">
    <div class="span6"><div class="diff"><div class=""> ``</div><div class=""> from gluon.contrib.login_methods.rpx_account import RPXAccount</div><div class=""> auth.settings.actions_disabled=[&#x27;register&#x27;,&#x27;change_password&#x27;,&#x27;request_reset_password&#x27;]</div><div class=""> auth.settings.login_form = RPXAccount(request,</div><div class="">     api_key=&#x27;...&#x27;,</div><div class="">     domain=&#x27;...&#x27;,</div><div class="insert">    url = &quot;http://<span class="highlight">y</span>o<span class="highlight">ur-extern</span>al<span class="highlight">-addre</span>s<span class="highlight">s</span>/%s/default/user/login&quot; % request.application)</div><div class=""> ``:code</div><div class=""> </div><div class="insert">+The first line imports the new login method, the second line disables local registration, and the third line asks web2py to use the RPX login method. You must insert your own ``api_key`` provided by Janrain.com, the domain you choose upon registration and the external ``url`` of your login page. To obtain then login at janrain.com, then go to [Deployment][Application Settings]. On the right side there is the &quot;Application Info&quot;, The api_key  is called &quot;API Key (Secret)&quot;.</div><div class="insert">+</div><div class="insert">+The domain is the &quot;Application Domain&quot; without leading &quot;https://&quot; and without the trailing &quot;.rpxnow.com/&quot;</div><div class="insert">+For example: if you have registered a website as &quot;secure.mywebsite.org&quot;, Janrain turns it to the Application Domain &quot;https://secure-mywebsite.rpxnow.com&quot;. </div><div class="insert">+</div></div></div>
    <div class="span6"><div class="diff"><div class=""> ``</div><div class=""> from gluon.contrib.login_methods.rpx_account import RPXAccount</div><div class=""> auth.settings.actions_disabled=[&#x27;register&#x27;,&#x27;change_password&#x27;,&#x27;request_reset_password&#x27;]</div><div class=""> auth.settings.login_form = RPXAccount(request,</div><div class="">     api_key=&#x27;...&#x27;,</div><div class="">     domain=&#x27;...&#x27;,</div><div class="delete">    url = &quot;http://<span class="highlight">l</span>o<span class="highlight">c</span>al<span class="highlight">ho</span>s<span class="highlight">t:8000</span>/%s/default/user/login&quot; % request.application)</div><div class=""> ``:code</div><div class=""> </div><div class="delete">-The first line imports the new login method, the second line disables local registration, and the third line asks web2py to use the RPX login method. You must insert your own ``api_key`` provided by Janrain.com, the domain you choose upon registration and the external ``url`` of your login page.</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/097d699dc16179206ccb7e4aee863d6523cd471c">097d699</a><ul><li>Date : 2012-12-27</li><li>fixed typo, thanks Andrew</li></ul></li></ul>
<div class="row-fluid" id="com_097d699dc16179206ccb7e4aee863d6523cd471c">
    <div class="span6"><div class="diff"><div class="insert">+## Access Control</div><div class="insert">+``Auth``:inxx ``Access Control``:inxx ``RBAC``:inxx ``DAC``:inxx ``MAC``:inxx</div><div class="insert">+</div><div class="insert">+web2py includes a powerful and customizable Role Based Access Control mechanism (RBAC).</div><div class="insert">+</div><div class="insert">+Here is a definition from Wikipedia:</div><div class="insert">+</div><div class="insert">+&quot;Role-Based Access Control (RBAC) is an approach to restricting system access to authorized users. It is a newer alternative approach to mandatory access control (MAC) and discretionary access control (DAC). RBAC is sometimes referred to as role-based security.</div><div class="insert">+</div><div class="insert">+RBAC is a policy neutral and flexible access control technology sufficiently powerful to simulate DAC and MAC. Conversely, MAC can simulate RBAC if the role graph is restricted to a tree rather than a partially ordered set.</div><div class="insert">+</div><div class="insert">+Prior to the development of RBAC, MAC and DAC were considered to be the only known models for access control: if a model was not MAC, it was considered to be a DAC model, and vice versa. Research in the late 1990s demonstrated that RBAC falls in neither category.</div><div class="insert">+</div><div class="insert">+Within an organization, roles are created for various job functions. The permissions to perform certain operations are assigned to specific roles. Members of staff (or other system users) are assigned particular roles, and through those role assignments acquire the permissions to perform particular system functions. Unlike context-based access control (CBAC), RBAC does not look at the message context (such as a connection&#x27;s source).</div><div class="insert">+</div><div class="insert">+Since users are not assigned permissions directly, but only acquire them through their role (or roles), management of individual user rights becomes a matter of simply assigning appropriate roles to the user; this simplifies common operations, such as adding a user, or changing a user&#x27;s department.</div><div class="insert">+</div><div class="insert">+RBAC differs from access control lists (ACLs) used in traditional discretionary access control systems in that it assigns permissions to specific operations with meaning in the organization, rather than to low level data objects. For example, an access control list could be used to grant or deny write access to a particular system file, but it would not dictate how that file could be changed.&quot;</div><div class="insert">+</div><div class="insert">+The web2py class that implements RBAC is called **Auth**.</div><div class="insert">+</div><div class="insert">+**Auth** needs (and defines) the following tables:</div><div class="insert">+- ``auth_user`` stores users&#x27; name, email address, password, and status (registration pending, accepted, blocked)</div><div class="insert">+- ``auth_group`` stores groups or roles for users in a many-to-many structure. By default, each user is in its own group, but a user can be in multiple groups, and each group can contain multiple users. A group is identified by a role and a description.</div><div class="insert">+- ``auth_membership`` links users and groups in a many-to-many structure.</div><div class="insert">+- ``auth_permission`` links groups and permissions. A permission is identified by a name and, optionally, a table and a record. For example, members of a certain group can have &quot;update&quot; permissions on a specific record of a specific table.</div><div class="insert">+- ``auth_event`` logs changes in the other tables and successful access via CRUD to objects controlled by the RBAC.</div><div class="insert">+</div><div class="insert">+In principle, there is no restriction on the names of the roles and the names of the permissions; the developer can create them to fix the roles and permissions in the organization. Once they have been created, web2py provides an API to check if a user is logged in, if a user is a member of a given group, and/or if the user is a member of any group that has a given required permission.</div><div class="insert">+</div><div class="insert">+web2py also provides decorators to restrict access to any function based on login, membership and permissions.</div><div class="insert">+</div><div class="insert">+web2py also understands some specific permissions, i.e., those that have a name that correspond to the CRUD methods (create, read, update, delete) and can enforce them automatically without the need to use decorators.</div><div class="insert">+</div><div class="insert">+In this chapter, we are going to discuss different parts of RBAC one by one.</div><div class="insert">+</div><div class="insert">+### Authentication</div><div class="insert">+</div><div class="insert">+In order to use RBAC, users need to be identified. This means that they need to register (or be registered) and log in.</div><div class="insert">+</div><div class="insert">+**Auth** provides multiple login methods. The default one consists of identifying users based on the local ``auth_user`` table.</div><div class="insert">+Alternatively, it can log in users against third-party authentication systems and single sign on providers such as Google, PAM, LDAP, Facebook, LinkedIn, Dropbox, OpenID, OAuth, etc..</div><div class="insert">+</div><div class="insert">+To start using ``Auth``, you need at least this code in a model file, which is also provided with the web2py &quot;welcome&quot; application and assumes a ``db`` connection object:</div><div class="insert">+``</div><div class="insert">+from gluon.tools import Auth</div><div class="insert">+auth = Auth(db)</div><div class="insert">+auth.define_tables()</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Auth has an optional ``secure=True`` argument, which will force authenticated pages to go over HTTPS. ``https``:inxx</div><div class="insert">+</div><div class="insert">+-------</div><div class="insert">+The ``password`` field of the ``db.auth_user`` table defaults to a ``CRYPT`` validator, which needs and ``hmac_key``. On legacy web2py applications you may see an extra argument passed to the Auth constructor: ``hmac_key = Auth.get_or_create_key()``. The latter is a function that read the hmac kay from a file &quot;private/auth.key&quot; within the application folder. If the file does not exist it creates a random ``hmac_key``. If multiple apps share the same auth database, make sure they also use the same ``hmac_key``. This is no loger necessary for new applications since passwords are salted with an individual random salt.</div><div class="insert">+-------</div><div class="insert">+</div><div class="insert">+By default, web2py uses email for login. If instead you want to log in using username set ``auth.define_tables(username=True)``</div><div class="insert">+</div><div class="insert">+If multiple apps share the same auth database you may want to disable migrations: ``auth.define_tables(migrate=False)``.</div><div class="insert">+</div><div class="insert">+To expose **Auth**, you also need the following function in a controller (for example in &quot;default.py&quot;):</div><div class="insert">+``</div><div class="insert">+def user(): return dict(form=auth())</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+-------</div><div class="insert">+The ``auth`` object and the ``user`` action are already defined in the</div><div class="insert">+scaffolding application.</div><div class="insert">+-------</div><div class="insert">+</div><div class="insert">+web2py also includes a sample view &quot;welcome/views/default/user.html&quot; to render this function properly that looks like this:</div><div class="insert">+``</div><div class="insert">+{{extend &#x27;layout.html&#x27;}}</div><div class="insert">+&lt;h2&gt;{{=T( request.args(0).replace(&#x27;_&#x27;,&#x27; &#x27;).capitalize() )}}&lt;/h2&gt;</div><div class="insert">+&lt;div id=&quot;web2py_user_form&quot;&gt;</div><div class="insert">+  {{=form}}</div><div class="insert">+  {{if request.args(0)==&#x27;login&#x27;:}}</div><div class="insert">+    {{if not &#x27;register&#x27; in auth.settings.actions_disabled:}}</div><div class="insert">+      &lt;br/&gt;&lt;a href=&quot;{{=URL(args=&#x27;register&#x27;)}}&quot;&gt;register&lt;/a&gt;</div><div class="insert">+    {{pass}}</div><div class="insert">+    {{if not &#x27;request_reset_password&#x27; in auth.settings.actions_disabled:}}</div><div class="insert">+      &lt;br/&gt;</div><div class="insert">+      &lt;a href=&quot;{{=URL(args=&#x27;request_reset_password&#x27;)}}&quot;&gt;lost password&lt;/a&gt;</div><div class="insert">+    {{pass}}</div><div class="insert">+  {{pass}}</div><div class="insert">+&lt;/div&gt;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Notice that this function simply displays a ``form`` and therefore it can be customized using normal custom form syntax. The only caveat is that the form displayed by ``form=auth()`` depends on ``request.args(0)``; therefore, if you replace the default ``auth()`` login form with a custom login form, you may need an ``if`` statement like this in the view:</div><div class="insert">+``</div><div class="insert">+{{if request.args(0)==&#x27;login&#x27;:}}...custom login form...{{pass}}</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+``auth.impersonate``:inxx ``auth.is_impersonating``:inxx</div><div class="insert">+</div><div class="insert">+The controller above exposes multiple actions:</div><div class="insert">+``</div><div class="insert">+http://.../[app]/default/user/register</div><div class="insert">+http://.../[app]/default/user/login</div><div class="insert">+http://.../[app]/default/user/logout</div><div class="insert">+http://.../[app]/default/user/profile</div><div class="insert">+http://.../[app]/default/user/change_password</div><div class="insert">+http://.../[app]/default/user/verify_email</div><div class="insert">+http://.../[app]/default/user/retrieve_username</div><div class="insert">+http://.../[app]/default/user/request_reset_password</div><div class="insert">+http://.../[app]/default/user/reset_password</div><div class="insert">+http://.../[app]/default/user/impersonate</div><div class="insert">+http://.../[app]/default/user/groups</div><div class="insert">+http://.../[app]/default/user/not_authorized</div><div class="insert">+``:code</div><div class="insert">+- **register** allows users to register. It is integrated with CAPTCHA, although this is disabled by default. This is also integrated with a client-side entropy calculator defined in &quot;web2py.js&quot;. The calculator indictates the strenght of the new password. You can use the ``IS_STRONG`` validator to prevent web2py from accepting weak passwords.</div><div class="insert">+- **login** allows users who are registered to log in (if the registration is verified or does not require verification, if it has been approved or does not require approval, and if it has not been blocked).</div><div class="insert">+- **logout** does what you would expect but also, as the other methods, logs the event and can be used to trigger some event.</div><div class="insert">+- **profile** allows users to edit their profile, i.e. the content of the ``auth_user`` table. Notice that this table does not have a fixed structure and can be customized.</div><div class="insert">+- **change_password** allows users to change their password in a fail-safe way.</div><div class="insert">+- **verify_email**. If email verification is turned on, then visitors, upon registration, receive an email with a link to verify their email information. The link points to this action.</div><div class="insert">+- **retrieve_username**. By default, **Auth** uses email and password for login, but it can, optionally, use username instead of email. In this latter case, if a user forgets his/her username, the ``retrieve_username`` method allows the user to type the email address and retrieve the username by email.</div><div class="insert">+- **request_reset_password**. Allows users who forgot their password to request a new password. They will get a confirmation email pointing to **reset_password**.</div><div class="insert">+- **impersonate** allows a user to &quot;impersonate&quot; another user. This is important for debugging and for support purposes. ``request.args[0]`` is the id of the user to be impersonated. This is only allowed if the logged in user ``has_permission(&#x27;impersonate&#x27;, db.auth_user, user_id)``. You can use ``auth.is_impersonating()`` to check is the current user is impersonating somebody else.</div><div class="insert">+- **groups** lists the groups of which the current logged in user is a member.</div><div class="insert">+- **not_authorized** displays an error message when the visitor tried to do something that he/she is not authorized to do</div><div class="insert">+- **navbar** is a helper that generates a bar with login/register/etc. links.</div><div class="insert">+</div><div class="insert">+Logout, profile, change_password, impersonate, and groups require login.</div><div class="insert">+</div><div class="insert">+By default they are all exposed, but it is possible to restrict access to only some of these actions.</div><div class="insert">+</div><div class="insert">+All of the methods above can be extended or replaced by subclassing **Auth**.</div><div class="insert">+</div><div class="insert">+All of the methods above can be used in separate actions. For example:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+def mylogin(): return dict(form=auth.login())</div><div class="insert">+def myregister(): return dict(form=auth.register())</div><div class="insert">+def myprofile(): return dict(form=auth.profile())</div><div class="insert">+...</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+To restrict access to functions to only logged in visitors, decorate the function as in the following example</div><div class="insert">+``</div><div class="insert">+@auth.requires_login()</div><div class="insert">+def hello():</div><div class="insert">+    return dict(message=&#x27;hello %(first_name)s&#x27; % auth.user)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Any function can be decorated, not just exposed actions. Of course this is still only a very simple example of access control. More complex examples will be discussed later.</div><div class="insert">+``auth.user``:inxx ``auth.user_id``:inxx ``auth.user_groups``.</div><div class="insert">+</div><div class="insert">+-----</div><div class="insert">+``auth.user`` contains a copy of the ``db.auth_user`` records for the current logged in user or ``None`` otherwise. There is also a ``auth.user_id`` which is the same as ``auth.user.id`` (i.e. the id of the current logger in user) or ``None``. Similarly, ``auth.user_groups`` contains a dictionary where each key is the id of a group of with the current logged in user is member of, the value is the corresponding group role.</div><div class="insert">+-----</div><div class="insert">+</div><div class="insert">+``otherwise``:inxx</div><div class="insert">+</div><div class="insert">+The ``auth.requires_login()`` decorator as well as the other ``auth.requires_*`` decorators take an optional ``otherwise`` argument. It can be set to a string where to redirect the user if registration files or to a callable object. It is called if registration fails.</div><div class="insert">+</div><div class="insert">+#### Restrictions on registration</div><div class="insert">+</div><div class="insert">+If you want to allow visitors to register but not to log in until registration has been approved by the administrator:</div><div class="insert">+``</div><div class="insert">+auth.settings.registration_requires_approval = True</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+You can approve a registration via the appadmin interface. Look into the table ``auth_user``. Pending registrations have a ``registration_key`` field set to &quot;pending&quot;. A registration is approved when this field is set to blank.</div><div class="insert">+</div><div class="insert">+Via the appadmin interface, you can also block a user from logging in. Locate the user in the table ``auth_user`` and set the ``registration_key`` to &quot;blocked&quot;. &quot;blocked&quot; users are not allowed to log in. Notice that this will prevent a visitor from logging in but it will not force a visitor who is already logged in to log out. The word &quot;disabled&quot; may be used instead of &quot;blocked&quot; if preferred, with exactly the same behavior.</div><div class="insert">+</div><div class="insert">+You can also block access to the &quot;register&quot; page completely with this statement:</div><div class="insert">+``</div><div class="insert">+auth.settings.actions_disabled.append(&#x27;register&#x27;)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+If you want to allow people to register and automatically log them in after registration but still want to send an email for verification so that they cannot login again after logout, unless they completed the instructions in the email, you can accomplish it as follows:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.settings.registration_requires_approval = True</div><div class="insert">+auth.settings.login_after_registration = True</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+</div><div class="insert">+Other methods of **Auth** can be restricted in the same way.</div><div class="insert">+</div><div class="insert">+#### Integration with OpenID, Facebook, etc.</div><div class="insert">+``Janrain``:inxx ``OpenID``:inxx ``Facebook``:inxx ``LinkedIn``:inxx ``Google``:inxx ``MySpace``:inxx ``Flickr``:inxx</div><div class="insert">+</div><div class="insert">+You can use the web2py Role Base Access Control and authenticate with other services like OpenID, Facebook, LinkedIn, Google, Dropbox, MySpace, Flickr, etc.</div><div class="insert">+The easiest way is to use Janrain Engage (formerly RPX) (Janrain.com).</div><div class="insert">+</div><div class="insert">+Dropbox is discussed as a special case in Chapter 14 since it allows more than just login, it also provides storage services for the logged in users.</div><div class="insert">+</div><div class="insert">+Janrain Engage is a service that provides middleware authentication. You can register with Janrain.com, register a domain (the name of your app) and set of URLs you will be using, and they will provide you with an API key.</div><div class="insert">+</div><div class="insert">+Now edit the model of your web2py application and place the following lines somewhere after the definition of the ``auth`` object :</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+from gluon.contrib.login_methods.rpx_account import RPXAccount</div><div class="insert">+auth.settings.actions_disabled=[&#x27;register&#x27;,&#x27;change_password&#x27;,&#x27;request_reset_password&#x27;]</div><div class="insert">+auth.settings.login_form = RPXAccount(request,</div><div class="insert">+    api_key=&#x27;...&#x27;,</div><div class="insert">+    domain=&#x27;...&#x27;,</div><div class="insert">+    url = &quot;http://localhost:8000/%s/default/user/login&quot; % request.application)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+The first line imports the new login method, the second line disables local registration, and the third line asks web2py to use the RPX login method. You must insert your own ``api_key`` provided by Janrain.com, the domain you choose upon registration and the external ``url`` of your login page.</div><div class="insert">+</div><div class="insert">+[[image @///image/en6900.png center 300px]]</div><div class="insert">+</div><div class="insert">+When a new user logins for the first time, web2py creates a new ``db.auth_user`` record associated to the user. It will use the ``registration_id`` field to store a unique id for the user. Most authentication methods will also provide a username, email, first_name and last_name but that is not guaranteed. Which fields are provided depends on the login method selected by the user. If the same user logs in twice using different authentication mechanisms (for example once with OpenID and once with Facebook), Janrain may not recognize his/her as the same user and issue different ``registration_id``.</div><div class="insert">+</div><div class="insert">+You can customize the mapping between the data provided by Janrain and the data stored in ``db.auth_user``. Here is an example for Facebook:</div><div class="insert">+``</div><div class="insert">+auth.settings.login_form.mappings.Facebook = lambda profile:\</div><div class="insert">+            dict(registration_id = profile[&quot;identifier&quot;],</div><div class="insert">+                 username = profile[&quot;preferredUsername&quot;],</div><div class="insert">+                 email = profile[&quot;email&quot;],</div><div class="insert">+                 first_name = profile[&quot;name&quot;][&quot;givenName&quot;],</div><div class="insert">+                 last_name = profile[&quot;name&quot;][&quot;familyName&quot;])</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+The keys in the dictionary are fields in ``db.auth_user`` and the values are data entries in the profile object provided by Janrain. Look at the online Janrain documentation for details on the latter.</div><div class="insert">+</div><div class="insert">+Janrain will also keep statistics about your users&#x27; login.</div><div class="insert">+</div><div class="insert">+This login form is fully integrated with web2py Role Based Access Control and you can still create groups, make users members of groups, assign permissions, block users, etc.</div><div class="insert">+</div><div class="insert">+-----</div><div class="insert">+Janrain&#x27;s free Basic service allows up to 2500 unique registered users to sign in annually. Accommodating more users requires an upgrade to one of their paid service tiers.</div><div class="insert">+</div><div class="insert">+If you prefer not to use Janrain and want to use a different login method (LDAP, PAM, Google, OpenID, OAuth/Facebook, LinkedIn, etc.) you can do so. The API to do so is described later in the chapter.</div><div class="insert">+-----</div><div class="insert">+</div><div class="insert">+#### CAPTCHA and reCAPTCHA</div><div class="insert">+</div><div class="insert">+``CAPTCHA``:inxx ``reCAPTCHA``:inxx ``PIL``:inxx</div><div class="insert">+To prevent spammers and bots registering on your site, you may require a registration CAPTCHA. web2py supports reCAPTCHA``recaptcha``:cite  out of the box. This is because reCAPTCHA is very well designed, free, accessible (it can read the words to the visitors), easy to set up, and does not require installing any third-party libraries.</div><div class="insert">+</div><div class="insert">+This is what you need to do to use reCAPTCHA:</div><div class="insert">+- Register with reCAPTCHA``recaptcha``:cite  and obtain a (PUBLIC_KEY, PRIVATE_KEY) couple for your account. These are just two strings.</div><div class="insert">+- Append the following code to your model after the ``auth`` object is defined:</div><div class="insert">+``</div><div class="insert">+from gluon.tools import Recaptcha</div><div class="insert">+auth.settings.captcha = Recaptcha(request,</div><div class="insert">+    &#x27;PUBLIC_KEY&#x27;, &#x27;PRIVATE_KEY&#x27;)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+reCAPTCHA may not work if you access the web site as &#x27;localhost&#x27; or &#x27;127.0.0.1&#x27;, because it is registered to work with publicly visible web sites only.</div><div class="insert">+</div><div class="insert">+The ``Recaptcha`` constructor takes some optional arguments:</div><div class="insert">+``</div><div class="insert">+Recaptcha(..., use_ssl=True, error_message=&#x27;invalid&#x27;, label=&#x27;Verify:&#x27;, options=&#x27;&#x27;)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Notice that ``use_ssl=False`` by default.</div><div class="insert">+</div><div class="insert">+``options`` may be a configuration string, e.g. ``options=&quot;theme:&#x27;white&#x27;, lang:&#x27;fr&#x27;&quot;``</div><div class="insert">+</div><div class="insert">+More details: [[reCAPTCHA http://www.google.com/recaptcha]]``recaptchagoogle``:cite  and [[customizing http://code.google.com/apis/recaptcha/docs/customization.html]]  .</div><div class="insert">+</div><div class="insert">+If you do not want to use reCAPTCHA, look into the definition of the ``Recaptcha`` class in &quot;gluon/tools.py&quot;, since it is easy to use other CAPTCHA systems.</div><div class="insert">+</div><div class="insert">+Notice that ``Recaptcha`` is just a helper that extends ``DIV``. It generates a dummy field that validates using the ``reCaptcha`` service and, therefore, it can be used in any form, including used defined FORMs:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+form = FORM(INPUT(...),Recaptcha(...),INPUT(_type=&#x27;submit&#x27;))</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+You can use it in all types of SQLFORM by injection:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+form = SQLFORM(...) or SQLFORM.factory(...)</div><div class="insert">+form.element(&#x27;table&#x27;).insert(-1,TR(&#x27;&#x27;,Recaptcha(...),&#x27;&#x27;))</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+#### Customizing ``Auth``</div><div class="insert">+</div><div class="insert">+The call to</div><div class="insert">+``</div><div class="insert">+auth.define_tables()</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+defines all **Auth** tables that have not been defined already. This means that if you wish to do so, you can define your own ``auth_user`` table.</div><div class="insert">+</div><div class="insert">+There are a number of ways to customize auth. The simplest way is to add extra fields:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+## after auth = Auth(db)</div><div class="insert">+auth.settings.extra_fields[&#x27;auth_user&#x27;]= [</div><div class="insert">+  Field(&#x27;address&#x27;),</div><div class="insert">+  Field(&#x27;city&#x27;),</div><div class="insert">+  Field(&#x27;zip&#x27;),</div><div class="insert">+  Field(&#x27;phone&#x27;)]</div><div class="insert">+## before auth.define_tables(username=True)</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+You can declare extra fields not just for table &quot;auth_user&quot; but also for other &quot;auth_&quot; tables.</div><div class="insert">+Using ``extra_fields`` is the recommended way as it will not break any internal mechanism.</div><div class="insert">+</div><div class="insert">+Another way to do this, although not really recommended, consists of defining your auth tables yourself. If a table is declared before ``auth.define_tables()`` it is used instead of the default one. Here is how to do it:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+## after auth = Auth(db)</div><div class="insert">+db.define_table(</div><div class="insert">+    auth.settings.table_user_name,</div><div class="insert">+    Field(&#x27;first_name&#x27;, length=128, default=&#x27;&#x27;),</div><div class="insert">+    Field(&#x27;last_name&#x27;, length=128, default=&#x27;&#x27;),</div><div class="insert">+    Field(&#x27;email&#x27;, length=128, default=&#x27;&#x27;, unique=True), # required</div><div class="insert">+    Field(&#x27;password&#x27;, &#x27;password&#x27;, length=512,            # required</div><div class="insert">+          readable=False, label=&#x27;Password&#x27;),</div><div class="insert">+    Field(&#x27;address&#x27;),</div><div class="insert">+    Field(&#x27;city&#x27;),</div><div class="insert">+    Field(&#x27;zip&#x27;),</div><div class="insert">+    Field(&#x27;phone&#x27;),</div><div class="insert">+    Field(&#x27;registration_key&#x27;, length=512,                # required</div><div class="insert">+          writable=False, readable=False, default=&#x27;&#x27;),</div><div class="insert">+    Field(&#x27;reset_password_key&#x27;, length=512,              # required</div><div class="insert">+          writable=False, readable=False, default=&#x27;&#x27;),</div><div class="insert">+    Field(&#x27;registration_id&#x27;, length=512,                 # required</div><div class="insert">+          writable=False, readable=False, default=&#x27;&#x27;))</div><div class="insert">+</div><div class="insert">+## do not forget validators</div><div class="insert">+custom_auth_table = db[auth.settings.table_user_name] # get the custom_auth_table</div><div class="insert">+custom_auth_table.first_name.requires = \</div><div class="insert">+  IS_NOT_EMPTY(error_message=auth.messages.is_empty)</div><div class="insert">+custom_auth_table.last_name.requires = \</div><div class="insert">+  IS_NOT_EMPTY(error_message=auth.messages.is_empty)</div><div class="insert">+custom_auth_table.password.requires = [IS_STRONG(), CRYPT()]</div><div class="insert">+custom_auth_table.email.requires = [</div><div class="insert">+  IS_EMAIL(error_message=auth.messages.invalid_email),</div><div class="insert">+  IS_NOT_IN_DB(db, custom_auth_table.email)]</div><div class="insert">+</div><div class="insert">+auth.settings.table_user = custom_auth_table # tell auth to use custom_auth_table</div><div class="insert">+</div><div class="insert">+## before auth.define_tables()</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+You can add any field you wish, and you can change validators but you cannot remove</div><div class="insert">+the fields marked as &quot;required&quot; in this example.</div><div class="insert">+</div><div class="insert">+It is important to make &quot;password&quot;, &quot;registration_key&quot;, &quot;reset_password_key&quot; and &quot;registration_id&quot; fields ``readable=False`` and ``writable=False``, since a visitor must not be allowed to tamper with them.</div><div class="insert">+</div><div class="insert">+If you add a field called &quot;username&quot;, it will be used in place of &quot;email&quot; for login. If you do, you will need to add a validator as well:</div><div class="insert">+``</div><div class="insert">+auth_table.username.requires = IS_NOT_IN_DB(db, auth_table.username)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+#### Renaming ``Auth`` tables</div><div class="insert">+</div><div class="insert">+The actual names of the ``Auth`` tables are stored in</div><div class="insert">+``</div><div class="insert">+auth.settings.table_user_name = &#x27;auth_user&#x27;</div><div class="insert">+auth.settings.table_group_name = &#x27;auth_group&#x27;</div><div class="insert">+auth.settings.table_membership_name = &#x27;auth_membership&#x27;</div><div class="insert">+auth.settings.table_permission_name = &#x27;auth_permission&#x27;</div><div class="insert">+auth.settings.table_event_name = &#x27;auth_event&#x27;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+The names of the table can be changed by reassigning the above variables after the ``auth`` object is defined and before the Auth tables are defined. For example:</div><div class="insert">+``</div><div class="insert">+auth = Auth(db)</div><div class="insert">+auth.settings.table_user_name = &#x27;person&#x27;</div><div class="insert">+#...</div><div class="insert">+auth.define_tables()</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+The actual tables can also be referenced, independently of their actual names, by</div><div class="insert">+``</div><div class="insert">+auth.settings.table_user</div><div class="insert">+auth.settings.table_group</div><div class="insert">+auth.settings.table_membership</div><div class="insert">+auth.settings.table_permission</div><div class="insert">+auth.settings.table_event</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+#### Other login methods and login forms</div><div class="insert">+``LDAP``:inxx ``PAM``:inxx</div><div class="insert">+</div><div class="insert">+Auth provides multiple login methods and hooks to create new login methods. Each supported login method corresponds to a file in the folder</div><div class="insert">+``</div><div class="insert">+gluon/contrib/login_methods/</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Refer to the documentation in the files themselves for each login method, but here are some examples.</div><div class="insert">+</div><div class="insert">+First of all, we need to make a distinction between two types of alternate login methods:</div><div class="insert">+- login methods that use a web2py login form (although the credentials are verified outside web2py). An example is LDAP.</div><div class="insert">+- login methods that require an external single-sign-on form (an example is Google and Facebook).</div><div class="insert">+</div><div class="insert">+In the latter case, web2py never gets the login credentials, only a login token issued by the service provider. The token is stored in ``db.auth_user.registration_id``.</div><div class="insert">+</div><div class="insert">+Let&#x27;s consider examples of the first case:</div><div class="insert">+</div><div class="insert">+##### Basic</div><div class="insert">+</div><div class="insert">+Let&#x27;s say you have an authentication service, for example at the url</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+https://basic.example.com</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+that accepts basic access authentication. That means the server accepts HTTP requests with a header of the form:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+GET /index.html HTTP/1.0</div><div class="insert">+Host: basic.example.com</div><div class="insert">+Authorization: Basic QWxhZGRpbjpvcGVuIHNlc2FtZQ==</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+where the latter string is the base64 encoding of the string username:password. The service responds 200 OK if the user is authorized and 400, 401, 402, 403 or 404 otherwise.</div><div class="insert">+</div><div class="insert">+You want to enter username and password using the standard ``Auth`` login form and verify the credentials against such a service. All you need to do is add the following code to your application</div><div class="insert">+``</div><div class="insert">+from gluon.contrib.login_methods.basic_auth import basic_auth</div><div class="insert">+auth.settings.login_methods.append(</div><div class="insert">+    basic_auth(&#x27;https://basic.example.com&#x27;))</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Notice that ``auth.settings.login_methods`` is a list of authentication methods that are executed sequentially.</div><div class="insert">+By default it is set to</div><div class="insert">+``</div><div class="insert">+auth.settings.login_methods = [auth]</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+When an alternate method is appended, for example ``basic_auth``, **Auth** first tries to log in the visitor based on the content of ``auth_user``, and when this fails, it tries the next method in the list. If a method succeeds in logging in the visitor, and if ``auth.settings.login_methods[0]==auth``, ``Auth`` takes the following actions:</div><div class="insert">+- if the user does not exist in ``auth_user``, a new user is created and the username/email and passwords are stored.</div><div class="insert">+- if the user does exist in ``auth_user`` but the new accepted password does not match the old stored password, the old password is replaced with the new one (notice that passwords are always stored hashed unless specified otherwise).</div><div class="insert">+</div><div class="insert">+If you do not wish to store the new password in ``auth_user``, then it is sufficient to change the order of login methods, or remove ``auth`` from the list. For example:</div><div class="insert">+``</div><div class="insert">+from gluon.contrib.login_methods.basic_auth import basic_auth</div><div class="insert">+auth.settings.login_methods = \</div><div class="insert">+    [basic_auth(&#x27;https://basic.example.com&#x27;)]</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+The same applies for any other login method described here.</div><div class="insert">+</div><div class="insert">+##### SMTP and Gmail</div><div class="insert">+``SMTP``:inxx ``Gmail``:inxx</div><div class="insert">+</div><div class="insert">+You can verify login credentials using a remote SMTP server, for example Gmail; i.e., you log the user in if the email and password they provide are valid credentials to access the Gmail SMTP server (``smtp.gmail.com:587``). All that is needed is the following code:</div><div class="insert">+``</div><div class="insert">+from gluon.contrib.login_methods.email_auth import email_auth</div><div class="insert">+auth.settings.login_methods.append(</div><div class="insert">+    email_auth(&quot;smtp.gmail.com:587&quot;, &quot;@gmail.com&quot;))</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+The first argument of ``email_auth`` is the address:port of the SMTP server. The second argument is the email domain.</div><div class="insert">+</div><div class="insert">+This works with any SMTP server that requires TLS authentication.``TLS``:inxx</div><div class="insert">+</div><div class="insert">+##### PAM</div><div class="insert">+``PAM``:inxx</div><div class="insert">+</div><div class="insert">+Authentication using Pluggable Authentication Modules (PAM) works as in the previous cases. It allows web2py to authenticate users using the operating system accounts:</div><div class="insert">+``</div><div class="insert">+from gluon.contrib.login_methods.pam_auth import pam_auth</div><div class="insert">+auth.settings.login_methods.append(pam_auth())</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+##### LDAP</div><div class="insert">+``LDAP``:inxx</div><div class="insert">+</div><div class="insert">+Authentication using LDAP works very much as in the previous cases.</div><div class="insert">+</div><div class="insert">+To use LDAP login with MS Active Directory:``Active Directory``:inxx</div><div class="insert">+``</div><div class="insert">+from gluon.contrib.login_methods.ldap_auth import ldap_auth</div><div class="insert">+auth.settings.login_methods.append(ldap_auth(mode=&#x27;ad&#x27;,</div><div class="insert">+   server=&#x27;my.domain.controller&#x27;,</div><div class="insert">+   base_dn=&#x27;ou=Users,dc=domain,dc=com&#x27;))</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+To use LDAP login with Lotus Notes and Domino:``Lotus Notes``:inxx ``Domino``:inxx</div><div class="insert">+``</div><div class="insert">+auth.settings.login_methods.append(ldap_auth(mode=&#x27;domino&#x27;,</div><div class="insert">+   server=&#x27;my.domino.server&#x27;))</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+To use LDAP login with OpenLDAP (with UID):``OpenLDAP``:inxx</div><div class="insert">+``</div><div class="insert">+auth.settings.login_methods.append(ldap_auth(server=&#x27;my.ldap.server&#x27;,</div><div class="insert">+   base_dn=&#x27;ou=Users,dc=domain,dc=com&#x27;))</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+To use LDAP login with OpenLDAP (with CN):</div><div class="insert">+``</div><div class="insert">+auth.settings.login_methods.append(ldap_auth(mode=&#x27;cn&#x27;,</div><div class="insert">+   server=&#x27;my.ldap.server&#x27;, base_dn=&#x27;ou=Users,dc=domain,dc=com&#x27;))</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+##### Google App Engine</div><div class="insert">+``GAE login``:inxx</div><div class="insert">+</div><div class="insert">+Authentication using Google when running on Google App Engine requires skipping the web2py login form, being redirected to the Google login page, and back upon success. Because the behavior is different than in the previous examples, the API is a little different.</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+from gluon.contrib.login_methods.gae_google_login import GaeGoogleAccount</div><div class="insert">+auth.settings.login_form = GaeGoogleAccount()</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+##### OpenID</div><div class="insert">+``OpenID``:inxx</div><div class="insert">+</div><div class="insert">+We have previously discussed integration with Janrain (which has OpenID support) and that is the easiest way to use OpenID. Yet sometimes you do not want to rely on a third party service and you want to access the OpenID provider directly from the consumer (your app).</div><div class="insert">+</div><div class="insert">+Here is an example:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+from gluon.contrib.login_methods.openid_auth import OpenIDAuth</div><div class="insert">+auth.settings.login_form = OpenIDAuth(auth)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+``OpenIDAuth`` requires the &#x27;&#x27;python-openid&#x27;&#x27; module to be installed separately. Under the hood, this login method defines the following table:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+db.define_table(&#x27;alt_logins&#x27;,</div><div class="insert">+    Field(&#x27;username&#x27;, length=512, default=&#x27;&#x27;),</div><div class="insert">+    Field(&#x27;type&#x27;, length =128, default=&#x27;openid&#x27;, readable=False),</div><div class="insert">+    Field(&#x27;user&#x27;, self.table_user, readable=False))</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+which stores the openid usernames for each user. If you want to display the openids for the current logged in user:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+{{=auth.settings.login_form.list_user_openids()}}</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+##### OAuth2.0 and Facebook</div><div class="insert">+``OAuth``:inxx ``Facebook``:inxx</div><div class="insert">+</div><div class="insert">+We have previously discussed integration with Janrain (which has Facebook support), yet sometimes you do not want to rely on a third party service and you want to access a OAuth2.0 provider directly; for example, Facebook. Here is how:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+from gluon.contrib.login_methods.oauth20_account import OAuthAccount</div><div class="insert">+auth.settings.login_form=OAuthAccount(YOUR_CLIENT_ID,YOUR_CLIENT_SECRET)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Things get a little more complex if you want to use Facebook OAuth2.0 to login into a specific Facebook app to access its API, instead of your own app. Here is an example for accessing the Facebook Graph API.</div><div class="insert">+</div><div class="insert">+First of all you must install the [[Facebook Python SDK https://github.com/facebook/python-sdk]].</div><div class="insert">+</div><div class="insert">+Second, you need the following code in your model:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+## import required modules</div><div class="insert">+from facebook import GraphAPI</div><div class="insert">+from gluon.contrib.login_methods.oauth20_account import OAuthAccount</div><div class="insert">+## extend the OAUthAccount class</div><div class="insert">+class FaceBookAccount(OAuthAccount):</div><div class="insert">+    &quot;&quot;&quot;OAuth impl for Facebook&quot;&quot;&quot;</div><div class="insert">+    AUTH_URL=&quot;https://graph.facebook.com/oauth/authorize&quot;</div><div class="insert">+    TOKEN_URL=&quot;https://graph.facebook.com/oauth/access_token&quot;</div><div class="insert">+    def __init__(self, g):</div><div class="insert">+        OAuthAccount.__init__(self, g,</div><div class="insert">+                              YOUR_CLIENT_ID,</div><div class="insert">+                              YOUR_CLIENT_SECRET,</div><div class="insert">+                              self.AUTH_URL,</div><div class="insert">+                              self.TOKEN_URL)</div><div class="insert">+        self.graph = None</div><div class="insert">+    # override function that fetches user info</div><div class="insert">+    def get_user(self):</div><div class="insert">+        &quot;Returns the user using the Graph API&quot;</div><div class="insert">+        if not self.accessToken():</div><div class="insert">+            return None</div><div class="insert">+        if not self.graph:</div><div class="insert">+            self.graph = GraphAPI((self.accessToken()))</div><div class="insert">+        try:</div><div class="insert">+            user = self.graph.get_object(&quot;me&quot;)</div><div class="insert">+            return dict(first_name = user[&#x27;first_name&#x27;],</div><div class="insert">+                        last_name = user[&#x27;last_name&#x27;],</div><div class="insert">+                        username = user[&#x27;id&#x27;])</div><div class="insert">+        except GraphAPIError:</div><div class="insert">+            self.session.token = None</div><div class="insert">+            self.graph = None</div><div class="insert">+            return None</div><div class="insert">+## use the above class to build a new login form</div><div class="insert">+auth.settings.login_form=FaceBookAccount()</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+##### LinkedIn</div><div class="insert">+``LinkedIn``:inxx</div><div class="insert">+</div><div class="insert">+We have previously discussed integration with Janrain (which has LinkedIn support) and that is the easiest way to use OAuth. Yet sometime you do not want to rely on a third party service or you may want to access LinkedIn directly to get more information than Janrain provides.</div><div class="insert">+</div><div class="insert">+Here is an example:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+from gluon.contrib.login_methods.linkedin_account import LinkedInAccount</div><div class="insert">+auth.settings.login_form=LinkedInAccount(request,KEY,SECRET,RETURN_URL)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+``LinkedInAccount`` requires the &quot;python-linkedin&quot; module installed separately.</div><div class="insert">+</div><div class="insert">+##### X509</div><div class="insert">+</div><div class="insert">+You can also login by passing to the page an x509 certificate and your credential will be extracted from the certificate. This requires ``M2Crypto`` installed from</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+http://chandlerproject.org/bin/view/Projects/MeTooCrypto</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+Once you have M2Cryption installed you can do:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+from gluon.contrib.login_methods.x509_auth import X509Account</div><div class="insert">+auth.settings.actions_disabled=[&#x27;register&#x27;,&#x27;change_password&#x27;,&#x27;request_reset_password&#x27;]</div><div class="insert">+auth.settings.login_form = X509Account()</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+You can now authenticate into web2py passing your x509 certificate. How to do this is browser-dependent, but probably you are more likely to use certificates for web services. In this case you can use for example ``cURL`` to try out your authentication:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+curl -d &quot;firstName=John&amp;lastName=Smith&quot; -G -v --key private.key \</div><div class="insert">+     --cert  server.crt https://example/app/default/user/profile</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+This works out of the box with Rocket (the web2py built-in web server) but you may need some extra configuration work on the web server side if you are using a different web server. In particular you need to tell your web server where the certificates are located on local host and that it needs to verify certificates coming from the clients. How to do it is web server dependent and therefore omitted here.</div><div class="insert">+</div><div class="insert">+##### Multiple login forms</div><div class="insert">+</div><div class="insert">+Some login methods modify the login_form, some do not. When they do that, they may not be able to coexist. Yet some coexist by providing multiple login forms in the same page. web2py provides a way to do it. Here is an example mixing normal login (auth) and RPX login (janrain.com):</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+from gluon.contrib.login_methods.extended_login_form import ExtendedLoginForm</div><div class="insert">+other_form = RPXAccount(request, api_key=&#x27;...&#x27;, domain=&#x27;...&#x27;, url=&#x27;...&#x27;)</div><div class="insert">+auth.settings.login_form = ExtendedLoginForm(auth, other_form, signals=[&#x27;token&#x27;])</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+If signals are set and a parameter in request matches any signals,</div><div class="insert">+it will return the call of ``other_form.login_form`` instead.</div><div class="insert">+``other_form`` can handle some particular situations, for example,</div><div class="insert">+multiple steps of OpenID login inside ``other_form.login_form``.</div><div class="insert">+</div><div class="insert">+Otherwise it will render the normal login form together with the ``other_form``.</div><div class="insert">+</div><div class="insert">+#### Record versioning</div><div class="insert">+</div><div class="insert">+You can use Auth to enable full record versioning:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+db.enable_record_versioning(db,</div><div class="insert">+    archive_db=None,</div><div class="insert">+    archive_names=&#x27;%(tablename)s_archive&#x27;,</div><div class="insert">+    current_record=&#x27;current_record&#x27;):</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+This tells web2py to create an archive table for each of the tables in ``db`` and store a copy of each record when modified. The old copy is stored. The new copy is not.</div><div class="insert">+</div><div class="insert">+The last three parameters are optional:</div><div class="insert">+</div><div class="insert">+- ``archive_db`` allows to specify another database where the archive tables are to be stored. Setting it to ``None`` is the same as setting it to ``db``.</div><div class="insert">+- ``archive_names`` provides a pattern for naming each archive table.</div><div class="insert">+- ``current_record`` specified the name of the reference field to be used in the archive table to refer to the original, unmodified, record. Notice that ``archive_db!=db`` then the reference field is just an integer field since cross database references are not possible.</div><div class="insert">+</div><div class="insert">+</div><div class="insert">+Only tables with ``modified_by`` and ``modified_on`` fields (as created</div><div class="insert">+for example by auth.signature) will be archived.</div><div class="insert">+</div><div class="insert">+When you ``enable_record_versioning``, if records have an</div><div class="insert">+``is_active`` field (also created by auth.signature),</div><div class="insert">+records will never be deleted but they will be marked with ``is_active=False``.</div><div class="insert">+In fact, ``enable_record_versioning`` adds a ``common_filter`` to</div><div class="insert">+every versioned table that filters out records with ``is_active=False`` so they essentially become invisible.</div><div class="insert">+</div><div class="insert">+If you ``enable_record_versioning``, you should not use</div><div class="insert">+``auth.archive`` or ``crud.archive`` else you will end up with duplicate records.</div><div class="insert">+Those functions do explicitly what ``enable_record_versioning`` does automatically and</div><div class="insert">+they will be deprecated.</div><div class="insert">+</div><div class="insert">+</div><div class="insert">+#### ``Mail`` and ``Auth``</div><div class="insert">+</div><div class="insert">+One can define a mailer with</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+from gluon.tools import Mail</div><div class="insert">+mail = Mail()</div><div class="insert">+mail.settings.server = &#x27;smtp.example.com:25&#x27;</div><div class="insert">+mail.settings.sender = &#x27;you@example.com&#x27;</div><div class="insert">+mail.settings.login = &#x27;username:password&#x27;</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+or simply use the mailer provided by ``auth``:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+mail = auth.settings.mailer</div><div class="insert">+mail.settings.server = &#x27;smtp.example.com:25&#x27;</div><div class="insert">+mail.settings.sender = &#x27;you@example.com&#x27;</div><div class="insert">+mail.settings.login = &#x27;username:password&#x27;</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+You need to replace the mail.settings with the proper parameters for your SMTP server. Set ``mail.settings.login = None`` if the SMTP server does not require authentication.</div><div class="insert">+</div><div class="insert">+You can read more about web2py API for emails and email configuration in Chapter 8. Here we limit the discussion to the interaction between ``Mail`` and ``Auth``.</div><div class="insert">+</div><div class="insert">+In ``Auth``, by default, email verification is disabled.</div><div class="insert">+To enable email, append the following lines in the model where ``auth`` is defined:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.settings.registration_requires_verification = True</div><div class="insert">+auth.settings.registration_requires_approval = False</div><div class="insert">+auth.settings.reset_password_requires_verification = True</div><div class="insert">+auth.messages.verify_email = &#x27;Click on the link http://&#x27; + \</div><div class="insert">+    request.env.http_host + \</div><div class="insert">+    URL(r=request,c=&#x27;default&#x27;,f=&#x27;user&#x27;,args=[&#x27;verify_email&#x27;]) + \</div><div class="insert">+    &#x27;/%(key)s to verify your email&#x27;</div><div class="insert">+auth.messages.reset_password = &#x27;Click on the link http://&#x27; + \</div><div class="insert">+    request.env.http_host + \</div><div class="insert">+    URL(r=request,c=&#x27;default&#x27;,f=&#x27;user&#x27;,args=[&#x27;reset_password&#x27;]) + \</div><div class="insert">+    &#x27;/%(key)s to reset your password&#x27;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+In the two ``auth.messages`` above, you may need to replace the URL portion of the string with the proper complete URL of the action. This is necessary because web2py may be installed behind a proxy, and it cannot determine its own public URLs with absolute certainty. The above examples (which are the default values) should, however, work in most cases.</div><div class="insert">+</div><div class="insert">+### Authorization</div><div class="insert">+</div><div class="insert">+Once a new user is registered, a new group is created to contain the user. The role of the new user is conventionally &quot;user_[id]&quot; where [id] is the id of the newly created user. The creation of the group can be disabled with</div><div class="insert">+``</div><div class="insert">+auth.settings.create_user_groups = None</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+although we do not suggest doing so. Notice that ``create_user_groups`` is not a boolean (althought it can be ``False``) but it defaults to:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.settings.create_user_groups=&quot;user_%(id)s&quot;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+It store a template for the name of the group created for user ``id``.</div><div class="insert">+</div><div class="insert">+Users have membership in groups. Each group is identified by a name/role. Groups have permissions. Users have permissions because of the groups they belong to. By default each user is made member of their own group.</div><div class="insert">+</div><div class="insert">+You can also also do</div><div class="insert">+``</div><div class="insert">+auth.settings.everybody_group_id = 5</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+to make any new user automatically member of group number 5. Here 5 is used as an example and we assume the group was created already.</div><div class="insert">+</div><div class="insert">+You can create groups, give membership and permissions via **appadmin**</div><div class="insert">+or programmatically using the following methods:</div><div class="insert">+``</div><div class="insert">+auth.add_group(&#x27;role&#x27;, &#x27;description&#x27;)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+returns the id of the newly created group.</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.del_group(group_id)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+deletes the group with ``group_id``.</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.del_group(auth.id_group(&#x27;user_7&#x27;))</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+deletes the group with role &quot;user_7&quot;, i.e., the group uniquely associated to user number 7.</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.user_group(user_id)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+returns the id of the group uniquely associated to the user identified by ``user_id``.</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.add_membership(group_id, user_id)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+gives ``user_id`` membership of the group ``group_id``.</div><div class="insert">+If the ``user_id`` is not specified, then web2py assumes the current logged-in user.</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.del_membership(group_id, user_id)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+revokes ``user_id`` membership of the group ``group_id``.</div><div class="insert">+If the ``user_id`` is not specified, then web2py assumes the current logged-in user.</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.has_membership(group_id, user_id, role)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+checks whether ``user_id`` has membership of the group ``group_id`` or the group with the specified role. Only ``group_id`` or ``role`` should be passed to the function, not both. If the ``user_id`` is not specified, then web2py assumes the current logged-in user.</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.add_permission(group_id, &#x27;name&#x27;, &#x27;object&#x27;, record_id)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+gives permission &quot;name&quot; (user defined) on the object &quot;object&quot; (also user defined) to members of the group ``group_id``. If &quot;object&quot; is a tablename then the permission can refer to the entire table by setting ``record_id`` to a value of zero, or the permission can refer to a specific record by specifying a ``record_id`` value greater than zero. When giving permissions on tables, it is common to use a permission name in the set (&#x27;create&#x27;, &#x27;read&#x27;, &#x27;update&#x27;, &#x27;delete&#x27;, &#x27;select&#x27;) since these permissions are understood and can be enforced by the CRUD APIs.</div><div class="insert">+</div><div class="insert">+If ``group_id`` is zero, web2py uses the group uniquely associated to the current logged-in user.</div><div class="insert">+</div><div class="insert">+You can also use ``auth.id_group(role=&quot;...&quot;)`` to get the id of a group given its name. ``id_group``:inxx</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.del_permission(group_id, &#x27;name&#x27;, &#x27;object&#x27;, record_id)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+revokes the permission.</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.has_permission(&#x27;name&#x27;, &#x27;object&#x27;, record_id, user_id)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+checks whether the user identified by ``user_id`` has membership in a group with the requested permission.</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+rows = db(auth.accessible_query(&#x27;read&#x27;, db.mytable, user_id))\</div><div class="insert">+    .select(db.mytable.ALL)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+returns all rows of table &quot;mytable&quot; that user ``user_id`` has &quot;read&quot; permission on.</div><div class="insert">+If the ``user_id`` is not specified, then web2py assumes the current logged-in user.</div><div class="insert">+The ``accessible_query(...)`` can be combined with other queries to make more complex ones.</div><div class="insert">+``accessible_query(...)`` is the only **Auth** method to require a JOIN, so it does not work on the Google App Engine.</div><div class="insert">+</div><div class="insert">+Assuming the following definitions:</div><div class="insert">+``</div><div class="insert">+&gt;&gt;&gt; from gluon.tools import Auth</div><div class="insert">+&gt;&gt;&gt; auth = Auth(db)</div><div class="insert">+&gt;&gt;&gt; auth.define_tables()</div><div class="insert">+&gt;&gt;&gt; secrets = db.define_table(&#x27;document&#x27;, Field(&#x27;body&#x27;))</div><div class="insert">+&gt;&gt;&gt; james_bond = db.auth_user.insert(first_name=&#x27;James&#x27;,</div><div class="insert">+                                     last_name=&#x27;Bond&#x27;)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Here is an example:</div><div class="insert">+``</div><div class="insert">+&gt;&gt;&gt; doc_id = db.document.insert(body = &#x27;top secret&#x27;)</div><div class="insert">+&gt;&gt;&gt; agents = auth.add_group(role = &#x27;Secret Agent&#x27;)</div><div class="insert">+&gt;&gt;&gt; auth.add_membership(agents, james_bond)</div><div class="insert">+&gt;&gt;&gt; auth.add_permission(agents, &#x27;read&#x27;, secrets)</div><div class="insert">+&gt;&gt;&gt; print auth.has_permission(&#x27;read&#x27;, secrets, doc_id, james_bond)</div><div class="insert">+True</div><div class="insert">+&gt;&gt;&gt; print auth.has_permission(&#x27;update&#x27;, secrets, doc_id, james_bond)</div><div class="insert">+False</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+#### Decorators</div><div class="insert">+</div><div class="insert">+The most common way to check permission is not by explicit calls to the above methods, but by decorating functions so that permissions are checked relative to the logged-in visitor. Here are some examples:</div><div class="insert">+``</div><div class="insert">+def function_one():</div><div class="insert">+    return &#x27;this is a public function&#x27;</div><div class="insert">+</div><div class="insert">+@auth.requires_login()</div><div class="insert">+def function_two():</div><div class="insert">+    return &#x27;this requires login&#x27;</div><div class="insert">+</div><div class="insert">+@auth.requires_membership(&#x27;agents&#x27;)</div><div class="insert">+def function_three():</div><div class="insert">+    return &#x27;you are a secret agent&#x27;</div><div class="insert">+</div><div class="insert">+@auth.requires_permission(&#x27;read&#x27;, secrets)</div><div class="insert">+def function_four():</div><div class="insert">+    return &#x27;you can read secret documents&#x27;</div><div class="insert">+</div><div class="insert">+@auth.requires_permission(&#x27;delete&#x27;, &#x27;any file&#x27;)</div><div class="insert">+def function_five():</div><div class="insert">+    import os</div><div class="insert">+    for file in os.listdir(&#x27;./&#x27;):</div><div class="insert">+        os.unlink(file)</div><div class="insert">+    return &#x27;all files deleted&#x27;</div><div class="insert">+</div><div class="insert">+@auth.requires(auth.user_id==1 or request.client==&#x27;127.0.0.1&#x27;, requires_login=True)</div><div class="insert">+def function_six():</div><div class="insert">+    return &#x27;you can read secret documents&#x27;</div><div class="insert">+</div><div class="insert">+@auth.requires_permission(&#x27;add&#x27;, &#x27;number&#x27;)</div><div class="insert">+def add(a, b):</div><div class="insert">+    return a + b</div><div class="insert">+</div><div class="insert">+def function_seven():</div><div class="insert">+    return add(3, 4)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+The condition argument of ``@auth.requires(condition)`` can be a callable and unless the condition is simple, it better to pass a callable than a condition since this will be faster, as the condition will only be evaluated if needed. For example</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+@auth.requires(lambda: check_condition())</div><div class="insert">+def action():</div><div class="insert">+    ....</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+``@auth.requires`` also takes an optional argument ``requires_login`` which defaults to ``True``. If set to False, it does not require login before evaluating the condition as true/false. The condition can be a boolean value or a function evaluating to boolean.</div><div class="insert">+</div><div class="insert">+Note that access to all functions apart from the first one is restricted based on permissions that the visitor may or may not have.</div><div class="insert">+</div><div class="insert">+If the visitor is not logged in, then the permission cannot be checked; the visitor is redirected to the login page and then back to the page that requires permissions.</div><div class="insert">+</div><div class="insert">+#### Combining requirements</div><div class="insert">+</div><div class="insert">+Occasionally, it is necessary to combine requirements. This can be done via a generic ``requires`` decorator which takes a single argument, a true or false condition. For example, to give access to agents, but only on Tuesday:</div><div class="insert">+``</div><div class="insert">+@auth.requires(auth.has_membership(group_id=agents) \</div><div class="insert">+               and request.now.weekday()==1)</div><div class="insert">+def function_seven():</div><div class="insert">+    return &#x27;Hello agent, it must be Tuesday!&#x27;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+or equivalently:</div><div class="insert">+``</div><div class="insert">+@auth.requires(auth.has_membership(role=&#x27;Secret Agent&#x27;) \</div><div class="insert">+               and request.now.weekday()==1)</div><div class="insert">+def function_seven():</div><div class="insert">+    return &#x27;Hello agent, it must be Tuesday!&#x27;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+#### Authorization and CRUD</div><div class="insert">+</div><div class="insert">+Using decorators and/or explicit checks provides one way to implement access control.</div><div class="insert">+</div><div class="insert">+Another way to implement access control is to always use CRUD (as opposed to ``SQLFORM``) to access the database and to ask CRUD to enforce access control on database tables and records. This is done by linking ``Auth`` and CRUD with the following statement:</div><div class="insert">+``</div><div class="insert">+crud.settings.auth = auth</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+This will prevent the visitor from accessing any of the CRUD functions unless the visitor is logged in and has explicit access. For example, to allow a visitor to post comments, but only update their own comments (assuming crud, auth and db.comment are defined):</div><div class="insert">+``</div><div class="insert">+def give_create_permission(form):</div><div class="insert">+    group_id = auth.id_group(&#x27;user_%s&#x27; % auth.user.id)</div><div class="insert">+    auth.add_permission(group_id, &#x27;read&#x27;, db.comment)</div><div class="insert">+    auth.add_permission(group_id, &#x27;create&#x27;, db.comment)</div><div class="insert">+    auth.add_permission(group_id, &#x27;select&#x27;, db.comment)</div><div class="insert">+</div><div class="insert">+def give_update_permission(form):</div><div class="insert">+    comment_id = form.vars.id</div><div class="insert">+    group_id = auth.id_group(&#x27;user_%s&#x27; % auth.user.id)</div><div class="insert">+    auth.add_permission(group_id, &#x27;update&#x27;, db.comment, comment_id)</div><div class="insert">+    auth.add_permission(group_id, &#x27;delete&#x27;, db.comment, comment_id)</div><div class="insert">+</div><div class="insert">+auth.settings.register_onaccept = give_create_permission</div><div class="insert">+crud.settings.auth = auth</div><div class="insert">+</div><div class="insert">+def post_comment():</div><div class="insert">+   form = crud.create(db.comment, onaccept=give_update_permission)</div><div class="insert">+   comments = db(db.comment).select()</div><div class="insert">+   return dict(form=form, comments=comments)</div><div class="insert">+</div><div class="insert">+def update_comment():</div><div class="insert">+   form = crud.update(db.comment, request.args(0))</div><div class="insert">+   return dict(form=form)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+You can also select specific records (those you have &#x27;read&#x27; access to):</div><div class="insert">+``</div><div class="insert">+def post_comment():</div><div class="insert">+   form = crud.create(db.comment, onaccept=give_update_permission)</div><div class="insert">+   query = auth.accessible_query(&#x27;read&#x27;, db.comment, auth.user.id)</div><div class="insert">+   comments = db(query).select(db.comment.ALL)</div><div class="insert">+   return dict(form=form, comments=comments)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+The permissions names enforced by :</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+crud.settings.auth = auth</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+are &quot;read&quot;, &quot;create&quot;, &quot;update&quot;, &quot;delete&quot;, &quot;select&quot;, &quot;impersonate&quot;.</div><div class="insert">+</div><div class="insert">+#### Authorization and downloads</div><div class="insert">+</div><div class="insert">+The use of decorators and the use of ``crud.settings.auth`` do not enforce authorization on files downloaded by the usual download function</div><div class="insert">+``</div><div class="insert">+def download(): return response.download(request, db)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+If one wishes to do so, one must declare explicitly which &quot;upload&quot; fields contain files that need access control upon download.</div><div class="insert">+For example:</div><div class="insert">+``</div><div class="insert">+db.define_table(&#x27;dog&#x27;,</div><div class="insert">+   Field(&#x27;small_image&#x27;, &#x27;upload&#x27;),</div><div class="insert">+   Field(&#x27;large_image&#x27;, &#x27;upload&#x27;))</div><div class="insert">+</div><div class="insert">+db.dog.large_image.authorization = lambda record: \</div><div class="insert">+   auth.is_logged_in() and \</div><div class="insert">+   auth.has_permission(&#x27;read&#x27;, db.dog, record.id, auth.user.id)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+The attribute ``authorization`` of upload field can be None (the default) or a function that decides whether the user is logged in and has permission to &#x27;read&#x27; the current record. In this example, there is no restriction on downloading images linked by the &quot;small_image&quot; field, but we require access control on images linked by the &quot;large_image&quot; field.</div><div class="insert">+</div><div class="insert">+</div><div class="insert">+#### Access Control and Basic Authentication</div><div class="insert">+</div><div class="insert">+Occasionally, it may be necessary to expose actions that have decorators that require access control as services; i.e., to call them from a program or script and still be able to use authentication to check for authorization.</div><div class="insert">+</div><div class="insert">+**Auth** enables login via basic authentication:</div><div class="insert">+``</div><div class="insert">+auth.settings.allow_basic_login = True</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+With this set, an action like</div><div class="insert">+``</div><div class="insert">+@auth.requires_login()</div><div class="insert">+def give_me_time():</div><div class="insert">+    import time</div><div class="insert">+    return time.ctime()</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+can be called, for example, from a shell command:</div><div class="insert">+``</div><div class="insert">+wget --user=[username] --password=[password]</div><div class="insert">+    http://.../[app]/[controller]/give_me_time</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+It is also possible to log in by calling ``auth.basic()`` rather than using an ``@auth`` decorator:</div><div class="insert">+``</div><div class="insert">+def give_me_time():</div><div class="insert">+    import time</div><div class="insert">+    auth.basic()</div><div class="insert">+    if auth.user:</div><div class="insert">+        return time.ctime()</div><div class="insert">+    else:</div><div class="insert">+        return &#x27;Not authorized&#x27;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Basic login is often the only option for services (described in the next chapter), but it is disabled by default.</div><div class="insert">+</div><div class="insert">+#### Manual Authentication</div><div class="insert">+</div><div class="insert">+Some times you want to implement your own logic and do &quot;manual&quot; user login.</div><div class="insert">+This can also be done by calling the function:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+user = auth.login_bare(username,password)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+``login_bare`` returns user if the user exists and the password is valid, else it returns False. ``username`` is the email if the &quot;auth_user&quot; table does not have a &quot;username&quot; field.</div><div class="insert">+</div><div class="insert">+#### Settings and messages</div><div class="insert">+</div><div class="insert">+Here is a list of all parameters that can be customized for **Auth**</div><div class="insert">+</div><div class="insert">+The following must point to a ``gluon.tools.Mail`` object to allow ``auth`` to send emails:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.settings.mailer = None</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+The following must be the name of the controller that defined the ``user`` action:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.settings.controller = &#x27;default&#x27;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+The following is a very important setting:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.settings.hmac_key = None</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+It must be set to something like &quot;sha512:a-pass-phrase&quot; and it will be passed to the CRYPT validator for the &quot;password&quot; field of the ``auth_user`` table. It will be the algorithm and a-pass-phrase used to hash the passwords.</div><div class="insert">+</div><div class="insert">+By default, auth also requires a minimum password length of 4. This can be changed:</div><div class="insert">+``</div><div class="insert">+auth.settings.password_min_length = 4</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+To disabled an action append its name to this list:</div><div class="insert">+``</div><div class="insert">+auth.settings.actions_disabled = []</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+For example:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.settings.actions_disabled.append(&#x27;register&#x27;)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+will disable registration.</div><div class="insert">+</div><div class="insert">+If you want to receive an email to verify registration set this to ``True``:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.settings.registration_requires_verification = False</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+To automatically login people after registration, even if they have not completed the email verification process, set the following to ``True``:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.settings.login_after_registration = False</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+If new registrants must wait for approval before being able to login set this to ``True``:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.settings.registration_requires_approval = False</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Approval consists of setting ``registration_key==&#x27;&#x27;`` via appadmin or programmatically.</div><div class="insert">+</div><div class="insert">+If you do not want a new group for each new user set the following to ``False``:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.settings.create_user_groups = True</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+The following settings determine alternative login methods and login forms, as discussed previously:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.settings.login_methods = [auth]</div><div class="insert">+auth.settings.login_form = auth</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Do you want to allow basic login?</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.settings.allows_basic_login = False</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+</div><div class="insert">+The following is the URL of the ``login`` action:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.settings.login_url = URL(&#x27;user&#x27;, args=&#x27;login&#x27;)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+If the user tried to access the register page but is already logged in, he will be redirected to this URL:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.settings.logged_url = URL(&#x27;user&#x27;, args=&#x27;profile&#x27;)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+This must point to the URL of the download action, in case the profile contains images:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.settings.download_url = URL(&#x27;download&#x27;)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+These must point to the URL you want to redirect your users to after the various possible ``auth`` actions (in case there is no referrer):</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.settings.login_next = URL(&#x27;index&#x27;)</div><div class="insert">+auth.settings.logout_next = URL(&#x27;index&#x27;)</div><div class="insert">+auth.settings.profile_next = URL(&#x27;index&#x27;)</div><div class="insert">+auth.settings.register_next = URL(&#x27;user&#x27;, args=&#x27;login&#x27;)</div><div class="insert">+auth.settings.retrieve_username_next = URL(&#x27;index&#x27;)</div><div class="insert">+auth.settings.retrieve_password_next = URL(&#x27;index&#x27;)</div><div class="insert">+auth.settings.change_password_next = URL(&#x27;index&#x27;)</div><div class="insert">+auth.settings.request_reset_password_next = URL(&#x27;user&#x27;, args=&#x27;login&#x27;)</div><div class="insert">+auth.settings.reset_password_next = URL(&#x27;user&#x27;, args=&#x27;login&#x27;)</div><div class="insert">+auth.settings.verify_email_next = URL(&#x27;user&#x27;, args=&#x27;login&#x27;)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+If the visitor is not logger in, and calls a function that requires authentication,</div><div class="insert">+the user is redirected to ``auth.settings.login_url`` which defaults to ``URL(&#x27;default&#x27;,&#x27;user/login&#x27;)``.</div><div class="insert">+One can replace this behavior by redefining:</div><div class="insert">+``on_failed_authentication``:inxx</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.settings.on_failed_authentication = lambda url: redirect(url)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+This is the function called for the redirection. The argument ``url``` passed to this function is the url for the login page.</div><div class="insert">+</div><div class="insert">+If the visitor does not have permission to access a given function, the visitor is redirect to the URL defined by</div><div class="insert">+``on_failed_authorization``:inxx</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.settings.on_failed_authorization = \</div><div class="insert">+    URL(&#x27;user&#x27;,args=&#x27;on_failed_authorization&#x27;)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+You can change this variable and redirect the user elsewhere.</div><div class="insert">+</div><div class="insert">+Often ``on_failed_authorization`` is a URL but it can be a function that returns the URL and it will be called on failed authorization.</div><div class="insert">+</div><div class="insert">+These are lists of callbacks that should be executed after form validation for each of the corresponding action before any database IO:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.settings.login_onvalidation = []</div><div class="insert">+auth.settings.register_onvalidation = []</div><div class="insert">+auth.settings.profile_onvalidation = []</div><div class="insert">+auth.settings.retrieve_password_onvalidation = []</div><div class="insert">+auth.settings.reset_password_onvalidation = []</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Each callback must be a function that takes the ``form`` object and it can modify the attributes of the form object before database IO is performed.</div><div class="insert">+</div><div class="insert">+These are lists of callbacks that should be executed after the database IO is performed and before redirection:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.settings.login_onaccept = []</div><div class="insert">+auth.settings.register_onaccept = []</div><div class="insert">+auth.settings.profile_onaccept = []</div><div class="insert">+auth.settings.verify_email_onaccept = []</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Here is an example:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.settings.register_onaccept.append(lambda form:\</div><div class="insert">+   mail.send(to=&#x27;you@example.com&#x27;,subject=&#x27;new user&#x27;,</div><div class="insert">+             message=&#x27;new user email is %s&#x27;%form.vars.email))</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+You can enable captcha for any of the ``auth`` actions:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.settings.captcha = None</div><div class="insert">+auth.settings.login_captcha = None</div><div class="insert">+auth.settings.register_captcha = None</div><div class="insert">+auth.settings.retrieve_username_captcha = None</div><div class="insert">+auth.settings.retrieve_password_captcha = None</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+If the ``.captcha`` settings points to a ``gluon.tools.Recaptcha``, all forms for which the corresponding option (like ``.login_captcha``) is set to ``None`` will have a captcha, while those for which the corresponding option is set to ``False`` will not. If, instead, ``.captcha`` is set to ``None``, only those form who have a corresponding option set to a ``gluon.tools.Recaptcha`` object will have captcha and the others will not.</div><div class="insert">+</div><div class="insert">+This is the login session expiration time:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.settings.expiration = 3600  # seconds</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+You can change the name of the password field (in Firebird for example &quot;password&quot; is a keyword and cannot be used to name a field):</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.settings.password_field = &#x27;password&#x27;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+</div><div class="insert">+Normally the login form tries to validate an email. This can be disabled by changing this setting:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.settings.login_email_validate = True</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Do you want to show the record id in the edit profile page?</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.settings.showid = False</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+For custom forms you may want to disable automatic error notification in forms:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.settings.hideerror = False</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+Also for custom forms you can change the style:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.settings.formstyle = &#x27;table3cols&#x27;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+(it can be &quot;table2cols&quot;, &quot;divs&quot; and &quot;ul&quot;)</div><div class="insert">+</div><div class="insert">+And you can set the separator for auth-generated forms:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.settings.label_separator =        &#x27;:&#x27;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+</div><div class="insert">+By default the login form gives the option to extend the login via &quot;remember me&quot; option. The expiration time can be changed or the option disabled via these settings:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.settings.long_expiration = 3600*24*30 # one month</div><div class="insert">+auth.settings.remember_me_form = True</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+You can also customize the following messages whose use and context should be obvious:</div><div class="insert">+``</div><div class="insert">+auth.messages.submit_button = &#x27;Submit&#x27;</div><div class="insert">+auth.messages.verify_password = &#x27;Verify Password&#x27;</div><div class="insert">+auth.messages.delete_label = &#x27;Check to delete:&#x27;</div><div class="insert">+auth.messages.function_disabled = &#x27;Function disabled&#x27;</div><div class="insert">+auth.messages.access_denied = &#x27;Insufficient privileges&#x27;</div><div class="insert">+auth.messages.registration_verifying = &#x27;Registration needs verification&#x27;</div><div class="insert">+auth.messages.registration_pending = &#x27;Registration is pending approval&#x27;</div><div class="insert">+auth.messages.login_disabled = &#x27;Login disabled by administrator&#x27;</div><div class="insert">+auth.messages.logged_in = &#x27;Logged in&#x27;</div><div class="insert">+auth.messages.email_sent = &#x27;Email sent&#x27;</div><div class="insert">+auth.messages.unable_to_send_email = &#x27;Unable to send email&#x27;</div><div class="insert">+auth.messages.email_verified = &#x27;Email verified&#x27;</div><div class="insert">+auth.messages.logged_out = &#x27;Logged out&#x27;</div><div class="insert">+auth.messages.registration_successful = &#x27;Registration successful&#x27;</div><div class="insert">+auth.messages.invalid_email = &#x27;Invalid email&#x27;</div><div class="insert">+auth.messages.unable_send_email = &#x27;Unable to send email&#x27;</div><div class="insert">+auth.messages.invalid_login = &#x27;Invalid login&#x27;</div><div class="insert">+auth.messages.invalid_user = &#x27;Invalid user&#x27;</div><div class="insert">+auth.messages.is_empty = &quot;Cannot be empty&quot;</div><div class="insert">+auth.messages.mismatched_password = &quot;Password fields don&#x27;t match&quot;</div><div class="insert">+auth.messages.verify_email = ...</div><div class="insert">+auth.messages.verify_email_subject = &#x27;Password verify&#x27;</div><div class="insert">+auth.messages.username_sent = &#x27;Your username was emailed to you&#x27;</div><div class="insert">+auth.messages.new_password_sent = &#x27;A new password was emailed to you&#x27;</div><div class="insert">+auth.messages.password_changed = &#x27;Password changed&#x27;</div><div class="insert">+auth.messages.retrieve_username = &#x27;Your username is: %(username)s&#x27;</div><div class="insert">+auth.messages.retrieve_username_subject = &#x27;Username retrieve&#x27;</div><div class="insert">+auth.messages.retrieve_password = &#x27;Your password is: %(password)s&#x27;</div><div class="insert">+auth.messages.retrieve_password_subject = &#x27;Password retrieve&#x27;</div><div class="insert">+auth.messages.reset_password = ...</div><div class="insert">+auth.messages.reset_password_subject = &#x27;Password reset&#x27;</div><div class="insert">+auth.messages.invalid_reset_password = &#x27;Invalid reset password&#x27;</div><div class="insert">+auth.messages.profile_updated = &#x27;Profile updated&#x27;</div><div class="insert">+auth.messages.new_password = &#x27;New password&#x27;</div><div class="insert">+auth.messages.old_password = &#x27;Old password&#x27;</div><div class="insert">+auth.messages.group_description = \</div><div class="insert">+    &#x27;Group uniquely assigned to user %(id)s&#x27;</div><div class="insert">+auth.messages.register_log = &#x27;User %(id)s Registered&#x27;</div><div class="insert">+auth.messages.login_log = &#x27;User %(id)s Logged-in&#x27;</div><div class="insert">+auth.messages.logout_log = &#x27;User %(id)s Logged-out&#x27;</div><div class="insert">+auth.messages.profile_log = &#x27;User %(id)s Profile updated&#x27;</div><div class="insert">+auth.messages.verify_email_log = &#x27;User %(id)s Verification email sent&#x27;</div><div class="insert">+auth.messages.retrieve_username_log = &#x27;User %(id)s Username retrieved&#x27;</div><div class="insert">+auth.messages.retrieve_password_log = &#x27;User %(id)s Password retrieved&#x27;</div><div class="insert">+auth.messages.reset_password_log = &#x27;User %(id)s Password reset&#x27;</div><div class="insert">+auth.messages.change_password_log = &#x27;User %(id)s Password changed&#x27;</div><div class="insert">+auth.messages.add_group_log = &#x27;Group %(group_id)s created&#x27;</div><div class="insert">+auth.messages.del_group_log = &#x27;Group %(group_id)s deleted&#x27;</div><div class="insert">+auth.messages.add_membership_log = None</div><div class="insert">+auth.messages.del_membership_log = None</div><div class="insert">+auth.messages.has_membership_log = None</div><div class="insert">+auth.messages.add_permission_log = None</div><div class="insert">+auth.messages.del_permission_log = None</div><div class="insert">+auth.messages.has_permission_log = None</div><div class="insert">+auth.messages.label_first_name = &#x27;First name&#x27;</div><div class="insert">+auth.messages.label_last_name = &#x27;Last name&#x27;</div><div class="insert">+auth.messages.label_username = &#x27;Username&#x27;</div><div class="insert">+auth.messages.label_email = &#x27;E-mail&#x27;</div><div class="insert">+auth.messages.label_password = &#x27;Password&#x27;</div><div class="insert">+auth.messages.label_registration_key = &#x27;Registration key&#x27;</div><div class="insert">+auth.messages.label_reset_password_key = &#x27;Reset Password key&#x27;</div><div class="insert">+auth.messages.label_registration_id = &#x27;Registration identifier&#x27;</div><div class="insert">+auth.messages.label_role = &#x27;Role&#x27;</div><div class="insert">+auth.messages.label_description = &#x27;Description&#x27;</div><div class="insert">+auth.messages.label_user_id = &#x27;User ID&#x27;</div><div class="insert">+auth.messages.label_group_id = &#x27;Group ID&#x27;</div><div class="insert">+auth.messages.label_name = &#x27;Name&#x27;</div><div class="insert">+auth.messages.label_table_name = &#x27;Table name&#x27;</div><div class="insert">+auth.messages.label_record_id = &#x27;Record ID&#x27;</div><div class="insert">+auth.messages.label_time_stamp = &#x27;Timestamp&#x27;</div><div class="insert">+auth.messages.label_client_ip = &#x27;Client IP&#x27;</div><div class="insert">+auth.messages.label_origin = &#x27;Origin&#x27;</div><div class="insert">+auth.messages.label_remember_me = &quot;Remember me (for 30 days)&quot;</div><div class="insert">+``:code</div><div class="insert">+``add|del|has`` membership logs allow the use of &quot;%(user_id)s&quot; and &quot;%(group_id)s&quot;.</div><div class="insert">+``add|del|has`` permission logs allow the use of &quot;%(user_id)s&quot;, &quot;%(name)s&quot;, &quot;%(table_name)s&quot;, and &quot;%(record_id)s&quot;.</div><div class="insert">+</div><div class="insert">+### Central Authentication Service</div><div class="insert">+``CAS``:inxx ``authentication``:inxx</div><div class="insert">+</div><div class="insert">+web2py provides support for third party authentication and single sign on.</div><div class="insert">+Here we discuss the Central Authentication Service (CAS) which is an industry standard and both client and server are built-into web2py.</div><div class="insert">+</div><div class="insert">+CAS is an open protocol for distributed authentication and it works in the following way: When a visitor arrives at our web site, our application check in the session if the user is already authenticated (for example via a ``session.token`` object). If the user is not authenticated, the controller redirects the visitor from the CAS appliance, where the user can log in, register, and manage his credentials (name, email and password). If the user registers, he receives an email, and registration is not complete until he responds to the email. Once the user has successfully registered and logged in, the CAS appliance redirects the user to our application together with a key. Our application uses the key to get the credentials of the user via an HTTP request in the background to the CAS server.</div><div class="insert">+</div><div class="insert">+Using this mechanism, multiple applications can use a single sign-on via a single CAS server. The server providing authentication is called a service provider. Applications seeking to authenticate visitors are called service consumers.</div><div class="insert">+</div><div class="insert">+CAS is similar to OpenID, with one main difference. In the case of OpenID, the visitor chooses the service provider. In the case of CAS, our application makes this choice, making CAS more secure.</div><div class="insert">+</div><div class="insert">+Running a web2py CAS provider is as easy as copying the scaffolding app. In fact any web2py app that exposes the action</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+## in provider app</div><div class="insert">+def user(): return dict(form=auth())</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+is a CAS 2.0 provider and its services can be accessed at the URL</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+http://.../provider/default/user/cas/login</div><div class="insert">+http://.../provider/default/user/cas/validate</div><div class="insert">+http://.../provider/default/user/cas/logout</div><div class="insert">+``:code</div><div class="insert">+(we assume the app to be called &quot;provider&quot;).</div><div class="insert">+</div><div class="insert">+You can access this service from any other web application (the consumer) by simply delegating authentication to the provider:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+## in consumer app</div><div class="insert">+auth = Auth(db,cas_provider = &#x27;http://127.0.0.1:8000/provider/default/user/cas&#x27;)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+When you visit the login url the consumer app, it will redirect you to the provider app which will perform authentication and will redirect back to the consumer. All processes of registration, logout, change password, retrieve password, have to be completed on the provider app. An entry about the logged-in user will be created on the consumer side so that you add extra fields and have a local profile. Thanks to CAS 2.0 all fields that are readable on the provider and have a corresponding field in the ``auth_user`` table of the consumer will be copied automatically.</div><div class="insert">+</div><div class="insert">+``Auth(...,cas_provider=&#x27;...&#x27;)`` works with third party providers and supports CAS 1.0 and 2.0. The version is detected automatically. By default it builds the URLs of the provider from a base (the ``cas_provider`` url above) by appending</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+/login</div><div class="insert">+/validate</div><div class="insert">+/logout</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+These can be changed in consumer and in provider</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+## in consumer or provider app (must match)</div><div class="insert">+auth.settings.cas_actions[&#x27;login&#x27;]=&#x27;login&#x27;</div><div class="insert">+auth.settings.cas_actions[&#x27;validate&#x27;]=&#x27;validate&#x27;</div><div class="insert">+auth.settings.cas_actions[&#x27;logout&#x27;]=&#x27;logout&#x27;</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+If you want to connect to a web2py CAS provider from a different domain, you must enable them by attending to the list of allowed domain:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+## in provider app</div><div class="insert">+auth.settings.cas_domains.append(&#x27;example.com&#x27;)</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+</div><div class="insert">+#### Using web2py to authorize non-web2py apps</div><div class="insert">+</div><div class="insert">+This is possible but dependent on the web server.</div><div class="insert">+here we assume two applications running under the same web server: Apache with ``mod_wsgi``.</div><div class="insert">+One of the applications is web2py with an app proving access control via Auth.</div><div class="insert">+The other can be a CGI script, a PHP program or anything else.</div><div class="insert">+We want to instruct the web server to ask permission to the former application when a client requests access to the latter.</div><div class="insert">+</div><div class="insert">+First of all we need to modify the web2py application and add the following controller:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+def check_access():</div><div class="insert">+    return &#x27;true&#x27; if auth.is_logged_in() else &#x27;false&#x27;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+which returns ``true`` if the user is logged in and ``false`` otherwise. Now run a web2py process in background:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+nohup python web2py.py -a &#x27;&#x27; -p 8002</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+Port 8002 is a must and there is no need to enable admin so no admin password.</div><div class="insert">+</div><div class="insert">+Then we need to edit the Apache config file (for example &quot;/etc/apache2/sites-available/default&quot;) and instruct apache so that when the non-web2py program is called, it should call the above ``check`` action instead and only if it returns ``true`` it should proceed and respond to the request, else if should deny access.</div><div class="insert">+</div><div class="insert">+Because web2py and the non-web2py application run under the same domain, if the user is logged into the web2py app, the web2py session cookie will be passed to Apache even when the other app is requested and will allow credential verification.</div><div class="insert">+</div><div class="insert">+In order to achieve this we need a script, &quot;web2py/scripts/access.wsgi&quot; that can play this trick.</div><div class="insert">+The script ships with web2py. All we need to do it tell apache to call this script, the URL of the application needing access control, and the location of the script:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+&lt;VirtualHost *:80&gt;</div><div class="insert">+   WSGIDaemonProcess web2py user=www-data group=www-data</div><div class="insert">+   WSGIProcessGroup web2py</div><div class="insert">+   WSGIScriptAlias / /home/www-data/web2py/wsgihandler.py</div><div class="insert">+</div><div class="insert">+   AliasMatch ^myapp/path/needing/authentication/myfile /path/to/myfile</div><div class="insert">+   &lt;Directory /path/to/&gt;</div><div class="insert">+     WSGIAccessScript /path/to/web2py/scripts/access.wsgi</div><div class="insert">+   &lt;/Directory&gt;</div><div class="insert">+&lt;/VirtualHost&gt;</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+Here &quot;^myapp/path/needing/authentication/myfile&quot; is the regular expression that should match the incoming request and &quot;/path/to/&quot; is the absolute location of the web2py folder.</div><div class="insert">+</div><div class="insert">+The &quot;access.wsgi&quot; script contains the following line:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+URL_CHECK_ACCESS = &#x27;http://127.0.0.1:8002/%(app)s/default/check_access&#x27;</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+which points to the web2py application we have requested but you can edit it to point to a specific application, running on a port other than 8002.</div><div class="insert">+</div><div class="insert">+You can also change the ``check_access()`` action and make its logic more complex. This action can retrieve the URL that was originally requested using the environment variable</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+request.env.request_uri</div><div class="insert">+``</div><div class="insert">+</div><div class="insert">+and you can implement more complex rules:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+def check_access():</div><div class="insert">+    if not auth.is_logged_in():</div><div class="insert">+       return &#x27;false&#x27;</div><div class="insert">+    elif not user_has_access(request.env.request_uri):</div><div class="insert">+       return &#x27;false&#x27;</div><div class="insert">+    else:</div><div class="insert">+       return &#x27;true&#x27;</div><div class="insert">+``:code</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">-## Access Control</div><div class="delete">-``Auth``:inxx ``Access Control``:inxx ``RBAC``:inxx ``DAC``:inxx ``MAC``:inxx</div><div class="delete">-</div><div class="delete">-web2py includes a powerful and customizable Role Based Access Control mechanism (RBAC).</div><div class="delete">-</div><div class="delete">-Here is a definition from Wikipedia:</div><div class="delete">-</div><div class="delete">-&quot;Role-Based Access Control (RBAC) is an approach to restricting system access to authorized users. It is a newer alternative approach to mandatory access control (MAC) and discretionary access control (DAC). RBAC is sometimes referred to as role-based security.</div><div class="delete">-</div><div class="delete">-RBAC is a policy neutral and flexible access control technology sufficiently powerful to simulate DAC and MAC. Conversely, MAC can simulate RBAC if the role graph is restricted to a tree rather than a partially ordered set.</div><div class="delete">-</div><div class="delete">-Prior to the development of RBAC, MAC and DAC were considered to be the only known models for access control: if a model was not MAC, it was considered to be a DAC model, and vice versa. Research in the late 1990s demonstrated that RBAC falls in neither category.</div><div class="delete">-</div><div class="delete">-Within an organization, roles are created for various job functions. The permissions to perform certain operations are assigned to specific roles. Members of staff (or other system users) are assigned particular roles, and through those role assignments acquire the permissions to perform particular system functions. Unlike context-based access control (CBAC), RBAC does not look at the message context (such as a connection&#x27;s source).</div><div class="delete">-</div><div class="delete">-Since users are not assigned permissions directly, but only acquire them through their role (or roles), management of individual user rights becomes a matter of simply assigning appropriate roles to the user; this simplifies common operations, such as adding a user, or changing a user&#x27;s department.</div><div class="delete">-</div><div class="delete">-RBAC differs from access control lists (ACLs) used in traditional discretionary access control systems in that it assigns permissions to specific operations with meaning in the organization, rather than to low level data objects. For example, an access control list could be used to grant or deny write access to a particular system file, but it would not dictate how that file could be changed.&quot;</div><div class="delete">-</div><div class="delete">-The web2py class that implements RBAC is called **Auth**.</div><div class="delete">-</div><div class="delete">-**Auth** needs (and defines) the following tables:</div><div class="delete">-- ``auth_user`` stores users&#x27; name, email address, password, and status (registration pending, accepted, blocked)</div><div class="delete">-- ``auth_group`` stores groups or roles for users in a many-to-many structure. By default, each user is in its own group, but a user can be in multiple groups, and each group can contain multiple users. A group is identified by a role and a description.</div><div class="delete">-- ``auth_membership`` links users and groups in a many-to-many structure.</div><div class="delete">-- ``auth_permission`` links groups and permissions. A permission is identified by a name and, optionally, a table and a record. For example, members of a certain group can have &quot;update&quot; permissions on a specific record of a specific table.</div><div class="delete">-- ``auth_event`` logs changes in the other tables and successful access via CRUD to objects controlled by the RBAC.</div><div class="delete">-</div><div class="delete">-In principle, there is no restriction on the names of the roles and the names of the permissions; the developer can create them to fix the roles and permissions in the organization. Once they have been created, web2py provides an API to check if a user is logged in, if a user is a member of a given group, and/or if the user is a member of any group that has a given required permission.</div><div class="delete">-</div><div class="delete">-web2py also provides decorators to restrict access to any function based on login, membership and permissions.</div><div class="delete">-</div><div class="delete">-web2py also understands some specific permissions, i.e., those that have a name that correspond to the CRUD methods (create, read, update, delete) and can enforce them automatically without the need to use decorators.</div><div class="delete">-</div><div class="delete">-In this chapter, we are going to discuss different parts of RBAC one by one.</div><div class="delete">-</div><div class="delete">-### Authentication</div><div class="delete">-</div><div class="delete">-In order to use RBAC, users need to be identified. This means that they need to register (or be registered) and log in.</div><div class="delete">-</div><div class="delete">-**Auth** provides multiple login methods. The default one consists of identifying users based on the local ``auth_user`` table.</div><div class="delete">-Alternatively, it can log in users against third-party authentication systems and single sign on providers such as Google, PAM, LDAP, Facebook, LinkedIn, Dropbox, OpenID, OAuth, etc..</div><div class="delete">-</div><div class="delete">-To start using ``Auth``, you need at least this code in a model file, which is also provided with the web2py &quot;welcome&quot; application and assumes a ``db`` connection object:</div><div class="delete">-``</div><div class="delete">-from gluon.tools import Auth</div><div class="delete">-auth = Auth(db)</div><div class="delete">-auth.define_tables()</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Auth has an optional ``secure=True`` argument, which will force authenticated pages to go over HTTPS. ``https``:inxx</div><div class="delete">-</div><div class="delete">-The ``password`` field of the ``db.auth_user`` table defaults to a ``CRYPT`` validator, which needs and ``hmac_key``. On legacy web2py applications you may see an extra argument passed to the Auth constructor: ``hmac_key = Auth.get_or_create_key()``. The latter is a function that read the hmac kay from a file &quot;private/auth.key&quot; within the application folder. If the file does not exist it creates a random ``hmac_key``. If multiple apps share the same auth database, make sure they also use the same ``hmac_key``. This is no loger necessary for new applications since passwords are salted with an individual random salt.</div><div class="delete">-</div><div class="delete">-By default, web2py uses email for login. If instead you want to log in using username set ``auth.define_tables(username=True)``</div><div class="delete">-</div><div class="delete">-If multiple apps share the same auth database you may want to disable migrations: ``auth.define_tables(migrate=False)``.</div><div class="delete">-</div><div class="delete">-To expose **Auth**, you also need the following function in a controller (for example in &quot;default.py&quot;):</div><div class="delete">-``</div><div class="delete">-def user(): return dict(form=auth())</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-The ``auth`` object and the ``user`` action are already defined in the</div><div class="delete">-scaffolding application.</div><div class="delete">-</div><div class="delete">-web2py also includes a sample view &quot;welcome/views/default/user.html&quot; to render this function properly that looks like this:</div><div class="delete">-``</div><div class="delete">-{{extend &#x27;layout.html&#x27;}}</div><div class="delete">-&lt;h2&gt;{{=T( request.args(0).replace(&#x27;_&#x27;,&#x27; &#x27;).capitalize() )}}&lt;/h2&gt;</div><div class="delete">-&lt;div id=&quot;web2py_user_form&quot;&gt;</div><div class="delete">-  {{=form}}</div><div class="delete">-  {{if request.args(0)==&#x27;login&#x27;:}}</div><div class="delete">-    {{if not &#x27;register&#x27; in auth.settings.actions_disabled:}}</div><div class="delete">-      &lt;br/&gt;&lt;a href=&quot;{{=URL(args=&#x27;register&#x27;)}}&quot;&gt;register&lt;/a&gt;</div><div class="delete">-    {{pass}}</div><div class="delete">-    {{if not &#x27;request_reset_password&#x27; in auth.settings.actions_disabled:}}</div><div class="delete">-      &lt;br/&gt;</div><div class="delete">-      &lt;a href=&quot;{{=URL(args=&#x27;request_reset_password&#x27;)}}&quot;&gt;lost password&lt;/a&gt;</div><div class="delete">-    {{pass}}</div><div class="delete">-  {{pass}}</div><div class="delete">-&lt;/div&gt;</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Notice that this function simply displays a ``form`` and therefore it can be customized using normal custom form syntax. The only caveat is that the form displayed by ``form=auth()`` depends on ``request.args(0)``; therefore, if you replace the default ``auth()`` login form with a custom login form, you may need an ``if`` statement like this in the view:</div><div class="delete">-``</div><div class="delete">-{{if request.args(0)==&#x27;login&#x27;:}}...custom login form...{{pass}}</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-``auth.impersonate``:inxx ``auth.is_impersonating``:inxx</div><div class="delete">-</div><div class="delete">-The controller above exposes multiple actions:</div><div class="delete">-``</div><div class="delete">-http://.../[app]/default/user/register</div><div class="delete">-http://.../[app]/default/user/login</div><div class="delete">-http://.../[app]/default/user/logout</div><div class="delete">-http://.../[app]/default/user/profile</div><div class="delete">-http://.../[app]/default/user/change_password</div><div class="delete">-http://.../[app]/default/user/verify_email</div><div class="delete">-http://.../[app]/default/user/retrieve_username</div><div class="delete">-http://.../[app]/default/user/request_reset_password</div><div class="delete">-http://.../[app]/default/user/reset_password</div><div class="delete">-http://.../[app]/default/user/impersonate</div><div class="delete">-http://.../[app]/default/user/groups</div><div class="delete">-http://.../[app]/default/user/not_authorized</div><div class="delete">-``:code</div><div class="delete">-- **register** allows users to register. It is integrated with CAPTCHA, although this is disabled by default. This is also integrated with a client-side entropy calculator defined in &quot;web2py.js&quot;. The calculator indictates the strenght of the new password. You can use the ``IS_STRONG`` validator to prevent web2py from accepting weak passwords. </div><div class="delete">-- **login** allows users who are registered to log in (if the registration is verified or does not require verification, if it has been approved or does not require approval, and if it has not been blocked).</div><div class="delete">-- **logout** does what you would expect but also, as the other methods, logs the event and can be used to trigger some event.</div><div class="delete">-- **profile** allows users to edit their profile, i.e. the content of the ``auth_user`` table. Notice that this table does not have a fixed structure and can be customized.</div><div class="delete">-- **change_password** allows users to change their password in a fail-safe way.</div><div class="delete">-- **verify_email**. If email verification is turned on, then visitors, upon registration, receive an email with a link to verify their email information. The link points to this action.</div><div class="delete">-- **retrieve_username**. By default, **Auth** uses email and password for login, but it can, optionally, use username instead of email. In this latter case, if a user forgets his/her username, the ``retrieve_username`` method allows the user to type the email address and retrieve the username by email.</div><div class="delete">-- **request_reset_password**. Allows users who forgot their password to request a new password. They will get a confirmation email pointing to **reset_password**.</div><div class="delete">-- **impersonate** allows a user to &quot;impersonate&quot; another user. This is important for debugging and for support purposes. ``request.args[0]`` is the id of the user to be impersonated. This is only allowed if the logged in user ``has_permission(&#x27;impersonate&#x27;, db.auth_user, user_id)``. You can use ``auth.is_impersonating()`` to check is the current user is impersonating somebody else.</div><div class="delete">-- **groups** lists the groups of which the current logged in user is a member.</div><div class="delete">-- **not_authorized** displays an error message when the visitor tried to do something that he/she is not authorized to do</div><div class="delete">-- **navbar** is a helper that generates a bar with login/register/etc. links.</div><div class="delete">-</div><div class="delete">-Logout, profile, change_password, impersonate, and groups require login.</div><div class="delete">-</div><div class="delete">-By default they are all exposed, but it is possible to restrict access to only some of these actions.</div><div class="delete">-</div><div class="delete">-All of the methods above can be extended or replaced by subclassing **Auth**.</div><div class="delete">-</div><div class="delete">-All of the methods above can be used in separate actions. For example:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-def mylogin(): return dict(form=auth.login())</div><div class="delete">-def myregister(): return dict(form=auth.register())</div><div class="delete">-def myprofile(): return dict(form=auth.profile())</div><div class="delete">-...</div><div class="delete">-``</div><div class="delete">-</div><div class="delete">-To restrict access to functions to only logged in visitors, decorate the function as in the following example</div><div class="delete">-``</div><div class="delete">-@auth.requires_login()</div><div class="delete">-def hello():</div><div class="delete">-    return dict(message=&#x27;hello %(first_name)s&#x27; % auth.user)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Any function can be decorated, not just exposed actions. Of course this is still only a very simple example of access control. More complex examples will be discussed later.</div><div class="delete">-``auth.user``:inxx ``auth.user_id``:inxx ``auth.user_groups``.</div><div class="delete">-</div><div class="delete">-``auth.user`` contains a copy of the ``db.auth_user`` records for the current logged in user or ``None`` otherwise. There is also a ``auth.user_id`` which is the same as ``auth.user.id`` (i.e. the id of the current logger in user) or ``None``. Similarly, ``auth.user_groups`` contains a dictionary where each key is the id of a group of with the current logged in user is member of, the value is the corresponding group role.</div><div class="delete">-</div><div class="delete">-``otherwise``:inxx</div><div class="delete">-</div><div class="delete">-The ``auth.requires_login()`` decorator as well as the other ``auth.requires_*`` decorators take an optional ``otherwise`` argument. It can be set to a string where to redirect the user if registration files or to a callable object. It is called if registration fails.</div><div class="delete">-</div><div class="delete">-#### Restrictions on registration</div><div class="delete">-</div><div class="delete">-If you want to allow visitors to register but not to log in until registration has been approved by the administrator:</div><div class="delete">-``</div><div class="delete">-auth.settings.registration_requires_approval = True</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-You can approve a registration via the appadmin interface. Look into the table ``auth_user``. Pending registrations have a ``registration_key`` field set to &quot;pending&quot;. A registration is approved when this field is set to blank.</div><div class="delete">-</div><div class="delete">-Via the appadmin interface, you can also block a user from logging in. Locate the user in the table ``auth_user`` and set the ``registration_key`` to &quot;blocked&quot;. &quot;blocked&quot; users are not allowed to log in. Notice that this will prevent a visitor from logging in but it will not force a visitor who is already logged in to log out. The word &quot;disabled&quot; may be used instead of &quot;blocked&quot; if preferred, with exactly the same behavior.</div><div class="delete">-</div><div class="delete">-You can also block access to the &quot;register&quot; page completely with this statement:</div><div class="delete">-``</div><div class="delete">-auth.settings.actions_disabled.append(&#x27;register&#x27;)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-If you want to allow people to register and automatically log them in after registration but still want to send an email for verification so that they cannot login again after logout, unless they completed the instructions in the email, you can accomplish it as follows:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.settings.registration_requires_approval = True</div><div class="delete">-auth.settings.login_after_registration = True</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-</div><div class="delete">-Other methods of **Auth** can be restricted in the same way.</div><div class="delete">-</div><div class="delete">-#### Integration with OpenID, Facebook, etc.</div><div class="delete">-``Janrain``:inxx ``OpenID``:inxx ``Facebook``:inxx ``LinkedIn``:inxx ``Google``:inxx ``MySpace``:inxx ``Flickr``:inxx</div><div class="delete">-</div><div class="delete">-You can use the web2py Role Base Access Control and authenticate with other services like OpenID, Facebook, LinkedIn, Google, Dropbox, MySpace, Flickr, etc.</div><div class="delete">-The easiest way is to use Janrain Engage (formerly RPX) (Janrain.com).</div><div class="delete">-</div><div class="delete">-Dropbox is discussed as a special case in Chapter 14 since it allows more than just login, it also provides storage services for the logged in users.</div><div class="delete">-</div><div class="delete">-Janrain Engage is a service that provides middleware authentication. You can register with Janrain.com, register a domain (the name of your app) and set of URLs you will be using, and they will provide you with an API key.</div><div class="delete">-</div><div class="delete">-Now edit the model of your web2py application and place the following lines somewhere after the definition of the ``auth`` object :</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-from gluon.contrib.login_methods.rpx_account import RPXAccount</div><div class="delete">-auth.settings.actions_disabled=[&#x27;register&#x27;,&#x27;change_password&#x27;,&#x27;request_reset_password&#x27;]</div><div class="delete">-auth.settings.login_form = RPXAccount(request,</div><div class="delete">-    api_key=&#x27;...&#x27;,</div><div class="delete">-    domain=&#x27;...&#x27;,</div><div class="delete">-    url = &quot;http://localhost:8000/%s/default/user/login&quot; % request.application)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-The first line imports the new login method, the second line disables local registration, and the third line asks web2py to use the RPX login method. You must insert your own ``api_key`` provided by Janrain.com, the domain you choose upon registration and the external ``url`` of your login page.</div><div class="delete">-</div><div class="delete">-[[image @///image/en6900.png center 300px]]</div><div class="delete">-</div><div class="delete">-When a new user logins for the first time, web2py creates a new ``db.auth_user`` record associated to the user. It will use the ``registration_id`` field to store a unique id for the user. Most authentication methods will also provide a username, email, first_name and last_name but that is not guaranteed. Which fields are provided depends on the login method selected by the user. If the same user logs in twice using different authentication mechanisms (for example once with OpenID and once with Facebook), Janrain may not recognize his/her as the same user and issue different ``registration_id``.</div><div class="delete">-</div><div class="delete">-You can customize the mapping between the data provided by Janrain and the data stored in ``db.auth_user``. Here is an example for Facebook:</div><div class="delete">-``</div><div class="delete">-auth.settings.login_form.mappings.Facebook = lambda profile:\</div><div class="delete">-            dict(registration_id = profile[&quot;identifier&quot;],</div><div class="delete">-                 username = profile[&quot;preferredUsername&quot;],</div><div class="delete">-                 email = profile[&quot;email&quot;],</div><div class="delete">-                 first_name = profile[&quot;name&quot;][&quot;givenName&quot;],</div><div class="delete">-                 last_name = profile[&quot;name&quot;][&quot;familyName&quot;])</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-The keys in the dictionary are fields in ``db.auth_user`` and the values are data entries in the profile object provided by Janrain. Look at the online Janrain documentation for details on the latter.</div><div class="delete">-</div><div class="delete">-Janrain will also keep statistics about your users&#x27; login.</div><div class="delete">-</div><div class="delete">-This login form is fully integrated with web2py Role Based Access Control and you can still create groups, make users members of groups, assign permissions, block users, etc.</div><div class="delete">-</div><div class="delete">-Janrain&#x27;s free Basic service allows up to 2500 unique registered users to sign in annually. Accommodating more users requires an upgrade to one of their paid service tiers.</div><div class="delete">-</div><div class="delete">-If you prefer not to use Janrain and want to use a different login method (LDAP, PAM, Google, OpenID, OAuth/Facebook, LinkedIn, etc.) you can do so. The API to do so is described later in the chapter.</div><div class="delete">-</div><div class="delete">-#### CAPTCHA and reCAPTCHA</div><div class="delete">-</div><div class="delete">-``CAPTCHA``:inxx ``reCAPTCHA``:inxx ``PIL``:inxx</div><div class="delete">-To prevent spammers and bots registering on your site, you may require a registration CAPTCHA. web2py supports reCAPTCHA``recaptcha``:cite  out of the box. This is because reCAPTCHA is very well designed, free, accessible (it can read the words to the visitors), easy to set up, and does not require installing any third-party libraries.</div><div class="delete">-</div><div class="delete">-This is what you need to do to use reCAPTCHA:</div><div class="delete">-- Register with reCAPTCHA``recaptcha``:cite  and obtain a (PUBLIC_KEY, PRIVATE_KEY) couple for your account. These are just two strings.</div><div class="delete">-- Append the following code to your model after the ``auth`` object is defined:</div><div class="delete">-``</div><div class="delete">-from gluon.tools import Recaptcha</div><div class="delete">-auth.settings.captcha = Recaptcha(request,</div><div class="delete">-    &#x27;PUBLIC_KEY&#x27;, &#x27;PRIVATE_KEY&#x27;)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-reCAPTCHA may not work if you access the web site as &#x27;localhost&#x27; or &#x27;127.0.0.1&#x27;, because it is registered to work with publicly visible web sites only.</div><div class="delete">-</div><div class="delete">-The ``Recaptcha`` constructor takes some optional arguments:</div><div class="delete">-``</div><div class="delete">-Recaptcha(..., use_ssl=True, error_message=&#x27;invalid&#x27;, label=&#x27;Verify:&#x27;, options=&#x27;&#x27;)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Notice that ``use_ssl=False`` by default.</div><div class="delete">-</div><div class="delete">-``options`` may be a configuration string, e.g. ``options=&quot;theme:&#x27;white&#x27;, lang:&#x27;fr&#x27;&quot;``</div><div class="delete">-</div><div class="delete">-More details: [[reCAPTCHA http://www.google.com/recaptcha]]``recaptchagoogle``:cite  and [[customizing http://code.google.com/apis/recaptcha/docs/customization.html]]  .</div><div class="delete">-</div><div class="delete">-If you do not want to use reCAPTCHA, look into the definition of the ``Recaptcha`` class in &quot;gluon/tools.py&quot;, since it is easy to use other CAPTCHA systems.</div><div class="delete">-</div><div class="delete">-Notice that ``Recaptcha`` is just a helper that extends ``DIV``. It generates a dummy field that validates using the ``reCaptcha`` service and, therefore, it can be used in any form, including used defined FORMs:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-form = FORM(INPUT(...),Recaptcha(...),INPUT(_type=&#x27;submit&#x27;))</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-You can use it in all types of SQLFORM by injection:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-form = SQLFORM(...) or SQLFORM.factory(...)</div><div class="delete">-form.element(&#x27;table&#x27;).insert(-1,TR(&#x27;&#x27;,Recaptcha(...),&#x27;&#x27;))</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-#### Customizing ``Auth``</div><div class="delete">-</div><div class="delete">-The call to</div><div class="delete">-``</div><div class="delete">-auth.define_tables()</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-defines all **Auth** tables that have not been defined already. This means that if you wish to do so, you can define your own ``auth_user`` table.</div><div class="delete">-</div><div class="delete">-There are a number of ways to customize auth. The simplest way is to add extra fields:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-## after auth = Auth(db)</div><div class="delete">-auth.settings.extra_fields[&#x27;auth_user&#x27;]= [</div><div class="delete">-  Field(&#x27;address&#x27;),</div><div class="delete">-  Field(&#x27;city&#x27;),</div><div class="delete">-  Field(&#x27;zip&#x27;),</div><div class="delete">-  Field(&#x27;phone&#x27;)]</div><div class="delete">-## before auth.define_tables(username=True)</div><div class="delete">-``</div><div class="delete">-</div><div class="delete">-You can declare extra fields not just for table &quot;auth_user&quot; but also for other &quot;auth_&quot; tables.</div><div class="delete">-Using ``extra_fields`` is the recommended way as it will not break any internal mechanism.</div><div class="delete">-</div><div class="delete">-Another way to do this, although not really recommended, consists of defining your auth tables yourself. If a table is declared before ``auth.define_tables()`` it is used instead of the default one. Here is how to do it:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-## after auth = Auth(db)</div><div class="delete">-db.define_table(</div><div class="delete">-    auth.settings.table_user_name,</div><div class="delete">-    Field(&#x27;first_name&#x27;, length=128, default=&#x27;&#x27;),</div><div class="delete">-    Field(&#x27;last_name&#x27;, length=128, default=&#x27;&#x27;),</div><div class="delete">-    Field(&#x27;email&#x27;, length=128, default=&#x27;&#x27;, unique=True), # required</div><div class="delete">-    Field(&#x27;password&#x27;, &#x27;password&#x27;, length=512,            # required</div><div class="delete">-          readable=False, label=&#x27;Password&#x27;),</div><div class="delete">-    Field(&#x27;address&#x27;),</div><div class="delete">-    Field(&#x27;city&#x27;),</div><div class="delete">-    Field(&#x27;zip&#x27;),</div><div class="delete">-    Field(&#x27;phone&#x27;),</div><div class="delete">-    Field(&#x27;registration_key&#x27;, length=512,                # required</div><div class="delete">-          writable=False, readable=False, default=&#x27;&#x27;),</div><div class="delete">-    Field(&#x27;reset_password_key&#x27;, length=512,              # required</div><div class="delete">-          writable=False, readable=False, default=&#x27;&#x27;),</div><div class="delete">-    Field(&#x27;registration_id&#x27;, length=512,                 # required</div><div class="delete">-          writable=False, readable=False, default=&#x27;&#x27;))</div><div class="delete">-</div><div class="delete">-## do not forget validators</div><div class="delete">-custom_auth_table = db[auth.settings.table_user_name] # get the custom_auth_table</div><div class="delete">-custom_auth_table.first_name.requires = \</div><div class="delete">-  IS_NOT_EMPTY(error_message=auth.messages.is_empty)</div><div class="delete">-custom_auth_table.last_name.requires = \</div><div class="delete">-  IS_NOT_EMPTY(error_message=auth.messages.is_empty)</div><div class="delete">-custom_auth_table.password.requires = [IS_STRONG(), CRYPT()]</div><div class="delete">-custom_auth_table.email.requires = [</div><div class="delete">-  IS_EMAIL(error_message=auth.messages.invalid_email),</div><div class="delete">-  IS_NOT_IN_DB(db, custom_auth_table.email)]</div><div class="delete">-</div><div class="delete">-auth.settings.table_user = custom_auth_table # tell auth to use custom_auth_table</div><div class="delete">-</div><div class="delete">-## before auth.define_tables()</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-You can add any field you wish, and you can change validators but you cannot remove</div><div class="delete">-the fields marked as &quot;required&quot; in this example.</div><div class="delete">-</div><div class="delete">-It is important to make &quot;password&quot;, &quot;registration_key&quot;, &quot;reset_password_key&quot; and &quot;registration_id&quot; fields ``readable=False`` and ``writable=False``, since a visitor must not be allowed to tamper with them.</div><div class="delete">-</div><div class="delete">-If you add a field called &quot;username&quot;, it will be used in place of &quot;email&quot; for login. If you do, you will need to add a validator as well:</div><div class="delete">-``</div><div class="delete">-auth_table.username.requires = IS_NOT_IN_DB(db, auth_table.username)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-#### Renaming ``Auth`` tables</div><div class="delete">-</div><div class="delete">-The actual names of the ``Auth`` tables are stored in</div><div class="delete">-``</div><div class="delete">-auth.settings.table_user_name = &#x27;auth_user&#x27;</div><div class="delete">-auth.settings.table_group_name = &#x27;auth_group&#x27;</div><div class="delete">-auth.settings.table_membership_name = &#x27;auth_membership&#x27;</div><div class="delete">-auth.settings.table_permission_name = &#x27;auth_permission&#x27;</div><div class="delete">-auth.settings.table_event_name = &#x27;auth_event&#x27;</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-The names of the table can be changed by reassigning the above variables after the ``auth`` object is defined and before the Auth tables are defined. For example:</div><div class="delete">-``</div><div class="delete">-auth = Auth(db)</div><div class="delete">-auth.settings.table_user_name = &#x27;person&#x27;</div><div class="delete">-#...</div><div class="delete">-auth.define_tables()</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-The actual tables can also be referenced, independently of their actual names, by</div><div class="delete">-``</div><div class="delete">-auth.settings.table_user</div><div class="delete">-auth.settings.table_group</div><div class="delete">-auth.settings.table_membership</div><div class="delete">-auth.settings.table_permission</div><div class="delete">-auth.settings.table_event</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-#### Other login methods and login forms</div><div class="delete">-``LDAP``:inxx ``PAM``:inxx</div><div class="delete">-</div><div class="delete">-Auth provides multiple login methods and hooks to create new login methods. Each supported login method corresponds to a file in the folder</div><div class="delete">-``</div><div class="delete">-gluon/contrib/login_methods/</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Refer to the documentation in the files themselves for each login method, but here are some examples.</div><div class="delete">-</div><div class="delete">-First of all, we need to make a distinction between two types of alternate login methods:</div><div class="delete">-- login methods that use a web2py login form (although the credentials are verified outside web2py). An example is LDAP.</div><div class="delete">-- login methods that require an external single-sign-on form (an example is Google and Facebook).</div><div class="delete">-</div><div class="delete">-In the latter case, web2py never gets the login credentials, only a login token issued by the service provider. The token is stored in ``db.auth_user.registration_id``.</div><div class="delete">-</div><div class="delete">-Let&#x27;s consider examples of the first case:</div><div class="delete">-</div><div class="delete">-##### Basic</div><div class="delete">-</div><div class="delete">-Let&#x27;s say you have an authentication service, for example at the url</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-https://basic.example.com</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-that accepts basic access authentication. That means the server accepts HTTP requests with a header of the form:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-GET /index.html HTTP/1.0</div><div class="delete">-Host: basic.example.com</div><div class="delete">-Authorization: Basic QWxhZGRpbjpvcGVuIHNlc2FtZQ==</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-where the latter string is the base64 encoding of the string username:password. The service responds 200 OK if the user is authorized and 400, 401, 402, 403 or 404 otherwise.</div><div class="delete">-</div><div class="delete">-You want to enter username and password using the standard ``Auth`` login form and verify the credentials against such a service. All you need to do is add the following code to your application</div><div class="delete">-``</div><div class="delete">-from gluon.contrib.login_methods.basic_auth import basic_auth</div><div class="delete">-auth.settings.login_methods.append(</div><div class="delete">-    basic_auth(&#x27;https://basic.example.com&#x27;))</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Notice that ``auth.settings.login_methods`` is a list of authentication methods that are executed sequentially.</div><div class="delete">-By default it is set to</div><div class="delete">-``</div><div class="delete">-auth.settings.login_methods = [auth]</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-When an alternate method is appended, for example ``basic_auth``, **Auth** first tries to log in the visitor based on the content of ``auth_user``, and when this fails, it tries the next method in the list. If a method succeeds in logging in the visitor, and if ``auth.settings.login_methods[0]==auth``, ``Auth`` takes the following actions:</div><div class="delete">-- if the user does not exist in ``auth_user``, a new user is created and the username/email and passwords are stored.</div><div class="delete">-- if the user does exist in ``auth_user`` but the new accepted password does not match the old stored password, the old password is replaced with the new one (notice that passwords are always stored hashed unless specified otherwise).</div><div class="delete">-</div><div class="delete">-If you do not wish to store the new password in ``auth_user``, then it is sufficient to change the order of login methods, or remove ``auth`` from the list. For example:</div><div class="delete">-``</div><div class="delete">-from gluon.contrib.login_methods.basic_auth import basic_auth</div><div class="delete">-auth.settings.login_methods = \</div><div class="delete">-    [basic_auth(&#x27;https://basic.example.com&#x27;)]</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-The same applies for any other login method described here.</div><div class="delete">-</div><div class="delete">-##### SMTP and Gmail</div><div class="delete">-``SMTP``:inxx ``Gmail``:inxx</div><div class="delete">-</div><div class="delete">-You can verify login credentials using a remote SMTP server, for example Gmail; i.e., you log the user in if the email and password they provide are valid credentials to access the Gmail SMTP server (``smtp.gmail.com:587``). All that is needed is the following code:</div><div class="delete">-``</div><div class="delete">-from gluon.contrib.login_methods.email_auth import email_auth</div><div class="delete">-auth.settings.login_methods.append(</div><div class="delete">-    email_auth(&quot;smtp.gmail.com:587&quot;, &quot;@gmail.com&quot;))</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-The first argument of ``email_auth`` is the address:port of the SMTP server. The second argument is the email domain.</div><div class="delete">-</div><div class="delete">-This works with any SMTP server that requires TLS authentication.``TLS``:inxx</div><div class="delete">-</div><div class="delete">-##### PAM</div><div class="delete">-``PAM``:inxx</div><div class="delete">-</div><div class="delete">-Authentication using Pluggable Authentication Modules (PAM) works as in the previous cases. It allows web2py to authenticate users using the operating system accounts:</div><div class="delete">-``</div><div class="delete">-from gluon.contrib.login_methods.pam_auth import pam_auth</div><div class="delete">-auth.settings.login_methods.append(pam_auth())</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-##### LDAP</div><div class="delete">-``LDAP``:inxx</div><div class="delete">-</div><div class="delete">-Authentication using LDAP works very much as in the previous cases.</div><div class="delete">-</div><div class="delete">-To use LDAP login with MS Active Directory:``Active Directory``:inxx</div><div class="delete">-``</div><div class="delete">-from gluon.contrib.login_methods.ldap_auth import ldap_auth</div><div class="delete">-auth.settings.login_methods.append(ldap_auth(mode=&#x27;ad&#x27;,</div><div class="delete">-   server=&#x27;my.domain.controller&#x27;,</div><div class="delete">-   base_dn=&#x27;ou=Users,dc=domain,dc=com&#x27;))</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-To use LDAP login with Lotus Notes and Domino:``Lotus Notes``:inxx ``Domino``:inxx</div><div class="delete">-``</div><div class="delete">-auth.settings.login_methods.append(ldap_auth(mode=&#x27;domino&#x27;,</div><div class="delete">-   server=&#x27;my.domino.server&#x27;))</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-To use LDAP login with OpenLDAP (with UID):``OpenLDAP``:inxx</div><div class="delete">-``</div><div class="delete">-auth.settings.login_methods.append(ldap_auth(server=&#x27;my.ldap.server&#x27;,</div><div class="delete">-   base_dn=&#x27;ou=Users,dc=domain,dc=com&#x27;))</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-To use LDAP login with OpenLDAP (with CN):</div><div class="delete">-``</div><div class="delete">-auth.settings.login_methods.append(ldap_auth(mode=&#x27;cn&#x27;,</div><div class="delete">-   server=&#x27;my.ldap.server&#x27;, base_dn=&#x27;ou=Users,dc=domain,dc=com&#x27;))</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-##### Google App Engine</div><div class="delete">-``GAE login``:inxx</div><div class="delete">-</div><div class="delete">-Authentication using Google when running on Google App Engine requires skipping the web2py login form, being redirected to the Google login page, and back upon success. Because the behavior is different than in the previous examples, the API is a little different.</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-from gluon.contrib.login_methods.gae_google_login import GaeGoogleAccount</div><div class="delete">-auth.settings.login_form = GaeGoogleAccount()</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-##### OpenID</div><div class="delete">-``OpenID``:inxx</div><div class="delete">-</div><div class="delete">-We have previously discussed integration with Janrain (which has OpenID support) and that is the easiest way to use OpenID. Yet sometimes you do not want to rely on a third party service and you want to access the OpenID provider directly from the consumer (your app).</div><div class="delete">-</div><div class="delete">-Here is an example:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-from gluon.contrib.login_methods.openid_auth import OpenIDAuth</div><div class="delete">-auth.settings.login_form = OpenIDAuth(auth)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-``OpenIDAuth`` requires the &#x27;&#x27;python-openid&#x27;&#x27; module to be installed separately. Under the hood, this login method defines the following table:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-db.define_table(&#x27;alt_logins&#x27;,</div><div class="delete">-    Field(&#x27;username&#x27;, length=512, default=&#x27;&#x27;),</div><div class="delete">-    Field(&#x27;type&#x27;, length =128, default=&#x27;openid&#x27;, readable=False),</div><div class="delete">-    Field(&#x27;user&#x27;, self.table_user, readable=False))</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-which stores the openid usernames for each user. If you want to display the openids for the current logged in user:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-{{=auth.settings.login_form.list_user_openids()}}</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-##### OAuth2.0 and Facebook</div><div class="delete">-``OAuth``:inxx ``Facebook``:inxx</div><div class="delete">-</div><div class="delete">-We have previously discussed integration with Janrain (which has Facebook support), yet sometimes you do not want to rely on a third party service and you want to access a OAuth2.0 provider directly; for example, Facebook. Here is how:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-from gluon.contrib.login_methods.oauth20_account import OAuthAccount</div><div class="delete">-auth.settings.login_form=OAuthAccount(YOUR_CLIENT_ID,YOUR_CLIENT_SECRET)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Things get a little more complex if you want to use Facebook OAuth2.0 to login into a specific Facebook app to access its API, instead of your own app. Here is an example for accessing the Facebook Graph API.</div><div class="delete">-</div><div class="delete">-First of all you must install the [[Facebook Python SDK https://github.com/facebook/python-sdk]].</div><div class="delete">-</div><div class="delete">-Second, you need the following code in your model:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-## import required modules</div><div class="delete">-from facebook import GraphAPI</div><div class="delete">-from gluon.contrib.login_methods.oauth20_account import OAuthAccount</div><div class="delete">-## extend the OAUthAccount class</div><div class="delete">-class FaceBookAccount(OAuthAccount):</div><div class="delete">-    &quot;&quot;&quot;OAuth impl for Facebook&quot;&quot;&quot;</div><div class="delete">-    AUTH_URL=&quot;https://graph.facebook.com/oauth/authorize&quot;</div><div class="delete">-    TOKEN_URL=&quot;https://graph.facebook.com/oauth/access_token&quot;</div><div class="delete">-    def __init__(self, g):</div><div class="delete">-        OAuthAccount.__init__(self, g,</div><div class="delete">-                              YOUR_CLIENT_ID,</div><div class="delete">-                              YOUR_CLIENT_SECRET,</div><div class="delete">-                              self.AUTH_URL,</div><div class="delete">-                              self.TOKEN_URL)</div><div class="delete">-        self.graph = None</div><div class="delete">-    # override function that fetches user info</div><div class="delete">-    def get_user(self):</div><div class="delete">-        &quot;Returns the user using the Graph API&quot;</div><div class="delete">-        if not self.accessToken():</div><div class="delete">-            return None</div><div class="delete">-        if not self.graph:</div><div class="delete">-            self.graph = GraphAPI((self.accessToken()))</div><div class="delete">-        try:</div><div class="delete">-            user = self.graph.get_object(&quot;me&quot;)</div><div class="delete">-            return dict(first_name = user[&#x27;first_name&#x27;],</div><div class="delete">-                        last_name = user[&#x27;last_name&#x27;],</div><div class="delete">-                        username = user[&#x27;id&#x27;])</div><div class="delete">-        except GraphAPIError:</div><div class="delete">-            self.session.token = None</div><div class="delete">-            self.graph = None</div><div class="delete">-            return None</div><div class="delete">-## use the above class to build a new login form</div><div class="delete">-auth.settings.login_form=FaceBookAccount()</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-##### LinkedIn</div><div class="delete">-``LinkedIn``:inxx</div><div class="delete">-</div><div class="delete">-We have previously discussed integration with Janrain (which has LinkedIn support) and that is the easiest way to use OAuth. Yet sometime you do not want to rely on a third party service or you may want to access LinkedIn directly to get more information than Janrain provides.</div><div class="delete">-</div><div class="delete">-Here is an example:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-from gluon.contrib.login_methods.linkedin_account import LinkedInAccount</div><div class="delete">-auth.settings.login_form=LinkedInAccount(request,KEY,SECRET,RETURN_URL)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-``LinkedInAccount`` requires the &quot;python-linkedin&quot; module installed separately.</div><div class="delete">-</div><div class="delete">-##### X509</div><div class="delete">-</div><div class="delete">-You can also login by passing to the page an x509 certificate and your credential will be extracted from the certificate. This requires ``M2Crypto`` installed from</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-http://chandlerproject.org/bin/view/Projects/MeTooCrypto</div><div class="delete">-``</div><div class="delete">-</div><div class="delete">-Once you have M2Cryption installed you can do:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-from gluon.contrib.login_methods.x509_auth import X509Account</div><div class="delete">-auth.settings.actions_disabled=[&#x27;register&#x27;,&#x27;change_password&#x27;,&#x27;request_reset_password&#x27;]</div><div class="delete">-auth.settings.login_form = X509Account()</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-You can now authenticate into web2py passing your x509 certificate. How to do this is browser-dependent, but probably you are more likely to use certificates for web services. In this case you can use for example ``cURL`` to try out your authentication:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-curl -d &quot;firstName=John&amp;lastName=Smith&quot; -G -v --key private.key \</div><div class="delete">-     --cert  server.crt https://example/app/default/user/profile</div><div class="delete">-``</div><div class="delete">-</div><div class="delete">-This works out of the box with Rocket (the web2py built-in web server) but you may need some extra configuration work on the web server side if you are using a different web server. In particular you need to tell your web server where the certificates are located on local host and that it needs to verify certificates coming from the clients. How to do it is web server dependent and therefore omitted here.</div><div class="delete">-</div><div class="delete">-##### Multiple login forms</div><div class="delete">-</div><div class="delete">-Some login methods modify the login_form, some do not. When they do that, they may not be able to coexist. Yet some coexist by providing multiple login forms in the same page. web2py provides a way to do it. Here is an example mixing normal login (auth) and RPX login (janrain.com):</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-from gluon.contrib.login_methods.extended_login_form import ExtendedLoginForm</div><div class="delete">-other_form = RPXAccount(request, api_key=&#x27;...&#x27;, domain=&#x27;...&#x27;, url=&#x27;...&#x27;)</div><div class="delete">-auth.settings.login_form = ExtendedLoginForm(auth, other_form, signals=[&#x27;token&#x27;])</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-If signals are set and a parameter in request matches any signals,</div><div class="delete">-it will return the call of ``other_form.login_form`` instead.</div><div class="delete">-``other_form`` can handle some particular situations, for example,</div><div class="delete">-multiple steps of OpenID login inside ``other_form.login_form``.</div><div class="delete">-</div><div class="delete">-Otherwise it will render the normal login form together with the ``other_form``.</div><div class="delete">-</div><div class="delete">-#### Record versioning</div><div class="delete">-</div><div class="delete">-You can use Auth to enable full record versioning:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-db.enable_record_versioning(db,</div><div class="delete">-    archive_db=None,</div><div class="delete">-    archive_names=&#x27;%(tablename)s_archive&#x27;,</div><div class="delete">-    current_record=&#x27;current_record&#x27;):</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-This tells web2py to create an archive table for each of the tables in ``db`` and store a copy of each record when modified. The old copy is stored. The new copy is not.</div><div class="delete">-</div><div class="delete">-The last three parameters are optional:</div><div class="delete">-</div><div class="delete">-- ``archive_db`` allows to specify another database where the archive tables are to be stored. Setting it to ``None`` is the same as setting it to ``db``.</div><div class="delete">-- ``archive_names`` provides a pattern for naming each archive table.</div><div class="delete">-- ``current_record`` specified the name of the reference field to be used in the archive table to refer to the original, unmodified, record. Notice that ``archive_db!=db`` then the reference field is just an integer field since cross database references are not possible.</div><div class="delete">-</div><div class="delete">-</div><div class="delete">-Only tables with ``modified_by`` and ``modified_on`` fields (as created</div><div class="delete">-for example by auth.signature) will be archived.</div><div class="delete">-</div><div class="delete">-When you ``enable_record_versioning``, if records have an </div><div class="delete">-``is_active`` field (also created by auth.signature), </div><div class="delete">-records will never be deleted but they will be marked with ``is_active=False``.</div><div class="delete">-In fact, ``enable_record_versioning`` adds a ``common_filter`` to </div><div class="delete">-every versioned table that filters out records with ``is_active=False`` so they essentially become invisible.</div><div class="delete">-</div><div class="delete">-If you ``enable_record_versioning``, you should not use </div><div class="delete">-``auth.archive`` or ``crud.archive`` else you will end up with duplicate records.</div><div class="delete">-Those functions do explicitly what ``enable_record_versioning`` does automatically and</div><div class="delete">-they will be deprecated.</div><div class="delete">-</div><div class="delete">-</div><div class="delete">-#### ``Mail`` and ``Auth``</div><div class="delete">-</div><div class="delete">-One can define a mailer with</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-from gluon.tools import Mail</div><div class="delete">-mail = Mail()</div><div class="delete">-mail.settings.server = &#x27;smtp.example.com:25&#x27;</div><div class="delete">-mail.settings.sender = &#x27;you@example.com&#x27;</div><div class="delete">-mail.settings.login = &#x27;username:password&#x27;</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-</div><div class="delete">-or simply use the mailer provided by ``auth``:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-mail = auth.settings.mailer</div><div class="delete">-mail.settings.server = &#x27;smtp.example.com:25&#x27;</div><div class="delete">-mail.settings.sender = &#x27;you@example.com&#x27;</div><div class="delete">-mail.settings.login = &#x27;username:password&#x27;</div><div class="delete">-``</div><div class="delete">-</div><div class="delete">-You need to replace the mail.settings with the proper parameters for your SMTP server. Set ``mail.settings.login = None`` if the SMTP server does not require authentication.</div><div class="delete">-</div><div class="delete">-You can read more about web2py API for emails and email configuration in Chapter 8. Here we limit the discussion to the interaction between ``Mail`` and ``Auth``.</div><div class="delete">-</div><div class="delete">-In ``Auth``, by default, email verification is disabled.</div><div class="delete">-To enable email, append the following lines in the model where ``auth`` is defined:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.settings.registration_requires_verification = True</div><div class="delete">-auth.settings.registration_requires_approval = False</div><div class="delete">-auth.settings.reset_password_requires_verification = True</div><div class="delete">-auth.messages.verify_email = &#x27;Click on the link http://&#x27; + \</div><div class="delete">-    request.env.http_host + \</div><div class="delete">-    URL(r=request,c=&#x27;default&#x27;,f=&#x27;user&#x27;,args=[&#x27;verify_email&#x27;]) + \</div><div class="delete">-    &#x27;/%(key)s to verify your email&#x27;</div><div class="delete">-auth.messages.reset_password = &#x27;Click on the link http://&#x27; + \</div><div class="delete">-    request.env.http_host + \</div><div class="delete">-    URL(r=request,c=&#x27;default&#x27;,f=&#x27;user&#x27;,args=[&#x27;reset_password&#x27;]) + \</div><div class="delete">-    &#x27;/%(key)s to reset your password&#x27;</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-In the two ``auth.messages`` above, you may need to replace the URL portion of the string with the proper complete URL of the action. This is necessary because web2py may be installed behind a proxy, and it cannot determine its own public URLs with absolute certainty. The above examples (which are the default values) should, however, work in most cases.</div><div class="delete">-</div><div class="delete">-### Authorization</div><div class="delete">-</div><div class="delete">-Once a new user is registered, a new group is created to contain the user. The role of the new user is conventionally &quot;user_[id]&quot; where [id] is the id of the newly created user. The creation of the group can be disabled with</div><div class="delete">-``</div><div class="delete">-auth.settings.create_user_groups = None</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-although we do not suggest doing so. Notice that ``create_user_groups`` is not a boolean (althought it can be ``False``) but it defaults to:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.settings.create_user_groups=&quot;user_%(id)s&quot;</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-It store a template for the name of the group created for user ``id``.</div><div class="delete">-</div><div class="delete">-Users have membership in groups. Each group is identified by a name/role. Groups have permissions. Users have permissions because of the groups they belong to. By default each user is made member of their own group.</div><div class="delete">-</div><div class="delete">-You can also also do</div><div class="delete">-``</div><div class="delete">-auth.settings.everybody_group_id = 5</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-to make any new user automatically member of group number 5. Here 5 is used as an example and we assume the group was created already.</div><div class="delete">-</div><div class="delete">-You can create groups, give membership and permissions via **appadmin**</div><div class="delete">-or programmatically using the following methods:</div><div class="delete">-``</div><div class="delete">-auth.add_group(&#x27;role&#x27;, &#x27;description&#x27;)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-returns the id of the newly created group.</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.del_group(group_id)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-deletes the group with ``group_id``.</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.del_group(auth.id_group(&#x27;user_7&#x27;))</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-deletes the group with role &quot;user_7&quot;, i.e., the group uniquely associated to user number 7.</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.user_group(user_id)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-returns the id of the group uniquely associated to the user identified by ``user_id``.</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.add_membership(group_id, user_id)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-gives ``user_id`` membership of the group ``group_id``.</div><div class="delete">-If the ``user_id`` is not specified, then web2py assumes the current logged-in user.</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.del_membership(group_id, user_id)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-revokes ``user_id`` membership of the group ``group_id``.</div><div class="delete">-If the ``user_id`` is not specified, then web2py assumes the current logged-in user.</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.has_membership(group_id, user_id, role)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-checks whether ``user_id`` has membership of the group ``group_id`` or the group with the specified role. Only ``group_id`` or ``role`` should be passed to the function, not both. If the ``user_id`` is not specified, then web2py assumes the current logged-in user.</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.add_permission(group_id, &#x27;name&#x27;, &#x27;object&#x27;, record_id)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-gives permission &quot;name&quot; (user defined) on the object &quot;object&quot; (also user defined) to members of the group ``group_id``. If &quot;object&quot; is a tablename then the permission can refer to the entire table by setting ``record_id`` to a value of zero, or the permission can refer to a specific record by specifying a ``record_id`` value greater than zero. When giving permissions on tables, it is common to use a permission name in the set (&#x27;create&#x27;, &#x27;read&#x27;, &#x27;update&#x27;, &#x27;delete&#x27;, &#x27;select&#x27;) since these permissions are understood and can be enforced by the CRUD APIs.</div><div class="delete">-</div><div class="delete">-If ``group_id`` is zero, web2py uses the group uniquely associated to the current logged-in user.</div><div class="delete">-</div><div class="delete">-You can also use ``auth.id_group(role=&quot;...&quot;)`` to get the id of a group given its name. ``id_group``:inxx</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.del_permission(group_id, &#x27;name&#x27;, &#x27;object&#x27;, record_id)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-revokes the permission.</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.has_permission(&#x27;name&#x27;, &#x27;object&#x27;, record_id, user_id)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-checks whether the user identified by ``user_id`` has membership in a group with the requested permission.</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-rows = db(auth.accessible_query(&#x27;read&#x27;, db.mytable, user_id))\</div><div class="delete">-    .select(db.mytable.ALL)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-returns all rows of table &quot;mytable&quot; that user ``user_id`` has &quot;read&quot; permission on.</div><div class="delete">-If the ``user_id`` is not specified, then web2py assumes the current logged-in user.</div><div class="delete">-The ``accessible_query(...)`` can be combined with other queries to make more complex ones.</div><div class="delete">-``accessible_query(...)`` is the only **Auth** method to require a JOIN, so it does not work on the Google App Engine.</div><div class="delete">-</div><div class="delete">-Assuming the following definitions:</div><div class="delete">-``</div><div class="delete">-&gt;&gt;&gt; from gluon.tools import Auth</div><div class="delete">-&gt;&gt;&gt; auth = Auth(db)</div><div class="delete">-&gt;&gt;&gt; auth.define_tables()</div><div class="delete">-&gt;&gt;&gt; secrets = db.define_table(&#x27;document&#x27;, Field(&#x27;body&#x27;))</div><div class="delete">-&gt;&gt;&gt; james_bond = db.auth_user.insert(first_name=&#x27;James&#x27;,</div><div class="delete">-                                     last_name=&#x27;Bond&#x27;)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Here is an example:</div><div class="delete">-``</div><div class="delete">-&gt;&gt;&gt; doc_id = db.document.insert(body = &#x27;top secret&#x27;)</div><div class="delete">-&gt;&gt;&gt; agents = auth.add_group(role = &#x27;Secret Agent&#x27;)</div><div class="delete">-&gt;&gt;&gt; auth.add_membership(agents, james_bond)</div><div class="delete">-&gt;&gt;&gt; auth.add_permission(agents, &#x27;read&#x27;, secrets)</div><div class="delete">-&gt;&gt;&gt; print auth.has_permission(&#x27;read&#x27;, secrets, doc_id, james_bond)</div><div class="delete">-True</div><div class="delete">-&gt;&gt;&gt; print auth.has_permission(&#x27;update&#x27;, secrets, doc_id, james_bond)</div><div class="delete">-False</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-#### Decorators</div><div class="delete">-</div><div class="delete">-The most common way to check permission is not by explicit calls to the above methods, but by decorating functions so that permissions are checked relative to the logged-in visitor. Here are some examples:</div><div class="delete">-``</div><div class="delete">-def function_one():</div><div class="delete">-    return &#x27;this is a public function&#x27;</div><div class="delete">-</div><div class="delete">-@auth.requires_login()</div><div class="delete">-def function_two():</div><div class="delete">-    return &#x27;this requires login&#x27;</div><div class="delete">-</div><div class="delete">-@auth.requires_membership(&#x27;agents&#x27;)</div><div class="delete">-def function_three():</div><div class="delete">-    return &#x27;you are a secret agent&#x27;</div><div class="delete">-</div><div class="delete">-@auth.requires_permission(&#x27;read&#x27;, secrets)</div><div class="delete">-def function_four():</div><div class="delete">-    return &#x27;you can read secret documents&#x27;</div><div class="delete">-</div><div class="delete">-@auth.requires_permission(&#x27;delete&#x27;, &#x27;any file&#x27;)</div><div class="delete">-def function_five():</div><div class="delete">-    import os</div><div class="delete">-    for file in os.listdir(&#x27;./&#x27;):</div><div class="delete">-        os.unlink(file)</div><div class="delete">-    return &#x27;all files deleted&#x27;</div><div class="delete">-</div><div class="delete">-@auth.requires(auth.user_id==1 or request.client==&#x27;127.0.0.1&#x27;, requires_login=True)</div><div class="delete">-def function_six():</div><div class="delete">-    return &#x27;you can read secret documents&#x27;</div><div class="delete">-</div><div class="delete">-@auth.requires_permission(&#x27;add&#x27;, &#x27;number&#x27;)</div><div class="delete">-def add(a, b):</div><div class="delete">-    return a + b</div><div class="delete">-</div><div class="delete">-def function_seven():</div><div class="delete">-    return add(3, 4)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-The condition argument of ``@auth.requires(condition)`` can be a callable and unless the condition is simple, it better to pass a callable than a condition since this will be faster, as the condition will only be evaluated if needed. For example</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-@auth.requires(lambda: check_condition())</div><div class="delete">-def action():</div><div class="delete">-    ....</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-``@auth.requires`` also takes an optional argument ``requires_login`` which defaults to ``True``. If set to False, it does not require login before evaluating the condition as true/false. The condition can be a boolean value or a function evaluating to boolean.</div><div class="delete">-</div><div class="delete">-Note that access to all functions apart from the first one is restricted based on permissions that the visitor may or may not have.</div><div class="delete">-</div><div class="delete">-If the visitor is not logged in, then the permission cannot be checked; the visitor is redirected to the login page and then back to the page that requires permissions.</div><div class="delete">-</div><div class="delete">-#### Combining requirements</div><div class="delete">-</div><div class="delete">-Occasionally, it is necessary to combine requirements. This can be done via a generic ``requires`` decorator which takes a single argument, a true or false condition. For example, to give access to agents, but only on Tuesday:</div><div class="delete">-``</div><div class="delete">-@auth.requires(auth.has_membership(group_id=agents) \</div><div class="delete">-               and request.now.weekday()==1)</div><div class="delete">-def function_seven():</div><div class="delete">-    return &#x27;Hello agent, it must be Tuesday!&#x27;</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-or equivalently:</div><div class="delete">-``</div><div class="delete">-@auth.requires(auth.has_membership(role=&#x27;Secret Agent&#x27;) \</div><div class="delete">-               and request.now.weekday()==1)</div><div class="delete">-def function_seven():</div><div class="delete">-    return &#x27;Hello agent, it must be Tuesday!&#x27;</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-#### Authorization and CRUD</div><div class="delete">-</div><div class="delete">-Using decorators and/or explicit checks provides one way to implement access control.</div><div class="delete">-</div><div class="delete">-Another way to implement access control is to always use CRUD (as opposed to ``SQLFORM``) to access the database and to ask CRUD to enforce access control on database tables and records. This is done by linking ``Auth`` and CRUD with the following statement:</div><div class="delete">-``</div><div class="delete">-crud.settings.auth = auth</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-This will prevent the visitor from accessing any of the CRUD functions unless the visitor is logged in and has explicit access. For example, to allow a visitor to post comments, but only update their own comments (assuming crud, auth and db.comment are defined):</div><div class="delete">-``</div><div class="delete">-def give_create_permission(form):</div><div class="delete">-    group_id = auth.id_group(&#x27;user_%s&#x27; % auth.user.id)</div><div class="delete">-    auth.add_permission(group_id, &#x27;read&#x27;, db.comment)</div><div class="delete">-    auth.add_permission(group_id, &#x27;create&#x27;, db.comment)</div><div class="delete">-    auth.add_permission(group_id, &#x27;select&#x27;, db.comment)</div><div class="delete">-</div><div class="delete">-def give_update_permission(form):</div><div class="delete">-    comment_id = form.vars.id</div><div class="delete">-    group_id = auth.id_group(&#x27;user_%s&#x27; % auth.user.id)</div><div class="delete">-    auth.add_permission(group_id, &#x27;update&#x27;, db.comment, comment_id)</div><div class="delete">-    auth.add_permission(group_id, &#x27;delete&#x27;, db.comment, comment_id)</div><div class="delete">-</div><div class="delete">-auth.settings.register_onaccept = give_create_permission</div><div class="delete">-crud.settings.auth = auth</div><div class="delete">-</div><div class="delete">-def post_comment():</div><div class="delete">-   form = crud.create(db.comment, onaccept=give_update_permission)</div><div class="delete">-   comments = db(db.comment).select()</div><div class="delete">-   return dict(form=form, comments=comments)</div><div class="delete">-</div><div class="delete">-def update_comment():</div><div class="delete">-   form = crud.update(db.comment, request.args(0))</div><div class="delete">-   return dict(form=form)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-You can also select specific records (those you have &#x27;read&#x27; access to):</div><div class="delete">-``</div><div class="delete">-def post_comment():</div><div class="delete">-   form = crud.create(db.comment, onaccept=give_update_permission)</div><div class="delete">-   query = auth.accessible_query(&#x27;read&#x27;, db.comment, auth.user.id)</div><div class="delete">-   comments = db(query).select(db.comment.ALL)</div><div class="delete">-   return dict(form=form, comments=comments)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-The permissions names enforced by :</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-crud.settings.auth = auth</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-are &quot;read&quot;, &quot;create&quot;, &quot;update&quot;, &quot;delete&quot;, &quot;select&quot;, &quot;impersonate&quot;.</div><div class="delete">-</div><div class="delete">-#### Authorization and downloads</div><div class="delete">-</div><div class="delete">-The use of decorators and the use of ``crud.settings.auth`` do not enforce authorization on files downloaded by the usual download function</div><div class="delete">-``</div><div class="delete">-def download(): return response.download(request, db)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-If one wishes to do so, one must declare explicitly which &quot;upload&quot; fields contain files that need access control upon download.</div><div class="delete">-For example:</div><div class="delete">-``</div><div class="delete">-db.define_table(&#x27;dog&#x27;,</div><div class="delete">-   Field(&#x27;small_image&#x27;, &#x27;upload&#x27;),</div><div class="delete">-   Field(&#x27;large_image&#x27;, &#x27;upload&#x27;))</div><div class="delete">-</div><div class="delete">-db.dog.large_image.authorization = lambda record: \</div><div class="delete">-   auth.is_logged_in() and \</div><div class="delete">-   auth.has_permission(&#x27;read&#x27;, db.dog, record.id, auth.user.id)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-The attribute ``authorization`` of upload field can be None (the default) or a function that decides whether the user is logged in and has permission to &#x27;read&#x27; the current record. In this example, there is no restriction on downloading images linked by the &quot;small_image&quot; field, but we require access control on images linked by the &quot;large_image&quot; field.</div><div class="delete">-</div><div class="delete">-</div><div class="delete">-#### Access Control and Basic Authentication</div><div class="delete">-</div><div class="delete">-Occasionally, it may be necessary to expose actions that have decorators that require access control as services; i.e., to call them from a program or script and still be able to use authentication to check for authorization.</div><div class="delete">-</div><div class="delete">-**Auth** enables login via basic authentication:</div><div class="delete">-``</div><div class="delete">-auth.settings.allow_basic_login = True</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-With this set, an action like</div><div class="delete">-``</div><div class="delete">-@auth.requires_login()</div><div class="delete">-def give_me_time():</div><div class="delete">-    import time</div><div class="delete">-    return time.ctime()</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-can be called, for example, from a shell command:</div><div class="delete">-``</div><div class="delete">-wget --user=[username] --password=[password]</div><div class="delete">-    http://.../[app]/[controller]/give_me_time</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-It is also possible to log in by calling ``auth.basic()`` rather than using an ``@auth`` decorator:</div><div class="delete">-``</div><div class="delete">-def give_me_time():</div><div class="delete">-    import time</div><div class="delete">-    auth.basic()</div><div class="delete">-    if auth.user:</div><div class="delete">-        return time.ctime()</div><div class="delete">-    else:</div><div class="delete">-        return &#x27;Not authorized&#x27;</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Basic login is often the only option for services (described in the next chapter), but it is disabled by default.</div><div class="delete">-</div><div class="delete">-#### Manual Authentication</div><div class="delete">-</div><div class="delete">-Some times you want to implement your own logic and do &quot;manual&quot; user login.</div><div class="delete">-This can also be done by calling the function:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-user = auth.login_bare(username,password)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-``login_bare`` returns user if the user exists and the password is valid, else it returns False. ``username`` is the email if the &quot;auth_user&quot; table does not have a &quot;username&quot; field.</div><div class="delete">-</div><div class="delete">-#### Settings and messages</div><div class="delete">-</div><div class="delete">-Here is a list of all parameters that can be customized for **Auth**</div><div class="delete">-</div><div class="delete">-The following must point to a ``gluon.tools.Mail`` object to allow ``auth`` to send emails:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.settings.mailer = None</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-The following must be the name of the controller that defined the ``user`` action:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.settings.controller = &#x27;default&#x27;</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-The following is a very important setting:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.settings.hmac_key = None</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-It must be set to something like &quot;sha512:a-pass-phrase&quot; and it will be passed to the CRYPT validator for the &quot;password&quot; field of the ``auth_user`` table. It will be the algorithm and a-pass-phrase used to hash the passwords.</div><div class="delete">-</div><div class="delete">-By default, auth also requires a minimum password length of 4. This can be changed:</div><div class="delete">-``</div><div class="delete">-auth.settings.password_min_length = 4</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-To disabled an action append its name to this list:</div><div class="delete">-``</div><div class="delete">-auth.settings.actions_disabled = []</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-For example:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.settings.actions_disabled.append(&#x27;register&#x27;)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-will disable registration.</div><div class="delete">-</div><div class="delete">-If you want to receive an email to verify registration set this to ``True``:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.settings.registration_requires_verification = False</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-To automatically login people after registration, even if they have not completed the email verification process, set the following to ``True``:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.settings.login_after_registration = False</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-If new registrants must wait for approval before being able to login set this to ``True``:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.settings.registration_requires_approval = False</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Approval consists of setting ``registration_key==&#x27;&#x27;`` via appadmin or programmatically.</div><div class="delete">-</div><div class="delete">-If you do not want a new group for each new user set the following to ``False``:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.settings.create_user_groups = True</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-The following settings determine alternative login methods and login forms, as discussed previously:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.settings.login_methods = [auth]</div><div class="delete">-auth.settings.login_form = auth</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Do you want to allow basic login?</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.settings.allows_basic_login = False</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-</div><div class="delete">-The following is the URL of the ``login`` action:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.settings.login_url = URL(&#x27;user&#x27;, args=&#x27;login&#x27;)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-If the user tried to access the register page but is already logged in, he will be redirected to this URL:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.settings.logged_url = URL(&#x27;user&#x27;, args=&#x27;profile&#x27;)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-This must point to the URL of the download action, in case the profile contains images:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.settings.download_url = URL(&#x27;download&#x27;)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-These must point to the URL you want to redirect your users to after the various possible ``auth`` actions (in case there is no referrer):</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.settings.login_next = URL(&#x27;index&#x27;)</div><div class="delete">-auth.settings.logout_next = URL(&#x27;index&#x27;)</div><div class="delete">-auth.settings.profile_next = URL(&#x27;index&#x27;)</div><div class="delete">-auth.settings.register_next = URL(&#x27;user&#x27;, args=&#x27;login&#x27;)</div><div class="delete">-auth.settings.retrieve_username_next = URL(&#x27;index&#x27;)</div><div class="delete">-auth.settings.retrieve_password_next = URL(&#x27;index&#x27;)</div><div class="delete">-auth.settings.change_password_next = URL(&#x27;index&#x27;)</div><div class="delete">-auth.settings.request_reset_password_next = URL(&#x27;user&#x27;, args=&#x27;login&#x27;)</div><div class="delete">-auth.settings.reset_password_next = URL(&#x27;user&#x27;, args=&#x27;login&#x27;)</div><div class="delete">-auth.settings.verify_email_next = URL(&#x27;user&#x27;, args=&#x27;login&#x27;)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-If the visitor is not logger in, and calls a function that requires authentication,</div><div class="delete">-the user is redirected to ``auth.settings.login_url`` which defaults to ``URL(&#x27;default&#x27;,&#x27;user/login&#x27;)``.</div><div class="delete">-One can replace this behavior by redefining:</div><div class="delete">-``on_failed_authentication``:inxx</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.settings.on_failed_authentication = lambda url: redirect(url)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-This is the function called for the redirection. The argument ``url``` passed to this function is the url for the login page.</div><div class="delete">-</div><div class="delete">-If the visitor does not have permission to access a given function, the visitor is redirect to the URL defined by</div><div class="delete">-``on_failed_authorization``:inxx</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.settings.on_failed_authorization = \</div><div class="delete">-    URL(&#x27;user&#x27;,args=&#x27;on_failed_authorization&#x27;)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-You can change this variable and redirect the user elsewhere.</div><div class="delete">-</div><div class="delete">-Often ``on_failed_authorization`` is a URL but it can be a function that returns the URL and it will be called on failed authorization.</div><div class="delete">-</div><div class="delete">-These are lists of callbacks that should be executed after form validation for each of the corresponding action before any database IO:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.settings.login_onvalidation = []</div><div class="delete">-auth.settings.register_onvalidation = []</div><div class="delete">-auth.settings.profile_onvalidation = []</div><div class="delete">-auth.settings.retrieve_password_onvalidation = []</div><div class="delete">-auth.settings.reset_password_onvalidation = []</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Each callback must be a function that takes the ``form`` object and it can modify the attributes of the form object before database IO is performed.</div><div class="delete">-</div><div class="delete">-These are lists of callbacks that should be executed after the database IO is performed and before redirection:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.settings.login_onaccept = []</div><div class="delete">-auth.settings.register_onaccept = []</div><div class="delete">-auth.settings.profile_onaccept = []</div><div class="delete">-auth.settings.verify_email_onaccept = []</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Here is an example:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.settings.register_onaccept.append(lambda form:\</div><div class="delete">-   mail.send(to=&#x27;you@example.com&#x27;,subject=&#x27;new user&#x27;,</div><div class="delete">-             message=&#x27;new user email is %s&#x27;%form.vars.email))</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-You can enable captcha for any of the ``auth`` actions:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.settings.captcha = None</div><div class="delete">-auth.settings.login_captcha = None</div><div class="delete">-auth.settings.register_captcha = None</div><div class="delete">-auth.settings.retrieve_username_captcha = None</div><div class="delete">-auth.settings.retrieve_password_captcha = None</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-If the ``.captcha`` settings points to a ``gluon.tools.Recaptcha``, all forms for which the corresponding option (like ``.login_captcha``) is set to ``None`` will have a captcha, while those for which the corresponding option is set to ``False`` will not. If, instead, ``.captcha`` is set to ``None``, only those form who have a corresponding option set to a ``gluon.tools.Recaptcha`` object will have captcha and the others will not.</div><div class="delete">-</div><div class="delete">-This is the login session expiration time:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.settings.expiration = 3600  # seconds</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-You can change the name of the password field (in Firebird for example &quot;password&quot; is a keyword and cannot be used to name a field):</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.settings.password_field = &#x27;password&#x27;</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-</div><div class="delete">-Normally the login form tries to validate an email. This can be disabled by changing this setting:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.settings.login_email_validate = True</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Do you want to show the record id in the edit profile page?</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.settings.showid = False</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-For custom forms you may want to disable automatic error notification in forms:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.settings.hideerror = False</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-Also for custom forms you can change the style:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.settings.formstyle = &#x27;table3cols&#x27;</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-(it can be &quot;table2cols&quot;, &quot;divs&quot; and &quot;ul&quot;)</div><div class="delete">-</div><div class="delete">-And you can set the separator for auth-generated forms:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.settings.label_separator =	&#x27;:&#x27;</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-</div><div class="delete">-By default the login form gives the option to extend the login via &quot;remember me&quot; option. The expiration time can be changed or the option disabled via these settings:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-auth.settings.long_expiration = 3600*24*30 # one month</div><div class="delete">-auth.settings.remember_me_form = True</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-You can also customize the following messages whose use and context should be obvious:</div><div class="delete">-``</div><div class="delete">-auth.messages.submit_button = &#x27;Submit&#x27;</div><div class="delete">-auth.messages.verify_password = &#x27;Verify Password&#x27;</div><div class="delete">-auth.messages.delete_label = &#x27;Check to delete:&#x27;</div><div class="delete">-auth.messages.function_disabled = &#x27;Function disabled&#x27;</div><div class="delete">-auth.messages.access_denied = &#x27;Insufficient privileges&#x27;</div><div class="delete">-auth.messages.registration_verifying = &#x27;Registration needs verification&#x27;</div><div class="delete">-auth.messages.registration_pending = &#x27;Registration is pending approval&#x27;</div><div class="delete">-auth.messages.login_disabled = &#x27;Login disabled by administrator&#x27;</div><div class="delete">-auth.messages.logged_in = &#x27;Logged in&#x27;</div><div class="delete">-auth.messages.email_sent = &#x27;Email sent&#x27;</div><div class="delete">-auth.messages.unable_to_send_email = &#x27;Unable to send email&#x27;</div><div class="delete">-auth.messages.email_verified = &#x27;Email verified&#x27;</div><div class="delete">-auth.messages.logged_out = &#x27;Logged out&#x27;</div><div class="delete">-auth.messages.registration_successful = &#x27;Registration successful&#x27;</div><div class="delete">-auth.messages.invalid_email = &#x27;Invalid email&#x27;</div><div class="delete">-auth.messages.unable_send_email = &#x27;Unable to send email&#x27;</div><div class="delete">-auth.messages.invalid_login = &#x27;Invalid login&#x27;</div><div class="delete">-auth.messages.invalid_user = &#x27;Invalid user&#x27;</div><div class="delete">-auth.messages.is_empty = &quot;Cannot be empty&quot;</div><div class="delete">-auth.messages.mismatched_password = &quot;Password fields don&#x27;t match&quot;</div><div class="delete">-auth.messages.verify_email = ...</div><div class="delete">-auth.messages.verify_email_subject = &#x27;Password verify&#x27;</div><div class="delete">-auth.messages.username_sent = &#x27;Your username was emailed to you&#x27;</div><div class="delete">-auth.messages.new_password_sent = &#x27;A new password was emailed to you&#x27;</div><div class="delete">-auth.messages.password_changed = &#x27;Password changed&#x27;</div><div class="delete">-auth.messages.retrieve_username = &#x27;Your username is: %(username)s&#x27;</div><div class="delete">-auth.messages.retrieve_username_subject = &#x27;Username retrieve&#x27;</div><div class="delete">-auth.messages.retrieve_password = &#x27;Your password is: %(password)s&#x27;</div><div class="delete">-auth.messages.retrieve_password_subject = &#x27;Password retrieve&#x27;</div><div class="delete">-auth.messages.reset_password = ...</div><div class="delete">-auth.messages.reset_password_subject = &#x27;Password reset&#x27;</div><div class="delete">-auth.messages.invalid_reset_password = &#x27;Invalid reset password&#x27;</div><div class="delete">-auth.messages.profile_updated = &#x27;Profile updated&#x27;</div><div class="delete">-auth.messages.new_password = &#x27;New password&#x27;</div><div class="delete">-auth.messages.old_password = &#x27;Old password&#x27;</div><div class="delete">-auth.messages.group_description = \</div><div class="delete">-    &#x27;Group uniquely assigned to user %(id)s&#x27;</div><div class="delete">-auth.messages.register_log = &#x27;User %(id)s Registered&#x27;</div><div class="delete">-auth.messages.login_log = &#x27;User %(id)s Logged-in&#x27;</div><div class="delete">-auth.messages.logout_log = &#x27;User %(id)s Logged-out&#x27;</div><div class="delete">-auth.messages.profile_log = &#x27;User %(id)s Profile updated&#x27;</div><div class="delete">-auth.messages.verify_email_log = &#x27;User %(id)s Verification email sent&#x27;</div><div class="delete">-auth.messages.retrieve_username_log = &#x27;User %(id)s Username retrieved&#x27;</div><div class="delete">-auth.messages.retrieve_password_log = &#x27;User %(id)s Password retrieved&#x27;</div><div class="delete">-auth.messages.reset_password_log = &#x27;User %(id)s Password reset&#x27;</div><div class="delete">-auth.messages.change_password_log = &#x27;User %(id)s Password changed&#x27;</div><div class="delete">-auth.messages.add_group_log = &#x27;Group %(group_id)s created&#x27;</div><div class="delete">-auth.messages.del_group_log = &#x27;Group %(group_id)s deleted&#x27;</div><div class="delete">-auth.messages.add_membership_log = None</div><div class="delete">-auth.messages.del_membership_log = None</div><div class="delete">-auth.messages.has_membership_log = None</div><div class="delete">-auth.messages.add_permission_log = None</div><div class="delete">-auth.messages.del_permission_log = None</div><div class="delete">-auth.messages.has_permission_log = None</div><div class="delete">-auth.messages.label_first_name = &#x27;First name&#x27;</div><div class="delete">-auth.messages.label_last_name = &#x27;Last name&#x27;</div><div class="delete">-auth.messages.label_username = &#x27;Username&#x27;</div><div class="delete">-auth.messages.label_email = &#x27;E-mail&#x27;</div><div class="delete">-auth.messages.label_password = &#x27;Password&#x27;</div><div class="delete">-auth.messages.label_registration_key = &#x27;Registration key&#x27;</div><div class="delete">-auth.messages.label_reset_password_key = &#x27;Reset Password key&#x27;</div><div class="delete">-auth.messages.label_registration_id = &#x27;Registration identifier&#x27;</div><div class="delete">-auth.messages.label_role = &#x27;Role&#x27;</div><div class="delete">-auth.messages.label_description = &#x27;Description&#x27;</div><div class="delete">-auth.messages.label_user_id = &#x27;User ID&#x27;</div><div class="delete">-auth.messages.label_group_id = &#x27;Group ID&#x27;</div><div class="delete">-auth.messages.label_name = &#x27;Name&#x27;</div><div class="delete">-auth.messages.label_table_name = &#x27;Table name&#x27;</div><div class="delete">-auth.messages.label_record_id = &#x27;Record ID&#x27;</div><div class="delete">-auth.messages.label_time_stamp = &#x27;Timestamp&#x27;</div><div class="delete">-auth.messages.label_client_ip = &#x27;Client IP&#x27;</div><div class="delete">-auth.messages.label_origin = &#x27;Origin&#x27;</div><div class="delete">-auth.messages.label_remember_me = &quot;Remember me (for 30 days)&quot;</div><div class="delete">-``:code</div><div class="delete">-``add|del|has`` membership logs allow the use of &quot;%(user_id)s&quot; and &quot;%(group_id)s&quot;.</div><div class="delete">-``add|del|has`` permission logs allow the use of &quot;%(user_id)s&quot;, &quot;%(name)s&quot;, &quot;%(table_name)s&quot;, and &quot;%(record_id)s&quot;.</div><div class="delete">-</div><div class="delete">-### Central Authentication Service</div><div class="delete">-``CAS``:inxx ``authentication``:inxx</div><div class="delete">-</div><div class="delete">-web2py provides support for third party authentication and single sign on.</div><div class="delete">-Here we discuss the Central Authentication Service (CAS) which is an industry standard and both client and server are built-into web2py.</div><div class="delete">-</div><div class="delete">-CAS is an open protocol for distributed authentication and it works in the following way: When a visitor arrives at our web site, our application check in the session if the user is already authenticated (for example via a ``session.token`` object). If the user is not authenticated, the controller redirects the visitor from the CAS appliance, where the user can log in, register, and manage his credentials (name, email and password). If the user registers, he receives an email, and registration is not complete until he responds to the email. Once the user has successfully registered and logged in, the CAS appliance redirects the user to our application together with a key. Our application uses the key to get the credentials of the user via an HTTP request in the background to the CAS server.</div><div class="delete">-</div><div class="delete">-Using this mechanism, multiple applications can use a single sign-on via a single CAS server. The server providing authentication is called a service provider. Applications seeking to authenticate visitors are called service consumers.</div><div class="delete">-</div><div class="delete">-CAS is similar to OpenID, with one main difference. In the case of OpenID, the visitor chooses the service provider. In the case of CAS, our application makes this choice, making CAS more secure.</div><div class="delete">-</div><div class="delete">-Running a web2py CAS provider is as easy as copying the scaffolding app. In fact any web2py app that exposes the action</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-## in provider app</div><div class="delete">-def user(): return dict(form=auth())</div><div class="delete">-``</div><div class="delete">-</div><div class="delete">-is a CAS 2.0 provider and its services can be accessed at the URL</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-http://.../provider/default/user/cas/login</div><div class="delete">-http://.../provider/default/user/cas/validate</div><div class="delete">-http://.../provider/default/user/cas/logout</div><div class="delete">-``:code</div><div class="delete">-(we assume the app to be called &quot;provider&quot;).</div><div class="delete">-</div><div class="delete">-You can access this service from any other web application (the consumer) by simply delegating authentication to the provider:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-## in consumer app</div><div class="delete">-auth = Auth(db,cas_provider = &#x27;http://127.0.0.1:8000/provider/default/user/cas&#x27;)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-When you visit the login url the consumer app, it will redirect you to the provider app which will perform authentication and will redirect back to the consumer. All processes of registration, logout, change password, retrieve password, have to be completed on the provider app. An entry about the logged-in user will be created on the consumer side so that you add extra fields and have a local profile. Thanks to CAS 2.0 all fields that are readable on the provider and have a corresponding field in the ``auth_user`` table of the consumer will be copied automatically.</div><div class="delete">-</div><div class="delete">-``Auth(...,cas_provider=&#x27;...&#x27;)`` works with third party providers and supports CAS 1.0 and 2.0. The version is detected automatically. By default it builds the URLs of the provider from a base (the ``cas_provider`` url above) by appending</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-/login</div><div class="delete">-/validate</div><div class="delete">-/logout</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-These can be changed in consumer and in provider</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-## in consumer or provider app (must match)</div><div class="delete">-auth.settings.cas_actions[&#x27;login&#x27;]=&#x27;login&#x27;</div><div class="delete">-auth.settings.cas_actions[&#x27;validate&#x27;]=&#x27;validate&#x27;</div><div class="delete">-auth.settings.cas_actions[&#x27;logout&#x27;]=&#x27;logout&#x27;</div><div class="delete">-``</div><div class="delete">-</div><div class="delete">-If you want to connect to a web2py CAS provider from a different domain, you must enable them by attending to the list of allowed domain:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-## in provider app</div><div class="delete">-auth.settings.cas_domains.append(&#x27;example.com&#x27;)</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-</div><div class="delete">-#### Using web2py to authorize non-web2py apps</div><div class="delete">-</div><div class="delete">-This is possible but dependent on the web server.</div><div class="delete">-here we assume two applications running under the same web server: Apache with ``mod_wsgi``.</div><div class="delete">-One of the applications is web2py with an app proving access control via Auth.</div><div class="delete">-The other can be a CGI script, a PHP program or anything else.</div><div class="delete">-We want to instruct the web server to ask permission to the former application when a client requests access to the latter.</div><div class="delete">-</div><div class="delete">-First of all we need to modify the web2py application and add the following controller:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-def check_access():</div><div class="delete">-    return &#x27;true&#x27; if auth.is_logged_in() else &#x27;false&#x27;</div><div class="delete">-``:code</div><div class="delete">-</div><div class="delete">-which returns ``true`` if the user is logged in and ``false`` otherwise. Now run a web2py process in background:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-nohup python web2py.py -a &#x27;&#x27; -p 8002</div><div class="delete">-``</div><div class="delete">-</div><div class="delete">-Port 8002 is a must and there is no need to enable admin so no admin password.</div><div class="delete">-</div><div class="delete">-Then we need to edit the Apache config file (for example &quot;/etc/apache2/sites-available/default&quot;) and instruct apache so that when the non-web2py program is called, it should call the above ``check`` action instead and only if it returns ``true`` it should proceed and respond to the request, else if should deny access.</div><div class="delete">-</div><div class="delete">-Because web2py and the non-web2py application run under the same domain, if the user is logged into the web2py app, the web2py session cookie will be passed to Apache even when the other app is requested and will allow credential verification.</div><div class="delete">-</div><div class="delete">-In order to achieve this we need a script, &quot;web2py/scripts/access.wsgi&quot; that can play this trick.</div><div class="delete">-The script ships with web2py. All we need to do it tell apache to call this script, the URL of the application needing access control, and the location of the script:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-&lt;VirtualHost *:80&gt;</div><div class="delete">-   WSGIDaemonProcess web2py user=www-data group=www-data</div><div class="delete">-   WSGIProcessGroup web2py</div><div class="delete">-   WSGIScriptAlias / /home/www-data/web2py/wsgihandler.py</div><div class="delete">-</div><div class="delete">-   AliasMatch ^myapp/path/needing/authentication/myfile /path/to/myfile</div><div class="delete">-   &lt;Directory /path/to/&gt;</div><div class="delete">-     WSGIAccessScript /path/to/web2py/scripts/access.wsgi</div><div class="delete">-   &lt;/Directory&gt;</div><div class="delete">-&lt;/VirtualHost&gt;</div><div class="delete">-``</div><div class="delete">-</div><div class="delete">-Here &quot;^myapp/path/needing/authentication/myfile&quot; is the regular expression that should match the incoming request and &quot;/path/to/&quot; is the absolute location of the web2py folder.</div><div class="delete">-</div><div class="delete">-The &quot;access.wsgi&quot; script contains the following line:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-URL_CHECK_ACCESS = &#x27;http://127.0.0.1:8002/%(app)s/default/check_access&#x27;</div><div class="delete">-``</div><div class="delete">-</div><div class="delete">-which points to the web2py application we have requested but you can edit it to point to a specific application, running on a port other than 8002.</div><div class="delete">-</div><div class="delete">-You can also change the ``check_access()`` action and make its logic more complex. This action can retrieve the URL that was originally requested using the environment variable</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-request.env.request_uri</div><div class="delete">-``</div><div class="delete">-</div><div class="delete">-and you can implement more complex rules:</div><div class="delete">-</div><div class="delete">-``</div><div class="delete">-def check_access():</div><div class="delete">-    if not auth.is_logged_in():</div><div class="delete">-       return &#x27;false&#x27;</div><div class="delete">-    elif not user_has_access(request.env.request_uri):</div><div class="delete">-       return &#x27;false&#x27;</div><div class="delete">-    else:</div><div class="delete">-       return &#x27;true&#x27;</div><div class="delete">-``:code</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/e234f6edf67361b3ba718ea10184ba8e7c2f773d">e234f6e</a><ul><li>Date : 2012-12-20</li><li>lots of improvements</li></ul></li></ul>
<div class="row-fluid" id="com_e234f6edf67361b3ba718ea10184ba8e7c2f773d">
    <div class="span6"><div class="diff"><div class="insert">+Auth has an optional ``secure=True`` argument, which will force authenticated pages to go over HTTPS. ``https``:inxx</div><div class="insert">+</div><div class=""> -------</div><div class=""> The ``password`` field of the ``db.auth_user`` table defaults to a ``CRYPT`` validator, which needs and ``hmac_key``. On legacy web2py applications you may see an extra argument passed to the Auth constructor: ``hmac_key = Auth.get_or_create_key()``. The latter is a function that read the hmac kay from a file &quot;private/auth.key&quot; within the application folder. If the file does not exist it creates a random ``hmac_key``. If multiple apps share the same auth database, make sure they also use the same ``hmac_key``. This is no loger necessary for new applications since passwords are salted with an individual random salt.</div><div class=""> -------</div><div class=""> </div><div class=""> By default, web2py uses email for login. If instead you want to log in using username set ``auth.define_tables(username=True)``</div><div class=""> </div><div class=""> If multiple apps share the same auth database you may want to disable migrations: ``auth.define_tables(migrate=False)``.</div><div class=""> </div><div class=""> To expose **Auth**, you also need the following function in a controller (for example in &quot;default.py&quot;):</div><div class=""> ``</div><div class=""> def user(): return dict(form=auth())</div><div class=""> ``:code</div><div class=""> </div><div class=""> -------</div><div class=""> The ``auth`` object and the ``user`` action are already defined in the</div><div class=""> scaffolding application.</div><div class=""> -------</div><div class=""> </div><div class=""> web2py also includes a sample view &quot;welcome/views/default/user.html&quot; to render this function properly that looks like this:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h2&gt;{{=T( request.args(0).replace(&#x27;_&#x27;,&#x27; &#x27;).capitalize() )}}&lt;/h2&gt;</div><div class=""> &lt;div id=&quot;web2py_user_form&quot;&gt;</div><div class="">   {{=form}}</div><div class="">   {{if request.args(0)==&#x27;login&#x27;:}}</div><div class="">     {{if not &#x27;register&#x27; in auth.settings.actions_disabled:}}</div><div class="">       &lt;br/&gt;&lt;a href=&quot;{{=URL(args=&#x27;register&#x27;)}}&quot;&gt;register&lt;/a&gt;</div><div class="">     {{pass}}</div><div class="">     {{if not &#x27;request_reset_password&#x27; in auth.settings.actions_disabled:}}</div><div class="">       &lt;br/&gt;</div><div class="">       &lt;a href=&quot;{{=URL(args=&#x27;request_reset_password&#x27;)}}&quot;&gt;lost password&lt;/a&gt;</div><div class="">     {{pass}}</div><div class="">   {{pass}}</div><div class=""> &lt;/div&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> Notice that this function simply displays a ``form`` and therefore it can be customized using normal custom form syntax. The only caveat is that the form displayed by ``form=auth()`` depends on ``request.args(0)``; therefore, if you replace the default ``auth()`` login form with a custom login form, you may need an ``if`` statement like this in the view:</div><div class=""> ``</div><div class=""> {{if request.args(0)==&#x27;login&#x27;:}}...custom login form...{{pass}}</div><div class=""> ``:code</div><div class=""> </div><div class="insert">+``auth.impersonate``:inxx ``auth.is_impersonating``:inxx</div><div class="insert">+</div><div class=""> The controller above exposes multiple actions:</div><div class=""> ``</div><div class=""> http://.../[app]/default/user/register</div><div class=""> http://.../[app]/default/user/login</div><div class=""> http://.../[app]/default/user/logout</div><div class=""> http://.../[app]/default/user/profile</div><div class=""> http://.../[app]/default/user/change_password</div><div class=""> http://.../[app]/default/user/verify_email</div><div class=""> http://.../[app]/default/user/retrieve_username</div><div class=""> http://.../[app]/default/user/request_reset_password</div><div class=""> http://.../[app]/default/user/reset_password</div><div class=""> http://.../[app]/default/user/impersonate</div><div class=""> http://.../[app]/default/user/groups</div><div class=""> http://.../[app]/default/user/not_authorized</div><div class=""> ``:code</div><div class=""> - **register** allows users to register. It is integrated with CAPTCHA, although this is disabled by default.</div><div class=""> - **login** allows users who are registered to log in (if the registration is verified or does not require verification, if it has been approved or does not require approval, and if it has not been blocked).</div><div class=""> - **logout** does what you would expect but also, as the other methods, logs the event and can be used to trigger some event.</div><div class=""> - **profile** allows users to edit their profile, i.e. the content of the ``auth_user`` table. Notice that this table does not have a fixed structure and can be customized.</div><div class=""> - **change_password** allows users to change their password in a fail-safe way.</div><div class=""> - **verify_email**. If email verification is turned on, then visitors, upon registration, receive an email with a link to verify their email information. The link points to this action.</div><div class=""> - **retrieve_username**. By default, **Auth** uses email and password for login, but it can, optionally, use username instead of email. In this latter case, if a user forgets his/her username, the ``retrieve_username`` method allows the user to type the email address and retrieve the username by email.</div><div class=""> - **request_reset_password**. Allows users who forgot their password to request a new password. They will get a confirmation email pointing to **reset_password**.</div><div class="insert">- **impersonate** allows a user to &quot;impersonate&quot; another user. This is important for debugging and for support purposes. ``request.args[0]`` is the id of the user to be impersonated. This is only allowed if the logged in user ``has_permission(&#x27;impersonate&#x27;, db.auth_user, user_id)``.<span class="highlight"> You can use ``auth.is_impersonating()`` to check is the current user is impersonating somebody else.</span></div><div class=""> - **groups** lists the groups of which the current logged in user is a member.</div><div class=""> - **not_authorized** displays an error message when the visitor tried to do something that he/she is not authorized to do</div><div class=""> - **navbar** is a helper that generates a bar with login/register/etc. links.</div><div class=""> </div><div class=""> Logout, profile, change_password, impersonate, and groups require login.</div><div class=""> </div><div class=""> By default they are all exposed, but it is possible to restrict access to only some of these actions.</div><div class=""> </div><div class=""> All of the methods above can be extended or replaced by subclassing **Auth**.</div><div class=""> </div><div class=""> All of the methods above can be used in separate actions. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> def mylogin(): return dict(form=auth.login())</div><div class=""> def myregister(): return dict(form=auth.register())</div><div class=""> def myprofile(): return dict(form=auth.profile())</div><div class=""> ...</div><div class=""> ``</div><div class=""> </div><div class=""> To restrict access to functions to only logged in visitors, decorate the function as in the following example</div><div class=""> ``</div><div class=""> @auth.requires_login()</div><div class=""> def hello():</div><div class="">     return dict(message=&#x27;hello %(first_name)s&#x27; % auth.user)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Any function can be decorated, not just exposed actions. Of course this is still only a very simple example of access control. More complex examples will be discussed later.</div><div class="insert">``auth.user``:inxx ``auth.user_id``:inxx<span class="highlight"> ``auth.user_groups``.</span></div><div class=""> </div><div class=""> -----</div><div class="insert">``auth.user`` contains a copy of the ``db.auth_user`` records for the current logged in user or ``None`` otherwise. There is also a ``auth.user_id`` which is the same as ``auth.user.id`` (i.e. the id of the current logger in user) or ``None``.<span class="highlight"> Similarly, ``auth.user_groups`` contains a dictionary where each key is the id of a group of with the current logged in user is member of, the value is the corresponding group role.</span></div><div class=""> -----</div><div class=""> </div><div class=""> ``otherwise``:inxx</div><div class=""> </div><div class=""> The ``auth.requires_login()`` decorator as well as the other ``auth.requires_*`` decorators take an optional ``otherwise`` argument. It can be set to a string where to redirect the user if registration files or to a callable object. It is called if registration fails.</div><div class=""> </div><div class=""> #### Restrictions on registration</div><div class=""> </div><div class=""> If you want to allow visitors to register but not to log in until registration has been approved by the administrator:</div><div class=""> ``</div><div class=""> auth.settings.registration_requires_approval = True</div><div class=""> ``:code</div><div class=""> </div><div class=""> You can approve a registration via the appadmin interface. Look into the table ``auth_user``. Pending registrations have a ``registration_key`` field set to &quot;pending&quot;. A registration is approved when this field is set to blank.</div><div class=""> </div><div class=""> Via the appadmin interface, you can also block a user from logging in. Locate the user in the table ``auth_user`` and set the ``registration_key`` to &quot;blocked&quot;. &quot;blocked&quot; users are not allowed to log in. Notice that this will prevent a visitor from logging in but it will not force a visitor who is already logged in to log out. The word &quot;disabled&quot; may be used instead of &quot;blocked&quot; if preferred, with exactly the same behavior.</div><div class=""> </div><div class=""> You can also block access to the &quot;register&quot; page completely with this statement:</div><div class=""> ``</div><div class=""> auth.settings.actions_disabled.append(&#x27;register&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> If you want to allow people to register and automatically log them in after registration but still want to send an email for verification so that they cannot login again after logout, unless they completed the instructions in the email, you can accomplish it as follows:</div><div class=""> </div><div class=""> ``</div><div class=""> auth.settings.registration_requires_approval = True</div><div class=""> auth.settings.login_after_registration = True</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> from gluon.contrib.login_methods.x509_auth import X509Account</div><div class=""> auth.settings.actions_disabled=[&#x27;register&#x27;,&#x27;change_password&#x27;,&#x27;request_reset_password&#x27;]</div><div class=""> auth.settings.login_form = X509Account()</div><div class=""> ``:code</div><div class=""> </div><div class=""> You can now authenticate into web2py passing your x509 certificate. How to do this is browser-dependent, but probably you are more likely to use certificates for web services. In this case you can use for example ``cURL`` to try out your authentication:</div><div class=""> </div><div class=""> ``</div><div class=""> curl -d &quot;firstName=John&amp;lastName=Smith&quot; -G -v --key private.key \</div><div class="">      --cert  server.crt https://example/app/default/user/profile</div><div class=""> ``</div><div class=""> </div><div class=""> This works out of the box with Rocket (the web2py built-in web server) but you may need some extra configuration work on the web server side if you are using a different web server. In particular you need to tell your web server where the certificates are located on local host and that it needs to verify certificates coming from the clients. How to do it is web server dependent and therefore omitted here.</div><div class=""> </div><div class=""> ##### Multiple login forms</div><div class=""> </div><div class=""> Some login methods modify the login_form, some do not. When they do that, they may not be able to coexist. Yet some coexist by providing multiple login forms in the same page. web2py provides a way to do it. Here is an example mixing normal login (auth) and RPX login (janrain.com):</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.contrib.login_methods.extended_login_form import ExtendedLoginForm</div><div class=""> other_form = RPXAccount(request, api_key=&#x27;...&#x27;, domain=&#x27;...&#x27;, url=&#x27;...&#x27;)</div><div class=""> auth.settings.login_form = ExtendedLoginForm(auth, other_form, signals=[&#x27;token&#x27;])</div><div class=""> ``:code</div><div class=""> </div><div class=""> If signals are set and a parameter in request matches any signals,</div><div class=""> it will return the call of ``other_form.login_form`` instead.</div><div class=""> ``other_form`` can handle some particular situations, for example,</div><div class=""> multiple steps of OpenID login inside ``other_form.login_form``.</div><div class=""> </div><div class=""> Otherwise it will render the normal login form together with the ``other_form``.</div><div class=""> </div><div class="insert">+#### Record versioning</div><div class="insert">+</div><div class="insert">+You can use Auth to enable full record versioning:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+db.enable_record_versioning(db,</div><div class="insert">+    archive_db=None,</div><div class="insert">+    archive_names=&#x27;%(tablename)s_archive&#x27;,</div><div class="insert">+    current_record=&#x27;current_record&#x27;):</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+This tells web2py to create an archive table for each of the tables in ``db`` and store a copy of each record when modified. The old copy is stored. The new copy is not.</div><div class="insert">+</div><div class="insert">+The last three parameters are optional:</div><div class="insert">+</div><div class="insert">+- ``archive_db`` allows to specify another database where the archive tables are to be stored. Setting it to ``None`` is the same as setting it to ``db``.</div><div class="insert">+- ``archive_names`` provides a pattern for naming each archive table.</div><div class="insert">+- ``current_record`` specified the name of the reference field to be used in the archive table to refer to the original, unmodified, record. Notice that ``archive_db!=db`` then the reference field is just an integer field since cross database references are not possible.</div><div class="insert">+</div><div class="insert">+</div><div class="insert">+Only tables with ``modified_by`` and ``modified_on`` fields (as created</div><div class="insert">+for example by auth.signature) will be archived.</div><div class="insert">+</div><div class="insert">+When you ``enable_record_versioning``, if records have an </div><div class="insert">+``is_active`` field (also created by auth.signature), </div><div class="insert">+records will never be deleted but they will be marked with ``is_active=False``.</div><div class="insert">+In fact, ``enable_record_versioning`` adds a ``common_filter`` to </div><div class="insert">+every versioned table that filters out records with ``is_active=False`` so they essentially become invisible.</div><div class="insert">+</div><div class="insert">+If you ``enable_record_versioning``, you should not use </div><div class="insert">+``auth.archive`` or ``crud.archive`` else you will end up with duplicate records.</div><div class="insert">+Those functions do explicitly what ``enable_record_versioning`` does automatically and</div><div class="insert">+they will be deprecated.</div><div class="insert">+</div><div class="insert">+</div><div class=""> ### ``Mail`` and ``Auth``</div><div class=""> </div><div class=""> One can define a mailer with</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.tools import Mail</div><div class=""> mail = Mail()</div><div class=""> mail.settings.server = &#x27;smtp.example.com:25&#x27;</div><div class=""> mail.settings.sender = &#x27;you@example.com&#x27;</div><div class=""> mail.settings.login = &#x27;username:password&#x27;</div><div class=""> </div><div class=""> ``</div><div class=""> </div><div class=""> or simply use the mailer provided by ``auth``:</div><div class=""> </div><div class=""> ``</div><div class=""> mail = auth.settings.mailer</div><div class=""> mail.settings.server = &#x27;smtp.example.com:25&#x27;</div><div class=""> mail.settings.sender = &#x27;you@example.com&#x27;</div><div class=""> mail.settings.login = &#x27;username:password&#x27;</div><div class=""> ``</div><div class=""> </div><div class=""> You need to replace the mail.settings with the proper parameters for your SMTP server. Set ``mail.settings.login = None`` if the SMTP server does not require authentication.</div><div class=""> </div><div class=""> You can read more about web2py API for emails and email configuration in Chapter 8. Here we limit the discussion to the interaction between ``Mail`` and ``Auth``.</div><div class=""> </div><div class=""> In ``Auth``, by default, email verification is disabled.</div><div class=""> To enable email, append the following lines in the model where ``auth`` is defined:</div><div class=""> </div><div class=""> ``</div><div class=""> auth.settings.registration_requires_verification = True</div><div class=""> auth.settings.registration_requires_approval = False</div><div class=""> auth.settings.reset_password_requires_verification = True</div><div class=""> auth.messages.verify_email = &#x27;Click on the link http://&#x27; + \</div><div class="">     request.env.http_host + \</div><div class="">     URL(r=request,c=&#x27;default&#x27;,f=&#x27;user&#x27;,args=[&#x27;verify_email&#x27;]) + \</div><div class="">     &#x27;/%(key)s to verify your email&#x27;</div><div class=""> auth.messages.reset_password = &#x27;Click on the link http://&#x27; + \</div><div class="">     request.env.http_host + \</div><div class="">     URL(r=request,c=&#x27;default&#x27;,f=&#x27;user&#x27;,args=[&#x27;reset_password&#x27;]) + \</div><div class="">     &#x27;/%(key)s to reset your password&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class=""> In the two ``auth.messages`` above, you may need to replace the URL portion of the string with the proper complete URL of the action. This is necessary because web2py may be installed behind a proxy, and it cannot determine its own public URLs with absolute certainty. The above examples (which are the default values) should, however, work in most cases.</div><div class=""> </div><div class=""> ### Authorization</div><div class=""> </div><div class=""> Once a new user is registered, a new group is created to contain the user. The role of the new user is conventionally &quot;user_[id]&quot; where [id] is the id of the newly created user. The creation of the group can be disabled with</div><div class=""> ``</div><div class="insert">auth.settings.create_user_groups = <span class="highlight">Non</span>e</div><div class=""> ``:code</div><div class=""> </div><div class="insert">+although we do not suggest doing so. Notice that ``create_user_groups`` is not a boolean (althought it can be ``False``) but it defaults to:</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+auth.settings.create_user_groups=&quot;user_%(id)s&quot;</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+It store a template for the name of the group created for user ``id``.</div><div class="insert">+</div><div class="insert">+Users have membership in groups. Each group is identified by a name/role. Groups have permissions. Users have permissions because of the groups they belong to. By default each user is made member of their own group.</div><div class="insert">+</div><div class="insert">+You can also also do</div><div class="insert">+``</div><div class="insert">+auth.settings.everybody_group_id = 5</div><div class="insert">+``:code</div><div class=""> </div><div class="insert"><span class="highlight">to make any new u</span>ser<span class="highlight"></span> <span class="highlight"></span>a<span class="highlight">utomatically</span> member<span class="highlight"></span> <span class="highlight"></span>o<span class="highlight">f</span> group <span class="highlight">number 5. Here 5 </span>is <span class="highlight">us</span>ed <span class="highlight">as</span> a<span class="highlight">n</span> <span class="highlight">ex</span>am<span class="highlight">p</span>le<span class="highlight"></span> <span class="highlight">and</span> <span class="highlight">w</span>e <span class="highlight">a</span>ss<span class="highlight">um</span>e<span class="highlight"></span> the group<span class="highlight"> wa</span>s <span class="highlight">crea</span>t<span class="highlight"></span>e<span class="highlight">d alread</span>y<span class="highlight"></span>.</div></div></div>
    <div class="span6"><div class="diff"><div class=""> -------</div><div class=""> The ``password`` field of the ``db.auth_user`` table defaults to a ``CRYPT`` validator, which needs and ``hmac_key``. On legacy web2py applications you may see an extra argument passed to the Auth constructor: ``hmac_key = Auth.get_or_create_key()``. The latter is a function that read the hmac kay from a file &quot;private/auth.key&quot; within the application folder. If the file does not exist it creates a random ``hmac_key``. If multiple apps share the same auth database, make sure they also use the same ``hmac_key``. This is no loger necessary for new applications since passwords are salted with an individual random salt.</div><div class=""> -------</div><div class=""> </div><div class=""> By default, web2py uses email for login. If instead you want to log in using username set ``auth.define_tables(username=True)``</div><div class=""> </div><div class=""> If multiple apps share the same auth database you may want to disable migrations: ``auth.define_tables(migrate=False)``.</div><div class=""> </div><div class=""> To expose **Auth**, you also need the following function in a controller (for example in &quot;default.py&quot;):</div><div class=""> ``</div><div class=""> def user(): return dict(form=auth())</div><div class=""> ``:code</div><div class=""> </div><div class=""> -------</div><div class=""> The ``auth`` object and the ``user`` action are already defined in the</div><div class=""> scaffolding application.</div><div class=""> -------</div><div class=""> </div><div class=""> web2py also includes a sample view &quot;welcome/views/default/user.html&quot; to render this function properly that looks like this:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h2&gt;{{=T( request.args(0).replace(&#x27;_&#x27;,&#x27; &#x27;).capitalize() )}}&lt;/h2&gt;</div><div class=""> &lt;div id=&quot;web2py_user_form&quot;&gt;</div><div class="">   {{=form}}</div><div class="">   {{if request.args(0)==&#x27;login&#x27;:}}</div><div class="">     {{if not &#x27;register&#x27; in auth.settings.actions_disabled:}}</div><div class="">       &lt;br/&gt;&lt;a href=&quot;{{=URL(args=&#x27;register&#x27;)}}&quot;&gt;register&lt;/a&gt;</div><div class="">     {{pass}}</div><div class="">     {{if not &#x27;request_reset_password&#x27; in auth.settings.actions_disabled:}}</div><div class="">       &lt;br/&gt;</div><div class="">       &lt;a href=&quot;{{=URL(args=&#x27;request_reset_password&#x27;)}}&quot;&gt;lost password&lt;/a&gt;</div><div class="">     {{pass}}</div><div class="">   {{pass}}</div><div class=""> &lt;/div&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> Notice that this function simply displays a ``form`` and therefore it can be customized using normal custom form syntax. The only caveat is that the form displayed by ``form=auth()`` depends on ``request.args(0)``; therefore, if you replace the default ``auth()`` login form with a custom login form, you may need an ``if`` statement like this in the view:</div><div class=""> ``</div><div class=""> {{if request.args(0)==&#x27;login&#x27;:}}...custom login form...{{pass}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> The controller above exposes multiple actions:</div><div class=""> ``</div><div class=""> http://.../[app]/default/user/register</div><div class=""> http://.../[app]/default/user/login</div><div class=""> http://.../[app]/default/user/logout</div><div class=""> http://.../[app]/default/user/profile</div><div class=""> http://.../[app]/default/user/change_password</div><div class=""> http://.../[app]/default/user/verify_email</div><div class=""> http://.../[app]/default/user/retrieve_username</div><div class=""> http://.../[app]/default/user/request_reset_password</div><div class=""> http://.../[app]/default/user/reset_password</div><div class=""> http://.../[app]/default/user/impersonate</div><div class=""> http://.../[app]/default/user/groups</div><div class=""> http://.../[app]/default/user/not_authorized</div><div class=""> ``:code</div><div class=""> - **register** allows users to register. It is integrated with CAPTCHA, although this is disabled by default.</div><div class=""> - **login** allows users who are registered to log in (if the registration is verified or does not require verification, if it has been approved or does not require approval, and if it has not been blocked).</div><div class=""> - **logout** does what you would expect but also, as the other methods, logs the event and can be used to trigger some event.</div><div class=""> - **profile** allows users to edit their profile, i.e. the content of the ``auth_user`` table. Notice that this table does not have a fixed structure and can be customized.</div><div class=""> - **change_password** allows users to change their password in a fail-safe way.</div><div class=""> - **verify_email**. If email verification is turned on, then visitors, upon registration, receive an email with a link to verify their email information. The link points to this action.</div><div class=""> - **retrieve_username**. By default, **Auth** uses email and password for login, but it can, optionally, use username instead of email. In this latter case, if a user forgets his/her username, the ``retrieve_username`` method allows the user to type the email address and retrieve the username by email.</div><div class=""> - **request_reset_password**. Allows users who forgot their password to request a new password. They will get a confirmation email pointing to **reset_password**.</div><div class="delete">- **impersonate** allows a user to &quot;impersonate&quot; another user. This is important for debugging and for support purposes. ``request.args[0]`` is the id of the user to be impersonated. This is only allowed if the logged in user ``has_permission(&#x27;impersonate&#x27;, db.auth_user, user_id)``.<span class="highlight"></span></div><div class=""> - **groups** lists the groups of which the current logged in user is a member.</div><div class=""> - **not_authorized** displays an error message when the visitor tried to do something that he/she is not authorized to do</div><div class=""> - **navbar** is a helper that generates a bar with login/register/etc. links.</div><div class=""> </div><div class=""> Logout, profile, change_password, impersonate, and groups require login.</div><div class=""> </div><div class=""> By default they are all exposed, but it is possible to restrict access to only some of these actions.</div><div class=""> </div><div class=""> All of the methods above can be extended or replaced by subclassing **Auth**.</div><div class=""> </div><div class=""> All of the methods above can be used in separate actions. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> def mylogin(): return dict(form=auth.login())</div><div class=""> def myregister(): return dict(form=auth.register())</div><div class=""> def myprofile(): return dict(form=auth.profile())</div><div class=""> ...</div><div class=""> ``</div><div class=""> </div><div class=""> To restrict access to functions to only logged in visitors, decorate the function as in the following example</div><div class=""> ``</div><div class=""> @auth.requires_login()</div><div class=""> def hello():</div><div class="">     return dict(message=&#x27;hello %(first_name)s&#x27; % auth.user)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Any function can be decorated, not just exposed actions. Of course this is still only a very simple example of access control. More complex examples will be discussed later.</div><div class="delete">``auth.user``:inxx ``auth.user_id``:inxx<span class="highlight"></span></div><div class=""> </div><div class=""> -----</div><div class="delete">``auth.user`` contains a copy of the ``db.auth_user`` records for the current logged in user or ``None`` otherwise. There is also a ``auth.user_id`` which is the same as ``auth.user.id`` (i.e. the id of the current logger in user) or ``None``.<span class="highlight"></span></div><div class=""> -----</div><div class=""> </div><div class=""> ``otherwise``:inxx</div><div class=""> </div><div class=""> The ``auth.requires_login()`` decorator as well as the other ``auth.requires_*`` decorators take an optional ``otherwise`` argument. It can be set to a string where to redirect the user if registration files or to a callable object. It is called if registration fails.</div><div class=""> </div><div class=""> #### Restrictions on registration</div><div class=""> </div><div class=""> If you want to allow visitors to register but not to log in until registration has been approved by the administrator:</div><div class=""> ``</div><div class=""> auth.settings.registration_requires_approval = True</div><div class=""> ``:code</div><div class=""> </div><div class=""> You can approve a registration via the appadmin interface. Look into the table ``auth_user``. Pending registrations have a ``registration_key`` field set to &quot;pending&quot;. A registration is approved when this field is set to blank.</div><div class=""> </div><div class=""> Via the appadmin interface, you can also block a user from logging in. Locate the user in the table ``auth_user`` and set the ``registration_key`` to &quot;blocked&quot;. &quot;blocked&quot; users are not allowed to log in. Notice that this will prevent a visitor from logging in but it will not force a visitor who is already logged in to log out. The word &quot;disabled&quot; may be used instead of &quot;blocked&quot; if preferred, with exactly the same behavior.</div><div class=""> </div><div class=""> You can also block access to the &quot;register&quot; page completely with this statement:</div><div class=""> ``</div><div class=""> auth.settings.actions_disabled.append(&#x27;register&#x27;)</div><div class=""> ``:code</div><div class=""> </div><div class=""> If you want to allow people to register and automatically log them in after registration but still want to send an email for verification so that they cannot login again after logout, unless they completed the instructions in the email, you can accomplish it as follows:</div><div class=""> </div><div class=""> ``</div><div class=""> auth.settings.registration_requires_approval = True</div><div class=""> auth.settings.login_after_registration = True</div><div class=""> ``:code</div><div class=""> </div><div class=""> </div><div class=""> from gluon.contrib.login_methods.x509_auth import X509Account</div><div class=""> auth.settings.actions_disabled=[&#x27;register&#x27;,&#x27;change_password&#x27;,&#x27;request_reset_password&#x27;]</div><div class=""> auth.settings.login_form = X509Account()</div><div class=""> ``:code</div><div class=""> </div><div class=""> You can now authenticate into web2py passing your x509 certificate. How to do this is browser-dependent, but probably you are more likely to use certificates for web services. In this case you can use for example ``cURL`` to try out your authentication:</div><div class=""> </div><div class=""> ``</div><div class=""> curl -d &quot;firstName=John&amp;lastName=Smith&quot; -G -v --key private.key \</div><div class="">      --cert  server.crt https://example/app/default/user/profile</div><div class=""> ``</div><div class=""> </div><div class=""> This works out of the box with Rocket (the web2py built-in web server) but you may need some extra configuration work on the web server side if you are using a different web server. In particular you need to tell your web server where the certificates are located on local host and that it needs to verify certificates coming from the clients. How to do it is web server dependent and therefore omitted here.</div><div class=""> </div><div class=""> ##### Multiple login forms</div><div class=""> </div><div class=""> Some login methods modify the login_form, some do not. When they do that, they may not be able to coexist. Yet some coexist by providing multiple login forms in the same page. web2py provides a way to do it. Here is an example mixing normal login (auth) and RPX login (janrain.com):</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.contrib.login_methods.extended_login_form import ExtendedLoginForm</div><div class=""> other_form = RPXAccount(request, api_key=&#x27;...&#x27;, domain=&#x27;...&#x27;, url=&#x27;...&#x27;)</div><div class=""> auth.settings.login_form = ExtendedLoginForm(auth, other_form, signals=[&#x27;token&#x27;])</div><div class=""> ``:code</div><div class=""> </div><div class=""> If signals are set and a parameter in request matches any signals,</div><div class=""> it will return the call of ``other_form.login_form`` instead.</div><div class=""> ``other_form`` can handle some particular situations, for example,</div><div class=""> multiple steps of OpenID login inside ``other_form.login_form``.</div><div class=""> </div><div class=""> Otherwise it will render the normal login form together with the ``other_form``.</div><div class=""> </div><div class=""> ### ``Mail`` and ``Auth``</div><div class=""> </div><div class=""> One can define a mailer with</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.tools import Mail</div><div class=""> mail = Mail()</div><div class=""> mail.settings.server = &#x27;smtp.example.com:25&#x27;</div><div class=""> mail.settings.sender = &#x27;you@example.com&#x27;</div><div class=""> mail.settings.login = &#x27;username:password&#x27;</div><div class=""> </div><div class=""> ``</div><div class=""> </div><div class=""> or simply use the mailer provided by ``auth``:</div><div class=""> </div><div class=""> ``</div><div class=""> mail = auth.settings.mailer</div><div class=""> mail.settings.server = &#x27;smtp.example.com:25&#x27;</div><div class=""> mail.settings.sender = &#x27;you@example.com&#x27;</div><div class=""> mail.settings.login = &#x27;username:password&#x27;</div><div class=""> ``</div><div class=""> </div><div class=""> You need to replace the mail.settings with the proper parameters for your SMTP server. Set ``mail.settings.login = None`` if the SMTP server does not require authentication.</div><div class=""> </div><div class=""> You can read more about web2py API for emails and email configuration in Chapter 8. Here we limit the discussion to the interaction between ``Mail`` and ``Auth``.</div><div class=""> </div><div class=""> In ``Auth``, by default, email verification is disabled.</div><div class=""> To enable email, append the following lines in the model where ``auth`` is defined:</div><div class=""> </div><div class=""> ``</div><div class=""> auth.settings.registration_requires_verification = True</div><div class=""> auth.settings.registration_requires_approval = False</div><div class=""> auth.settings.reset_password_requires_verification = True</div><div class=""> auth.messages.verify_email = &#x27;Click on the link http://&#x27; + \</div><div class="">     request.env.http_host + \</div><div class="">     URL(r=request,c=&#x27;default&#x27;,f=&#x27;user&#x27;,args=[&#x27;verify_email&#x27;]) + \</div><div class="">     &#x27;/%(key)s to verify your email&#x27;</div><div class=""> auth.messages.reset_password = &#x27;Click on the link http://&#x27; + \</div><div class="">     request.env.http_host + \</div><div class="">     URL(r=request,c=&#x27;default&#x27;,f=&#x27;user&#x27;,args=[&#x27;reset_password&#x27;]) + \</div><div class="">     &#x27;/%(key)s to reset your password&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class=""> In the two ``auth.messages`` above, you may need to replace the URL portion of the string with the proper complete URL of the action. This is necessary because web2py may be installed behind a proxy, and it cannot determine its own public URLs with absolute certainty. The above examples (which are the default values) should, however, work in most cases.</div><div class=""> </div><div class=""> ### Authorization</div><div class=""> </div><div class=""> Once a new user is registered, a new group is created to contain the user. The role of the new user is conventionally &quot;user_[id]&quot; where [id] is the id of the newly created user. The creation of the group can be disabled with</div><div class=""> ``</div><div class="delete">auth.settings.create_user_groups = <span class="highlight">Fals</span>e</div><div class=""> ``:code</div><div class=""> </div><div class="delete">-although we do not suggest doing so.</div><div class=""> </div><div class="delete"><span class="highlight">U</span>ser<span class="highlight">s</span> <span class="highlight">h</span>a<span class="highlight">ve</span> member<span class="highlight">ship</span> <span class="highlight">in gr</span>o<span class="highlight">ups. Each</span> group <span class="highlight"></span>is <span class="highlight">identifi</span>ed <span class="highlight">by</span> a<span class="highlight"></span> <span class="highlight">n</span>am<span class="highlight">e/ro</span>le<span class="highlight">.</span> <span class="highlight">Groups</span> <span class="highlight">hav</span>e <span class="highlight">permi</span>ss<span class="highlight">ions. Us</span>e<span class="highlight">rs have permissions because of</span> the group<span class="highlight"></span>s <span class="highlight"></span>t<span class="highlight">h</span>e<span class="highlight"></span>y<span class="highlight"> belong to</span>.</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/c4e4f430a3fe8433d95790170768d74eaf109a49">c4e4f43</a><ul><li>Date : 2012-12-22</li><li>fixed subsection level</li></ul></li></ul>
<div class="row-fluid" id="com_c4e4f430a3fe8433d95790170768d74eaf109a49">
    <div class="span6"><div class="diff"><div class="insert"><span class="highlight">#</span>### ``Mail`` and ``Auth``</div></div></div>
    <div class="span6"><div class="diff"><div class="delete"><span class="highlight"></span>### ``Mail`` and ``Auth``</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/f2fd41dd2a0d4bf68f5cd4f0989fb32bdc35eac5">f2fd41d</a><ul><li>Date : 2012-12-31</li><li>spell check of diffs, thanks Joanthan</li></ul></li></ul>
<div class="row-fluid" id="com_f2fd41dd2a0d4bf68f5cd4f0989fb32bdc35eac5">
    <div class="span6"><div class="diff"><div class=""> **Auth** needs (and defines) the following tables:</div><div class=""> - ``auth_user`` stores users&#x27; name, email address, password, and status (registration pending, accepted, blocked)</div><div class=""> - ``auth_group`` stores groups or roles for users in a many-to-many structure. By default, each user is in its own group, but a user can be in multiple groups, and each group can contain multiple users. A group is identified by a role and a description.</div><div class=""> - ``auth_membership`` links users and groups in a many-to-many structure.</div><div class=""> - ``auth_permission`` links groups and permissions. A permission is identified by a name and, optionally, a table and a record. For example, members of a certain group can have &quot;update&quot; permissions on a specific record of a specific table.</div><div class=""> - ``auth_event`` logs changes in the other tables and successful access via CRUD to objects controlled by the RBAC.</div><div class="insert">- ``auth_cas`` is used for Central Authe<span class="highlight">n</span>tication Service (CAS). Every web2py application is a CAS provider and can optionally be a CAS consumer.</div><div class=""> </div><div class=""> The schema is reproduced graphically in the image below:</div><div class=""> </div><div class=""> [[image @///image/schema_auth.png center 300px]]</div><div class=""> </div><div class=""> </div><div class=""> </div><div class=""> In principle, there is no restriction on the names of the roles and the names of the permissions; the developer can create them to fix the roles and permissions in the organization. Once they have been created, web2py provides an API to check if a user is logged in, if a user is a member of a given group, and/or if the user is a member of any group that has a given required permission.</div><div class=""> </div><div class=""> web2py also provides decorators to restrict access to any function based on login, membership and permissions.</div><div class=""> </div><div class=""> web2py also understands some specific permissions, i.e., those that have a name that correspond to the CRUD methods (create, read, update, delete) and can enforce them automatically without the need to use decorators.</div><div class=""> </div><div class=""> In this chapter, we are going to discuss different parts of RBAC one by one.</div><div class=""> </div><div class=""> ### Authentication</div><div class=""> </div><div class=""> In order to use RBAC, users need to be identified. This means that they need to register (or be registered) and log in.</div><div class=""> </div><div class=""> **Auth** provides multiple login methods. The default one consists of identifying users based on the local ``auth_user`` table.</div><div class=""> Alternatively, it can log in users against third-party authentication systems and single sign on providers such as Google, PAM, LDAP, Facebook, LinkedIn, Dropbox, OpenID, OAuth, etc..</div><div class=""> </div><div class=""> To start using ``Auth``, you need at least this code in a model file, which is also provided with the web2py &quot;welcome&quot; application and assumes a ``db`` connection object:</div><div class=""> ``</div><div class=""> from gluon.tools import Auth</div><div class=""> auth = Auth(db)</div><div class=""> auth.define_tables()</div><div class=""> ``:code</div><div class=""> </div><div class=""> Auth has an optional ``secure=True`` argument, which will force authenticated pages to go over HTTPS. ``https``:inxx</div><div class=""> </div><div class=""> -------</div><div class="insert">The ``password`` field of the ``db.auth_user`` table defaults to a ``CRYPT`` validator, which needs and ``hmac_key``. On legacy web2py applications you may see an extra argument passed to the Auth constructor: ``hmac_key = Auth.get_or_create_key()``. The latter is a function that read the <span class="highlight">HMAC ke</span>y from a file &quot;private/auth.key&quot; within the application folder. If the file does not exist it creates a random ``hmac_key``. If multiple apps share the same auth database, make sure they also use the same ``hmac_key``. This is no loger necessary for new applications since passwords are salted with an individual random salt.</div><div class=""> -------</div><div class=""> </div><div class=""> By default, web2py uses email for login. If instead you want to log in using username set ``auth.define_tables(username=True)``</div><div class=""> </div><div class=""> If multiple apps share the same auth database you may want to disable migrations: ``auth.define_tables(migrate=False)``.</div><div class=""> </div><div class=""> To expose **Auth**, you also need the following function in a controller (for example in &quot;default.py&quot;):</div><div class=""> ``</div><div class=""> def user(): return dict(form=auth())</div><div class=""> ``:code</div><div class=""> </div><div class=""> -------</div><div class=""> The ``auth`` object and the ``user`` action are already defined in the</div><div class=""> scaffolding application.</div><div class=""> -------</div><div class=""> </div><div class=""> web2py also includes a sample view &quot;welcome/views/default/user.html&quot; to render this function properly that looks like this:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h2&gt;{{=T( request.args(0).replace(&#x27;_&#x27;,&#x27; &#x27;).capitalize() )}}&lt;/h2&gt;</div><div class=""> &lt;div id=&quot;web2py_user_form&quot;&gt;</div><div class="">   {{=form}}</div><div class="">   {{if request.args(0)==&#x27;login&#x27;:}}</div><div class="">     {{if not &#x27;register&#x27; in auth.settings.actions_disabled:}}</div><div class="">       &lt;br/&gt;&lt;a href=&quot;{{=URL(args=&#x27;register&#x27;)}}&quot;&gt;register&lt;/a&gt;</div><div class="">     {{pass}}</div><div class="">     {{if not &#x27;request_reset_password&#x27; in auth.settings.actions_disabled:}}</div><div class="">       &lt;br/&gt;</div><div class="">       &lt;a href=&quot;{{=URL(args=&#x27;request_reset_password&#x27;)}}&quot;&gt;lost password&lt;/a&gt;</div><div class="">     {{pass}}</div><div class="">   {{pass}}</div><div class=""> &lt;/div&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> Notice that this function simply displays a ``form`` and therefore it can be customized using normal custom form syntax. The only caveat is that the form displayed by ``form=auth()`` depends on ``request.args(0)``; therefore, if you replace the default ``auth()`` login form with a custom login form, you may need an ``if`` statement like this in the view:</div><div class=""> ``</div><div class=""> {{if request.args(0)==&#x27;login&#x27;:}}...custom login form...{{pass}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> ``auth.impersonate``:inxx ``auth.is_impersonating``:inxx</div><div class=""> </div><div class=""> The controller above exposes multiple actions:</div><div class=""> ``</div><div class=""> http://.../[app]/default/user/register</div><div class=""> http://.../[app]/default/user/login</div><div class=""> http://.../[app]/default/user/logout</div><div class=""> http://.../[app]/default/user/profile</div><div class=""> http://.../[app]/default/user/change_password</div><div class=""> http://.../[app]/default/user/verify_email</div><div class=""> http://.../[app]/default/user/retrieve_username</div><div class=""> http://.../[app]/default/user/request_reset_password</div><div class=""> http://.../[app]/default/user/reset_password</div><div class=""> http://.../[app]/default/user/impersonate</div><div class=""> http://.../[app]/default/user/groups</div><div class=""> http://.../[app]/default/user/not_authorized</div><div class=""> ``:code</div><div class="insert">- **register** allows users to register. It is integrated with CAPTCHA, although this is disabled by default. This is also integrated with a client-side entropy calculator defined in &quot;web2py.js&quot;. The calculator indic<span class="highlight">ates the strength</span> of the new password. You can use the ``IS_STRONG`` validator to prevent web2py from accepting weak passwords.</div><div class=""> - **login** allows users who are registered to log in (if the registration is verified or does not require verification, if it has been approved or does not require approval, and if it has not been blocked).</div><div class=""> - **logout** does what you would expect but also, as the other methods, logs the event and can be used to trigger some event.</div><div class=""> - **profile** allows users to edit their profile, i.e. the content of the ``auth_user`` table. Notice that this table does not have a fixed structure and can be customized.</div><div class=""> - **change_password** allows users to change their password in a fail-safe way.</div><div class=""> - **verify_email**. If email verification is turned on, then visitors, upon registration, receive an email with a link to verify their email information. The link points to this action.</div><div class=""> - **retrieve_username**. By default, **Auth** uses email and password for login, but it can, optionally, use username instead of email. In this latter case, if a user forgets his/her username, the ``retrieve_username`` method allows the user to type the email address and retrieve the username by email.</div><div class=""> - **request_reset_password**. Allows users who forgot their password to request a new password. They will get a confirmation email pointing to **reset_password**.</div><div class=""> - **impersonate** allows a user to &quot;impersonate&quot; another user. This is important for debugging and for support purposes. ``request.args[0]`` is the id of the user to be impersonated. This is only allowed if the logged in user ``has_permission(&#x27;impersonate&#x27;, db.auth_user, user_id)``. You can use ``auth.is_impersonating()`` to check is the current user is impersonating somebody else.</div><div class=""> - **groups** lists the groups of which the current logged in user is a member.</div><div class=""> - **not_authorized** displays an error message when the visitor tried to do something that he/she is not authorized to do</div><div class=""> - **navbar** is a helper that generates a bar with login/register/etc. links.</div><div class=""> </div><div class=""> Logout, profile, change_password, impersonate, and groups require login.</div><div class=""> </div><div class=""> By default they are all exposed, but it is possible to restrict access to only some of these actions.</div><div class=""> </div><div class=""> All of the methods above can be extended or replaced by subclassing **Auth**.</div><div class=""> </div><div class=""> All of the methods above can be used in separate actions. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> def mylogin(): return dict(form=auth.login())</div><div class=""> def myregister(): return dict(form=auth.register())</div><div class=""> def myprofile(): return dict(form=auth.profile())</div><div class=""> ...</div><div class=""> ``</div><div class=""> </div><div class=""> To restrict access to functions to only logged in visitors, decorate the function as in the following example</div><div class=""> ``</div><div class=""> @auth.requires_login()</div><div class=""> mail.settings.login = &#x27;username:password&#x27;</div><div class=""> You need to replace the mail.settings with the proper parameters for your SMTP server. Set ``mail.settings.login = None`` if the SMTP server does not require authentication.</div><div class=""> </div><div class=""> You can read more about web2py API for emails and email configuration in Chapter 8. Here we limit the discussion to the interaction between ``Mail`` and ``Auth``.</div><div class=""> </div><div class=""> In ``Auth``, by default, email verification is disabled.</div><div class=""> To enable email, append the following lines in the model where ``auth`` is defined:</div><div class=""> </div><div class=""> ``</div><div class=""> auth.settings.registration_requires_verification = True</div><div class=""> auth.settings.registration_requires_approval = False</div><div class=""> auth.settings.reset_password_requires_verification = True</div><div class=""> auth.messages.verify_email = &#x27;Click on the link http://&#x27; + \</div><div class="">     request.env.http_host + \</div><div class="">     URL(r=request,c=&#x27;default&#x27;,f=&#x27;user&#x27;,args=[&#x27;verify_email&#x27;]) + \</div><div class="">     &#x27;/%(key)s to verify your email&#x27;</div><div class=""> auth.messages.reset_password = &#x27;Click on the link http://&#x27; + \</div><div class="">     request.env.http_host + \</div><div class="">     URL(r=request,c=&#x27;default&#x27;,f=&#x27;user&#x27;,args=[&#x27;reset_password&#x27;]) + \</div><div class="">     &#x27;/%(key)s to reset your password&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class=""> In the two ``auth.messages`` above, you may need to replace the URL portion of the string with the proper complete URL of the action. This is necessary because web2py may be installed behind a proxy, and it cannot determine its own public URLs with absolute certainty. The above examples (which are the default values) should, however, work in most cases.</div><div class=""> </div><div class=""> ### Authorization</div><div class=""> </div><div class=""> Once a new user is registered, a new group is created to contain the user. The role of the new user is conventionally &quot;user_[id]&quot; where [id] is the id of the newly created user. The creation of the group can be disabled with</div><div class=""> ``</div><div class=""> auth.settings.create_user_groups = None</div><div class=""> ``:code</div><div class=""> </div><div class="insert">although we do not suggest doing so. Notice that ``create_user_groups`` is not a boolean (although<span class="highlight"></span> it can be ``False``) but it defaults to:</div></div></div>
    <div class="span6"><div class="diff"><div class=""> **Auth** needs (and defines) the following tables:</div><div class=""> - ``auth_user`` stores users&#x27; name, email address, password, and status (registration pending, accepted, blocked)</div><div class=""> - ``auth_group`` stores groups or roles for users in a many-to-many structure. By default, each user is in its own group, but a user can be in multiple groups, and each group can contain multiple users. A group is identified by a role and a description.</div><div class=""> - ``auth_membership`` links users and groups in a many-to-many structure.</div><div class=""> - ``auth_permission`` links groups and permissions. A permission is identified by a name and, optionally, a table and a record. For example, members of a certain group can have &quot;update&quot; permissions on a specific record of a specific table.</div><div class=""> - ``auth_event`` logs changes in the other tables and successful access via CRUD to objects controlled by the RBAC.</div><div class="delete">- ``auth_cas`` is used for Central Authe<span class="highlight">tica</span>tication Service (CAS). Every web2py application is a CAS provider and can optionally be a CAS consumer.</div><div class=""> </div><div class=""> The schema is reproduced graphically in the image below:</div><div class=""> </div><div class=""> [[image @///image/schema_auth.png center 300px]]</div><div class=""> </div><div class=""> </div><div class=""> </div><div class=""> In principle, there is no restriction on the names of the roles and the names of the permissions; the developer can create them to fix the roles and permissions in the organization. Once they have been created, web2py provides an API to check if a user is logged in, if a user is a member of a given group, and/or if the user is a member of any group that has a given required permission.</div><div class=""> </div><div class=""> web2py also provides decorators to restrict access to any function based on login, membership and permissions.</div><div class=""> </div><div class=""> web2py also understands some specific permissions, i.e., those that have a name that correspond to the CRUD methods (create, read, update, delete) and can enforce them automatically without the need to use decorators.</div><div class=""> </div><div class=""> In this chapter, we are going to discuss different parts of RBAC one by one.</div><div class=""> </div><div class=""> ### Authentication</div><div class=""> </div><div class=""> In order to use RBAC, users need to be identified. This means that they need to register (or be registered) and log in.</div><div class=""> </div><div class=""> **Auth** provides multiple login methods. The default one consists of identifying users based on the local ``auth_user`` table.</div><div class=""> Alternatively, it can log in users against third-party authentication systems and single sign on providers such as Google, PAM, LDAP, Facebook, LinkedIn, Dropbox, OpenID, OAuth, etc..</div><div class=""> </div><div class=""> To start using ``Auth``, you need at least this code in a model file, which is also provided with the web2py &quot;welcome&quot; application and assumes a ``db`` connection object:</div><div class=""> ``</div><div class=""> from gluon.tools import Auth</div><div class=""> auth = Auth(db)</div><div class=""> auth.define_tables()</div><div class=""> ``:code</div><div class=""> </div><div class=""> Auth has an optional ``secure=True`` argument, which will force authenticated pages to go over HTTPS. ``https``:inxx</div><div class=""> </div><div class=""> -------</div><div class="delete">The ``password`` field of the ``db.auth_user`` table defaults to a ``CRYPT`` validator, which needs and ``hmac_key``. On legacy web2py applications you may see an extra argument passed to the Auth constructor: ``hmac_key = Auth.get_or_create_key()``. The latter is a function that read the <span class="highlight">hmac ka</span>y from a file &quot;private/auth.key&quot; within the application folder. If the file does not exist it creates a random ``hmac_key``. If multiple apps share the same auth database, make sure they also use the same ``hmac_key``. This is no loger necessary for new applications since passwords are salted with an individual random salt.</div><div class=""> -------</div><div class=""> </div><div class=""> By default, web2py uses email for login. If instead you want to log in using username set ``auth.define_tables(username=True)``</div><div class=""> </div><div class=""> If multiple apps share the same auth database you may want to disable migrations: ``auth.define_tables(migrate=False)``.</div><div class=""> </div><div class=""> To expose **Auth**, you also need the following function in a controller (for example in &quot;default.py&quot;):</div><div class=""> ``</div><div class=""> def user(): return dict(form=auth())</div><div class=""> ``:code</div><div class=""> </div><div class=""> -------</div><div class=""> The ``auth`` object and the ``user`` action are already defined in the</div><div class=""> scaffolding application.</div><div class=""> -------</div><div class=""> </div><div class=""> web2py also includes a sample view &quot;welcome/views/default/user.html&quot; to render this function properly that looks like this:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h2&gt;{{=T( request.args(0).replace(&#x27;_&#x27;,&#x27; &#x27;).capitalize() )}}&lt;/h2&gt;</div><div class=""> &lt;div id=&quot;web2py_user_form&quot;&gt;</div><div class="">   {{=form}}</div><div class="">   {{if request.args(0)==&#x27;login&#x27;:}}</div><div class="">     {{if not &#x27;register&#x27; in auth.settings.actions_disabled:}}</div><div class="">       &lt;br/&gt;&lt;a href=&quot;{{=URL(args=&#x27;register&#x27;)}}&quot;&gt;register&lt;/a&gt;</div><div class="">     {{pass}}</div><div class="">     {{if not &#x27;request_reset_password&#x27; in auth.settings.actions_disabled:}}</div><div class="">       &lt;br/&gt;</div><div class="">       &lt;a href=&quot;{{=URL(args=&#x27;request_reset_password&#x27;)}}&quot;&gt;lost password&lt;/a&gt;</div><div class="">     {{pass}}</div><div class="">   {{pass}}</div><div class=""> &lt;/div&gt;</div><div class=""> ``:code</div><div class=""> </div><div class=""> Notice that this function simply displays a ``form`` and therefore it can be customized using normal custom form syntax. The only caveat is that the form displayed by ``form=auth()`` depends on ``request.args(0)``; therefore, if you replace the default ``auth()`` login form with a custom login form, you may need an ``if`` statement like this in the view:</div><div class=""> ``</div><div class=""> {{if request.args(0)==&#x27;login&#x27;:}}...custom login form...{{pass}}</div><div class=""> ``:code</div><div class=""> </div><div class=""> ``auth.impersonate``:inxx ``auth.is_impersonating``:inxx</div><div class=""> </div><div class=""> The controller above exposes multiple actions:</div><div class=""> ``</div><div class=""> http://.../[app]/default/user/register</div><div class=""> http://.../[app]/default/user/login</div><div class=""> http://.../[app]/default/user/logout</div><div class=""> http://.../[app]/default/user/profile</div><div class=""> http://.../[app]/default/user/change_password</div><div class=""> http://.../[app]/default/user/verify_email</div><div class=""> http://.../[app]/default/user/retrieve_username</div><div class=""> http://.../[app]/default/user/request_reset_password</div><div class=""> http://.../[app]/default/user/reset_password</div><div class=""> http://.../[app]/default/user/impersonate</div><div class=""> http://.../[app]/default/user/groups</div><div class=""> http://.../[app]/default/user/not_authorized</div><div class=""> ``:code</div><div class="delete">- **register** allows users to register. It is integrated with CAPTCHA, although this is disabled by default. This is also integrated with a client-side entropy calculator defined in &quot;web2py.js&quot;. The calculator indic<span class="highlight">tates the strenght</span> of the new password. You can use the ``IS_STRONG`` validator to prevent web2py from accepting weak passwords.</div><div class=""> - **login** allows users who are registered to log in (if the registration is verified or does not require verification, if it has been approved or does not require approval, and if it has not been blocked).</div><div class=""> - **logout** does what you would expect but also, as the other methods, logs the event and can be used to trigger some event.</div><div class=""> - **profile** allows users to edit their profile, i.e. the content of the ``auth_user`` table. Notice that this table does not have a fixed structure and can be customized.</div><div class=""> - **change_password** allows users to change their password in a fail-safe way.</div><div class=""> - **verify_email**. If email verification is turned on, then visitors, upon registration, receive an email with a link to verify their email information. The link points to this action.</div><div class=""> - **retrieve_username**. By default, **Auth** uses email and password for login, but it can, optionally, use username instead of email. In this latter case, if a user forgets his/her username, the ``retrieve_username`` method allows the user to type the email address and retrieve the username by email.</div><div class=""> - **request_reset_password**. Allows users who forgot their password to request a new password. They will get a confirmation email pointing to **reset_password**.</div><div class=""> - **impersonate** allows a user to &quot;impersonate&quot; another user. This is important for debugging and for support purposes. ``request.args[0]`` is the id of the user to be impersonated. This is only allowed if the logged in user ``has_permission(&#x27;impersonate&#x27;, db.auth_user, user_id)``. You can use ``auth.is_impersonating()`` to check is the current user is impersonating somebody else.</div><div class=""> - **groups** lists the groups of which the current logged in user is a member.</div><div class=""> - **not_authorized** displays an error message when the visitor tried to do something that he/she is not authorized to do</div><div class=""> - **navbar** is a helper that generates a bar with login/register/etc. links.</div><div class=""> </div><div class=""> Logout, profile, change_password, impersonate, and groups require login.</div><div class=""> </div><div class=""> By default they are all exposed, but it is possible to restrict access to only some of these actions.</div><div class=""> </div><div class=""> All of the methods above can be extended or replaced by subclassing **Auth**.</div><div class=""> </div><div class=""> All of the methods above can be used in separate actions. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> def mylogin(): return dict(form=auth.login())</div><div class=""> def myregister(): return dict(form=auth.register())</div><div class=""> def myprofile(): return dict(form=auth.profile())</div><div class=""> ...</div><div class=""> ``</div><div class=""> </div><div class=""> To restrict access to functions to only logged in visitors, decorate the function as in the following example</div><div class=""> ``</div><div class=""> @auth.requires_login()</div><div class=""> mail.settings.login = &#x27;username:password&#x27;</div><div class=""> You need to replace the mail.settings with the proper parameters for your SMTP server. Set ``mail.settings.login = None`` if the SMTP server does not require authentication.</div><div class=""> </div><div class=""> You can read more about web2py API for emails and email configuration in Chapter 8. Here we limit the discussion to the interaction between ``Mail`` and ``Auth``.</div><div class=""> </div><div class=""> In ``Auth``, by default, email verification is disabled.</div><div class=""> To enable email, append the following lines in the model where ``auth`` is defined:</div><div class=""> </div><div class=""> ``</div><div class=""> auth.settings.registration_requires_verification = True</div><div class=""> auth.settings.registration_requires_approval = False</div><div class=""> auth.settings.reset_password_requires_verification = True</div><div class=""> auth.messages.verify_email = &#x27;Click on the link http://&#x27; + \</div><div class="">     request.env.http_host + \</div><div class="">     URL(r=request,c=&#x27;default&#x27;,f=&#x27;user&#x27;,args=[&#x27;verify_email&#x27;]) + \</div><div class="">     &#x27;/%(key)s to verify your email&#x27;</div><div class=""> auth.messages.reset_password = &#x27;Click on the link http://&#x27; + \</div><div class="">     request.env.http_host + \</div><div class="">     URL(r=request,c=&#x27;default&#x27;,f=&#x27;user&#x27;,args=[&#x27;reset_password&#x27;]) + \</div><div class="">     &#x27;/%(key)s to reset your password&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class=""> In the two ``auth.messages`` above, you may need to replace the URL portion of the string with the proper complete URL of the action. This is necessary because web2py may be installed behind a proxy, and it cannot determine its own public URLs with absolute certainty. The above examples (which are the default values) should, however, work in most cases.</div><div class=""> </div><div class=""> ### Authorization</div><div class=""> </div><div class=""> Once a new user is registered, a new group is created to contain the user. The role of the new user is conventionally &quot;user_[id]&quot; where [id] is the id of the newly created user. The creation of the group can be disabled with</div><div class=""> ``</div><div class=""> auth.settings.create_user_groups = None</div><div class=""> ``:code</div><div class=""> </div><div class="delete">although we do not suggest doing so. Notice that ``create_user_groups`` is not a boolean (although<span class="highlight">t</span> it can be ``False``) but it defaults to:</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/7bce1473ce90f4e60f49d72bf1b61d32f430cb54">7bce147</a><ul><li>Date : 2012-12-22</li><li>scheduler.queue_task</li></ul></li></ul>
<div class="row-fluid" id="com_7bce1473ce90f4e60f49d72bf1b61d32f430cb54">
    <div class="span6"><div class="diff"><div class="insert">gives permission &quot;name&quot; (user defined) on the object &quot;object&quot; (also user defined) to members of the group ``group_id``. If &quot;object&quot; is a tablename then the permission can refer to the entire table by setting ``record_id`` to a value of zero, or the permission can refer to a specific record by specifying a ``record_id`` value greater than zero. When giving permissions on tables, it is common to use a permission name in the set (&#x27;create&#x27;, &#x27;read&#x27;, &#x27;update&#x27;, &#x27;delete&#x27;, &#x27;select&#x27;) since these permissions are understood and can be enforced by<span class="highlight"> the</span> CRUD<span class="highlight"> APIs</span>.</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">gives permission &quot;name&quot; (user defined) on the object &quot;object&quot; (also user defined) to members of the group ``group_id``. If &quot;object&quot; is a tablename then the permission can refer to the entire table by setting ``record_id`` to a value of zero, or the permission can refer to a specific record by specifying a ``record_id`` value greater than zero. When giving permissions on tables, it is common to use a permission name in the set (&#x27;create&#x27;, &#x27;read&#x27;, &#x27;update&#x27;, &#x27;delete&#x27;, &#x27;select&#x27;) since these permissions are understood and can be enforced by<span class="highlight"></span> CRUD<span class="highlight"></span>.</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/d864cef3b68d807ffe8dbc10c26845734fefb97b">d864cef</a><ul><li>Date : 2013-02-04</li><li>fixed all but chap 6</li></ul></li></ul>
<div class="row-fluid" id="com_d864cef3b68d807ffe8dbc10c26845734fefb97b">
    <div class="span6"><div class="diff"><div class=""> -------</div><div class="insert">The ``password`` field of the ``db.auth_user`` table defaults to a ``CRYPT`` validator, which needs and ``hmac_key``. On legacy web2py applications you may see an extra argument passed to the Auth constructor: ``hmac_key = Auth.get_or_create_key()``. The latter is a function that read the HMAC key from a file &quot;private/auth.key&quot; within the application folder. If the file does not exist it creates a random ``hmac_key``. If multiple apps share the same auth database, make sure they also use the same ``hmac_key``. This is no lo<span class="highlight">n</span>ger necessary for new applications since passwords are salted with an individual random salt.</div><div class=""> -------</div><div class=""> </div><div class=""> By default, web2py uses email for login. If instead you want to log in using username set ``auth.define_tables(username=True)``</div><div class=""> </div><div class=""> If multiple apps share the same auth database you may want to disable migrations: ``auth.define_tables(migrate=False)``.</div><div class=""> </div><div class=""> To expose **Auth**, you also need the following function in a controller (for example in &quot;default.py&quot;):</div><div class=""> ``</div><div class=""> def user(): return dict(form=auth())</div><div class=""> ``:code</div><div class=""> </div><div class=""> -------</div><div class=""> The ``auth`` object and the ``user`` action are already defined in the</div><div class=""> scaffolding application.</div><div class=""> -------</div><div class=""> </div><div class=""> web2py also includes a sample view &quot;welcome/views/default/user.html&quot; to render this function properly that looks like this:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h2&gt;{{=T( request.args(0).replace(&#x27;_&#x27;,&#x27; &#x27;).capitalize() )}}&lt;/h2&gt;</div><div class=""> &lt;div id=&quot;web2py_user_form&quot;&gt;</div><div class="">   {{=form}}</div><div class="">   {{if request.args(0)==&#x27;login&#x27;:}}</div><div class="">     {{if not &#x27;register&#x27; in auth.settings.actions_disabled:}}</div><div class="">       &lt;br/&gt;&lt;a href=&quot;{{=URL(args=&#x27;register&#x27;)}}&quot;&gt;register&lt;/a&gt;</div><div class="">     {{pass}}</div><div class="">     {{if not &#x27;request_reset_password&#x27; in auth.settings.actions_disabled:}}</div><div class="">       &lt;br/&gt;</div><div class="">       &lt;a href=&quot;{{=URL(args=&#x27;request_reset_password&#x27;)}}&quot;&gt;lost password&lt;/a&gt;</div><div class="">     {{pass}}</div><div class=""> auth.settings.registration_requires_approval = False</div><div class=""> auth.settings.reset_password_requires_verification = True</div><div class=""> auth.messages.verify_email = &#x27;Click on the link http://&#x27; + \</div><div class="">     request.env.http_host + \</div><div class="">     URL(r=request,c=&#x27;default&#x27;,f=&#x27;user&#x27;,args=[&#x27;verify_email&#x27;]) + \</div><div class="">     &#x27;/%(key)s to verify your email&#x27;</div><div class=""> auth.messages.reset_password = &#x27;Click on the link http://&#x27; + \</div><div class="">     request.env.http_host + \</div><div class="">     URL(r=request,c=&#x27;default&#x27;,f=&#x27;user&#x27;,args=[&#x27;reset_password&#x27;]) + \</div><div class="">     &#x27;/%(key)s to reset your password&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class=""> In the two ``auth.messages`` above, you may need to replace the URL portion of the string with the proper complete URL of the action. This is necessary because web2py may be installed behind a proxy, and it cannot determine its own public URLs with absolute certainty. The above examples (which are the default values) should, however, work in most cases.</div><div class=""> </div><div class=""> ### Authorization</div><div class=""> </div><div class=""> Once a new user is registered, a new group is created to contain the user. The role of the new user is conventionally &quot;user_[id]&quot; where [id] is the id of the newly created user. The creation of the group can be disabled with</div><div class=""> ``</div><div class=""> auth.settings.create_user_groups = None</div><div class=""> ``:code</div><div class=""> </div><div class=""> although we do not suggest doing so. Notice that ``create_user_groups`` is not a boolean (although it can be ``False``) but it defaults to:</div><div class=""> </div><div class=""> ``</div><div class=""> auth.settings.create_user_groups=&quot;user_%(id)s&quot;</div><div class=""> ``:code</div><div class=""> </div><div class=""> It store a template for the name of the group created for user ``id``.</div><div class=""> </div><div class=""> Users have membership in groups. Each group is identified by a name/role. Groups have permissions. Users have permissions because of the groups they belong to. By default each user is made member of their own group.</div><div class=""> </div><div class="insert">You can also <span class="highlight"></span>do</div><div class=""> ``</div><div class=""> auth.settings.everybody_group_id = 5</div><div class=""> ``:code</div></div></div>
    <div class="span6"><div class="diff"><div class=""> -------</div><div class="delete">The ``password`` field of the ``db.auth_user`` table defaults to a ``CRYPT`` validator, which needs and ``hmac_key``. On legacy web2py applications you may see an extra argument passed to the Auth constructor: ``hmac_key = Auth.get_or_create_key()``. The latter is a function that read the HMAC key from a file &quot;private/auth.key&quot; within the application folder. If the file does not exist it creates a random ``hmac_key``. If multiple apps share the same auth database, make sure they also use the same ``hmac_key``. This is no lo<span class="highlight"></span>ger necessary for new applications since passwords are salted with an individual random salt.</div><div class=""> -------</div><div class=""> </div><div class=""> By default, web2py uses email for login. If instead you want to log in using username set ``auth.define_tables(username=True)``</div><div class=""> </div><div class=""> If multiple apps share the same auth database you may want to disable migrations: ``auth.define_tables(migrate=False)``.</div><div class=""> </div><div class=""> To expose **Auth**, you also need the following function in a controller (for example in &quot;default.py&quot;):</div><div class=""> ``</div><div class=""> def user(): return dict(form=auth())</div><div class=""> ``:code</div><div class=""> </div><div class=""> -------</div><div class=""> The ``auth`` object and the ``user`` action are already defined in the</div><div class=""> scaffolding application.</div><div class=""> -------</div><div class=""> </div><div class=""> web2py also includes a sample view &quot;welcome/views/default/user.html&quot; to render this function properly that looks like this:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h2&gt;{{=T( request.args(0).replace(&#x27;_&#x27;,&#x27; &#x27;).capitalize() )}}&lt;/h2&gt;</div><div class=""> &lt;div id=&quot;web2py_user_form&quot;&gt;</div><div class="">   {{=form}}</div><div class="">   {{if request.args(0)==&#x27;login&#x27;:}}</div><div class="">     {{if not &#x27;register&#x27; in auth.settings.actions_disabled:}}</div><div class="">       &lt;br/&gt;&lt;a href=&quot;{{=URL(args=&#x27;register&#x27;)}}&quot;&gt;register&lt;/a&gt;</div><div class="">     {{pass}}</div><div class="">     {{if not &#x27;request_reset_password&#x27; in auth.settings.actions_disabled:}}</div><div class="">       &lt;br/&gt;</div><div class="">       &lt;a href=&quot;{{=URL(args=&#x27;request_reset_password&#x27;)}}&quot;&gt;lost password&lt;/a&gt;</div><div class="">     {{pass}}</div><div class=""> auth.settings.registration_requires_approval = False</div><div class=""> auth.settings.reset_password_requires_verification = True</div><div class=""> auth.messages.verify_email = &#x27;Click on the link http://&#x27; + \</div><div class="">     request.env.http_host + \</div><div class="">     URL(r=request,c=&#x27;default&#x27;,f=&#x27;user&#x27;,args=[&#x27;verify_email&#x27;]) + \</div><div class="">     &#x27;/%(key)s to verify your email&#x27;</div><div class=""> auth.messages.reset_password = &#x27;Click on the link http://&#x27; + \</div><div class="">     request.env.http_host + \</div><div class="">     URL(r=request,c=&#x27;default&#x27;,f=&#x27;user&#x27;,args=[&#x27;reset_password&#x27;]) + \</div><div class="">     &#x27;/%(key)s to reset your password&#x27;</div><div class=""> ``:code</div><div class=""> </div><div class=""> In the two ``auth.messages`` above, you may need to replace the URL portion of the string with the proper complete URL of the action. This is necessary because web2py may be installed behind a proxy, and it cannot determine its own public URLs with absolute certainty. The above examples (which are the default values) should, however, work in most cases.</div><div class=""> </div><div class=""> ### Authorization</div><div class=""> </div><div class=""> Once a new user is registered, a new group is created to contain the user. The role of the new user is conventionally &quot;user_[id]&quot; where [id] is the id of the newly created user. The creation of the group can be disabled with</div><div class=""> ``</div><div class=""> auth.settings.create_user_groups = None</div><div class=""> ``:code</div><div class=""> </div><div class=""> although we do not suggest doing so. Notice that ``create_user_groups`` is not a boolean (although it can be ``False``) but it defaults to:</div><div class=""> </div><div class=""> ``</div><div class=""> auth.settings.create_user_groups=&quot;user_%(id)s&quot;</div><div class=""> ``:code</div><div class=""> </div><div class=""> It store a template for the name of the group created for user ``id``.</div><div class=""> </div><div class=""> Users have membership in groups. Each group is identified by a name/role. Groups have permissions. Users have permissions because of the groups they belong to. By default each user is made member of their own group.</div><div class=""> </div><div class="delete">You can also <span class="highlight">also </span>do</div><div class=""> ``</div><div class=""> auth.settings.everybody_group_id = 5</div><div class=""> ``:code</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/e8219d5f3760c9d20419ee76e9eb514a4046ce1c">e8219d5</a><ul><li>Date : 2013-02-15</li><li>Corrected a small typo</li></ul></li></ul>
<div class="row-fluid" id="com_e8219d5f3760c9d20419ee76e9eb514a4046ce1c">
    <div class="span6"><div class="diff"><div class=""> Occasionally, it is necessary to combine requirements. This can be done via a generic ``requires`` decorator which takes a single argument, a true or false condition. For example, to give access to agents, but only on Tuesday:</div><div class=""> ``</div><div class="insert">@auth.requires(auth.has_membership(group_id=<span class="highlight">&#x27;</span>agents<span class="highlight">&#x27;</span> \</div><div class="">                and request.now.weekday()==1)</div><div class=""> def function_seven():</div><div class="">     return &#x27;Hello agent, it must be Tuesday!&#x27;</div><div class=""> ``:code</div></div></div>
    <div class="span6"><div class="diff"><div class=""> Occasionally, it is necessary to combine requirements. This can be done via a generic ``requires`` decorator which takes a single argument, a true or false condition. For example, to give access to agents, but only on Tuesday:</div><div class=""> ``</div><div class="delete">@auth.requires(auth.has_membership(group_id=<span class="highlight"></span>agents<span class="highlight">)</span> \</div><div class="">                and request.now.weekday()==1)</div><div class=""> def function_seven():</div><div class="">     return &#x27;Hello agent, it must be Tuesday!&#x27;</div><div class=""> ``:code</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/329109afbb83ba34de23d586d44aedbaa27502e5">329109a</a><ul><li>Date : 2012-12-28</li><li>added schema image</li></ul></li></ul>
<div class="row-fluid" id="com_329109afbb83ba34de23d586d44aedbaa27502e5">
    <div class="span6"><div class="diff"><div class=""> **Auth** needs (and defines) the following tables:</div><div class=""> - ``auth_user`` stores users&#x27; name, email address, password, and status (registration pending, accepted, blocked)</div><div class=""> - ``auth_group`` stores groups or roles for users in a many-to-many structure. By default, each user is in its own group, but a user can be in multiple groups, and each group can contain multiple users. A group is identified by a role and a description.</div><div class=""> - ``auth_membership`` links users and groups in a many-to-many structure.</div><div class=""> - ``auth_permission`` links groups and permissions. A permission is identified by a name and, optionally, a table and a record. For example, members of a certain group can have &quot;update&quot; permissions on a specific record of a specific table.</div><div class=""> - ``auth_event`` logs changes in the other tables and successful access via CRUD to objects controlled by the RBAC.</div><div class="insert">+- ``auth_cas`` is used for Central Autheticatication Service (CAS). Every web2py application is a CAS provider and can optionally be a CAS consumer.</div><div class="insert">+</div><div class="insert">+The schema is reproduced graphically in the image below:</div><div class="insert">+</div><div class="insert">+[[image @///image/schema_auth.png center 300px]]</div><div class="insert">+</div><div class="insert">+</div></div></div>
    <div class="span6"><div class="diff"><div class=""> **Auth** needs (and defines) the following tables:</div><div class=""> - ``auth_user`` stores users&#x27; name, email address, password, and status (registration pending, accepted, blocked)</div><div class=""> - ``auth_group`` stores groups or roles for users in a many-to-many structure. By default, each user is in its own group, but a user can be in multiple groups, and each group can contain multiple users. A group is identified by a role and a description.</div><div class=""> - ``auth_membership`` links users and groups in a many-to-many structure.</div><div class=""> - ``auth_permission`` links groups and permissions. A permission is identified by a name and, optionally, a table and a record. For example, members of a certain group can have &quot;update&quot; permissions on a specific record of a specific table.</div><div class=""> - ``auth_event`` logs changes in the other tables and successful access via CRUD to objects controlled by the RBAC.</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/56409943ff62a997f7c1326dc264c8f53e5b722e">5640994</a><ul><li>Date : 2013-01-18</li><li>Update sources/29-web2py-english/09.markmin</li></ul></li></ul>
<div class="row-fluid" id="com_56409943ff62a997f7c1326dc264c8f53e5b722e">
    <div class="span6"><div class="diff"><div class="insert">First of all you must install the [[Facebook Python SDK https://github.com/<span class="highlight">pythonfor</span>facebook/<span class="highlight">faceb</span>o<span class="highlight">ok</span>-sdk<span class="highlight">/</span>]].</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">First of all you must install the [[Facebook Python SDK https://github.com/<span class="highlight"></span>facebook/<span class="highlight">pyth</span>o<span class="highlight">n</span>-sdk<span class="highlight"></span>]].</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/eaaa0e14bf17cdc4d0edd2ea9daa9af5f3484c09">eaaa0e1</a><ul><li>Date : 2012-12-25</li><li>changes to style</li></ul></li></ul>
<div class="row-fluid" id="com_eaaa0e14bf17cdc4d0edd2ea9daa9af5f3484c09">
    <div class="span6"><div class="diff"><div class="insert">Another way to do this<span class="highlight">, although not really recommended,</span> consists of defining your auth tables yourself. If a table is declared before ``auth.define_tables()`` it is used instead of the default one. Here is how to do it:</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">Another way to do this<span class="highlight"> (for experts!)</span> consists of defining your auth tables yourself. If a table is declared before ``auth.define_tables()`` it is used instead of the default one. Here is how to do it:</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/82dc64e7baa231edd3896ca7a0d41393e426f123">82dc64e</a><ul><li>Date : 2012-12-19</li><li>lots of small additions</li></ul></li></ul>
<div class="row-fluid" id="com_82dc64e7baa231edd3896ca7a0d41393e426f123">
    <div class="span6"><div class="diff"><div class="insert">+The condition argument of ``@auth.requires(condition)`` can be a callable and unless the condition is simple, it better to pass a callable than a condition since this will be faster, as the condition will only be evaluated if needed. For example</div><div class="insert">+</div><div class="insert">+``</div><div class="insert">+@auth.requires(lambda: check_condition())</div><div class="insert">+def action():</div><div class="insert">+    ....</div><div class="insert">+``:code</div><div class="insert">+</div><div class="insert">+``@auth.requires`` also takes an optional argument ``requires_login`` which defaults to ``True``. If set to False, it does not require login before evaluating the condition as true/false. The condition can be a boolean value or a function evaluating to boolean.</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">-The condition argument of ``@auth.requires(condition)`` can be a callable. ``@auth.requires`` also takes an optional argument ``requires_login`` which defaults to ``True``. If set to False, it does not require login before evaluating the condition as true/false. The condition can be a boolean value or a function evaluating to boolean.</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/76c0363755694c36971ffc9db176312fe5c14276">76c0363</a><ul><li>Date : 2012-12-22</li><li>more and more additions and corrections</li></ul></li></ul>
<div class="row-fluid" id="com_76c0363755694c36971ffc9db176312fe5c14276">
    <div class="span6"><div class="diff"><div class=""> The controller above exposes multiple actions:</div><div class=""> ``</div><div class=""> http://.../[app]/default/user/register</div><div class=""> http://.../[app]/default/user/login</div><div class=""> http://.../[app]/default/user/logout</div><div class=""> http://.../[app]/default/user/profile</div><div class=""> http://.../[app]/default/user/change_password</div><div class=""> http://.../[app]/default/user/verify_email</div><div class=""> http://.../[app]/default/user/retrieve_username</div><div class=""> http://.../[app]/default/user/request_reset_password</div><div class=""> http://.../[app]/default/user/reset_password</div><div class=""> http://.../[app]/default/user/impersonate</div><div class=""> http://.../[app]/default/user/groups</div><div class=""> http://.../[app]/default/user/not_authorized</div><div class=""> ``:code</div><div class="insert">- **register** allows users to register. It is integrated with CAPTCHA, although this is disabled by default.<span class="highlight"> This is also integrated with a client-side entropy calculator defined in &quot;web2py.js&quot;. The calculator indictates the strenght of the new password. You can use the ``IS_STRONG`` validator to prevent web2py from accepting weak passwords. </span></div><div class=""> - **login** allows users who are registered to log in (if the registration is verified or does not require verification, if it has been approved or does not require approval, and if it has not been blocked).</div><div class=""> - **logout** does what you would expect but also, as the other methods, logs the event and can be used to trigger some event.</div><div class=""> - **profile** allows users to edit their profile, i.e. the content of the ``auth_user`` table. Notice that this table does not have a fixed structure and can be customized.</div><div class=""> - **change_password** allows users to change their password in a fail-safe way.</div><div class=""> - **verify_email**. If email verification is turned on, then visitors, upon registration, receive an email with a link to verify their email information. The link points to this action.</div><div class=""> - **retrieve_username**. By default, **Auth** uses email and password for login, but it can, optionally, use username instead of email. In this latter case, if a user forgets his/her username, the ``retrieve_username`` method allows the user to type the email address and retrieve the username by email.</div><div class=""> - **request_reset_password**. Allows users who forgot their password to request a new password. They will get a confirmation email pointing to **reset_password**.</div><div class=""> - **impersonate** allows a user to &quot;impersonate&quot; another user. This is important for debugging and for support purposes. ``request.args[0]`` is the id of the user to be impersonated. This is only allowed if the logged in user ``has_permission(&#x27;impersonate&#x27;, db.auth_user, user_id)``. You can use ``auth.is_impersonating()`` to check is the current user is impersonating somebody else.</div><div class=""> - **groups** lists the groups of which the current logged in user is a member.</div><div class=""> - **not_authorized** displays an error message when the visitor tried to do something that he/she is not authorized to do</div><div class=""> - **navbar** is a helper that generates a bar with login/register/etc. links.</div></div></div>
    <div class="span6"><div class="diff"><div class=""> The controller above exposes multiple actions:</div><div class=""> ``</div><div class=""> http://.../[app]/default/user/register</div><div class=""> http://.../[app]/default/user/login</div><div class=""> http://.../[app]/default/user/logout</div><div class=""> http://.../[app]/default/user/profile</div><div class=""> http://.../[app]/default/user/change_password</div><div class=""> http://.../[app]/default/user/verify_email</div><div class=""> http://.../[app]/default/user/retrieve_username</div><div class=""> http://.../[app]/default/user/request_reset_password</div><div class=""> http://.../[app]/default/user/reset_password</div><div class=""> http://.../[app]/default/user/impersonate</div><div class=""> http://.../[app]/default/user/groups</div><div class=""> http://.../[app]/default/user/not_authorized</div><div class=""> ``:code</div><div class="delete">- **register** allows users to register. It is integrated with CAPTCHA, although this is disabled by default.<span class="highlight"></span></div><div class=""> - **login** allows users who are registered to log in (if the registration is verified or does not require verification, if it has been approved or does not require approval, and if it has not been blocked).</div><div class=""> - **logout** does what you would expect but also, as the other methods, logs the event and can be used to trigger some event.</div><div class=""> - **profile** allows users to edit their profile, i.e. the content of the ``auth_user`` table. Notice that this table does not have a fixed structure and can be customized.</div><div class=""> - **change_password** allows users to change their password in a fail-safe way.</div><div class=""> - **verify_email**. If email verification is turned on, then visitors, upon registration, receive an email with a link to verify their email information. The link points to this action.</div><div class=""> - **retrieve_username**. By default, **Auth** uses email and password for login, but it can, optionally, use username instead of email. In this latter case, if a user forgets his/her username, the ``retrieve_username`` method allows the user to type the email address and retrieve the username by email.</div><div class=""> - **request_reset_password**. Allows users who forgot their password to request a new password. They will get a confirmation email pointing to **reset_password**.</div><div class=""> - **impersonate** allows a user to &quot;impersonate&quot; another user. This is important for debugging and for support purposes. ``request.args[0]`` is the id of the user to be impersonated. This is only allowed if the logged in user ``has_permission(&#x27;impersonate&#x27;, db.auth_user, user_id)``. You can use ``auth.is_impersonating()`` to check is the current user is impersonating somebody else.</div><div class=""> - **groups** lists the groups of which the current logged in user is a member.</div><div class=""> - **not_authorized** displays an error message when the visitor tried to do something that he/she is not authorized to do</div><div class=""> - **navbar** is a helper that generates a bar with login/register/etc. links.</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/28816a98948c4a6577f73bdeb2b7424dc55d2582">28816a9</a><ul><li>Date : 2012-12-23</li><li>code building book</li></ul></li></ul>
<div class="row-fluid" id="com_28816a98948c4a6577f73bdeb2b7424dc55d2582">
    <div class="span6"><div class="diff"><div class="insert">More details: [[reCAPTCHA http://www.google.com/recaptcha]]``recaptchagoogle``:cite  and [[customizing http://code.google.com/apis/recaptcha/docs/customization.html]]<span class="highlight"></span>  .</div></div></div>
    <div class="span6"><div class="diff"><div class="delete">More details: [[reCAPTCHA http://www.google.com/recaptcha]]``recaptchagoogle``:cite  and [[customizing http://code.google.com/apis/recaptcha/docs/customization.html]]<span class="highlight">``recaptchacustomizing``:cite</span>  .</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/ac4003f4349f9ee22c67309ceeb48de5539b0308">ac4003f</a><ul><li>Date : 2012-09-01</li><li>added lots of new features to book</li></ul></li></ul>
<div class="row-fluid" id="com_ac4003f4349f9ee22c67309ceeb48de5539b0308">
    <div class="span6"><div class="diff"><div class=""> To start using ``Auth``, you need at least this code in a model file, which is also provided with the web2py &quot;welcome&quot; application and assumes a ``db`` connection object:</div><div class=""> ``</div><div class=""> from gluon.tools import Auth</div><div class="insert">auth = Auth(db<span class="highlight"></span>)<span class="highlight"></span></div><div class=""> auth.define_tables()</div><div class=""> ``:code</div><div class=""> </div><div class=""> -------</div><div class="insert">The ``password`` field of the ``db.auth_user`` table defaults to a ``CRYPT`` validator, which needs and ``hmac_key``. <span class="highlight">On legacy web2py applications you may see an extra argument passed to the Auth contructor: ``hmac_key = </span>Auth.get_or_create_key()``<span class="highlight">. The latter</span> is a function that read the hmac kay from a file &quot;private/auth.key&quot; within the application folder. If the file does not exist it creates a random ``hmac_key``. If multiple apps share the same auth database, make sure they also use the same ``hmac_key``.<span class="highlight"> This is no loger necessary for new applications since passwords are salted with an individual random salt.</span></div><div class=""> -------</div><div class=""> </div><div class=""> By default, web2py uses email for login. If instead you want to log in using username set ``auth.define_tables(username=True)``</div><div class=""> </div><div class=""> If multiple apps share the same auth database you may want to disable migrations: ``auth.define_tables(migrate=False)``.</div><div class=""> </div><div class=""> To expose **Auth**, you also need the following function in a controller (for example in &quot;default.py&quot;):</div><div class=""> ``</div><div class=""> def user(): return dict(form=auth())</div><div class=""> ``:code</div><div class=""> </div><div class=""> -------</div><div class=""> The ``auth`` object and the ``user`` action are already defined in the</div><div class=""> scaffolding application.</div><div class=""> -------</div><div class=""> </div><div class=""> web2py also includes a sample view &quot;welcome/views/default/user.html&quot; to render this function properly that looks like this:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h2&gt;{{=T( request.args(0).replace(&#x27;_&#x27;,&#x27; &#x27;).capitalize() )}}&lt;/h2&gt;</div><div class=""> &lt;div id=&quot;web2py_user_form&quot;&gt;</div><div class="">   {{=form}}</div><div class="">   {{if request.args(0)==&#x27;login&#x27;:}}</div><div class="">     {{if not &#x27;register&#x27; in auth.settings.actions_disabled:}}</div><div class="">       &lt;br/&gt;&lt;a href=&quot;{{=URL(args=&#x27;register&#x27;)}}&quot;&gt;register&lt;/a&gt;</div><div class="">     {{pass}}</div><div class="">     {{if not &#x27;request_reset_password&#x27; in auth.settings.actions_disabled:}}</div><div class="">       &lt;br/&gt;</div><div class="">       &lt;a href=&quot;{{=URL(args=&#x27;request_reset_password&#x27;)}}&quot;&gt;lost password&lt;/a&gt;</div><div class="">     {{pass}}</div><div class=""> http://.../[app]/default/user/not_authorized</div><div class=""> </div><div class=""> Logout, profile, change_password, impersonate, and groups require login.</div><div class=""> </div><div class=""> By default they are all exposed, but it is possible to restrict access to only some of these actions.</div><div class=""> </div><div class=""> All of the methods above can be extended or replaced by subclassing **Auth**.</div><div class=""> </div><div class=""> All of the methods above can be used in separate actions. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> def mylogin(): return dict(form=auth.login())</div><div class=""> def myregister(): return dict(form=auth.register())</div><div class=""> def myprofile(): return dict(form=auth.profile())</div><div class=""> ...</div><div class=""> ``</div><div class=""> </div><div class=""> To restrict access to functions to only logged in visitors, decorate the function as in the following example</div><div class=""> ``</div><div class=""> @auth.requires_login()</div><div class=""> def hello():</div><div class="">     return dict(message=&#x27;hello %(first_name)s&#x27; % auth.user)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Any function can be decorated, not just exposed actions. Of course this is still only a very simple example of access control. More complex examples will be discussed later.</div><div class=""> ``auth.user``:inxx ``auth.user_id``:inxx</div><div class=""> </div><div class=""> -----</div><div class=""> ``auth.user`` contains a copy of the ``db.auth_user`` records for the current logged in user or ``None`` otherwise. There is also a ``auth.user_id`` which is the same as ``auth.user.id`` (i.e. the id of the current logger in user) or ``None``.</div><div class=""> -----</div><div class=""> </div><div class="insert">+``otherwise``:inxx</div><div class="insert">+</div><div class="insert">+The ``auth.requires_login()`` decorator as well as the other ``auth.requires_*`` decorators take an optional ``otherwise`` argument. It can be set to a string where to redirect the user if registration files or to a callable object. It is called if registration fails.</div><div class="insert">+</div><div class=""> #### Restrictions on registration</div></div></div>
    <div class="span6"><div class="diff"><div class=""> To start using ``Auth``, you need at least this code in a model file, which is also provided with the web2py &quot;welcome&quot; application and assumes a ``db`` connection object:</div><div class=""> ``</div><div class=""> from gluon.tools import Auth</div><div class="delete">auth = Auth(db<span class="highlight">, hmac_key=Auth.get_or_create_key(</span>)<span class="highlight">)</span></div><div class=""> auth.define_tables()</div><div class=""> ``:code</div><div class=""> </div><div class=""> -------</div><div class="delete">The ``password`` field of the ``db.auth_user`` table defaults to a ``CRYPT`` validator, which needs and ``hmac_key``. <span class="highlight">The ``</span>Auth.get_or_create_key()``<span class="highlight"></span> is a function that read the hmac kay from a file &quot;private/auth.key&quot; within the application folder. If the file does not exist it creates a random ``hmac_key``. If multiple apps share the same auth database, make sure they also use the same ``hmac_key``.<span class="highlight"></span></div><div class=""> -------</div><div class=""> </div><div class=""> By default, web2py uses email for login. If instead you want to log in using username set ``auth.define_tables(username=True)``</div><div class=""> </div><div class=""> If multiple apps share the same auth database you may want to disable migrations: ``auth.define_tables(migrate=False)``.</div><div class=""> </div><div class=""> To expose **Auth**, you also need the following function in a controller (for example in &quot;default.py&quot;):</div><div class=""> ``</div><div class=""> def user(): return dict(form=auth())</div><div class=""> ``:code</div><div class=""> </div><div class=""> -------</div><div class=""> The ``auth`` object and the ``user`` action are already defined in the</div><div class=""> scaffolding application.</div><div class=""> -------</div><div class=""> </div><div class=""> web2py also includes a sample view &quot;welcome/views/default/user.html&quot; to render this function properly that looks like this:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h2&gt;{{=T( request.args(0).replace(&#x27;_&#x27;,&#x27; &#x27;).capitalize() )}}&lt;/h2&gt;</div><div class=""> &lt;div id=&quot;web2py_user_form&quot;&gt;</div><div class="">   {{=form}}</div><div class="">   {{if request.args(0)==&#x27;login&#x27;:}}</div><div class="">     {{if not &#x27;register&#x27; in auth.settings.actions_disabled:}}</div><div class="">       &lt;br/&gt;&lt;a href=&quot;{{=URL(args=&#x27;register&#x27;)}}&quot;&gt;register&lt;/a&gt;</div><div class="">     {{pass}}</div><div class="">     {{if not &#x27;request_reset_password&#x27; in auth.settings.actions_disabled:}}</div><div class="">       &lt;br/&gt;</div><div class="">       &lt;a href=&quot;{{=URL(args=&#x27;request_reset_password&#x27;)}}&quot;&gt;lost password&lt;/a&gt;</div><div class="">     {{pass}}</div><div class=""> http://.../[app]/default/user/not_authorized</div><div class=""> </div><div class=""> Logout, profile, change_password, impersonate, and groups require login.</div><div class=""> </div><div class=""> By default they are all exposed, but it is possible to restrict access to only some of these actions.</div><div class=""> </div><div class=""> All of the methods above can be extended or replaced by subclassing **Auth**.</div><div class=""> </div><div class=""> All of the methods above can be used in separate actions. For example:</div><div class=""> </div><div class=""> ``</div><div class=""> def mylogin(): return dict(form=auth.login())</div><div class=""> def myregister(): return dict(form=auth.register())</div><div class=""> def myprofile(): return dict(form=auth.profile())</div><div class=""> ...</div><div class=""> ``</div><div class=""> </div><div class=""> To restrict access to functions to only logged in visitors, decorate the function as in the following example</div><div class=""> ``</div><div class=""> @auth.requires_login()</div><div class=""> def hello():</div><div class="">     return dict(message=&#x27;hello %(first_name)s&#x27; % auth.user)</div><div class=""> ``:code</div><div class=""> </div><div class=""> Any function can be decorated, not just exposed actions. Of course this is still only a very simple example of access control. More complex examples will be discussed later.</div><div class=""> ``auth.user``:inxx ``auth.user_id``:inxx</div><div class=""> </div><div class=""> -----</div><div class=""> ``auth.user`` contains a copy of the ``db.auth_user`` records for the current logged in user or ``None`` otherwise. There is also a ``auth.user_id`` which is the same as ``auth.user.id`` (i.e. the id of the current logger in user) or ``None``.</div><div class=""> -----</div><div class=""> </div><div class=""> #### Restrictions on registration</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/c0da1a23055a3368a1a4b20f5e90fcd6ef18f4f8">c0da1a2</a><ul><li>Date : 2012-09-06</li><li>fix more typos</li></ul></li></ul>
<div class="row-fluid" id="com_c0da1a23055a3368a1a4b20f5e90fcd6ef18f4f8">
    <div class="span6"><div class="diff"><div class=""> -------</div><div class="insert">The ``password`` field of the ``db.auth_user`` table defaults to a ``CRYPT`` validator, which needs and ``hmac_key``. On legacy web2py applications you may see an extra argument passed to the Auth con<span class="highlight">s</span>tructor: ``hmac_key = Auth.get_or_create_key()``. The latter is a function that read the hmac kay from a file &quot;private/auth.key&quot; within the application folder. If the file does not exist it creates a random ``hmac_key``. If multiple apps share the same auth database, make sure they also use the same ``hmac_key``. This is no loger necessary for new applications since passwords are salted with an individual random salt.</div><div class=""> -------</div><div class=""> </div><div class=""> By default, web2py uses email for login. If instead you want to log in using username set ``auth.define_tables(username=True)``</div><div class=""> </div><div class=""> If multiple apps share the same auth database you may want to disable migrations: ``auth.define_tables(migrate=False)``.</div><div class=""> </div><div class=""> To expose **Auth**, you also need the following function in a controller (for example in &quot;default.py&quot;):</div><div class=""> ``</div><div class=""> def user(): return dict(form=auth())</div><div class=""> ``:code</div><div class=""> </div><div class=""> -------</div><div class=""> The ``auth`` object and the ``user`` action are already defined in the</div><div class=""> scaffolding application.</div><div class=""> -------</div><div class=""> </div><div class=""> web2py also includes a sample view &quot;welcome/views/default/user.html&quot; to render this function properly that looks like this:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h2&gt;{{=T( request.args(0).replace(&#x27;_&#x27;,&#x27; &#x27;).capitalize() )}}&lt;/h2&gt;</div><div class=""> &lt;div id=&quot;web2py_user_form&quot;&gt;</div><div class="">   {{=form}}</div><div class="">   {{if request.args(0)==&#x27;login&#x27;:}}</div><div class="">     {{if not &#x27;register&#x27; in auth.settings.actions_disabled:}}</div><div class="">       &lt;br/&gt;&lt;a href=&quot;{{=URL(args=&#x27;register&#x27;)}}&quot;&gt;register&lt;/a&gt;</div><div class="">     {{pass}}</div><div class="">     {{if not &#x27;request_reset_password&#x27; in auth.settings.actions_disabled:}}</div><div class="">       &lt;br/&gt;</div><div class="">       &lt;a href=&quot;{{=URL(args=&#x27;request_reset_password&#x27;)}}&quot;&gt;lost password&lt;/a&gt;</div><div class="">     {{pass}}</div><div class=""> You can use it in all types of SQLFORM by injection:</div><div class=""> </div><div class=""> ``</div><div class=""> form = SQLFORM(...) or SQLFORM.factory(...)</div><div class=""> form.element(&#x27;table&#x27;).insert(-1,TR(&#x27;&#x27;,Recaptcha(...),&#x27;&#x27;))</div><div class=""> ``:code</div><div class=""> </div><div class=""> #### Customizing ``Auth``</div><div class=""> </div><div class=""> The call to</div><div class=""> ``</div><div class=""> auth.define_tables()</div><div class=""> ``:code</div><div class=""> </div><div class=""> defines all **Auth** tables that have not been defined already. This means that if you wish to do so, you can define your own ``auth_user`` table.</div><div class=""> </div><div class=""> There are a number of ways to customize auth. The simplest way is to add extra fields:</div><div class=""> </div><div class=""> ``</div><div class=""> ## after auth = Auth(db)</div><div class=""> auth.settings.extra_fields[&#x27;auth_user&#x27;]= [</div><div class="">   Field(&#x27;address&#x27;),</div><div class="">   Field(&#x27;city&#x27;),</div><div class="">   Field(&#x27;zip&#x27;),</div><div class="">   Field(&#x27;phone&#x27;)]</div><div class=""> ## before auth.define_tables(username=True)</div><div class=""> ``</div><div class=""> </div><div class=""> You can declare extra fields not just for table &quot;auth_user&quot; but also for other &quot;auth_&quot; tables.</div><div class=""> Using ``extra_fields`` is the recommended way as it will not break any internal mechanism.</div><div class=""> </div><div class="insert">Another way to do<span class="highlight"> this</span> (for experts!) consists of defining your auth tables you<span class="highlight">r</span>self. If a table is declared before ``auth.define_tables()`` it is used instead of the default one. Here is how to do it:</div><div class=""> </div><div class=""> ``</div><div class=""> ## after auth = Auth(db)</div><div class=""> db.define_table(</div><div class="">     auth.settings.table_user_name,</div><div class="">     Field(&#x27;first_name&#x27;, length=128, default=&#x27;&#x27;),</div><div class="">     Field(&#x27;last_name&#x27;, length=128, default=&#x27;&#x27;),</div><div class="">     Field(&#x27;email&#x27;, length=128, default=&#x27;&#x27;, unique=True), # required</div><div class="">     Field(&#x27;password&#x27;, &#x27;password&#x27;, length=512,            # required</div><div class="">           readable=False, label=&#x27;Password&#x27;),</div><div class="">     Field(&#x27;address&#x27;),</div><div class="">     Field(&#x27;city&#x27;),</div><div class="">     Field(&#x27;zip&#x27;),</div><div class="">     Field(&#x27;phone&#x27;),</div><div class="">     Field(&#x27;registration_key&#x27;, length=512,                # required</div><div class="">           writable=False, readable=False, default=&#x27;&#x27;),</div><div class="">     Field(&#x27;reset_password_key&#x27;, length=512,              # required</div><div class="">           writable=False, readable=False, default=&#x27;&#x27;),</div><div class="">     Field(&#x27;registration_id&#x27;, length=512,                 # required</div><div class="">           writable=False, readable=False, default=&#x27;&#x27;))</div><div class=""> </div><div class=""> ## do not forget validators</div><div class=""> custom_auth_table = db[auth.settings.table_user_name] # get the custom_auth_table</div><div class=""> custom_auth_table.first_name.requires = \</div><div class="">   IS_NOT_EMPTY(error_message=auth.messages.is_empty)</div><div class=""> custom_auth_table.last_name.requires = \</div><div class="">   IS_NOT_EMPTY(error_message=auth.messages.is_empty)</div><div class=""> custom_auth_table.password.requires = [IS_STRONG(), CRYPT()]</div><div class=""> custom_auth_table.email.requires = [</div><div class="">   IS_EMAIL(error_message=auth.messages.invalid_email),</div><div class=""> auth.settings.login_form=FaceBookAccount()</div><div class=""> ##### LinkedIn</div><div class=""> ``LinkedIn``:inxx</div><div class=""> </div><div class=""> We have previously discussed integration with Janrain (which has LinkedIn support) and that is the easiest way to use OAuth. Yet sometime you do not want to rely on a third party service or you may want to access LinkedIn directly to get more information than Janrain provides.</div><div class=""> </div><div class=""> Here is an example:</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.contrib.login_methods.linkedin_account import LinkedInAccount</div><div class=""> auth.settings.login_form=LinkedInAccount(request,KEY,SECRET,RETURN_URL)</div><div class=""> ``:code</div><div class=""> </div><div class=""> ``LinkedInAccount`` requires the &quot;python-linkedin&quot; module installed separately.</div><div class=""> </div><div class=""> ##### X509</div><div class=""> </div><div class=""> You can also login by passing to the page an x509 certificate and your credential will be extracted from the certificate. This requires ``M2Crypto`` installed from</div><div class=""> </div><div class=""> ``</div><div class=""> http://chandlerproject.org/bin/view/Projects/MeTooCrypto</div><div class=""> ``</div><div class=""> </div><div class=""> Once you have M2Cryption installed you can do:</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.contrib.login_methods.x509_auth import X509Account</div><div class=""> auth.settings.actions_disabled=[&#x27;register&#x27;,&#x27;change_password&#x27;,&#x27;request_reset_password&#x27;]</div><div class=""> auth.settings.login_form = X509Account()</div><div class=""> ``:code</div><div class=""> </div><div class="insert">You can now authenticate into web2py passing your x509 certificate. How to do this is browser<span class="highlight">-</span>depend<span class="highlight">ent,</span> but probably you are more likely to use certificates for web services. In this case you can use for example ``cURL`` to try out your authentication:</div></div></div>
    <div class="span6"><div class="diff"><div class=""> -------</div><div class="delete">The ``password`` field of the ``db.auth_user`` table defaults to a ``CRYPT`` validator, which needs and ``hmac_key``. On legacy web2py applications you may see an extra argument passed to the Auth con<span class="highlight"></span>tructor: ``hmac_key = Auth.get_or_create_key()``. The latter is a function that read the hmac kay from a file &quot;private/auth.key&quot; within the application folder. If the file does not exist it creates a random ``hmac_key``. If multiple apps share the same auth database, make sure they also use the same ``hmac_key``. This is no loger necessary for new applications since passwords are salted with an individual random salt.</div><div class=""> -------</div><div class=""> </div><div class=""> By default, web2py uses email for login. If instead you want to log in using username set ``auth.define_tables(username=True)``</div><div class=""> </div><div class=""> If multiple apps share the same auth database you may want to disable migrations: ``auth.define_tables(migrate=False)``.</div><div class=""> </div><div class=""> To expose **Auth**, you also need the following function in a controller (for example in &quot;default.py&quot;):</div><div class=""> ``</div><div class=""> def user(): return dict(form=auth())</div><div class=""> ``:code</div><div class=""> </div><div class=""> -------</div><div class=""> The ``auth`` object and the ``user`` action are already defined in the</div><div class=""> scaffolding application.</div><div class=""> -------</div><div class=""> </div><div class=""> web2py also includes a sample view &quot;welcome/views/default/user.html&quot; to render this function properly that looks like this:</div><div class=""> ``</div><div class=""> {{extend &#x27;layout.html&#x27;}}</div><div class=""> &lt;h2&gt;{{=T( request.args(0).replace(&#x27;_&#x27;,&#x27; &#x27;).capitalize() )}}&lt;/h2&gt;</div><div class=""> &lt;div id=&quot;web2py_user_form&quot;&gt;</div><div class="">   {{=form}}</div><div class="">   {{if request.args(0)==&#x27;login&#x27;:}}</div><div class="">     {{if not &#x27;register&#x27; in auth.settings.actions_disabled:}}</div><div class="">       &lt;br/&gt;&lt;a href=&quot;{{=URL(args=&#x27;register&#x27;)}}&quot;&gt;register&lt;/a&gt;</div><div class="">     {{pass}}</div><div class="">     {{if not &#x27;request_reset_password&#x27; in auth.settings.actions_disabled:}}</div><div class="">       &lt;br/&gt;</div><div class="">       &lt;a href=&quot;{{=URL(args=&#x27;request_reset_password&#x27;)}}&quot;&gt;lost password&lt;/a&gt;</div><div class="">     {{pass}}</div><div class=""> You can use it in all types of SQLFORM by injection:</div><div class=""> </div><div class=""> ``</div><div class=""> form = SQLFORM(...) or SQLFORM.factory(...)</div><div class=""> form.element(&#x27;table&#x27;).insert(-1,TR(&#x27;&#x27;,Recaptcha(...),&#x27;&#x27;))</div><div class=""> ``:code</div><div class=""> </div><div class=""> #### Customizing ``Auth``</div><div class=""> </div><div class=""> The call to</div><div class=""> ``</div><div class=""> auth.define_tables()</div><div class=""> ``:code</div><div class=""> </div><div class=""> defines all **Auth** tables that have not been defined already. This means that if you wish to do so, you can define your own ``auth_user`` table.</div><div class=""> </div><div class=""> There are a number of ways to customize auth. The simplest way is to add extra fields:</div><div class=""> </div><div class=""> ``</div><div class=""> ## after auth = Auth(db)</div><div class=""> auth.settings.extra_fields[&#x27;auth_user&#x27;]= [</div><div class="">   Field(&#x27;address&#x27;),</div><div class="">   Field(&#x27;city&#x27;),</div><div class="">   Field(&#x27;zip&#x27;),</div><div class="">   Field(&#x27;phone&#x27;)]</div><div class=""> ## before auth.define_tables(username=True)</div><div class=""> ``</div><div class=""> </div><div class=""> You can declare extra fields not just for table &quot;auth_user&quot; but also for other &quot;auth_&quot; tables.</div><div class=""> Using ``extra_fields`` is the recommended way as it will not break any internal mechanism.</div><div class=""> </div><div class="delete">Another way to do<span class="highlight"></span> (for experts!) consists of defining your auth tables you<span class="highlight"></span>self. If a table is declared before ``auth.define_tables()`` it is used instead of the default one. Here is how to do it:</div><div class=""> </div><div class=""> ``</div><div class=""> ## after auth = Auth(db)</div><div class=""> db.define_table(</div><div class="">     auth.settings.table_user_name,</div><div class="">     Field(&#x27;first_name&#x27;, length=128, default=&#x27;&#x27;),</div><div class="">     Field(&#x27;last_name&#x27;, length=128, default=&#x27;&#x27;),</div><div class="">     Field(&#x27;email&#x27;, length=128, default=&#x27;&#x27;, unique=True), # required</div><div class="">     Field(&#x27;password&#x27;, &#x27;password&#x27;, length=512,            # required</div><div class="">           readable=False, label=&#x27;Password&#x27;),</div><div class="">     Field(&#x27;address&#x27;),</div><div class="">     Field(&#x27;city&#x27;),</div><div class="">     Field(&#x27;zip&#x27;),</div><div class="">     Field(&#x27;phone&#x27;),</div><div class="">     Field(&#x27;registration_key&#x27;, length=512,                # required</div><div class="">           writable=False, readable=False, default=&#x27;&#x27;),</div><div class="">     Field(&#x27;reset_password_key&#x27;, length=512,              # required</div><div class="">           writable=False, readable=False, default=&#x27;&#x27;),</div><div class="">     Field(&#x27;registration_id&#x27;, length=512,                 # required</div><div class="">           writable=False, readable=False, default=&#x27;&#x27;))</div><div class=""> </div><div class=""> ## do not forget validators</div><div class=""> custom_auth_table = db[auth.settings.table_user_name] # get the custom_auth_table</div><div class=""> custom_auth_table.first_name.requires = \</div><div class="">   IS_NOT_EMPTY(error_message=auth.messages.is_empty)</div><div class=""> custom_auth_table.last_name.requires = \</div><div class="">   IS_NOT_EMPTY(error_message=auth.messages.is_empty)</div><div class=""> custom_auth_table.password.requires = [IS_STRONG(), CRYPT()]</div><div class=""> custom_auth_table.email.requires = [</div><div class="">   IS_EMAIL(error_message=auth.messages.invalid_email),</div><div class=""> auth.settings.login_form=FaceBookAccount()</div><div class=""> ##### LinkedIn</div><div class=""> ``LinkedIn``:inxx</div><div class=""> </div><div class=""> We have previously discussed integration with Janrain (which has LinkedIn support) and that is the easiest way to use OAuth. Yet sometime you do not want to rely on a third party service or you may want to access LinkedIn directly to get more information than Janrain provides.</div><div class=""> </div><div class=""> Here is an example:</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.contrib.login_methods.linkedin_account import LinkedInAccount</div><div class=""> auth.settings.login_form=LinkedInAccount(request,KEY,SECRET,RETURN_URL)</div><div class=""> ``:code</div><div class=""> </div><div class=""> ``LinkedInAccount`` requires the &quot;python-linkedin&quot; module installed separately.</div><div class=""> </div><div class=""> ##### X509</div><div class=""> </div><div class=""> You can also login by passing to the page an x509 certificate and your credential will be extracted from the certificate. This requires ``M2Crypto`` installed from</div><div class=""> </div><div class=""> ``</div><div class=""> http://chandlerproject.org/bin/view/Projects/MeTooCrypto</div><div class=""> ``</div><div class=""> </div><div class=""> Once you have M2Cryption installed you can do:</div><div class=""> </div><div class=""> ``</div><div class=""> from gluon.contrib.login_methods.x509_auth import X509Account</div><div class=""> auth.settings.actions_disabled=[&#x27;register&#x27;,&#x27;change_password&#x27;,&#x27;request_reset_password&#x27;]</div><div class=""> auth.settings.login_form = X509Account()</div><div class=""> ``:code</div><div class=""> </div><div class="delete">You can now authenticate into web2py passing your x509 certificate. How to do this is browser<span class="highlight"> </span>depend<span class="highlight">ant</span> but probably you are more likely to use certificates for web services. In this case you can use for example ``cURL`` to try out your authentication:</div></div></div>
</div>
<hr />

<ul><li><a href="https://github.com/mdipierro/web2py-book/commit/f74941a5a1e849459f1fbea6dc9a2861e40e419a">f74941a</a><ul><li>Date : 2013-01-08</li><li>Added documentation on mail.settings.tls</li></ul></li></ul>
<div class="row-fluid" id="com_f74941a5a1e849459f1fbea6dc9a2861e40e419a">
    <div class="span6"><div class="diff"><div class="insert">You need to replace the mail.settings with the proper parameters for your SMTP server. Set ``mail.settings.login = None`` if the SMTP server does not require authentication.<span class="highlight"> If you don&#x27;t want to use TLS, set ``mail.settings.tls = False``</span></div></div></div>
    <div class="span6"><div class="diff"><div class="delete">You need to replace the mail.settings with the proper parameters for your SMTP server. Set ``mail.settings.login = None`` if the SMTP server does not require authentication.<span class="highlight"></span></div></div></div>
</div>
<hr />


        
      </div>

      <div id="push"></div>
    </div>

    <div id="footer">
      <div class="container-fluid">
          <div class="copyright pull-left">Copyright &#169; 2013</div>
          <div id="poweredBy" class="pull-right">
              Powered by
              <a href="http://www.web2py.com/">web2py</a>
          </div>
      </div>
    </div>
<script src="static/js/bootstrap.min.js"></script>
<script src="static/js/web2py_bootstrap.js"></script>
</body>
</html>
